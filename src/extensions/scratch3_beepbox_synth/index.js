const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const Cast = require('../../util/cast');
var beepboxsynthuri = "data:text/javascript;base64,dmFyIGJlZXBib3ggPSAoZnVuY3Rpb24gKGV4cG9ydHMpIHsKICAgICd1c2Ugc3RyaWN0JzsKCiAgICAvKiEKICAgIENvcHlyaWdodCAoQykgMjAyMSBKb2huIE5lc2t5CgogICAgUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weSBvZgogICAgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4KICAgIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8KICAgIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzCiAgICBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8KICAgIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKCiAgICBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGwKICAgIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgogICAgVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1IKICAgIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAogICAgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCiAgICBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSCiAgICBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAogICAgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKICAgIFNPRlRXQVJFLgogICAgKi8KICAgIGNsYXNzIENvbmZpZyB7CiAgICB9CiAgICBDb25maWcuc2NhbGVzID0gdG9OYW1lTWFwKFsKICAgICAgICB7IG5hbWU6ICJlYXN5IDopIiwgcmVhbE5hbWU6ICJwZW50YXRvbmljIG1ham9yIiwgZmxhZ3M6IFt0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIHRydWUsIGZhbHNlLCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIHRydWUsIGZhbHNlLCBmYWxzZV0gfSwKICAgICAgICB7IG5hbWU6ICJlYXN5IDooIiwgcmVhbE5hbWU6ICJwZW50YXRvbmljIG1pbm9yIiwgZmxhZ3M6IFt0cnVlLCBmYWxzZSwgZmFsc2UsIHRydWUsIGZhbHNlLCB0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIGZhbHNlLCB0cnVlLCBmYWxzZV0gfSwKICAgICAgICB7IG5hbWU6ICJpc2xhbmQgOikiLCByZWFsTmFtZTogInJ5dWt5dSIsIGZsYWdzOiBbdHJ1ZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgdHJ1ZSwgdHJ1ZSwgZmFsc2UsIHRydWUsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIHRydWVdIH0sCiAgICAgICAgeyBuYW1lOiAiaXNsYW5kIDooIiwgcmVhbE5hbWU6ICJwZWxvZyBzZWxpc2lyIiwgZmxhZ3M6IFt0cnVlLCB0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgdHJ1ZSwgdHJ1ZSwgZmFsc2UsIGZhbHNlLCBmYWxzZV0gfSwKICAgICAgICB7IG5hbWU6ICJibHVlcyA6KSIsIHJlYWxOYW1lOiAiYmx1ZXMgbWFqb3IiLCBmbGFnczogW3RydWUsIGZhbHNlLCB0cnVlLCB0cnVlLCB0cnVlLCBmYWxzZSwgZmFsc2UsIHRydWUsIGZhbHNlLCB0cnVlLCBmYWxzZSwgZmFsc2VdIH0sCiAgICAgICAgeyBuYW1lOiAiYmx1ZXMgOigiLCByZWFsTmFtZTogImJsdWVzIiwgZmxhZ3M6IFt0cnVlLCBmYWxzZSwgZmFsc2UsIHRydWUsIGZhbHNlLCB0cnVlLCB0cnVlLCB0cnVlLCBmYWxzZSwgZmFsc2UsIHRydWUsIGZhbHNlXSB9LAogICAgICAgIHsgbmFtZTogIm5vcm1hbCA6KSIsIHJlYWxOYW1lOiAiaW9uaWFuIiwgZmxhZ3M6IFt0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIHRydWUsIHRydWUsIGZhbHNlLCB0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIHRydWVdIH0sCiAgICAgICAgeyBuYW1lOiAibm9ybWFsIDooIiwgcmVhbE5hbWU6ICJhZW9saWFuIiwgZmxhZ3M6IFt0cnVlLCBmYWxzZSwgdHJ1ZSwgdHJ1ZSwgZmFsc2UsIHRydWUsIGZhbHNlLCB0cnVlLCB0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2VdIH0sCiAgICAgICAgeyBuYW1lOiAiZGJsIGhhcm1vbmljIDopIiwgcmVhbE5hbWU6ICJkb3VibGUgaGFybW9uaWMgbWFqb3IiLCBmbGFnczogW3RydWUsIHRydWUsIGZhbHNlLCBmYWxzZSwgdHJ1ZSwgdHJ1ZSwgZmFsc2UsIHRydWUsIHRydWUsIGZhbHNlLCBmYWxzZSwgdHJ1ZV0gfSwKICAgICAgICB7IG5hbWU6ICJkYmwgaGFybW9uaWMgOigiLCByZWFsTmFtZTogImRvdWJsZSBoYXJtb25pYyBtaW5vciIsIGZsYWdzOiBbdHJ1ZSwgZmFsc2UsIHRydWUsIHRydWUsIGZhbHNlLCBmYWxzZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSwgZmFsc2UsIGZhbHNlLCB0cnVlXSB9LAogICAgICAgIHsgbmFtZTogInN0cmFuZ2UiLCByZWFsTmFtZTogIndob2xlIHRvbmUiLCBmbGFnczogW3RydWUsIGZhbHNlLCB0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2UsIHRydWUsIGZhbHNlLCB0cnVlLCBmYWxzZSwgdHJ1ZSwgZmFsc2VdIH0sCiAgICAgICAgeyBuYW1lOiAiZXhwZXJ0IiwgcmVhbE5hbWU6ICJjaHJvbWF0aWMiLCBmbGFnczogW3RydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWUsIHRydWVdIH0sCiAgICBdKTsKICAgIENvbmZpZy5rZXlzID0gdG9OYW1lTWFwKFsKICAgICAgICB7IG5hbWU6ICJDIiwgaXNXaGl0ZUtleTogdHJ1ZSwgYmFzZVBpdGNoOiAxMiB9LAogICAgICAgIHsgbmFtZTogIkPima8iLCBpc1doaXRlS2V5OiBmYWxzZSwgYmFzZVBpdGNoOiAxMyB9LAogICAgICAgIHsgbmFtZTogIkQiLCBpc1doaXRlS2V5OiB0cnVlLCBiYXNlUGl0Y2g6IDE0IH0sCiAgICAgICAgeyBuYW1lOiAiROKZryIsIGlzV2hpdGVLZXk6IGZhbHNlLCBiYXNlUGl0Y2g6IDE1IH0sCiAgICAgICAgeyBuYW1lOiAiRSIsIGlzV2hpdGVLZXk6IHRydWUsIGJhc2VQaXRjaDogMTYgfSwKICAgICAgICB7IG5hbWU6ICJGIiwgaXNXaGl0ZUtleTogdHJ1ZSwgYmFzZVBpdGNoOiAxNyB9LAogICAgICAgIHsgbmFtZTogIkbima8iLCBpc1doaXRlS2V5OiBmYWxzZSwgYmFzZVBpdGNoOiAxOCB9LAogICAgICAgIHsgbmFtZTogIkciLCBpc1doaXRlS2V5OiB0cnVlLCBiYXNlUGl0Y2g6IDE5IH0sCiAgICAgICAgeyBuYW1lOiAiR+KZryIsIGlzV2hpdGVLZXk6IGZhbHNlLCBiYXNlUGl0Y2g6IDIwIH0sCiAgICAgICAgeyBuYW1lOiAiQSIsIGlzV2hpdGVLZXk6IHRydWUsIGJhc2VQaXRjaDogMjEgfSwKICAgICAgICB7IG5hbWU6ICJB4pmvIiwgaXNXaGl0ZUtleTogZmFsc2UsIGJhc2VQaXRjaDogMjIgfSwKICAgICAgICB7IG5hbWU6ICJCIiwgaXNXaGl0ZUtleTogdHJ1ZSwgYmFzZVBpdGNoOiAyMyB9LAogICAgXSk7CiAgICBDb25maWcuYmxhY2tLZXlOYW1lUGFyZW50cyA9IFstMSwgMSwgLTEsIDEsIC0xLCAxLCAtMSwgLTEsIDEsIC0xLCAxLCAtMV07CiAgICBDb25maWcudGVtcG9NaW4gPSAzMDsKICAgIENvbmZpZy50ZW1wb01heCA9IDMwMDsKICAgIENvbmZpZy5lY2hvRGVsYXlSYW5nZSA9IDI0OwogICAgQ29uZmlnLmVjaG9EZWxheVN0ZXBUaWNrcyA9IDQ7CiAgICBDb25maWcuZWNob1N1c3RhaW5SYW5nZSA9IDg7CiAgICBDb25maWcuZWNob1NoZWxmSHogPSA0MDAwLjA7CiAgICBDb25maWcuZWNob1NoZWxmR2FpbiA9IE1hdGgucG93KDIuMCwgLTAuNSk7CiAgICBDb25maWcucmV2ZXJiU2hlbGZIeiA9IDgwMDAuMDsKICAgIENvbmZpZy5yZXZlcmJTaGVsZkdhaW4gPSBNYXRoLnBvdygyLjAsIC0xLjUpOwogICAgQ29uZmlnLnJldmVyYlJhbmdlID0gNDsKICAgIENvbmZpZy5yZXZlcmJEZWxheUJ1ZmZlclNpemUgPSAxNjM4NDsKICAgIENvbmZpZy5yZXZlcmJEZWxheUJ1ZmZlck1hc2sgPSBDb25maWcucmV2ZXJiRGVsYXlCdWZmZXJTaXplIC0gMTsKICAgIENvbmZpZy5iZWF0c1BlckJhck1pbiA9IDM7CiAgICBDb25maWcuYmVhdHNQZXJCYXJNYXggPSAxNjsKICAgIENvbmZpZy5iYXJDb3VudE1pbiA9IDE7CiAgICBDb25maWcuYmFyQ291bnRNYXggPSAxMjg7CiAgICBDb25maWcuaW5zdHJ1bWVudENvdW50TWluID0gMTsKICAgIENvbmZpZy5sYXllcmVkSW5zdHJ1bWVudENvdW50TWF4ID0gNDsKICAgIENvbmZpZy5wYXR0ZXJuSW5zdHJ1bWVudENvdW50TWF4ID0gMTA7CiAgICBDb25maWcucGFydHNQZXJCZWF0ID0gMjQ7CiAgICBDb25maWcudGlja3NQZXJQYXJ0ID0gMjsKICAgIENvbmZpZy5yaHl0aG1zID0gdG9OYW1lTWFwKFsKICAgICAgICB7IG5hbWU6ICLDtzMgKHRyaXBsZXRzKSIsIHN0ZXBzUGVyQmVhdDogMywgdGlja3NQZXJBcnBlZ2dpbzogNCwgYXJwZWdnaW9QYXR0ZXJuczogW1swXSwgWzAsIDAsIDEsIDFdLCBbMCwgMSwgMiwgMV1dLCByb3VuZFVwVGhyZXNob2xkczogWzUsIDEyLCAxOF0gfSwKICAgICAgICB7IG5hbWU6ICLDtzQgKHN0YW5kYXJkKSIsIHN0ZXBzUGVyQmVhdDogNCwgdGlja3NQZXJBcnBlZ2dpbzogMywgYXJwZWdnaW9QYXR0ZXJuczogW1swXSwgWzAsIDAsIDEsIDFdLCBbMCwgMSwgMiwgMV1dLCByb3VuZFVwVGhyZXNob2xkczogWzMsIDksIDE3LCAyMV0gfSwKICAgICAgICB7IG5hbWU6ICLDtzYiLCBzdGVwc1BlckJlYXQ6IDYsIHRpY2tzUGVyQXJwZWdnaW86IDQsIGFycGVnZ2lvUGF0dGVybnM6IFtbMF0sIFswLCAxXSwgWzAsIDEsIDIsIDFdXSwgcm91bmRVcFRocmVzaG9sZHM6IG51bGwgfSwKICAgICAgICB7IG5hbWU6ICLDtzgiLCBzdGVwc1BlckJlYXQ6IDgsIHRpY2tzUGVyQXJwZWdnaW86IDMsIGFycGVnZ2lvUGF0dGVybnM6IFtbMF0sIFswLCAxXSwgWzAsIDEsIDIsIDFdXSwgcm91bmRVcFRocmVzaG9sZHM6IG51bGwgfSwKICAgICAgICB7IG5hbWU6ICJmcmVlaGFuZCIsIHN0ZXBzUGVyQmVhdDogMjQsIHRpY2tzUGVyQXJwZWdnaW86IDMsIGFycGVnZ2lvUGF0dGVybnM6IFtbMF0sIFswLCAxXSwgWzAsIDEsIDIsIDFdXSwgcm91bmRVcFRocmVzaG9sZHM6IG51bGwgfSwKICAgIF0pOwogICAgQ29uZmlnLmluc3RydW1lbnRUeXBlTmFtZXMgPSBbImNoaXAiLCAiRk0iLCAibm9pc2UiLCAic3BlY3RydW0iLCAiZHJ1bXNldCIsICJoYXJtb25pY3MiLCAiUFdNIiwgIlBpY2tlZCBTdHJpbmciXTsKICAgIENvbmZpZy5pbnN0cnVtZW50VHlwZUhhc1NwZWNpYWxJbnRlcnZhbCA9IFt0cnVlLCB0cnVlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCB0cnVlLCBmYWxzZSwgZmFsc2VdOwogICAgQ29uZmlnLmNoaXBCYXNlRXhwcmVzc2lvbiA9IDAuMDMzNzU7CiAgICBDb25maWcuZm1CYXNlRXhwcmVzc2lvbiA9IDAuMDM7CiAgICBDb25maWcubm9pc2VCYXNlRXhwcmVzc2lvbiA9IDAuMTk7CiAgICBDb25maWcuc3BlY3RydW1CYXNlRXhwcmVzc2lvbiA9IDAuMzsKICAgIENvbmZpZy5kcnVtc2V0QmFzZUV4cHJlc3Npb24gPSAwLjQ1OwogICAgQ29uZmlnLmhhcm1vbmljc0Jhc2VFeHByZXNzaW9uID0gMC4wMjU7CiAgICBDb25maWcucHdtQmFzZUV4cHJlc3Npb24gPSAwLjA0NzI1OwogICAgQ29uZmlnLnBpY2tlZFN0cmluZ0Jhc2VFeHByZXNzaW9uID0gMC4wMjU7CiAgICBDb25maWcuZGlzdG9ydGlvbkJhc2VWb2x1bWUgPSAwLjAxMTsKICAgIENvbmZpZy5iaXRjcnVzaGVyQmFzZVZvbHVtZSA9IDAuMDEwOwogICAgQ29uZmlnLmNoaXBXYXZlcyA9IHRvTmFtZU1hcChbCiAgICAgICAgeyBuYW1lOiAicm91bmRlZCIsIGV4cHJlc3Npb246IDAuOTQsIHNhbXBsZXM6IGNlbnRlcldhdmUoWzAuMCwgMC4yLCAwLjQsIDAuNSwgMC42LCAwLjcsIDAuOCwgMC44NSwgMC45LCAwLjk1LCAxLjAsIDEuMCwgMS4wLCAxLjAsIDEuMCwgMS4wLCAxLjAsIDEuMCwgMS4wLCAxLjAsIDEuMCwgMS4wLCAxLjAsIDEuMCwgMS4wLCAwLjk1LCAwLjksIDAuODUsIDAuOCwgMC43LCAwLjYsIDAuNSwgMC40LCAwLjIsIDAuMCwgLTAuMiwgLTAuNCwgLTAuNSwgLTAuNiwgLTAuNywgLTAuOCwgLTAuODUsIC0wLjksIC0wLjk1LCAtMS4wLCAtMS4wLCAtMS4wLCAtMS4wLCAtMS4wLCAtMS4wLCAtMS4wLCAtMS4wLCAtMS4wLCAtMS4wLCAtMS4wLCAtMC45NSwgLTAuOSwgLTAuODUsIC0wLjgsIC0wLjcsIC0wLjYsIC0wLjUsIC0wLjQsIC0wLjJdKSB9LAogICAgICAgIHsgbmFtZTogInRyaWFuZ2xlIiwgZXhwcmVzc2lvbjogMS4wLCBzYW1wbGVzOiBjZW50ZXJXYXZlKFsxLjAgLyAxNS4wLCAzLjAgLyAxNS4wLCA1LjAgLyAxNS4wLCA3LjAgLyAxNS4wLCA5LjAgLyAxNS4wLCAxMS4wIC8gMTUuMCwgMTMuMCAvIDE1LjAsIDE1LjAgLyAxNS4wLCAxNS4wIC8gMTUuMCwgMTMuMCAvIDE1LjAsIDExLjAgLyAxNS4wLCA5LjAgLyAxNS4wLCA3LjAgLyAxNS4wLCA1LjAgLyAxNS4wLCAzLjAgLyAxNS4wLCAxLjAgLyAxNS4wLCAtMS4wIC8gMTUuMCwgLTMuMCAvIDE1LjAsIC01LjAgLyAxNS4wLCAtNy4wIC8gMTUuMCwgLTkuMCAvIDE1LjAsIC0xMS4wIC8gMTUuMCwgLTEzLjAgLyAxNS4wLCAtMTUuMCAvIDE1LjAsIC0xNS4wIC8gMTUuMCwgLTEzLjAgLyAxNS4wLCAtMTEuMCAvIDE1LjAsIC05LjAgLyAxNS4wLCAtNy4wIC8gMTUuMCwgLTUuMCAvIDE1LjAsIC0zLjAgLyAxNS4wLCAtMS4wIC8gMTUuMF0pIH0sCiAgICAgICAgeyBuYW1lOiAic3F1YXJlIiwgZXhwcmVzc2lvbjogMC41LCBzYW1wbGVzOiBjZW50ZXJXYXZlKFsxLjAsIC0xLjBdKSB9LAogICAgICAgIHsgbmFtZTogIjEvNCBwdWxzZSIsIGV4cHJlc3Npb246IDAuNSwgc2FtcGxlczogY2VudGVyV2F2ZShbMS4wLCAtMS4wLCAtMS4wLCAtMS4wXSkgfSwKICAgICAgICB7IG5hbWU6ICIxLzggcHVsc2UiLCBleHByZXNzaW9uOiAwLjUsIHNhbXBsZXM6IGNlbnRlcldhdmUoWzEuMCwgLTEuMCwgLTEuMCwgLTEuMCwgLTEuMCwgLTEuMCwgLTEuMCwgLTEuMF0pIH0sCiAgICAgICAgeyBuYW1lOiAic2F3dG9vdGgiLCBleHByZXNzaW9uOiAwLjY1LCBzYW1wbGVzOiBjZW50ZXJXYXZlKFsxLjAgLyAzMS4wLCAzLjAgLyAzMS4wLCA1LjAgLyAzMS4wLCA3LjAgLyAzMS4wLCA5LjAgLyAzMS4wLCAxMS4wIC8gMzEuMCwgMTMuMCAvIDMxLjAsIDE1LjAgLyAzMS4wLCAxNy4wIC8gMzEuMCwgMTkuMCAvIDMxLjAsIDIxLjAgLyAzMS4wLCAyMy4wIC8gMzEuMCwgMjUuMCAvIDMxLjAsIDI3LjAgLyAzMS4wLCAyOS4wIC8gMzEuMCwgMzEuMCAvIDMxLjAsIC0zMS4wIC8gMzEuMCwgLTI5LjAgLyAzMS4wLCAtMjcuMCAvIDMxLjAsIC0yNS4wIC8gMzEuMCwgLTIzLjAgLyAzMS4wLCAtMjEuMCAvIDMxLjAsIC0xOS4wIC8gMzEuMCwgLTE3LjAgLyAzMS4wLCAtMTUuMCAvIDMxLjAsIC0xMy4wIC8gMzEuMCwgLTExLjAgLyAzMS4wLCAtOS4wIC8gMzEuMCwgLTcuMCAvIDMxLjAsIC01LjAgLyAzMS4wLCAtMy4wIC8gMzEuMCwgLTEuMCAvIDMxLjBdKSB9LAogICAgICAgIHsgbmFtZTogImRvdWJsZSBzYXciLCBleHByZXNzaW9uOiAwLjUsIHNhbXBsZXM6IGNlbnRlcldhdmUoWzAuMCwgLTAuMiwgLTAuNCwgLTAuNiwgLTAuOCwgLTEuMCwgMS4wLCAtMC44LCAtMC42LCAtMC40LCAtMC4yLCAxLjAsIDAuOCwgMC42LCAwLjQsIDAuMl0pIH0sCiAgICAgICAgeyBuYW1lOiAiZG91YmxlIHB1bHNlIiwgZXhwcmVzc2lvbjogMC40LCBzYW1wbGVzOiBjZW50ZXJXYXZlKFsxLjAsIDEuMCwgMS4wLCAxLjAsIDEuMCwgLTEuMCwgLTEuMCwgLTEuMCwgMS4wLCAxLjAsIDEuMCwgMS4wLCAtMS4wLCAtMS4wLCAtMS4wLCAtMS4wXSkgfSwKICAgICAgICB7IG5hbWU6ICJzcGlreSIsIGV4cHJlc3Npb246IDAuNCwgc2FtcGxlczogY2VudGVyV2F2ZShbMS4wLCAtMS4wLCAxLjAsIC0xLjAsIDEuMCwgMC4wXSkgfSwKICAgIF0pOwogICAgQ29uZmlnLmNoaXBOb2lzZXMgPSB0b05hbWVNYXAoWwogICAgICAgIHsgbmFtZTogInJldHJvIiwgZXhwcmVzc2lvbjogMC4yNSwgYmFzZVBpdGNoOiA2OSwgcGl0Y2hGaWx0ZXJNdWx0OiAxMDI0LjAsIGlzU29mdDogZmFsc2UsIHNhbXBsZXM6IG51bGwgfSwKICAgICAgICB7IG5hbWU6ICJ3aGl0ZSIsIGV4cHJlc3Npb246IDEuMCwgYmFzZVBpdGNoOiA2OSwgcGl0Y2hGaWx0ZXJNdWx0OiA4LjAsIGlzU29mdDogdHJ1ZSwgc2FtcGxlczogbnVsbCB9LAogICAgICAgIHsgbmFtZTogImNsYW5nIiwgZXhwcmVzc2lvbjogMC40LCBiYXNlUGl0Y2g6IDY5LCBwaXRjaEZpbHRlck11bHQ6IDEwMjQuMCwgaXNTb2Z0OiBmYWxzZSwgc2FtcGxlczogbnVsbCB9LAogICAgICAgIHsgbmFtZTogImJ1enoiLCBleHByZXNzaW9uOiAwLjMsIGJhc2VQaXRjaDogNjksIHBpdGNoRmlsdGVyTXVsdDogMTAyNC4wLCBpc1NvZnQ6IGZhbHNlLCBzYW1wbGVzOiBudWxsIH0sCiAgICAgICAgeyBuYW1lOiAiaG9sbG93IiwgZXhwcmVzc2lvbjogMS41LCBiYXNlUGl0Y2g6IDk2LCBwaXRjaEZpbHRlck11bHQ6IDEuMCwgaXNTb2Z0OiB0cnVlLCBzYW1wbGVzOiBudWxsIH0sCiAgICBdKTsKICAgIENvbmZpZy5maWx0ZXJGcmVxU3RlcCA9IDEuMCAvIDQuMDsKICAgIENvbmZpZy5maWx0ZXJGcmVxUmFuZ2UgPSAzNDsKICAgIENvbmZpZy5maWx0ZXJGcmVxUmVmZXJlbmNlU2V0dGluZyA9IDI4OwogICAgQ29uZmlnLmZpbHRlckZyZXFSZWZlcmVuY2VIeiA9IDgwMDAuMDsKICAgIENvbmZpZy5maWx0ZXJGcmVxTWF4SHogPSBDb25maWcuZmlsdGVyRnJlcVJlZmVyZW5jZUh6ICogTWF0aC5wb3coMi4wLCBDb25maWcuZmlsdGVyRnJlcVN0ZXAgKiAoQ29uZmlnLmZpbHRlckZyZXFSYW5nZSAtIDEgLSBDb25maWcuZmlsdGVyRnJlcVJlZmVyZW5jZVNldHRpbmcpKTsKICAgIENvbmZpZy5maWx0ZXJGcmVxTWluSHogPSA4LjA7CiAgICBDb25maWcuZmlsdGVyR2FpblJhbmdlID0gMTU7CiAgICBDb25maWcuZmlsdGVyR2FpbkNlbnRlciA9IDc7CiAgICBDb25maWcuZmlsdGVyR2FpblN0ZXAgPSAxLjAgLyAyLjA7CiAgICBDb25maWcuZmlsdGVyTWF4UG9pbnRzID0gODsKICAgIENvbmZpZy5maWx0ZXJUeXBlTmFtZXMgPSBbImxvdy1wYXNzIiwgImhpZ2gtcGFzcyIsICJwZWFrIl07CiAgICBDb25maWcuZmFkZUluUmFuZ2UgPSAxMDsKICAgIENvbmZpZy5mYWRlT3V0VGlja3MgPSBbLTI0LCAtMTIsIC02LCAtMywgLTEsIDYsIDEyLCAyNCwgNDgsIDcyLCA5Nl07CiAgICBDb25maWcuZmFkZU91dE5ldXRyYWwgPSA0OwogICAgQ29uZmlnLmRydW1zZXRGYWRlT3V0VGlja3MgPSA0ODsKICAgIENvbmZpZy50cmFuc2l0aW9ucyA9IHRvTmFtZU1hcChbCiAgICAgICAgeyBuYW1lOiAibm9ybWFsIiwgaXNTZWFtbGVzczogZmFsc2UsIGNvbnRpbnVlczogZmFsc2UsIHNsaWRlczogZmFsc2UsIHNsaWRlVGlja3M6IDMsIGluY2x1ZGVBZGphY2VudFBhdHRlcm5zOiBmYWxzZSB9LAogICAgICAgIHsgbmFtZTogImludGVycnVwdCIsIGlzU2VhbWxlc3M6IHRydWUsIGNvbnRpbnVlczogZmFsc2UsIHNsaWRlczogZmFsc2UsIHNsaWRlVGlja3M6IDMsIGluY2x1ZGVBZGphY2VudFBhdHRlcm5zOiB0cnVlIH0sCiAgICAgICAgeyBuYW1lOiAiY29udGludWUiLCBpc1NlYW1sZXNzOiB0cnVlLCBjb250aW51ZXM6IHRydWUsIHNsaWRlczogZmFsc2UsIHNsaWRlVGlja3M6IDMsIGluY2x1ZGVBZGphY2VudFBhdHRlcm5zOiB0cnVlIH0sCiAgICAgICAgeyBuYW1lOiAic2xpZGUiLCBpc1NlYW1sZXNzOiB0cnVlLCBjb250aW51ZXM6IGZhbHNlLCBzbGlkZXM6IHRydWUsIHNsaWRlVGlja3M6IDMsIGluY2x1ZGVBZGphY2VudFBhdHRlcm5zOiB0cnVlIH0sCiAgICAgICAgeyBuYW1lOiAic2xpZGUgaW4gcGF0dGVybiIsIGlzU2VhbWxlc3M6IHRydWUsIGNvbnRpbnVlczogZmFsc2UsIHNsaWRlczogdHJ1ZSwgc2xpZGVUaWNrczogMywgaW5jbHVkZUFkamFjZW50UGF0dGVybnM6IGZhbHNlIH0sCiAgICBdKTsKICAgIENvbmZpZy52aWJyYXRvcyA9IHRvTmFtZU1hcChbCiAgICAgICAgeyBuYW1lOiAibm9uZSIsIGFtcGxpdHVkZTogMC4wLCBwZXJpb2RzU2Vjb25kczogWzAuMTRdLCBkZWxheVRpY2tzOiAwIH0sCiAgICAgICAgeyBuYW1lOiAibGlnaHQiLCBhbXBsaXR1ZGU6IDAuMTUsIHBlcmlvZHNTZWNvbmRzOiBbMC4xNF0sIGRlbGF5VGlja3M6IDAgfSwKICAgICAgICB7IG5hbWU6ICJkZWxheWVkIiwgYW1wbGl0dWRlOiAwLjMsIHBlcmlvZHNTZWNvbmRzOiBbMC4xNF0sIGRlbGF5VGlja3M6IDM3IH0sCiAgICAgICAgeyBuYW1lOiAiaGVhdnkiLCBhbXBsaXR1ZGU6IDAuNDUsIHBlcmlvZHNTZWNvbmRzOiBbMC4xNF0sIGRlbGF5VGlja3M6IDAgfSwKICAgICAgICB7IG5hbWU6ICJzaGFreSIsIGFtcGxpdHVkZTogMC4xLCBwZXJpb2RzU2Vjb25kczogWzAuMTEsIDEuNjE4ICogMC4xMSwgMyAqIDAuMTFdLCBkZWxheVRpY2tzOiAwIH0sCiAgICBdKTsKICAgIENvbmZpZy51bmlzb25zID0gdG9OYW1lTWFwKFsKICAgICAgICB7IG5hbWU6ICJub25lIiwgdm9pY2VzOiAxLCBzcHJlYWQ6IDAuMCwgb2Zmc2V0OiAwLjAsIGV4cHJlc3Npb246IDEuNCwgc2lnbjogMS4wIH0sCiAgICAgICAgeyBuYW1lOiAic2hpbW1lciIsIHZvaWNlczogMiwgc3ByZWFkOiAwLjAxOCwgb2Zmc2V0OiAwLjAsIGV4cHJlc3Npb246IDAuOCwgc2lnbjogMS4wIH0sCiAgICAgICAgeyBuYW1lOiAiaHVtIiwgdm9pY2VzOiAyLCBzcHJlYWQ6IDAuMDQ1LCBvZmZzZXQ6IDAuMCwgZXhwcmVzc2lvbjogMS4wLCBzaWduOiAxLjAgfSwKICAgICAgICB7IG5hbWU6ICJob25reSB0b25rIiwgdm9pY2VzOiAyLCBzcHJlYWQ6IDAuMDksIG9mZnNldDogMC4wLCBleHByZXNzaW9uOiAxLjAsIHNpZ246IDEuMCB9LAogICAgICAgIHsgbmFtZTogImRpc3NvbmFudCIsIHZvaWNlczogMiwgc3ByZWFkOiAwLjI1LCBvZmZzZXQ6IDAuMCwgZXhwcmVzc2lvbjogMC45LCBzaWduOiAxLjAgfSwKICAgICAgICB7IG5hbWU6ICJmaWZ0aCIsIHZvaWNlczogMiwgc3ByZWFkOiAzLjUsIG9mZnNldDogMy41LCBleHByZXNzaW9uOiAwLjksIHNpZ246IDEuMCB9LAogICAgICAgIHsgbmFtZTogIm9jdGF2ZSIsIHZvaWNlczogMiwgc3ByZWFkOiA2LjAsIG9mZnNldDogNi4wLCBleHByZXNzaW9uOiAwLjgsIHNpZ246IDEuMCB9LAogICAgICAgIHsgbmFtZTogImJvd2VkIiwgdm9pY2VzOiAyLCBzcHJlYWQ6IDAuMDIsIG9mZnNldDogMC4wLCBleHByZXNzaW9uOiAxLjAsIHNpZ246IC0xLjAgfSwKICAgICAgICB7IG5hbWU6ICJwaWFubyIsIHZvaWNlczogMiwgc3ByZWFkOiAwLjAxLCBvZmZzZXQ6IDAuMCwgZXhwcmVzc2lvbjogMS4wLCBzaWduOiAwLjcgfSwKICAgIF0pOwogICAgQ29uZmlnLmVmZmVjdE5hbWVzID0gWyJyZXZlcmIiLCAiY2hvcnVzIiwgInBhbm5pbmciLCAiZGlzdG9ydGlvbiIsICJiaXRjcnVzaGVyIiwgIm5vdGUgZmlsdGVyIiwgImVjaG8iLCAicGl0Y2ggc2hpZnQiLCAiZGV0dW5lIiwgInZpYnJhdG8iLCAidHJhbnNpdGlvbiB0eXBlIiwgImNob3JkIHR5cGUiXTsKICAgIENvbmZpZy5lZmZlY3RPcmRlciA9IFsxMCwgMTEsIDcsIDgsIDksIDUsIDMsIDQsIDIsIDEsIDYsIDBdOwogICAgQ29uZmlnLm5vdGVTaXplTWF4ID0gMzsKICAgIENvbmZpZy52b2x1bWVSYW5nZSA9IDg7CiAgICBDb25maWcudm9sdW1lTG9nU2NhbGUgPSAtMC41OwogICAgQ29uZmlnLnBhbkNlbnRlciA9IDQ7CiAgICBDb25maWcucGFuTWF4ID0gQ29uZmlnLnBhbkNlbnRlciAqIDI7CiAgICBDb25maWcucGFuRGVsYXlTZWNvbmRzTWF4ID0gMC4wMDA1OwogICAgQ29uZmlnLmNob3J1c1JhbmdlID0gNDsKICAgIENvbmZpZy5jaG9ydXNQZXJpb2RTZWNvbmRzID0gMi4wOwogICAgQ29uZmlnLmNob3J1c0RlbGF5UmFuZ2UgPSAwLjAwMzQ7CiAgICBDb25maWcuY2hvcnVzRGVsYXlPZmZzZXRzID0gW1sxLjUxLCAyLjEwLCAzLjM1XSwgWzEuNDcsIDIuMTUsIDMuMjVdXTsKICAgIENvbmZpZy5jaG9ydXNQaGFzZU9mZnNldHMgPSBbWzAuMCwgMi4xLCA0LjJdLCBbMy4yLCA1LjMsIDEuMF1dOwogICAgQ29uZmlnLmNob3J1c01heERlbGF5ID0gQ29uZmlnLmNob3J1c0RlbGF5UmFuZ2UgKiAoMS4wICsgQ29uZmlnLmNob3J1c0RlbGF5T2Zmc2V0c1swXS5jb25jYXQoQ29uZmlnLmNob3J1c0RlbGF5T2Zmc2V0c1sxXSkucmVkdWNlKCh4LCB5KSA9PiBNYXRoLm1heCh4LCB5KSkpOwogICAgQ29uZmlnLmNob3JkcyA9IHRvTmFtZU1hcChbCiAgICAgICAgeyBuYW1lOiAic2ltdWx0YW5lb3VzIiwgY3VzdG9tSW50ZXJ2YWw6IGZhbHNlLCBhcnBlZ2dpYXRlczogZmFsc2UsIHN0cnVtUGFydHM6IDAsIHNpbmdsZVRvbmU6IGZhbHNlIH0sCiAgICAgICAgeyBuYW1lOiAic3RydW0iLCBjdXN0b21JbnRlcnZhbDogZmFsc2UsIGFycGVnZ2lhdGVzOiBmYWxzZSwgc3RydW1QYXJ0czogMSwgc2luZ2xlVG9uZTogZmFsc2UgfSwKICAgICAgICB7IG5hbWU6ICJhcnBlZ2dpbyIsIGN1c3RvbUludGVydmFsOiBmYWxzZSwgYXJwZWdnaWF0ZXM6IHRydWUsIHN0cnVtUGFydHM6IDAsIHNpbmdsZVRvbmU6IHRydWUgfSwKICAgICAgICB7IG5hbWU6ICJjdXN0b20gaW50ZXJ2YWwiLCBjdXN0b21JbnRlcnZhbDogdHJ1ZSwgYXJwZWdnaWF0ZXM6IGZhbHNlLCBzdHJ1bVBhcnRzOiAwLCBzaW5nbGVUb25lOiB0cnVlIH0sCiAgICBdKTsKICAgIENvbmZpZy5tYXhDaG9yZFNpemUgPSA0OwogICAgQ29uZmlnLm9wZXJhdG9yQ291bnQgPSA0OwogICAgQ29uZmlnLmFsZ29yaXRobXMgPSB0b05hbWVNYXAoWwogICAgICAgIHsgbmFtZTogIjHihpAoMuKAgjPigII0KSIsIGNhcnJpZXJDb3VudDogMSwgYXNzb2NpYXRlZENhcnJpZXI6IFsxLCAxLCAxLCAxXSwgbW9kdWxhdGVkQnk6IFtbMiwgMywgNF0sIFtdLCBbXSwgW11dIH0sCiAgICAgICAgeyBuYW1lOiAiMeKGkCgy4oCCM+KGkDQpIiwgY2FycmllckNvdW50OiAxLCBhc3NvY2lhdGVkQ2FycmllcjogWzEsIDEsIDEsIDFdLCBtb2R1bGF0ZWRCeTogW1syLCAzXSwgW10sIFs0XSwgW11dIH0sCiAgICAgICAgeyBuYW1lOiAiMeKGkDLihpAoM+KAgjQpIiwgY2FycmllckNvdW50OiAxLCBhc3NvY2lhdGVkQ2FycmllcjogWzEsIDEsIDEsIDFdLCBtb2R1bGF0ZWRCeTogW1syXSwgWzMsIDRdLCBbXSwgW11dIH0sCiAgICAgICAgeyBuYW1lOiAiMeKGkCgy4oCCMynihpA0IiwgY2FycmllckNvdW50OiAxLCBhc3NvY2lhdGVkQ2FycmllcjogWzEsIDEsIDEsIDFdLCBtb2R1bGF0ZWRCeTogW1syLCAzXSwgWzRdLCBbNF0sIFtdXSB9LAogICAgICAgIHsgbmFtZTogIjHihpAy4oaQM+KGkDQiLCBjYXJyaWVyQ291bnQ6IDEsIGFzc29jaWF0ZWRDYXJyaWVyOiBbMSwgMSwgMSwgMV0sIG1vZHVsYXRlZEJ5OiBbWzJdLCBbM10sIFs0XSwgW11dIH0sCiAgICAgICAgeyBuYW1lOiAiMeKGkDPigIMy4oaQNCIsIGNhcnJpZXJDb3VudDogMiwgYXNzb2NpYXRlZENhcnJpZXI6IFsxLCAyLCAxLCAyXSwgbW9kdWxhdGVkQnk6IFtbM10sIFs0XSwgW10sIFtdXSB9LAogICAgICAgIHsgbmFtZTogIjHigIMy4oaQKDPigII0KSIsIGNhcnJpZXJDb3VudDogMiwgYXNzb2NpYXRlZENhcnJpZXI6IFsxLCAyLCAyLCAyXSwgbW9kdWxhdGVkQnk6IFtbXSwgWzMsIDRdLCBbXSwgW11dIH0sCiAgICAgICAgeyBuYW1lOiAiMeKAgzLihpAz4oaQNCIsIGNhcnJpZXJDb3VudDogMiwgYXNzb2NpYXRlZENhcnJpZXI6IFsxLCAyLCAyLCAyXSwgbW9kdWxhdGVkQnk6IFtbXSwgWzNdLCBbNF0sIFtdXSB9LAogICAgICAgIHsgbmFtZTogIigx4oCCMinihpAz4oaQNCIsIGNhcnJpZXJDb3VudDogMiwgYXNzb2NpYXRlZENhcnJpZXI6IFsxLCAyLCAyLCAyXSwgbW9kdWxhdGVkQnk6IFtbM10sIFszXSwgWzRdLCBbXV0gfSwKICAgICAgICB7IG5hbWU6ICIoMeKAgjIp4oaQKDPigII0KSIsIGNhcnJpZXJDb3VudDogMiwgYXNzb2NpYXRlZENhcnJpZXI6IFsxLCAyLCAyLCAyXSwgbW9kdWxhdGVkQnk6IFtbMywgNF0sIFszLCA0XSwgW10sIFtdXSB9LAogICAgICAgIHsgbmFtZTogIjHigIMy4oCDM+KGkDQiLCBjYXJyaWVyQ291bnQ6IDMsIGFzc29jaWF0ZWRDYXJyaWVyOiBbMSwgMiwgMywgM10sIG1vZHVsYXRlZEJ5OiBbW10sIFtdLCBbNF0sIFtdXSB9LAogICAgICAgIHsgbmFtZTogIigx4oCCMuKAgjMp4oaQNCIsIGNhcnJpZXJDb3VudDogMywgYXNzb2NpYXRlZENhcnJpZXI6IFsxLCAyLCAzLCAzXSwgbW9kdWxhdGVkQnk6IFtbNF0sIFs0XSwgWzRdLCBbXV0gfSwKICAgICAgICB7IG5hbWU6ICIx4oCDMuKAgzPigIM0IiwgY2FycmllckNvdW50OiA0LCBhc3NvY2lhdGVkQ2FycmllcjogWzEsIDIsIDMsIDRdLCBtb2R1bGF0ZWRCeTogW1tdLCBbXSwgW10sIFtdXSB9LAogICAgXSk7CiAgICBDb25maWcub3BlcmF0b3JDYXJyaWVySW50ZXJ2YWwgPSBbMC4wLCAwLjA0LCAtMC4wNzMsIDAuMDkxXTsKICAgIENvbmZpZy5vcGVyYXRvckFtcGxpdHVkZU1heCA9IDE1OwogICAgQ29uZmlnLm9wZXJhdG9yRnJlcXVlbmNpZXMgPSB0b05hbWVNYXAoWwogICAgICAgIHsgbmFtZTogIjHDlyIsIG11bHQ6IDEuMCwgaHpPZmZzZXQ6IDAuMCwgYW1wbGl0dWRlU2lnbjogMS4wIH0sCiAgICAgICAgeyBuYW1lOiAifjHDlyIsIG11bHQ6IDEuMCwgaHpPZmZzZXQ6IDEuNSwgYW1wbGl0dWRlU2lnbjogLTEuMCB9LAogICAgICAgIHsgbmFtZTogIjLDlyIsIG11bHQ6IDIuMCwgaHpPZmZzZXQ6IDAuMCwgYW1wbGl0dWRlU2lnbjogMS4wIH0sCiAgICAgICAgeyBuYW1lOiAifjLDlyIsIG11bHQ6IDIuMCwgaHpPZmZzZXQ6IC0xLjMsIGFtcGxpdHVkZVNpZ246IC0xLjAgfSwKICAgICAgICB7IG5hbWU6ICIzw5ciLCBtdWx0OiAzLjAsIGh6T2Zmc2V0OiAwLjAsIGFtcGxpdHVkZVNpZ246IDEuMCB9LAogICAgICAgIHsgbmFtZTogIjTDlyIsIG11bHQ6IDQuMCwgaHpPZmZzZXQ6IDAuMCwgYW1wbGl0dWRlU2lnbjogMS4wIH0sCiAgICAgICAgeyBuYW1lOiAiNcOXIiwgbXVsdDogNS4wLCBoek9mZnNldDogMC4wLCBhbXBsaXR1ZGVTaWduOiAxLjAgfSwKICAgICAgICB7IG5hbWU6ICI2w5ciLCBtdWx0OiA2LjAsIGh6T2Zmc2V0OiAwLjAsIGFtcGxpdHVkZVNpZ246IDEuMCB9LAogICAgICAgIHsgbmFtZTogIjfDlyIsIG11bHQ6IDcuMCwgaHpPZmZzZXQ6IDAuMCwgYW1wbGl0dWRlU2lnbjogMS4wIH0sCiAgICAgICAgeyBuYW1lOiAiOMOXIiwgbXVsdDogOC4wLCBoek9mZnNldDogMC4wLCBhbXBsaXR1ZGVTaWduOiAxLjAgfSwKICAgICAgICB7IG5hbWU6ICI5w5ciLCBtdWx0OiA5LjAsIGh6T2Zmc2V0OiAwLjAsIGFtcGxpdHVkZVNpZ246IDEuMCB9LAogICAgICAgIHsgbmFtZTogIjExw5ciLCBtdWx0OiAxMS4wLCBoek9mZnNldDogMC4wLCBhbXBsaXR1ZGVTaWduOiAxLjAgfSwKICAgICAgICB7IG5hbWU6ICIxM8OXIiwgbXVsdDogMTMuMCwgaHpPZmZzZXQ6IDAuMCwgYW1wbGl0dWRlU2lnbjogMS4wIH0sCiAgICAgICAgeyBuYW1lOiAiMTbDlyIsIG11bHQ6IDE2LjAsIGh6T2Zmc2V0OiAwLjAsIGFtcGxpdHVkZVNpZ246IDEuMCB9LAogICAgICAgIHsgbmFtZTogIjIww5ciLCBtdWx0OiAyMC4wLCBoek9mZnNldDogMC4wLCBhbXBsaXR1ZGVTaWduOiAxLjAgfSwKICAgIF0pOwogICAgQ29uZmlnLmVudmVsb3BlcyA9IHRvTmFtZU1hcChbCiAgICAgICAgeyBuYW1lOiAibm9uZSIsIHR5cGU6IDEsIHNwZWVkOiAwLjAgfSwKICAgICAgICB7IG5hbWU6ICJub3RlIHNpemUiLCB0eXBlOiAwLCBzcGVlZDogMC4wIH0sCiAgICAgICAgeyBuYW1lOiAicHVuY2giLCB0eXBlOiAyLCBzcGVlZDogMC4wIH0sCiAgICAgICAgeyBuYW1lOiAiZmxhcmUgMSIsIHR5cGU6IDMsIHNwZWVkOiAzMi4wIH0sCiAgICAgICAgeyBuYW1lOiAiZmxhcmUgMiIsIHR5cGU6IDMsIHNwZWVkOiA4LjAgfSwKICAgICAgICB7IG5hbWU6ICJmbGFyZSAzIiwgdHlwZTogMywgc3BlZWQ6IDIuMCB9LAogICAgICAgIHsgbmFtZTogInR3YW5nIDEiLCB0eXBlOiA0LCBzcGVlZDogMzIuMCB9LAogICAgICAgIHsgbmFtZTogInR3YW5nIDIiLCB0eXBlOiA0LCBzcGVlZDogOC4wIH0sCiAgICAgICAgeyBuYW1lOiAidHdhbmcgMyIsIHR5cGU6IDQsIHNwZWVkOiAyLjAgfSwKICAgICAgICB7IG5hbWU6ICJzd2VsbCAxIiwgdHlwZTogNSwgc3BlZWQ6IDMyLjAgfSwKICAgICAgICB7IG5hbWU6ICJzd2VsbCAyIiwgdHlwZTogNSwgc3BlZWQ6IDguMCB9LAogICAgICAgIHsgbmFtZTogInN3ZWxsIDMiLCB0eXBlOiA1LCBzcGVlZDogMi4wIH0sCiAgICAgICAgeyBuYW1lOiAidHJlbW9sbzEiLCB0eXBlOiA2LCBzcGVlZDogNC4wIH0sCiAgICAgICAgeyBuYW1lOiAidHJlbW9sbzIiLCB0eXBlOiA2LCBzcGVlZDogMi4wIH0sCiAgICAgICAgeyBuYW1lOiAidHJlbW9sbzMiLCB0eXBlOiA2LCBzcGVlZDogMS4wIH0sCiAgICAgICAgeyBuYW1lOiAidHJlbW9sbzQiLCB0eXBlOiA3LCBzcGVlZDogNC4wIH0sCiAgICAgICAgeyBuYW1lOiAidHJlbW9sbzUiLCB0eXBlOiA3LCBzcGVlZDogMi4wIH0sCiAgICAgICAgeyBuYW1lOiAidHJlbW9sbzYiLCB0eXBlOiA3LCBzcGVlZDogMS4wIH0sCiAgICAgICAgeyBuYW1lOiAiZGVjYXkgMSIsIHR5cGU6IDgsIHNwZWVkOiAxMC4wIH0sCiAgICAgICAgeyBuYW1lOiAiZGVjYXkgMiIsIHR5cGU6IDgsIHNwZWVkOiA3LjAgfSwKICAgICAgICB7IG5hbWU6ICJkZWNheSAzIiwgdHlwZTogOCwgc3BlZWQ6IDQuMCB9LAogICAgXSk7CiAgICBDb25maWcuZmVlZGJhY2tzID0gdG9OYW1lTWFwKFsKICAgICAgICB7IG5hbWU6ICIx4p+yIiwgaW5kaWNlczogW1sxXSwgW10sIFtdLCBbXV0gfSwKICAgICAgICB7IG5hbWU6ICIy4p+yIiwgaW5kaWNlczogW1tdLCBbMl0sIFtdLCBbXV0gfSwKICAgICAgICB7IG5hbWU6ICIz4p+yIiwgaW5kaWNlczogW1tdLCBbXSwgWzNdLCBbXV0gfSwKICAgICAgICB7IG5hbWU6ICI04p+yIiwgaW5kaWNlczogW1tdLCBbXSwgW10sIFs0XV0gfSwKICAgICAgICB7IG5hbWU6ICIx4p+y4oCDMuKfsiIsIGluZGljZXM6IFtbMV0sIFsyXSwgW10sIFtdXSB9LAogICAgICAgIHsgbmFtZTogIjPin7LigIM04p+yIiwgaW5kaWNlczogW1tdLCBbXSwgWzNdLCBbNF1dIH0sCiAgICAgICAgeyBuYW1lOiAiMeKfsuKAgzLin7LigIMz4p+yIiwgaW5kaWNlczogW1sxXSwgWzJdLCBbM10sIFtdXSB9LAogICAgICAgIHsgbmFtZTogIjLin7LigIMz4p+y4oCDNOKfsiIsIGluZGljZXM6IFtbXSwgWzJdLCBbM10sIFs0XV0gfSwKICAgICAgICB7IG5hbWU6ICIx4p+yIDLin7IgM+KfsiA04p+yIiwgaW5kaWNlczogW1sxXSwgWzJdLCBbM10sIFs0XV0gfSwKICAgICAgICB7IG5hbWU6ICIx4oaSMiIsIGluZGljZXM6IFtbXSwgWzFdLCBbXSwgW11dIH0sCiAgICAgICAgeyBuYW1lOiAiMeKGkjMiLCBpbmRpY2VzOiBbW10sIFtdLCBbMV0sIFtdXSB9LAogICAgICAgIHsgbmFtZTogIjHihpI0IiwgaW5kaWNlczogW1tdLCBbXSwgW10sIFsxXV0gfSwKICAgICAgICB7IG5hbWU6ICIy4oaSMyIsIGluZGljZXM6IFtbXSwgW10sIFsyXSwgW11dIH0sCiAgICAgICAgeyBuYW1lOiAiMuKGkjQiLCBpbmRpY2VzOiBbW10sIFtdLCBbXSwgWzJdXSB9LAogICAgICAgIHsgbmFtZTogIjPihpI0IiwgaW5kaWNlczogW1tdLCBbXSwgW10sIFszXV0gfSwKICAgICAgICB7IG5hbWU6ICIx4oaSM+KAgzLihpI0IiwgaW5kaWNlczogW1tdLCBbXSwgWzFdLCBbMl1dIH0sCiAgICAgICAgeyBuYW1lOiAiMeKGkjTigIMy4oaSMyIsIGluZGljZXM6IFtbXSwgW10sIFsyXSwgWzFdXSB9LAogICAgICAgIHsgbmFtZTogIjHihpIy4oaSM+KGkjQiLCBpbmRpY2VzOiBbW10sIFsxXSwgWzJdLCBbM11dIH0sCiAgICBdKTsKICAgIENvbmZpZy5jaGlwTm9pc2VMZW5ndGggPSAxIDw8IDE1OwogICAgQ29uZmlnLnNwZWN0cnVtTm9pc2VMZW5ndGggPSAxIDw8IDE1OwogICAgQ29uZmlnLnNwZWN0cnVtQmFzZVBpdGNoID0gMjQ7CiAgICBDb25maWcuc3BlY3RydW1Db250cm9sUG9pbnRzID0gMzA7CiAgICBDb25maWcuc3BlY3RydW1Db250cm9sUG9pbnRzUGVyT2N0YXZlID0gNzsKICAgIENvbmZpZy5zcGVjdHJ1bUNvbnRyb2xQb2ludEJpdHMgPSAzOwogICAgQ29uZmlnLnNwZWN0cnVtTWF4ID0gKDEgPDwgQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50Qml0cykgLSAxOwogICAgQ29uZmlnLmhhcm1vbmljc0NvbnRyb2xQb2ludHMgPSAyODsKICAgIENvbmZpZy5oYXJtb25pY3NSZW5kZXJlZCA9IDY0OwogICAgQ29uZmlnLmhhcm1vbmljc1JlbmRlcmVkRm9yUGlja2VkU3RyaW5nID0gMSA8PCA4OwogICAgQ29uZmlnLmhhcm1vbmljc0NvbnRyb2xQb2ludEJpdHMgPSAzOwogICAgQ29uZmlnLmhhcm1vbmljc01heCA9ICgxIDw8IENvbmZpZy5oYXJtb25pY3NDb250cm9sUG9pbnRCaXRzKSAtIDE7CiAgICBDb25maWcuaGFybW9uaWNzV2F2ZWxlbmd0aCA9IDEgPDwgMTE7CiAgICBDb25maWcucHVsc2VXaWR0aFJhbmdlID0gODsKICAgIENvbmZpZy5wdWxzZVdpZHRoU3RlcFBvd2VyID0gMC41OwogICAgQ29uZmlnLnBpdGNoQ2hhbm5lbENvdW50TWluID0gMTsKICAgIENvbmZpZy5waXRjaENoYW5uZWxDb3VudE1heCA9IDEwOwogICAgQ29uZmlnLm5vaXNlQ2hhbm5lbENvdW50TWluID0gMDsKICAgIENvbmZpZy5ub2lzZUNoYW5uZWxDb3VudE1heCA9IDU7CiAgICBDb25maWcubm9pc2VJbnRlcnZhbCA9IDY7CiAgICBDb25maWcucGl0Y2hlc1Blck9jdGF2ZSA9IDEyOwogICAgQ29uZmlnLmRydW1Db3VudCA9IDEyOwogICAgQ29uZmlnLnBpdGNoT2N0YXZlcyA9IDc7CiAgICBDb25maWcubWF4UGl0Y2ggPSBDb25maWcucGl0Y2hPY3RhdmVzICogQ29uZmlnLnBpdGNoZXNQZXJPY3RhdmU7CiAgICBDb25maWcubWF4aW11bVRvbmVzUGVyQ2hhbm5lbCA9IENvbmZpZy5tYXhDaG9yZFNpemUgKiAyOwogICAgQ29uZmlnLmp1c3RJbnRvbmF0aW9uU2VtaXRvbmVzID0gWzEuMCAvIDIuMCwgOC4wIC8gMTUuMCwgOS4wIC8gMTYuMCwgMy4wIC8gNS4wLCA1LjAgLyA4LjAsIDIuMCAvIDMuMCwgMzIuMCAvIDQ1LjAsIDMuMCAvIDQuMCwgNC4wIC8gNS4wLCA1LjAgLyA2LjAsIDguMCAvIDkuMCwgMTUuMCAvIDE2LjAsIDEuMCwgMTYuMCAvIDE1LjAsIDkuMCAvIDguMCwgNi4wIC8gNS4wLCA1LjAgLyA0LjAsIDQuMCAvIDMuMCwgNDUuMCAvIDMyLjAsIDMuMCAvIDIuMCwgOC4wIC8gNS4wLCA1LjAgLyAzLjAsIDE2LjAgLyA5LjAsIDE1LjAgLyA4LjAsIDIuMF0ubWFwKHggPT4gTWF0aC5sb2cyKHgpICogQ29uZmlnLnBpdGNoZXNQZXJPY3RhdmUpOwogICAgQ29uZmlnLnBpdGNoU2hpZnRSYW5nZSA9IENvbmZpZy5qdXN0SW50b25hdGlvblNlbWl0b25lcy5sZW5ndGg7CiAgICBDb25maWcucGl0Y2hTaGlmdENlbnRlciA9IENvbmZpZy5waXRjaFNoaWZ0UmFuZ2UgPj4gMTsKICAgIENvbmZpZy5kZXR1bmVDZW50ZXIgPSA5OwogICAgQ29uZmlnLmRldHVuZU1heCA9IENvbmZpZy5kZXR1bmVDZW50ZXIgKiAyOwogICAgQ29uZmlnLnNpbmVXYXZlTGVuZ3RoID0gMSA8PCA4OwogICAgQ29uZmlnLnNpbmVXYXZlTWFzayA9IENvbmZpZy5zaW5lV2F2ZUxlbmd0aCAtIDE7CiAgICBDb25maWcuc2luZVdhdmUgPSBnZW5lcmF0ZVNpbmVXYXZlKCk7CiAgICBDb25maWcucGlja2VkU3RyaW5nRGlzcGVyc2lvbkNlbnRlckZyZXEgPSA2MDAwLjA7CiAgICBDb25maWcucGlja2VkU3RyaW5nRGlzcGVyc2lvbkZyZXFTY2FsZSA9IDAuMzsKICAgIENvbmZpZy5waWNrZWRTdHJpbmdEaXNwZXJzaW9uRnJlcU11bHQgPSA0LjA7CiAgICBDb25maWcucGlja2VkU3RyaW5nU2hlbGZIeiA9IDQwMDAuMDsKICAgIENvbmZpZy5kaXN0b3J0aW9uUmFuZ2UgPSA4OwogICAgQ29uZmlnLnN0cmluZ1N1c3RhaW5SYW5nZSA9IDE1OwogICAgQ29uZmlnLnN0cmluZ0RlY2F5UmF0ZSA9IDAuMTI7CiAgICBDb25maWcuYml0Y3J1c2hlckZyZXFSYW5nZSA9IDE0OwogICAgQ29uZmlnLmJpdGNydXNoZXJPY3RhdmVTdGVwID0gMC41OwogICAgQ29uZmlnLmJpdGNydXNoZXJRdWFudGl6YXRpb25SYW5nZSA9IDg7CiAgICBDb25maWcubWF4RW52ZWxvcGVDb3VudCA9IDEyOwogICAgQ29uZmlnLmRlZmF1bHRBdXRvbWF0aW9uUmFuZ2UgPSAxMzsKICAgIENvbmZpZy5pbnN0cnVtZW50QXV0b21hdGlvblRhcmdldHMgPSB0b05hbWVNYXAoWwogICAgICAgIHsgbmFtZTogIm5vbmUiLCBjb21wdXRlSW5kZXg6IG51bGwsIGRpc3BsYXlOYW1lOiAibm9uZSIsIGludGVybGVhdmU6IGZhbHNlLCBpc0ZpbHRlcjogZmFsc2UsIG1heENvdW50OiAxLCBlZmZlY3Q6IG51bGwsIGNvbXBhdGlibGVJbnN0cnVtZW50czogbnVsbCB9LAogICAgICAgIHsgbmFtZTogIm5vdGVWb2x1bWUiLCBjb21wdXRlSW5kZXg6IDAsIGRpc3BsYXlOYW1lOiAibm90ZSB2b2x1bWUiLCBpbnRlcmxlYXZlOiBmYWxzZSwgaXNGaWx0ZXI6IGZhbHNlLCBtYXhDb3VudDogMSwgZWZmZWN0OiBudWxsLCBjb21wYXRpYmxlSW5zdHJ1bWVudHM6IG51bGwgfSwKICAgICAgICB7IG5hbWU6ICJwdWxzZVdpZHRoIiwgY29tcHV0ZUluZGV4OiAyLCBkaXNwbGF5TmFtZTogInB1bHNlIHdpZHRoIiwgaW50ZXJsZWF2ZTogZmFsc2UsIGlzRmlsdGVyOiBmYWxzZSwgbWF4Q291bnQ6IDEsIGVmZmVjdDogbnVsbCwgY29tcGF0aWJsZUluc3RydW1lbnRzOiBbNl0gfSwKICAgICAgICB7IG5hbWU6ICJzdHJpbmdTdXN0YWluIiwgY29tcHV0ZUluZGV4OiAzLCBkaXNwbGF5TmFtZTogInN1c3RhaW4iLCBpbnRlcmxlYXZlOiBmYWxzZSwgaXNGaWx0ZXI6IGZhbHNlLCBtYXhDb3VudDogMSwgZWZmZWN0OiBudWxsLCBjb21wYXRpYmxlSW5zdHJ1bWVudHM6IFs3XSB9LAogICAgICAgIHsgbmFtZTogInVuaXNvbiIsIGNvbXB1dGVJbmRleDogNCwgZGlzcGxheU5hbWU6ICJ1bmlzb24iLCBpbnRlcmxlYXZlOiBmYWxzZSwgaXNGaWx0ZXI6IGZhbHNlLCBtYXhDb3VudDogMSwgZWZmZWN0OiBudWxsLCBjb21wYXRpYmxlSW5zdHJ1bWVudHM6IFswLCA1LCA3XSB9LAogICAgICAgIHsgbmFtZTogIm9wZXJhdG9yRnJlcXVlbmN5IiwgY29tcHV0ZUluZGV4OiA1LCBkaXNwbGF5TmFtZTogImZtIyBmcmVxIiwgaW50ZXJsZWF2ZTogdHJ1ZSwgaXNGaWx0ZXI6IGZhbHNlLCBtYXhDb3VudDogQ29uZmlnLm9wZXJhdG9yQ291bnQsIGVmZmVjdDogbnVsbCwgY29tcGF0aWJsZUluc3RydW1lbnRzOiBbMV0gfSwKICAgICAgICB7IG5hbWU6ICJvcGVyYXRvckFtcGxpdHVkZSIsIGNvbXB1dGVJbmRleDogOSwgZGlzcGxheU5hbWU6ICJmbSMgdm9sdW1lIiwgaW50ZXJsZWF2ZTogZmFsc2UsIGlzRmlsdGVyOiBmYWxzZSwgbWF4Q291bnQ6IENvbmZpZy5vcGVyYXRvckNvdW50LCBlZmZlY3Q6IG51bGwsIGNvbXBhdGlibGVJbnN0cnVtZW50czogWzFdIH0sCiAgICAgICAgeyBuYW1lOiAiZmVlZGJhY2tBbXBsaXR1ZGUiLCBjb21wdXRlSW5kZXg6IDEzLCBkaXNwbGF5TmFtZTogImZtIGZlZWRiYWNrIiwgaW50ZXJsZWF2ZTogZmFsc2UsIGlzRmlsdGVyOiBmYWxzZSwgbWF4Q291bnQ6IDEsIGVmZmVjdDogbnVsbCwgY29tcGF0aWJsZUluc3RydW1lbnRzOiBbMV0gfSwKICAgICAgICB7IG5hbWU6ICJwaXRjaFNoaWZ0IiwgY29tcHV0ZUluZGV4OiAxNCwgZGlzcGxheU5hbWU6ICJwaXRjaCBzaGlmdCIsIGludGVybGVhdmU6IGZhbHNlLCBpc0ZpbHRlcjogZmFsc2UsIG1heENvdW50OiAxLCBlZmZlY3Q6IDcsIGNvbXBhdGlibGVJbnN0cnVtZW50czogbnVsbCB9LAogICAgICAgIHsgbmFtZTogImRldHVuZSIsIGNvbXB1dGVJbmRleDogMTUsIGRpc3BsYXlOYW1lOiAiZGV0dW5lIiwgaW50ZXJsZWF2ZTogZmFsc2UsIGlzRmlsdGVyOiBmYWxzZSwgbWF4Q291bnQ6IDEsIGVmZmVjdDogOCwgY29tcGF0aWJsZUluc3RydW1lbnRzOiBudWxsIH0sCiAgICAgICAgeyBuYW1lOiAidmlicmF0b0RlcHRoIiwgY29tcHV0ZUluZGV4OiAxNiwgZGlzcGxheU5hbWU6ICJ2aWJyYXRvIHJhbmdlIiwgaW50ZXJsZWF2ZTogZmFsc2UsIGlzRmlsdGVyOiBmYWxzZSwgbWF4Q291bnQ6IDEsIGVmZmVjdDogOSwgY29tcGF0aWJsZUluc3RydW1lbnRzOiBudWxsIH0sCiAgICAgICAgeyBuYW1lOiAibm90ZUZpbHRlckFsbEZyZXFzIiwgY29tcHV0ZUluZGV4OiAxLCBkaXNwbGF5TmFtZTogIm4uIGZpbHRlciBmcmVxcyIsIGludGVybGVhdmU6IGZhbHNlLCBpc0ZpbHRlcjogdHJ1ZSwgbWF4Q291bnQ6IDEsIGVmZmVjdDogNSwgY29tcGF0aWJsZUluc3RydW1lbnRzOiBudWxsIH0sCiAgICAgICAgeyBuYW1lOiAibm90ZUZpbHRlckZyZXEiLCBjb21wdXRlSW5kZXg6IDE3LCBkaXNwbGF5TmFtZTogIm4uIGZpbHRlciAjIGZyZXEiLCBpbnRlcmxlYXZlOiBmYWxzZSwgaXNGaWx0ZXI6IHRydWUsIG1heENvdW50OiBDb25maWcuZmlsdGVyTWF4UG9pbnRzLCBlZmZlY3Q6IDUsIGNvbXBhdGlibGVJbnN0cnVtZW50czogbnVsbCB9LAogICAgXSk7CiAgICBmdW5jdGlvbiBjZW50ZXJXYXZlKHdhdmUpIHsKICAgICAgICBsZXQgc3VtID0gMC4wOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2F2ZS5sZW5ndGg7IGkrKykKICAgICAgICAgICAgc3VtICs9IHdhdmVbaV07CiAgICAgICAgY29uc3QgYXZlcmFnZSA9IHN1bSAvIHdhdmUubGVuZ3RoOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2F2ZS5sZW5ndGg7IGkrKykKICAgICAgICAgICAgd2F2ZVtpXSAtPSBhdmVyYWdlOwogICAgICAgIHBlcmZvcm1JbnRlZ3JhbCh3YXZlKTsKICAgICAgICB3YXZlLnB1c2goMCk7CiAgICAgICAgcmV0dXJuIG5ldyBGbG9hdDY0QXJyYXkod2F2ZSk7CiAgICB9CiAgICBmdW5jdGlvbiBwZXJmb3JtSW50ZWdyYWwod2F2ZSkgewogICAgICAgIGxldCBjdW11bGF0aXZlID0gMC4wOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2F2ZS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBjb25zdCB0ZW1wID0gd2F2ZVtpXTsKICAgICAgICAgICAgd2F2ZVtpXSA9IGN1bXVsYXRpdmU7CiAgICAgICAgICAgIGN1bXVsYXRpdmUgKz0gdGVtcDsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBnZXRQdWxzZVdpZHRoUmF0aW8ocHVsc2VXaWR0aCkgewogICAgICAgIHJldHVybiBNYXRoLnBvdygwLjUsIChDb25maWcucHVsc2VXaWR0aFJhbmdlIC0gMSAtIHB1bHNlV2lkdGgpICogQ29uZmlnLnB1bHNlV2lkdGhTdGVwUG93ZXIpICogMC41OwogICAgfQogICAgZnVuY3Rpb24gZ2V0RHJ1bVdhdmUoaW5kZXgsIGludmVyc2VSZWFsRm91cmllclRyYW5zZm9ybSwgc2NhbGVFbGVtZW50c0J5RmFjdG9yKSB7CiAgICAgICAgbGV0IHdhdmUgPSBDb25maWcuY2hpcE5vaXNlc1tpbmRleF0uc2FtcGxlczsKICAgICAgICBpZiAod2F2ZSA9PSBudWxsKSB7CiAgICAgICAgICAgIHdhdmUgPSBuZXcgRmxvYXQzMkFycmF5KENvbmZpZy5jaGlwTm9pc2VMZW5ndGggKyAxKTsKICAgICAgICAgICAgQ29uZmlnLmNoaXBOb2lzZXNbaW5kZXhdLnNhbXBsZXMgPSB3YXZlOwogICAgICAgICAgICBpZiAoaW5kZXggPT0gMCkgewogICAgICAgICAgICAgICAgbGV0IGRydW1CdWZmZXIgPSAxOwogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBDb25maWcuY2hpcE5vaXNlTGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB3YXZlW2ldID0gKGRydW1CdWZmZXIgJiAxKSAqIDIuMCAtIDEuMDsKICAgICAgICAgICAgICAgICAgICBsZXQgbmV3QnVmZmVyID0gZHJ1bUJ1ZmZlciA+PiAxOwogICAgICAgICAgICAgICAgICAgIGlmICgoKGRydW1CdWZmZXIgKyBuZXdCdWZmZXIpICYgMSkgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBuZXdCdWZmZXIgKz0gMSA8PCAxNDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZHJ1bUJ1ZmZlciA9IG5ld0J1ZmZlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChpbmRleCA9PSAxKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IENvbmZpZy5jaGlwTm9pc2VMZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHdhdmVbaV0gPSBNYXRoLnJhbmRvbSgpICogMi4wIC0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGluZGV4ID09IDIpIHsKICAgICAgICAgICAgICAgIGxldCBkcnVtQnVmZmVyID0gMTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ29uZmlnLmNoaXBOb2lzZUxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgd2F2ZVtpXSA9IChkcnVtQnVmZmVyICYgMSkgKiAyLjAgLSAxLjA7CiAgICAgICAgICAgICAgICAgICAgbGV0IG5ld0J1ZmZlciA9IGRydW1CdWZmZXIgPj4gMTsKICAgICAgICAgICAgICAgICAgICBpZiAoKChkcnVtQnVmZmVyICsgbmV3QnVmZmVyKSAmIDEpID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3QnVmZmVyICs9IDIgPDwgMTQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGRydW1CdWZmZXIgPSBuZXdCdWZmZXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoaW5kZXggPT0gMykgewogICAgICAgICAgICAgICAgbGV0IGRydW1CdWZmZXIgPSAxOwogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBDb25maWcuY2hpcE5vaXNlTGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB3YXZlW2ldID0gKGRydW1CdWZmZXIgJiAxKSAqIDIuMCAtIDEuMDsKICAgICAgICAgICAgICAgICAgICBsZXQgbmV3QnVmZmVyID0gZHJ1bUJ1ZmZlciA+PiAxOwogICAgICAgICAgICAgICAgICAgIGlmICgoKGRydW1CdWZmZXIgKyBuZXdCdWZmZXIpICYgMSkgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBuZXdCdWZmZXIgKz0gMTAgPDwgMjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZHJ1bUJ1ZmZlciA9IG5ld0J1ZmZlcjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChpbmRleCA9PSA0KSB7CiAgICAgICAgICAgICAgICBkcmF3Tm9pc2VTcGVjdHJ1bSh3YXZlLCBDb25maWcuY2hpcE5vaXNlTGVuZ3RoLCAxMCwgMTEsIDEsIDEsIDApOwogICAgICAgICAgICAgICAgZHJhd05vaXNlU3BlY3RydW0od2F2ZSwgQ29uZmlnLmNoaXBOb2lzZUxlbmd0aCwgMTEsIDE0LCAuNjU3OCwgLjY1NzgsIDApOwogICAgICAgICAgICAgICAgaW52ZXJzZVJlYWxGb3VyaWVyVHJhbnNmb3JtKHdhdmUsIENvbmZpZy5jaGlwTm9pc2VMZW5ndGgpOwogICAgICAgICAgICAgICAgc2NhbGVFbGVtZW50c0J5RmFjdG9yKHdhdmUsIDEuMCAvIE1hdGguc3FydChDb25maWcuY2hpcE5vaXNlTGVuZ3RoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVucmVjb2duaXplZCBkcnVtIGluZGV4OiAiICsgaW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdhdmVbQ29uZmlnLmNoaXBOb2lzZUxlbmd0aF0gPSB3YXZlWzBdOwogICAgICAgIH0KICAgICAgICByZXR1cm4gd2F2ZTsKICAgIH0KICAgIGZ1bmN0aW9uIGRyYXdOb2lzZVNwZWN0cnVtKHdhdmUsIHdhdmVMZW5ndGgsIGxvd09jdGF2ZSwgaGlnaE9jdGF2ZSwgbG93UG93ZXIsIGhpZ2hQb3dlciwgb3ZlcmFsbFNsb3BlKSB7CiAgICAgICAgY29uc3QgcmVmZXJlbmNlT2N0YXZlID0gMTE7CiAgICAgICAgY29uc3QgcmVmZXJlbmNlSW5kZXggPSAxIDw8IHJlZmVyZW5jZU9jdGF2ZTsKICAgICAgICBjb25zdCBsb3dJbmRleCA9IE1hdGgucG93KDIsIGxvd09jdGF2ZSkgfCAwOwogICAgICAgIGNvbnN0IGhpZ2hJbmRleCA9IE1hdGgubWluKHdhdmVMZW5ndGggPj4gMSwgTWF0aC5wb3coMiwgaGlnaE9jdGF2ZSkgfCAwKTsKICAgICAgICBjb25zdCByZXRyb1dhdmUgPSBnZXREcnVtV2F2ZSgwLCBudWxsLCBudWxsKTsKICAgICAgICBsZXQgY29tYmluZWRBbXBsaXR1ZGUgPSAwLjA7CiAgICAgICAgZm9yIChsZXQgaSA9IGxvd0luZGV4OyBpIDwgaGlnaEluZGV4OyBpKyspIHsKICAgICAgICAgICAgbGV0IGxlcnBlZCA9IGxvd1Bvd2VyICsgKGhpZ2hQb3dlciAtIGxvd1Bvd2VyKSAqIChNYXRoLmxvZzIoaSkgLSBsb3dPY3RhdmUpIC8gKGhpZ2hPY3RhdmUgLSBsb3dPY3RhdmUpOwogICAgICAgICAgICBsZXQgYW1wbGl0dWRlID0gTWF0aC5wb3coMiwgKGxlcnBlZCAtIDEpICogNyArIDEpICogbGVycGVkOwogICAgICAgICAgICBhbXBsaXR1ZGUgKj0gTWF0aC5wb3coaSAvIHJlZmVyZW5jZUluZGV4LCBvdmVyYWxsU2xvcGUpOwogICAgICAgICAgICBjb21iaW5lZEFtcGxpdHVkZSArPSBhbXBsaXR1ZGU7CiAgICAgICAgICAgIGFtcGxpdHVkZSAqPSByZXRyb1dhdmVbaV07CiAgICAgICAgICAgIGNvbnN0IHJhZGlhbnMgPSAwLjYxODAzMzk4ODc1ICogaSAqIGkgKiBNYXRoLlBJICogMi4wOwogICAgICAgICAgICB3YXZlW2ldID0gTWF0aC5jb3MocmFkaWFucykgKiBhbXBsaXR1ZGU7CiAgICAgICAgICAgIHdhdmVbd2F2ZUxlbmd0aCAtIGldID0gTWF0aC5zaW4ocmFkaWFucykgKiBhbXBsaXR1ZGU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBjb21iaW5lZEFtcGxpdHVkZTsKICAgIH0KICAgIGZ1bmN0aW9uIGdlbmVyYXRlU2luZVdhdmUoKSB7CiAgICAgICAgY29uc3Qgd2F2ZSA9IG5ldyBGbG9hdDY0QXJyYXkoQ29uZmlnLnNpbmVXYXZlTGVuZ3RoICsgMSk7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBDb25maWcuc2luZVdhdmVMZW5ndGggKyAxOyBpKyspIHsKICAgICAgICAgICAgd2F2ZVtpXSA9IE1hdGguc2luKGkgKiBNYXRoLlBJICogMi4wIC8gQ29uZmlnLnNpbmVXYXZlTGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHdhdmU7CiAgICB9CiAgICBmdW5jdGlvbiBnZXRBcnBlZ2dpb1BpdGNoSW5kZXgocGl0Y2hDb3VudCwgcmh5dGhtLCBhcnBlZ2dpbykgewogICAgICAgIGNvbnN0IGFycGVnZ2lvUGF0dGVybiA9IENvbmZpZy5yaHl0aG1zW3JoeXRobV0uYXJwZWdnaW9QYXR0ZXJuc1twaXRjaENvdW50IC0gMV07CiAgICAgICAgaWYgKGFycGVnZ2lvUGF0dGVybiAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiBhcnBlZ2dpb1BhdHRlcm5bYXJwZWdnaW8gJSBhcnBlZ2dpb1BhdHRlcm4ubGVuZ3RoXTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBhcnBlZ2dpbyAlIHBpdGNoQ291bnQ7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gdG9OYW1lTWFwKGFycmF5KSB7CiAgICAgICAgY29uc3QgZGljdGlvbmFyeSA9IHt9OwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBhcnJheVtpXTsKICAgICAgICAgICAgdmFsdWUuaW5kZXggPSBpOwogICAgICAgICAgICBkaWN0aW9uYXJ5W3ZhbHVlLm5hbWVdID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3VsdCA9IGFycmF5OwogICAgICAgIHJlc3VsdC5kaWN0aW9uYXJ5ID0gZGljdGlvbmFyeTsKICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQogICAgZnVuY3Rpb24gZWZmZWN0c0luY2x1ZGVUcmFuc2l0aW9uKGVmZmVjdHMpIHsKICAgICAgICByZXR1cm4gKGVmZmVjdHMgJiAoMSA8PCAxMCkpICE9IDA7CiAgICB9CiAgICBmdW5jdGlvbiBlZmZlY3RzSW5jbHVkZUNob3JkKGVmZmVjdHMpIHsKICAgICAgICByZXR1cm4gKGVmZmVjdHMgJiAoMSA8PCAxMSkpICE9IDA7CiAgICB9CiAgICBmdW5jdGlvbiBlZmZlY3RzSW5jbHVkZVBpdGNoU2hpZnQoZWZmZWN0cykgewogICAgICAgIHJldHVybiAoZWZmZWN0cyAmICgxIDw8IDcpKSAhPSAwOwogICAgfQogICAgZnVuY3Rpb24gZWZmZWN0c0luY2x1ZGVEZXR1bmUoZWZmZWN0cykgewogICAgICAgIHJldHVybiAoZWZmZWN0cyAmICgxIDw8IDgpKSAhPSAwOwogICAgfQogICAgZnVuY3Rpb24gZWZmZWN0c0luY2x1ZGVWaWJyYXRvKGVmZmVjdHMpIHsKICAgICAgICByZXR1cm4gKGVmZmVjdHMgJiAoMSA8PCA5KSkgIT0gMDsKICAgIH0KICAgIGZ1bmN0aW9uIGVmZmVjdHNJbmNsdWRlTm90ZUZpbHRlcihlZmZlY3RzKSB7CiAgICAgICAgcmV0dXJuIChlZmZlY3RzICYgKDEgPDwgNSkpICE9IDA7CiAgICB9CiAgICBmdW5jdGlvbiBlZmZlY3RzSW5jbHVkZURpc3RvcnRpb24oZWZmZWN0cykgewogICAgICAgIHJldHVybiAoZWZmZWN0cyAmICgxIDw8IDMpKSAhPSAwOwogICAgfQogICAgZnVuY3Rpb24gZWZmZWN0c0luY2x1ZGVCaXRjcnVzaGVyKGVmZmVjdHMpIHsKICAgICAgICByZXR1cm4gKGVmZmVjdHMgJiAoMSA8PCA0KSkgIT0gMDsKICAgIH0KICAgIGZ1bmN0aW9uIGVmZmVjdHNJbmNsdWRlUGFubmluZyhlZmZlY3RzKSB7CiAgICAgICAgcmV0dXJuIChlZmZlY3RzICYgKDEgPDwgMikpICE9IDA7CiAgICB9CiAgICBmdW5jdGlvbiBlZmZlY3RzSW5jbHVkZUNob3J1cyhlZmZlY3RzKSB7CiAgICAgICAgcmV0dXJuIChlZmZlY3RzICYgKDEgPDwgMSkpICE9IDA7CiAgICB9CiAgICBmdW5jdGlvbiBlZmZlY3RzSW5jbHVkZUVjaG8oZWZmZWN0cykgewogICAgICAgIHJldHVybiAoZWZmZWN0cyAmICgxIDw8IDYpKSAhPSAwOwogICAgfQogICAgZnVuY3Rpb24gZWZmZWN0c0luY2x1ZGVSZXZlcmIoZWZmZWN0cykgewogICAgICAgIHJldHVybiAoZWZmZWN0cyAmICgxIDw8IDApKSAhPSAwOwogICAgfQoKICAgIGZ1bmN0aW9uIHNjYWxlRWxlbWVudHNCeUZhY3RvcihhcnJheSwgZmFjdG9yKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhcnJheVtpXSAqPSBmYWN0b3I7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaXNQb3dlck9mMihuKSB7CiAgICAgICAgcmV0dXJuICEhbiAmJiAhKG4gJiAobiAtIDEpKTsKICAgIH0KICAgIGZ1bmN0aW9uIGNvdW50Qml0cyhuKSB7CiAgICAgICAgaWYgKCFpc1Bvd2VyT2YyKG4pKQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkZGVCBhcnJheSBsZW5ndGggbXVzdCBiZSBhIHBvd2VyIG9mIDIuIik7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoTWF0aC5sb2cobikgLyBNYXRoLmxvZygyKSk7CiAgICB9CiAgICBmdW5jdGlvbiByZXZlcnNlSW5kZXhCaXRzKGFycmF5LCBmdWxsQXJyYXlMZW5ndGgpIHsKICAgICAgICBjb25zdCBiaXRDb3VudCA9IGNvdW50Qml0cyhmdWxsQXJyYXlMZW5ndGgpOwogICAgICAgIGlmIChiaXRDb3VudCA+IDE2KQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkZGVCBhcnJheSBsZW5ndGggbXVzdCBub3QgYmUgZ3JlYXRlciB0aGFuIDJeMTYuIik7CiAgICAgICAgY29uc3QgZmluYWxTaGlmdCA9IDE2IC0gYml0Q291bnQ7CiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmdWxsQXJyYXlMZW5ndGg7IGkrKykgewogICAgICAgICAgICBsZXQgajsKICAgICAgICAgICAgaiA9ICgoaSAmIDB4YWFhYSkgPj4gMSkgfCAoKGkgJiAweDU1NTUpIDw8IDEpOwogICAgICAgICAgICBqID0gKChqICYgMHhjY2NjKSA+PiAyKSB8ICgoaiAmIDB4MzMzMykgPDwgMik7CiAgICAgICAgICAgIGogPSAoKGogJiAweGYwZjApID4+IDQpIHwgKChqICYgMHgwZjBmKSA8PCA0KTsKICAgICAgICAgICAgaiA9ICgoaiA+PiA4KSB8ICgoaiAmIDB4ZmYpIDw8IDgpKSA+PiBmaW5hbFNoaWZ0OwogICAgICAgICAgICBpZiAoaiA+IGkpIHsKICAgICAgICAgICAgICAgIGxldCB0ZW1wID0gYXJyYXlbaV07CiAgICAgICAgICAgICAgICBhcnJheVtpXSA9IGFycmF5W2pdOwogICAgICAgICAgICAgICAgYXJyYXlbal0gPSB0ZW1wOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gaW52ZXJzZVJlYWxGb3VyaWVyVHJhbnNmb3JtKGFycmF5LCBmdWxsQXJyYXlMZW5ndGgpIHsKICAgICAgICBjb25zdCB0b3RhbFBhc3NlcyA9IGNvdW50Qml0cyhmdWxsQXJyYXlMZW5ndGgpOwogICAgICAgIGlmIChmdWxsQXJyYXlMZW5ndGggPCA0KQogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkZGVCBhcnJheSBsZW5ndGggbXVzdCBiZSBhdCBsZWFzdCA0LiIpOwogICAgICAgIGZvciAobGV0IHBhc3MgPSB0b3RhbFBhc3NlcyAtIDE7IHBhc3MgPj0gMjsgcGFzcy0tKSB7CiAgICAgICAgICAgIGNvbnN0IHN1YlN0cmlkZSA9IDEgPDwgcGFzczsKICAgICAgICAgICAgY29uc3QgbWlkU3ViU3RyaWRlID0gc3ViU3RyaWRlID4+IDE7CiAgICAgICAgICAgIGNvbnN0IHN0cmlkZSA9IHN1YlN0cmlkZSA8PCAxOwogICAgICAgICAgICBjb25zdCByYWRpYW5zSW5jcmVtZW50ID0gTWF0aC5QSSAqIDIuMCAvIHN0cmlkZTsKICAgICAgICAgICAgY29uc3QgY29zSW5jcmVtZW50ID0gTWF0aC5jb3MocmFkaWFuc0luY3JlbWVudCk7CiAgICAgICAgICAgIGNvbnN0IHNpbkluY3JlbWVudCA9IE1hdGguc2luKHJhZGlhbnNJbmNyZW1lbnQpOwogICAgICAgICAgICBjb25zdCBvc2NpbGxhdG9yTXVsdGlwbGllciA9IDIuMCAqIGNvc0luY3JlbWVudDsKICAgICAgICAgICAgZm9yIChsZXQgc3RhcnRJbmRleCA9IDA7IHN0YXJ0SW5kZXggPCBmdWxsQXJyYXlMZW5ndGg7IHN0YXJ0SW5kZXggKz0gc3RyaWRlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzdGFydEluZGV4QSA9IHN0YXJ0SW5kZXg7CiAgICAgICAgICAgICAgICBjb25zdCBtaWRJbmRleEEgPSBzdGFydEluZGV4QSArIG1pZFN1YlN0cmlkZTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0SW5kZXhCID0gc3RhcnRJbmRleEEgKyBzdWJTdHJpZGU7CiAgICAgICAgICAgICAgICBjb25zdCBtaWRJbmRleEIgPSBzdGFydEluZGV4QiArIG1pZFN1YlN0cmlkZTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0b3BJbmRleCA9IHN0YXJ0SW5kZXhCICsgc3ViU3RyaWRlOwogICAgICAgICAgICAgICAgY29uc3QgcmVhbFN0YXJ0QSA9IGFycmF5W3N0YXJ0SW5kZXhBXTsKICAgICAgICAgICAgICAgIGNvbnN0IGltYWdTdGFydEIgPSBhcnJheVtzdGFydEluZGV4Ql07CiAgICAgICAgICAgICAgICBhcnJheVtzdGFydEluZGV4QV0gPSByZWFsU3RhcnRBICsgaW1hZ1N0YXJ0QjsKICAgICAgICAgICAgICAgIGFycmF5W21pZEluZGV4QV0gKj0gMjsKICAgICAgICAgICAgICAgIGFycmF5W3N0YXJ0SW5kZXhCXSA9IHJlYWxTdGFydEEgLSBpbWFnU3RhcnRCOwogICAgICAgICAgICAgICAgYXJyYXlbbWlkSW5kZXhCXSAqPSAyOwogICAgICAgICAgICAgICAgbGV0IGMgPSBjb3NJbmNyZW1lbnQ7CiAgICAgICAgICAgICAgICBsZXQgcyA9IC1zaW5JbmNyZW1lbnQ7CiAgICAgICAgICAgICAgICBsZXQgY1ByZXYgPSAxLjA7CiAgICAgICAgICAgICAgICBsZXQgc1ByZXYgPSAwLjA7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDE7IGluZGV4IDwgbWlkU3ViU3RyaWRlOyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXhBMCA9IHN0YXJ0SW5kZXhBICsgaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXhBMSA9IHN0YXJ0SW5kZXhCIC0gaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXhCMCA9IHN0YXJ0SW5kZXhCICsgaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5kZXhCMSA9IHN0b3BJbmRleCAtIGluZGV4OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYWwwID0gYXJyYXlbaW5kZXhBMF07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhbDEgPSBhcnJheVtpbmRleEExXTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbWFnMCA9IGFycmF5W2luZGV4QjBdOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGltYWcxID0gYXJyYXlbaW5kZXhCMV07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVtcEEgPSByZWFsMCAtIHJlYWwxOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBCID0gaW1hZzAgKyBpbWFnMTsKICAgICAgICAgICAgICAgICAgICBhcnJheVtpbmRleEEwXSA9IHJlYWwwICsgcmVhbDE7CiAgICAgICAgICAgICAgICAgICAgYXJyYXlbaW5kZXhBMV0gPSBpbWFnMSAtIGltYWcwOwogICAgICAgICAgICAgICAgICAgIGFycmF5W2luZGV4QjBdID0gdGVtcEEgKiBjIC0gdGVtcEIgKiBzOwogICAgICAgICAgICAgICAgICAgIGFycmF5W2luZGV4QjFdID0gdGVtcEIgKiBjICsgdGVtcEEgKiBzOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNUZW1wID0gb3NjaWxsYXRvck11bHRpcGxpZXIgKiBjIC0gY1ByZXY7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc1RlbXAgPSBvc2NpbGxhdG9yTXVsdGlwbGllciAqIHMgLSBzUHJldjsKICAgICAgICAgICAgICAgICAgICBjUHJldiA9IGM7CiAgICAgICAgICAgICAgICAgICAgc1ByZXYgPSBzOwogICAgICAgICAgICAgICAgICAgIGMgPSBjVGVtcDsKICAgICAgICAgICAgICAgICAgICBzID0gc1RlbXA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGZ1bGxBcnJheUxlbmd0aDsgaW5kZXggKz0gNCkgewogICAgICAgICAgICBjb25zdCBpbmRleDEgPSBpbmRleCArIDE7CiAgICAgICAgICAgIGNvbnN0IGluZGV4MiA9IGluZGV4ICsgMjsKICAgICAgICAgICAgY29uc3QgaW5kZXgzID0gaW5kZXggKyAzOwogICAgICAgICAgICBjb25zdCByZWFsMCA9IGFycmF5W2luZGV4XTsKICAgICAgICAgICAgY29uc3QgcmVhbDEgPSBhcnJheVtpbmRleDFdICogMjsKICAgICAgICAgICAgY29uc3QgaW1hZzIgPSBhcnJheVtpbmRleDJdOwogICAgICAgICAgICBjb25zdCBpbWFnMyA9IGFycmF5W2luZGV4M10gKiAyOwogICAgICAgICAgICBjb25zdCB0ZW1wQSA9IHJlYWwwICsgaW1hZzI7CiAgICAgICAgICAgIGNvbnN0IHRlbXBCID0gcmVhbDAgLSBpbWFnMjsKICAgICAgICAgICAgYXJyYXlbaW5kZXhdID0gdGVtcEEgKyByZWFsMTsKICAgICAgICAgICAgYXJyYXlbaW5kZXgxXSA9IHRlbXBBIC0gcmVhbDE7CiAgICAgICAgICAgIGFycmF5W2luZGV4Ml0gPSB0ZW1wQiArIGltYWczOwogICAgICAgICAgICBhcnJheVtpbmRleDNdID0gdGVtcEIgLSBpbWFnMzsKICAgICAgICB9CiAgICAgICAgcmV2ZXJzZUluZGV4Qml0cyhhcnJheSwgZnVsbEFycmF5TGVuZ3RoKTsKICAgIH0KCiAgICBjbGFzcyBEZXF1ZSB7CiAgICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgICAgIHRoaXMuX2NhcGFjaXR5ID0gMTsKICAgICAgICAgICAgdGhpcy5fYnVmZmVyID0gW3VuZGVmaW5lZF07CiAgICAgICAgICAgIHRoaXMuX21hc2sgPSAwOwogICAgICAgICAgICB0aGlzLl9vZmZzZXQgPSAwOwogICAgICAgICAgICB0aGlzLl9jb3VudCA9IDA7CiAgICAgICAgfQogICAgICAgIHB1c2hGcm9udChlbGVtZW50KSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9jb3VudCA+PSB0aGlzLl9jYXBhY2l0eSkKICAgICAgICAgICAgICAgIHRoaXMuX2V4cGFuZENhcGFjaXR5KCk7CiAgICAgICAgICAgIHRoaXMuX29mZnNldCA9ICh0aGlzLl9vZmZzZXQgLSAxKSAmIHRoaXMuX21hc2s7CiAgICAgICAgICAgIHRoaXMuX2J1ZmZlclt0aGlzLl9vZmZzZXRdID0gZWxlbWVudDsKICAgICAgICAgICAgdGhpcy5fY291bnQrKzsKICAgICAgICB9CiAgICAgICAgcHVzaEJhY2soZWxlbWVudCkgewogICAgICAgICAgICBpZiAodGhpcy5fY291bnQgPj0gdGhpcy5fY2FwYWNpdHkpCiAgICAgICAgICAgICAgICB0aGlzLl9leHBhbmRDYXBhY2l0eSgpOwogICAgICAgICAgICB0aGlzLl9idWZmZXJbKHRoaXMuX29mZnNldCArIHRoaXMuX2NvdW50KSAmIHRoaXMuX21hc2tdID0gZWxlbWVudDsKICAgICAgICAgICAgdGhpcy5fY291bnQrKzsKICAgICAgICB9CiAgICAgICAgcG9wRnJvbnQoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9jb3VudCA8PSAwKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyBlbGVtZW50cyBsZWZ0IHRvIHBvcC4iKTsKICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMuX2J1ZmZlclt0aGlzLl9vZmZzZXRdOwogICAgICAgICAgICB0aGlzLl9idWZmZXJbdGhpcy5fb2Zmc2V0XSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgdGhpcy5fb2Zmc2V0ID0gKHRoaXMuX29mZnNldCArIDEpICYgdGhpcy5fbWFzazsKICAgICAgICAgICAgdGhpcy5fY291bnQtLTsKICAgICAgICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICAgICAgfQogICAgICAgIHBvcEJhY2soKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9jb3VudCA8PSAwKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyBlbGVtZW50cyBsZWZ0IHRvIHBvcC4iKTsKICAgICAgICAgICAgdGhpcy5fY291bnQtLTsKICAgICAgICAgICAgY29uc3QgaW5kZXggPSAodGhpcy5fb2Zmc2V0ICsgdGhpcy5fY291bnQpICYgdGhpcy5fbWFzazsKICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMuX2J1ZmZlcltpbmRleF07CiAgICAgICAgICAgIHRoaXMuX2J1ZmZlcltpbmRleF0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50OwogICAgICAgIH0KICAgICAgICBwZWFrRnJvbnQoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9jb3VudCA8PSAwKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyBlbGVtZW50cyBsZWZ0IHRvIHBvcC4iKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2J1ZmZlclt0aGlzLl9vZmZzZXRdOwogICAgICAgIH0KICAgICAgICBwZWFrQmFjaygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2NvdW50IDw9IDApCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vIGVsZW1lbnRzIGxlZnQgdG8gcG9wLiIpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fYnVmZmVyWyh0aGlzLl9vZmZzZXQgKyB0aGlzLl9jb3VudCAtIDEpICYgdGhpcy5fbWFza107CiAgICAgICAgfQogICAgICAgIGNvdW50KCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fY291bnQ7CiAgICAgICAgfQogICAgICAgIHNldChpbmRleCwgZWxlbWVudCkgewogICAgICAgICAgICBpZiAoaW5kZXggPCAwIHx8IGluZGV4ID49IHRoaXMuX2NvdW50KQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGluZGV4Iik7CiAgICAgICAgICAgIHRoaXMuX2J1ZmZlclsodGhpcy5fb2Zmc2V0ICsgaW5kZXgpICYgdGhpcy5fbWFza10gPSBlbGVtZW50OwogICAgICAgIH0KICAgICAgICBnZXQoaW5kZXgpIHsKICAgICAgICAgICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLl9jb3VudCkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBpbmRleCIpOwogICAgICAgICAgICByZXR1cm4gdGhpcy5fYnVmZmVyWyh0aGlzLl9vZmZzZXQgKyBpbmRleCkgJiB0aGlzLl9tYXNrXTsKICAgICAgICB9CiAgICAgICAgcmVtb3ZlKGluZGV4KSB7CiAgICAgICAgICAgIGlmIChpbmRleCA8IDAgfHwgaW5kZXggPj0gdGhpcy5fY291bnQpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgaW5kZXgiKTsKICAgICAgICAgICAgaWYgKGluZGV4IDw9ICh0aGlzLl9jb3VudCA+PiAxKSkgewogICAgICAgICAgICAgICAgd2hpbGUgKGluZGV4ID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0KGluZGV4LCB0aGlzLmdldChpbmRleCAtIDEpKTsKICAgICAgICAgICAgICAgICAgICBpbmRleC0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wb3BGcm9udCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgIHdoaWxlIChpbmRleCA8IHRoaXMuX2NvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXQoaW5kZXggLSAxLCB0aGlzLmdldChpbmRleCkpOwogICAgICAgICAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLnBvcEJhY2soKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBfZXhwYW5kQ2FwYWNpdHkoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9jYXBhY2l0eSA+PSAweDQwMDAwMDAwKQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYXBhY2l0eSB0b28gYmlnLiIpOwogICAgICAgICAgICB0aGlzLl9jYXBhY2l0eSA9IHRoaXMuX2NhcGFjaXR5IDw8IDE7CiAgICAgICAgICAgIGNvbnN0IG9sZEJ1ZmZlciA9IHRoaXMuX2J1ZmZlcjsKICAgICAgICAgICAgY29uc3QgbmV3QnVmZmVyID0gbmV3IEFycmF5KHRoaXMuX2NhcGFjaXR5KTsKICAgICAgICAgICAgY29uc3Qgc2l6ZSA9IHRoaXMuX2NvdW50IHwgMDsKICAgICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gdGhpcy5fb2Zmc2V0IHwgMDsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHsKICAgICAgICAgICAgICAgIG5ld0J1ZmZlcltpXSA9IG9sZEJ1ZmZlclsob2Zmc2V0ICsgaSkgJiB0aGlzLl9tYXNrXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGxldCBpID0gc2l6ZTsgaSA8IHRoaXMuX2NhcGFjaXR5OyBpKyspIHsKICAgICAgICAgICAgICAgIG5ld0J1ZmZlcltpXSA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9vZmZzZXQgPSAwOwogICAgICAgICAgICB0aGlzLl9idWZmZXIgPSBuZXdCdWZmZXI7CiAgICAgICAgICAgIHRoaXMuX21hc2sgPSB0aGlzLl9jYXBhY2l0eSAtIDE7CiAgICAgICAgfQogICAgfQoKICAgIGNsYXNzIEZpbHRlckNvZWZmaWNpZW50cyB7CiAgICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgICAgIHRoaXMuYSA9IFsxLjBdOwogICAgICAgICAgICB0aGlzLmIgPSBbMS4wXTsKICAgICAgICAgICAgdGhpcy5vcmRlciA9IDA7CiAgICAgICAgfQogICAgICAgIGxpbmVhckdhaW4wdGhPcmRlcihsaW5lYXJHYWluKSB7CiAgICAgICAgICAgIHRoaXMuYlswXSA9IGxpbmVhckdhaW47CiAgICAgICAgICAgIHRoaXMub3JkZXIgPSAwOwogICAgICAgIH0KICAgICAgICBsb3dQYXNzMXN0T3JkZXJCdXR0ZXJ3b3J0aChjb3JuZXJSYWRpYW5zUGVyU2FtcGxlKSB7CiAgICAgICAgICAgIGNvbnN0IGcgPSAxLjAgLyBNYXRoLnRhbihjb3JuZXJSYWRpYW5zUGVyU2FtcGxlICogMC41KTsKICAgICAgICAgICAgY29uc3QgYTAgPSAxLjAgKyBnOwogICAgICAgICAgICB0aGlzLmFbMV0gPSAoMS4wIC0gZykgLyBhMDsKICAgICAgICAgICAgdGhpcy5iWzFdID0gdGhpcy5iWzBdID0gMSAvIGEwOwogICAgICAgICAgICB0aGlzLm9yZGVyID0gMTsKICAgICAgICB9CiAgICAgICAgbG93UGFzczFzdE9yZGVyU2ltcGxpZmllZChjb3JuZXJSYWRpYW5zUGVyU2FtcGxlKSB7CiAgICAgICAgICAgIGNvbnN0IGcgPSAyLjAgKiBNYXRoLnNpbihjb3JuZXJSYWRpYW5zUGVyU2FtcGxlICogMC41KTsKICAgICAgICAgICAgdGhpcy5hWzFdID0gZyAtIDEuMDsKICAgICAgICAgICAgdGhpcy5iWzBdID0gZzsKICAgICAgICAgICAgdGhpcy5iWzFdID0gMC4wOwogICAgICAgICAgICB0aGlzLm9yZGVyID0gMTsKICAgICAgICB9CiAgICAgICAgaGlnaFBhc3Mxc3RPcmRlckJ1dHRlcndvcnRoKGNvcm5lclJhZGlhbnNQZXJTYW1wbGUpIHsKICAgICAgICAgICAgY29uc3QgZyA9IDEuMCAvIE1hdGgudGFuKGNvcm5lclJhZGlhbnNQZXJTYW1wbGUgKiAwLjUpOwogICAgICAgICAgICBjb25zdCBhMCA9IDEuMCArIGc7CiAgICAgICAgICAgIHRoaXMuYVsxXSA9ICgxLjAgLSBnKSAvIGEwOwogICAgICAgICAgICB0aGlzLmJbMF0gPSBnIC8gYTA7CiAgICAgICAgICAgIHRoaXMuYlsxXSA9IC1nIC8gYTA7CiAgICAgICAgICAgIHRoaXMub3JkZXIgPSAxOwogICAgICAgIH0KICAgICAgICBoaWdoU2hlbGYxc3RPcmRlcihjb3JuZXJSYWRpYW5zUGVyU2FtcGxlLCBzaGVsZkxpbmVhckdhaW4pIHsKICAgICAgICAgICAgY29uc3QgdGFuID0gTWF0aC50YW4oY29ybmVyUmFkaWFuc1BlclNhbXBsZSAqIDAuNSk7CiAgICAgICAgICAgIGNvbnN0IHNxcnRHYWluID0gTWF0aC5zcXJ0KHNoZWxmTGluZWFyR2Fpbik7CiAgICAgICAgICAgIGNvbnN0IGcgPSAodGFuICogc3FydEdhaW4gLSAxKSAvICh0YW4gKiBzcXJ0R2FpbiArIDEuMCk7CiAgICAgICAgICAgIGNvbnN0IGEwID0gMS4wOwogICAgICAgICAgICB0aGlzLmFbMV0gPSBnIC8gYTA7CiAgICAgICAgICAgIHRoaXMuYlswXSA9ICgxLjAgKyBnICsgc2hlbGZMaW5lYXJHYWluICogKDEuMCAtIGcpKSAvICgyLjAgKiBhMCk7CiAgICAgICAgICAgIHRoaXMuYlsxXSA9ICgxLjAgKyBnIC0gc2hlbGZMaW5lYXJHYWluICogKDEuMCAtIGcpKSAvICgyLjAgKiBhMCk7CiAgICAgICAgICAgIHRoaXMub3JkZXIgPSAxOwogICAgICAgIH0KICAgICAgICBhbGxQYXNzMXN0T3JkZXJJbnZlcnRQaGFzZUFib3ZlKGNvcm5lclJhZGlhbnNQZXJTYW1wbGUpIHsKICAgICAgICAgICAgY29uc3QgZyA9IChNYXRoLnNpbihjb3JuZXJSYWRpYW5zUGVyU2FtcGxlKSAtIDEuMCkgLyBNYXRoLmNvcyhjb3JuZXJSYWRpYW5zUGVyU2FtcGxlKTsKICAgICAgICAgICAgdGhpcy5hWzFdID0gZzsKICAgICAgICAgICAgdGhpcy5iWzBdID0gZzsKICAgICAgICAgICAgdGhpcy5iWzFdID0gMS4wOwogICAgICAgICAgICB0aGlzLm9yZGVyID0gMTsKICAgICAgICB9CiAgICAgICAgYWxsUGFzczFzdE9yZGVyRnJhY3Rpb25hbERlbGF5KGRlbGF5KSB7CiAgICAgICAgICAgIGNvbnN0IGcgPSAoMS4wIC0gZGVsYXkpIC8gKDEuMCArIGRlbGF5KTsKICAgICAgICAgICAgdGhpcy5hWzFdID0gZzsKICAgICAgICAgICAgdGhpcy5iWzBdID0gZzsKICAgICAgICAgICAgdGhpcy5iWzFdID0gMS4wOwogICAgICAgICAgICB0aGlzLm9yZGVyID0gMTsKICAgICAgICB9CiAgICAgICAgbG93UGFzczJuZE9yZGVyQnV0dGVyd29ydGgoY29ybmVyUmFkaWFuc1BlclNhbXBsZSwgcGVha0xpbmVhckdhaW4pIHsKICAgICAgICAgICAgY29uc3QgYWxwaGEgPSBNYXRoLnNpbihjb3JuZXJSYWRpYW5zUGVyU2FtcGxlKSAvICgyLjAgKiBwZWFrTGluZWFyR2Fpbik7CiAgICAgICAgICAgIGNvbnN0IGNvcyA9IE1hdGguY29zKGNvcm5lclJhZGlhbnNQZXJTYW1wbGUpOwogICAgICAgICAgICBjb25zdCBhMCA9IDEuMCArIGFscGhhOwogICAgICAgICAgICB0aGlzLmFbMV0gPSAtMi4wICogY29zIC8gYTA7CiAgICAgICAgICAgIHRoaXMuYVsyXSA9ICgxIC0gYWxwaGEpIC8gYTA7CiAgICAgICAgICAgIHRoaXMuYlsyXSA9IHRoaXMuYlswXSA9ICgxIC0gY29zKSAvICgyLjAgKiBhMCk7CiAgICAgICAgICAgIHRoaXMuYlsxXSA9ICgxIC0gY29zKSAvIGEwOwogICAgICAgICAgICB0aGlzLm9yZGVyID0gMjsKICAgICAgICB9CiAgICAgICAgbG93UGFzczJuZE9yZGVyU2ltcGxpZmllZChjb3JuZXJSYWRpYW5zUGVyU2FtcGxlLCBwZWFrTGluZWFyR2FpbikgewogICAgICAgICAgICBjb25zdCBnID0gMi4wICogTWF0aC5zaW4oY29ybmVyUmFkaWFuc1BlclNhbXBsZSAvIDIuMCk7CiAgICAgICAgICAgIGNvbnN0IGZpbHRlclJlc29uYW5jZSA9IDEuMCAtIDEuMCAvICgyLjAgKiBwZWFrTGluZWFyR2Fpbik7CiAgICAgICAgICAgIGNvbnN0IGZlZWRiYWNrID0gZmlsdGVyUmVzb25hbmNlICsgZmlsdGVyUmVzb25hbmNlIC8gKDEuMCAtIGcpOwogICAgICAgICAgICB0aGlzLmFbMV0gPSAyLjAgKiBnICsgKGcgLSAxLjApICogZyAqIGZlZWRiYWNrIC0gMi4wOwogICAgICAgICAgICB0aGlzLmFbMl0gPSAoZyAtIDEuMCkgKiAoZyAtIGcgKiBmZWVkYmFjayAtIDEuMCk7CiAgICAgICAgICAgIHRoaXMuYlswXSA9IGcgKiBnOwogICAgICAgICAgICB0aGlzLmJbMV0gPSAwOwogICAgICAgICAgICB0aGlzLmJbMl0gPSAwOwogICAgICAgICAgICB0aGlzLm9yZGVyID0gMjsKICAgICAgICB9CiAgICAgICAgaGlnaFBhc3MybmRPcmRlckJ1dHRlcndvcnRoKGNvcm5lclJhZGlhbnNQZXJTYW1wbGUsIHBlYWtMaW5lYXJHYWluKSB7CiAgICAgICAgICAgIGNvbnN0IGFscGhhID0gTWF0aC5zaW4oY29ybmVyUmFkaWFuc1BlclNhbXBsZSkgLyAoMiAqIHBlYWtMaW5lYXJHYWluKTsKICAgICAgICAgICAgY29uc3QgY29zID0gTWF0aC5jb3MoY29ybmVyUmFkaWFuc1BlclNhbXBsZSk7CiAgICAgICAgICAgIGNvbnN0IGEwID0gMS4wICsgYWxwaGE7CiAgICAgICAgICAgIHRoaXMuYVsxXSA9IC0yLjAgKiBjb3MgLyBhMDsKICAgICAgICAgICAgdGhpcy5hWzJdID0gKDEuMCAtIGFscGhhKSAvIGEwOwogICAgICAgICAgICB0aGlzLmJbMl0gPSB0aGlzLmJbMF0gPSAoMS4wICsgY29zKSAvICgyLjAgKiBhMCk7CiAgICAgICAgICAgIHRoaXMuYlsxXSA9IC0oMS4wICsgY29zKSAvIGEwOwogICAgICAgICAgICB0aGlzLm9yZGVyID0gMjsKICAgICAgICB9CiAgICAgICAgcGVhazJuZE9yZGVyKGNvcm5lclJhZGlhbnNQZXJTYW1wbGUsIHBlYWtMaW5lYXJHYWluLCBiYW5kV2lkdGhTY2FsZSkgewogICAgICAgICAgICBjb25zdCBzcXJ0R2FpbiA9IE1hdGguc3FydChwZWFrTGluZWFyR2Fpbik7CiAgICAgICAgICAgIGNvbnN0IGJhbmRXaWR0aCA9IGJhbmRXaWR0aFNjYWxlICogY29ybmVyUmFkaWFuc1BlclNhbXBsZSAvIChzcXJ0R2FpbiA+PSAxID8gc3FydEdhaW4gOiAxIC8gc3FydEdhaW4pOwogICAgICAgICAgICBjb25zdCBhbHBoYSA9IE1hdGgudGFuKGJhbmRXaWR0aCAqIDAuNSk7CiAgICAgICAgICAgIGNvbnN0IGEwID0gMS4wICsgYWxwaGEgLyBzcXJ0R2FpbjsKICAgICAgICAgICAgdGhpcy5iWzBdID0gKDEuMCArIGFscGhhICogc3FydEdhaW4pIC8gYTA7CiAgICAgICAgICAgIHRoaXMuYlsxXSA9IHRoaXMuYVsxXSA9IC0yLjAgKiBNYXRoLmNvcyhjb3JuZXJSYWRpYW5zUGVyU2FtcGxlKSAvIGEwOwogICAgICAgICAgICB0aGlzLmJbMl0gPSAoMS4wIC0gYWxwaGEgKiBzcXJ0R2FpbikgLyBhMDsKICAgICAgICAgICAgdGhpcy5hWzJdID0gKDEuMCAtIGFscGhhIC8gc3FydEdhaW4pIC8gYTA7CiAgICAgICAgICAgIHRoaXMub3JkZXIgPSAyOwogICAgICAgIH0KICAgIH0KICAgIGNsYXNzIEZyZXF1ZW5jeVJlc3BvbnNlIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5yZWFsID0gMC4wOwogICAgICAgICAgICB0aGlzLmltYWcgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZGVub20gPSAxLjA7CiAgICAgICAgfQogICAgICAgIGFuYWx5emUoZmlsdGVyLCByYWRpYW5zUGVyU2FtcGxlKSB7CiAgICAgICAgICAgIHRoaXMuYW5hbHl6ZUNvbXBsZXgoZmlsdGVyLCBNYXRoLmNvcyhyYWRpYW5zUGVyU2FtcGxlKSwgTWF0aC5zaW4ocmFkaWFuc1BlclNhbXBsZSkpOwogICAgICAgIH0KICAgICAgICBhbmFseXplQ29tcGxleChmaWx0ZXIsIHJlYWwsIGltYWcpIHsKICAgICAgICAgICAgY29uc3QgYSA9IGZpbHRlci5hOwogICAgICAgICAgICBjb25zdCBiID0gZmlsdGVyLmI7CiAgICAgICAgICAgIGNvbnN0IHJlYWxaMSA9IHJlYWw7CiAgICAgICAgICAgIGNvbnN0IGltYWdaMSA9IC1pbWFnOwogICAgICAgICAgICBsZXQgcmVhbE51bSA9IGJbMF0gKyBiWzFdICogcmVhbFoxOwogICAgICAgICAgICBsZXQgaW1hZ051bSA9IGJbMV0gKiBpbWFnWjE7CiAgICAgICAgICAgIGxldCByZWFsRGVub20gPSAxLjAgKyBhWzFdICogcmVhbFoxOwogICAgICAgICAgICBsZXQgaW1hZ0Rlbm9tID0gYVsxXSAqIGltYWdaMTsKICAgICAgICAgICAgbGV0IHJlYWxaID0gcmVhbFoxOwogICAgICAgICAgICBsZXQgaW1hZ1ogPSBpbWFnWjE7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAyOyBpIDw9IGZpbHRlci5vcmRlcjsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCByZWFsVGVtcCA9IHJlYWxaICogcmVhbFoxIC0gaW1hZ1ogKiBpbWFnWjE7CiAgICAgICAgICAgICAgICBjb25zdCBpbWFnVGVtcCA9IHJlYWxaICogaW1hZ1oxICsgaW1hZ1ogKiByZWFsWjE7CiAgICAgICAgICAgICAgICByZWFsWiA9IHJlYWxUZW1wOwogICAgICAgICAgICAgICAgaW1hZ1ogPSBpbWFnVGVtcDsKICAgICAgICAgICAgICAgIHJlYWxOdW0gKz0gYltpXSAqIHJlYWxaOwogICAgICAgICAgICAgICAgaW1hZ051bSArPSBiW2ldICogaW1hZ1o7CiAgICAgICAgICAgICAgICByZWFsRGVub20gKz0gYVtpXSAqIHJlYWxaOwogICAgICAgICAgICAgICAgaW1hZ0Rlbm9tICs9IGFbaV0gKiBpbWFnWjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmRlbm9tID0gcmVhbERlbm9tICogcmVhbERlbm9tICsgaW1hZ0Rlbm9tICogaW1hZ0Rlbm9tOwogICAgICAgICAgICB0aGlzLnJlYWwgPSByZWFsTnVtICogcmVhbERlbm9tICsgaW1hZ051bSAqIGltYWdEZW5vbTsKICAgICAgICAgICAgdGhpcy5pbWFnID0gaW1hZ051bSAqIHJlYWxEZW5vbSAtIHJlYWxOdW0gKiBpbWFnRGVub207CiAgICAgICAgfQogICAgICAgIG1hZ25pdHVkZSgpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGguc3FydCh0aGlzLnJlYWwgKiB0aGlzLnJlYWwgKyB0aGlzLmltYWcgKiB0aGlzLmltYWcpIC8gdGhpcy5kZW5vbTsKICAgICAgICB9CiAgICAgICAgYW5nbGUoKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHRoaXMuaW1hZywgdGhpcy5yZWFsKTsKICAgICAgICB9CiAgICB9CiAgICBjbGFzcyBEeW5hbWljQmlxdWFkRmlsdGVyIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5hMSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5hMiA9IDAuMDsKICAgICAgICAgICAgdGhpcy5iMCA9IDEuMDsKICAgICAgICAgICAgdGhpcy5iMSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5iMiA9IDAuMDsKICAgICAgICAgICAgdGhpcy5hMURlbHRhID0gMC4wOwogICAgICAgICAgICB0aGlzLmEyRGVsdGEgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuYjBEZWx0YSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5iMURlbHRhID0gMC4wOwogICAgICAgICAgICB0aGlzLmIyRGVsdGEgPSAwLjA7CiAgICAgICAgICAgIHRoaXMub3V0cHV0MSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5vdXRwdXQyID0gMC4wOwogICAgICAgICAgICB0aGlzLnVzZU11bHRpcGxpY2F0aXZlSW5wdXRDb2VmZmljaWVudHMgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmVzZXRPdXRwdXQoKSB7CiAgICAgICAgICAgIHRoaXMub3V0cHV0MSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5vdXRwdXQyID0gMC4wOwogICAgICAgIH0KICAgICAgICBsb2FkQ29lZmZpY2llbnRzV2l0aEdyYWRpZW50KHN0YXJ0LCBlbmQsIGRlbHRhUmF0ZSwgdXNlTXVsdGlwbGljYXRpdmVJbnB1dENvZWZmaWNpZW50cykgewogICAgICAgICAgICBpZiAoc3RhcnQub3JkZXIgIT0gMiB8fCBlbmQub3JkZXIgIT0gMikKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICB0aGlzLmExID0gc3RhcnQuYVsxXTsKICAgICAgICAgICAgdGhpcy5hMiA9IHN0YXJ0LmFbMl07CiAgICAgICAgICAgIHRoaXMuYjAgPSBzdGFydC5iWzBdOwogICAgICAgICAgICB0aGlzLmIxID0gc3RhcnQuYlsxXTsKICAgICAgICAgICAgdGhpcy5iMiA9IHN0YXJ0LmJbMl07CiAgICAgICAgICAgIHRoaXMuYTFEZWx0YSA9IChlbmQuYVsxXSAtIHN0YXJ0LmFbMV0pICogZGVsdGFSYXRlOwogICAgICAgICAgICB0aGlzLmEyRGVsdGEgPSAoZW5kLmFbMl0gLSBzdGFydC5hWzJdKSAqIGRlbHRhUmF0ZTsKICAgICAgICAgICAgaWYgKHVzZU11bHRpcGxpY2F0aXZlSW5wdXRDb2VmZmljaWVudHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuYjBEZWx0YSA9IE1hdGgucG93KGVuZC5iWzBdIC8gc3RhcnQuYlswXSwgZGVsdGFSYXRlKTsKICAgICAgICAgICAgICAgIHRoaXMuYjFEZWx0YSA9IE1hdGgucG93KGVuZC5iWzFdIC8gc3RhcnQuYlsxXSwgZGVsdGFSYXRlKTsKICAgICAgICAgICAgICAgIHRoaXMuYjJEZWx0YSA9IE1hdGgucG93KGVuZC5iWzJdIC8gc3RhcnQuYlsyXSwgZGVsdGFSYXRlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuYjBEZWx0YSA9IChlbmQuYlswXSAtIHN0YXJ0LmJbMF0pICogZGVsdGFSYXRlOwogICAgICAgICAgICAgICAgdGhpcy5iMURlbHRhID0gKGVuZC5iWzFdIC0gc3RhcnQuYlsxXSkgKiBkZWx0YVJhdGU7CiAgICAgICAgICAgICAgICB0aGlzLmIyRGVsdGEgPSAoZW5kLmJbMl0gLSBzdGFydC5iWzJdKSAqIGRlbHRhUmF0ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVzZU11bHRpcGxpY2F0aXZlSW5wdXRDb2VmZmljaWVudHMgPSB1c2VNdWx0aXBsaWNhdGl2ZUlucHV0Q29lZmZpY2llbnRzOwogICAgICAgIH0KICAgIH0KCiAgICBjb25zdCBlcHNpbG9uID0gKDEuMGUtMjQpOwogICAgY29uc3QgYmFzZTY0SW50VG9DaGFyQ29kZSA9IFs0OCwgNDksIDUwLCA1MSwgNTIsIDUzLCA1NCwgNTUsIDU2LCA1NywgOTcsIDk4LCA5OSwgMTAwLCAxMDEsIDEwMiwgMTAzLCAxMDQsIDEwNSwgMTA2LCAxMDcsIDEwOCwgMTA5LCAxMTAsIDExMSwgMTEyLCAxMTMsIDExNCwgMTE1LCAxMTYsIDExNywgMTE4LCAxMTksIDEyMCwgMTIxLCAxMjIsIDY1LCA2NiwgNjcsIDY4LCA2OSwgNzAsIDcxLCA3MiwgNzMsIDc0LCA3NSwgNzYsIDc3LCA3OCwgNzksIDgwLCA4MSwgODIsIDgzLCA4NCwgODUsIDg2LCA4NywgODgsIDg5LCA5MCwgNDUsIDk1XTsKICAgIGNvbnN0IGJhc2U2NENoYXJDb2RlVG9JbnQgPSBbMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgMCwgNjIsIDYyLCAwLCAwLCAxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCA5LCAwLCAwLCAwLCAwLCAwLCAwLCAwLCAzNiwgMzcsIDM4LCAzOSwgNDAsIDQxLCA0MiwgNDMsIDQ0LCA0NSwgNDYsIDQ3LCA0OCwgNDksIDUwLCA1MSwgNTIsIDUzLCA1NCwgNTUsIDU2LCA1NywgNTgsIDU5LCA2MCwgNjEsIDAsIDAsIDAsIDAsIDYzLCAwLCAxMCwgMTEsIDEyLCAxMywgMTQsIDE1LCAxNiwgMTcsIDE4LCAxOSwgMjAsIDIxLCAyMiwgMjMsIDI0LCAyNSwgMjYsIDI3LCAyOCwgMjksIDMwLCAzMSwgMzIsIDMzLCAzNCwgMzUsIDAsIDAsIDAsIDAsIDBdOwogICAgY2xhc3MgQml0RmllbGRSZWFkZXIgewogICAgICAgIGNvbnN0cnVjdG9yKHNvdXJjZSwgc3RhcnRJbmRleCwgc3RvcEluZGV4KSB7CiAgICAgICAgICAgIHRoaXMuX2JpdHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5fcmVhZEluZGV4ID0gMDsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IHN0YXJ0SW5kZXg7IGkgPCBzdG9wSW5kZXg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBiYXNlNjRDaGFyQ29kZVRvSW50W3NvdXJjZS5jaGFyQ29kZUF0KGkpXTsKICAgICAgICAgICAgICAgIHRoaXMuX2JpdHMucHVzaCgodmFsdWUgPj4gNSkgJiAweDEpOwogICAgICAgICAgICAgICAgdGhpcy5fYml0cy5wdXNoKCh2YWx1ZSA+PiA0KSAmIDB4MSk7CiAgICAgICAgICAgICAgICB0aGlzLl9iaXRzLnB1c2goKHZhbHVlID4+IDMpICYgMHgxKTsKICAgICAgICAgICAgICAgIHRoaXMuX2JpdHMucHVzaCgodmFsdWUgPj4gMikgJiAweDEpOwogICAgICAgICAgICAgICAgdGhpcy5fYml0cy5wdXNoKCh2YWx1ZSA+PiAxKSAmIDB4MSk7CiAgICAgICAgICAgICAgICB0aGlzLl9iaXRzLnB1c2godmFsdWUgJiAweDEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJlYWQoYml0Q291bnQpIHsKICAgICAgICAgICAgbGV0IHJlc3VsdCA9IDA7CiAgICAgICAgICAgIHdoaWxlIChiaXRDb3VudCA+IDApIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdCA8PCAxOwogICAgICAgICAgICAgICAgcmVzdWx0ICs9IHRoaXMuX2JpdHNbdGhpcy5fcmVhZEluZGV4KytdOwogICAgICAgICAgICAgICAgYml0Q291bnQtLTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZWFkTG9uZ1RhaWwobWluVmFsdWUsIG1pbkJpdHMpIHsKICAgICAgICAgICAgbGV0IHJlc3VsdCA9IG1pblZhbHVlOwogICAgICAgICAgICBsZXQgbnVtQml0cyA9IG1pbkJpdHM7CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9iaXRzW3RoaXMuX3JlYWRJbmRleCsrXSkgewogICAgICAgICAgICAgICAgcmVzdWx0ICs9IDEgPDwgbnVtQml0czsKICAgICAgICAgICAgICAgIG51bUJpdHMrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAobnVtQml0cyA+IDApIHsKICAgICAgICAgICAgICAgIG51bUJpdHMtLTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9iaXRzW3RoaXMuX3JlYWRJbmRleCsrXSkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdCArPSAxIDw8IG51bUJpdHM7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmVhZFBhcnREdXJhdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVhZExvbmdUYWlsKDEsIDMpOwogICAgICAgIH0KICAgICAgICByZWFkTGVnYWN5UGFydER1cmF0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5yZWFkTG9uZ1RhaWwoMSwgMik7CiAgICAgICAgfQogICAgICAgIHJlYWRQaW5Db3VudCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVhZExvbmdUYWlsKDEsIDApOwogICAgICAgIH0KICAgICAgICByZWFkUGl0Y2hJbnRlcnZhbCgpIHsKICAgICAgICAgICAgaWYgKHRoaXMucmVhZCgxKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIC10aGlzLnJlYWRMb25nVGFpbCgxLCAzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnJlYWRMb25nVGFpbCgxLCAzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGNsYXNzIEJpdEZpZWxkV3JpdGVyIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5faW5kZXggPSAwOwogICAgICAgICAgICB0aGlzLl9iaXRzID0gW107CiAgICAgICAgfQogICAgICAgIGNsZWFyKCkgewogICAgICAgICAgICB0aGlzLl9pbmRleCA9IDA7CiAgICAgICAgfQogICAgICAgIHdyaXRlKGJpdENvdW50LCB2YWx1ZSkgewogICAgICAgICAgICBiaXRDb3VudC0tOwogICAgICAgICAgICB3aGlsZSAoYml0Q291bnQgPj0gMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYml0c1t0aGlzLl9pbmRleCsrXSA9ICh2YWx1ZSA+Pj4gYml0Q291bnQpICYgMTsKICAgICAgICAgICAgICAgIGJpdENvdW50LS07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgd3JpdGVMb25nVGFpbChtaW5WYWx1ZSwgbWluQml0cywgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlIDwgbWluVmFsdWUpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoInZhbHVlIG91dCBvZiBib3VuZHMiKTsKICAgICAgICAgICAgdmFsdWUgLT0gbWluVmFsdWU7CiAgICAgICAgICAgIGxldCBudW1CaXRzID0gbWluQml0czsKICAgICAgICAgICAgd2hpbGUgKHZhbHVlID49ICgxIDw8IG51bUJpdHMpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9iaXRzW3RoaXMuX2luZGV4KytdID0gMTsKICAgICAgICAgICAgICAgIHZhbHVlIC09IDEgPDwgbnVtQml0czsKICAgICAgICAgICAgICAgIG51bUJpdHMrKzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl9iaXRzW3RoaXMuX2luZGV4KytdID0gMDsKICAgICAgICAgICAgd2hpbGUgKG51bUJpdHMgPiAwKSB7CiAgICAgICAgICAgICAgICBudW1CaXRzLS07CiAgICAgICAgICAgICAgICB0aGlzLl9iaXRzW3RoaXMuX2luZGV4KytdID0gKHZhbHVlID4+PiBudW1CaXRzKSAmIDE7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgd3JpdGVQYXJ0RHVyYXRpb24odmFsdWUpIHsKICAgICAgICAgICAgdGhpcy53cml0ZUxvbmdUYWlsKDEsIDMsIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgd3JpdGVQaW5Db3VudCh2YWx1ZSkgewogICAgICAgICAgICB0aGlzLndyaXRlTG9uZ1RhaWwoMSwgMCwgdmFsdWUpOwogICAgICAgIH0KICAgICAgICB3cml0ZVBpdGNoSW50ZXJ2YWwodmFsdWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlIDwgMCkgewogICAgICAgICAgICAgICAgdGhpcy53cml0ZSgxLCAxKTsKICAgICAgICAgICAgICAgIHRoaXMud3JpdGVMb25nVGFpbCgxLCAzLCAtdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy53cml0ZSgxLCAwKTsKICAgICAgICAgICAgICAgIHRoaXMud3JpdGVMb25nVGFpbCgxLCAzLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uY2F0KG90aGVyKSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3RoZXIuX2luZGV4OyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMuX2JpdHNbdGhpcy5faW5kZXgrK10gPSBvdGhlci5fYml0c1tpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbmNvZGVCYXNlNjQoYnVmZmVyKSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5faW5kZXg7IGkgKz0gNikgewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSAodGhpcy5fYml0c1tpXSA8PCA1KSB8ICh0aGlzLl9iaXRzW2kgKyAxXSA8PCA0KSB8ICh0aGlzLl9iaXRzW2kgKyAyXSA8PCAzKSB8ICh0aGlzLl9iaXRzW2kgKyAzXSA8PCAyKSB8ICh0aGlzLl9iaXRzW2kgKyA0XSA8PCAxKSB8IHRoaXMuX2JpdHNbaSArIDVdOwogICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goYmFzZTY0SW50VG9DaGFyQ29kZVt2YWx1ZV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBidWZmZXI7CiAgICAgICAgfQogICAgICAgIGxlbmd0aEJhc2U2NCgpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGguY2VpbCh0aGlzLl9pbmRleCAvIDYpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIG1ha2VOb3RlUGluKGludGVydmFsLCB0aW1lLCBzaXplKSB7CiAgICAgICAgcmV0dXJuIHsgaW50ZXJ2YWw6IGludGVydmFsLCB0aW1lOiB0aW1lLCBzaXplOiBzaXplIH07CiAgICB9CiAgICBmdW5jdGlvbiBjbGFtcChtaW4sIG1heCwgdmFsKSB7CiAgICAgICAgbWF4ID0gbWF4IC0gMTsKICAgICAgICBpZiAodmFsIDw9IG1heCkgewogICAgICAgICAgICBpZiAodmFsID49IG1pbikKICAgICAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHJldHVybiBtaW47CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICByZXR1cm4gbWF4OwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHZhbGlkYXRlUmFuZ2UobWluLCBtYXgsIHZhbCkgewogICAgICAgIGlmIChtaW4gPD0gdmFsICYmIHZhbCA8PSBtYXgpCiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBWYWx1ZSAke3ZhbH0gbm90IGluIHJhbmdlIFske21pbn0sICR7bWF4fV1gKTsKICAgIH0KICAgIGNsYXNzIE5vdGUgewogICAgICAgIGNvbnN0cnVjdG9yKHBpdGNoLCBzdGFydCwgZW5kLCBzaXplLCBmYWRlb3V0ID0gZmFsc2UpIHsKICAgICAgICAgICAgdGhpcy5waXRjaGVzID0gW3BpdGNoXTsKICAgICAgICAgICAgdGhpcy5waW5zID0gW21ha2VOb3RlUGluKDAsIDAsIHNpemUpLCBtYWtlTm90ZVBpbigwLCBlbmQgLSBzdGFydCwgZmFkZW91dCA/IDAgOiBzaXplKV07CiAgICAgICAgICAgIHRoaXMuc3RhcnQgPSBzdGFydDsKICAgICAgICAgICAgdGhpcy5lbmQgPSBlbmQ7CiAgICAgICAgICAgIHRoaXMuY29udGludWVzTGFzdFBhdHRlcm4gPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcGlja01haW5JbnRlcnZhbCgpIHsKICAgICAgICAgICAgbGV0IGxvbmdlc3RGbGF0SW50ZXJ2YWxEdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIGxldCBtYWluSW50ZXJ2YWwgPSAwOwogICAgICAgICAgICBmb3IgKGxldCBwaW5JbmRleCA9IDE7IHBpbkluZGV4IDwgdGhpcy5waW5zLmxlbmd0aDsgcGluSW5kZXgrKykgewogICAgICAgICAgICAgICAgY29uc3QgcGluQSA9IHRoaXMucGluc1twaW5JbmRleCAtIDFdOwogICAgICAgICAgICAgICAgY29uc3QgcGluQiA9IHRoaXMucGluc1twaW5JbmRleF07CiAgICAgICAgICAgICAgICBpZiAocGluQS5pbnRlcnZhbCA9PSBwaW5CLmludGVydmFsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSBwaW5CLnRpbWUgLSBwaW5BLnRpbWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxvbmdlc3RGbGF0SW50ZXJ2YWxEdXJhdGlvbiA8IGR1cmF0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvbmdlc3RGbGF0SW50ZXJ2YWxEdXJhdGlvbiA9IGR1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICBtYWluSW50ZXJ2YWwgPSBwaW5BLmludGVydmFsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobG9uZ2VzdEZsYXRJbnRlcnZhbER1cmF0aW9uID09IDApIHsKICAgICAgICAgICAgICAgIGxldCBsb3VkZXN0U2l6ZSA9IDA7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBwaW5JbmRleCA9IDA7IHBpbkluZGV4IDwgdGhpcy5waW5zLmxlbmd0aDsgcGluSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpbiA9IHRoaXMucGluc1twaW5JbmRleF07CiAgICAgICAgICAgICAgICAgICAgaWYgKGxvdWRlc3RTaXplIDwgcGluLnNpemUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG91ZGVzdFNpemUgPSBwaW4uc2l6ZTsKICAgICAgICAgICAgICAgICAgICAgICAgbWFpbkludGVydmFsID0gcGluLmludGVydmFsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWFpbkludGVydmFsOwogICAgICAgIH0KICAgICAgICBjbG9uZSgpIHsKICAgICAgICAgICAgY29uc3QgbmV3Tm90ZSA9IG5ldyBOb3RlKC0xLCB0aGlzLnN0YXJ0LCB0aGlzLmVuZCwgQ29uZmlnLm5vdGVTaXplTWF4KTsKICAgICAgICAgICAgbmV3Tm90ZS5waXRjaGVzID0gdGhpcy5waXRjaGVzLmNvbmNhdCgpOwogICAgICAgICAgICBuZXdOb3RlLnBpbnMgPSBbXTsKICAgICAgICAgICAgZm9yIChjb25zdCBwaW4gb2YgdGhpcy5waW5zKSB7CiAgICAgICAgICAgICAgICBuZXdOb3RlLnBpbnMucHVzaChtYWtlTm90ZVBpbihwaW4uaW50ZXJ2YWwsIHBpbi50aW1lLCBwaW4uc2l6ZSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG5ld05vdGUuY29udGludWVzTGFzdFBhdHRlcm4gPSB0aGlzLmNvbnRpbnVlc0xhc3RQYXR0ZXJuOwogICAgICAgICAgICByZXR1cm4gbmV3Tm90ZTsKICAgICAgICB9CiAgICAgICAgZ2V0RW5kUGluSW5kZXgocGFydCkgewogICAgICAgICAgICBsZXQgZW5kUGluSW5kZXg7CiAgICAgICAgICAgIGZvciAoZW5kUGluSW5kZXggPSAxOyBlbmRQaW5JbmRleCA8IHRoaXMucGlucy5sZW5ndGggLSAxOyBlbmRQaW5JbmRleCsrKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5waW5zW2VuZFBpbkluZGV4XS50aW1lICsgdGhpcy5zdGFydCA+IHBhcnQpCiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVuZFBpbkluZGV4OwogICAgICAgIH0KICAgIH0KICAgIGNsYXNzIFBhdHRlcm4gewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICB0aGlzLm5vdGVzID0gW107CiAgICAgICAgICAgIHRoaXMuaW5zdHJ1bWVudHMgPSBbMF07CiAgICAgICAgfQogICAgICAgIGNsb25lTm90ZXMoKSB7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdOwogICAgICAgICAgICBmb3IgKGNvbnN0IG5vdGUgb2YgdGhpcy5ub3RlcykgewogICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobm90ZS5jbG9uZSgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgICAgIH0KICAgICAgICByZXNldCgpIHsKICAgICAgICAgICAgdGhpcy5ub3Rlcy5sZW5ndGggPSAwOwogICAgICAgICAgICB0aGlzLmluc3RydW1lbnRzWzBdID0gMDsKICAgICAgICAgICAgdGhpcy5pbnN0cnVtZW50cy5sZW5ndGggPSAxOwogICAgICAgIH0KICAgIH0KICAgIGNsYXNzIE9wZXJhdG9yIHsKICAgICAgICBjb25zdHJ1Y3RvcihpbmRleCkgewogICAgICAgICAgICB0aGlzLmZyZXF1ZW5jeSA9IDA7CiAgICAgICAgICAgIHRoaXMuYW1wbGl0dWRlID0gMDsKICAgICAgICAgICAgdGhpcy5yZXNldChpbmRleCk7CiAgICAgICAgfQogICAgICAgIHJlc2V0KGluZGV4KSB7CiAgICAgICAgICAgIHRoaXMuZnJlcXVlbmN5ID0gMDsKICAgICAgICAgICAgdGhpcy5hbXBsaXR1ZGUgPSAoaW5kZXggPD0gMSkgPyBDb25maWcub3BlcmF0b3JBbXBsaXR1ZGVNYXggOiAwOwogICAgICAgIH0KICAgIH0KICAgIGNsYXNzIFNwZWN0cnVtV2F2ZSB7CiAgICAgICAgY29uc3RydWN0b3IoaXNOb2lzZUNoYW5uZWwpIHsKICAgICAgICAgICAgdGhpcy5zcGVjdHJ1bSA9IFtdOwogICAgICAgICAgICB0aGlzLl93YXZlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5fd2F2ZUlzUmVhZHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5yZXNldChpc05vaXNlQ2hhbm5lbCk7CiAgICAgICAgfQogICAgICAgIHJlc2V0KGlzTm9pc2VDaGFubmVsKSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoaXNOb2lzZUNoYW5uZWwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNwZWN0cnVtW2ldID0gTWF0aC5yb3VuZChDb25maWcuc3BlY3RydW1NYXggKiAoMSAvIE1hdGguc3FydCgxICsgaSAvIDMpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc0hhcm1vbmljID0gaSA9PSAwIHx8IGkgPT0gNyB8fCBpID09IDExIHx8IGkgPT0gMTQgfHwgaSA9PSAxNiB8fCBpID09IDE4IHx8IGkgPT0gMjEgfHwgaSA9PSAyMyB8fCBpID49IDI1OwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3BlY3RydW1baV0gPSBpc0hhcm1vbmljID8gTWF0aC5tYXgoMCwgTWF0aC5yb3VuZChDb25maWcuc3BlY3RydW1NYXggKiAoMSAtIGkgLyAzMCkpKSA6IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fd2F2ZUlzUmVhZHkgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgbWFya0N1c3RvbVdhdmVEaXJ0eSgpIHsKICAgICAgICAgICAgdGhpcy5fd2F2ZUlzUmVhZHkgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZ2V0Q3VzdG9tV2F2ZShsb3dlc3RPY3RhdmUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3dhdmVJc1JlYWR5KQogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3dhdmU7CiAgICAgICAgICAgIGNvbnN0IHdhdmVMZW5ndGggPSBDb25maWcuc3BlY3RydW1Ob2lzZUxlbmd0aDsKICAgICAgICAgICAgaWYgKHRoaXMuX3dhdmUgPT0gbnVsbCB8fCB0aGlzLl93YXZlLmxlbmd0aCAhPSB3YXZlTGVuZ3RoICsgMSkgewogICAgICAgICAgICAgICAgdGhpcy5fd2F2ZSA9IG5ldyBGbG9hdDMyQXJyYXkod2F2ZUxlbmd0aCArIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHdhdmUgPSB0aGlzLl93YXZlOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdhdmVMZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgd2F2ZVtpXSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgaGlnaGVzdE9jdGF2ZSA9IDE0OwogICAgICAgICAgICBjb25zdCBmYWxsb2ZmUmF0aW8gPSAwLjI1OwogICAgICAgICAgICBjb25zdCBwaXRjaFR3ZWFrID0gWzAsIDEgLyA3LCBNYXRoLmxvZzIoNSAvIDQpLCAzIC8gNywgTWF0aC5sb2cyKDMgLyAyKSwgNSAvIDcsIDYgLyA3XTsKICAgICAgICAgICAgZnVuY3Rpb24gY29udHJvbFBvaW50VG9PY3RhdmUocG9pbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBsb3dlc3RPY3RhdmUgKyBNYXRoLmZsb29yKHBvaW50IC8gQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50c1Blck9jdGF2ZSkgKyBwaXRjaFR3ZWFrWyhwb2ludCArIENvbmZpZy5zcGVjdHJ1bUNvbnRyb2xQb2ludHNQZXJPY3RhdmUpICUgQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50c1Blck9jdGF2ZV07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGNvbWJpbmVkQW1wbGl0dWRlID0gMTsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBDb25maWcuc3BlY3RydW1Db250cm9sUG9pbnRzICsgMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZTEgPSAoaSA8PSAwKSA/IDAgOiB0aGlzLnNwZWN0cnVtW2kgLSAxXTsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlMiA9IChpID49IENvbmZpZy5zcGVjdHJ1bUNvbnRyb2xQb2ludHMpID8gdGhpcy5zcGVjdHJ1bVtDb25maWcuc3BlY3RydW1Db250cm9sUG9pbnRzIC0gMV0gOiB0aGlzLnNwZWN0cnVtW2ldOwogICAgICAgICAgICAgICAgY29uc3Qgb2N0YXZlMSA9IGNvbnRyb2xQb2ludFRvT2N0YXZlKGkgLSAxKTsKICAgICAgICAgICAgICAgIGxldCBvY3RhdmUyID0gY29udHJvbFBvaW50VG9PY3RhdmUoaSk7CiAgICAgICAgICAgICAgICBpZiAoaSA+PSBDb25maWcuc3BlY3RydW1Db250cm9sUG9pbnRzKQogICAgICAgICAgICAgICAgICAgIG9jdGF2ZTIgPSBoaWdoZXN0T2N0YXZlICsgKG9jdGF2ZTIgLSBoaWdoZXN0T2N0YXZlKSAqIGZhbGxvZmZSYXRpbzsKICAgICAgICAgICAgICAgIGlmICh2YWx1ZTEgPT0gMCAmJiB2YWx1ZTIgPT0gMCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIGNvbWJpbmVkQW1wbGl0dWRlICs9IDAuMDIgKiBkcmF3Tm9pc2VTcGVjdHJ1bSh3YXZlLCB3YXZlTGVuZ3RoLCBvY3RhdmUxLCBvY3RhdmUyLCB2YWx1ZTEgLyBDb25maWcuc3BlY3RydW1NYXgsIHZhbHVlMiAvIENvbmZpZy5zcGVjdHJ1bU1heCwgLTAuNSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc3BlY3RydW1bQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50cyAtIDFdID4gMCkgewogICAgICAgICAgICAgICAgY29tYmluZWRBbXBsaXR1ZGUgKz0gMC4wMiAqIGRyYXdOb2lzZVNwZWN0cnVtKHdhdmUsIHdhdmVMZW5ndGgsIGhpZ2hlc3RPY3RhdmUgKyAoY29udHJvbFBvaW50VG9PY3RhdmUoQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50cykgLSBoaWdoZXN0T2N0YXZlKSAqIGZhbGxvZmZSYXRpbywgaGlnaGVzdE9jdGF2ZSwgdGhpcy5zcGVjdHJ1bVtDb25maWcuc3BlY3RydW1Db250cm9sUG9pbnRzIC0gMV0gLyBDb25maWcuc3BlY3RydW1NYXgsIDAsIC0wLjUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGludmVyc2VSZWFsRm91cmllclRyYW5zZm9ybSh3YXZlLCB3YXZlTGVuZ3RoKTsKICAgICAgICAgICAgc2NhbGVFbGVtZW50c0J5RmFjdG9yKHdhdmUsIDUuMCAvIChNYXRoLnNxcnQod2F2ZUxlbmd0aCkgKiBNYXRoLnBvdyhjb21iaW5lZEFtcGxpdHVkZSwgMC43NSkpKTsKICAgICAgICAgICAgd2F2ZVt3YXZlTGVuZ3RoXSA9IHdhdmVbMF07CiAgICAgICAgICAgIHRoaXMuX3dhdmVJc1JlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHdhdmU7CiAgICAgICAgfQogICAgfQogICAgY2xhc3MgSGFybW9uaWNzV2F2ZSB7CiAgICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgICAgIHRoaXMuaGFybW9uaWNzID0gW107CiAgICAgICAgICAgIHRoaXMuX3dhdmUgPSBudWxsOwogICAgICAgICAgICB0aGlzLl93YXZlSXNSZWFkeSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgfQogICAgICAgIHJlc2V0KCkgewogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IENvbmZpZy5oYXJtb25pY3NDb250cm9sUG9pbnRzOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMuaGFybW9uaWNzW2ldID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmhhcm1vbmljc1swXSA9IENvbmZpZy5oYXJtb25pY3NNYXg7CiAgICAgICAgICAgIHRoaXMuaGFybW9uaWNzWzNdID0gQ29uZmlnLmhhcm1vbmljc01heDsKICAgICAgICAgICAgdGhpcy5oYXJtb25pY3NbNl0gPSBDb25maWcuaGFybW9uaWNzTWF4OwogICAgICAgICAgICB0aGlzLl93YXZlSXNSZWFkeSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBtYXJrQ3VzdG9tV2F2ZURpcnR5KCkgewogICAgICAgICAgICB0aGlzLl93YXZlSXNSZWFkeSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBnZXRDdXN0b21XYXZlKGluc3RydW1lbnRUeXBlKSB7CiAgICAgICAgICAgIGlmICh0aGlzLl9nZW5lcmF0ZWRGb3JUeXBlICE9IGluc3RydW1lbnRUeXBlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9nZW5lcmF0ZWRGb3JUeXBlID0gaW5zdHJ1bWVudFR5cGU7CiAgICAgICAgICAgICAgICB0aGlzLl93YXZlSXNSZWFkeSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGhhcm1vbmljc1JlbmRlcmVkID0gKGluc3RydW1lbnRUeXBlID09IDcpID8gQ29uZmlnLmhhcm1vbmljc1JlbmRlcmVkRm9yUGlja2VkU3RyaW5nIDogQ29uZmlnLmhhcm1vbmljc1JlbmRlcmVkOwogICAgICAgICAgICBpZiAodGhpcy5fd2F2ZUlzUmVhZHkpCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fd2F2ZTsKICAgICAgICAgICAgY29uc3Qgd2F2ZUxlbmd0aCA9IENvbmZpZy5oYXJtb25pY3NXYXZlbGVuZ3RoOwogICAgICAgICAgICBjb25zdCByZXRyb1dhdmUgPSBnZXREcnVtV2F2ZSgwLCBudWxsLCBudWxsKTsKICAgICAgICAgICAgaWYgKHRoaXMuX3dhdmUgPT0gbnVsbCB8fCB0aGlzLl93YXZlLmxlbmd0aCAhPSB3YXZlTGVuZ3RoICsgMSkgewogICAgICAgICAgICAgICAgdGhpcy5fd2F2ZSA9IG5ldyBGbG9hdDMyQXJyYXkod2F2ZUxlbmd0aCArIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHdhdmUgPSB0aGlzLl93YXZlOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdhdmVMZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgd2F2ZVtpXSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3Qgb3ZlcmFsbFNsb3BlID0gLTAuMjU7CiAgICAgICAgICAgIGxldCBjb21iaW5lZENvbnRyb2xQb2ludEFtcGxpdHVkZSA9IDE7CiAgICAgICAgICAgIGZvciAobGV0IGhhcm1vbmljSW5kZXggPSAwOyBoYXJtb25pY0luZGV4IDwgaGFybW9uaWNzUmVuZGVyZWQ7IGhhcm1vbmljSW5kZXgrKykgewogICAgICAgICAgICAgICAgY29uc3QgaGFybW9uaWNGcmVxID0gaGFybW9uaWNJbmRleCArIDE7CiAgICAgICAgICAgICAgICBsZXQgY29udHJvbFZhbHVlID0gaGFybW9uaWNJbmRleCA8IENvbmZpZy5oYXJtb25pY3NDb250cm9sUG9pbnRzID8gdGhpcy5oYXJtb25pY3NbaGFybW9uaWNJbmRleF0gOiB0aGlzLmhhcm1vbmljc1tDb25maWcuaGFybW9uaWNzQ29udHJvbFBvaW50cyAtIDFdOwogICAgICAgICAgICAgICAgaWYgKGhhcm1vbmljSW5kZXggPj0gQ29uZmlnLmhhcm1vbmljc0NvbnRyb2xQb2ludHMpIHsKICAgICAgICAgICAgICAgICAgICBjb250cm9sVmFsdWUgKj0gMSAtIChoYXJtb25pY0luZGV4IC0gQ29uZmlnLmhhcm1vbmljc0NvbnRyb2xQb2ludHMpIC8gKGhhcm1vbmljc1JlbmRlcmVkIC0gQ29uZmlnLmhhcm1vbmljc0NvbnRyb2xQb2ludHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3Qgbm9ybWFsaXplZFZhbHVlID0gY29udHJvbFZhbHVlIC8gQ29uZmlnLmhhcm1vbmljc01heDsKICAgICAgICAgICAgICAgIGxldCBhbXBsaXR1ZGUgPSBNYXRoLnBvdygyLCBjb250cm9sVmFsdWUgLSBDb25maWcuaGFybW9uaWNzTWF4ICsgMSkgKiBNYXRoLnNxcnQobm9ybWFsaXplZFZhbHVlKTsKICAgICAgICAgICAgICAgIGlmIChoYXJtb25pY0luZGV4IDwgQ29uZmlnLmhhcm1vbmljc0NvbnRyb2xQb2ludHMpIHsKICAgICAgICAgICAgICAgICAgICBjb21iaW5lZENvbnRyb2xQb2ludEFtcGxpdHVkZSArPSBhbXBsaXR1ZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBhbXBsaXR1ZGUgKj0gTWF0aC5wb3coaGFybW9uaWNGcmVxLCBvdmVyYWxsU2xvcGUpOwogICAgICAgICAgICAgICAgYW1wbGl0dWRlICo9IHJldHJvV2F2ZVtoYXJtb25pY0luZGV4ICsgNTg5XTsKICAgICAgICAgICAgICAgIHdhdmVbd2F2ZUxlbmd0aCAtIGhhcm1vbmljRnJlcV0gPSBhbXBsaXR1ZGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW52ZXJzZVJlYWxGb3VyaWVyVHJhbnNmb3JtKHdhdmUsIHdhdmVMZW5ndGgpOwogICAgICAgICAgICBjb25zdCBtdWx0ID0gMSAvIE1hdGgucG93KGNvbWJpbmVkQ29udHJvbFBvaW50QW1wbGl0dWRlLCAwLjcpOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHdhdmUubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICB3YXZlW2ldICo9IG11bHQ7CiAgICAgICAgICAgIHBlcmZvcm1JbnRlZ3JhbCh3YXZlKTsKICAgICAgICAgICAgd2F2ZVt3YXZlTGVuZ3RoXSA9IHdhdmVbMF07CiAgICAgICAgICAgIHRoaXMuX3dhdmVJc1JlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIHdhdmU7CiAgICAgICAgfQogICAgfQogICAgY2xhc3MgRmlsdGVyQ29udHJvbFBvaW50IHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5mcmVxID0gMDsKICAgICAgICAgICAgdGhpcy5nYWluID0gQ29uZmlnLmZpbHRlckdhaW5DZW50ZXI7CiAgICAgICAgICAgIHRoaXMudHlwZSA9IDI7CiAgICAgICAgfQogICAgICAgIHNldChmcmVxU2V0dGluZywgZ2FpblNldHRpbmcpIHsKICAgICAgICAgICAgdGhpcy5mcmVxID0gZnJlcVNldHRpbmc7CiAgICAgICAgICAgIHRoaXMuZ2FpbiA9IGdhaW5TZXR0aW5nOwogICAgICAgIH0KICAgICAgICBnZXRIeigpIHsKICAgICAgICAgICAgcmV0dXJuIEZpbHRlckNvbnRyb2xQb2ludC5nZXRIekZyb21TZXR0aW5nVmFsdWUodGhpcy5mcmVxKTsKICAgICAgICB9CiAgICAgICAgc3RhdGljIGdldEh6RnJvbVNldHRpbmdWYWx1ZSh2YWx1ZSkgewogICAgICAgICAgICByZXR1cm4gQ29uZmlnLmZpbHRlckZyZXFSZWZlcmVuY2VIeiAqIE1hdGgucG93KDIuMCwgKHZhbHVlIC0gQ29uZmlnLmZpbHRlckZyZXFSZWZlcmVuY2VTZXR0aW5nKSAqIENvbmZpZy5maWx0ZXJGcmVxU3RlcCk7CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBnZXRTZXR0aW5nVmFsdWVGcm9tSHooaHopIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgubG9nMihoeiAvIENvbmZpZy5maWx0ZXJGcmVxUmVmZXJlbmNlSHopIC8gQ29uZmlnLmZpbHRlckZyZXFTdGVwICsgQ29uZmlnLmZpbHRlckZyZXFSZWZlcmVuY2VTZXR0aW5nOwogICAgICAgIH0KICAgICAgICBzdGF0aWMgZ2V0Um91bmRlZFNldHRpbmdWYWx1ZUZyb21IeihoeikgewogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oQ29uZmlnLmZpbHRlckZyZXFSYW5nZSAtIDEsIE1hdGgucm91bmQoRmlsdGVyQ29udHJvbFBvaW50LmdldFNldHRpbmdWYWx1ZUZyb21IeihoeikpKSk7CiAgICAgICAgfQogICAgICAgIGdldExpbmVhckdhaW4ocGVha011bHQgPSAxLjApIHsKICAgICAgICAgICAgY29uc3QgcG93ZXIgPSAodGhpcy5nYWluIC0gQ29uZmlnLmZpbHRlckdhaW5DZW50ZXIpICogQ29uZmlnLmZpbHRlckdhaW5TdGVwOwogICAgICAgICAgICBjb25zdCBuZXV0cmFsID0gKHRoaXMudHlwZSA9PSAyKSA/IDAuMCA6IC0wLjU7CiAgICAgICAgICAgIGNvbnN0IGludGVycG9sYXRlZFBvd2VyID0gbmV1dHJhbCArIChwb3dlciAtIG5ldXRyYWwpICogcGVha011bHQ7CiAgICAgICAgICAgIHJldHVybiBNYXRoLnBvdygyLjAsIGludGVycG9sYXRlZFBvd2VyKTsKICAgICAgICB9CiAgICAgICAgc3RhdGljIGdldFJvdW5kZWRTZXR0aW5nVmFsdWVGcm9tTGluZWFyR2FpbihsaW5lYXJHYWluKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1pbihDb25maWcuZmlsdGVyR2FpblJhbmdlIC0gMSwgTWF0aC5yb3VuZChNYXRoLmxvZzIobGluZWFyR2FpbikgLyBDb25maWcuZmlsdGVyR2FpblN0ZXAgKyBDb25maWcuZmlsdGVyR2FpbkNlbnRlcikpKTsKICAgICAgICB9CiAgICAgICAgdG9Db2VmZmljaWVudHMoZmlsdGVyLCBzYW1wbGVSYXRlLCBmcmVxTXVsdCA9IDEuMCwgcGVha011bHQgPSAxLjApIHsKICAgICAgICAgICAgY29uc3QgY29ybmVyUmFkaWFuc1BlclNhbXBsZSA9IDIuMCAqIE1hdGguUEkgKiBNYXRoLm1heChDb25maWcuZmlsdGVyRnJlcU1pbkh6LCBNYXRoLm1pbihDb25maWcuZmlsdGVyRnJlcU1heEh6LCBmcmVxTXVsdCAqIHRoaXMuZ2V0SHooKSkpIC8gc2FtcGxlUmF0ZTsKICAgICAgICAgICAgY29uc3QgbGluZWFyR2FpbiA9IHRoaXMuZ2V0TGluZWFyR2FpbihwZWFrTXVsdCk7CiAgICAgICAgICAgIHN3aXRjaCAodGhpcy50eXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyLmxvd1Bhc3MybmRPcmRlckJ1dHRlcndvcnRoKGNvcm5lclJhZGlhbnNQZXJTYW1wbGUsIGxpbmVhckdhaW4pOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgICAgIGZpbHRlci5oaWdoUGFzczJuZE9yZGVyQnV0dGVyd29ydGgoY29ybmVyUmFkaWFuc1BlclNhbXBsZSwgbGluZWFyR2Fpbik7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyLnBlYWsybmRPcmRlcihjb3JuZXJSYWRpYW5zUGVyU2FtcGxlLCBsaW5lYXJHYWluLCAxLjApOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBnZXRWb2x1bWVDb21wZW5zYXRpb25NdWx0KCkgewogICAgICAgICAgICBjb25zdCBvY3RhdmUgPSAodGhpcy5mcmVxIC0gQ29uZmlnLmZpbHRlckZyZXFSZWZlcmVuY2VTZXR0aW5nKSAqIENvbmZpZy5maWx0ZXJGcmVxU3RlcDsKICAgICAgICAgICAgY29uc3QgZ2FpblBvdyA9ICh0aGlzLmdhaW4gLSBDb25maWcuZmlsdGVyR2FpbkNlbnRlcikgKiBDb25maWcuZmlsdGVyR2FpblN0ZXA7CiAgICAgICAgICAgIHN3aXRjaCAodGhpcy50eXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZnJlcVJlbGF0aXZlVG84a2h6ID0gTWF0aC5wb3coMi4wLCBvY3RhdmUpICogQ29uZmlnLmZpbHRlckZyZXFSZWZlcmVuY2VIeiAvIDgwMDAuMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3YXJwZWRGcmVxID0gKE1hdGguc3FydCgxLjAgKyA0LjAgKiBmcmVxUmVsYXRpdmVUbzhraHopIC0gMS4wKSAvIDIuMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3YXJwZWRPY3RhdmUgPSBNYXRoLmxvZzIod2FycGVkRnJlcSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE1hdGgucG93KDAuNSwgMC4yICogTWF0aC5tYXgoMC4wLCBnYWluUG93ICsgMS4wKSArIE1hdGgubWluKDAuMCwgTWF0aC5tYXgoLTMuMCwgMC41OTUgKiB3YXJwZWRPY3RhdmUgKyAwLjM1ICogTWF0aC5taW4oMC4wLCBnYWluUG93ICsgMS4wKSkpKTsKICAgICAgICAgICAgICAgIGNhc2UgMToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5wb3coMC41LCAwLjEyNSAqIE1hdGgubWF4KDAuMCwgZ2FpblBvdyArIDEuMCkgKyBNYXRoLm1pbigwLjAsIDAuMyAqICgtb2N0YXZlIC0gTWF0aC5sb2cyKENvbmZpZy5maWx0ZXJGcmVxUmVmZXJlbmNlSHogLyAxMjUuMCkpICsgMC4yICogTWF0aC5taW4oMC4wLCBnYWluUG93ICsgMS4wKSkpOwogICAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpc3RhbmNlRnJvbUNlbnRlciA9IG9jdGF2ZSArIE1hdGgubG9nMihDb25maWcuZmlsdGVyRnJlcVJlZmVyZW5jZUh6IC8gMjAwMC4wKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmcmVxTG91ZG5lc3MgPSBNYXRoLnBvdygxLjAgLyAoMS4wICsgTWF0aC5wb3coZGlzdGFuY2VGcm9tQ2VudGVyIC8gMy4wLCAyLjApKSwgMi4wKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTWF0aC5wb3coMC41LCAwLjEyNSAqIE1hdGgubWF4KDAuMCwgZ2FpblBvdykgKyAwLjEgKiBmcmVxTG91ZG5lc3MgKiBNYXRoLm1pbigwLjAsIGdhaW5Qb3cpKTsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjbGFzcyBGaWx0ZXJTZXR0aW5ncyB7CiAgICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgICAgIHRoaXMuY29udHJvbFBvaW50cyA9IFtdOwogICAgICAgICAgICB0aGlzLmNvbnRyb2xQb2ludENvdW50ID0gMDsKICAgICAgICAgICAgdGhpcy5yZXNldCgpOwogICAgICAgIH0KICAgICAgICByZXNldCgpIHsKICAgICAgICAgICAgdGhpcy5jb250cm9sUG9pbnRDb3VudCA9IDA7CiAgICAgICAgfQogICAgICAgIGFkZFBvaW50KHR5cGUsIGZyZXFTZXR0aW5nLCBnYWluU2V0dGluZykgewogICAgICAgICAgICBsZXQgY29udHJvbFBvaW50OwogICAgICAgICAgICBpZiAodGhpcy5jb250cm9sUG9pbnRzLmxlbmd0aCA8PSB0aGlzLmNvbnRyb2xQb2ludENvdW50KSB7CiAgICAgICAgICAgICAgICBjb250cm9sUG9pbnQgPSBuZXcgRmlsdGVyQ29udHJvbFBvaW50KCk7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xQb2ludHNbdGhpcy5jb250cm9sUG9pbnRDb3VudF0gPSBjb250cm9sUG9pbnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBjb250cm9sUG9pbnQgPSB0aGlzLmNvbnRyb2xQb2ludHNbdGhpcy5jb250cm9sUG9pbnRDb3VudF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jb250cm9sUG9pbnRDb3VudCsrOwogICAgICAgICAgICBjb250cm9sUG9pbnQudHlwZSA9IHR5cGU7CiAgICAgICAgICAgIGNvbnRyb2xQb2ludC5zZXQoZnJlcVNldHRpbmcsIGdhaW5TZXR0aW5nKTsKICAgICAgICB9CiAgICAgICAgdG9Kc29uT2JqZWN0KCkgewogICAgICAgICAgICBjb25zdCBmaWx0ZXJBcnJheSA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY29udHJvbFBvaW50Q291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgcG9pbnQgPSB0aGlzLmNvbnRyb2xQb2ludHNbaV07CiAgICAgICAgICAgICAgICBmaWx0ZXJBcnJheS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6IENvbmZpZy5maWx0ZXJUeXBlTmFtZXNbcG9pbnQudHlwZV0sCiAgICAgICAgICAgICAgICAgICAgImN1dG9mZkh6IjogTWF0aC5yb3VuZChwb2ludC5nZXRIeigpICogMTAwKSAvIDEwMCwKICAgICAgICAgICAgICAgICAgICAibGluZWFyR2FpbiI6IE1hdGgucm91bmQocG9pbnQuZ2V0TGluZWFyR2FpbigpICogMTAwMDApIC8gMTAwMDAsCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmlsdGVyQXJyYXk7CiAgICAgICAgfQogICAgICAgIGZyb21Kc29uT2JqZWN0KGZpbHRlck9iamVjdCkgewogICAgICAgICAgICB0aGlzLmNvbnRyb2xQb2ludHMubGVuZ3RoID0gMDsKICAgICAgICAgICAgaWYgKGZpbHRlck9iamVjdCkgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCBwb2ludE9iamVjdCBvZiBmaWx0ZXJPYmplY3QpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwb2ludCA9IG5ldyBGaWx0ZXJDb250cm9sUG9pbnQoKTsKICAgICAgICAgICAgICAgICAgICBwb2ludC50eXBlID0gQ29uZmlnLmZpbHRlclR5cGVOYW1lcy5pbmRleE9mKHBvaW50T2JqZWN0WyJ0eXBlIl0pOwogICAgICAgICAgICAgICAgICAgIGlmIChwb2ludC50eXBlID09IC0xKQogICAgICAgICAgICAgICAgICAgICAgICBwb2ludC50eXBlID0gMjsKICAgICAgICAgICAgICAgICAgICBpZiAocG9pbnRPYmplY3RbImN1dG9mZkh6Il0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50LmZyZXEgPSBGaWx0ZXJDb250cm9sUG9pbnQuZ2V0Um91bmRlZFNldHRpbmdWYWx1ZUZyb21Ieihwb2ludE9iamVjdFsiY3V0b2ZmSHoiXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBwb2ludC5mcmVxID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHBvaW50T2JqZWN0WyJsaW5lYXJHYWluIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50LmdhaW4gPSBGaWx0ZXJDb250cm9sUG9pbnQuZ2V0Um91bmRlZFNldHRpbmdWYWx1ZUZyb21MaW5lYXJHYWluKHBvaW50T2JqZWN0WyJsaW5lYXJHYWluIl0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnQuZ2FpbiA9IENvbmZpZy5maWx0ZXJHYWluQ2VudGVyOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRyb2xQb2ludHMucHVzaChwb2ludCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5jb250cm9sUG9pbnRDb3VudCA9IHRoaXMuY29udHJvbFBvaW50cy5sZW5ndGg7CiAgICAgICAgfQogICAgICAgIGNvbnZlcnRMZWdhY3lTZXR0aW5ncyhsZWdhY3lDdXRvZmZTZXR0aW5nLCBsZWdhY3lSZXNvbmFuY2VTZXR0aW5nLCBsZWdhY3lFbnYpIHsKICAgICAgICAgICAgdGhpcy5yZXNldCgpOwogICAgICAgICAgICBjb25zdCBsZWdhY3lGaWx0ZXJDdXRvZmZNYXhIeiA9IDgwMDA7CiAgICAgICAgICAgIGNvbnN0IGxlZ2FjeUZpbHRlck1heCA9IDAuOTU7CiAgICAgICAgICAgIGNvbnN0IGxlZ2FjeUZpbHRlck1heFJhZGlhbnMgPSBNYXRoLmFzaW4obGVnYWN5RmlsdGVyTWF4IC8gMi4wKSAqIDIuMDsKICAgICAgICAgICAgY29uc3QgbGVnYWN5RmlsdGVyTWF4UmVzb25hbmNlID0gMC45NTsKICAgICAgICAgICAgY29uc3QgbGVnYWN5RmlsdGVyQ3V0b2ZmUmFuZ2UgPSAxMTsKICAgICAgICAgICAgY29uc3QgbGVnYWN5RmlsdGVyUmVzb25hbmNlUmFuZ2UgPSA4OwogICAgICAgICAgICBjb25zdCByZXNvbmFudCA9IChsZWdhY3lSZXNvbmFuY2VTZXR0aW5nID4gMSk7CiAgICAgICAgICAgIGNvbnN0IGZpcnN0T3JkZXIgPSAobGVnYWN5UmVzb25hbmNlU2V0dGluZyA9PSAwKTsKICAgICAgICAgICAgY29uc3QgY3V0b2ZmQXRNYXggPSAobGVnYWN5Q3V0b2ZmU2V0dGluZyA9PSBsZWdhY3lGaWx0ZXJDdXRvZmZSYW5nZSAtIDEpOwogICAgICAgICAgICBjb25zdCBlbnZEZWNheXMgPSAobGVnYWN5RW52LnR5cGUgPT0gMyB8fCBsZWdhY3lFbnYudHlwZSA9PSA0IHx8IGxlZ2FjeUVudi50eXBlID09IDggfHwgbGVnYWN5RW52LnR5cGUgPT0gMCk7CiAgICAgICAgICAgIGNvbnN0IHN0YW5kYXJkU2FtcGxlUmF0ZSA9IDQ4MDAwOwogICAgICAgICAgICBjb25zdCBsZWdhY3lIeiA9IGxlZ2FjeUZpbHRlckN1dG9mZk1heEh6ICogTWF0aC5wb3coMi4wLCAobGVnYWN5Q3V0b2ZmU2V0dGluZyAtIChsZWdhY3lGaWx0ZXJDdXRvZmZSYW5nZSAtIDEpKSAqIDAuNSk7CiAgICAgICAgICAgIGNvbnN0IGxlZ2FjeVJhZGlhbnMgPSBNYXRoLm1pbihsZWdhY3lGaWx0ZXJNYXhSYWRpYW5zLCAyICogTWF0aC5QSSAqIGxlZ2FjeUh6IC8gc3RhbmRhcmRTYW1wbGVSYXRlKTsKICAgICAgICAgICAgaWYgKGxlZ2FjeUVudi50eXBlID09IDEgJiYgIXJlc29uYW50ICYmIGN1dG9mZkF0TWF4KSA7CiAgICAgICAgICAgIGVsc2UgaWYgKGZpcnN0T3JkZXIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGV4dHJhT2N0YXZlcyA9IDMuNTsKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFJhZGlhbnMgPSBsZWdhY3lSYWRpYW5zICogTWF0aC5wb3coMi4wLCBleHRyYU9jdGF2ZXMpOwogICAgICAgICAgICAgICAgY29uc3QgY3VydmVkUmFkaWFucyA9IHRhcmdldFJhZGlhbnMgLyAoMS4wICsgdGFyZ2V0UmFkaWFucyAvIE1hdGguUEkpOwogICAgICAgICAgICAgICAgY29uc3QgY3VydmVkSHogPSBzdGFuZGFyZFNhbXBsZVJhdGUgKiBjdXJ2ZWRSYWRpYW5zIC8gKDIuMCAqIE1hdGguUEkpOwogICAgICAgICAgICAgICAgY29uc3QgZnJlcVNldHRpbmcgPSBGaWx0ZXJDb250cm9sUG9pbnQuZ2V0Um91bmRlZFNldHRpbmdWYWx1ZUZyb21IeihjdXJ2ZWRIeik7CiAgICAgICAgICAgICAgICBjb25zdCBmaW5hbEh6ID0gRmlsdGVyQ29udHJvbFBvaW50LmdldEh6RnJvbVNldHRpbmdWYWx1ZShmcmVxU2V0dGluZyk7CiAgICAgICAgICAgICAgICBjb25zdCBmaW5hbFJhZGlhbnMgPSAyLjAgKiBNYXRoLlBJICogZmluYWxIeiAvIHN0YW5kYXJkU2FtcGxlUmF0ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeUZpbHRlciA9IG5ldyBGaWx0ZXJDb2VmZmljaWVudHMoKTsKICAgICAgICAgICAgICAgIGxlZ2FjeUZpbHRlci5sb3dQYXNzMXN0T3JkZXJTaW1wbGlmaWVkKGxlZ2FjeVJhZGlhbnMpOwogICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBuZXcgRnJlcXVlbmN5UmVzcG9uc2UoKTsKICAgICAgICAgICAgICAgIHJlc3BvbnNlLmFuYWx5emUobGVnYWN5RmlsdGVyLCBmaW5hbFJhZGlhbnMpOwogICAgICAgICAgICAgICAgY29uc3QgbGVnYWN5RmlsdGVyR2FpbkF0TmV3UmFkaWFucyA9IHJlc3BvbnNlLm1hZ25pdHVkZSgpOwogICAgICAgICAgICAgICAgbGV0IGxvZ0dhaW4gPSBNYXRoLmxvZzIobGVnYWN5RmlsdGVyR2FpbkF0TmV3UmFkaWFucyk7CiAgICAgICAgICAgICAgICBsb2dHYWluID0gLWV4dHJhT2N0YXZlcyArIChsb2dHYWluICsgZXh0cmFPY3RhdmVzKSAqIDAuODI7CiAgICAgICAgICAgICAgICBpZiAoZW52RGVjYXlzKQogICAgICAgICAgICAgICAgICAgIGxvZ0dhaW4gPSBNYXRoLm1pbihsb2dHYWluLCAtMS4wKTsKICAgICAgICAgICAgICAgIGNvbnN0IGNvbnZlcnRlZEdhaW4gPSBNYXRoLnBvdygyLjAsIGxvZ0dhaW4pOwogICAgICAgICAgICAgICAgY29uc3QgZ2FpblNldHRpbmcgPSBGaWx0ZXJDb250cm9sUG9pbnQuZ2V0Um91bmRlZFNldHRpbmdWYWx1ZUZyb21MaW5lYXJHYWluKGNvbnZlcnRlZEdhaW4pOwogICAgICAgICAgICAgICAgdGhpcy5hZGRQb2ludCgwLCBmcmVxU2V0dGluZywgZ2FpblNldHRpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgaW50ZW5kZWRHYWluID0gMC41IC8gKDEuMCAtIGxlZ2FjeUZpbHRlck1heFJlc29uYW5jZSAqIE1hdGguc3FydChNYXRoLm1heCgwLjAsIGxlZ2FjeVJlc29uYW5jZVNldHRpbmcgLSAxLjApIC8gKGxlZ2FjeUZpbHRlclJlc29uYW5jZVJhbmdlIC0gMi4wKSkpOwogICAgICAgICAgICAgICAgY29uc3QgaW52ZXJ0ZWRHYWluID0gMC41IC8gaW50ZW5kZWRHYWluOwogICAgICAgICAgICAgICAgY29uc3QgbWF4UmFkaWFucyA9IDIuMCAqIE1hdGguUEkgKiBsZWdhY3lGaWx0ZXJDdXRvZmZNYXhIeiAvIHN0YW5kYXJkU2FtcGxlUmF0ZTsKICAgICAgICAgICAgICAgIGNvbnN0IGZyZXFSYXRpbyA9IGxlZ2FjeVJhZGlhbnMgLyBtYXhSYWRpYW5zOwogICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0UmFkaWFucyA9IGxlZ2FjeVJhZGlhbnMgKiAoZnJlcVJhdGlvICogTWF0aC5wb3coaW52ZXJ0ZWRHYWluLCAwLjkpICsgMS4wKTsKICAgICAgICAgICAgICAgIGNvbnN0IGN1cnZlZFJhZGlhbnMgPSBsZWdhY3lSYWRpYW5zICsgKHRhcmdldFJhZGlhbnMgLSBsZWdhY3lSYWRpYW5zKSAqIGludmVydGVkR2FpbjsKICAgICAgICAgICAgICAgIGxldCBjdXJ2ZWRIejsKICAgICAgICAgICAgICAgIGlmIChlbnZEZWNheXMpIHsKICAgICAgICAgICAgICAgICAgICBjdXJ2ZWRIeiA9IHN0YW5kYXJkU2FtcGxlUmF0ZSAqIE1hdGgubWluKGN1cnZlZFJhZGlhbnMsIGxlZ2FjeVJhZGlhbnMgKiBNYXRoLnBvdygyLCAwLjI1KSkgLyAoMi4wICogTWF0aC5QSSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJ2ZWRIeiA9IHN0YW5kYXJkU2FtcGxlUmF0ZSAqIGN1cnZlZFJhZGlhbnMgLyAoMi4wICogTWF0aC5QSSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBmcmVxU2V0dGluZyA9IEZpbHRlckNvbnRyb2xQb2ludC5nZXRSb3VuZGVkU2V0dGluZ1ZhbHVlRnJvbUh6KGN1cnZlZEh6KTsKICAgICAgICAgICAgICAgIGxldCBsZWdhY3lGaWx0ZXJHYWluOwogICAgICAgICAgICAgICAgaWYgKGVudkRlY2F5cykgewogICAgICAgICAgICAgICAgICAgIGxlZ2FjeUZpbHRlckdhaW4gPSBpbnRlbmRlZEdhaW47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lGaWx0ZXIgPSBuZXcgRmlsdGVyQ29lZmZpY2llbnRzKCk7CiAgICAgICAgICAgICAgICAgICAgbGVnYWN5RmlsdGVyLmxvd1Bhc3MybmRPcmRlclNpbXBsaWZpZWQobGVnYWN5UmFkaWFucywgaW50ZW5kZWRHYWluKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IG5ldyBGcmVxdWVuY3lSZXNwb25zZSgpOwogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlLmFuYWx5emUobGVnYWN5RmlsdGVyLCBjdXJ2ZWRSYWRpYW5zKTsKICAgICAgICAgICAgICAgICAgICBsZWdhY3lGaWx0ZXJHYWluID0gcmVzcG9uc2UubWFnbml0dWRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIXJlc29uYW50KQogICAgICAgICAgICAgICAgICAgIGxlZ2FjeUZpbHRlckdhaW4gPSBNYXRoLm1pbihsZWdhY3lGaWx0ZXJHYWluLCBNYXRoLnNxcnQoMC41KSk7CiAgICAgICAgICAgICAgICBjb25zdCBnYWluU2V0dGluZyA9IEZpbHRlckNvbnRyb2xQb2ludC5nZXRSb3VuZGVkU2V0dGluZ1ZhbHVlRnJvbUxpbmVhckdhaW4obGVnYWN5RmlsdGVyR2Fpbik7CiAgICAgICAgICAgICAgICB0aGlzLmFkZFBvaW50KDAsIGZyZXFTZXR0aW5nLCBnYWluU2V0dGluZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjbGFzcyBFbnZlbG9wZVNldHRpbmdzIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSAwOwogICAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5lbnZlbG9wZSA9IDA7CiAgICAgICAgICAgIHRoaXMucmVzZXQoKTsKICAgICAgICB9CiAgICAgICAgcmVzZXQoKSB7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0ID0gMDsKICAgICAgICAgICAgdGhpcy5pbmRleCA9IDA7CiAgICAgICAgICAgIHRoaXMuZW52ZWxvcGUgPSAwOwogICAgICAgIH0KICAgICAgICB0b0pzb25PYmplY3QoKSB7CiAgICAgICAgICAgIGNvbnN0IGVudmVsb3BlT2JqZWN0ID0gewogICAgICAgICAgICAgICAgInRhcmdldCI6IENvbmZpZy5pbnN0cnVtZW50QXV0b21hdGlvblRhcmdldHNbdGhpcy50YXJnZXRdLm5hbWUsCiAgICAgICAgICAgICAgICAiZW52ZWxvcGUiOiBDb25maWcuZW52ZWxvcGVzW3RoaXMuZW52ZWxvcGVdLm5hbWUsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGlmIChDb25maWcuaW5zdHJ1bWVudEF1dG9tYXRpb25UYXJnZXRzW3RoaXMudGFyZ2V0XS5tYXhDb3VudCA+IDEpIHsKICAgICAgICAgICAgICAgIGVudmVsb3BlT2JqZWN0WyJpbmRleCJdID0gdGhpcy5pbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZW52ZWxvcGVPYmplY3Q7CiAgICAgICAgfQogICAgICAgIGZyb21Kc29uT2JqZWN0KGVudmVsb3BlT2JqZWN0KSB7CiAgICAgICAgICAgIHRoaXMucmVzZXQoKTsKICAgICAgICAgICAgbGV0IHRhcmdldCA9IENvbmZpZy5pbnN0cnVtZW50QXV0b21hdGlvblRhcmdldHMuZGljdGlvbmFyeVtlbnZlbG9wZU9iamVjdFsidGFyZ2V0Il1dOwogICAgICAgICAgICBpZiAodGFyZ2V0ID09IG51bGwpCiAgICAgICAgICAgICAgICB0YXJnZXQgPSBDb25maWcuaW5zdHJ1bWVudEF1dG9tYXRpb25UYXJnZXRzLmRpY3Rpb25hcnlbIm5vdGVWb2x1bWUiXTsKICAgICAgICAgICAgdGhpcy50YXJnZXQgPSB0YXJnZXQuaW5kZXg7CiAgICAgICAgICAgIGxldCBlbnZlbG9wZSA9IENvbmZpZy5lbnZlbG9wZXMuZGljdGlvbmFyeVtlbnZlbG9wZU9iamVjdFsiZW52ZWxvcGUiXV07CiAgICAgICAgICAgIGlmIChlbnZlbG9wZSA9PSBudWxsKQogICAgICAgICAgICAgICAgZW52ZWxvcGUgPSBDb25maWcuZW52ZWxvcGVzLmRpY3Rpb25hcnlbIm5vbmUiXTsKICAgICAgICAgICAgdGhpcy5lbnZlbG9wZSA9IGVudmVsb3BlLmluZGV4OwogICAgICAgICAgICBpZiAoZW52ZWxvcGVPYmplY3RbImluZGV4Il0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmluZGV4ID0gY2xhbXAoMCwgQ29uZmlnLmluc3RydW1lbnRBdXRvbWF0aW9uVGFyZ2V0c1t0aGlzLnRhcmdldF0ubWF4Q291bnQsIGVudmVsb3BlT2JqZWN0WyJpbmRleCJdIHwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmluZGV4ID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGNsYXNzIEluc3RydW1lbnQgewogICAgICAgIGNvbnN0cnVjdG9yKGlzTm9pc2VDaGFubmVsKSB7CiAgICAgICAgICAgIHRoaXMudHlwZSA9IDA7CiAgICAgICAgICAgIHRoaXMucHJlc2V0ID0gMDsKICAgICAgICAgICAgdGhpcy5jaGlwV2F2ZSA9IDI7CiAgICAgICAgICAgIHRoaXMuY2hpcE5vaXNlID0gMTsKICAgICAgICAgICAgdGhpcy5lcUZpbHRlciA9IG5ldyBGaWx0ZXJTZXR0aW5ncygpOwogICAgICAgICAgICB0aGlzLm5vdGVGaWx0ZXIgPSBuZXcgRmlsdGVyU2V0dGluZ3MoKTsKICAgICAgICAgICAgdGhpcy5lbnZlbG9wZXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5lbnZlbG9wZUNvdW50ID0gMDsKICAgICAgICAgICAgdGhpcy5mYWRlSW4gPSAwOwogICAgICAgICAgICB0aGlzLmZhZGVPdXQgPSBDb25maWcuZmFkZU91dE5ldXRyYWw7CiAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvbiA9IENvbmZpZy50cmFuc2l0aW9ucy5kaWN0aW9uYXJ5WyJub3JtYWwiXS5pbmRleDsKICAgICAgICAgICAgdGhpcy5waXRjaFNoaWZ0ID0gMDsKICAgICAgICAgICAgdGhpcy5kZXR1bmUgPSAwOwogICAgICAgICAgICB0aGlzLnZpYnJhdG8gPSAwOwogICAgICAgICAgICB0aGlzLnVuaXNvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuZWZmZWN0cyA9IDA7CiAgICAgICAgICAgIHRoaXMuY2hvcmQgPSAxOwogICAgICAgICAgICB0aGlzLnZvbHVtZSA9IDA7CiAgICAgICAgICAgIHRoaXMucGFuID0gQ29uZmlnLnBhbkNlbnRlcjsKICAgICAgICAgICAgdGhpcy5wdWxzZVdpZHRoID0gQ29uZmlnLnB1bHNlV2lkdGhSYW5nZSAtIDE7CiAgICAgICAgICAgIHRoaXMuc3RyaW5nU3VzdGFpbiA9IDEwOwogICAgICAgICAgICB0aGlzLmRpc3RvcnRpb24gPSAwOwogICAgICAgICAgICB0aGlzLmJpdGNydXNoZXJGcmVxID0gMDsKICAgICAgICAgICAgdGhpcy5iaXRjcnVzaGVyUXVhbnRpemF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5jaG9ydXMgPSAwOwogICAgICAgICAgICB0aGlzLnJldmVyYiA9IDA7CiAgICAgICAgICAgIHRoaXMuZWNob1N1c3RhaW4gPSAwOwogICAgICAgICAgICB0aGlzLmVjaG9EZWxheSA9IDA7CiAgICAgICAgICAgIHRoaXMuYWxnb3JpdGhtID0gMDsKICAgICAgICAgICAgdGhpcy5mZWVkYmFja1R5cGUgPSAwOwogICAgICAgICAgICB0aGlzLmZlZWRiYWNrQW1wbGl0dWRlID0gMDsKICAgICAgICAgICAgdGhpcy5vcGVyYXRvcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5oYXJtb25pY3NXYXZlID0gbmV3IEhhcm1vbmljc1dhdmUoKTsKICAgICAgICAgICAgdGhpcy5kcnVtc2V0RW52ZWxvcGVzID0gW107CiAgICAgICAgICAgIHRoaXMuZHJ1bXNldFNwZWN0cnVtV2F2ZXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5zcGVjdHJ1bVdhdmUgPSBuZXcgU3BlY3RydW1XYXZlKGlzTm9pc2VDaGFubmVsKTsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBDb25maWcub3BlcmF0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICB0aGlzLm9wZXJhdG9yc1tpXSA9IG5ldyBPcGVyYXRvcihpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IENvbmZpZy5kcnVtQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5kcnVtc2V0RW52ZWxvcGVzW2ldID0gQ29uZmlnLmVudmVsb3Blcy5kaWN0aW9uYXJ5WyJ0d2FuZyAyIl0uaW5kZXg7CiAgICAgICAgICAgICAgICB0aGlzLmRydW1zZXRTcGVjdHJ1bVdhdmVzW2ldID0gbmV3IFNwZWN0cnVtV2F2ZSh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzZXRUeXBlQW5kUmVzZXQodHlwZSwgaXNOb2lzZUNoYW5uZWwpIHsKICAgICAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICAgICAgdGhpcy5wcmVzZXQgPSB0eXBlOwogICAgICAgICAgICB0aGlzLnZvbHVtZSA9IDA7CiAgICAgICAgICAgIHRoaXMuZWZmZWN0cyA9IDA7CiAgICAgICAgICAgIHRoaXMuY2hvcnVzID0gQ29uZmlnLmNob3J1c1JhbmdlIC0gMTsKICAgICAgICAgICAgdGhpcy5yZXZlcmIgPSAyOwogICAgICAgICAgICB0aGlzLmVjaG9TdXN0YWluID0gTWF0aC5mbG9vcigoQ29uZmlnLmVjaG9TdXN0YWluUmFuZ2UgLSAxKSAqIDAuNSk7CiAgICAgICAgICAgIHRoaXMuZWNob0RlbGF5ID0gTWF0aC5mbG9vcigoQ29uZmlnLmVjaG9EZWxheVJhbmdlIC0gMSkgKiAwLjUpOwogICAgICAgICAgICB0aGlzLmVxRmlsdGVyLnJlc2V0KCk7CiAgICAgICAgICAgIHRoaXMubm90ZUZpbHRlci5yZXNldCgpOwogICAgICAgICAgICB0aGlzLmRpc3RvcnRpb24gPSBNYXRoLmZsb29yKChDb25maWcuZGlzdG9ydGlvblJhbmdlIC0gMSkgKiAwLjc1KTsKICAgICAgICAgICAgdGhpcy5iaXRjcnVzaGVyRnJlcSA9IE1hdGguZmxvb3IoKENvbmZpZy5iaXRjcnVzaGVyRnJlcVJhbmdlIC0gMSkgKiAwLjUpOwogICAgICAgICAgICB0aGlzLmJpdGNydXNoZXJRdWFudGl6YXRpb24gPSBNYXRoLmZsb29yKChDb25maWcuYml0Y3J1c2hlclF1YW50aXphdGlvblJhbmdlIC0gMSkgKiAwLjUpOwogICAgICAgICAgICB0aGlzLnBhbiA9IENvbmZpZy5wYW5DZW50ZXI7CiAgICAgICAgICAgIHRoaXMucGl0Y2hTaGlmdCA9IENvbmZpZy5waXRjaFNoaWZ0Q2VudGVyOwogICAgICAgICAgICB0aGlzLmRldHVuZSA9IENvbmZpZy5kZXR1bmVDZW50ZXI7CiAgICAgICAgICAgIHRoaXMudmlicmF0byA9IDA7CiAgICAgICAgICAgIHRoaXMudW5pc29uID0gMDsKICAgICAgICAgICAgdGhpcy5zdHJpbmdTdXN0YWluID0gMTA7CiAgICAgICAgICAgIHRoaXMuZmFkZUluID0gMDsKICAgICAgICAgICAgdGhpcy5mYWRlT3V0ID0gQ29uZmlnLmZhZGVPdXROZXV0cmFsOwogICAgICAgICAgICB0aGlzLnRyYW5zaXRpb24gPSBDb25maWcudHJhbnNpdGlvbnMuZGljdGlvbmFyeVsibm9ybWFsIl0uaW5kZXg7CiAgICAgICAgICAgIHRoaXMuZW52ZWxvcGVDb3VudCA9IDA7CiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpcFdhdmUgPSAyOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hvcmQgPSBDb25maWcuY2hvcmRzLmRpY3Rpb25hcnlbImFycGVnZ2lvIl0uaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaG9yZCA9IENvbmZpZy5jaG9yZHMuZGljdGlvbmFyeVsiY3VzdG9tIGludGVydmFsIl0uaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hbGdvcml0aG0gPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZmVlZGJhY2tUeXBlID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZlZWRiYWNrQW1wbGl0dWRlID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMub3BlcmF0b3JzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3BlcmF0b3JzW2ldLnJlc2V0KGkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmNoaXBOb2lzZSA9IDE7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaG9yZCA9IENvbmZpZy5jaG9yZHMuZGljdGlvbmFyeVsiYXJwZWdnaW8iXS5pbmRleDsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICB0aGlzLmNob3JkID0gQ29uZmlnLmNob3Jkcy5kaWN0aW9uYXJ5WyJzaW11bHRhbmVvdXMiXS5pbmRleDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNwZWN0cnVtV2F2ZS5yZXNldChpc05vaXNlQ2hhbm5lbCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaG9yZCA9IENvbmZpZy5jaG9yZHMuZGljdGlvbmFyeVsic2ltdWx0YW5lb3VzIl0uaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBDb25maWcuZHJ1bUNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcnVtc2V0RW52ZWxvcGVzW2ldID0gQ29uZmlnLmVudmVsb3Blcy5kaWN0aW9uYXJ5WyJ0d2FuZyAyIl0uaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZHJ1bXNldFNwZWN0cnVtV2F2ZXNbaV0ucmVzZXQoaXNOb2lzZUNoYW5uZWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNToKICAgICAgICAgICAgICAgICAgICB0aGlzLmNob3JkID0gQ29uZmlnLmNob3Jkcy5kaWN0aW9uYXJ5WyJzaW11bHRhbmVvdXMiXS5pbmRleDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhhcm1vbmljc1dhdmUucmVzZXQoKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIGNhc2UgNjoKICAgICAgICAgICAgICAgICAgICB0aGlzLmNob3JkID0gQ29uZmlnLmNob3Jkcy5kaWN0aW9uYXJ5WyJhcnBlZ2dpbyJdLmluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucHVsc2VXaWR0aCA9IENvbmZpZy5wdWxzZVdpZHRoUmFuZ2UgLSAxOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgY2FzZSA3OgogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hvcmQgPSBDb25maWcuY2hvcmRzLmRpY3Rpb25hcnlbInN0cnVtIl0uaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYXJtb25pY3NXYXZlLnJlc2V0KCk7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5yZWNvZ25pemVkIGluc3RydW1lbnQgdHlwZTogIiArIHR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmNob3JkICE9IENvbmZpZy5jaG9yZHMuZGljdGlvbmFyeVsic2ltdWx0YW5lb3VzIl0uaW5kZXgpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWZmZWN0cyA9ICh0aGlzLmVmZmVjdHMgfCAoMSA8PCAxMSkpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNvbnZlcnRMZWdhY3lTZXR0aW5ncyhsZWdhY3lTZXR0aW5ncykgewogICAgICAgICAgICBsZXQgbGVnYWN5Q3V0b2ZmU2V0dGluZyA9IGxlZ2FjeVNldHRpbmdzLmZpbHRlckN1dG9mZjsKICAgICAgICAgICAgbGV0IGxlZ2FjeVJlc29uYW5jZVNldHRpbmcgPSBsZWdhY3lTZXR0aW5ncy5maWx0ZXJSZXNvbmFuY2U7CiAgICAgICAgICAgIGxldCBsZWdhY3lGaWx0ZXJFbnYgPSBsZWdhY3lTZXR0aW5ncy5maWx0ZXJFbnZlbG9wZTsKICAgICAgICAgICAgbGV0IGxlZ2FjeVB1bHNlRW52ID0gbGVnYWN5U2V0dGluZ3MucHVsc2VFbnZlbG9wZTsKICAgICAgICAgICAgbGV0IGxlZ2FjeU9wZXJhdG9yRW52ZWxvcGVzID0gbGVnYWN5U2V0dGluZ3Mub3BlcmF0b3JFbnZlbG9wZXM7CiAgICAgICAgICAgIGxldCBsZWdhY3lGZWVkYmFja0VudiA9IGxlZ2FjeVNldHRpbmdzLmZlZWRiYWNrRW52ZWxvcGU7CiAgICAgICAgICAgIGlmIChsZWdhY3lDdXRvZmZTZXR0aW5nID09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIGxlZ2FjeUN1dG9mZlNldHRpbmcgPSAodGhpcy50eXBlID09IDApID8gNiA6IDEwOwogICAgICAgICAgICBpZiAobGVnYWN5UmVzb25hbmNlU2V0dGluZyA9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICBsZWdhY3lSZXNvbmFuY2VTZXR0aW5nID0gMDsKICAgICAgICAgICAgaWYgKGxlZ2FjeUZpbHRlckVudiA9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICBsZWdhY3lGaWx0ZXJFbnYgPSBDb25maWcuZW52ZWxvcGVzLmRpY3Rpb25hcnlbIm5vbmUiXTsKICAgICAgICAgICAgaWYgKGxlZ2FjeVB1bHNlRW52ID09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIGxlZ2FjeVB1bHNlRW52ID0gQ29uZmlnLmVudmVsb3Blcy5kaWN0aW9uYXJ5Wyh0aGlzLnR5cGUgPT0gNikgPyAidHdhbmcgMiIgOiAibm9uZSJdOwogICAgICAgICAgICBpZiAobGVnYWN5T3BlcmF0b3JFbnZlbG9wZXMgPT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgbGVnYWN5T3BlcmF0b3JFbnZlbG9wZXMgPSBbQ29uZmlnLmVudmVsb3Blcy5kaWN0aW9uYXJ5Wyh0aGlzLnR5cGUgPT0gMSkgPyAibm90ZSBzaXplIiA6ICJub25lIl0sIENvbmZpZy5lbnZlbG9wZXMuZGljdGlvbmFyeVsibm9uZSJdLCBDb25maWcuZW52ZWxvcGVzLmRpY3Rpb25hcnlbIm5vbmUiXSwgQ29uZmlnLmVudmVsb3Blcy5kaWN0aW9uYXJ5WyJub25lIl1dOwogICAgICAgICAgICBpZiAobGVnYWN5RmVlZGJhY2tFbnYgPT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgbGVnYWN5RmVlZGJhY2tFbnYgPSBDb25maWcuZW52ZWxvcGVzLmRpY3Rpb25hcnlbIm5vbmUiXTsKICAgICAgICAgICAgY29uc3QgY2FycmllckNvdW50ID0gQ29uZmlnLmFsZ29yaXRobXNbdGhpcy5hbGdvcml0aG1dLmNhcnJpZXJDb3VudDsKICAgICAgICAgICAgbGV0IG5vQ2FycmllcnNDb250cm9sbGVkQnlOb3RlU2l6ZSA9IHRydWU7CiAgICAgICAgICAgIGxldCBhbGxDYXJyaWVyc0NvbnRyb2xsZWRCeU5vdGVTaXplID0gdHJ1ZTsKICAgICAgICAgICAgbGV0IG5vdGVTaXplQ29udHJvbHNTb21ldGhpbmdFbHNlID0gKGxlZ2FjeUZpbHRlckVudi50eXBlID09IDApIHx8IChsZWdhY3lQdWxzZUVudi50eXBlID09IDApOwogICAgICAgICAgICBpZiAodGhpcy50eXBlID09IDEpIHsKICAgICAgICAgICAgICAgIG5vdGVTaXplQ29udHJvbHNTb21ldGhpbmdFbHNlID0gbm90ZVNpemVDb250cm9sc1NvbWV0aGluZ0Vsc2UgfHwgKGxlZ2FjeUZlZWRiYWNrRW52LnR5cGUgPT0gMCk7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlZ2FjeU9wZXJhdG9yRW52ZWxvcGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGkgPCBjYXJyaWVyQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlZ2FjeU9wZXJhdG9yRW52ZWxvcGVzW2ldLnR5cGUgIT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWxsQ2FycmllcnNDb250cm9sbGVkQnlOb3RlU2l6ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9DYXJyaWVyc0NvbnRyb2xsZWRCeU5vdGVTaXplID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vdGVTaXplQ29udHJvbHNTb21ldGhpbmdFbHNlID0gbm90ZVNpemVDb250cm9sc1NvbWV0aGluZ0Vsc2UgfHwgKGxlZ2FjeU9wZXJhdG9yRW52ZWxvcGVzW2ldLnR5cGUgPT0gMCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZW52ZWxvcGVDb3VudCA9IDA7CiAgICAgICAgICAgIGlmICh0aGlzLnR5cGUgPT0gMSkgewogICAgICAgICAgICAgICAgaWYgKGFsbENhcnJpZXJzQ29udHJvbGxlZEJ5Tm90ZVNpemUgJiYgbm90ZVNpemVDb250cm9sc1NvbWV0aGluZ0Vsc2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZEVudmVsb3BlKENvbmZpZy5pbnN0cnVtZW50QXV0b21hdGlvblRhcmdldHMuZGljdGlvbmFyeVsibm90ZVZvbHVtZSJdLmluZGV4LCAwLCBDb25maWcuZW52ZWxvcGVzLmRpY3Rpb25hcnlbIm5vdGUgc2l6ZSJdLmluZGV4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG5vQ2FycmllcnNDb250cm9sbGVkQnlOb3RlU2l6ZSAmJiAhbm90ZVNpemVDb250cm9sc1NvbWV0aGluZ0Vsc2UpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZEVudmVsb3BlKENvbmZpZy5pbnN0cnVtZW50QXV0b21hdGlvblRhcmdldHMuZGljdGlvbmFyeVsibm9uZSJdLmluZGV4LCAwLCBDb25maWcuZW52ZWxvcGVzLmRpY3Rpb25hcnlbIm5vdGUgc2l6ZSJdLmluZGV4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGVnYWN5RmlsdGVyRW52LnR5cGUgPT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5ub3RlRmlsdGVyLnJlc2V0KCk7CiAgICAgICAgICAgICAgICB0aGlzLmVxRmlsdGVyLmNvbnZlcnRMZWdhY3lTZXR0aW5ncyhsZWdhY3lDdXRvZmZTZXR0aW5nLCBsZWdhY3lSZXNvbmFuY2VTZXR0aW5nLCBsZWdhY3lGaWx0ZXJFbnYpOwogICAgICAgICAgICAgICAgdGhpcy5lZmZlY3RzICY9IH4oMSA8PCA1KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZXFGaWx0ZXIucmVzZXQoKTsKICAgICAgICAgICAgICAgIHRoaXMubm90ZUZpbHRlci5jb252ZXJ0TGVnYWN5U2V0dGluZ3MobGVnYWN5Q3V0b2ZmU2V0dGluZywgbGVnYWN5UmVzb25hbmNlU2V0dGluZywgbGVnYWN5RmlsdGVyRW52KTsKICAgICAgICAgICAgICAgIHRoaXMuZWZmZWN0cyB8PSAxIDw8IDU7CiAgICAgICAgICAgICAgICB0aGlzLmFkZEVudmVsb3BlKENvbmZpZy5pbnN0cnVtZW50QXV0b21hdGlvblRhcmdldHMuZGljdGlvbmFyeVsibm90ZUZpbHRlckFsbEZyZXFzIl0uaW5kZXgsIDAsIGxlZ2FjeUZpbHRlckVudi5pbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxlZ2FjeVB1bHNlRW52LnR5cGUgIT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5hZGRFbnZlbG9wZShDb25maWcuaW5zdHJ1bWVudEF1dG9tYXRpb25UYXJnZXRzLmRpY3Rpb25hcnlbInB1bHNlV2lkdGgiXS5pbmRleCwgMCwgbGVnYWN5UHVsc2VFbnYuaW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVnYWN5T3BlcmF0b3JFbnZlbG9wZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChpIDwgY2FycmllckNvdW50ICYmIGFsbENhcnJpZXJzQ29udHJvbGxlZEJ5Tm90ZVNpemUpCiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICBpZiAobGVnYWN5T3BlcmF0b3JFbnZlbG9wZXNbaV0udHlwZSAhPSAxKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRFbnZlbG9wZShDb25maWcuaW5zdHJ1bWVudEF1dG9tYXRpb25UYXJnZXRzLmRpY3Rpb25hcnlbIm9wZXJhdG9yQW1wbGl0dWRlIl0uaW5kZXgsIGksIGxlZ2FjeU9wZXJhdG9yRW52ZWxvcGVzW2ldLmluZGV4KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAobGVnYWN5RmVlZGJhY2tFbnYudHlwZSAhPSAxKSB7CiAgICAgICAgICAgICAgICB0aGlzLmFkZEVudmVsb3BlKENvbmZpZy5pbnN0cnVtZW50QXV0b21hdGlvblRhcmdldHMuZGljdGlvbmFyeVsiZmVlZGJhY2tBbXBsaXR1ZGUiXS5pbmRleCwgMCwgbGVnYWN5RmVlZGJhY2tFbnYuaW5kZXgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRvSnNvbk9iamVjdCgpIHsKICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudE9iamVjdCA9IHsKICAgICAgICAgICAgICAgICJ0eXBlIjogQ29uZmlnLmluc3RydW1lbnRUeXBlTmFtZXNbdGhpcy50eXBlXSwKICAgICAgICAgICAgICAgICJ2b2x1bWUiOiAoNSAtIHRoaXMudm9sdW1lKSAqIDIwLAogICAgICAgICAgICAgICAgImVxRmlsdGVyIjogdGhpcy5lcUZpbHRlci50b0pzb25PYmplY3QoKSwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKHRoaXMucHJlc2V0ICE9IHRoaXMudHlwZSkgewogICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsicHJlc2V0Il0gPSB0aGlzLnByZXNldDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBlZmZlY3RzID0gW107CiAgICAgICAgICAgIGZvciAoY29uc3QgZWZmZWN0IG9mIENvbmZpZy5lZmZlY3RPcmRlcikgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWZmZWN0cyAmICgxIDw8IGVmZmVjdCkpIHsKICAgICAgICAgICAgICAgICAgICBlZmZlY3RzLnB1c2goQ29uZmlnLmVmZmVjdE5hbWVzW2VmZmVjdF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3RbImVmZmVjdHMiXSA9IGVmZmVjdHM7CiAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZVRyYW5zaXRpb24odGhpcy5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsidHJhbnNpdGlvbiJdID0gQ29uZmlnLnRyYW5zaXRpb25zW3RoaXMudHJhbnNpdGlvbl0ubmFtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVDaG9yZCh0aGlzLmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJjaG9yZCJdID0gdGhpcy5nZXRDaG9yZCgpLm5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlUGl0Y2hTaGlmdCh0aGlzLmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJwaXRjaFNoaWZ0U2VtaXRvbmVzIl0gPSB0aGlzLnBpdGNoU2hpZnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlRGV0dW5lKHRoaXMuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3RbImRldHVuZUNlbnRzIl0gPSBTeW50aC5kZXR1bmVUb0NlbnRzKHRoaXMuZGV0dW5lIC0gQ29uZmlnLmRldHVuZUNlbnRlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlVmlicmF0byh0aGlzLmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJ2aWJyYXRvIl0gPSBDb25maWcudmlicmF0b3NbdGhpcy52aWJyYXRvXS5uYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZU5vdGVGaWx0ZXIodGhpcy5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsibm90ZUZpbHRlciJdID0gdGhpcy5ub3RlRmlsdGVyLnRvSnNvbk9iamVjdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZURpc3RvcnRpb24odGhpcy5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsiZGlzdG9ydGlvbiJdID0gTWF0aC5yb3VuZCgxMDAgKiB0aGlzLmRpc3RvcnRpb24gLyAoQ29uZmlnLmRpc3RvcnRpb25SYW5nZSAtIDEpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVCaXRjcnVzaGVyKHRoaXMuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3RbImJpdGNydXNoZXJPY3RhdmUiXSA9IChDb25maWcuYml0Y3J1c2hlckZyZXFSYW5nZSAtIDEgLSB0aGlzLmJpdGNydXNoZXJGcmVxKSAqIENvbmZpZy5iaXRjcnVzaGVyT2N0YXZlU3RlcDsKICAgICAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3RbImJpdGNydXNoZXJRdWFudGl6YXRpb24iXSA9IE1hdGgucm91bmQoMTAwICogdGhpcy5iaXRjcnVzaGVyUXVhbnRpemF0aW9uIC8gKENvbmZpZy5iaXRjcnVzaGVyUXVhbnRpemF0aW9uUmFuZ2UgLSAxKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlUGFubmluZyh0aGlzLmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJwYW4iXSA9IE1hdGgucm91bmQoMTAwICogKHRoaXMucGFuIC0gQ29uZmlnLnBhbkNlbnRlcikgLyBDb25maWcucGFuQ2VudGVyKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVDaG9ydXModGhpcy5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsiY2hvcnVzIl0gPSBNYXRoLnJvdW5kKDEwMCAqIHRoaXMuY2hvcnVzIC8gKENvbmZpZy5jaG9ydXNSYW5nZSAtIDEpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVFY2hvKHRoaXMuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3RbImVjaG9TdXN0YWluIl0gPSBNYXRoLnJvdW5kKDEwMCAqIHRoaXMuZWNob1N1c3RhaW4gLyAoQ29uZmlnLmVjaG9TdXN0YWluUmFuZ2UgLSAxKSk7CiAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJlY2hvRGVsYXlCZWF0cyJdID0gTWF0aC5yb3VuZCgxMDAwICogKHRoaXMuZWNob0RlbGF5ICsgMSkgKiBDb25maWcuZWNob0RlbGF5U3RlcFRpY2tzIC8gKENvbmZpZy50aWNrc1BlclBhcnQgKiBDb25maWcucGFydHNQZXJCZWF0KSkgLyAxMDAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZVJldmVyYih0aGlzLmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJyZXZlcmIiXSA9IE1hdGgucm91bmQoMTAwICogdGhpcy5yZXZlcmIgLyAoQ29uZmlnLnJldmVyYlJhbmdlIC0gMSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnR5cGUgIT0gNCkgewogICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsiZmFkZUluU2Vjb25kcyJdID0gTWF0aC5yb3VuZCgxMDAwMCAqIFN5bnRoLmZhZGVJblNldHRpbmdUb1NlY29uZHModGhpcy5mYWRlSW4pKSAvIDEwMDAwOwogICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsiZmFkZU91dFRpY2tzIl0gPSBTeW50aC5mYWRlT3V0U2V0dGluZ1RvVGlja3ModGhpcy5mYWRlT3V0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy50eXBlID09IDUgfHwgdGhpcy50eXBlID09IDcpIHsKICAgICAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3RbImhhcm1vbmljcyJdID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IENvbmZpZy5oYXJtb25pY3NDb250cm9sUG9pbnRzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJoYXJtb25pY3MiXVtpXSA9IE1hdGgucm91bmQoMTAwICogdGhpcy5oYXJtb25pY3NXYXZlLmhhcm1vbmljc1tpXSAvIENvbmZpZy5oYXJtb25pY3NNYXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnR5cGUgPT0gMikgewogICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsid2F2ZSJdID0gQ29uZmlnLmNoaXBOb2lzZXNbdGhpcy5jaGlwTm9pc2VdLm5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy50eXBlID09IDMpIHsKICAgICAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3RbInNwZWN0cnVtIl0gPSBbXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsic3BlY3RydW0iXVtpXSA9IE1hdGgucm91bmQoMTAwICogdGhpcy5zcGVjdHJ1bVdhdmUuc3BlY3RydW1baV0gLyBDb25maWcuc3BlY3RydW1NYXgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudHlwZSA9PSA0KSB7CiAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJkcnVtcyJdID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IENvbmZpZy5kcnVtQ291bnQ7IGorKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWN0cnVtID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBDb25maWcuc3BlY3RydW1Db250cm9sUG9pbnRzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3BlY3RydW1baV0gPSBNYXRoLnJvdW5kKDEwMCAqIHRoaXMuZHJ1bXNldFNwZWN0cnVtV2F2ZXNbal0uc3BlY3RydW1baV0gLyBDb25maWcuc3BlY3RydW1NYXgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJkcnVtcyJdW2pdID0gewogICAgICAgICAgICAgICAgICAgICAgICAiZmlsdGVyRW52ZWxvcGUiOiB0aGlzLmdldERydW1zZXRFbnZlbG9wZShqKS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAic3BlY3RydW0iOiBzcGVjdHJ1bSwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudHlwZSA9PSAwKSB7CiAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJ3YXZlIl0gPSBDb25maWcuY2hpcFdhdmVzW3RoaXMuY2hpcFdhdmVdLm5hbWU7CiAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJ1bmlzb24iXSA9IENvbmZpZy51bmlzb25zW3RoaXMudW5pc29uXS5uYW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudHlwZSA9PSA2KSB7CiAgICAgICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJwdWxzZVdpZHRoIl0gPSBNYXRoLnJvdW5kKGdldFB1bHNlV2lkdGhSYXRpbyh0aGlzLnB1bHNlV2lkdGgpICogMTAwICogMTAwMDAwKSAvIDEwMDAwMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLnR5cGUgPT0gNykgewogICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsidW5pc29uIl0gPSBDb25maWcudW5pc29uc1t0aGlzLnVuaXNvbl0ubmFtZTsKICAgICAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3RbInN0cmluZ1N1c3RhaW4iXSA9IE1hdGgucm91bmQoMTAwICogdGhpcy5zdHJpbmdTdXN0YWluIC8gKENvbmZpZy5zdHJpbmdTdXN0YWluUmFuZ2UgLSAxKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy50eXBlID09IDUpIHsKICAgICAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3RbInVuaXNvbiJdID0gQ29uZmlnLnVuaXNvbnNbdGhpcy51bmlzb25dLm5hbWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy50eXBlID09IDEpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9wZXJhdG9yQXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgb3BlcmF0b3Igb2YgdGhpcy5vcGVyYXRvcnMpIHsKICAgICAgICAgICAgICAgICAgICBvcGVyYXRvckFycmF5LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAiZnJlcXVlbmN5IjogQ29uZmlnLm9wZXJhdG9yRnJlcXVlbmNpZXNbb3BlcmF0b3IuZnJlcXVlbmN5XS5uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAiYW1wbGl0dWRlIjogb3BlcmF0b3IuYW1wbGl0dWRlLAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsiYWxnb3JpdGhtIl0gPSBDb25maWcuYWxnb3JpdGhtc1t0aGlzLmFsZ29yaXRobV0ubmFtZTsKICAgICAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3RbImZlZWRiYWNrVHlwZSJdID0gQ29uZmlnLmZlZWRiYWNrc1t0aGlzLmZlZWRiYWNrVHlwZV0ubmFtZTsKICAgICAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3RbImZlZWRiYWNrQW1wbGl0dWRlIl0gPSB0aGlzLmZlZWRiYWNrQW1wbGl0dWRlOwogICAgICAgICAgICAgICAgaW5zdHJ1bWVudE9iamVjdFsib3BlcmF0b3JzIl0gPSBvcGVyYXRvckFycmF5OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbnJlY29nbml6ZWQgaW5zdHJ1bWVudCB0eXBlIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3QgZW52ZWxvcGVzID0gW107CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5lbnZlbG9wZUNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIGVudmVsb3Blcy5wdXNoKHRoaXMuZW52ZWxvcGVzW2ldLnRvSnNvbk9iamVjdCgpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnN0cnVtZW50T2JqZWN0WyJlbnZlbG9wZXMiXSA9IGVudmVsb3BlczsKICAgICAgICAgICAgcmV0dXJuIGluc3RydW1lbnRPYmplY3Q7CiAgICAgICAgfQogICAgICAgIGZyb21Kc29uT2JqZWN0KGluc3RydW1lbnRPYmplY3QsIGlzTm9pc2VDaGFubmVsLCBsZWdhY3lHbG9iYWxSZXZlcmIgPSAwKSB7CiAgICAgICAgICAgIGlmIChpbnN0cnVtZW50T2JqZWN0ID09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgIGluc3RydW1lbnRPYmplY3QgPSB7fTsKICAgICAgICAgICAgbGV0IHR5cGUgPSBDb25maWcuaW5zdHJ1bWVudFR5cGVOYW1lcy5pbmRleE9mKGluc3RydW1lbnRPYmplY3RbInR5cGUiXSk7CiAgICAgICAgICAgIGlmICh0eXBlID09IC0xKQogICAgICAgICAgICAgICAgdHlwZSA9IGlzTm9pc2VDaGFubmVsID8gMiA6IDA7CiAgICAgICAgICAgIHRoaXMuc2V0VHlwZUFuZFJlc2V0KHR5cGUsIGlzTm9pc2VDaGFubmVsKTsKICAgICAgICAgICAgaWYgKGluc3RydW1lbnRPYmplY3RbInByZXNldCJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5wcmVzZXQgPSBpbnN0cnVtZW50T2JqZWN0WyJwcmVzZXQiXSA+Pj4gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdHJ1bWVudE9iamVjdFsidm9sdW1lIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnZvbHVtZSA9IGNsYW1wKDAsIENvbmZpZy52b2x1bWVSYW5nZSwgTWF0aC5yb3VuZCg1IC0gKGluc3RydW1lbnRPYmplY3RbInZvbHVtZSJdIHwgMCkgLyAyMCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy52b2x1bWUgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGluc3RydW1lbnRPYmplY3RbImVmZmVjdHMiXSkpIHsKICAgICAgICAgICAgICAgIGxldCBlZmZlY3RzID0gMDsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5zdHJ1bWVudE9iamVjdFsiZWZmZWN0cyJdLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0cyA9IGVmZmVjdHMgfCAoMSA8PCBDb25maWcuZWZmZWN0TmFtZXMuaW5kZXhPZihpbnN0cnVtZW50T2JqZWN0WyJlZmZlY3RzIl1baV0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuZWZmZWN0cyA9IChlZmZlY3RzICYgKCgxIDw8IDEyKSAtIDEpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeUVmZmVjdHNOYW1lcyA9IFsibm9uZSIsICJyZXZlcmIiLCAiY2hvcnVzIiwgImNob3J1cyAmIHJldmVyYiJdOwogICAgICAgICAgICAgICAgdGhpcy5lZmZlY3RzID0gbGVnYWN5RWZmZWN0c05hbWVzLmluZGV4T2YoaW5zdHJ1bWVudE9iamVjdFsiZWZmZWN0cyJdKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVmZmVjdHMgPT0gLTEpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5lZmZlY3RzID0gKHRoaXMudHlwZSA9PSAyKSA/IDAgOiAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvbiA9IENvbmZpZy50cmFuc2l0aW9ucy5kaWN0aW9uYXJ5WyJub3JtYWwiXS5pbmRleDsKICAgICAgICAgICAgY29uc3QgdHJhbnNpdGlvblByb3BlcnR5ID0gaW5zdHJ1bWVudE9iamVjdFsidHJhbnNpdGlvbiJdIHx8IGluc3RydW1lbnRPYmplY3RbImVudmVsb3BlIl07CiAgICAgICAgICAgIGlmICh0cmFuc2l0aW9uUHJvcGVydHkgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBsZXQgdHJhbnNpdGlvbiA9IENvbmZpZy50cmFuc2l0aW9ucy5kaWN0aW9uYXJ5W3RyYW5zaXRpb25Qcm9wZXJ0eV07CiAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudE9iamVjdFsiZmFkZUluU2Vjb25kcyJdID09IHVuZGVmaW5lZCB8fCBpbnN0cnVtZW50T2JqZWN0WyJmYWRlT3V0VGlja3MiXSA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lTZXR0aW5ncyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgImJpbmFyeSI6IHsgdHJhbnNpdGlvbjogImludGVycnVwdCIsIGZhZGVJblNlY29uZHM6IDAuMCwgZmFkZU91dFRpY2tzOiAtMSB9LAogICAgICAgICAgICAgICAgICAgICAgICAic2VhbWxlc3MiOiB7IHRyYW5zaXRpb246ICJpbnRlcnJ1cHQiLCBmYWRlSW5TZWNvbmRzOiAwLjAsIGZhZGVPdXRUaWNrczogLTEgfSwKICAgICAgICAgICAgICAgICAgICAgICAgInN1ZGRlbiI6IHsgdHJhbnNpdGlvbjogIm5vcm1hbCIsIGZhZGVJblNlY29uZHM6IDAuMCwgZmFkZU91dFRpY2tzOiAtMyB9LAogICAgICAgICAgICAgICAgICAgICAgICAiaGFyZCI6IHsgdHJhbnNpdGlvbjogIm5vcm1hbCIsIGZhZGVJblNlY29uZHM6IDAuMCwgZmFkZU91dFRpY2tzOiAtMyB9LAogICAgICAgICAgICAgICAgICAgICAgICAic21vb3RoIjogeyB0cmFuc2l0aW9uOiAibm9ybWFsIiwgZmFkZUluU2Vjb25kczogMC4wMjUsIGZhZGVPdXRUaWNrczogLTMgfSwKICAgICAgICAgICAgICAgICAgICAgICAgInNvZnQiOiB7IHRyYW5zaXRpb246ICJub3JtYWwiLCBmYWRlSW5TZWNvbmRzOiAwLjAyNSwgZmFkZU91dFRpY2tzOiAtMyB9LAogICAgICAgICAgICAgICAgICAgICAgICAic2xpZGUiOiB7IHRyYW5zaXRpb246ICJzbGlkZSBpbiBwYXR0ZXJuIiwgZmFkZUluU2Vjb25kczogMC4wMjUsIGZhZGVPdXRUaWNrczogLTMgfSwKICAgICAgICAgICAgICAgICAgICAgICAgImNyb3NzIGZhZGUiOiB7IHRyYW5zaXRpb246ICJub3JtYWwiLCBmYWRlSW5TZWNvbmRzOiAwLjA0LCBmYWRlT3V0VGlja3M6IDYgfSwKICAgICAgICAgICAgICAgICAgICAgICAgImhhcmQgZmFkZSI6IHsgdHJhbnNpdGlvbjogIm5vcm1hbCIsIGZhZGVJblNlY29uZHM6IDAuMCwgZmFkZU91dFRpY2tzOiA0OCB9LAogICAgICAgICAgICAgICAgICAgICAgICAibWVkaXVtIGZhZGUiOiB7IHRyYW5zaXRpb246ICJub3JtYWwiLCBmYWRlSW5TZWNvbmRzOiAwLjAxMjUsIGZhZGVPdXRUaWNrczogNzIgfSwKICAgICAgICAgICAgICAgICAgICAgICAgInNvZnQgZmFkZSI6IHsgdHJhbnNpdGlvbjogIm5vcm1hbCIsIGZhZGVJblNlY29uZHM6IDAuMDYsIGZhZGVPdXRUaWNrczogOTYgfSwKICAgICAgICAgICAgICAgICAgICB9W3RyYW5zaXRpb25Qcm9wZXJ0eV07CiAgICAgICAgICAgICAgICAgICAgaWYgKGxlZ2FjeVNldHRpbmdzICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uID0gQ29uZmlnLnRyYW5zaXRpb25zLmRpY3Rpb25hcnlbbGVnYWN5U2V0dGluZ3MudHJhbnNpdGlvbl07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZmFkZUluID0gU3ludGguc2Vjb25kc1RvRmFkZUluU2V0dGluZyhsZWdhY3lTZXR0aW5ncy5mYWRlSW5TZWNvbmRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mYWRlT3V0ID0gU3ludGgudGlja3NUb0ZhZGVPdXRTZXR0aW5nKGxlZ2FjeVNldHRpbmdzLmZhZGVPdXRUaWNrcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRyYW5zaXRpb24gIT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgIHRoaXMudHJhbnNpdGlvbiA9IHRyYW5zaXRpb24uaW5kZXg7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmFuc2l0aW9uICE9IENvbmZpZy50cmFuc2l0aW9ucy5kaWN0aW9uYXJ5WyJub3JtYWwiXS5pbmRleCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZWZmZWN0cyA9ICh0aGlzLmVmZmVjdHMgfCAoMSA8PCAxMCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0cnVtZW50T2JqZWN0WyJmYWRlSW5TZWNvbmRzIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZhZGVJbiA9IFN5bnRoLnNlY29uZHNUb0ZhZGVJblNldHRpbmcoK2luc3RydW1lbnRPYmplY3RbImZhZGVJblNlY29uZHMiXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RydW1lbnRPYmplY3RbImZhZGVPdXRUaWNrcyJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5mYWRlT3V0ID0gU3ludGgudGlja3NUb0ZhZGVPdXRTZXR0aW5nKCtpbnN0cnVtZW50T2JqZWN0WyJmYWRlT3V0VGlja3MiXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29uc3QgY2hvcmRQcm9wZXJ0eSA9IGluc3RydW1lbnRPYmplY3RbImNob3JkIl07CiAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lDaG9yZE5hbWVzID0geyAiaGFybW9ueSI6ICJzaW11bHRhbmVvdXMiIH07CiAgICAgICAgICAgICAgICBjb25zdCBjaG9yZCA9IENvbmZpZy5jaG9yZHMuZGljdGlvbmFyeVtsZWdhY3lDaG9yZE5hbWVzW2Nob3JkUHJvcGVydHldXSB8fCBDb25maWcuY2hvcmRzLmRpY3Rpb25hcnlbY2hvcmRQcm9wZXJ0eV07CiAgICAgICAgICAgICAgICBpZiAoY2hvcmQgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaG9yZCA9IGNob3JkLmluZGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudHlwZSA9PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hvcmQgPSBDb25maWcuY2hvcmRzLmRpY3Rpb25hcnlbImFycGVnZ2lvIl0uaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudHlwZSA9PSA3KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hvcmQgPSBDb25maWcuY2hvcmRzLmRpY3Rpb25hcnlbInN0cnVtIl0uaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudHlwZSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hvcmQgPSBDb25maWcuY2hvcmRzLmRpY3Rpb25hcnlbImFycGVnZ2lvIl0uaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudHlwZSA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hvcmQgPSBDb25maWcuY2hvcmRzLmRpY3Rpb25hcnlbImN1c3RvbSBpbnRlcnZhbCJdLmluZGV4OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaG9yZCA9IENvbmZpZy5jaG9yZHMuZGljdGlvbmFyeVsic2ltdWx0YW5lb3VzIl0uaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudW5pc29uID0gQ29uZmlnLnVuaXNvbnMuZGljdGlvbmFyeVsibm9uZSJdLmluZGV4OwogICAgICAgICAgICBjb25zdCB1bmlzb25Qcm9wZXJ0eSA9IGluc3RydW1lbnRPYmplY3RbInVuaXNvbiJdIHx8IGluc3RydW1lbnRPYmplY3RbImludGVydmFsIl0gfHwgaW5zdHJ1bWVudE9iamVjdFsiY2hvcnVzIl07CiAgICAgICAgICAgIGlmICh1bmlzb25Qcm9wZXJ0eSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeUNob3J1c05hbWVzID0geyAidW5pb24iOiAibm9uZSIsICJmaWZ0aHMiOiAiZmlmdGgiLCAib2N0YXZlcyI6ICJvY3RhdmUiIH07CiAgICAgICAgICAgICAgICBjb25zdCB1bmlzb24gPSBDb25maWcudW5pc29ucy5kaWN0aW9uYXJ5W2xlZ2FjeUNob3J1c05hbWVzW3VuaXNvblByb3BlcnR5XV0gfHwgQ29uZmlnLnVuaXNvbnMuZGljdGlvbmFyeVt1bmlzb25Qcm9wZXJ0eV07CiAgICAgICAgICAgICAgICBpZiAodW5pc29uICE9IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnVuaXNvbiA9IHVuaXNvbi5pbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdHJ1bWVudE9iamVjdFsiY2hvcnVzIl0gPT0gImN1c3RvbSBoYXJtb255IikgewogICAgICAgICAgICAgICAgdGhpcy51bmlzb24gPSBDb25maWcudW5pc29ucy5kaWN0aW9uYXJ5WyJodW0iXS5pbmRleDsKICAgICAgICAgICAgICAgIHRoaXMuY2hvcmQgPSBDb25maWcuY2hvcmRzLmRpY3Rpb25hcnlbImN1c3RvbSBpbnRlcnZhbCJdLmluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLmNob3JkICE9IENvbmZpZy5jaG9yZHMuZGljdGlvbmFyeVsic2ltdWx0YW5lb3VzIl0uaW5kZXggJiYgIUFycmF5LmlzQXJyYXkoaW5zdHJ1bWVudE9iamVjdFsiZWZmZWN0cyJdKSkgewogICAgICAgICAgICAgICAgdGhpcy5lZmZlY3RzID0gKHRoaXMuZWZmZWN0cyB8ICgxIDw8IDExKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RydW1lbnRPYmplY3RbInBpdGNoU2hpZnRTZW1pdG9uZXMiXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucGl0Y2hTaGlmdCA9IGNsYW1wKDAsIENvbmZpZy5waXRjaFNoaWZ0UmFuZ2UsIE1hdGgucm91bmQoK2luc3RydW1lbnRPYmplY3RbInBpdGNoU2hpZnRTZW1pdG9uZXMiXSkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0cnVtZW50T2JqZWN0WyJkZXR1bmVDZW50cyJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5kZXR1bmUgPSBjbGFtcCgwLCBDb25maWcuZGV0dW5lTWF4ICsgMSwgTWF0aC5yb3VuZChDb25maWcuZGV0dW5lQ2VudGVyICsgU3ludGguY2VudHNUb0RldHVuZSgraW5zdHJ1bWVudE9iamVjdFsiZGV0dW5lQ2VudHMiXSkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZpYnJhdG8gPSBDb25maWcudmlicmF0b3MuZGljdGlvbmFyeVsibm9uZSJdLmluZGV4OwogICAgICAgICAgICBjb25zdCB2aWJyYXRvUHJvcGVydHkgPSBpbnN0cnVtZW50T2JqZWN0WyJ2aWJyYXRvIl0gfHwgaW5zdHJ1bWVudE9iamVjdFsiZWZmZWN0Il07CiAgICAgICAgICAgIGlmICh2aWJyYXRvUHJvcGVydHkgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lWaWJyYXRvTmFtZXMgPSB7ICJ2aWJyYXRvIGxpZ2h0IjogImxpZ2h0IiwgInZpYnJhdG8gZGVsYXllZCI6ICJkZWxheWVkIiwgInZpYnJhdG8gaGVhdnkiOiAiaGVhdnkiIH07CiAgICAgICAgICAgICAgICBjb25zdCB2aWJyYXRvID0gQ29uZmlnLnZpYnJhdG9zLmRpY3Rpb25hcnlbbGVnYWN5VmlicmF0b05hbWVzW3VuaXNvblByb3BlcnR5XV0gfHwgQ29uZmlnLnZpYnJhdG9zLmRpY3Rpb25hcnlbdmlicmF0b1Byb3BlcnR5XTsKICAgICAgICAgICAgICAgIGlmICh2aWJyYXRvICE9IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgICB0aGlzLnZpYnJhdG8gPSB2aWJyYXRvLmluZGV4OwogICAgICAgICAgICAgICAgaWYgKHZpYnJhdG8gIT0gQ29uZmlnLnZpYnJhdG9zLmRpY3Rpb25hcnlbIm5vbmUiXSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZWZmZWN0cyA9ICh0aGlzLmVmZmVjdHMgfCAoMSA8PCA5KSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RydW1lbnRPYmplY3RbInBhbiJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5wYW4gPSBjbGFtcCgwLCBDb25maWcucGFuTWF4ICsgMSwgTWF0aC5yb3VuZChDb25maWcucGFuQ2VudGVyICsgKGluc3RydW1lbnRPYmplY3RbInBhbiJdIHwgMCkgKiBDb25maWcucGFuQ2VudGVyIC8gMTAwKSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5wYW4gIT0gQ29uZmlnLnBhbkNlbnRlcikgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZWZmZWN0cyA9ICh0aGlzLmVmZmVjdHMgfCAoMSA8PCAyKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhbiA9IENvbmZpZy5wYW5DZW50ZXI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RydW1lbnRPYmplY3RbImRpc3RvcnRpb24iXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZGlzdG9ydGlvbiA9IGNsYW1wKDAsIENvbmZpZy5kaXN0b3J0aW9uUmFuZ2UsIE1hdGgucm91bmQoKENvbmZpZy5kaXN0b3J0aW9uUmFuZ2UgLSAxKSAqIChpbnN0cnVtZW50T2JqZWN0WyJkaXN0b3J0aW9uIl0gfCAwKSAvIDEwMCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0cnVtZW50T2JqZWN0WyJiaXRjcnVzaGVyT2N0YXZlIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJpdGNydXNoZXJGcmVxID0gQ29uZmlnLmJpdGNydXNoZXJGcmVxUmFuZ2UgLSAxIC0gKCtpbnN0cnVtZW50T2JqZWN0WyJiaXRjcnVzaGVyT2N0YXZlIl0pIC8gQ29uZmlnLmJpdGNydXNoZXJPY3RhdmVTdGVwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0cnVtZW50T2JqZWN0WyJiaXRjcnVzaGVyUXVhbnRpemF0aW9uIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJpdGNydXNoZXJRdWFudGl6YXRpb24gPSBjbGFtcCgwLCBDb25maWcuYml0Y3J1c2hlclF1YW50aXphdGlvblJhbmdlLCBNYXRoLnJvdW5kKChDb25maWcuYml0Y3J1c2hlclF1YW50aXphdGlvblJhbmdlIC0gMSkgKiAoaW5zdHJ1bWVudE9iamVjdFsiYml0Y3J1c2hlclF1YW50aXphdGlvbiJdIHwgMCkgLyAxMDApKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdHJ1bWVudE9iamVjdFsiZWNob1N1c3RhaW4iXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWNob1N1c3RhaW4gPSBjbGFtcCgwLCBDb25maWcuZWNob1N1c3RhaW5SYW5nZSwgTWF0aC5yb3VuZCgoQ29uZmlnLmVjaG9TdXN0YWluUmFuZ2UgLSAxKSAqIChpbnN0cnVtZW50T2JqZWN0WyJlY2hvU3VzdGFpbiJdIHwgMCkgLyAxMDApKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdHJ1bWVudE9iamVjdFsiZWNob0RlbGF5QmVhdHMiXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWNob0RlbGF5ID0gY2xhbXAoMCwgQ29uZmlnLmVjaG9EZWxheVJhbmdlLCBNYXRoLnJvdW5kKCgraW5zdHJ1bWVudE9iamVjdFsiZWNob0RlbGF5QmVhdHMiXSkgKiAoQ29uZmlnLnRpY2tzUGVyUGFydCAqIENvbmZpZy5wYXJ0c1BlckJlYXQpIC8gQ29uZmlnLmVjaG9EZWxheVN0ZXBUaWNrcyAtIDEuMCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaXNOYU4oaW5zdHJ1bWVudE9iamVjdFsiY2hvcnVzIl0pKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNob3J1cyA9IGNsYW1wKDAsIENvbmZpZy5jaG9ydXNSYW5nZSwgTWF0aC5yb3VuZCgoQ29uZmlnLmNob3J1c1JhbmdlIC0gMSkgKiAoaW5zdHJ1bWVudE9iamVjdFsiY2hvcnVzIl0gfCAwKSAvIDEwMCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChpbnN0cnVtZW50T2JqZWN0WyJyZXZlcmIiXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucmV2ZXJiID0gY2xhbXAoMCwgQ29uZmlnLnJldmVyYlJhbmdlLCBNYXRoLnJvdW5kKChDb25maWcucmV2ZXJiUmFuZ2UgLSAxKSAqIChpbnN0cnVtZW50T2JqZWN0WyJyZXZlcmIiXSB8IDApIC8gMTAwKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAobGVnYWN5R2xvYmFsUmV2ZXJiID09IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVmZmVjdHMgPSAodGhpcy5lZmZlY3RzICYgKH4oMSA8PCAwKSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXZlcmIgPSBsZWdhY3lHbG9iYWxSZXZlcmI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RydW1lbnRPYmplY3RbInB1bHNlV2lkdGgiXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucHVsc2VXaWR0aCA9IGNsYW1wKDAsIENvbmZpZy5wdWxzZVdpZHRoUmFuZ2UsIE1hdGgucm91bmQoTWF0aC5sb2cyKCgraW5zdHJ1bWVudE9iamVjdFsicHVsc2VXaWR0aCJdKSAvIDUwKSAvIDAuNSAtIDEgKyA4KSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnB1bHNlV2lkdGggPSBDb25maWcucHVsc2VXaWR0aFJhbmdlIC0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdHJ1bWVudE9iamVjdFsiaGFybW9uaWNzIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IENvbmZpZy5oYXJtb25pY3NDb250cm9sUG9pbnRzOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhhcm1vbmljc1dhdmUuaGFybW9uaWNzW2ldID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oQ29uZmlnLmhhcm1vbmljc01heCwgTWF0aC5yb3VuZChDb25maWcuaGFybW9uaWNzTWF4ICogKCtpbnN0cnVtZW50T2JqZWN0WyJoYXJtb25pY3MiXVtpXSkgLyAxMDApKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmhhcm1vbmljc1dhdmUucmVzZXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdHJ1bWVudE9iamVjdFsic3BlY3RydW0iXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zcGVjdHJ1bVdhdmUuc3BlY3RydW1baV0gPSBNYXRoLm1heCgwLCBNYXRoLm1pbihDb25maWcuc3BlY3RydW1NYXgsIE1hdGgucm91bmQoQ29uZmlnLnNwZWN0cnVtTWF4ICogKCtpbnN0cnVtZW50T2JqZWN0WyJzcGVjdHJ1bSJdW2ldKSAvIDEwMCkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuc3BlY3RydW1XYXZlLnJlc2V0KGlzTm9pc2VDaGFubmVsKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoaW5zdHJ1bWVudE9iamVjdFsic3RyaW5nU3VzdGFpbiJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgdGhpcy5zdHJpbmdTdXN0YWluID0gY2xhbXAoMCwgQ29uZmlnLnN0cmluZ1N1c3RhaW5SYW5nZSwgTWF0aC5yb3VuZCgoQ29uZmlnLnN0cmluZ1N1c3RhaW5SYW5nZSAtIDEpICogKGluc3RydW1lbnRPYmplY3RbInN0cmluZ1N1c3RhaW4iXSB8IDApIC8gMTAwKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnN0cmluZ1N1c3RhaW4gPSAxMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy50eXBlID09IDIpIHsKICAgICAgICAgICAgICAgIHRoaXMuY2hpcE5vaXNlID0gQ29uZmlnLmNoaXBOb2lzZXMuZmluZEluZGV4KHdhdmUgPT4gd2F2ZS5uYW1lID09IGluc3RydW1lbnRPYmplY3RbIndhdmUiXSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGlwTm9pc2UgPT0gLTEpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGlwTm9pc2UgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGxlZ2FjeUVudmVsb3BlTmFtZXMgPSB7ICJjdXN0b20iOiAibm90ZSBzaXplIiwgInN0ZWFkeSI6ICJub25lIiwgInBsdWNrIDEiOiAidHdhbmcgMSIsICJwbHVjayAyIjogInR3YW5nIDIiLCAicGx1Y2sgMyI6ICJ0d2FuZyAzIiB9OwogICAgICAgICAgICBjb25zdCBnZXRFbnZlbG9wZSA9IChuYW1lKSA9PiAobGVnYWN5RW52ZWxvcGVOYW1lc1tuYW1lXSAhPSB1bmRlZmluZWQpID8gQ29uZmlnLmVudmVsb3Blcy5kaWN0aW9uYXJ5W2xlZ2FjeUVudmVsb3BlTmFtZXNbbmFtZV1dIDogQ29uZmlnLmVudmVsb3Blcy5kaWN0aW9uYXJ5W25hbWVdOwogICAgICAgICAgICBpZiAodGhpcy50eXBlID09IDQpIHsKICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50T2JqZWN0WyJkcnVtcyJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgQ29uZmlnLmRydW1Db3VudDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGRydW0gPSBpbnN0cnVtZW50T2JqZWN0WyJkcnVtcyJdW2pdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHJ1bSA9PSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcnVtc2V0RW52ZWxvcGVzW2pdID0gQ29uZmlnLmVudmVsb3Blcy5kaWN0aW9uYXJ5WyJ0d2FuZyAyIl0uaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkcnVtWyJmaWx0ZXJFbnZlbG9wZSJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZW52ZWxvcGUgPSBnZXRFbnZlbG9wZShkcnVtWyJmaWx0ZXJFbnZlbG9wZSJdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnZlbG9wZSAhPSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kcnVtc2V0RW52ZWxvcGVzW2pdID0gZW52ZWxvcGUuaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRydW1bInNwZWN0cnVtIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IENvbmZpZy5zcGVjdHJ1bUNvbnRyb2xQb2ludHM7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZHJ1bXNldFNwZWN0cnVtV2F2ZXNbal0uc3BlY3RydW1baV0gPSBNYXRoLm1heCgwLCBNYXRoLm1pbihDb25maWcuc3BlY3RydW1NYXgsIE1hdGgucm91bmQoQ29uZmlnLnNwZWN0cnVtTWF4ICogKCtkcnVtWyJzcGVjdHJ1bSJdW2ldKSAvIDEwMCkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy50eXBlID09IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeVdhdmVOYW1lcyA9IHsgInRyaWFuZ2xlIjogMSwgInNxdWFyZSI6IDIsICJwdWxzZSB3aWRlIjogMywgInB1bHNlIG5hcnJvdyI6IDQsICJzYXd0b290aCI6IDUsICJkb3VibGUgc2F3IjogNiwgImRvdWJsZSBwdWxzZSI6IDcsICJzcGlreSI6IDgsICJwbGF0ZWF1IjogMCB9OwogICAgICAgICAgICAgICAgdGhpcy5jaGlwV2F2ZSA9IGxlZ2FjeVdhdmVOYW1lc1tpbnN0cnVtZW50T2JqZWN0WyJ3YXZlIl1dICE9IHVuZGVmaW5lZCA/IGxlZ2FjeVdhdmVOYW1lc1tpbnN0cnVtZW50T2JqZWN0WyJ3YXZlIl1dIDogQ29uZmlnLmNoaXBXYXZlcy5maW5kSW5kZXgod2F2ZSA9PiB3YXZlLm5hbWUgPT0gaW5zdHJ1bWVudE9iamVjdFsid2F2ZSJdKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoaXBXYXZlID09IC0xKQogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hpcFdhdmUgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnR5cGUgPT0gMSkgewogICAgICAgICAgICAgICAgdGhpcy5hbGdvcml0aG0gPSBDb25maWcuYWxnb3JpdGhtcy5maW5kSW5kZXgoYWxnb3JpdGhtID0+IGFsZ29yaXRobS5uYW1lID09IGluc3RydW1lbnRPYmplY3RbImFsZ29yaXRobSJdKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmFsZ29yaXRobSA9PSAtMSkKICAgICAgICAgICAgICAgICAgICB0aGlzLmFsZ29yaXRobSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmZlZWRiYWNrVHlwZSA9IENvbmZpZy5mZWVkYmFja3MuZmluZEluZGV4KGZlZWRiYWNrID0+IGZlZWRiYWNrLm5hbWUgPT0gaW5zdHJ1bWVudE9iamVjdFsiZmVlZGJhY2tUeXBlIl0pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZmVlZGJhY2tUeXBlID09IC0xKQogICAgICAgICAgICAgICAgICAgIHRoaXMuZmVlZGJhY2tUeXBlID0gMDsKICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50T2JqZWN0WyJmZWVkYmFja0FtcGxpdHVkZSJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZmVlZGJhY2tBbXBsaXR1ZGUgPSBjbGFtcCgwLCBDb25maWcub3BlcmF0b3JBbXBsaXR1ZGVNYXggKyAxLCBpbnN0cnVtZW50T2JqZWN0WyJmZWVkYmFja0FtcGxpdHVkZSJdIHwgMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZlZWRiYWNrQW1wbGl0dWRlID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgQ29uZmlnLm9wZXJhdG9yQ291bnQ7IGorKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wZXJhdG9yID0gdGhpcy5vcGVyYXRvcnNbal07CiAgICAgICAgICAgICAgICAgICAgbGV0IG9wZXJhdG9yT2JqZWN0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50T2JqZWN0WyJvcGVyYXRvcnMiXSAhPSB1bmRlZmluZWQpCiAgICAgICAgICAgICAgICAgICAgICAgIG9wZXJhdG9yT2JqZWN0ID0gaW5zdHJ1bWVudE9iamVjdFsib3BlcmF0b3JzIl1bal07CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wZXJhdG9yT2JqZWN0ID09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgICAgICAgb3BlcmF0b3JPYmplY3QgPSB7fTsKICAgICAgICAgICAgICAgICAgICBvcGVyYXRvci5mcmVxdWVuY3kgPSBDb25maWcub3BlcmF0b3JGcmVxdWVuY2llcy5maW5kSW5kZXgoZnJlcSA9PiBmcmVxLm5hbWUgPT0gb3BlcmF0b3JPYmplY3RbImZyZXF1ZW5jeSJdKTsKICAgICAgICAgICAgICAgICAgICBpZiAob3BlcmF0b3IuZnJlcXVlbmN5ID09IC0xKQogICAgICAgICAgICAgICAgICAgICAgICBvcGVyYXRvci5mcmVxdWVuY3kgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmIChvcGVyYXRvck9iamVjdFsiYW1wbGl0dWRlIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9wZXJhdG9yLmFtcGxpdHVkZSA9IGNsYW1wKDAsIENvbmZpZy5vcGVyYXRvckFtcGxpdHVkZU1heCArIDEsIG9wZXJhdG9yT2JqZWN0WyJhbXBsaXR1ZGUiXSB8IDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3BlcmF0b3IuYW1wbGl0dWRlID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RydW1lbnRPYmplY3RbIm5vdGVGaWx0ZXIiXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMubm90ZUZpbHRlci5mcm9tSnNvbk9iamVjdChpbnN0cnVtZW50T2JqZWN0WyJub3RlRmlsdGVyIl0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5ub3RlRmlsdGVyLnJlc2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaW5zdHJ1bWVudE9iamVjdFsiZXFGaWx0ZXIiXSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuZXFGaWx0ZXIuZnJvbUpzb25PYmplY3QoaW5zdHJ1bWVudE9iamVjdFsiZXFGaWx0ZXIiXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVxRmlsdGVyLnJlc2V0KCk7CiAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lTZXR0aW5ncyA9IHt9OwogICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyQ3V0b2ZmTWF4SHogPSA4MDAwOwogICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyQ3V0b2ZmUmFuZ2UgPSAxMTsKICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlclJlc29uYW5jZVJhbmdlID0gODsKICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50T2JqZWN0WyJmaWx0ZXJDdXRvZmZIeiJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGxlZ2FjeVNldHRpbmdzLmZpbHRlckN1dG9mZiA9IGNsYW1wKDAsIGZpbHRlckN1dG9mZlJhbmdlLCBNYXRoLnJvdW5kKChmaWx0ZXJDdXRvZmZSYW5nZSAtIDEpICsgMi4wICogTWF0aC5sb2coKGluc3RydW1lbnRPYmplY3RbImZpbHRlckN1dG9mZkh6Il0gfCAwKSAvIGZpbHRlckN1dG9mZk1heEh6KSAvIE1hdGguTE4yKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5ncy5maWx0ZXJDdXRvZmYgPSAodGhpcy50eXBlID09IDApID8gNiA6IDEwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnRPYmplY3RbImZpbHRlclJlc29uYW5jZSJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGxlZ2FjeVNldHRpbmdzLmZpbHRlclJlc29uYW5jZSA9IGNsYW1wKDAsIGZpbHRlclJlc29uYW5jZVJhbmdlLCBNYXRoLnJvdW5kKChmaWx0ZXJSZXNvbmFuY2VSYW5nZSAtIDEpICogKGluc3RydW1lbnRPYmplY3RbImZpbHRlclJlc29uYW5jZSJdIHwgMCkgLyAxMDApKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIGxlZ2FjeVNldHRpbmdzLmZpbHRlclJlc29uYW5jZSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5ncy5maWx0ZXJFbnZlbG9wZSA9IGdldEVudmVsb3BlKGluc3RydW1lbnRPYmplY3RbImZpbHRlckVudmVsb3BlIl0pOwogICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3MucHVsc2VFbnZlbG9wZSA9IGdldEVudmVsb3BlKGluc3RydW1lbnRPYmplY3RbInB1bHNlRW52ZWxvcGUiXSk7CiAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5ncy5mZWVkYmFja0VudmVsb3BlID0gZ2V0RW52ZWxvcGUoaW5zdHJ1bWVudE9iamVjdFsiZmVlZGJhY2tFbnZlbG9wZSJdKTsKICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGluc3RydW1lbnRPYmplY3RbIm9wZXJhdG9ycyJdKSkgewogICAgICAgICAgICAgICAgICAgIGxlZ2FjeVNldHRpbmdzLm9wZXJhdG9yRW52ZWxvcGVzID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBDb25maWcub3BlcmF0b3JDb3VudDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlbnZlbG9wZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnRPYmplY3RbIm9wZXJhdG9ycyJdW2pdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZW52ZWxvcGUgPSBnZXRFbnZlbG9wZShpbnN0cnVtZW50T2JqZWN0WyJvcGVyYXRvcnMiXVtqXVsiZW52ZWxvcGUiXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3Mub3BlcmF0b3JFbnZlbG9wZXNbal0gPSAoZW52ZWxvcGUgIT0gdW5kZWZpbmVkKSA/IGVudmVsb3BlIDogQ29uZmlnLmVudmVsb3Blcy5kaWN0aW9uYXJ5WyJub25lIl07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnRPYmplY3RbImZpbHRlciJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeVRvQ3V0b2ZmID0gWzEwLCA2LCAzLCAwLCA4LCA1LCAyXTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lUb0VudmVsb3BlID0gWyJub25lIiwgIm5vbmUiLCAibm9uZSIsICJub25lIiwgImRlY2F5IDEiLCAiZGVjYXkgMiIsICJkZWNheSAzIl07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyTmFtZXMgPSBbIm5vbmUiLCAiYnJpZ2h0IiwgIm1lZGl1bSIsICJzb2Z0IiwgImRlY2F5IGJyaWdodCIsICJkZWNheSBtZWRpdW0iLCAiZGVjYXkgc29mdCJdOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZEZpbHRlck5hbWVzID0geyAic3VzdGFpbiBzaGFycCI6IDEsICJzdXN0YWluIG1lZGl1bSI6IDIsICJzdXN0YWluIHNvZnQiOiAzLCAiZGVjYXkgc2hhcnAiOiA0IH07CiAgICAgICAgICAgICAgICAgICAgbGV0IGxlZ2FjeUZpbHRlciA9IG9sZEZpbHRlck5hbWVzW2luc3RydW1lbnRPYmplY3RbImZpbHRlciJdXSAhPSB1bmRlZmluZWQgPyBvbGRGaWx0ZXJOYW1lc1tpbnN0cnVtZW50T2JqZWN0WyJmaWx0ZXIiXV0gOiBmaWx0ZXJOYW1lcy5pbmRleE9mKGluc3RydW1lbnRPYmplY3RbImZpbHRlciJdKTsKICAgICAgICAgICAgICAgICAgICBpZiAobGVnYWN5RmlsdGVyID09IC0xKQogICAgICAgICAgICAgICAgICAgICAgICBsZWdhY3lGaWx0ZXIgPSAwOwogICAgICAgICAgICAgICAgICAgIGxlZ2FjeVNldHRpbmdzLmZpbHRlckN1dG9mZiA9IGxlZ2FjeVRvQ3V0b2ZmW2xlZ2FjeUZpbHRlcl07CiAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3MuZmlsdGVyRW52ZWxvcGUgPSBnZXRFbnZlbG9wZShsZWdhY3lUb0VudmVsb3BlW2xlZ2FjeUZpbHRlcl0pOwogICAgICAgICAgICAgICAgICAgIGxlZ2FjeVNldHRpbmdzLmZpbHRlclJlc29uYW5jZSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmNvbnZlcnRMZWdhY3lTZXR0aW5ncyhsZWdhY3lTZXR0aW5ncyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoaW5zdHJ1bWVudE9iamVjdFsiZW52ZWxvcGVzIl0pKSB7CiAgICAgICAgICAgICAgICBjb25zdCBlbnZlbG9wZUFycmF5ID0gaW5zdHJ1bWVudE9iamVjdFsiZW52ZWxvcGVzIl07CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVudmVsb3BlQXJyYXkubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5lbnZlbG9wZUNvdW50ID49IENvbmZpZy5tYXhFbnZlbG9wZUNvdW50KQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ZW1wRW52ZWxvcGUgPSBuZXcgRW52ZWxvcGVTZXR0aW5ncygpOwogICAgICAgICAgICAgICAgICAgIHRlbXBFbnZlbG9wZS5mcm9tSnNvbk9iamVjdChlbnZlbG9wZUFycmF5W2ldKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZEVudmVsb3BlKHRlbXBFbnZlbG9wZS50YXJnZXQsIHRlbXBFbnZlbG9wZS5pbmRleCwgdGVtcEVudmVsb3BlLmVudmVsb3BlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGF0aWMgZnJlcXVlbmN5RnJvbVBpdGNoKHBpdGNoKSB7CiAgICAgICAgICAgIHJldHVybiA0NDAuMCAqIE1hdGgucG93KDIuMCwgKHBpdGNoIC0gNjkuMCkgLyAxMi4wKTsKICAgICAgICB9CiAgICAgICAgc3RhdGljIGRydW1zZXRJbmRleFJlZmVyZW5jZURlbHRhKGluZGV4KSB7CiAgICAgICAgICAgIHJldHVybiBJbnN0cnVtZW50LmZyZXF1ZW5jeUZyb21QaXRjaChDb25maWcuc3BlY3RydW1CYXNlUGl0Y2ggKyBpbmRleCAqIDYpIC8gNDQxMDA7CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBfZHJ1bXNldEluZGV4VG9TcGVjdHJ1bU9jdGF2ZShpbmRleCkgewogICAgICAgICAgICByZXR1cm4gMTUgKyBNYXRoLmxvZzIoSW5zdHJ1bWVudC5kcnVtc2V0SW5kZXhSZWZlcmVuY2VEZWx0YShpbmRleCkpOwogICAgICAgIH0KICAgICAgICBhZGRFbnZlbG9wZSh0YXJnZXQsIGluZGV4LCBlbnZlbG9wZSkgewogICAgICAgICAgICBpZiAoIXRoaXMuc3VwcG9ydHNFbnZlbG9wZVRhcmdldCh0YXJnZXQsIGluZGV4KSkKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICBpZiAodGhpcy5lbnZlbG9wZUNvdW50ID49IENvbmZpZy5tYXhFbnZlbG9wZUNvdW50KQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgICAgICAgIHdoaWxlICh0aGlzLmVudmVsb3Blcy5sZW5ndGggPD0gdGhpcy5lbnZlbG9wZUNvdW50KQogICAgICAgICAgICAgICAgdGhpcy5lbnZlbG9wZXNbdGhpcy5lbnZlbG9wZXMubGVuZ3RoXSA9IG5ldyBFbnZlbG9wZVNldHRpbmdzKCk7CiAgICAgICAgICAgIGNvbnN0IGVudmVsb3BlU2V0dGluZ3MgPSB0aGlzLmVudmVsb3Blc1t0aGlzLmVudmVsb3BlQ291bnRdOwogICAgICAgICAgICBlbnZlbG9wZVNldHRpbmdzLnRhcmdldCA9IHRhcmdldDsKICAgICAgICAgICAgZW52ZWxvcGVTZXR0aW5ncy5pbmRleCA9IGluZGV4OwogICAgICAgICAgICBlbnZlbG9wZVNldHRpbmdzLmVudmVsb3BlID0gZW52ZWxvcGU7CiAgICAgICAgICAgIHRoaXMuZW52ZWxvcGVDb3VudCsrOwogICAgICAgIH0KICAgICAgICBzdXBwb3J0c0VudmVsb3BlVGFyZ2V0KHRhcmdldCwgaW5kZXgpIHsKICAgICAgICAgICAgY29uc3QgYXV0b21hdGlvblRhcmdldCA9IENvbmZpZy5pbnN0cnVtZW50QXV0b21hdGlvblRhcmdldHNbdGFyZ2V0XTsKICAgICAgICAgICAgaWYgKGluZGV4ID49IGF1dG9tYXRpb25UYXJnZXQubWF4Q291bnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXV0b21hdGlvblRhcmdldC5jb21wYXRpYmxlSW5zdHJ1bWVudHMgIT0gbnVsbCAmJiBhdXRvbWF0aW9uVGFyZ2V0LmNvbXBhdGlibGVJbnN0cnVtZW50cy5pbmRleE9mKHRoaXMudHlwZSkgPT0gLTEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXV0b21hdGlvblRhcmdldC5lZmZlY3QgIT0gbnVsbCAmJiAodGhpcy5lZmZlY3RzICYgKDEgPDwgYXV0b21hdGlvblRhcmdldC5lZmZlY3QpKSA9PSAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGF1dG9tYXRpb25UYXJnZXQuaXNGaWx0ZXIpIHsKICAgICAgICAgICAgICAgIGlmIChpbmRleCA+PSB0aGlzLm5vdGVGaWx0ZXIuY29udHJvbFBvaW50Q291bnQpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBjbGVhckludmFsaWRFbnZlbG9wZVRhcmdldHMoKSB7CiAgICAgICAgICAgIGZvciAobGV0IGVudmVsb3BlSW5kZXggPSAwOyBlbnZlbG9wZUluZGV4IDwgdGhpcy5lbnZlbG9wZUNvdW50OyBlbnZlbG9wZUluZGV4KyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuZW52ZWxvcGVzW2VudmVsb3BlSW5kZXhdLnRhcmdldDsKICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5lbnZlbG9wZXNbZW52ZWxvcGVJbmRleF0uaW5kZXg7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuc3VwcG9ydHNFbnZlbG9wZVRhcmdldCh0YXJnZXQsIGluZGV4KSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZW52ZWxvcGVzW2VudmVsb3BlSW5kZXhdLnRhcmdldCA9IENvbmZpZy5pbnN0cnVtZW50QXV0b21hdGlvblRhcmdldHMuZGljdGlvbmFyeVsibm9uZSJdLmluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMuZW52ZWxvcGVzW2VudmVsb3BlSW5kZXhdLmluZGV4ID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB3YXJtVXAoc2FtcGxlc1BlclNlY29uZCkgewogICAgICAgICAgICBpZiAodGhpcy50eXBlID09IDIpIHsKICAgICAgICAgICAgICAgIGdldERydW1XYXZlKHRoaXMuY2hpcE5vaXNlLCBpbnZlcnNlUmVhbEZvdXJpZXJUcmFuc2Zvcm0sIHNjYWxlRWxlbWVudHNCeUZhY3Rvcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy50eXBlID09IDUpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGFybW9uaWNzV2F2ZS5nZXRDdXN0b21XYXZlKHRoaXMudHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy50eXBlID09IDcpIHsKICAgICAgICAgICAgICAgIHRoaXMuaGFybW9uaWNzV2F2ZS5nZXRDdXN0b21XYXZlKHRoaXMudHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy50eXBlID09IDMpIHsKICAgICAgICAgICAgICAgIHRoaXMuc3BlY3RydW1XYXZlLmdldEN1c3RvbVdhdmUoOCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy50eXBlID09IDQpIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ29uZmlnLmRydW1Db3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kcnVtc2V0U3BlY3RydW1XYXZlc1tpXS5nZXRDdXN0b21XYXZlKEluc3RydW1lbnQuX2RydW1zZXRJbmRleFRvU3BlY3RydW1PY3RhdmUoaSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGdldERydW1XYXZlKCkgewogICAgICAgICAgICBpZiAodGhpcy50eXBlID09IDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXREcnVtV2F2ZSh0aGlzLmNoaXBOb2lzZSwgaW52ZXJzZVJlYWxGb3VyaWVyVHJhbnNmb3JtLCBzY2FsZUVsZW1lbnRzQnlGYWN0b3IpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudHlwZSA9PSAzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zcGVjdHJ1bVdhdmUuZ2V0Q3VzdG9tV2F2ZSg4KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5oYW5kbGVkIGluc3RydW1lbnQgdHlwZSBpbiBnZXREcnVtV2F2ZSIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGdldERydW1zZXRXYXZlKHBpdGNoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnR5cGUgPT0gNCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZHJ1bXNldFNwZWN0cnVtV2F2ZXNbcGl0Y2hdLmdldEN1c3RvbVdhdmUoSW5zdHJ1bWVudC5fZHJ1bXNldEluZGV4VG9TcGVjdHJ1bU9jdGF2ZShwaXRjaCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmhhbmRsZWQgaW5zdHJ1bWVudCB0eXBlIGluIGdldERydW1zZXRXYXZlIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZ2V0VHJhbnNpdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGVmZmVjdHNJbmNsdWRlVHJhbnNpdGlvbih0aGlzLmVmZmVjdHMpID8gQ29uZmlnLnRyYW5zaXRpb25zW3RoaXMudHJhbnNpdGlvbl0gOiBDb25maWcudHJhbnNpdGlvbnMuZGljdGlvbmFyeVsibm9ybWFsIl07CiAgICAgICAgfQogICAgICAgIGdldEZhZGVJblNlY29uZHMoKSB7CiAgICAgICAgICAgIHJldHVybiAodGhpcy50eXBlID09IDQpID8gMC4wIDogU3ludGguZmFkZUluU2V0dGluZ1RvU2Vjb25kcyh0aGlzLmZhZGVJbik7CiAgICAgICAgfQogICAgICAgIGdldEZhZGVPdXRUaWNrcygpIHsKICAgICAgICAgICAgcmV0dXJuICh0aGlzLnR5cGUgPT0gNCkgPyBDb25maWcuZHJ1bXNldEZhZGVPdXRUaWNrcyA6IFN5bnRoLmZhZGVPdXRTZXR0aW5nVG9UaWNrcyh0aGlzLmZhZGVPdXQpOwogICAgICAgIH0KICAgICAgICBnZXRDaG9yZCgpIHsKICAgICAgICAgICAgcmV0dXJuIGVmZmVjdHNJbmNsdWRlQ2hvcmQodGhpcy5lZmZlY3RzKSA/IENvbmZpZy5jaG9yZHNbdGhpcy5jaG9yZF0gOiBDb25maWcuY2hvcmRzLmRpY3Rpb25hcnlbInNpbXVsdGFuZW91cyJdOwogICAgICAgIH0KICAgICAgICBnZXREcnVtc2V0RW52ZWxvcGUocGl0Y2gpIHsKICAgICAgICAgICAgaWYgKHRoaXMudHlwZSAhPSA0KQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDYW4ndCBnZXREcnVtc2V0RW52ZWxvcGUoKSBmb3Igbm9uLWRydW1zZXQuIik7CiAgICAgICAgICAgIHJldHVybiBDb25maWcuZW52ZWxvcGVzW3RoaXMuZHJ1bXNldEVudmVsb3Blc1twaXRjaF1dOwogICAgICAgIH0KICAgIH0KICAgIGNsYXNzIENoYW5uZWwgewogICAgICAgIGNvbnN0cnVjdG9yKCkgewogICAgICAgICAgICB0aGlzLm9jdGF2ZSA9IDA7CiAgICAgICAgICAgIHRoaXMuaW5zdHJ1bWVudHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5wYXR0ZXJucyA9IFtdOwogICAgICAgICAgICB0aGlzLmJhcnMgPSBbXTsKICAgICAgICAgICAgdGhpcy5tdXRlZCA9IGZhbHNlOwogICAgICAgIH0KICAgIH0KICAgIGNsYXNzIFNvbmcgewogICAgICAgIGNvbnN0cnVjdG9yKHN0cmluZykgewogICAgICAgICAgICB0aGlzLmNoYW5uZWxzID0gW107CiAgICAgICAgICAgIGlmIChzdHJpbmcgIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZyb21CYXNlNjRTdHJpbmcoc3RyaW5nKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5pdFRvRGVmYXVsdCh0cnVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBnZXRDaGFubmVsQ291bnQoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBpdGNoQ2hhbm5lbENvdW50ICsgdGhpcy5ub2lzZUNoYW5uZWxDb3VudDsKICAgICAgICB9CiAgICAgICAgZ2V0TWF4SW5zdHJ1bWVudHNQZXJDaGFubmVsKCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgodGhpcy5sYXllcmVkSW5zdHJ1bWVudHMgPyBDb25maWcubGF5ZXJlZEluc3RydW1lbnRDb3VudE1heCA6IENvbmZpZy5pbnN0cnVtZW50Q291bnRNaW4sIHRoaXMucGF0dGVybkluc3RydW1lbnRzID8gQ29uZmlnLnBhdHRlcm5JbnN0cnVtZW50Q291bnRNYXggOiBDb25maWcuaW5zdHJ1bWVudENvdW50TWluKTsKICAgICAgICB9CiAgICAgICAgZ2V0TWF4SW5zdHJ1bWVudHNQZXJQYXR0ZXJuKGNoYW5uZWxJbmRleCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRNYXhJbnN0cnVtZW50c1BlclBhdHRlcm5Gb3JDaGFubmVsKHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XSk7CiAgICAgICAgfQogICAgICAgIGdldE1heEluc3RydW1lbnRzUGVyUGF0dGVybkZvckNoYW5uZWwoY2hhbm5lbCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sYXllcmVkSW5zdHJ1bWVudHMKICAgICAgICAgICAgICAgID8gTWF0aC5taW4oQ29uZmlnLmxheWVyZWRJbnN0cnVtZW50Q291bnRNYXgsIGNoYW5uZWwuaW5zdHJ1bWVudHMubGVuZ3RoKQogICAgICAgICAgICAgICAgOiAxOwogICAgICAgIH0KICAgICAgICBnZXRDaGFubmVsSXNOb2lzZShjaGFubmVsSW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIChjaGFubmVsSW5kZXggPj0gdGhpcy5waXRjaENoYW5uZWxDb3VudCk7CiAgICAgICAgfQogICAgICAgIGluaXRUb0RlZmF1bHQoYW5kUmVzZXRDaGFubmVscyA9IHRydWUpIHsKICAgICAgICAgICAgdGhpcy5zY2FsZSA9IDA7CiAgICAgICAgICAgIHRoaXMua2V5ID0gMDsKICAgICAgICAgICAgdGhpcy5sb29wU3RhcnQgPSAwOwogICAgICAgICAgICB0aGlzLmxvb3BMZW5ndGggPSA0OwogICAgICAgICAgICB0aGlzLnRlbXBvID0gMTUwOwogICAgICAgICAgICB0aGlzLmJlYXRzUGVyQmFyID0gODsKICAgICAgICAgICAgdGhpcy5iYXJDb3VudCA9IDE2OwogICAgICAgICAgICB0aGlzLnBhdHRlcm5zUGVyQ2hhbm5lbCA9IDg7CiAgICAgICAgICAgIHRoaXMucmh5dGhtID0gMTsKICAgICAgICAgICAgdGhpcy5sYXllcmVkSW5zdHJ1bWVudHMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5wYXR0ZXJuSW5zdHJ1bWVudHMgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKGFuZFJlc2V0Q2hhbm5lbHMpIHsKICAgICAgICAgICAgICAgIHRoaXMucGl0Y2hDaGFubmVsQ291bnQgPSAzOwogICAgICAgICAgICAgICAgdGhpcy5ub2lzZUNoYW5uZWxDb3VudCA9IDE7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCB0aGlzLmdldENoYW5uZWxDb3VudCgpOyBjaGFubmVsSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTm9pc2VDaGFubmVsID0gY2hhbm5lbEluZGV4ID49IHRoaXMucGl0Y2hDaGFubmVsQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hhbm5lbHMubGVuZ3RoIDw9IGNoYW5uZWxJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0gPSBuZXcgQ2hhbm5lbCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFubmVsID0gdGhpcy5jaGFubmVsc1tjaGFubmVsSW5kZXhdOwogICAgICAgICAgICAgICAgICAgIGNoYW5uZWwub2N0YXZlID0gaXNOb2lzZUNoYW5uZWwgPyAwIDogNCAtIGNoYW5uZWxJbmRleDsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBwYXR0ZXJuID0gMDsgcGF0dGVybiA8IHRoaXMucGF0dGVybnNQZXJDaGFubmVsOyBwYXR0ZXJuKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoYW5uZWwucGF0dGVybnMubGVuZ3RoIDw9IHBhdHRlcm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWwucGF0dGVybnNbcGF0dGVybl0gPSBuZXcgUGF0dGVybigpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5wYXR0ZXJuc1twYXR0ZXJuXS5yZXNldCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNoYW5uZWwucGF0dGVybnMubGVuZ3RoID0gdGhpcy5wYXR0ZXJuc1BlckNoYW5uZWw7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaW5zdHJ1bWVudCA9IDA7IGluc3RydW1lbnQgPCBDb25maWcuaW5zdHJ1bWVudENvdW50TWluOyBpbnN0cnVtZW50KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoYW5uZWwuaW5zdHJ1bWVudHMubGVuZ3RoIDw9IGluc3RydW1lbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWwuaW5zdHJ1bWVudHNbaW5zdHJ1bWVudF0gPSBuZXcgSW5zdHJ1bWVudChpc05vaXNlQ2hhbm5lbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5pbnN0cnVtZW50c1tpbnN0cnVtZW50XS5zZXRUeXBlQW5kUmVzZXQoaXNOb2lzZUNoYW5uZWwgPyAyIDogMCwgaXNOb2lzZUNoYW5uZWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjaGFubmVsLmluc3RydW1lbnRzLmxlbmd0aCA9IENvbmZpZy5pbnN0cnVtZW50Q291bnRNaW47CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgYmFyID0gMDsgYmFyIDwgdGhpcy5iYXJDb3VudDsgYmFyKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5iYXJzW2Jhcl0gPSBiYXIgPCA0ID8gMSA6IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNoYW5uZWwuYmFycy5sZW5ndGggPSB0aGlzLmJhckNvdW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5jaGFubmVscy5sZW5ndGggPSB0aGlzLmdldENoYW5uZWxDb3VudCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRvQmFzZTY0U3RyaW5nKCkgewogICAgICAgICAgICBsZXQgYml0czsKICAgICAgICAgICAgbGV0IGJ1ZmZlciA9IFtdOwogICAgICAgICAgICBidWZmZXIucHVzaChiYXNlNjRJbnRUb0NoYXJDb2RlW1NvbmcuX2xhdGVzdFZlcnNpb25dKTsKICAgICAgICAgICAgYnVmZmVyLnB1c2goMTEwLCBiYXNlNjRJbnRUb0NoYXJDb2RlW3RoaXMucGl0Y2hDaGFubmVsQ291bnRdLCBiYXNlNjRJbnRUb0NoYXJDb2RlW3RoaXMubm9pc2VDaGFubmVsQ291bnRdKTsKICAgICAgICAgICAgYnVmZmVyLnB1c2goMTE1LCBiYXNlNjRJbnRUb0NoYXJDb2RlW3RoaXMuc2NhbGVdKTsKICAgICAgICAgICAgYnVmZmVyLnB1c2goMTA3LCBiYXNlNjRJbnRUb0NoYXJDb2RlW3RoaXMua2V5XSk7CiAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDEwOCwgYmFzZTY0SW50VG9DaGFyQ29kZVt0aGlzLmxvb3BTdGFydCA+PiA2XSwgYmFzZTY0SW50VG9DaGFyQ29kZVt0aGlzLmxvb3BTdGFydCAmIDB4M2ZdKTsKICAgICAgICAgICAgYnVmZmVyLnB1c2goMTAxLCBiYXNlNjRJbnRUb0NoYXJDb2RlWyh0aGlzLmxvb3BMZW5ndGggLSAxKSA+PiA2XSwgYmFzZTY0SW50VG9DaGFyQ29kZVsodGhpcy5sb29wTGVuZ3RoIC0gMSkgJiAweDNmXSk7CiAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDExNiwgYmFzZTY0SW50VG9DaGFyQ29kZVt0aGlzLnRlbXBvID4+IDZdLCBiYXNlNjRJbnRUb0NoYXJDb2RlW3RoaXMudGVtcG8gJiA2M10pOwogICAgICAgICAgICBidWZmZXIucHVzaCg5NywgYmFzZTY0SW50VG9DaGFyQ29kZVt0aGlzLmJlYXRzUGVyQmFyIC0gMV0pOwogICAgICAgICAgICBidWZmZXIucHVzaCgxMDMsIGJhc2U2NEludFRvQ2hhckNvZGVbKHRoaXMuYmFyQ291bnQgLSAxKSA+PiA2XSwgYmFzZTY0SW50VG9DaGFyQ29kZVsodGhpcy5iYXJDb3VudCAtIDEpICYgMHgzZl0pOwogICAgICAgICAgICBidWZmZXIucHVzaCgxMDYsIGJhc2U2NEludFRvQ2hhckNvZGVbKHRoaXMucGF0dGVybnNQZXJDaGFubmVsIC0gMSkgPj4gNl0sIGJhc2U2NEludFRvQ2hhckNvZGVbKHRoaXMucGF0dGVybnNQZXJDaGFubmVsIC0gMSkgJiAweDNmXSk7CiAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDExNCwgYmFzZTY0SW50VG9DaGFyQ29kZVt0aGlzLnJoeXRobV0pOwogICAgICAgICAgICBidWZmZXIucHVzaCgxMDUsIGJhc2U2NEludFRvQ2hhckNvZGVbKHRoaXMubGF5ZXJlZEluc3RydW1lbnRzIDw8IDEpIHwgdGhpcy5wYXR0ZXJuSW5zdHJ1bWVudHNdKTsKICAgICAgICAgICAgaWYgKHRoaXMubGF5ZXJlZEluc3RydW1lbnRzIHx8IHRoaXMucGF0dGVybkluc3RydW1lbnRzKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCB0aGlzLmdldENoYW5uZWxDb3VudCgpOyBjaGFubmVsSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGJhc2U2NEludFRvQ2hhckNvZGVbdGhpcy5jaGFubmVsc1tjaGFubmVsSW5kZXhdLmluc3RydW1lbnRzLmxlbmd0aCAtIENvbmZpZy5pbnN0cnVtZW50Q291bnRNaW5dKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBidWZmZXIucHVzaCgxMTEpOwogICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCB0aGlzLnBpdGNoQ2hhbm5lbENvdW50OyBjaGFubmVsSW5kZXgrKykgewogICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goYmFzZTY0SW50VG9DaGFyQ29kZVt0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0ub2N0YXZlXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbEluZGV4ID0gMDsgY2hhbm5lbEluZGV4IDwgdGhpcy5nZXRDaGFubmVsQ291bnQoKTsgY2hhbm5lbEluZGV4KyspIHsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jaGFubmVsc1tjaGFubmVsSW5kZXhdLmluc3RydW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XS5pbnN0cnVtZW50c1tpXTsKICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCg4NCwgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LnR5cGVdKTsKICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCgxMTgsIGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC52b2x1bWVdKTsKICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCgxMTcsIGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC5wcmVzZXQgPj4gNl0sIGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC5wcmVzZXQgJiA2M10pOwogICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDEwMiwgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmVxRmlsdGVyLmNvbnRyb2xQb2ludENvdW50XSk7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBpbnN0cnVtZW50LmVxRmlsdGVyLmNvbnRyb2xQb2ludENvdW50OyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcG9pbnQgPSBpbnN0cnVtZW50LmVxRmlsdGVyLmNvbnRyb2xQb2ludHNbal07CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGJhc2U2NEludFRvQ2hhckNvZGVbcG9pbnQudHlwZV0sIGJhc2U2NEludFRvQ2hhckNvZGVbcG9pbnQuZnJlcV0sIGJhc2U2NEludFRvQ2hhckNvZGVbcG9pbnQuZ2Fpbl0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCgxMTMsIGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC5lZmZlY3RzID4+IDZdLCBiYXNlNjRJbnRUb0NoYXJDb2RlW2luc3RydW1lbnQuZWZmZWN0cyAmIDYzXSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlTm90ZUZpbHRlcihpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC5ub3RlRmlsdGVyLmNvbnRyb2xQb2ludENvdW50XSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgaW5zdHJ1bWVudC5ub3RlRmlsdGVyLmNvbnRyb2xQb2ludENvdW50OyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvaW50ID0gaW5zdHJ1bWVudC5ub3RlRmlsdGVyLmNvbnRyb2xQb2ludHNbal07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaChiYXNlNjRJbnRUb0NoYXJDb2RlW3BvaW50LnR5cGVdLCBiYXNlNjRJbnRUb0NoYXJDb2RlW3BvaW50LmZyZXFdLCBiYXNlNjRJbnRUb0NoYXJDb2RlW3BvaW50LmdhaW5dKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVUcmFuc2l0aW9uKGluc3RydW1lbnQuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LnRyYW5zaXRpb25dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlQ2hvcmQoaW5zdHJ1bWVudC5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaChiYXNlNjRJbnRUb0NoYXJDb2RlW2luc3RydW1lbnQuY2hvcmRdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlUGl0Y2hTaGlmdChpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC5waXRjaFNoaWZ0XSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZURldHVuZShpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC5kZXR1bmVdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlVmlicmF0byhpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC52aWJyYXRvXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZURpc3RvcnRpb24oaW5zdHJ1bWVudC5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaChiYXNlNjRJbnRUb0NoYXJDb2RlW2luc3RydW1lbnQuZGlzdG9ydGlvbl0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVCaXRjcnVzaGVyKGluc3RydW1lbnQuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmJpdGNydXNoZXJGcmVxXSwgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmJpdGNydXNoZXJRdWFudGl6YXRpb25dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlUGFubmluZyhpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC5wYW5dKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlQ2hvcnVzKGluc3RydW1lbnQuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmNob3J1c10pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVFY2hvKGluc3RydW1lbnQuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmVjaG9TdXN0YWluXSwgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmVjaG9EZWxheV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVSZXZlcmIoaW5zdHJ1bWVudC5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaChiYXNlNjRJbnRUb0NoYXJDb2RlW2luc3RydW1lbnQucmV2ZXJiXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50LnR5cGUgIT0gNCkgewogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCgxMDAsIGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC5mYWRlSW5dLCBiYXNlNjRJbnRUb0NoYXJDb2RlW2luc3RydW1lbnQuZmFkZU91dF0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudC50eXBlID09IDUgfHwgaW5zdHJ1bWVudC50eXBlID09IDcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goNzIpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBoYXJtb25pY3NCaXRzID0gbmV3IEJpdEZpZWxkV3JpdGVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ29uZmlnLmhhcm1vbmljc0NvbnRyb2xQb2ludHM7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFybW9uaWNzQml0cy53cml0ZShDb25maWcuaGFybW9uaWNzQ29udHJvbFBvaW50Qml0cywgaW5zdHJ1bWVudC5oYXJtb25pY3NXYXZlLmhhcm1vbmljc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaGFybW9uaWNzQml0cy5lbmNvZGVCYXNlNjQoYnVmZmVyKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudHlwZSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDExOSwgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmNoaXBXYXZlXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDEwNCwgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LnVuaXNvbl0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpbnN0cnVtZW50LnR5cGUgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCg2NSwgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmFsZ29yaXRobV0pOwogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCg3MCwgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmZlZWRiYWNrVHlwZV0pOwogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCg2NiwgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmZlZWRiYWNrQW1wbGl0dWRlXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDgxKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgbyA9IDA7IG8gPCBDb25maWcub3BlcmF0b3JDb3VudDsgbysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaChiYXNlNjRJbnRUb0NoYXJDb2RlW2luc3RydW1lbnQub3BlcmF0b3JzW29dLmZyZXF1ZW5jeV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDgwKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgbyA9IDA7IG8gPCBDb25maWcub3BlcmF0b3JDb3VudDsgbysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaChiYXNlNjRJbnRUb0NoYXJDb2RlW2luc3RydW1lbnQub3BlcmF0b3JzW29dLmFtcGxpdHVkZV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGluc3RydW1lbnQudHlwZSA9PSAyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDExOSwgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmNoaXBOb2lzZV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpbnN0cnVtZW50LnR5cGUgPT0gMykgewogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCg4Myk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwZWN0cnVtQml0cyA9IG5ldyBCaXRGaWVsZFdyaXRlcigpOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IENvbmZpZy5zcGVjdHJ1bUNvbnRyb2xQb2ludHM7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlY3RydW1CaXRzLndyaXRlKENvbmZpZy5zcGVjdHJ1bUNvbnRyb2xQb2ludEJpdHMsIGluc3RydW1lbnQuc3BlY3RydW1XYXZlLnNwZWN0cnVtW2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBzcGVjdHJ1bUJpdHMuZW5jb2RlQmFzZTY0KGJ1ZmZlcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGluc3RydW1lbnQudHlwZSA9PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDEyMik7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgQ29uZmlnLmRydW1Db3VudDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaChiYXNlNjRJbnRUb0NoYXJDb2RlW2luc3RydW1lbnQuZHJ1bXNldEVudmVsb3Blc1tqXV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDgzKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BlY3RydW1CaXRzID0gbmV3IEJpdEZpZWxkV3JpdGVyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgQ29uZmlnLmRydW1Db3VudDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IENvbmZpZy5zcGVjdHJ1bUNvbnRyb2xQb2ludHM7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWN0cnVtQml0cy53cml0ZShDb25maWcuc3BlY3RydW1Db250cm9sUG9pbnRCaXRzLCBpbnN0cnVtZW50LmRydW1zZXRTcGVjdHJ1bVdhdmVzW2pdLnNwZWN0cnVtW2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBzcGVjdHJ1bUJpdHMuZW5jb2RlQmFzZTY0KGJ1ZmZlcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGluc3RydW1lbnQudHlwZSA9PSA1KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDEwNCwgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LnVuaXNvbl0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpbnN0cnVtZW50LnR5cGUgPT0gNikgewogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaCg4NywgYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LnB1bHNlV2lkdGhdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaW5zdHJ1bWVudC50eXBlID09IDcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goMTA0LCBiYXNlNjRJbnRUb0NoYXJDb2RlW2luc3RydW1lbnQudW5pc29uXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDczLCBiYXNlNjRJbnRUb0NoYXJDb2RlW2luc3RydW1lbnQuc3RyaW5nU3VzdGFpbl0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmtub3duIGluc3RydW1lbnQgdHlwZS4iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goNjksIGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC5lbnZlbG9wZUNvdW50XSk7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgZW52ZWxvcGVJbmRleCA9IDA7IGVudmVsb3BlSW5kZXggPCBpbnN0cnVtZW50LmVudmVsb3BlQ291bnQ7IGVudmVsb3BlSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICBidWZmZXIucHVzaChiYXNlNjRJbnRUb0NoYXJDb2RlW2luc3RydW1lbnQuZW52ZWxvcGVzW2VudmVsb3BlSW5kZXhdLnRhcmdldF0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoQ29uZmlnLmluc3RydW1lbnRBdXRvbWF0aW9uVGFyZ2V0c1tpbnN0cnVtZW50LmVudmVsb3Blc1tlbnZlbG9wZUluZGV4XS50YXJnZXRdLm1heENvdW50ID4gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVmZmVyLnB1c2goYmFzZTY0SW50VG9DaGFyQ29kZVtpbnN0cnVtZW50LmVudmVsb3Blc1tlbnZlbG9wZUluZGV4XS5pbmRleF0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZmZlci5wdXNoKGJhc2U2NEludFRvQ2hhckNvZGVbaW5zdHJ1bWVudC5lbnZlbG9wZXNbZW52ZWxvcGVJbmRleF0uZW52ZWxvcGVdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnVmZmVyLnB1c2goOTgpOwogICAgICAgICAgICBiaXRzID0gbmV3IEJpdEZpZWxkV3JpdGVyKCk7CiAgICAgICAgICAgIGxldCBuZWVkZWRCaXRzID0gMDsKICAgICAgICAgICAgd2hpbGUgKCgxIDw8IG5lZWRlZEJpdHMpIDwgdGhpcy5wYXR0ZXJuc1BlckNoYW5uZWwgKyAxKQogICAgICAgICAgICAgICAgbmVlZGVkQml0cysrOwogICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCB0aGlzLmdldENoYW5uZWxDb3VudCgpOyBjaGFubmVsSW5kZXgrKykKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5iYXJDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYml0cy53cml0ZShuZWVkZWRCaXRzLCB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uYmFyc1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGJpdHMuZW5jb2RlQmFzZTY0KGJ1ZmZlcik7CiAgICAgICAgICAgIGJ1ZmZlci5wdXNoKDExMik7CiAgICAgICAgICAgIGJpdHMgPSBuZXcgQml0RmllbGRXcml0ZXIoKTsKICAgICAgICAgICAgY29uc3Qgc2hhcGVCaXRzID0gbmV3IEJpdEZpZWxkV3JpdGVyKCk7CiAgICAgICAgICAgIGNvbnN0IGJpdHNQZXJOb3RlU2l6ZSA9IFNvbmcuZ2V0TmVlZGVkQml0cyhDb25maWcubm90ZVNpemVNYXgpOwogICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCB0aGlzLmdldENoYW5uZWxDb3VudCgpOyBjaGFubmVsSW5kZXgrKykgewogICAgICAgICAgICAgICAgY29uc3QgY2hhbm5lbCA9IHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XTsKICAgICAgICAgICAgICAgIGNvbnN0IG1heEluc3RydW1lbnRzUGVyUGF0dGVybiA9IHRoaXMuZ2V0TWF4SW5zdHJ1bWVudHNQZXJQYXR0ZXJuKGNoYW5uZWxJbmRleCk7CiAgICAgICAgICAgICAgICBjb25zdCBuZWVkZWRJbnN0cnVtZW50Q291bnRCaXRzID0gU29uZy5nZXROZWVkZWRCaXRzKG1heEluc3RydW1lbnRzUGVyUGF0dGVybiAtIENvbmZpZy5pbnN0cnVtZW50Q291bnRNaW4pOwogICAgICAgICAgICAgICAgY29uc3QgbmVlZGVkSW5zdHJ1bWVudEluZGV4Qml0cyA9IFNvbmcuZ2V0TmVlZGVkQml0cyhjaGFubmVsLmluc3RydW1lbnRzLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgY29uc3QgaXNOb2lzZUNoYW5uZWwgPSB0aGlzLmdldENoYW5uZWxJc05vaXNlKGNoYW5uZWxJbmRleCk7CiAgICAgICAgICAgICAgICBjb25zdCBvY3RhdmVPZmZzZXQgPSBpc05vaXNlQ2hhbm5lbCA/IDAgOiBjaGFubmVsLm9jdGF2ZSAqIENvbmZpZy5waXRjaGVzUGVyT2N0YXZlOwogICAgICAgICAgICAgICAgbGV0IGxhc3RQaXRjaCA9IChpc05vaXNlQ2hhbm5lbCA/IDQgOiBvY3RhdmVPZmZzZXQpOwogICAgICAgICAgICAgICAgY29uc3QgcmVjZW50UGl0Y2hlcyA9IGlzTm9pc2VDaGFubmVsID8gWzQsIDYsIDcsIDIsIDMsIDgsIDAsIDEwXSA6IFswLCA3LCAxMiwgMTksIDI0LCAtNSwgLTEyXTsKICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudFNoYXBlcyA9IFtdOwogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZWNlbnRQaXRjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgcmVjZW50UGl0Y2hlc1tpXSArPSBvY3RhdmVPZmZzZXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHBhdHRlcm4gb2YgY2hhbm5lbC5wYXR0ZXJucykgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhdHRlcm5JbnN0cnVtZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50Q291bnQgPSB2YWxpZGF0ZVJhbmdlKENvbmZpZy5pbnN0cnVtZW50Q291bnRNaW4sIG1heEluc3RydW1lbnRzUGVyUGF0dGVybiwgcGF0dGVybi5pbnN0cnVtZW50cy5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICBiaXRzLndyaXRlKG5lZWRlZEluc3RydW1lbnRDb3VudEJpdHMsIGluc3RydW1lbnRDb3VudCAtIENvbmZpZy5pbnN0cnVtZW50Q291bnRNaW4pOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluc3RydW1lbnRDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRzLndyaXRlKG5lZWRlZEluc3RydW1lbnRJbmRleEJpdHMsIHBhdHRlcm4uaW5zdHJ1bWVudHNbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChwYXR0ZXJuLm5vdGVzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgYml0cy53cml0ZSgxLCAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGN1clBhcnQgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG5vdGUgb2YgcGF0dGVybi5ub3RlcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdGUuc3RhcnQgPiBjdXJQYXJ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYml0cy53cml0ZSgyLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRzLndyaXRlUGFydER1cmF0aW9uKG5vdGUuc3RhcnQgLSBjdXJQYXJ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlQml0cy5jbGVhcigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPCBub3RlLnBpdGNoZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGVCaXRzLndyaXRlKDEsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdGUucGl0Y2hlcy5sZW5ndGggPCBDb25maWcubWF4Q2hvcmRTaXplKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlQml0cy53cml0ZSgxLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlQml0cy53cml0ZVBpbkNvdW50KG5vdGUucGlucy5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlQml0cy53cml0ZShiaXRzUGVyTm90ZVNpemUsIG5vdGUucGluc1swXS5zaXplKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzaGFwZVBhcnQgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXJ0UGl0Y2ggPSBub3RlLnBpdGNoZXNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgY3VycmVudFBpdGNoID0gc3RhcnRQaXRjaDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoQmVuZHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgbm90ZS5waW5zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGluID0gbm90ZS5waW5zW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5leHRQaXRjaCA9IHN0YXJ0UGl0Y2ggKyBwaW4uaW50ZXJ2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRQaXRjaCAhPSBuZXh0UGl0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGVCaXRzLndyaXRlKDEsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaEJlbmRzLnB1c2gobmV4dFBpdGNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFBpdGNoID0gbmV4dFBpdGNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGVCaXRzLndyaXRlKDEsIDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFwZUJpdHMud3JpdGVQYXJ0RHVyYXRpb24ocGluLnRpbWUgLSBzaGFwZVBhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlUGFydCA9IHBpbi50aW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlQml0cy53cml0ZShiaXRzUGVyTm90ZVNpemUsIHBpbi5zaXplKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNoYXBlU3RyaW5nID0gU3RyaW5nLmZyb21DaGFyQ29kZS5hcHBseShudWxsLCBzaGFwZUJpdHMuZW5jb2RlQmFzZTY0KFtdKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzaGFwZUluZGV4ID0gcmVjZW50U2hhcGVzLmluZGV4T2Yoc2hhcGVTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNoYXBlSW5kZXggPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRzLndyaXRlKDIsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMuY29uY2F0KHNoYXBlQml0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRzLndyaXRlKDEsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMud3JpdGVMb25nVGFpbCgwLCAwLCBzaGFwZUluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlbnRTaGFwZXMuc3BsaWNlKHNoYXBlSW5kZXgsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjZW50U2hhcGVzLnVuc2hpZnQoc2hhcGVTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlY2VudFNoYXBlcy5sZW5ndGggPiAxMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlbnRTaGFwZXMucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhbGxQaXRjaGVzID0gbm90ZS5waXRjaGVzLmNvbmNhdChwaXRjaEJlbmRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYWxsUGl0Y2hlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoID0gYWxsUGl0Y2hlc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwaXRjaEluZGV4ID0gcmVjZW50UGl0Y2hlcy5pbmRleE9mKHBpdGNoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGl0Y2hJbmRleCA9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgaW50ZXJ2YWwgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGl0Y2hJdGVyID0gbGFzdFBpdGNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGl0Y2hJdGVyIDwgcGl0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChwaXRjaEl0ZXIgIT0gcGl0Y2gpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaEl0ZXIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVjZW50UGl0Y2hlcy5pbmRleE9mKHBpdGNoSXRlcikgPT0gLTEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludGVydmFsKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAocGl0Y2hJdGVyICE9IHBpdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl0Y2hJdGVyLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlY2VudFBpdGNoZXMuaW5kZXhPZihwaXRjaEl0ZXIpID09IC0xKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbC0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMud3JpdGUoMSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMud3JpdGVQaXRjaEludGVydmFsKGludGVydmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMud3JpdGUoMSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMud3JpdGUoMywgcGl0Y2hJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VudFBpdGNoZXMuc3BsaWNlKHBpdGNoSW5kZXgsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlbnRQaXRjaGVzLnVuc2hpZnQocGl0Y2gpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWNlbnRQaXRjaGVzLmxlbmd0aCA+IDgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VudFBpdGNoZXMucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkgPT0gbm90ZS5waXRjaGVzLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFBpdGNoID0gbm90ZS5waXRjaGVzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFBpdGNoID0gcGl0Y2g7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdGUuc3RhcnQgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdHMud3JpdGUoMSwgbm90ZS5jb250aW51ZXNMYXN0UGF0dGVybiA/IDEgOiAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1clBhcnQgPSBub3RlLmVuZDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VyUGFydCA8IHRoaXMuYmVhdHNQZXJCYXIgKiBDb25maWcucGFydHNQZXJCZWF0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRzLndyaXRlKDIsIDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYml0cy53cml0ZVBhcnREdXJhdGlvbih0aGlzLmJlYXRzUGVyQmFyICogQ29uZmlnLnBhcnRzUGVyQmVhdCAtIGN1clBhcnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBiaXRzLndyaXRlKDEsIDApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgc3RyaW5nTGVuZ3RoID0gYml0cy5sZW5ndGhCYXNlNjQoKTsKICAgICAgICAgICAgbGV0IGRpZ2l0cyA9IFtdOwogICAgICAgICAgICB3aGlsZSAoc3RyaW5nTGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgZGlnaXRzLnVuc2hpZnQoYmFzZTY0SW50VG9DaGFyQ29kZVtzdHJpbmdMZW5ndGggJiAweDNmXSk7CiAgICAgICAgICAgICAgICBzdHJpbmdMZW5ndGggPSBzdHJpbmdMZW5ndGggPj4gNjsKICAgICAgICAgICAgfQogICAgICAgICAgICBidWZmZXIucHVzaChiYXNlNjRJbnRUb0NoYXJDb2RlW2RpZ2l0cy5sZW5ndGhdKTsKICAgICAgICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkoYnVmZmVyLCBkaWdpdHMpOwogICAgICAgICAgICBiaXRzLmVuY29kZUJhc2U2NChidWZmZXIpOwogICAgICAgICAgICBjb25zdCBtYXhBcHBseUFyZ3MgPSA2NDAwMDsKICAgICAgICAgICAgaWYgKGJ1ZmZlci5sZW5ndGggPCBtYXhBcHBseUFyZ3MpIHsKICAgICAgICAgICAgICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGJ1ZmZlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gIiI7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJ1ZmZlci5sZW5ndGg7IGkgKz0gbWF4QXBwbHlBcmdzKSB7CiAgICAgICAgICAgICAgICAgICAgcmVzdWx0ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkobnVsbCwgYnVmZmVyLnNsaWNlKGksIGkgKyBtYXhBcHBseUFyZ3MpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc3RhdGljIF9lbnZlbG9wZUZyb21MZWdhY3lJbmRleChsZWdhY3lJbmRleCkgewogICAgICAgICAgICBpZiAobGVnYWN5SW5kZXggPT0gMCkKICAgICAgICAgICAgICAgIGxlZ2FjeUluZGV4ID0gMTsKICAgICAgICAgICAgZWxzZSBpZiAobGVnYWN5SW5kZXggPT0gMSkKICAgICAgICAgICAgICAgIGxlZ2FjeUluZGV4ID0gMDsKICAgICAgICAgICAgcmV0dXJuIENvbmZpZy5lbnZlbG9wZXNbY2xhbXAoMCwgQ29uZmlnLmVudmVsb3Blcy5sZW5ndGgsIGxlZ2FjeUluZGV4KV07CiAgICAgICAgfQogICAgICAgIGZyb21CYXNlNjRTdHJpbmcoY29tcHJlc3NlZCkgewogICAgICAgICAgICBpZiAoY29tcHJlc3NlZCA9PSBudWxsIHx8IGNvbXByZXNzZWQgPT0gIiIpIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5pdFRvRGVmYXVsdCh0cnVlKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgY2hhckluZGV4ID0gMDsKICAgICAgICAgICAgd2hpbGUgKGNvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgpIDw9IDMyKQogICAgICAgICAgICAgICAgY2hhckluZGV4Kys7CiAgICAgICAgICAgIGlmIChjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KSA9PSAzNSkKICAgICAgICAgICAgICAgIGNoYXJJbmRleCsrOwogICAgICAgICAgICBpZiAoY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCkgPT0gMTIzKSB7CiAgICAgICAgICAgICAgICB0aGlzLmZyb21Kc29uT2JqZWN0KEpTT04ucGFyc2UoY2hhckluZGV4ID09IDAgPyBjb21wcmVzc2VkIDogY29tcHJlc3NlZC5zdWJzdHJpbmcoY2hhckluZGV4KSkpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHZlcnNpb24gPSBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldOwogICAgICAgICAgICBpZiAodmVyc2lvbiA9PSAtMSB8fCB2ZXJzaW9uID4gU29uZy5fbGF0ZXN0VmVyc2lvbiB8fCB2ZXJzaW9uIDwgU29uZy5fb2xkZXN0VmVyc2lvbikKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgY29uc3QgYmVmb3JlVGhyZWUgPSB2ZXJzaW9uIDwgMzsKICAgICAgICAgICAgY29uc3QgYmVmb3JlRm91ciA9IHZlcnNpb24gPCA0OwogICAgICAgICAgICBjb25zdCBiZWZvcmVGaXZlID0gdmVyc2lvbiA8IDU7CiAgICAgICAgICAgIGNvbnN0IGJlZm9yZVNpeCA9IHZlcnNpb24gPCA2OwogICAgICAgICAgICBjb25zdCBiZWZvcmVTZXZlbiA9IHZlcnNpb24gPCA3OwogICAgICAgICAgICBjb25zdCBiZWZvcmVFaWdodCA9IHZlcnNpb24gPCA4OwogICAgICAgICAgICBjb25zdCBiZWZvcmVOaW5lID0gdmVyc2lvbiA8IDk7CiAgICAgICAgICAgIHRoaXMuaW5pdFRvRGVmYXVsdChiZWZvcmVOaW5lKTsKICAgICAgICAgICAgaWYgKGJlZm9yZVRocmVlKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGNoYW5uZWwgb2YgdGhpcy5jaGFubmVscykgewogICAgICAgICAgICAgICAgICAgIGNoYW5uZWwuaW5zdHJ1bWVudHNbMF0udHJhbnNpdGlvbiA9IENvbmZpZy50cmFuc2l0aW9ucy5kaWN0aW9uYXJ5WyJpbnRlcnJ1cHQiXS5pbmRleDsKICAgICAgICAgICAgICAgICAgICBjaGFubmVsLmluc3RydW1lbnRzWzBdLmVmZmVjdHMgfD0gMSA8PCAxMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuY2hhbm5lbHNbM10uaW5zdHJ1bWVudHNbMF0uY2hpcE5vaXNlID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgbGVnYWN5U2V0dGluZ3NDYWNoZSA9IG51bGw7CiAgICAgICAgICAgIGlmIChiZWZvcmVOaW5lKSB7CiAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5nc0NhY2hlID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gbGVnYWN5U2V0dGluZ3NDYWNoZS5sZW5ndGg7IGkgPCB0aGlzLmdldENoYW5uZWxDb3VudCgpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5nc0NhY2hlW2ldID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBDb25maWcuaW5zdHJ1bWVudENvdW50TWluOyBqKyspCiAgICAgICAgICAgICAgICAgICAgICAgIGxlZ2FjeVNldHRpbmdzQ2FjaGVbaV1bal0gPSB7fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgbGVnYWN5R2xvYmFsUmV2ZXJiID0gMDsKICAgICAgICAgICAgbGV0IGluc3RydW1lbnRDaGFubmVsSXRlcmF0b3IgPSAwOwogICAgICAgICAgICBsZXQgaW5zdHJ1bWVudEluZGV4SXRlcmF0b3IgPSAtMTsKICAgICAgICAgICAgbGV0IGNvbW1hbmQ7CiAgICAgICAgICAgIHdoaWxlIChjaGFySW5kZXggPCBjb21wcmVzc2VkLmxlbmd0aCkKICAgICAgICAgICAgICAgIHN3aXRjaCAoY29tbWFuZCA9IGNvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKykpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIDExMDoKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5waXRjaENoYW5uZWxDb3VudCA9IGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm5vaXNlQ2hhbm5lbENvdW50ID0gYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGl0Y2hDaGFubmVsQ291bnQgPSB2YWxpZGF0ZVJhbmdlKENvbmZpZy5waXRjaENoYW5uZWxDb3VudE1pbiwgQ29uZmlnLnBpdGNoQ2hhbm5lbENvdW50TWF4LCB0aGlzLnBpdGNoQ2hhbm5lbENvdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubm9pc2VDaGFubmVsQ291bnQgPSB2YWxpZGF0ZVJhbmdlKENvbmZpZy5ub2lzZUNoYW5uZWxDb3VudE1pbiwgQ29uZmlnLm5vaXNlQ2hhbm5lbENvdW50TWF4LCB0aGlzLm5vaXNlQ2hhbm5lbENvdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGNoYW5uZWxJbmRleCA9IHRoaXMuY2hhbm5lbHMubGVuZ3RoOyBjaGFubmVsSW5kZXggPCB0aGlzLmdldENoYW5uZWxDb3VudCgpOyBjaGFubmVsSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XSA9IG5ldyBDaGFubmVsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzLmxlbmd0aCA9IHRoaXMuZ2V0Q2hhbm5lbENvdW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlTmluZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSBsZWdhY3lTZXR0aW5nc0NhY2hlLmxlbmd0aDsgaSA8IHRoaXMuZ2V0Q2hhbm5lbENvdW50KCk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5nc0NhY2hlW2ldID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgQ29uZmlnLmluc3RydW1lbnRDb3VudE1pbjsgaisrKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3NDYWNoZVtpXVtqXSA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDExNToKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zY2FsZSA9IGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlVGhyZWUgJiYgdGhpcy5zY2FsZSA9PSAxMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNjYWxlID0gMTE7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxMDc6CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVTZXZlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMua2V5ID0gY2xhbXAoMCwgQ29uZmlnLmtleXMubGVuZ3RoLCAxMSAtIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5rZXkgPSBjbGFtcCgwLCBDb25maWcua2V5cy5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMTA4OgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlRml2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcFN0YXJ0ID0gYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcFN0YXJ0ID0gKGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0gPDwgNikgKyBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMTAxOgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlRml2ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcExlbmd0aCA9IGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb3BMZW5ndGggPSAoYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSA8PCA2KSArIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0gKyAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMTE2OgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlRm91cikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGVtcG8gPSBbOTUsIDEyMCwgMTUxLCAxOTBdW2Jhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV1dOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYmVmb3JlU2V2ZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRlbXBvID0gWzg4LCA5NSwgMTAzLCAxMTEsIDEyMCwgMTMwLCAxNDAsIDE1MSwgMTYzLCAxNzYsIDE5MCwgMjA2LCAyMjIsIDI0MCwgMjU5XVtiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGVtcG8gPSAoYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSA8PCA2KSB8IChiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGVtcG8gPSBjbGFtcChDb25maWcudGVtcG9NaW4sIENvbmZpZy50ZW1wb01heCArIDEsIHRoaXMudGVtcG8pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMTA5OgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlTmluZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZ2FjeUdsb2JhbFJldmVyYiA9IGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5R2xvYmFsUmV2ZXJiID0gY2xhbXAoMCwgNCwgbGVnYWN5R2xvYmFsUmV2ZXJiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDk3OgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlVGhyZWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJlYXRzUGVyQmFyID0gWzYsIDcsIDgsIDksIDEwXVtiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmVhdHNQZXJCYXIgPSBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldICsgMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmVhdHNQZXJCYXIgPSBNYXRoLm1heChDb25maWcuYmVhdHNQZXJCYXJNaW4sIE1hdGgubWluKENvbmZpZy5iZWF0c1BlckJhck1heCwgdGhpcy5iZWF0c1BlckJhcikpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMTAzOgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXJDb3VudCA9IChiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldIDw8IDYpICsgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJhckNvdW50ID0gdmFsaWRhdGVSYW5nZShDb25maWcuYmFyQ291bnRNaW4sIENvbmZpZy5iYXJDb3VudE1heCwgYmFyQ291bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbEluZGV4ID0gMDsgY2hhbm5lbEluZGV4IDwgdGhpcy5nZXRDaGFubmVsQ291bnQoKTsgY2hhbm5lbEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBiYXIgPSB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uYmFycy5sZW5ndGg7IGJhciA8IHRoaXMuYmFyQ291bnQ7IGJhcisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XS5iYXJzW2Jhcl0gPSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uYmFycy5sZW5ndGggPSB0aGlzLmJhckNvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMTA2OgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGF0dGVybnNQZXJDaGFubmVsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZUVpZ2h0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybnNQZXJDaGFubmVsID0gYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuc1BlckNoYW5uZWwgPSAoYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSA8PCA2KSArIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0gKyAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXR0ZXJuc1BlckNoYW5uZWwgPSB2YWxpZGF0ZVJhbmdlKDEsIENvbmZpZy5iYXJDb3VudE1heCwgcGF0dGVybnNQZXJDaGFubmVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5uZWxDb3VudCA9IHRoaXMuZ2V0Q2hhbm5lbENvdW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCBjaGFubmVsQ291bnQ7IGNoYW5uZWxJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGF0dGVybnMgPSB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0ucGF0dGVybnM7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgcGF0dGVybiA9IHBhdHRlcm5zLmxlbmd0aDsgcGF0dGVybiA8IHRoaXMucGF0dGVybnNQZXJDaGFubmVsOyBwYXR0ZXJuKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybnNbcGF0dGVybl0gPSBuZXcgUGF0dGVybigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJucy5sZW5ndGggPSB0aGlzLnBhdHRlcm5zUGVyQ2hhbm5lbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDEwNToKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZU5pbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50c1BlckNoYW5uZWwgPSB2YWxpZGF0ZVJhbmdlKENvbmZpZy5pbnN0cnVtZW50Q291bnRNaW4sIENvbmZpZy5wYXR0ZXJuSW5zdHJ1bWVudENvdW50TWF4LCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldICsgQ29uZmlnLmluc3RydW1lbnRDb3VudE1pbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXllcmVkSW5zdHJ1bWVudHMgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhdHRlcm5JbnN0cnVtZW50cyA9IChpbnN0cnVtZW50c1BlckNoYW5uZWwgPiAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCB0aGlzLmdldENoYW5uZWxDb3VudCgpOyBjaGFubmVsSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc05vaXNlQ2hhbm5lbCA9IGNoYW5uZWxJbmRleCA+PSB0aGlzLnBpdGNoQ2hhbm5lbENvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpbnN0cnVtZW50SW5kZXggPSB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uaW5zdHJ1bWVudHMubGVuZ3RoOyBpbnN0cnVtZW50SW5kZXggPCBpbnN0cnVtZW50c1BlckNoYW5uZWw7IGluc3RydW1lbnRJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uaW5zdHJ1bWVudHNbaW5zdHJ1bWVudEluZGV4XSA9IG5ldyBJbnN0cnVtZW50KGlzTm9pc2VDaGFubmVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uaW5zdHJ1bWVudHMubGVuZ3RoID0gaW5zdHJ1bWVudHNQZXJDaGFubmVsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlU2l4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpbnN0cnVtZW50SW5kZXggPSAwOyBpbnN0cnVtZW50SW5kZXggPCBpbnN0cnVtZW50c1BlckNoYW5uZWw7IGluc3RydW1lbnRJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFubmVsc1tjaGFubmVsSW5kZXhdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleF0uc2V0VHlwZUFuZFJlc2V0KGlzTm9pc2VDaGFubmVsID8gMiA6IDAsIGlzTm9pc2VDaGFubmVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gbGVnYWN5U2V0dGluZ3NDYWNoZVtjaGFubmVsSW5kZXhdLmxlbmd0aDsgaiA8IGluc3RydW1lbnRzUGVyQ2hhbm5lbDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5nc0NhY2hlW2NoYW5uZWxJbmRleF1bal0gPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnRzRmxhZ0JpdHMgPSBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGF5ZXJlZEluc3RydW1lbnRzID0gKGluc3RydW1lbnRzRmxhZ0JpdHMgJiAoMSA8PCAxKSkgIT0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhdHRlcm5JbnN0cnVtZW50cyA9IChpbnN0cnVtZW50c0ZsYWdCaXRzICYgKDEgPDwgMCkpICE9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbEluZGV4ID0gMDsgY2hhbm5lbEluZGV4IDwgdGhpcy5nZXRDaGFubmVsQ291bnQoKTsgY2hhbm5lbEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGluc3RydW1lbnRDb3VudCA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxheWVyZWRJbnN0cnVtZW50cyB8fCB0aGlzLnBhdHRlcm5JbnN0cnVtZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudENvdW50ID0gdmFsaWRhdGVSYW5nZShDb25maWcuaW5zdHJ1bWVudENvdW50TWluLCB0aGlzLmdldE1heEluc3RydW1lbnRzUGVyQ2hhbm5lbCgpLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldICsgQ29uZmlnLmluc3RydW1lbnRDb3VudE1pbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhbm5lbCA9IHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNOb2lzZUNoYW5uZWwgPSB0aGlzLmdldENoYW5uZWxJc05vaXNlKGNoYW5uZWxJbmRleCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSBjaGFubmVsLmluc3RydW1lbnRzLmxlbmd0aDsgaSA8IGluc3RydW1lbnRDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLmluc3RydW1lbnRzW2ldID0gbmV3IEluc3RydW1lbnQoaXNOb2lzZUNoYW5uZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWwuaW5zdHJ1bWVudHMubGVuZ3RoID0gaW5zdHJ1bWVudENvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDExNDoKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yaHl0aG0gPSBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMTExOgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlVGhyZWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFubmVsSW5kZXggPSBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XS5vY3RhdmUgPSBjbGFtcCgwLCBDb25maWcucGl0Y2hPY3RhdmVzLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoYW5uZWxJbmRleCA+PSB0aGlzLnBpdGNoQ2hhbm5lbENvdW50KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0ub2N0YXZlID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGJlZm9yZU5pbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCB0aGlzLmdldENoYW5uZWxDb3VudCgpOyBjaGFubmVsSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0ub2N0YXZlID0gY2xhbXAoMCwgQ29uZmlnLnBpdGNoT2N0YXZlcywgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hhbm5lbEluZGV4ID49IHRoaXMucGl0Y2hDaGFubmVsQ291bnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0ub2N0YXZlID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCB0aGlzLnBpdGNoQ2hhbm5lbENvdW50OyBjaGFubmVsSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0ub2N0YXZlID0gY2xhbXAoMCwgQ29uZmlnLnBpdGNoT2N0YXZlcywgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgODQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnRJbmRleEl0ZXJhdG9yKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudEluZGV4SXRlcmF0b3IgPj0gdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudEluZGV4SXRlcmF0b3IgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVSYW5nZSgwLCB0aGlzLmNoYW5uZWxzLmxlbmd0aCAtIDEsIGluc3RydW1lbnRDaGFubmVsSXRlcmF0b3IpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IHRoaXMuY2hhbm5lbHNbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl0uaW5zdHJ1bWVudHNbaW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudFR5cGUgPSB2YWxpZGF0ZVJhbmdlKDAsIDggLSAxLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuc2V0VHlwZUFuZFJlc2V0KGluc3RydW1lbnRUeXBlLCBpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yID49IHRoaXMucGl0Y2hDaGFubmVsQ291bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZVNldmVuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5lZmZlY3RzID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGVnYWN5R2xvYmFsUmV2ZXJiID4gMCAmJiAhdGhpcy5nZXRDaGFubmVsSXNOb2lzZShpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LnJldmVyYiA9IGxlZ2FjeUdsb2JhbFJldmVyYjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5lZmZlY3RzIHw9IDEgPDwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnQuY2hvcmQgIT0gQ29uZmlnLmNob3Jkcy5kaWN0aW9uYXJ5WyJzaW11bHRhbmVvdXMiXS5pbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmVmZmVjdHMgfD0gMSA8PCAxMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxMTc6CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHByZXNldFZhbHVlID0gKGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0gPDwgNikgfCAoYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXS5wcmVzZXQgPSBwcmVzZXRWYWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDExOToKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZVRocmVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVnYWN5V2F2ZXMgPSBbMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhbm5lbEluZGV4ID0gYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50ID0gdGhpcy5jaGFubmVsc1tjaGFubmVsSW5kZXhdLmluc3RydW1lbnRzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuY2hpcFdhdmUgPSBjbGFtcCgwLCBDb25maWcuY2hpcFdhdmVzLmxlbmd0aCwgbGVnYWN5V2F2ZXNbYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXV0gfCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmNvbnZlcnRMZWdhY3lTZXR0aW5ncyhsZWdhY3lTZXR0aW5nc0NhY2hlW2NoYW5uZWxJbmRleF1bMF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYmVmb3JlU2l4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVnYWN5V2F2ZXMgPSBbMSwgMiwgMywgNCwgNSwgNiwgNywgOCwgMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbEluZGV4ID0gMDsgY2hhbm5lbEluZGV4IDwgdGhpcy5nZXRDaGFubmVsQ291bnQoKTsgY2hhbm5lbEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBpbnN0cnVtZW50IG9mIHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XS5pbnN0cnVtZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoYW5uZWxJbmRleCA+PSB0aGlzLnBpdGNoQ2hhbm5lbENvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5jaGlwTm9pc2UgPSBjbGFtcCgwLCBDb25maWcuY2hpcE5vaXNlcy5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5jaGlwV2F2ZSA9IGNsYW1wKDAsIENvbmZpZy5jaGlwV2F2ZXMubGVuZ3RoLCBsZWdhY3lXYXZlc1tiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldXSB8IDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYmVmb3JlU2V2ZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lXYXZlcyA9IFsxLCAyLCAzLCA0LCA1LCA2LCA3LCA4LCAwXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvciA+PSB0aGlzLnBpdGNoQ2hhbm5lbENvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbm5lbHNbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl0uaW5zdHJ1bWVudHNbaW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdLmNoaXBOb2lzZSA9IGNsYW1wKDAsIENvbmZpZy5jaGlwTm9pc2VzLmxlbmd0aCwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXS5jaGlwV2F2ZSA9IGNsYW1wKDAsIENvbmZpZy5jaGlwV2F2ZXMubGVuZ3RoLCBsZWdhY3lXYXZlc1tiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldXSB8IDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yID49IHRoaXMucGl0Y2hDaGFubmVsQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl0uY2hpcE5vaXNlID0gY2xhbXAoMCwgQ29uZmlnLmNoaXBOb2lzZXMubGVuZ3RoLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbm5lbHNbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl0uaW5zdHJ1bWVudHNbaW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdLmNoaXBXYXZlID0gY2xhbXAoMCwgQ29uZmlnLmNoaXBXYXZlcy5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDEwMjoKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZU5pbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlU2V2ZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVnYWN5VG9DdXRvZmYgPSBbMTAsIDYsIDMsIDAsIDgsIDUsIDJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lUb0VudmVsb3BlID0gWyJub25lIiwgIm5vbmUiLCAibm9uZSIsICJub25lIiwgImRlY2F5IDEiLCAiZGVjYXkgMiIsICJkZWNheSAzIl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVUaHJlZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhbm5lbEluZGV4ID0gYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uaW5zdHJ1bWVudHNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lTZXR0aW5ncyA9IGxlZ2FjeVNldHRpbmdzQ2FjaGVbY2hhbm5lbEluZGV4XVswXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeUZpbHRlciA9IFsxLCAzLCA0LCA1XVtjbGFtcCgwLCBsZWdhY3lUb0N1dG9mZi5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZ2FjeVNldHRpbmdzLmZpbHRlckN1dG9mZiA9IGxlZ2FjeVRvQ3V0b2ZmW2xlZ2FjeUZpbHRlcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5ncy5maWx0ZXJSZXNvbmFuY2UgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3MuZmlsdGVyRW52ZWxvcGUgPSBDb25maWcuZW52ZWxvcGVzLmRpY3Rpb25hcnlbbGVnYWN5VG9FbnZlbG9wZVtsZWdhY3lGaWx0ZXJdXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuY29udmVydExlZ2FjeVNldHRpbmdzKGxlZ2FjeVNldHRpbmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiZWZvcmVTaXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGNoYW5uZWxJbmRleCA9IDA7IGNoYW5uZWxJbmRleCA8IHRoaXMuZ2V0Q2hhbm5lbENvdW50KCk7IGNoYW5uZWxJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uaW5zdHJ1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XS5pbnN0cnVtZW50c1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVnYWN5U2V0dGluZ3MgPSBsZWdhY3lTZXR0aW5nc0NhY2hlW2NoYW5uZWxJbmRleF1baV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeUZpbHRlciA9IGNsYW1wKDAsIGxlZ2FjeVRvQ3V0b2ZmLmxlbmd0aCwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hhbm5lbEluZGV4IDwgdGhpcy5waXRjaENoYW5uZWxDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3MuZmlsdGVyQ3V0b2ZmID0gbGVnYWN5VG9DdXRvZmZbbGVnYWN5RmlsdGVyXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZ2FjeVNldHRpbmdzLmZpbHRlclJlc29uYW5jZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5ncy5maWx0ZXJFbnZlbG9wZSA9IENvbmZpZy5lbnZlbG9wZXMuZGljdGlvbmFyeVtsZWdhY3lUb0VudmVsb3BlW2xlZ2FjeUZpbHRlcl1dOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3MuZmlsdGVyQ3V0b2ZmID0gMTA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5ncy5maWx0ZXJSZXNvbmFuY2UgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3MuZmlsdGVyRW52ZWxvcGUgPSBDb25maWcuZW52ZWxvcGVzLmRpY3Rpb25hcnlbIm5vbmUiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmNvbnZlcnRMZWdhY3lTZXR0aW5ncyhsZWdhY3lTZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVnYWN5RmlsdGVyID0gY2xhbXAoMCwgbGVnYWN5VG9DdXRvZmYubGVuZ3RoLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeVNldHRpbmdzID0gbGVnYWN5U2V0dGluZ3NDYWNoZVtpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXVtpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5ncy5maWx0ZXJDdXRvZmYgPSBsZWdhY3lUb0N1dG9mZltsZWdhY3lGaWx0ZXJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3MuZmlsdGVyUmVzb25hbmNlID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuY29udmVydExlZ2FjeVNldHRpbmdzKGxlZ2FjeVNldHRpbmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyQ3V0b2ZmUmFuZ2UgPSAxMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IHRoaXMuY2hhbm5lbHNbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl0uaW5zdHJ1bWVudHNbaW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lTZXR0aW5ncyA9IGxlZ2FjeVNldHRpbmdzQ2FjaGVbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl1baW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5ncy5maWx0ZXJDdXRvZmYgPSBjbGFtcCgwLCBmaWx0ZXJDdXRvZmZSYW5nZSwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuY29udmVydExlZ2FjeVNldHRpbmdzKGxlZ2FjeVNldHRpbmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50ID0gdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxDb250cm9sUG9pbnRDb3VudCA9IGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5lcUZpbHRlci5jb250cm9sUG9pbnRDb3VudCA9IGNsYW1wKDAsIENvbmZpZy5maWx0ZXJNYXhQb2ludHMgKyAxLCBvcmlnaW5hbENvbnRyb2xQb2ludENvdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gaW5zdHJ1bWVudC5lcUZpbHRlci5jb250cm9sUG9pbnRzLmxlbmd0aDsgaSA8IGluc3RydW1lbnQuZXFGaWx0ZXIuY29udHJvbFBvaW50Q291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmVxRmlsdGVyLmNvbnRyb2xQb2ludHNbaV0gPSBuZXcgRmlsdGVyQ29udHJvbFBvaW50KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5zdHJ1bWVudC5lcUZpbHRlci5jb250cm9sUG9pbnRDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvaW50ID0gaW5zdHJ1bWVudC5lcUZpbHRlci5jb250cm9sUG9pbnRzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2ludC50eXBlID0gY2xhbXAoMCwgMywgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50LmZyZXEgPSBjbGFtcCgwLCBDb25maWcuZmlsdGVyRnJlcVJhbmdlLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnQuZ2FpbiA9IGNsYW1wKDAsIENvbmZpZy5maWx0ZXJHYWluUmFuZ2UsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gaW5zdHJ1bWVudC5lcUZpbHRlci5jb250cm9sUG9pbnRDb3VudDsgaSA8IG9yaWdpbmFsQ29udHJvbFBvaW50Q291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFySW5kZXggKz0gMzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxMjE6CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVOaW5lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyUmVzb25hbmNlUmFuZ2UgPSA4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lTZXR0aW5ncyA9IGxlZ2FjeVNldHRpbmdzQ2FjaGVbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl1baW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZ2FjeVNldHRpbmdzLmZpbHRlclJlc29uYW5jZSA9IGNsYW1wKDAsIGZpbHRlclJlc29uYW5jZVJhbmdlLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmNvbnZlcnRMZWdhY3lTZXR0aW5ncyhsZWdhY3lTZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxMjI6CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVOaW5lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudHlwZSA9PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ29uZmlnLmRydW1Db3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmRydW1zZXRFbnZlbG9wZXNbaV0gPSBTb25nLl9lbnZlbG9wZUZyb21MZWdhY3lJbmRleChiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKS5pbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVnYWN5U2V0dGluZ3MgPSBsZWdhY3lTZXR0aW5nc0NhY2hlW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3MuZmlsdGVyRW52ZWxvcGUgPSBTb25nLl9lbnZlbG9wZUZyb21MZWdhY3lJbmRleChiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5jb252ZXJ0TGVnYWN5U2V0dGluZ3MobGVnYWN5U2V0dGluZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ29uZmlnLmRydW1Db3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuZHJ1bXNldEVudmVsb3Blc1tpXSA9IGNsYW1wKDAsIENvbmZpZy5lbnZlbG9wZXMubGVuZ3RoLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSA4NzoKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IHRoaXMuY2hhbm5lbHNbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl0uaW5zdHJ1bWVudHNbaW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5wdWxzZVdpZHRoID0gY2xhbXAoMCwgQ29uZmlnLnB1bHNlV2lkdGhSYW5nZSwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlTmluZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeVNldHRpbmdzID0gbGVnYWN5U2V0dGluZ3NDYWNoZVtpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXVtpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3MucHVsc2VFbnZlbG9wZSA9IFNvbmcuX2VudmVsb3BlRnJvbUxlZ2FjeUluZGV4KGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuY29udmVydExlZ2FjeVNldHRpbmdzKGxlZ2FjeVNldHRpbmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDczOgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50ID0gdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LnN0cmluZ1N1c3RhaW4gPSBjbGFtcCgwLCBDb25maWcuc3RyaW5nU3VzdGFpblJhbmdlLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDEwMDoKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZU5pbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lTZXR0aW5ncyA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB0cmFuc2l0aW9uOiAiaW50ZXJydXB0IiwgZmFkZUluU2Vjb25kczogMC4wLCBmYWRlT3V0VGlja3M6IC0xIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgdHJhbnNpdGlvbjogIm5vcm1hbCIsIGZhZGVJblNlY29uZHM6IDAuMCwgZmFkZU91dFRpY2tzOiAtMyB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHRyYW5zaXRpb246ICJub3JtYWwiLCBmYWRlSW5TZWNvbmRzOiAwLjAyNSwgZmFkZU91dFRpY2tzOiAtMyB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHRyYW5zaXRpb246ICJzbGlkZSBpbiBwYXR0ZXJuIiwgZmFkZUluU2Vjb25kczogMC4wMjUsIGZhZGVPdXRUaWNrczogLTMgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB0cmFuc2l0aW9uOiAibm9ybWFsIiwgZmFkZUluU2Vjb25kczogMC4wNCwgZmFkZU91dFRpY2tzOiA2IH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsgdHJhbnNpdGlvbjogIm5vcm1hbCIsIGZhZGVJblNlY29uZHM6IDAuMCwgZmFkZU91dFRpY2tzOiA0OCB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB7IHRyYW5zaXRpb246ICJub3JtYWwiLCBmYWRlSW5TZWNvbmRzOiAwLjAxMjUsIGZhZGVPdXRUaWNrczogNzIgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB0cmFuc2l0aW9uOiAibm9ybWFsIiwgZmFkZUluU2Vjb25kczogMC4wNiwgZmFkZU91dFRpY2tzOiA5NiB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZVRocmVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5uZWxJbmRleCA9IGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNldHRpbmdzID0gbGVnYWN5U2V0dGluZ3NbY2xhbXAoMCwgbGVnYWN5U2V0dGluZ3MubGVuZ3RoLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uaW5zdHJ1bWVudHNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuZmFkZUluID0gU3ludGguc2Vjb25kc1RvRmFkZUluU2V0dGluZyhzZXR0aW5ncy5mYWRlSW5TZWNvbmRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5mYWRlT3V0ID0gU3ludGgudGlja3NUb0ZhZGVPdXRTZXR0aW5nKHNldHRpbmdzLmZhZGVPdXRUaWNrcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQudHJhbnNpdGlvbiA9IENvbmZpZy50cmFuc2l0aW9ucy5kaWN0aW9uYXJ5W3NldHRpbmdzLnRyYW5zaXRpb25dLmluZGV4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudC50cmFuc2l0aW9uICE9IENvbmZpZy50cmFuc2l0aW9ucy5kaWN0aW9uYXJ5WyJub3JtYWwiXS5pbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5lZmZlY3RzIHw9IDEgPDwgMTA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYmVmb3JlU2l4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGNoYW5uZWxJbmRleCA9IDA7IGNoYW5uZWxJbmRleCA8IHRoaXMuZ2V0Q2hhbm5lbENvdW50KCk7IGNoYW5uZWxJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGluc3RydW1lbnQgb2YgdGhpcy5jaGFubmVsc1tjaGFubmVsSW5kZXhdLmluc3RydW1lbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSBsZWdhY3lTZXR0aW5nc1tjbGFtcCgwLCBsZWdhY3lTZXR0aW5ncy5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmZhZGVJbiA9IFN5bnRoLnNlY29uZHNUb0ZhZGVJblNldHRpbmcoc2V0dGluZ3MuZmFkZUluU2Vjb25kcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5mYWRlT3V0ID0gU3ludGgudGlja3NUb0ZhZGVPdXRTZXR0aW5nKHNldHRpbmdzLmZhZGVPdXRUaWNrcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC50cmFuc2l0aW9uID0gQ29uZmlnLnRyYW5zaXRpb25zLmRpY3Rpb25hcnlbc2V0dGluZ3MudHJhbnNpdGlvbl0uaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudHJhbnNpdGlvbiAhPSBDb25maWcudHJhbnNpdGlvbnMuZGljdGlvbmFyeVsibm9ybWFsIl0uaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5lZmZlY3RzIHw9IDEgPDwgMTA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzZXR0aW5ncyA9IGxlZ2FjeVNldHRpbmdzW2NsYW1wKDAsIGxlZ2FjeVNldHRpbmdzLmxlbmd0aCwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50ID0gdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuZmFkZUluID0gU3ludGguc2Vjb25kc1RvRmFkZUluU2V0dGluZyhzZXR0aW5ncy5mYWRlSW5TZWNvbmRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5mYWRlT3V0ID0gU3ludGgudGlja3NUb0ZhZGVPdXRTZXR0aW5nKHNldHRpbmdzLmZhZGVPdXRUaWNrcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQudHJhbnNpdGlvbiA9IENvbmZpZy50cmFuc2l0aW9ucy5kaWN0aW9uYXJ5W3NldHRpbmdzLnRyYW5zaXRpb25dLmluZGV4OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudC50cmFuc2l0aW9uICE9IENvbmZpZy50cmFuc2l0aW9ucy5kaWN0aW9uYXJ5WyJub3JtYWwiXS5pbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5lZmZlY3RzIHw9IDEgPDwgMTA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50ID0gdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5mYWRlSW4gPSBjbGFtcCgwLCBDb25maWcuZmFkZUluUmFuZ2UsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuZmFkZU91dCA9IGNsYW1wKDAsIENvbmZpZy5mYWRlT3V0VGlja3MubGVuZ3RoLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDk5OgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlTmluZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVTZXZlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlVGhyZWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeUVmZmVjdHMgPSBbMCwgMywgMiwgMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lFbnZlbG9wZXMgPSBbIm5vbmUiLCAibm9uZSIsICJub25lIiwgInRyZW1vbG8yIl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFubmVsSW5kZXggPSBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWZmZWN0ID0gY2xhbXAoMCwgbGVnYWN5RWZmZWN0cy5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XS5pbnN0cnVtZW50c1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeVNldHRpbmdzID0gbGVnYWN5U2V0dGluZ3NDYWNoZVtjaGFubmVsSW5kZXhdWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC52aWJyYXRvID0gbGVnYWN5RWZmZWN0c1tlZmZlY3RdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxlZ2FjeVNldHRpbmdzLmZpbHRlckVudmVsb3BlID09IHVuZGVmaW5lZCB8fCBsZWdhY3lTZXR0aW5ncy5maWx0ZXJFbnZlbG9wZS50eXBlID09IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5ncy5maWx0ZXJFbnZlbG9wZSA9IENvbmZpZy5lbnZlbG9wZXMuZGljdGlvbmFyeVtsZWdhY3lFbnZlbG9wZXNbZWZmZWN0XV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5jb252ZXJ0TGVnYWN5U2V0dGluZ3MobGVnYWN5U2V0dGluZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudmlicmF0byAhPSBDb25maWcudmlicmF0b3MuZGljdGlvbmFyeVsibm9uZSJdLmluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5lZmZlY3RzIHw9IDEgPDwgOTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiZWZvcmVTaXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeUVmZmVjdHMgPSBbMCwgMSwgMiwgMywgMCwgMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lFbnZlbG9wZXMgPSBbIm5vbmUiLCAibm9uZSIsICJub25lIiwgIm5vbmUiLCAidHJlbW9sbzUiLCAidHJlbW9sbzIiXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGNoYW5uZWxJbmRleCA9IDA7IGNoYW5uZWxJbmRleCA8IHRoaXMuZ2V0Q2hhbm5lbENvdW50KCk7IGNoYW5uZWxJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uaW5zdHJ1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWZmZWN0ID0gY2xhbXAoMCwgbGVnYWN5RWZmZWN0cy5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50ID0gdGhpcy5jaGFubmVsc1tjaGFubmVsSW5kZXhdLmluc3RydW1lbnRzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lTZXR0aW5ncyA9IGxlZ2FjeVNldHRpbmdzQ2FjaGVbY2hhbm5lbEluZGV4XVtpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC52aWJyYXRvID0gbGVnYWN5RWZmZWN0c1tlZmZlY3RdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGVnYWN5U2V0dGluZ3MuZmlsdGVyRW52ZWxvcGUgPT0gdW5kZWZpbmVkIHx8IGxlZ2FjeVNldHRpbmdzLmZpbHRlckVudmVsb3BlLnR5cGUgPT0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3MuZmlsdGVyRW52ZWxvcGUgPSBDb25maWcuZW52ZWxvcGVzLmRpY3Rpb25hcnlbbGVnYWN5RW52ZWxvcGVzW2VmZmVjdF1dOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5jb252ZXJ0TGVnYWN5U2V0dGluZ3MobGVnYWN5U2V0dGluZ3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50LnZpYnJhdG8gIT0gQ29uZmlnLnZpYnJhdG9zLmRpY3Rpb25hcnlbIm5vbmUiXS5pbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5lZmZlY3RzIHw9IDEgPDwgOTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGVnYWN5R2xvYmFsUmV2ZXJiICE9IDAgJiYgIXRoaXMuZ2V0Q2hhbm5lbElzTm9pc2UoY2hhbm5lbEluZGV4KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5lZmZlY3RzIHw9IDEgPDwgMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQucmV2ZXJiID0gbGVnYWN5R2xvYmFsUmV2ZXJiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVnYWN5RWZmZWN0cyA9IFswLCAxLCAyLCAzLCAwLCAwXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlZ2FjeUVudmVsb3BlcyA9IFsibm9uZSIsICJub25lIiwgIm5vbmUiLCAibm9uZSIsICJ0cmVtb2xvNSIsICJ0cmVtb2xvMiJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZWZmZWN0ID0gY2xhbXAoMCwgbGVnYWN5RWZmZWN0cy5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IHRoaXMuY2hhbm5lbHNbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl0uaW5zdHJ1bWVudHNbaW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVnYWN5U2V0dGluZ3MgPSBsZWdhY3lTZXR0aW5nc0NhY2hlW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQudmlicmF0byA9IGxlZ2FjeUVmZmVjdHNbZWZmZWN0XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsZWdhY3lTZXR0aW5ncy5maWx0ZXJFbnZlbG9wZSA9PSB1bmRlZmluZWQgfHwgbGVnYWN5U2V0dGluZ3MuZmlsdGVyRW52ZWxvcGUudHlwZSA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVnYWN5U2V0dGluZ3MuZmlsdGVyRW52ZWxvcGUgPSBDb25maWcuZW52ZWxvcGVzLmRpY3Rpb25hcnlbbGVnYWN5RW52ZWxvcGVzW2VmZmVjdF1dOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuY29udmVydExlZ2FjeVNldHRpbmdzKGxlZ2FjeVNldHRpbmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50LnZpYnJhdG8gIT0gQ29uZmlnLnZpYnJhdG9zLmRpY3Rpb25hcnlbIm5vbmUiXS5pbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuZWZmZWN0cyB8PSAxIDw8IDk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGVnYWN5R2xvYmFsUmV2ZXJiICE9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmVmZmVjdHMgfD0gMSA8PCAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQucmV2ZXJiID0gbGVnYWN5R2xvYmFsUmV2ZXJiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50ID0gdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHZpYnJhdG8gPSBjbGFtcCgwLCBDb25maWcudmlicmF0b3MubGVuZ3RoLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC52aWJyYXRvID0gdmlicmF0bzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudmlicmF0byAhPSBDb25maWcudmlicmF0b3MuZGljdGlvbmFyeVsibm9uZSJdLmluZGV4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmVmZmVjdHMgfD0gMSA8PCA5OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMTA0OgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlVGhyZWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFubmVsSW5kZXggPSBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XS5pbnN0cnVtZW50c1swXS51bmlzb24gPSBjbGFtcCgwLCBDb25maWcudW5pc29ucy5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYmVmb3JlU2l4KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbEluZGV4ID0gMDsgY2hhbm5lbEluZGV4IDwgdGhpcy5nZXRDaGFubmVsQ291bnQoKTsgY2hhbm5lbEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBpbnN0cnVtZW50IG9mIHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XS5pbnN0cnVtZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxWYWx1ZSA9IGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgdW5pc29uID0gY2xhbXAoMCwgQ29uZmlnLnVuaXNvbnMubGVuZ3RoLCBvcmlnaW5hbFZhbHVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbFZhbHVlID09IDgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmlzb24gPSAyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuY2hvcmQgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC51bmlzb24gPSB1bmlzb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiZWZvcmVTZXZlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsVmFsdWUgPSBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCB1bmlzb24gPSBjbGFtcCgwLCBDb25maWcudW5pc29ucy5sZW5ndGgsIG9yaWdpbmFsVmFsdWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcmlnaW5hbFZhbHVlID09IDgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5pc29uID0gMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl0uY2hvcmQgPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXS51bmlzb24gPSB1bmlzb247CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXS51bmlzb24gPSBjbGFtcCgwLCBDb25maWcudW5pc29ucy5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgNjc6CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVOaW5lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IHRoaXMuY2hhbm5lbHNbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl0uaW5zdHJ1bWVudHNbaW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuY2hvcmQgPSBjbGFtcCgwLCBDb25maWcuY2hvcmRzLmxlbmd0aCwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnQuY2hvcmQgIT0gQ29uZmlnLmNob3Jkcy5kaWN0aW9uYXJ5WyJzaW11bHRhbmVvdXMiXS5pbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmVmZmVjdHMgfD0gMSA8PCAxMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxMTM6CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVOaW5lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5lZmZlY3RzID0gKGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0gJiAoKDEgPDwgMTIpIC0gMSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChsZWdhY3lHbG9iYWxSZXZlcmIgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmVmZmVjdHMgJj0gfigxIDw8IDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChlZmZlY3RzSW5jbHVkZVJldmVyYihpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQucmV2ZXJiID0gbGVnYWN5R2xvYmFsUmV2ZXJiOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudC5wYW4gIT0gQ29uZmlnLnBhbkNlbnRlcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmVmZmVjdHMgfD0gMSA8PCAyOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudC52aWJyYXRvICE9IENvbmZpZy52aWJyYXRvcy5kaWN0aW9uYXJ5WyJub25lIl0uaW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5lZmZlY3RzIHw9IDEgPDwgMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVnYWN5U2V0dGluZ3MgPSBsZWdhY3lTZXR0aW5nc0NhY2hlW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmNvbnZlcnRMZWdhY3lTZXR0aW5ncyhsZWdhY3lTZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmVmZmVjdHMgPSAoYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSA8PCA2KSB8IChiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVOb3RlRmlsdGVyKGluc3RydW1lbnQuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxDb250cm9sUG9pbnRDb3VudCA9IGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQubm90ZUZpbHRlci5jb250cm9sUG9pbnRDb3VudCA9IGNsYW1wKDAsIENvbmZpZy5maWx0ZXJNYXhQb2ludHMgKyAxLCBvcmlnaW5hbENvbnRyb2xQb2ludENvdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IGluc3RydW1lbnQubm90ZUZpbHRlci5jb250cm9sUG9pbnRzLmxlbmd0aDsgaSA8IGluc3RydW1lbnQubm90ZUZpbHRlci5jb250cm9sUG9pbnRDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50Lm5vdGVGaWx0ZXIuY29udHJvbFBvaW50c1tpXSA9IG5ldyBGaWx0ZXJDb250cm9sUG9pbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluc3RydW1lbnQubm90ZUZpbHRlci5jb250cm9sUG9pbnRDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb2ludCA9IGluc3RydW1lbnQubm90ZUZpbHRlci5jb250cm9sUG9pbnRzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnQudHlwZSA9IGNsYW1wKDAsIDMsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnQuZnJlcSA9IGNsYW1wKDAsIENvbmZpZy5maWx0ZXJGcmVxUmFuZ2UsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnQuZ2FpbiA9IGNsYW1wKDAsIENvbmZpZy5maWx0ZXJHYWluUmFuZ2UsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSBpbnN0cnVtZW50Lm5vdGVGaWx0ZXIuY29udHJvbFBvaW50Q291bnQ7IGkgPCBvcmlnaW5hbENvbnRyb2xQb2ludENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJJbmRleCArPSAzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZVRyYW5zaXRpb24oaW5zdHJ1bWVudC5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LnRyYW5zaXRpb24gPSBjbGFtcCgwLCBDb25maWcudHJhbnNpdGlvbnMubGVuZ3RoLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlQ2hvcmQoaW5zdHJ1bWVudC5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmNob3JkID0gY2xhbXAoMCwgQ29uZmlnLmNob3Jkcy5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVQaXRjaFNoaWZ0KGluc3RydW1lbnQuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5waXRjaFNoaWZ0ID0gY2xhbXAoMCwgQ29uZmlnLnBpdGNoU2hpZnRSYW5nZSwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZURldHVuZShpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuZGV0dW5lID0gY2xhbXAoMCwgQ29uZmlnLmRldHVuZU1heCArIDEsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVWaWJyYXRvKGluc3RydW1lbnQuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC52aWJyYXRvID0gY2xhbXAoMCwgQ29uZmlnLnZpYnJhdG9zLmxlbmd0aCwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZURpc3RvcnRpb24oaW5zdHJ1bWVudC5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmRpc3RvcnRpb24gPSBjbGFtcCgwLCBDb25maWcuZGlzdG9ydGlvblJhbmdlLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlQml0Y3J1c2hlcihpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuYml0Y3J1c2hlckZyZXEgPSBjbGFtcCgwLCBDb25maWcuYml0Y3J1c2hlckZyZXFSYW5nZSwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuYml0Y3J1c2hlclF1YW50aXphdGlvbiA9IGNsYW1wKDAsIENvbmZpZy5iaXRjcnVzaGVyUXVhbnRpemF0aW9uUmFuZ2UsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVQYW5uaW5nKGluc3RydW1lbnQuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5wYW4gPSBjbGFtcCgwLCBDb25maWcucGFuTWF4ICsgMSwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZUNob3J1cyhpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuY2hvcnVzID0gY2xhbXAoMCwgQ29uZmlnLmNob3J1c1JhbmdlLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlRWNobyhpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuZWNob1N1c3RhaW4gPSBjbGFtcCgwLCBDb25maWcuZWNob1N1c3RhaW5SYW5nZSwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuZWNob0RlbGF5ID0gY2xhbXAoMCwgQ29uZmlnLmVjaG9EZWxheVJhbmdlLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlUmV2ZXJiKGluc3RydW1lbnQuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5yZXZlcmIgPSBjbGFtcCgwLCBDb25maWcucmV2ZXJiUmFuZ2UsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuZWZmZWN0cyAmPSAoMSA8PCAxMikgLSAxOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMTE4OgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlVGhyZWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFubmVsSW5kZXggPSBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uaW5zdHJ1bWVudHNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC52b2x1bWUgPSBjbGFtcCgwLCBDb25maWcudm9sdW1lUmFuZ2UsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50LnZvbHVtZSA9PSA1KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LnZvbHVtZSA9IENvbmZpZy52b2x1bWVSYW5nZSAtIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiZWZvcmVTaXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCB0aGlzLmdldENoYW5uZWxDb3VudCgpOyBjaGFubmVsSW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGluc3RydW1lbnQgb2YgdGhpcy5jaGFubmVsc1tjaGFubmVsSW5kZXhdLmluc3RydW1lbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LnZvbHVtZSA9IGNsYW1wKDAsIENvbmZpZy52b2x1bWVSYW5nZSwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudC52b2x1bWUgPT0gNSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LnZvbHVtZSA9IENvbmZpZy52b2x1bWVSYW5nZSAtIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiZWZvcmVTZXZlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LnZvbHVtZSA9IGNsYW1wKDAsIENvbmZpZy52b2x1bWVSYW5nZSwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudm9sdW1lID09IDUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQudm9sdW1lID0gQ29uZmlnLnZvbHVtZVJhbmdlIC0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LnZvbHVtZSA9IGNsYW1wKDAsIENvbmZpZy52b2x1bWVSYW5nZSwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSA3NjoKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZU5pbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50ID0gdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5wYW4gPSBjbGFtcCgwLCBDb25maWcucGFuTWF4ICsgMSwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSA2NToKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IHRoaXMuY2hhbm5lbHNbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl0uaW5zdHJ1bWVudHNbaW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5hbGdvcml0aG0gPSBjbGFtcCgwLCBDb25maWcuYWxnb3JpdGhtcy5sZW5ndGgsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZU5pbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lTZXR0aW5ncyA9IGxlZ2FjeVNldHRpbmdzQ2FjaGVbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl1baW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuY29udmVydExlZ2FjeVNldHRpbmdzKGxlZ2FjeVNldHRpbmdzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDcwOgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXS5mZWVkYmFja1R5cGUgPSBjbGFtcCgwLCBDb25maWcuZmVlZGJhY2tzLmxlbmd0aCwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSA2NjoKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl0uZmVlZGJhY2tBbXBsaXR1ZGUgPSBjbGFtcCgwLCBDb25maWcub3BlcmF0b3JBbXBsaXR1ZGVNYXggKyAxLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDg2OgogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlTmluZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsZWdhY3lTZXR0aW5ncyA9IGxlZ2FjeVNldHRpbmdzQ2FjaGVbaW5zdHJ1bWVudENoYW5uZWxJdGVyYXRvcl1baW5zdHJ1bWVudEluZGV4SXRlcmF0b3JdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlZ2FjeVNldHRpbmdzLmZlZWRiYWNrRW52ZWxvcGUgPSBTb25nLl9lbnZlbG9wZUZyb21MZWdhY3lJbmRleChiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmNvbnZlcnRMZWdhY3lTZXR0aW5ncyhsZWdhY3lTZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSA4MToKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgbyA9IDA7IG8gPCBDb25maWcub3BlcmF0b3JDb3VudDsgbysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl0ub3BlcmF0b3JzW29dLmZyZXF1ZW5jeSA9IGNsYW1wKDAsIENvbmZpZy5vcGVyYXRvckZyZXF1ZW5jaWVzLmxlbmd0aCwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSA4MDoKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgbyA9IDA7IG8gPCBDb25maWcub3BlcmF0b3JDb3VudDsgbysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGFubmVsc1tpbnN0cnVtZW50Q2hhbm5lbEl0ZXJhdG9yXS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhJdGVyYXRvcl0ub3BlcmF0b3JzW29dLmFtcGxpdHVkZSA9IGNsYW1wKDAsIENvbmZpZy5vcGVyYXRvckFtcGxpdHVkZU1heCArIDEsIGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgNjk6CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVOaW5lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGVnYWN5U2V0dGluZ3MgPSBsZWdhY3lTZXR0aW5nc0NhY2hlW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5ncy5vcGVyYXRvckVudmVsb3BlcyA9IFtdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IG8gPSAwOyBvIDwgQ29uZmlnLm9wZXJhdG9yQ291bnQ7IG8rKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWdhY3lTZXR0aW5ncy5vcGVyYXRvckVudmVsb3Blc1tvXSA9IFNvbmcuX2VudmVsb3BlRnJvbUxlZ2FjeUluZGV4KGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmNvbnZlcnRMZWdhY3lTZXR0aW5ncyhsZWdhY3lTZXR0aW5ncyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbnZlbG9wZUNvdW50ID0gY2xhbXAoMCwgQ29uZmlnLm1heEVudmVsb3BlQ291bnQgKyAxLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVudmVsb3BlQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBjbGFtcCgwLCBDb25maWcuaW5zdHJ1bWVudEF1dG9tYXRpb25UYXJnZXRzLmxlbmd0aCwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbmRleCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1heENvdW50ID0gQ29uZmlnLmluc3RydW1lbnRBdXRvbWF0aW9uVGFyZ2V0c1t0YXJnZXRdLm1heENvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF4Q291bnQgPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCA9IGNsYW1wKDAsIG1heENvdW50LCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbnZlbG9wZSA9IGNsYW1wKDAsIENvbmZpZy5lbnZlbG9wZXMubGVuZ3RoLCBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5hZGRFbnZlbG9wZSh0YXJnZXQsIGluZGV4LCBlbnZlbG9wZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgODM6CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50LnR5cGUgPT0gMykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ5dGVDb3VudCA9IE1hdGguY2VpbChDb25maWcuc3BlY3RydW1Db250cm9sUG9pbnRzICogQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50Qml0cyAvIDYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJpdHMgPSBuZXcgQml0RmllbGRSZWFkZXIoY29tcHJlc3NlZCwgY2hhckluZGV4LCBjaGFySW5kZXggKyBieXRlQ291bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuc3BlY3RydW1XYXZlLnNwZWN0cnVtW2ldID0gYml0cy5yZWFkKENvbmZpZy5zcGVjdHJ1bUNvbnRyb2xQb2ludEJpdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LnNwZWN0cnVtV2F2ZS5tYXJrQ3VzdG9tV2F2ZURpcnR5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhckluZGV4ICs9IGJ5dGVDb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGluc3RydW1lbnQudHlwZSA9PSA0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYnl0ZUNvdW50ID0gTWF0aC5jZWlsKENvbmZpZy5kcnVtQ291bnQgKiBDb25maWcuc3BlY3RydW1Db250cm9sUG9pbnRzICogQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50Qml0cyAvIDYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJpdHMgPSBuZXcgQml0RmllbGRSZWFkZXIoY29tcHJlc3NlZCwgY2hhckluZGV4LCBjaGFySW5kZXggKyBieXRlQ291bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgQ29uZmlnLmRydW1Db3VudDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ29uZmlnLnNwZWN0cnVtQ29udHJvbFBvaW50czsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50LmRydW1zZXRTcGVjdHJ1bVdhdmVzW2pdLnNwZWN0cnVtW2ldID0gYml0cy5yZWFkKENvbmZpZy5zcGVjdHJ1bUNvbnRyb2xQb2ludEJpdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuZHJ1bXNldFNwZWN0cnVtV2F2ZXNbal0ubWFya0N1c3RvbVdhdmVEaXJ0eSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFySW5kZXggKz0gYnl0ZUNvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbmhhbmRsZWQgaW5zdHJ1bWVudCB0eXBlIGZvciBzcGVjdHJ1bSBzb25nIHRhZyBjb2RlLiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgNzI6CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSB0aGlzLmNoYW5uZWxzW2luc3RydW1lbnRDaGFubmVsSXRlcmF0b3JdLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleEl0ZXJhdG9yXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJ5dGVDb3VudCA9IE1hdGguY2VpbChDb25maWcuaGFybW9uaWNzQ29udHJvbFBvaW50cyAqIENvbmZpZy5oYXJtb25pY3NDb250cm9sUG9pbnRCaXRzIC8gNik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiaXRzID0gbmV3IEJpdEZpZWxkUmVhZGVyKGNvbXByZXNzZWQsIGNoYXJJbmRleCwgY2hhckluZGV4ICsgYnl0ZUNvdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgQ29uZmlnLmhhcm1vbmljc0NvbnRyb2xQb2ludHM7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnQuaGFybW9uaWNzV2F2ZS5oYXJtb25pY3NbaV0gPSBiaXRzLnJlYWQoQ29uZmlnLmhhcm1vbmljc0NvbnRyb2xQb2ludEJpdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5oYXJtb25pY3NXYXZlLm1hcmtDdXN0b21XYXZlRGlydHkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJJbmRleCArPSBieXRlQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSA5ODoKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHN1YlN0cmluZ0xlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVUaHJlZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5uZWxJbmRleCA9IGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFyQ291bnQgPSBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YlN0cmluZ0xlbmd0aCA9IE1hdGguY2VpbChiYXJDb3VudCAqIDAuNSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYml0cyA9IG5ldyBCaXRGaWVsZFJlYWRlcihjb21wcmVzc2VkLCBjaGFySW5kZXgsIGNoYXJJbmRleCArIHN1YlN0cmluZ0xlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBiYXJDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XS5iYXJzW2ldID0gYml0cy5yZWFkKDMpICsgMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChiZWZvcmVGaXZlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5lZWRlZEJpdHMgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICgoMSA8PCBuZWVkZWRCaXRzKSA8IHRoaXMucGF0dGVybnNQZXJDaGFubmVsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkZWRCaXRzKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViU3RyaW5nTGVuZ3RoID0gTWF0aC5jZWlsKHRoaXMuZ2V0Q2hhbm5lbENvdW50KCkgKiB0aGlzLmJhckNvdW50ICogbmVlZGVkQml0cyAvIDYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJpdHMgPSBuZXcgQml0RmllbGRSZWFkZXIoY29tcHJlc3NlZCwgY2hhckluZGV4LCBjaGFySW5kZXggKyBzdWJTdHJpbmdMZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGNoYW5uZWxJbmRleCA9IDA7IGNoYW5uZWxJbmRleCA8IHRoaXMuZ2V0Q2hhbm5lbENvdW50KCk7IGNoYW5uZWxJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5iYXJDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uYmFyc1tpXSA9IGJpdHMucmVhZChuZWVkZWRCaXRzKSArIDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbmVlZGVkQml0cyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCgxIDw8IG5lZWRlZEJpdHMpIDwgdGhpcy5wYXR0ZXJuc1BlckNoYW5uZWwgKyAxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZWVkZWRCaXRzKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViU3RyaW5nTGVuZ3RoID0gTWF0aC5jZWlsKHRoaXMuZ2V0Q2hhbm5lbENvdW50KCkgKiB0aGlzLmJhckNvdW50ICogbmVlZGVkQml0cyAvIDYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGJpdHMgPSBuZXcgQml0RmllbGRSZWFkZXIoY29tcHJlc3NlZCwgY2hhckluZGV4LCBjaGFySW5kZXggKyBzdWJTdHJpbmdMZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGNoYW5uZWxJbmRleCA9IDA7IGNoYW5uZWxJbmRleCA8IHRoaXMuZ2V0Q2hhbm5lbENvdW50KCk7IGNoYW5uZWxJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5iYXJDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uYmFyc1tpXSA9IGJpdHMucmVhZChuZWVkZWRCaXRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJJbmRleCArPSBzdWJTdHJpbmdMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxMTI6CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBiaXRTdHJpbmdMZW5ndGggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGNoYW5uZWxJbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVUaHJlZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWxJbmRleCA9IGJhc2U2NENoYXJDb2RlVG9JbnRbY29tcHJlc3NlZC5jaGFyQ29kZUF0KGNoYXJJbmRleCsrKV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhckluZGV4Kys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYml0U3RyaW5nTGVuZ3RoID0gYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRTdHJpbmdMZW5ndGggPSBiaXRTdHJpbmdMZW5ndGggPDwgNjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRTdHJpbmdMZW5ndGggKz0gYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWxJbmRleCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGJpdFN0cmluZ0xlbmd0aExlbmd0aCA9IHZhbGlkYXRlUmFuZ2UoMSwgNCwgYmFzZTY0Q2hhckNvZGVUb0ludFtjb21wcmVzc2VkLmNoYXJDb2RlQXQoY2hhckluZGV4KyspXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGJpdFN0cmluZ0xlbmd0aExlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYml0U3RyaW5nTGVuZ3RoID0gYml0U3RyaW5nTGVuZ3RoIDw8IDY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJpdFN0cmluZ0xlbmd0aCArPSBiYXNlNjRDaGFyQ29kZVRvSW50W2NvbXByZXNzZWQuY2hhckNvZGVBdChjaGFySW5kZXgrKyldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiaXRTdHJpbmdMZW5ndGhMZW5ndGgtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiaXRzID0gbmV3IEJpdEZpZWxkUmVhZGVyKGNvbXByZXNzZWQsIGNoYXJJbmRleCwgY2hhckluZGV4ICsgYml0U3RyaW5nTGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJJbmRleCArPSBiaXRTdHJpbmdMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiaXRzUGVyTm90ZVNpemUgPSBTb25nLmdldE5lZWRlZEJpdHMoQ29uZmlnLm5vdGVTaXplTWF4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlICh0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhbm5lbCA9IHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc05vaXNlQ2hhbm5lbCA9IHRoaXMuZ2V0Q2hhbm5lbElzTm9pc2UoY2hhbm5lbEluZGV4KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXhJbnN0cnVtZW50c1BlclBhdHRlcm4gPSB0aGlzLmdldE1heEluc3RydW1lbnRzUGVyUGF0dGVybihjaGFubmVsSW5kZXgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5lZWRlZEluc3RydW1lbnRDb3VudEJpdHMgPSBTb25nLmdldE5lZWRlZEJpdHMobWF4SW5zdHJ1bWVudHNQZXJQYXR0ZXJuIC0gQ29uZmlnLmluc3RydW1lbnRDb3VudE1pbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmVlZGVkSW5zdHJ1bWVudEluZGV4Qml0cyA9IFNvbmcuZ2V0TmVlZGVkQml0cyhjaGFubmVsLmluc3RydW1lbnRzLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9jdGF2ZU9mZnNldCA9IGlzTm9pc2VDaGFubmVsID8gMCA6IGNoYW5uZWwub2N0YXZlICogMTI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxhc3RQaXRjaCA9IChpc05vaXNlQ2hhbm5lbCA/IDQgOiBvY3RhdmVPZmZzZXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlY2VudFBpdGNoZXMgPSBpc05vaXNlQ2hhbm5lbCA/IFs0LCA2LCA3LCAyLCAzLCA4LCAwLCAxMF0gOiBbMCwgNywgMTIsIDE5LCAyNCwgLTUsIC0xMl07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVjZW50U2hhcGVzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZWNlbnRQaXRjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VudFBpdGNoZXNbaV0gKz0gb2N0YXZlT2Zmc2V0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGF0dGVybnNQZXJDaGFubmVsOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3UGF0dGVybiA9IGNoYW5uZWwucGF0dGVybnNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVOaW5lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQYXR0ZXJuLmluc3RydW1lbnRzWzBdID0gdmFsaWRhdGVSYW5nZSgwLCBjaGFubmVsLmluc3RydW1lbnRzLmxlbmd0aCAtIDEsIGJpdHMucmVhZChuZWVkZWRJbnN0cnVtZW50SW5kZXhCaXRzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQYXR0ZXJuLmluc3RydW1lbnRzLmxlbmd0aCA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXR0ZXJuSW5zdHJ1bWVudHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50Q291bnQgPSB2YWxpZGF0ZVJhbmdlKENvbmZpZy5pbnN0cnVtZW50Q291bnRNaW4sIG1heEluc3RydW1lbnRzUGVyUGF0dGVybiwgYml0cy5yZWFkKG5lZWRlZEluc3RydW1lbnRDb3VudEJpdHMpICsgQ29uZmlnLmluc3RydW1lbnRDb3VudE1pbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBpbnN0cnVtZW50Q291bnQ7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQYXR0ZXJuLmluc3RydW1lbnRzW2pdID0gdmFsaWRhdGVSYW5nZSgwLCBjaGFubmVsLmluc3RydW1lbnRzLmxlbmd0aCAtIDEsIGJpdHMucmVhZChuZWVkZWRJbnN0cnVtZW50SW5kZXhCaXRzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhdHRlcm4uaW5zdHJ1bWVudHMubGVuZ3RoID0gaW5zdHJ1bWVudENvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGF0dGVybi5pbnN0cnVtZW50c1swXSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGF0dGVybi5pbnN0cnVtZW50cy5sZW5ndGggPSBDb25maWcuaW5zdHJ1bWVudENvdW50TWluOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYmVmb3JlVGhyZWUgJiYgYml0cy5yZWFkKDEpID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhdHRlcm4ubm90ZXMubGVuZ3RoID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjdXJQYXJ0ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV3Tm90ZXMgPSBuZXdQYXR0ZXJuLm5vdGVzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbm90ZUNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGN1clBhcnQgPCB0aGlzLmJlYXRzUGVyQmFyICogQ29uZmlnLnBhcnRzUGVyQmVhdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXNlT2xkU2hhcGUgPSBiaXRzLnJlYWQoMSkgPT0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBuZXdOb3RlID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2hhcGVJbmRleCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodXNlT2xkU2hhcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFwZUluZGV4ID0gdmFsaWRhdGVSYW5nZSgwLCByZWNlbnRTaGFwZXMubGVuZ3RoIC0gMSwgYml0cy5yZWFkTG9uZ1RhaWwoMCwgMCkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3Tm90ZSA9IGJpdHMucmVhZCgxKSA9PSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF1c2VPbGRTaGFwZSAmJiAhbmV3Tm90ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlc3RMZW5ndGggPSBiZWZvcmVTZXZlbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGJpdHMucmVhZExlZ2FjeVBhcnREdXJhdGlvbigpICogQ29uZmlnLnBhcnRzUGVyQmVhdCAvIENvbmZpZy5yaHl0aG1zW3RoaXMucmh5dGhtXS5zdGVwc1BlckJlYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBiaXRzLnJlYWRQYXJ0RHVyYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJQYXJ0ICs9IHJlc3RMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc2hhcGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVzZU9sZFNoYXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlID0gcmVjZW50U2hhcGVzW3NoYXBlSW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlbnRTaGFwZXMuc3BsaWNlKHNoYXBlSW5kZXgsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGUgPSB7fTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGUucGl0Y2hDb3VudCA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChzaGFwZS5waXRjaENvdW50IDwgQ29uZmlnLm1heENob3JkU2l6ZSAmJiBiaXRzLnJlYWQoMSkgPT0gMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlLnBpdGNoQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGUucGluQ291bnQgPSBiaXRzLnJlYWRQaW5Db3VudCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFwZS5pbml0aWFsU2l6ZSA9IGJpdHMucmVhZChiaXRzUGVyTm90ZVNpemUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFwZS5waW5zID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlLmxlbmd0aCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYXBlLmJlbmRDb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgc2hhcGUucGluQ291bnQ7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpbk9iaiA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGluT2JqLnBpdGNoQmVuZCA9IGJpdHMucmVhZCgxKSA9PSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpbk9iai5waXRjaEJlbmQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGUuYmVuZENvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFwZS5sZW5ndGggKz0gYmVmb3JlU2V2ZW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGJpdHMucmVhZExlZ2FjeVBhcnREdXJhdGlvbigpICogQ29uZmlnLnBhcnRzUGVyQmVhdCAvIENvbmZpZy5yaHl0aG1zW3RoaXMucmh5dGhtXS5zdGVwc1BlckJlYXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IGJpdHMucmVhZFBhcnREdXJhdGlvbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGluT2JqLnRpbWUgPSBzaGFwZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaW5PYmouc2l6ZSA9IGJpdHMucmVhZChiaXRzUGVyTm90ZVNpemUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhcGUucGlucy5wdXNoKHBpbk9iaik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVjZW50U2hhcGVzLnVuc2hpZnQoc2hhcGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWNlbnRTaGFwZXMubGVuZ3RoID4gMTApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VudFNoYXBlcy5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbm90ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3Tm90ZXMubGVuZ3RoIDw9IG5vdGVDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RlID0gbmV3IE5vdGUoMCwgY3VyUGFydCwgY3VyUGFydCArIHNoYXBlLmxlbmd0aCwgc2hhcGUuaW5pdGlhbFNpemUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdOb3Rlc1tub3RlQ291bnQrK10gPSBub3RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZSA9IG5ld05vdGVzW25vdGVDb3VudCsrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZS5zdGFydCA9IGN1clBhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdGUuZW5kID0gY3VyUGFydCArIHNoYXBlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZS5waW5zWzBdLnNpemUgPSBzaGFwZS5pbml0aWFsU2l6ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBpdGNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaXRjaENvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwaXRjaEJlbmRzID0gW107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzaGFwZS5waXRjaENvdW50ICsgc2hhcGUuYmVuZENvdW50OyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXNlT2xkUGl0Y2ggPSBiaXRzLnJlYWQoMSkgPT0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF1c2VPbGRQaXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZXJ2YWwgPSBiaXRzLnJlYWRQaXRjaEludGVydmFsKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaCA9IGxhc3RQaXRjaDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnRlcnZhbEl0ZXIgPSBpbnRlcnZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChpbnRlcnZhbEl0ZXIgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl0Y2grKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAocmVjZW50UGl0Y2hlcy5pbmRleE9mKHBpdGNoKSAhPSAtMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl0Y2grKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbEl0ZXItLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChpbnRlcnZhbEl0ZXIgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl0Y2gtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAocmVjZW50UGl0Y2hlcy5pbmRleE9mKHBpdGNoKSAhPSAtMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl0Y2gtLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnRlcnZhbEl0ZXIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoSW5kZXggPSB2YWxpZGF0ZVJhbmdlKDAsIHJlY2VudFBpdGNoZXMubGVuZ3RoIC0gMSwgYml0cy5yZWFkKDMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gcmVjZW50UGl0Y2hlc1twaXRjaEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VudFBpdGNoZXMuc3BsaWNlKHBpdGNoSW5kZXgsIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlY2VudFBpdGNoZXMudW5zaGlmdChwaXRjaCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZWNlbnRQaXRjaGVzLmxlbmd0aCA+IDgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNlbnRQaXRjaGVzLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA8IHNoYXBlLnBpdGNoQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdGUucGl0Y2hlc1twaXRjaENvdW50KytdID0gcGl0Y2g7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaEJlbmRzLnB1c2gocGl0Y2gpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID09IHNoYXBlLnBpdGNoQ291bnQgLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0UGl0Y2ggPSBub3RlLnBpdGNoZXNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0UGl0Y2ggPSBwaXRjaDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RlLnBpdGNoZXMubGVuZ3RoID0gcGl0Y2hDb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaEJlbmRzLnVuc2hpZnQobm90ZS5waXRjaGVzWzBdKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcGluQ291bnQgPSAxOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcGluT2JqIG9mIHNoYXBlLnBpbnMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpbk9iai5waXRjaEJlbmQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaXRjaEJlbmRzLnNoaWZ0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGludGVydmFsID0gcGl0Y2hCZW5kc1swXSAtIG5vdGUucGl0Y2hlc1swXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdGUucGlucy5sZW5ndGggPD0gcGluQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdGUucGluc1twaW5Db3VudCsrXSA9IG1ha2VOb3RlUGluKGludGVydmFsLCBwaW5PYmoudGltZSwgcGluT2JqLnNpemUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGluID0gbm90ZS5waW5zW3BpbkNvdW50KytdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGluLmludGVydmFsID0gaW50ZXJ2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaW4udGltZSA9IHBpbk9iai50aW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGluLnNpemUgPSBwaW5PYmouc2l6ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RlLnBpbnMubGVuZ3RoID0gcGluQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdGUuc3RhcnQgPT0gMCAmJiAhYmVmb3JlTmluZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RlLmNvbnRpbnVlc0xhc3RQYXR0ZXJuID0gKGJpdHMucmVhZCgxKSA9PSAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdGUuY29udGludWVzTGFzdFBhdHRlcm4gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VyUGFydCA9IHZhbGlkYXRlUmFuZ2UoMCwgdGhpcy5iZWF0c1BlckJhciAqIENvbmZpZy5wYXJ0c1BlckJlYXQsIG5vdGUuZW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdOb3Rlcy5sZW5ndGggPSBub3RlQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiZWZvcmVUaHJlZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWxJbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hhbm5lbEluZGV4ID49IHRoaXMuZ2V0Q2hhbm5lbENvdW50KCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJVbnJlY29nbml6ZWQgc29uZyB0YWcgY29kZSAiICsgU3RyaW5nLmZyb21DaGFyQ29kZShjb21tYW5kKSArICIgYXQgaW5kZXggIiArIChjaGFySW5kZXggLSAxKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdG9Kc29uT2JqZWN0KGVuYWJsZUludHJvID0gdHJ1ZSwgbG9vcENvdW50ID0gMSwgZW5hYmxlT3V0cm8gPSB0cnVlKSB7CiAgICAgICAgICAgIGNvbnN0IGNoYW5uZWxBcnJheSA9IFtdOwogICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCB0aGlzLmdldENoYW5uZWxDb3VudCgpOyBjaGFubmVsSW5kZXgrKykgewogICAgICAgICAgICAgICAgY29uc3QgY2hhbm5lbCA9IHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XTsKICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnRBcnJheSA9IFtdOwogICAgICAgICAgICAgICAgY29uc3QgaXNOb2lzZUNoYW5uZWwgPSB0aGlzLmdldENoYW5uZWxJc05vaXNlKGNoYW5uZWxJbmRleCk7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGluc3RydW1lbnQgb2YgY2hhbm5lbC5pbnN0cnVtZW50cykgewogICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnRBcnJheS5wdXNoKGluc3RydW1lbnQudG9Kc29uT2JqZWN0KCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgcGF0dGVybkFycmF5ID0gW107CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHBhdHRlcm4gb2YgY2hhbm5lbC5wYXR0ZXJucykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vdGVBcnJheSA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgbm90ZSBvZiBwYXR0ZXJuLm5vdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBvaW50QXJyYXkgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBwaW4gb2Ygbm90ZS5waW5zKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2ludEFycmF5LnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aWNrIjogKHBpbi50aW1lICsgbm90ZS5zdGFydCkgKiBDb25maWcucmh5dGhtc1t0aGlzLnJoeXRobV0uc3RlcHNQZXJCZWF0IC8gQ29uZmlnLnBhcnRzUGVyQmVhdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAicGl0Y2hCZW5kIjogcGluLmludGVydmFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ2b2x1bWUiOiBNYXRoLnJvdW5kKHBpbi5zaXplICogMTAwIC8gMyksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBub3RlT2JqZWN0ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInBpdGNoZXMiOiBub3RlLnBpdGNoZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAicG9pbnRzIjogcG9pbnRBcnJheSwKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdGUuc3RhcnQgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZU9iamVjdFsiY29udGludWVzTGFzdFBhdHRlcm4iXSA9IG5vdGUuY29udGludWVzTGFzdFBhdHRlcm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbm90ZUFycmF5LnB1c2gobm90ZU9iamVjdCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhdHRlcm5PYmplY3QgPSB7ICJub3RlcyI6IG5vdGVBcnJheSB9OwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhdHRlcm5JbnN0cnVtZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuT2JqZWN0WyJpbnN0cnVtZW50cyJdID0gcGF0dGVybi5pbnN0cnVtZW50cy5tYXAoaSA9PiBpICsgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhdHRlcm5BcnJheS5wdXNoKHBhdHRlcm5PYmplY3QpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3Qgc2VxdWVuY2VBcnJheSA9IFtdOwogICAgICAgICAgICAgICAgaWYgKGVuYWJsZUludHJvKQogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5sb29wU3RhcnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBzZXF1ZW5jZUFycmF5LnB1c2goY2hhbm5lbC5iYXJzW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGxldCBsID0gMDsgbCA8IGxvb3BDb3VudDsgbCsrKQogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmxvb3BTdGFydDsgaSA8IHRoaXMubG9vcFN0YXJ0ICsgdGhpcy5sb29wTGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2VxdWVuY2VBcnJheS5wdXNoKGNoYW5uZWwuYmFyc1tpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVuYWJsZU91dHJvKQogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSB0aGlzLmxvb3BTdGFydCArIHRoaXMubG9vcExlbmd0aDsgaSA8IHRoaXMuYmFyQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBzZXF1ZW5jZUFycmF5LnB1c2goY2hhbm5lbC5iYXJzW2ldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBjaGFubmVsT2JqZWN0ID0gewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogaXNOb2lzZUNoYW5uZWwgPyAiZHJ1bSIgOiAicGl0Y2giLAogICAgICAgICAgICAgICAgICAgICJpbnN0cnVtZW50cyI6IGluc3RydW1lbnRBcnJheSwKICAgICAgICAgICAgICAgICAgICAicGF0dGVybnMiOiBwYXR0ZXJuQXJyYXksCiAgICAgICAgICAgICAgICAgICAgInNlcXVlbmNlIjogc2VxdWVuY2VBcnJheSwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAoIWlzTm9pc2VDaGFubmVsKSB7CiAgICAgICAgICAgICAgICAgICAgY2hhbm5lbE9iamVjdFsib2N0YXZlU2Nyb2xsQmFyIl0gPSBjaGFubmVsLm9jdGF2ZSAtIDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGFubmVsQXJyYXkucHVzaChjaGFubmVsT2JqZWN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgImZvcm1hdCI6IFNvbmcuX2Zvcm1hdCwKICAgICAgICAgICAgICAgICJ2ZXJzaW9uIjogU29uZy5fbGF0ZXN0VmVyc2lvbiwKICAgICAgICAgICAgICAgICJzY2FsZSI6IENvbmZpZy5zY2FsZXNbdGhpcy5zY2FsZV0ubmFtZSwKICAgICAgICAgICAgICAgICJrZXkiOiBDb25maWcua2V5c1t0aGlzLmtleV0ubmFtZSwKICAgICAgICAgICAgICAgICJpbnRyb0JhcnMiOiB0aGlzLmxvb3BTdGFydCwKICAgICAgICAgICAgICAgICJsb29wQmFycyI6IHRoaXMubG9vcExlbmd0aCwKICAgICAgICAgICAgICAgICJiZWF0c1BlckJhciI6IHRoaXMuYmVhdHNQZXJCYXIsCiAgICAgICAgICAgICAgICAidGlja3NQZXJCZWF0IjogQ29uZmlnLnJoeXRobXNbdGhpcy5yaHl0aG1dLnN0ZXBzUGVyQmVhdCwKICAgICAgICAgICAgICAgICJiZWF0c1Blck1pbnV0ZSI6IHRoaXMudGVtcG8sCiAgICAgICAgICAgICAgICAibGF5ZXJlZEluc3RydW1lbnRzIjogdGhpcy5sYXllcmVkSW5zdHJ1bWVudHMsCiAgICAgICAgICAgICAgICAicGF0dGVybkluc3RydW1lbnRzIjogdGhpcy5wYXR0ZXJuSW5zdHJ1bWVudHMsCiAgICAgICAgICAgICAgICAiY2hhbm5lbHMiOiBjaGFubmVsQXJyYXksCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGZyb21Kc29uT2JqZWN0KGpzb25PYmplY3QpIHsKICAgICAgICAgICAgdGhpcy5pbml0VG9EZWZhdWx0KHRydWUpOwogICAgICAgICAgICBpZiAoIWpzb25PYmplY3QpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIHRoaXMuc2NhbGUgPSAxMTsKICAgICAgICAgICAgaWYgKGpzb25PYmplY3RbInNjYWxlIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvbGRTY2FsZU5hbWVzID0gewogICAgICAgICAgICAgICAgICAgICJyb21hbmkgOikiOiAiZGJsIGhhcm1vbmljIDopIiwKICAgICAgICAgICAgICAgICAgICAicm9tYW5pIDooIjogImRibCBoYXJtb25pYyA6KCIsCiAgICAgICAgICAgICAgICAgICAgImVuaWdtYSI6ICJzdHJhbmdlIiwKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZU5hbWUgPSAob2xkU2NhbGVOYW1lc1tqc29uT2JqZWN0WyJzY2FsZSJdXSAhPSB1bmRlZmluZWQpID8gb2xkU2NhbGVOYW1lc1tqc29uT2JqZWN0WyJzY2FsZSJdXSA6IGpzb25PYmplY3RbInNjYWxlIl07CiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZSA9IENvbmZpZy5zY2FsZXMuZmluZEluZGV4KHNjYWxlID0+IHNjYWxlLm5hbWUgPT0gc2NhbGVOYW1lKTsKICAgICAgICAgICAgICAgIGlmIChzY2FsZSAhPSAtMSkKICAgICAgICAgICAgICAgICAgICB0aGlzLnNjYWxlID0gc2NhbGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGpzb25PYmplY3RbImtleSJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiAoanNvbk9iamVjdFsia2V5Il0pID09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5rZXkgPSAoKGpzb25PYmplY3RbImtleSJdICsgMTIwMCkgPj4+IDApICUgQ29uZmlnLmtleXMubGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIChqc29uT2JqZWN0WyJrZXkiXSkgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBqc29uT2JqZWN0WyJrZXkiXTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsZXR0ZXIgPSBrZXkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ltYm9sID0ga2V5LmNoYXJBdCgxKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxldHRlck1hcCA9IHsgIkMiOiAwLCAiRCI6IDIsICJFIjogNCwgIkYiOiA1LCAiRyI6IDcsICJBIjogOSwgIkIiOiAxMSB9OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGFjY2lkZW50YWxNYXAgPSB7ICIjIjogMSwgIuKZryI6IDEsICJiIjogLTEsICLima0iOiAtMSB9OwogICAgICAgICAgICAgICAgICAgIGxldCBpbmRleCA9IGxldHRlck1hcFtsZXR0ZXJdOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9mZnNldCA9IGFjY2lkZW50YWxNYXBbc3ltYm9sXTsKICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvZmZzZXQgIT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gb2Zmc2V0OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXggKz0gMTI7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gaW5kZXggJSAxMjsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5rZXkgPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGpzb25PYmplY3RbImJlYXRzUGVyTWludXRlIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLnRlbXBvID0gY2xhbXAoQ29uZmlnLnRlbXBvTWluLCBDb25maWcudGVtcG9NYXggKyAxLCBqc29uT2JqZWN0WyJiZWF0c1Blck1pbnV0ZSJdIHwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGxlZ2FjeUdsb2JhbFJldmVyYiA9IDA7CiAgICAgICAgICAgIGlmIChqc29uT2JqZWN0WyJyZXZlcmIiXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGxlZ2FjeUdsb2JhbFJldmVyYiA9IGNsYW1wKDAsIDQsIGpzb25PYmplY3RbInJldmVyYiJdIHwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGpzb25PYmplY3RbImJlYXRzUGVyQmFyIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmJlYXRzUGVyQmFyID0gTWF0aC5tYXgoQ29uZmlnLmJlYXRzUGVyQmFyTWluLCBNYXRoLm1pbihDb25maWcuYmVhdHNQZXJCYXJNYXgsIGpzb25PYmplY3RbImJlYXRzUGVyQmFyIl0gfCAwKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbGV0IGltcG9ydGVkUGFydHNQZXJCZWF0ID0gNDsKICAgICAgICAgICAgaWYgKGpzb25PYmplY3RbInRpY2tzUGVyQmVhdCJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgaW1wb3J0ZWRQYXJ0c1BlckJlYXQgPSAoanNvbk9iamVjdFsidGlja3NQZXJCZWF0Il0gfCAwKSB8fCA0OwogICAgICAgICAgICAgICAgdGhpcy5yaHl0aG0gPSBDb25maWcucmh5dGhtcy5maW5kSW5kZXgocmh5dGhtID0+IHJoeXRobS5zdGVwc1BlckJlYXQgPT0gaW1wb3J0ZWRQYXJ0c1BlckJlYXQpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMucmh5dGhtID09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yaHl0aG0gPSAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBtYXhJbnN0cnVtZW50cyA9IDE7CiAgICAgICAgICAgIGxldCBtYXhQYXR0ZXJucyA9IDE7CiAgICAgICAgICAgIGxldCBtYXhCYXJzID0gMTsKICAgICAgICAgICAgaWYgKGpzb25PYmplY3RbImNoYW5uZWxzIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGNoYW5uZWxPYmplY3Qgb2YganNvbk9iamVjdFsiY2hhbm5lbHMiXSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjaGFubmVsT2JqZWN0WyJpbnN0cnVtZW50cyJdKQogICAgICAgICAgICAgICAgICAgICAgICBtYXhJbnN0cnVtZW50cyA9IE1hdGgubWF4KG1heEluc3RydW1lbnRzLCBjaGFubmVsT2JqZWN0WyJpbnN0cnVtZW50cyJdLmxlbmd0aCB8IDApOwogICAgICAgICAgICAgICAgICAgIGlmIChjaGFubmVsT2JqZWN0WyJwYXR0ZXJucyJdKQogICAgICAgICAgICAgICAgICAgICAgICBtYXhQYXR0ZXJucyA9IE1hdGgubWF4KG1heFBhdHRlcm5zLCBjaGFubmVsT2JqZWN0WyJwYXR0ZXJucyJdLmxlbmd0aCB8IDApOwogICAgICAgICAgICAgICAgICAgIGlmIChjaGFubmVsT2JqZWN0WyJzZXF1ZW5jZSJdKQogICAgICAgICAgICAgICAgICAgICAgICBtYXhCYXJzID0gTWF0aC5tYXgobWF4QmFycywgY2hhbm5lbE9iamVjdFsic2VxdWVuY2UiXS5sZW5ndGggfCAwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoanNvbk9iamVjdFsibGF5ZXJlZEluc3RydW1lbnRzIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLmxheWVyZWRJbnN0cnVtZW50cyA9ICEhanNvbk9iamVjdFsibGF5ZXJlZEluc3RydW1lbnRzIl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmxheWVyZWRJbnN0cnVtZW50cyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChqc29uT2JqZWN0WyJwYXR0ZXJuSW5zdHJ1bWVudHMiXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMucGF0dGVybkluc3RydW1lbnRzID0gISFqc29uT2JqZWN0WyJwYXR0ZXJuSW5zdHJ1bWVudHMiXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMucGF0dGVybkluc3RydW1lbnRzID0gKG1heEluc3RydW1lbnRzID4gMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5wYXR0ZXJuc1BlckNoYW5uZWwgPSBNYXRoLm1pbihtYXhQYXR0ZXJucywgQ29uZmlnLmJhckNvdW50TWF4KTsKICAgICAgICAgICAgdGhpcy5iYXJDb3VudCA9IE1hdGgubWluKG1heEJhcnMsIENvbmZpZy5iYXJDb3VudE1heCk7CiAgICAgICAgICAgIGlmIChqc29uT2JqZWN0WyJpbnRyb0JhcnMiXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9vcFN0YXJ0ID0gY2xhbXAoMCwgdGhpcy5iYXJDb3VudCwganNvbk9iamVjdFsiaW50cm9CYXJzIl0gfCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoanNvbk9iamVjdFsibG9vcEJhcnMiXSAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9vcExlbmd0aCA9IGNsYW1wKDEsIHRoaXMuYmFyQ291bnQgLSB0aGlzLmxvb3BTdGFydCArIDEsIGpzb25PYmplY3RbImxvb3BCYXJzIl0gfCAwKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCBuZXdQaXRjaENoYW5uZWxzID0gW107CiAgICAgICAgICAgIGNvbnN0IG5ld05vaXNlQ2hhbm5lbHMgPSBbXTsKICAgICAgICAgICAgaWYgKGpzb25PYmplY3RbImNoYW5uZWxzIl0gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsSW5kZXggPSAwOyBjaGFubmVsSW5kZXggPCBqc29uT2JqZWN0WyJjaGFubmVscyJdLmxlbmd0aDsgY2hhbm5lbEluZGV4KyspIHsKICAgICAgICAgICAgICAgICAgICBsZXQgY2hhbm5lbE9iamVjdCA9IGpzb25PYmplY3RbImNoYW5uZWxzIl1bY2hhbm5lbEluZGV4XTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFubmVsID0gbmV3IENoYW5uZWwoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgaXNOb2lzZUNoYW5uZWwgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBpZiAoY2hhbm5lbE9iamVjdFsidHlwZSJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBpc05vaXNlQ2hhbm5lbCA9IChjaGFubmVsT2JqZWN0WyJ0eXBlIl0gPT0gImRydW0iKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlzTm9pc2VDaGFubmVsID0gKGNoYW5uZWxJbmRleCA+PSAzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzTm9pc2VDaGFubmVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld05vaXNlQ2hhbm5lbHMucHVzaChjaGFubmVsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BpdGNoQ2hhbm5lbHMucHVzaChjaGFubmVsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKGNoYW5uZWxPYmplY3RbIm9jdGF2ZVNjcm9sbEJhciJdICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLm9jdGF2ZSA9IGNsYW1wKDAsIENvbmZpZy5waXRjaE9jdGF2ZXMsIChjaGFubmVsT2JqZWN0WyJvY3RhdmVTY3JvbGxCYXIiXSB8IDApICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc05vaXNlQ2hhbm5lbCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWwub2N0YXZlID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoY2hhbm5lbE9iamVjdFsiaW5zdHJ1bWVudHMiXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudE9iamVjdHMgPSBjaGFubmVsT2JqZWN0WyJpbnN0cnVtZW50cyJdOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluc3RydW1lbnRPYmplY3RzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA+PSB0aGlzLmdldE1heEluc3RydW1lbnRzUGVyQ2hhbm5lbCgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IG5ldyBJbnN0cnVtZW50KGlzTm9pc2VDaGFubmVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoYW5uZWwuaW5zdHJ1bWVudHNbaV0gPSBpbnN0cnVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdHJ1bWVudC5mcm9tSnNvbk9iamVjdChpbnN0cnVtZW50T2JqZWN0c1tpXSwgaXNOb2lzZUNoYW5uZWwsIGxlZ2FjeUdsb2JhbFJldmVyYik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnBhdHRlcm5zUGVyQ2hhbm5lbDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhdHRlcm4gPSBuZXcgUGF0dGVybigpOwogICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsLnBhdHRlcm5zW2ldID0gcGF0dGVybjsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBhdHRlcm5PYmplY3QgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGFubmVsT2JqZWN0WyJwYXR0ZXJucyJdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybk9iamVjdCA9IGNoYW5uZWxPYmplY3RbInBhdHRlcm5zIl1baV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXR0ZXJuT2JqZWN0ID09IHVuZGVmaW5lZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5wYXR0ZXJuSW5zdHJ1bWVudHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHBhdHRlcm5PYmplY3RbImluc3RydW1lbnRzIl0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudHMgPSBwYXR0ZXJuT2JqZWN0WyJpbnN0cnVtZW50cyJdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnRDb3VudCA9IGNsYW1wKENvbmZpZy5pbnN0cnVtZW50Q291bnRNaW4sIHRoaXMuZ2V0TWF4SW5zdHJ1bWVudHNQZXJQYXR0ZXJuRm9yQ2hhbm5lbChjaGFubmVsKSArIDEsIGluc3RydW1lbnRzLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBpbnN0cnVtZW50Q291bnQ7IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuLmluc3RydW1lbnRzW2pdID0gY2xhbXAoMCwgY2hhbm5lbC5pbnN0cnVtZW50cy5sZW5ndGgsIChpbnN0cnVtZW50c1tqXSB8IDApIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhdHRlcm4uaW5zdHJ1bWVudHMubGVuZ3RoID0gaW5zdHJ1bWVudENvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybi5pbnN0cnVtZW50c1swXSA9IGNsYW1wKDAsIGNoYW5uZWwuaW5zdHJ1bWVudHMubGVuZ3RoLCAocGF0dGVybk9iamVjdFsiaW5zdHJ1bWVudCJdIHwgMCkgLSAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXR0ZXJuLmluc3RydW1lbnRzLmxlbmd0aCA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhdHRlcm5PYmplY3RbIm5vdGVzIl0gJiYgcGF0dGVybk9iamVjdFsibm90ZXMiXS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXhOb3RlQ291bnQgPSBNYXRoLm1pbih0aGlzLmJlYXRzUGVyQmFyICogQ29uZmlnLnBhcnRzUGVyQmVhdCwgcGF0dGVybk9iamVjdFsibm90ZXMiXS5sZW5ndGggPj4+IDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRpY2tDbG9jayA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHBhdHRlcm5PYmplY3RbIm5vdGVzIl0ubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA+PSBtYXhOb3RlQ291bnQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vdGVPYmplY3QgPSBwYXR0ZXJuT2JqZWN0WyJub3RlcyJdW2pdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbm90ZU9iamVjdCB8fCAhbm90ZU9iamVjdFsicGl0Y2hlcyJdIHx8ICEobm90ZU9iamVjdFsicGl0Y2hlcyJdLmxlbmd0aCA+PSAxKSB8fCAhbm90ZU9iamVjdFsicG9pbnRzIl0gfHwgIShub3RlT2JqZWN0WyJwb2ludHMiXS5sZW5ndGggPj0gMikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vdGUgPSBuZXcgTm90ZSgwLCAwLCAwLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RlLnBpdGNoZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RlLnBpbnMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IG5vdGVPYmplY3RbInBpdGNoZXMiXS5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwaXRjaCA9IG5vdGVPYmplY3RbInBpdGNoZXMiXVtrXSB8IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub3RlLnBpdGNoZXMuaW5kZXhPZihwaXRjaCkgIT0gLTEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZS5waXRjaGVzLnB1c2gocGl0Y2gpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm90ZS5waXRjaGVzLmxlbmd0aCA+PSBDb25maWcubWF4Q2hvcmRTaXplKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub3RlLnBpdGNoZXMubGVuZ3RoIDwgMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5vdGVDbG9jayA9IHRpY2tDbG9jazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnRJbnRlcnZhbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBub3RlT2JqZWN0WyJwb2ludHMiXS5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwb2ludE9iamVjdCA9IG5vdGVPYmplY3RbInBvaW50cyJdW2tdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9pbnRPYmplY3QgPT0gdW5kZWZpbmVkIHx8IHBvaW50T2JqZWN0WyJ0aWNrIl0gPT0gdW5kZWZpbmVkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGludGVydmFsID0gKHBvaW50T2JqZWN0WyJwaXRjaEJlbmQiXSA9PSB1bmRlZmluZWQpID8gMCA6IChwb2ludE9iamVjdFsicGl0Y2hCZW5kIl0gfCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGltZSA9IE1hdGgucm91bmQoKCtwb2ludE9iamVjdFsidGljayJdKSAqIENvbmZpZy5wYXJ0c1BlckJlYXQgLyBpbXBvcnRlZFBhcnRzUGVyQmVhdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNpemUgPSAocG9pbnRPYmplY3RbInZvbHVtZSJdID09IHVuZGVmaW5lZCkgPyAzIDogTWF0aC5tYXgoMCwgTWF0aC5taW4oMywgTWF0aC5yb3VuZCgocG9pbnRPYmplY3RbInZvbHVtZSJdIHwgMCkgKiAzIC8gMTAwKSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGltZSA+IHRoaXMuYmVhdHNQZXJCYXIgKiBDb25maWcucGFydHNQZXJCZWF0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub3RlLnBpbnMubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aW1lIDwgbm90ZUNsb2NrKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZS5zdGFydCA9IHRpbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGFydEludGVydmFsID0gaW50ZXJ2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGltZSA8PSBub3RlQ2xvY2spCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZUNsb2NrID0gdGltZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZS5waW5zLnB1c2gobWFrZU5vdGVQaW4oaW50ZXJ2YWwgLSBzdGFydEludGVydmFsLCB0aW1lIC0gbm90ZS5zdGFydCwgc2l6ZSkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm90ZS5waW5zLmxlbmd0aCA8IDIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdGUuZW5kID0gbm90ZS5waW5zW25vdGUucGlucy5sZW5ndGggLSAxXS50aW1lICsgbm90ZS5zdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXhQaXRjaCA9IGlzTm9pc2VDaGFubmVsID8gQ29uZmlnLmRydW1Db3VudCAtIDEgOiBDb25maWcubWF4UGl0Y2g7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGxvd2VzdFBpdGNoID0gbWF4UGl0Y2g7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGhpZ2hlc3RQaXRjaCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBub3RlLnBpdGNoZXMubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZS5waXRjaGVzW2tdICs9IHN0YXJ0SW50ZXJ2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub3RlLnBpdGNoZXNba10gPCAwIHx8IG5vdGUucGl0Y2hlc1trXSA+IG1heFBpdGNoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RlLnBpdGNoZXMuc3BsaWNlKGssIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgay0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub3RlLnBpdGNoZXNba10gPCBsb3dlc3RQaXRjaCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvd2VzdFBpdGNoID0gbm90ZS5waXRjaGVzW2tdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm90ZS5waXRjaGVzW2tdID4gaGlnaGVzdFBpdGNoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlnaGVzdFBpdGNoID0gbm90ZS5waXRjaGVzW2tdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm90ZS5waXRjaGVzLmxlbmd0aCA8IDEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbm90ZS5waW5zLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpbiA9IG5vdGUucGluc1trXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpbi5pbnRlcnZhbCArIGxvd2VzdFBpdGNoIDwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpbi5pbnRlcnZhbCA9IC1sb3dlc3RQaXRjaDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpbi5pbnRlcnZhbCArIGhpZ2hlc3RQaXRjaCA+IG1heFBpdGNoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGluLmludGVydmFsID0gbWF4UGl0Y2ggLSBoaWdoZXN0UGl0Y2g7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrID49IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaW4uaW50ZXJ2YWwgPT0gbm90ZS5waW5zW2sgLSAxXS5pbnRlcnZhbCAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpbi5pbnRlcnZhbCA9PSBub3RlLnBpbnNbayAtIDJdLmludGVydmFsICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGluLnNpemUgPT0gbm90ZS5waW5zW2sgLSAxXS5zaXplICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGluLnNpemUgPT0gbm90ZS5waW5zW2sgLSAyXS5zaXplKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZS5waW5zLnNwbGljZShrIC0gMSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgay0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub3RlLnN0YXJ0ID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZS5jb250aW51ZXNMYXN0UGF0dGVybiA9IChub3RlT2JqZWN0WyJjb250aW51ZXNMYXN0UGF0dGVybiJdID09PSB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdGUuY29udGludWVzTGFzdFBhdHRlcm4gPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGF0dGVybi5ub3Rlcy5wdXNoKG5vdGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpY2tDbG9jayA9IG5vdGUuZW5kOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNoYW5uZWwucGF0dGVybnMubGVuZ3RoID0gdGhpcy5wYXR0ZXJuc1BlckNoYW5uZWw7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmJhckNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbC5iYXJzW2ldID0gKGNoYW5uZWxPYmplY3RbInNlcXVlbmNlIl0gIT0gdW5kZWZpbmVkKSA/IE1hdGgubWluKHRoaXMucGF0dGVybnNQZXJDaGFubmVsLCBjaGFubmVsT2JqZWN0WyJzZXF1ZW5jZSJdW2ldID4+PiAwKSA6IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNoYW5uZWwuYmFycy5sZW5ndGggPSB0aGlzLmJhckNvdW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChuZXdQaXRjaENoYW5uZWxzLmxlbmd0aCA+IENvbmZpZy5waXRjaENoYW5uZWxDb3VudE1heCkKICAgICAgICAgICAgICAgIG5ld1BpdGNoQ2hhbm5lbHMubGVuZ3RoID0gQ29uZmlnLnBpdGNoQ2hhbm5lbENvdW50TWF4OwogICAgICAgICAgICBpZiAobmV3Tm9pc2VDaGFubmVscy5sZW5ndGggPiBDb25maWcubm9pc2VDaGFubmVsQ291bnRNYXgpCiAgICAgICAgICAgICAgICBuZXdOb2lzZUNoYW5uZWxzLmxlbmd0aCA9IENvbmZpZy5ub2lzZUNoYW5uZWxDb3VudE1heDsKICAgICAgICAgICAgdGhpcy5waXRjaENoYW5uZWxDb3VudCA9IG5ld1BpdGNoQ2hhbm5lbHMubGVuZ3RoOwogICAgICAgICAgICB0aGlzLm5vaXNlQ2hhbm5lbENvdW50ID0gbmV3Tm9pc2VDaGFubmVscy5sZW5ndGg7CiAgICAgICAgICAgIHRoaXMuY2hhbm5lbHMubGVuZ3RoID0gMDsKICAgICAgICAgICAgQXJyYXkucHJvdG90eXBlLnB1c2guYXBwbHkodGhpcy5jaGFubmVscywgbmV3UGl0Y2hDaGFubmVscyk7CiAgICAgICAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoLmFwcGx5KHRoaXMuY2hhbm5lbHMsIG5ld05vaXNlQ2hhbm5lbHMpOwogICAgICAgIH0KICAgICAgICBnZXRQYXR0ZXJuKGNoYW5uZWxJbmRleCwgYmFyKSB7CiAgICAgICAgICAgIGlmIChiYXIgPCAwIHx8IGJhciA+PSB0aGlzLmJhckNvdW50KQogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgIGNvbnN0IHBhdHRlcm5JbmRleCA9IHRoaXMuY2hhbm5lbHNbY2hhbm5lbEluZGV4XS5iYXJzW2Jhcl07CiAgICAgICAgICAgIGlmIChwYXR0ZXJuSW5kZXggPT0gMCkKICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICByZXR1cm4gdGhpcy5jaGFubmVsc1tjaGFubmVsSW5kZXhdLnBhdHRlcm5zW3BhdHRlcm5JbmRleCAtIDFdOwogICAgICAgIH0KICAgICAgICBnZXRCZWF0c1Blck1pbnV0ZSgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudGVtcG87CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBnZXROZWVkZWRCaXRzKG1heFZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiAzMiAtIE1hdGguY2x6MzIoTWF0aC5jZWlsKG1heFZhbHVlICsgMSkgLSAxKTsKICAgICAgICB9CiAgICB9CiAgICBTb25nLl9mb3JtYXQgPSAiQmVlcEJveCI7CiAgICBTb25nLl9vbGRlc3RWZXJzaW9uID0gMjsKICAgIFNvbmcuX2xhdGVzdFZlcnNpb24gPSA5OwogICAgY2xhc3MgUGlja2VkU3RyaW5nIHsKICAgICAgICBjb25zdHJ1Y3RvcigpIHsKICAgICAgICAgICAgdGhpcy5kZWxheUxpbmUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgfQogICAgICAgIHJlc2V0KCkgewogICAgICAgICAgICB0aGlzLmRlbGF5SW5kZXggPSAtMTsKICAgICAgICAgICAgdGhpcy5hbGxQYXNzU2FtcGxlID0gMC4wOwogICAgICAgICAgICB0aGlzLmFsbFBhc3NQcmV2SW5wdXQgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuc2hlbGZTYW1wbGUgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuc2hlbGZQcmV2SW5wdXQgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZnJhY3Rpb25hbERlbGF5U2FtcGxlID0gMC4wOwogICAgICAgICAgICB0aGlzLnByZXZEZWxheUxlbmd0aCA9IC0xLjA7CiAgICAgICAgICAgIHRoaXMuZGVsYXlSZXNldE9mZnNldCA9IDA7CiAgICAgICAgfQogICAgfQogICAgY2xhc3MgRW52ZWxvcGVDb21wdXRlciB7CiAgICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgICAgIHRoaXMubm90ZVNlY29uZHNTdGFydCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5ub3RlU2Vjb25kc0VuZCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5ub3RlVGlja3NTdGFydCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5ub3RlVGlja3NFbmQgPSAwLjA7CiAgICAgICAgICAgIHRoaXMubm90ZVNpemVTdGFydCA9IENvbmZpZy5ub3RlU2l6ZU1heDsKICAgICAgICAgICAgdGhpcy5ub3RlU2l6ZUVuZCA9IENvbmZpZy5ub3RlU2l6ZU1heDsKICAgICAgICAgICAgdGhpcy5wcmV2Tm90ZVNpemUgPSBDb25maWcubm90ZVNpemVNYXg7CiAgICAgICAgICAgIHRoaXMubmV4dE5vdGVTaXplID0gQ29uZmlnLm5vdGVTaXplTWF4OwogICAgICAgICAgICB0aGlzLl9ub3RlU2l6ZUZpbmFsID0gQ29uZmlnLm5vdGVTaXplTWF4OwogICAgICAgICAgICB0aGlzLnByZXZOb3RlU2Vjb25kc1N0YXJ0ID0gMC4wOwogICAgICAgICAgICB0aGlzLnByZXZOb3RlU2Vjb25kc0VuZCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5wcmV2Tm90ZVRpY2tzU3RhcnQgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucHJldk5vdGVUaWNrc0VuZCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5fcHJldk5vdGVTaXplRmluYWwgPSBDb25maWcubm90ZVNpemVNYXg7CiAgICAgICAgICAgIHRoaXMucHJldlNsaWRlU3RhcnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5wcmV2U2xpZGVFbmQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5uZXh0U2xpZGVTdGFydCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm5leHRTbGlkZUVuZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnByZXZTbGlkZVJhdGlvU3RhcnQgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucHJldlNsaWRlUmF0aW9FbmQgPSAwLjA7CiAgICAgICAgICAgIHRoaXMubmV4dFNsaWRlUmF0aW9TdGFydCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5uZXh0U2xpZGVSYXRpb0VuZCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5lbnZlbG9wZVN0YXJ0cyA9IFtdOwogICAgICAgICAgICB0aGlzLmVudmVsb3BlRW5kcyA9IFtdOwogICAgICAgICAgICB0aGlzLmxvd3Bhc3NDdXRvZmZEZWNheVZvbHVtZUNvbXBlbnNhdGlvbiA9IDEuMDsKICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gMzM7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMuZW52ZWxvcGVTdGFydHNbaV0gPSAxLjA7CiAgICAgICAgICAgICAgICB0aGlzLmVudmVsb3BlRW5kc1tpXSA9IDEuMDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgfQogICAgICAgIHJlc2V0KCkgewogICAgICAgICAgICB0aGlzLm5vdGVTZWNvbmRzRW5kID0gMC4wOwogICAgICAgICAgICB0aGlzLm5vdGVUaWNrc0VuZCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5fbm90ZVNpemVGaW5hbCA9IENvbmZpZy5ub3RlU2l6ZU1heDsKICAgICAgICAgICAgdGhpcy5wcmV2Tm90ZVNlY29uZHNFbmQgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucHJldk5vdGVUaWNrc0VuZCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5fcHJldk5vdGVTaXplRmluYWwgPSBDb25maWcubm90ZVNpemVNYXg7CiAgICAgICAgfQogICAgICAgIGNvbXB1dGVFbnZlbG9wZXMoaW5zdHJ1bWVudCwgY3VycmVudFBhcnQsIHRpY2tUaW1lU3RhcnQsIHRpY2tUaW1lRW5kLCBzZWNvbmRzUGFzc2luZywgdG9uZSkgewogICAgICAgICAgICBjb25zdCB0cmFuc2l0aW9uID0gaW5zdHJ1bWVudC5nZXRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIGlmICh0b25lICE9IG51bGwgJiYgdG9uZS5hdE5vdGVTdGFydCAmJiAhdHJhbnNpdGlvbi5jb250aW51ZXMgJiYgIXRvbmUuZm9yY2VDb250aW51ZUF0U3RhcnQpIHsKICAgICAgICAgICAgICAgIHRoaXMucHJldk5vdGVTZWNvbmRzRW5kID0gdGhpcy5ub3RlU2Vjb25kc0VuZDsKICAgICAgICAgICAgICAgIHRoaXMucHJldk5vdGVUaWNrc0VuZCA9IHRoaXMubm90ZVRpY2tzRW5kOwogICAgICAgICAgICAgICAgdGhpcy5fcHJldk5vdGVTaXplRmluYWwgPSB0aGlzLl9ub3RlU2l6ZUZpbmFsOwogICAgICAgICAgICAgICAgdGhpcy5ub3RlU2Vjb25kc0VuZCA9IDAuMDsKICAgICAgICAgICAgICAgIHRoaXMubm90ZVRpY2tzRW5kID0gMC4wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0b25lICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmICh0b25lLm5vdGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX25vdGVTaXplRmluYWwgPSB0b25lLm5vdGUucGluc1t0b25lLm5vdGUucGlucy5sZW5ndGggLSAxXS5zaXplOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbm90ZVNpemVGaW5hbCA9IENvbmZpZy5ub3RlU2l6ZU1heDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zdCB0aWNrc1Bhc3NpbmcgPSB0aWNrVGltZUVuZCAtIHRpY2tUaW1lU3RhcnQ7CiAgICAgICAgICAgIGNvbnN0IG5vdGVTZWNvbmRzU3RhcnQgPSB0aGlzLm5vdGVTZWNvbmRzRW5kOwogICAgICAgICAgICBjb25zdCBub3RlU2Vjb25kc0VuZCA9IG5vdGVTZWNvbmRzU3RhcnQgKyBzZWNvbmRzUGFzc2luZzsKICAgICAgICAgICAgY29uc3Qgbm90ZVRpY2tzU3RhcnQgPSB0aGlzLm5vdGVUaWNrc0VuZDsKICAgICAgICAgICAgY29uc3Qgbm90ZVRpY2tzRW5kID0gbm90ZVRpY2tzU3RhcnQgKyB0aWNrc1Bhc3Npbmc7CiAgICAgICAgICAgIGNvbnN0IHByZXZOb3RlU2Vjb25kc1N0YXJ0ID0gdGhpcy5wcmV2Tm90ZVNlY29uZHNFbmQ7CiAgICAgICAgICAgIGNvbnN0IHByZXZOb3RlU2Vjb25kc0VuZCA9IHByZXZOb3RlU2Vjb25kc1N0YXJ0ICsgc2Vjb25kc1Bhc3Npbmc7CiAgICAgICAgICAgIGNvbnN0IHByZXZOb3RlVGlja3NTdGFydCA9IHRoaXMucHJldk5vdGVUaWNrc0VuZDsKICAgICAgICAgICAgY29uc3QgcHJldk5vdGVUaWNrc0VuZCA9IHByZXZOb3RlVGlja3NTdGFydCArIHRpY2tzUGFzc2luZzsKICAgICAgICAgICAgY29uc3QgYmVhdHNQZXJUaWNrID0gMS4wIC8gKENvbmZpZy50aWNrc1BlclBhcnQgKiBDb25maWcucGFydHNQZXJCZWF0KTsKICAgICAgICAgICAgY29uc3QgYmVhdFRpbWVTdGFydCA9IGJlYXRzUGVyVGljayAqIHRpY2tUaW1lU3RhcnQ7CiAgICAgICAgICAgIGNvbnN0IGJlYXRUaW1lRW5kID0gYmVhdHNQZXJUaWNrICogdGlja1RpbWVFbmQ7CiAgICAgICAgICAgIGxldCBub3RlU2l6ZVN0YXJ0ID0gdGhpcy5fbm90ZVNpemVGaW5hbDsKICAgICAgICAgICAgbGV0IG5vdGVTaXplRW5kID0gdGhpcy5fbm90ZVNpemVGaW5hbDsKICAgICAgICAgICAgbGV0IHByZXZOb3RlU2l6ZSA9IHRoaXMuX3ByZXZOb3RlU2l6ZUZpbmFsOwogICAgICAgICAgICBsZXQgbmV4dE5vdGVTaXplID0gMDsKICAgICAgICAgICAgbGV0IHByZXZTbGlkZVN0YXJ0ID0gZmFsc2U7CiAgICAgICAgICAgIGxldCBwcmV2U2xpZGVFbmQgPSBmYWxzZTsKICAgICAgICAgICAgbGV0IG5leHRTbGlkZVN0YXJ0ID0gZmFsc2U7CiAgICAgICAgICAgIGxldCBuZXh0U2xpZGVFbmQgPSBmYWxzZTsKICAgICAgICAgICAgbGV0IHByZXZTbGlkZVJhdGlvU3RhcnQgPSAwLjA7CiAgICAgICAgICAgIGxldCBwcmV2U2xpZGVSYXRpb0VuZCA9IDAuMDsKICAgICAgICAgICAgbGV0IG5leHRTbGlkZVJhdGlvU3RhcnQgPSAwLjA7CiAgICAgICAgICAgIGxldCBuZXh0U2xpZGVSYXRpb0VuZCA9IDAuMDsKICAgICAgICAgICAgaWYgKHRvbmUgIT0gbnVsbCAmJiB0b25lLm5vdGUgIT0gbnVsbCAmJiAhdG9uZS5wYXNzZWRFbmRPZk5vdGUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGVuZFBpbkluZGV4ID0gdG9uZS5ub3RlLmdldEVuZFBpbkluZGV4KGN1cnJlbnRQYXJ0KTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0UGluID0gdG9uZS5ub3RlLnBpbnNbZW5kUGluSW5kZXggLSAxXTsKICAgICAgICAgICAgICAgIGNvbnN0IGVuZFBpbiA9IHRvbmUubm90ZS5waW5zW2VuZFBpbkluZGV4XTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0UGluVGljayA9ICh0b25lLm5vdGUuc3RhcnQgKyBzdGFydFBpbi50aW1lKSAqIENvbmZpZy50aWNrc1BlclBhcnQ7CiAgICAgICAgICAgICAgICBjb25zdCBlbmRQaW5UaWNrID0gKHRvbmUubm90ZS5zdGFydCArIGVuZFBpbi50aW1lKSAqIENvbmZpZy50aWNrc1BlclBhcnQ7CiAgICAgICAgICAgICAgICBjb25zdCByYXRpb1N0YXJ0ID0gKHRpY2tUaW1lU3RhcnQgLSBzdGFydFBpblRpY2spIC8gKGVuZFBpblRpY2sgLSBzdGFydFBpblRpY2spOwogICAgICAgICAgICAgICAgY29uc3QgcmF0aW9FbmQgPSAodGlja1RpbWVFbmQgLSBzdGFydFBpblRpY2spIC8gKGVuZFBpblRpY2sgLSBzdGFydFBpblRpY2spOwogICAgICAgICAgICAgICAgbm90ZVNpemVTdGFydCA9IHN0YXJ0UGluLnNpemUgKyAoZW5kUGluLnNpemUgLSBzdGFydFBpbi5zaXplKSAqIHJhdGlvU3RhcnQ7CiAgICAgICAgICAgICAgICBub3RlU2l6ZUVuZCA9IHN0YXJ0UGluLnNpemUgKyAoZW5kUGluLnNpemUgLSBzdGFydFBpbi5zaXplKSAqIHJhdGlvRW5kOwogICAgICAgICAgICAgICAgaWYgKHRyYW5zaXRpb24uc2xpZGVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm90ZVN0YXJ0VGljayA9IHRvbmUubm90ZVN0YXJ0UGFydCAqIENvbmZpZy50aWNrc1BlclBhcnQ7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm90ZUVuZFRpY2sgPSB0b25lLm5vdGVFbmRQYXJ0ICogQ29uZmlnLnRpY2tzUGVyUGFydDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBub3RlTGVuZ3RoVGlja3MgPSBub3RlRW5kVGljayAtIG5vdGVTdGFydFRpY2s7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF4aW11bVNsaWRlVGlja3MgPSBub3RlTGVuZ3RoVGlja3MgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2xpZGVUaWNrcyA9IE1hdGgubWluKG1heGltdW1TbGlkZVRpY2tzLCB0cmFuc2l0aW9uLnNsaWRlVGlja3MpOwogICAgICAgICAgICAgICAgICAgIGlmICh0b25lLnByZXZOb3RlICE9IG51bGwgJiYgIXRvbmUuZm9yY2VDb250aW51ZUF0U3RhcnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRpY2tUaW1lU3RhcnQgLSBub3RlU3RhcnRUaWNrIDwgc2xpZGVUaWNrcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldlNsaWRlU3RhcnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldlNsaWRlUmF0aW9TdGFydCA9IDAuNSAqICgxLjAgLSAodGlja1RpbWVTdGFydCAtIG5vdGVTdGFydFRpY2spIC8gc2xpZGVUaWNrcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRpY2tUaW1lRW5kIC0gbm90ZVN0YXJ0VGljayA8IHNsaWRlVGlja3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZTbGlkZUVuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2U2xpZGVSYXRpb0VuZCA9IDAuNSAqICgxLjAgLSAodGlja1RpbWVFbmQgLSBub3RlU3RhcnRUaWNrKSAvIHNsaWRlVGlja3MpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0b25lLm5leHROb3RlICE9IG51bGwgJiYgIXRvbmUuZm9yY2VDb250aW51ZUF0RW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5leHROb3RlU2l6ZSA9IHRvbmUubmV4dE5vdGUucGluc1swXS5zaXplOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobm90ZUVuZFRpY2sgLSB0aWNrVGltZVN0YXJ0IDwgc2xpZGVUaWNrcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dFNsaWRlU3RhcnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dFNsaWRlUmF0aW9TdGFydCA9IDAuNSAqICgxLjAgLSAobm90ZUVuZFRpY2sgLSB0aWNrVGltZVN0YXJ0KSAvIHNsaWRlVGlja3MpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub3RlRW5kVGljayAtIHRpY2tUaW1lRW5kIDwgc2xpZGVUaWNrcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dFNsaWRlRW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRTbGlkZVJhdGlvRW5kID0gMC41ICogKDEuMCAtIChub3RlRW5kVGljayAtIHRpY2tUaW1lRW5kKSAvIHNsaWRlVGlja3MpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBsb3dwYXNzQ3V0b2ZmRGVjYXlWb2x1bWVDb21wZW5zYXRpb24gPSAxLjA7CiAgICAgICAgICAgIGxldCB1c2VkTm90ZVNpemUgPSBmYWxzZTsKICAgICAgICAgICAgZm9yIChsZXQgZW52ZWxvcGVJbmRleCA9IDA7IGVudmVsb3BlSW5kZXggPD0gaW5zdHJ1bWVudC5lbnZlbG9wZUNvdW50OyBlbnZlbG9wZUluZGV4KyspIHsKICAgICAgICAgICAgICAgIGxldCBhdXRvbWF0aW9uVGFyZ2V0OwogICAgICAgICAgICAgICAgbGV0IHRhcmdldEluZGV4OwogICAgICAgICAgICAgICAgbGV0IGVudmVsb3BlOwogICAgICAgICAgICAgICAgaWYgKGVudmVsb3BlSW5kZXggPT0gaW5zdHJ1bWVudC5lbnZlbG9wZUNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHVzZWROb3RlU2l6ZSkKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgYXV0b21hdGlvblRhcmdldCA9IENvbmZpZy5pbnN0cnVtZW50QXV0b21hdGlvblRhcmdldHMuZGljdGlvbmFyeVsibm90ZVZvbHVtZSJdOwogICAgICAgICAgICAgICAgICAgIHRhcmdldEluZGV4ID0gMDsKICAgICAgICAgICAgICAgICAgICBlbnZlbG9wZSA9IENvbmZpZy5lbnZlbG9wZXMuZGljdGlvbmFyeVsibm90ZSBzaXplIl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgZW52ZWxvcGVTZXR0aW5ncyA9IGluc3RydW1lbnQuZW52ZWxvcGVzW2VudmVsb3BlSW5kZXhdOwogICAgICAgICAgICAgICAgICAgIGF1dG9tYXRpb25UYXJnZXQgPSBDb25maWcuaW5zdHJ1bWVudEF1dG9tYXRpb25UYXJnZXRzW2VudmVsb3BlU2V0dGluZ3MudGFyZ2V0XTsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRJbmRleCA9IGVudmVsb3BlU2V0dGluZ3MuaW5kZXg7CiAgICAgICAgICAgICAgICAgICAgZW52ZWxvcGUgPSBDb25maWcuZW52ZWxvcGVzW2VudmVsb3BlU2V0dGluZ3MuZW52ZWxvcGVdOwogICAgICAgICAgICAgICAgICAgIGlmIChlbnZlbG9wZS50eXBlID09IDApCiAgICAgICAgICAgICAgICAgICAgICAgIHVzZWROb3RlU2l6ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoYXV0b21hdGlvblRhcmdldC5jb21wdXRlSW5kZXggIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbXB1dGVJbmRleCA9IGF1dG9tYXRpb25UYXJnZXQuY29tcHV0ZUluZGV4ICsgdGFyZ2V0SW5kZXg7CiAgICAgICAgICAgICAgICAgICAgbGV0IGVudmVsb3BlU3RhcnQgPSBFbnZlbG9wZUNvbXB1dGVyLmNvbXB1dGVFbnZlbG9wZShlbnZlbG9wZSwgbm90ZVNlY29uZHNTdGFydCwgYmVhdFRpbWVTdGFydCwgbm90ZVNpemVTdGFydCk7CiAgICAgICAgICAgICAgICAgICAgbGV0IGVudmVsb3BlRW5kID0gRW52ZWxvcGVDb21wdXRlci5jb21wdXRlRW52ZWxvcGUoZW52ZWxvcGUsIG5vdGVTZWNvbmRzRW5kLCBiZWF0VGltZUVuZCwgbm90ZVNpemVFbmQpOwogICAgICAgICAgICAgICAgICAgIGlmIChwcmV2U2xpZGVTdGFydCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvdGhlciA9IEVudmVsb3BlQ29tcHV0ZXIuY29tcHV0ZUVudmVsb3BlKGVudmVsb3BlLCBwcmV2Tm90ZVNlY29uZHNTdGFydCwgYmVhdFRpbWVTdGFydCwgcHJldk5vdGVTaXplKTsKICAgICAgICAgICAgICAgICAgICAgICAgZW52ZWxvcGVTdGFydCArPSAob3RoZXIgLSBlbnZlbG9wZVN0YXJ0KSAqIHByZXZTbGlkZVJhdGlvU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChwcmV2U2xpZGVFbmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3RoZXIgPSBFbnZlbG9wZUNvbXB1dGVyLmNvbXB1dGVFbnZlbG9wZShlbnZlbG9wZSwgcHJldk5vdGVTZWNvbmRzRW5kLCBiZWF0VGltZUVuZCwgcHJldk5vdGVTaXplKTsKICAgICAgICAgICAgICAgICAgICAgICAgZW52ZWxvcGVFbmQgKz0gKG90aGVyIC0gZW52ZWxvcGVFbmQpICogcHJldlNsaWRlUmF0aW9FbmQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChuZXh0U2xpZGVTdGFydCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvdGhlciA9IEVudmVsb3BlQ29tcHV0ZXIuY29tcHV0ZUVudmVsb3BlKGVudmVsb3BlLCAwLjAsIGJlYXRUaW1lU3RhcnQsIG5leHROb3RlU2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudmVsb3BlU3RhcnQgKz0gKG90aGVyIC0gZW52ZWxvcGVTdGFydCkgKiBuZXh0U2xpZGVSYXRpb1N0YXJ0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAobmV4dFNsaWRlRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG90aGVyID0gRW52ZWxvcGVDb21wdXRlci5jb21wdXRlRW52ZWxvcGUoZW52ZWxvcGUsIDAuMCwgYmVhdFRpbWVFbmQsIG5leHROb3RlU2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGVudmVsb3BlRW5kICs9IChvdGhlciAtIGVudmVsb3BlRW5kKSAqIG5leHRTbGlkZVJhdGlvRW5kOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmVudmVsb3BlU3RhcnRzW2NvbXB1dGVJbmRleF0gKj0gZW52ZWxvcGVTdGFydDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVudmVsb3BlRW5kc1tjb21wdXRlSW5kZXhdICo9IGVudmVsb3BlRW5kOwogICAgICAgICAgICAgICAgICAgIGlmIChhdXRvbWF0aW9uVGFyZ2V0LmlzRmlsdGVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlclNldHRpbmdzID0gaW5zdHJ1bWVudC5ub3RlRmlsdGVyOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmlsdGVyU2V0dGluZ3MuY29udHJvbFBvaW50Q291bnQgPiB0YXJnZXRJbmRleCAmJiBmaWx0ZXJTZXR0aW5ncy5jb250cm9sUG9pbnRzW3RhcmdldEluZGV4XS50eXBlID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvd3Bhc3NDdXRvZmZEZWNheVZvbHVtZUNvbXBlbnNhdGlvbiA9IE1hdGgubWF4KGxvd3Bhc3NDdXRvZmZEZWNheVZvbHVtZUNvbXBlbnNhdGlvbiwgRW52ZWxvcGVDb21wdXRlci5nZXRMb3dwYXNzQ3V0b2ZmRGVjYXlWb2x1bWVDb21wZW5zYXRpb24oZW52ZWxvcGUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm5vdGVTZWNvbmRzU3RhcnQgPSBub3RlU2Vjb25kc1N0YXJ0OwogICAgICAgICAgICB0aGlzLm5vdGVTZWNvbmRzRW5kID0gbm90ZVNlY29uZHNFbmQ7CiAgICAgICAgICAgIHRoaXMubm90ZVRpY2tzU3RhcnQgPSBub3RlVGlja3NTdGFydDsKICAgICAgICAgICAgdGhpcy5ub3RlVGlja3NFbmQgPSBub3RlVGlja3NFbmQ7CiAgICAgICAgICAgIHRoaXMucHJldk5vdGVTZWNvbmRzU3RhcnQgPSBwcmV2Tm90ZVNlY29uZHNTdGFydDsKICAgICAgICAgICAgdGhpcy5wcmV2Tm90ZVNlY29uZHNFbmQgPSBwcmV2Tm90ZVNlY29uZHNFbmQ7CiAgICAgICAgICAgIHRoaXMucHJldk5vdGVUaWNrc1N0YXJ0ID0gcHJldk5vdGVUaWNrc1N0YXJ0OwogICAgICAgICAgICB0aGlzLnByZXZOb3RlVGlja3NFbmQgPSBwcmV2Tm90ZVRpY2tzRW5kOwogICAgICAgICAgICB0aGlzLnByZXZOb3RlU2l6ZSA9IHByZXZOb3RlU2l6ZTsKICAgICAgICAgICAgdGhpcy5uZXh0Tm90ZVNpemUgPSBuZXh0Tm90ZVNpemU7CiAgICAgICAgICAgIHRoaXMubm90ZVNpemVTdGFydCA9IG5vdGVTaXplU3RhcnQ7CiAgICAgICAgICAgIHRoaXMubm90ZVNpemVFbmQgPSBub3RlU2l6ZUVuZDsKICAgICAgICAgICAgdGhpcy5wcmV2U2xpZGVTdGFydCA9IHByZXZTbGlkZVN0YXJ0OwogICAgICAgICAgICB0aGlzLnByZXZTbGlkZUVuZCA9IHByZXZTbGlkZUVuZDsKICAgICAgICAgICAgdGhpcy5uZXh0U2xpZGVTdGFydCA9IG5leHRTbGlkZVN0YXJ0OwogICAgICAgICAgICB0aGlzLm5leHRTbGlkZUVuZCA9IG5leHRTbGlkZUVuZDsKICAgICAgICAgICAgdGhpcy5wcmV2U2xpZGVSYXRpb1N0YXJ0ID0gcHJldlNsaWRlUmF0aW9TdGFydDsKICAgICAgICAgICAgdGhpcy5wcmV2U2xpZGVSYXRpb0VuZCA9IHByZXZTbGlkZVJhdGlvRW5kOwogICAgICAgICAgICB0aGlzLm5leHRTbGlkZVJhdGlvU3RhcnQgPSBuZXh0U2xpZGVSYXRpb1N0YXJ0OwogICAgICAgICAgICB0aGlzLm5leHRTbGlkZVJhdGlvRW5kID0gbmV4dFNsaWRlUmF0aW9FbmQ7CiAgICAgICAgICAgIHRoaXMubG93cGFzc0N1dG9mZkRlY2F5Vm9sdW1lQ29tcGVuc2F0aW9uID0gbG93cGFzc0N1dG9mZkRlY2F5Vm9sdW1lQ29tcGVuc2F0aW9uOwogICAgICAgIH0KICAgICAgICBjbGVhckVudmVsb3BlcyhpbnN0cnVtZW50KSB7CiAgICAgICAgICAgIGZvciAobGV0IGVudmVsb3BlSW5kZXggPSAwOyBlbnZlbG9wZUluZGV4IDwgaW5zdHJ1bWVudC5lbnZlbG9wZUNvdW50OyBlbnZlbG9wZUluZGV4KyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGVudmVsb3BlU2V0dGluZ3MgPSBpbnN0cnVtZW50LmVudmVsb3Blc1tlbnZlbG9wZUluZGV4XTsKICAgICAgICAgICAgICAgIGNvbnN0IGF1dG9tYXRpb25UYXJnZXQgPSBDb25maWcuaW5zdHJ1bWVudEF1dG9tYXRpb25UYXJnZXRzW2VudmVsb3BlU2V0dGluZ3MudGFyZ2V0XTsKICAgICAgICAgICAgICAgIGlmIChhdXRvbWF0aW9uVGFyZ2V0LmNvbXB1dGVJbmRleCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tcHV0ZUluZGV4ID0gYXV0b21hdGlvblRhcmdldC5jb21wdXRlSW5kZXggKyBlbnZlbG9wZVNldHRpbmdzLmluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMuZW52ZWxvcGVTdGFydHNbY29tcHV0ZUluZGV4XSA9IDEuMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVudmVsb3BlRW5kc1tjb21wdXRlSW5kZXhdID0gMS4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZW52ZWxvcGVTdGFydHNbMF0gPSAxLjA7CiAgICAgICAgICAgIHRoaXMuZW52ZWxvcGVFbmRzWzBdID0gMS4wOwogICAgICAgIH0KICAgICAgICBzdGF0aWMgY29tcHV0ZUVudmVsb3BlKGVudmVsb3BlLCB0aW1lLCBiZWF0cywgbm90ZVNpemUpIHsKICAgICAgICAgICAgc3dpdGNoIChlbnZlbG9wZS50eXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlIDA6IHJldHVybiBTeW50aC5ub3RlU2l6ZVRvVm9sdW1lTXVsdChub3RlU2l6ZSk7CiAgICAgICAgICAgICAgICBjYXNlIDE6IHJldHVybiAxLjA7CiAgICAgICAgICAgICAgICBjYXNlIDQ6IHJldHVybiAxLjAgLyAoMS4wICsgdGltZSAqIGVudmVsb3BlLnNwZWVkKTsKICAgICAgICAgICAgICAgIGNhc2UgNTogcmV0dXJuIDEuMCAtIDEuMCAvICgxLjAgKyB0aW1lICogZW52ZWxvcGUuc3BlZWQpOwogICAgICAgICAgICAgICAgY2FzZSA2OiByZXR1cm4gMC41IC0gTWF0aC5jb3MoYmVhdHMgKiAyLjAgKiBNYXRoLlBJICogZW52ZWxvcGUuc3BlZWQpICogMC41OwogICAgICAgICAgICAgICAgY2FzZSA3OiByZXR1cm4gMC43NSAtIE1hdGguY29zKGJlYXRzICogMi4wICogTWF0aC5QSSAqIGVudmVsb3BlLnNwZWVkKSAqIDAuMjU7CiAgICAgICAgICAgICAgICBjYXNlIDI6IHJldHVybiBNYXRoLm1heCgxLjAsIDIuMCAtIHRpbWUgKiAxMC4wKTsKICAgICAgICAgICAgICAgIGNhc2UgMzoKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRhY2sgPSAwLjI1IC8gTWF0aC5zcXJ0KGVudmVsb3BlLnNwZWVkKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGltZSA8IGF0dGFjayA/IHRpbWUgLyBhdHRhY2sgOiAxLjAgLyAoMS4wICsgKHRpbWUgLSBhdHRhY2spICogZW52ZWxvcGUuc3BlZWQpOwogICAgICAgICAgICAgICAgY2FzZSA4OiByZXR1cm4gTWF0aC5wb3coMiwgLWVudmVsb3BlLnNwZWVkICogdGltZSk7CiAgICAgICAgICAgICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgRXJyb3IoIlVucmVjb2duaXplZCBvcGVyYXRvciBlbnZlbG9wZSB0eXBlLiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBnZXRMb3dwYXNzQ3V0b2ZmRGVjYXlWb2x1bWVDb21wZW5zYXRpb24oZW52ZWxvcGUpIHsKICAgICAgICAgICAgaWYgKGVudmVsb3BlLnR5cGUgPT0gOCkKICAgICAgICAgICAgICAgIHJldHVybiAxLjI1ICsgMC4wMjUgKiBlbnZlbG9wZS5zcGVlZDsKICAgICAgICAgICAgaWYgKGVudmVsb3BlLnR5cGUgPT0gNCkKICAgICAgICAgICAgICAgIHJldHVybiAxLjAgKyAwLjAyICogZW52ZWxvcGUuc3BlZWQ7CiAgICAgICAgICAgIHJldHVybiAxLjA7CiAgICAgICAgfQogICAgfQogICAgY2xhc3MgVG9uZSB7CiAgICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgICAgIHRoaXMucGl0Y2hlcyA9IEFycmF5KENvbmZpZy5tYXhDaG9yZFNpemUpLmZpbGwoMCk7CiAgICAgICAgICAgIHRoaXMucGl0Y2hDb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMuY2hvcmRTaXplID0gMDsKICAgICAgICAgICAgdGhpcy5kcnVtc2V0UGl0Y2ggPSBudWxsOwogICAgICAgICAgICB0aGlzLm5vdGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLnByZXZOb3RlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5uZXh0Tm90ZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucHJldk5vdGVQaXRjaEluZGV4ID0gMDsKICAgICAgICAgICAgdGhpcy5uZXh0Tm90ZVBpdGNoSW5kZXggPSAwOwogICAgICAgICAgICB0aGlzLmZyZXNobHlBbGxvY2F0ZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmF0Tm90ZVN0YXJ0ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuaXNPbkxhc3RUaWNrID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMucGFzc2VkRW5kT2ZOb3RlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZm9yY2VDb250aW51ZUF0U3RhcnQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5mb3JjZUNvbnRpbnVlQXRFbmQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5ub3RlU3RhcnRQYXJ0ID0gMDsKICAgICAgICAgICAgdGhpcy5ub3RlRW5kUGFydCA9IDA7CiAgICAgICAgICAgIHRoaXMudGlja3NTaW5jZVJlbGVhc2VkID0gMDsKICAgICAgICAgICAgdGhpcy5saXZlSW5wdXRTYW1wbGVzSGVsZCA9IDA7CiAgICAgICAgICAgIHRoaXMubGFzdEludGVydmFsID0gMDsKICAgICAgICAgICAgdGhpcy5zYW1wbGUgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucGhhc2VzID0gW107CiAgICAgICAgICAgIHRoaXMucGhhc2VEZWx0YXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5leHByZXNzaW9uU3RhcnRzID0gW107CiAgICAgICAgICAgIHRoaXMuZXhwcmVzc2lvbkRlbHRhcyA9IFtdOwogICAgICAgICAgICB0aGlzLnBoYXNlRGVsdGFTY2FsZXMgPSBbXTsKICAgICAgICAgICAgdGhpcy5wcmV2VmlicmF0byA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucHVsc2VXaWR0aCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5wdWxzZVdpZHRoRGVsdGEgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucGlja2VkU3RyaW5ncyA9IFtdOwogICAgICAgICAgICB0aGlzLm5vdGVGaWx0ZXJzID0gW107CiAgICAgICAgICAgIHRoaXMubm90ZUZpbHRlckNvdW50ID0gMDsKICAgICAgICAgICAgdGhpcy5pbml0aWFsTm90ZUZpbHRlcklucHV0MSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5pbml0aWFsTm90ZUZpbHRlcklucHV0MiA9IDAuMDsKICAgICAgICAgICAgdGhpcy5zcGVjaWFsSW50ZXJ2YWxNdWx0ID0gMC4wOwogICAgICAgICAgICB0aGlzLnNwZWNpYWxJbnRlcnZhbEV4cHJlc3Npb25NdWx0ID0gMS4wOwogICAgICAgICAgICB0aGlzLmZlZWRiYWNrT3V0cHV0cyA9IFtdOwogICAgICAgICAgICB0aGlzLmZlZWRiYWNrTXVsdCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5mZWVkYmFja0RlbHRhID0gMC4wOwogICAgICAgICAgICB0aGlzLmVudmVsb3BlQ29tcHV0ZXIgPSBuZXcgRW52ZWxvcGVDb21wdXRlcigpOwogICAgICAgICAgICB0aGlzLnJlc2V0KCk7CiAgICAgICAgfQogICAgICAgIHJlc2V0KCkgewogICAgICAgICAgICB0aGlzLnNhbXBsZSA9IDAuMDsKICAgICAgICAgICAgY29uc3QgbWF4V2F2ZXMgPSBNYXRoLm1heChDb25maWcubWF4Q2hvcmRTaXplLCBDb25maWcub3BlcmF0b3JDb3VudCk7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWF4V2F2ZXM7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5waGFzZXNbaV0gPSAwLjA7CiAgICAgICAgICAgICAgICB0aGlzLmZlZWRiYWNrT3V0cHV0c1tpXSA9IDAuMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMubm90ZUZpbHRlckNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgIHRoaXMubm90ZUZpbHRlcnNbaV0ucmVzZXRPdXRwdXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLm5vdGVGaWx0ZXJDb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDEgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDIgPSAwLjA7CiAgICAgICAgICAgIHRoaXMubGl2ZUlucHV0U2FtcGxlc0hlbGQgPSAwOwogICAgICAgICAgICBmb3IgKGNvbnN0IHBpY2tlZFN0cmluZyBvZiB0aGlzLnBpY2tlZFN0cmluZ3MpIHsKICAgICAgICAgICAgICAgIHBpY2tlZFN0cmluZy5yZXNldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZW52ZWxvcGVDb21wdXRlci5yZXNldCgpOwogICAgICAgICAgICB0aGlzLnByZXZWaWJyYXRvID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5kcnVtc2V0UGl0Y2ggPSBudWxsOwogICAgICAgIH0KICAgIH0KICAgIGNsYXNzIEluc3RydW1lbnRTdGF0ZSB7CiAgICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgICAgIHRoaXMuYXdha2UgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jb21wdXRlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnRvbmVzQWRkZWRJblRoaXNUaWNrID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZmx1c2hpbmdEZWxheUxpbmVzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZGVhY3RpdmF0ZUFmdGVyVGhpc1RpY2sgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5hdHRlbnR1YXRpb25Qcm9ncmVzcyA9IDAuMDsKICAgICAgICAgICAgdGhpcy5mbHVzaGVkU2FtcGxlcyA9IDA7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlVG9uZXMgPSBuZXcgRGVxdWUoKTsKICAgICAgICAgICAgdGhpcy5yZWxlYXNlZFRvbmVzID0gbmV3IERlcXVlKCk7CiAgICAgICAgICAgIHRoaXMubGl2ZUlucHV0VG9uZXMgPSBuZXcgRGVxdWUoKTsKICAgICAgICAgICAgdGhpcy5lcUZpbHRlclZvbHVtZVN0YXJ0ID0gMS4wOwogICAgICAgICAgICB0aGlzLmVxRmlsdGVyVm9sdW1lRGVsdGEgPSAwLjA7CiAgICAgICAgICAgIHRoaXMubWl4Vm9sdW1lU3RhcnQgPSAxLjA7CiAgICAgICAgICAgIHRoaXMubWl4Vm9sdW1lRGVsdGEgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZGVsYXlJbnB1dE11bHRTdGFydCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5kZWxheUlucHV0TXVsdERlbHRhID0gMC4wOwogICAgICAgICAgICB0aGlzLmRpc3RvcnRpb25TdGFydCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5kaXN0b3J0aW9uRW5kID0gMC4wOwogICAgICAgICAgICB0aGlzLmRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQxID0gMC4wOwogICAgICAgICAgICB0aGlzLmRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQyID0gMC4wOwogICAgICAgICAgICB0aGlzLmRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQzID0gMC4wOwogICAgICAgICAgICB0aGlzLmRpc3RvcnRpb25QcmV2SW5wdXQgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZGlzdG9ydGlvbk5leHRPdXRwdXQgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuYml0Y3J1c2hlclByZXZJbnB1dCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5iaXRjcnVzaGVyQ3VycmVudE91dHB1dCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5iaXRjcnVzaGVyUGhhc2UgPSAxLjA7CiAgICAgICAgICAgIHRoaXMuYml0Y3J1c2hlclBoYXNlRGVsdGEgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuYml0Y3J1c2hlclBoYXNlRGVsdGFTY2FsZSA9IDEuMDsKICAgICAgICAgICAgdGhpcy5iaXRjcnVzaGVyU2NhbGUgPSAxLjA7CiAgICAgICAgICAgIHRoaXMuYml0Y3J1c2hlclNjYWxlU2NhbGUgPSAxLjA7CiAgICAgICAgICAgIHRoaXMuYml0Y3J1c2hlckZvbGRMZXZlbCA9IDEuMDsKICAgICAgICAgICAgdGhpcy5iaXRjcnVzaGVyRm9sZExldmVsU2NhbGUgPSAxLjA7CiAgICAgICAgICAgIHRoaXMuZXFGaWx0ZXJzID0gW107CiAgICAgICAgICAgIHRoaXMuZXFGaWx0ZXJDb3VudCA9IDA7CiAgICAgICAgICAgIHRoaXMuaW5pdGlhbEVxRmlsdGVySW5wdXQxID0gMC4wOwogICAgICAgICAgICB0aGlzLmluaXRpYWxFcUZpbHRlcklucHV0MiA9IDAuMDsKICAgICAgICAgICAgdGhpcy5wYW5uaW5nRGVsYXlMaW5lID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5wYW5uaW5nRGVsYXlQb3MgPSAwOwogICAgICAgICAgICB0aGlzLnBhbm5pbmdWb2x1bWVTdGFydEwgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucGFubmluZ1ZvbHVtZVN0YXJ0UiA9IDAuMDsKICAgICAgICAgICAgdGhpcy5wYW5uaW5nVm9sdW1lRGVsdGFMID0gMC4wOwogICAgICAgICAgICB0aGlzLnBhbm5pbmdWb2x1bWVEZWx0YVIgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucGFubmluZ09mZnNldFN0YXJ0TCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5wYW5uaW5nT2Zmc2V0U3RhcnRSID0gMC4wOwogICAgICAgICAgICB0aGlzLnBhbm5pbmdPZmZzZXREZWx0YUwgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucGFubmluZ09mZnNldERlbHRhUiA9IDAuMDsKICAgICAgICAgICAgdGhpcy5jaG9ydXNEZWxheUxpbmVMID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jaG9ydXNEZWxheUxpbmVSID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5jaG9ydXNEZWxheUxpbmVEaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNob3J1c0RlbGF5UG9zID0gMDsKICAgICAgICAgICAgdGhpcy5jaG9ydXNQaGFzZSA9IDA7CiAgICAgICAgICAgIHRoaXMuY2hvcnVzU3RhcnQgPSAwOwogICAgICAgICAgICB0aGlzLmNob3J1c0VuZCA9IDA7CiAgICAgICAgICAgIHRoaXMuZWNob0RlbGF5TGluZUwgPSBudWxsOwogICAgICAgICAgICB0aGlzLmVjaG9EZWxheUxpbmVSID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5lY2hvRGVsYXlMaW5lRGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lY2hvRGVsYXlQb3MgPSAwOwogICAgICAgICAgICB0aGlzLmVjaG9EZWxheU9mZnNldFN0YXJ0ID0gMDsKICAgICAgICAgICAgdGhpcy5lY2hvRGVsYXlPZmZzZXRFbmQgPSAwOwogICAgICAgICAgICB0aGlzLmVjaG9EZWxheU9mZnNldExhc3RUaWNrID0gMDsKICAgICAgICAgICAgdGhpcy5lY2hvRGVsYXlPZmZzZXRSYXRpbyA9IDAuMDsKICAgICAgICAgICAgdGhpcy5lY2hvRGVsYXlPZmZzZXRSYXRpb0RlbHRhID0gMC4wOwogICAgICAgICAgICB0aGlzLmVjaG9EZWxheU9mZnNldExhc3RUaWNrSXNDb21wdXRlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVjaG9NdWx0U3RhcnQgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZWNob011bHREZWx0YSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5lY2hvU2hlbGZBMSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5lY2hvU2hlbGZCMCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5lY2hvU2hlbGZCMSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5lY2hvU2hlbGZTYW1wbGVMID0gMC4wOwogICAgICAgICAgICB0aGlzLmVjaG9TaGVsZlNhbXBsZVIgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZWNob1NoZWxmUHJldklucHV0TCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5lY2hvU2hlbGZQcmV2SW5wdXRSID0gMC4wOwogICAgICAgICAgICB0aGlzLnJldmVyYkRlbGF5TGluZSA9IG51bGw7CiAgICAgICAgICAgIHRoaXMucmV2ZXJiRGVsYXlMaW5lRGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5yZXZlcmJEZWxheVBvcyA9IDA7CiAgICAgICAgICAgIHRoaXMucmV2ZXJiTXVsdFN0YXJ0ID0gMC4wOwogICAgICAgICAgICB0aGlzLnJldmVyYk11bHREZWx0YSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5yZXZlcmJTaGVsZkExID0gMC4wOwogICAgICAgICAgICB0aGlzLnJldmVyYlNoZWxmQjAgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucmV2ZXJiU2hlbGZCMSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5yZXZlcmJTaGVsZlNhbXBsZTAgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucmV2ZXJiU2hlbGZTYW1wbGUxID0gMC4wOwogICAgICAgICAgICB0aGlzLnJldmVyYlNoZWxmU2FtcGxlMiA9IDAuMDsKICAgICAgICAgICAgdGhpcy5yZXZlcmJTaGVsZlNhbXBsZTMgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucmV2ZXJiU2hlbGZQcmV2SW5wdXQwID0gMC4wOwogICAgICAgICAgICB0aGlzLnJldmVyYlNoZWxmUHJldklucHV0MSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5yZXZlcmJTaGVsZlByZXZJbnB1dDIgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucmV2ZXJiU2hlbGZQcmV2SW5wdXQzID0gMC4wOwogICAgICAgIH0KICAgICAgICBhbGxvY2F0ZU5lY2Vzc2FyeUJ1ZmZlcnMoc3ludGgsIGluc3RydW1lbnQsIHNhbXBsZXNQZXJUaWNrKSB7CiAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZVBhbm5pbmcoaW5zdHJ1bWVudC5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMucGFubmluZ0RlbGF5TGluZSA9PSBudWxsIHx8IHRoaXMucGFubmluZ0RlbGF5TGluZS5sZW5ndGggPCBzeW50aC5wYW5uaW5nRGVsYXlCdWZmZXJTaXplKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYW5uaW5nRGVsYXlMaW5lID0gbmV3IEZsb2F0MzJBcnJheShzeW50aC5wYW5uaW5nRGVsYXlCdWZmZXJTaXplKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVDaG9ydXMoaW5zdHJ1bWVudC5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hvcnVzRGVsYXlMaW5lTCA9PSBudWxsIHx8IHRoaXMuY2hvcnVzRGVsYXlMaW5lTC5sZW5ndGggPCBzeW50aC5jaG9ydXNEZWxheUJ1ZmZlclNpemUpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNob3J1c0RlbGF5TGluZUwgPSBuZXcgRmxvYXQzMkFycmF5KHN5bnRoLmNob3J1c0RlbGF5QnVmZmVyU2l6ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGhpcy5jaG9ydXNEZWxheUxpbmVSID09IG51bGwgfHwgdGhpcy5jaG9ydXNEZWxheUxpbmVSLmxlbmd0aCA8IHN5bnRoLmNob3J1c0RlbGF5QnVmZmVyU2l6ZSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hvcnVzRGVsYXlMaW5lUiA9IG5ldyBGbG9hdDMyQXJyYXkoc3ludGguY2hvcnVzRGVsYXlCdWZmZXJTaXplKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVFY2hvKGluc3RydW1lbnQuZWZmZWN0cykpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNhZmVFY2hvRGVsYXlTdGVwcyA9IE1hdGgubWF4KENvbmZpZy5lY2hvRGVsYXlSYW5nZSA+PiAxLCAoaW5zdHJ1bWVudC5lY2hvRGVsYXkgKyAxKSk7CiAgICAgICAgICAgICAgICBjb25zdCBiYXNlRWNob0RlbGF5QnVmZmVyU2l6ZSA9IFN5bnRoLmZpdHRpbmdQb3dlck9mVHdvKHNhZmVFY2hvRGVsYXlTdGVwcyAqIENvbmZpZy5lY2hvRGVsYXlTdGVwVGlja3MgKiBzYW1wbGVzUGVyVGljayk7CiAgICAgICAgICAgICAgICBjb25zdCBzYWZlRWNob0RlbGF5QnVmZmVyU2l6ZSA9IGJhc2VFY2hvRGVsYXlCdWZmZXJTaXplICogMjsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVjaG9EZWxheUxpbmVMID09IG51bGwgfHwgdGhpcy5lY2hvRGVsYXlMaW5lUiA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lY2hvRGVsYXlMaW5lTCA9IG5ldyBGbG9hdDMyQXJyYXkoc2FmZUVjaG9EZWxheUJ1ZmZlclNpemUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZWNob0RlbGF5TGluZVIgPSBuZXcgRmxvYXQzMkFycmF5KHNhZmVFY2hvRGVsYXlCdWZmZXJTaXplKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMuZWNob0RlbGF5TGluZUwubGVuZ3RoIDwgc2FmZUVjaG9EZWxheUJ1ZmZlclNpemUgfHwgdGhpcy5lY2hvRGVsYXlMaW5lUi5sZW5ndGggPCBzYWZlRWNob0RlbGF5QnVmZmVyU2l6ZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5ld0RlbGF5TGluZUwgPSBuZXcgRmxvYXQzMkFycmF5KHNhZmVFY2hvRGVsYXlCdWZmZXJTaXplKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdEZWxheUxpbmVSID0gbmV3IEZsb2F0MzJBcnJheShzYWZlRWNob0RlbGF5QnVmZmVyU2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2xkTWFzayA9IHRoaXMuZWNob0RlbGF5TGluZUwubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZWNob0RlbGF5TGluZUwubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGVsYXlMaW5lTFtpXSA9IHRoaXMuZWNob0RlbGF5TGluZUxbKHRoaXMuZWNob0RlbGF5UG9zICsgaSkgJiBvbGRNYXNrXTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGVsYXlMaW5lUltpXSA9IHRoaXMuZWNob0RlbGF5TGluZUxbKHRoaXMuZWNob0RlbGF5UG9zICsgaSkgJiBvbGRNYXNrXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lY2hvRGVsYXlQb3MgPSB0aGlzLmVjaG9EZWxheUxpbmVMLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVjaG9EZWxheUxpbmVMID0gbmV3RGVsYXlMaW5lTDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVjaG9EZWxheUxpbmVSID0gbmV3RGVsYXlMaW5lUjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoZWZmZWN0c0luY2x1ZGVSZXZlcmIoaW5zdHJ1bWVudC5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMucmV2ZXJiRGVsYXlMaW5lID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJldmVyYkRlbGF5TGluZSA9IG5ldyBGbG9hdDMyQXJyYXkoQ29uZmlnLnJldmVyYkRlbGF5QnVmZmVyU2l6ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZGVhY3RpdmF0ZSgpIHsKICAgICAgICAgICAgdGhpcy5iaXRjcnVzaGVyUHJldklucHV0ID0gMC4wOwogICAgICAgICAgICB0aGlzLmJpdGNydXNoZXJDdXJyZW50T3V0cHV0ID0gMC4wOwogICAgICAgICAgICB0aGlzLmJpdGNydXNoZXJQaGFzZSA9IDEuMDsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLmVxRmlsdGVyQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5lcUZpbHRlcnNbaV0ucmVzZXRPdXRwdXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmVxRmlsdGVyQ291bnQgPSAwOwogICAgICAgICAgICB0aGlzLmluaXRpYWxFcUZpbHRlcklucHV0MSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5pbml0aWFsRXFGaWx0ZXJJbnB1dDIgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZGlzdG9ydGlvbkZyYWN0aW9uYWxJbnB1dDEgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZGlzdG9ydGlvbkZyYWN0aW9uYWxJbnB1dDIgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZGlzdG9ydGlvbkZyYWN0aW9uYWxJbnB1dDMgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZGlzdG9ydGlvblByZXZJbnB1dCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5kaXN0b3J0aW9uTmV4dE91dHB1dCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5wYW5uaW5nRGVsYXlQb3MgPSAwOwogICAgICAgICAgICBpZiAodGhpcy5wYW5uaW5nRGVsYXlMaW5lICE9IG51bGwpCiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucGFubmluZ0RlbGF5TGluZS5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhbm5pbmdEZWxheUxpbmVbaV0gPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZWNob0RlbGF5T2Zmc2V0TGFzdFRpY2tJc0NvbXB1dGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZWNob1NoZWxmU2FtcGxlTCA9IDAuMDsKICAgICAgICAgICAgdGhpcy5lY2hvU2hlbGZTYW1wbGVSID0gMC4wOwogICAgICAgICAgICB0aGlzLmVjaG9TaGVsZlByZXZJbnB1dEwgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZWNob1NoZWxmUHJldklucHV0UiA9IDAuMDsKICAgICAgICAgICAgdGhpcy5yZXZlcmJTaGVsZlNhbXBsZTAgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucmV2ZXJiU2hlbGZTYW1wbGUxID0gMC4wOwogICAgICAgICAgICB0aGlzLnJldmVyYlNoZWxmU2FtcGxlMiA9IDAuMDsKICAgICAgICAgICAgdGhpcy5yZXZlcmJTaGVsZlNhbXBsZTMgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucmV2ZXJiU2hlbGZQcmV2SW5wdXQwID0gMC4wOwogICAgICAgICAgICB0aGlzLnJldmVyYlNoZWxmUHJldklucHV0MSA9IDAuMDsKICAgICAgICAgICAgdGhpcy5yZXZlcmJTaGVsZlByZXZJbnB1dDIgPSAwLjA7CiAgICAgICAgICAgIHRoaXMucmV2ZXJiU2hlbGZQcmV2SW5wdXQzID0gMC4wOwogICAgICAgICAgICB0aGlzLmF3YWtlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZmx1c2hpbmdEZWxheUxpbmVzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuZGVhY3RpdmF0ZUFmdGVyVGhpc1RpY2sgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5hdHRlbnR1YXRpb25Qcm9ncmVzcyA9IDAuMDsKICAgICAgICAgICAgdGhpcy5mbHVzaGVkU2FtcGxlcyA9IDA7CiAgICAgICAgfQogICAgICAgIHJlc2V0QWxsRWZmZWN0cygpIHsKICAgICAgICAgICAgdGhpcy5kZWFjdGl2YXRlKCk7CiAgICAgICAgICAgIGlmICh0aGlzLmNob3J1c0RlbGF5TGluZURpcnR5KSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY2hvcnVzRGVsYXlMaW5lTC5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB0aGlzLmNob3J1c0RlbGF5TGluZUxbaV0gPSAwLjA7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuY2hvcnVzRGVsYXlMaW5lUi5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB0aGlzLmNob3J1c0RlbGF5TGluZVJbaV0gPSAwLjA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuZWNob0RlbGF5TGluZURpcnR5KSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuZWNob0RlbGF5TGluZUwubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgdGhpcy5lY2hvRGVsYXlMaW5lTFtpXSA9IDAuMDsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5lY2hvRGVsYXlMaW5lUi5sZW5ndGg7IGkrKykKICAgICAgICAgICAgICAgICAgICB0aGlzLmVjaG9EZWxheUxpbmVSW2ldID0gMC4wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnJldmVyYkRlbGF5TGluZURpcnR5KSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMucmV2ZXJiRGVsYXlMaW5lLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICAgIHRoaXMucmV2ZXJiRGVsYXlMaW5lW2ldID0gMC4wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY2hvcnVzUGhhc2UgPSAwLjA7CiAgICAgICAgfQogICAgICAgIGNvbXB1dGUoc3ludGgsIGluc3RydW1lbnQsIHNhbXBsZXNQZXJUaWNrLCBydW5MZW5ndGgsIHRvbmUpIHsKICAgICAgICAgICAgdGhpcy5jb21wdXRlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuYWxsb2NhdGVOZWNlc3NhcnlCdWZmZXJzKHN5bnRoLCBpbnN0cnVtZW50LCBzYW1wbGVzUGVyVGljayk7CiAgICAgICAgICAgIGNvbnN0IHNhbXBsZXNQZXJTZWNvbmQgPSBzeW50aC5zYW1wbGVzUGVyU2Vjb25kOwogICAgICAgICAgICBjb25zdCB0aWNrU2FtcGxlQ291bnRkb3duID0gc3ludGgudGlja1NhbXBsZUNvdW50ZG93bjsKICAgICAgICAgICAgY29uc3QgdGlja1JlbWFpbmluZ1N0YXJ0ID0gKHRpY2tTYW1wbGVDb3VudGRvd24pIC8gc2FtcGxlc1BlclRpY2s7CiAgICAgICAgICAgIGNvbnN0IHRpY2tSZW1haW5pbmdFbmQgPSAodGlja1NhbXBsZUNvdW50ZG93biAtIHJ1bkxlbmd0aCkgLyBzYW1wbGVzUGVyVGljazsKICAgICAgICAgICAgY29uc3QgdXNlc0Rpc3RvcnRpb24gPSBlZmZlY3RzSW5jbHVkZURpc3RvcnRpb24oaW5zdHJ1bWVudC5lZmZlY3RzKTsKICAgICAgICAgICAgY29uc3QgdXNlc0JpdGNydXNoZXIgPSBlZmZlY3RzSW5jbHVkZUJpdGNydXNoZXIoaW5zdHJ1bWVudC5lZmZlY3RzKTsKICAgICAgICAgICAgY29uc3QgdXNlc1Bhbm5pbmcgPSBlZmZlY3RzSW5jbHVkZVBhbm5pbmcoaW5zdHJ1bWVudC5lZmZlY3RzKTsKICAgICAgICAgICAgY29uc3QgdXNlc0Nob3J1cyA9IGVmZmVjdHNJbmNsdWRlQ2hvcnVzKGluc3RydW1lbnQuZWZmZWN0cyk7CiAgICAgICAgICAgIGNvbnN0IHVzZXNFY2hvID0gZWZmZWN0c0luY2x1ZGVFY2hvKGluc3RydW1lbnQuZWZmZWN0cyk7CiAgICAgICAgICAgIGNvbnN0IHVzZXNSZXZlcmIgPSBlZmZlY3RzSW5jbHVkZVJldmVyYihpbnN0cnVtZW50LmVmZmVjdHMpOwogICAgICAgICAgICBpZiAodXNlc0Rpc3RvcnRpb24pIHsKICAgICAgICAgICAgICAgIHRoaXMuZGlzdG9ydGlvblN0YXJ0ID0gTWF0aC5taW4oMS4wLCBpbnN0cnVtZW50LmRpc3RvcnRpb24gLyAoQ29uZmlnLmRpc3RvcnRpb25SYW5nZSAtIDEpKTsKICAgICAgICAgICAgICAgIHRoaXMuZGlzdG9ydGlvbkVuZCA9IE1hdGgubWluKDEuMCwgaW5zdHJ1bWVudC5kaXN0b3J0aW9uIC8gKENvbmZpZy5kaXN0b3J0aW9uUmFuZ2UgLSAxKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHVzZXNCaXRjcnVzaGVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBmcmVxU2V0dGluZ1N0YXJ0ID0gaW5zdHJ1bWVudC5iaXRjcnVzaGVyRnJlcTsKICAgICAgICAgICAgICAgIGNvbnN0IGZyZXFTZXR0aW5nRW5kID0gaW5zdHJ1bWVudC5iaXRjcnVzaGVyRnJlcTsKICAgICAgICAgICAgICAgIGNvbnN0IHF1YW50aXphdGlvblNldHRpbmdTdGFydCA9IGluc3RydW1lbnQuYml0Y3J1c2hlclF1YW50aXphdGlvbjsKICAgICAgICAgICAgICAgIGNvbnN0IHF1YW50aXphdGlvblNldHRpbmdFbmQgPSBpbnN0cnVtZW50LmJpdGNydXNoZXJRdWFudGl6YXRpb247CiAgICAgICAgICAgICAgICBjb25zdCBiYXNlUGl0Y2ggPSBDb25maWcua2V5c1tzeW50aC5zb25nLmtleV0uYmFzZVBpdGNoOwogICAgICAgICAgICAgICAgY29uc3QgZnJlcVN0YXJ0ID0gSW5zdHJ1bWVudC5mcmVxdWVuY3lGcm9tUGl0Y2goYmFzZVBpdGNoICsgNjApICogTWF0aC5wb3coMi4wLCAoQ29uZmlnLmJpdGNydXNoZXJGcmVxUmFuZ2UgLSAxIC0gZnJlcVNldHRpbmdTdGFydCkgKiBDb25maWcuYml0Y3J1c2hlck9jdGF2ZVN0ZXApOwogICAgICAgICAgICAgICAgY29uc3QgZnJlcUVuZCA9IEluc3RydW1lbnQuZnJlcXVlbmN5RnJvbVBpdGNoKGJhc2VQaXRjaCArIDYwKSAqIE1hdGgucG93KDIuMCwgKENvbmZpZy5iaXRjcnVzaGVyRnJlcVJhbmdlIC0gMSAtIGZyZXFTZXR0aW5nRW5kKSAqIENvbmZpZy5iaXRjcnVzaGVyT2N0YXZlU3RlcCk7CiAgICAgICAgICAgICAgICBjb25zdCBwaGFzZURlbHRhU3RhcnQgPSBNYXRoLm1pbigxLjAsIGZyZXFTdGFydCAvIHNhbXBsZXNQZXJTZWNvbmQpOwogICAgICAgICAgICAgICAgY29uc3QgcGhhc2VEZWx0YUVuZCA9IE1hdGgubWluKDEuMCwgZnJlcUVuZCAvIHNhbXBsZXNQZXJTZWNvbmQpOwogICAgICAgICAgICAgICAgdGhpcy5iaXRjcnVzaGVyUGhhc2VEZWx0YSA9IHBoYXNlRGVsdGFTdGFydDsKICAgICAgICAgICAgICAgIHRoaXMuYml0Y3J1c2hlclBoYXNlRGVsdGFTY2FsZSA9IE1hdGgucG93KHBoYXNlRGVsdGFFbmQgLyBwaGFzZURlbHRhU3RhcnQsIDEuMCAvIHJ1bkxlbmd0aCk7CiAgICAgICAgICAgICAgICBjb25zdCBzY2FsZVN0YXJ0ID0gMi4wICogQ29uZmlnLmJpdGNydXNoZXJCYXNlVm9sdW1lICogTWF0aC5wb3coMi4wLCAxLjAgLSBNYXRoLnBvdygyLjAsIChDb25maWcuYml0Y3J1c2hlclF1YW50aXphdGlvblJhbmdlIC0gMSAtIHF1YW50aXphdGlvblNldHRpbmdTdGFydCkgKiAwLjUpKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNjYWxlRW5kID0gMi4wICogQ29uZmlnLmJpdGNydXNoZXJCYXNlVm9sdW1lICogTWF0aC5wb3coMi4wLCAxLjAgLSBNYXRoLnBvdygyLjAsIChDb25maWcuYml0Y3J1c2hlclF1YW50aXphdGlvblJhbmdlIC0gMSAtIHF1YW50aXphdGlvblNldHRpbmdFbmQpICogMC41KSk7CiAgICAgICAgICAgICAgICB0aGlzLmJpdGNydXNoZXJTY2FsZSA9IHNjYWxlU3RhcnQ7CiAgICAgICAgICAgICAgICB0aGlzLmJpdGNydXNoZXJTY2FsZVNjYWxlID0gTWF0aC5wb3coc2NhbGVFbmQgLyBzY2FsZVN0YXJ0LCAxLjAgLyBydW5MZW5ndGgpOwogICAgICAgICAgICAgICAgY29uc3QgZm9sZExldmVsU3RhcnQgPSAyLjAgKiBDb25maWcuYml0Y3J1c2hlckJhc2VWb2x1bWUgKiBNYXRoLnBvdygxLjUsIENvbmZpZy5iaXRjcnVzaGVyUXVhbnRpemF0aW9uUmFuZ2UgLSAxIC0gcXVhbnRpemF0aW9uU2V0dGluZ1N0YXJ0KTsKICAgICAgICAgICAgICAgIGNvbnN0IGZvbGRMZXZlbEVuZCA9IDIuMCAqIENvbmZpZy5iaXRjcnVzaGVyQmFzZVZvbHVtZSAqIE1hdGgucG93KDEuNSwgQ29uZmlnLmJpdGNydXNoZXJRdWFudGl6YXRpb25SYW5nZSAtIDEgLSBxdWFudGl6YXRpb25TZXR0aW5nRW5kKTsKICAgICAgICAgICAgICAgIHRoaXMuYml0Y3J1c2hlckZvbGRMZXZlbCA9IGZvbGRMZXZlbFN0YXJ0OwogICAgICAgICAgICAgICAgdGhpcy5iaXRjcnVzaGVyRm9sZExldmVsU2NhbGUgPSBNYXRoLnBvdyhmb2xkTGV2ZWxFbmQgLyBmb2xkTGV2ZWxTdGFydCwgMS4wIC8gcnVuTGVuZ3RoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBsZXQgZXFGaWx0ZXJWb2x1bWUgPSAxLjA7CiAgICAgICAgICAgIGNvbnN0IGVxRmlsdGVyU2V0dGluZ3MgPSBpbnN0cnVtZW50LmVxRmlsdGVyOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVxRmlsdGVyU2V0dGluZ3MuY29udHJvbFBvaW50Q291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgcG9pbnQgPSBlcUZpbHRlclNldHRpbmdzLmNvbnRyb2xQb2ludHNbaV07CiAgICAgICAgICAgICAgICBwb2ludC50b0NvZWZmaWNpZW50cyhTeW50aC50ZW1wRmlsdGVyU3RhcnRDb2VmZmljaWVudHMsIHNhbXBsZXNQZXJTZWNvbmQsIDEuMCwgMS4wKTsKICAgICAgICAgICAgICAgIHBvaW50LnRvQ29lZmZpY2llbnRzKFN5bnRoLnRlbXBGaWx0ZXJFbmRDb2VmZmljaWVudHMsIHNhbXBsZXNQZXJTZWNvbmQsIDEuMCwgMS4wKTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmVxRmlsdGVycy5sZW5ndGggPD0gaSkKICAgICAgICAgICAgICAgICAgICB0aGlzLmVxRmlsdGVyc1tpXSA9IG5ldyBEeW5hbWljQmlxdWFkRmlsdGVyKCk7CiAgICAgICAgICAgICAgICB0aGlzLmVxRmlsdGVyc1tpXS5sb2FkQ29lZmZpY2llbnRzV2l0aEdyYWRpZW50KFN5bnRoLnRlbXBGaWx0ZXJTdGFydENvZWZmaWNpZW50cywgU3ludGgudGVtcEZpbHRlckVuZENvZWZmaWNpZW50cywgMS4wIC8gcnVuTGVuZ3RoLCBwb2ludC50eXBlID09IDApOwogICAgICAgICAgICAgICAgZXFGaWx0ZXJWb2x1bWUgKj0gcG9pbnQuZ2V0Vm9sdW1lQ29tcGVuc2F0aW9uTXVsdCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZXFGaWx0ZXJDb3VudCA9IGVxRmlsdGVyU2V0dGluZ3MuY29udHJvbFBvaW50Q291bnQ7CiAgICAgICAgICAgIGVxRmlsdGVyVm9sdW1lID0gTWF0aC5taW4oMy4wLCBlcUZpbHRlclZvbHVtZSk7CiAgICAgICAgICAgIGNvbnN0IG1haW5JbnN0cnVtZW50Vm9sdW1lID0gU3ludGguaW5zdHJ1bWVudFZvbHVtZVRvVm9sdW1lTXVsdChpbnN0cnVtZW50LnZvbHVtZSk7CiAgICAgICAgICAgIHRoaXMubWl4Vm9sdW1lU3RhcnQgPSBtYWluSW5zdHJ1bWVudFZvbHVtZTsKICAgICAgICAgICAgY29uc3QgbWl4Vm9sdW1lRW5kID0gbWFpbkluc3RydW1lbnRWb2x1bWU7CiAgICAgICAgICAgIHRoaXMubWl4Vm9sdW1lRGVsdGEgPSAobWl4Vm9sdW1lRW5kIC0gdGhpcy5taXhWb2x1bWVTdGFydCkgLyBydW5MZW5ndGg7CiAgICAgICAgICAgIGxldCBlcUZpbHRlclZvbHVtZVN0YXJ0ID0gZXFGaWx0ZXJWb2x1bWU7CiAgICAgICAgICAgIGxldCBlcUZpbHRlclZvbHVtZUVuZCA9IGVxRmlsdGVyVm9sdW1lOwogICAgICAgICAgICBsZXQgZGVsYXlJbnB1dE11bHRTdGFydCA9IDEuMDsKICAgICAgICAgICAgbGV0IGRlbGF5SW5wdXRNdWx0RW5kID0gMS4wOwogICAgICAgICAgICBpZiAodXNlc1Bhbm5pbmcpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBhbiA9IChpbnN0cnVtZW50LnBhbiAtIENvbmZpZy5wYW5DZW50ZXIpIC8gQ29uZmlnLnBhbkNlbnRlcjsKICAgICAgICAgICAgICAgIGNvbnN0IHBhblN0YXJ0ID0gTWF0aC5tYXgoLTEuMCwgTWF0aC5taW4oMS4wLCBwYW4pKTsKICAgICAgICAgICAgICAgIGNvbnN0IHBhbkVuZCA9IE1hdGgubWF4KC0xLjAsIE1hdGgubWluKDEuMCwgcGFuKSk7CiAgICAgICAgICAgICAgICBjb25zdCB2b2x1bWVTdGFydEwgPSBNYXRoLmNvcygoMSArIHBhblN0YXJ0KSAqIE1hdGguUEkgKiAwLjI1KSAqIDEuNDE0OwogICAgICAgICAgICAgICAgY29uc3Qgdm9sdW1lU3RhcnRSID0gTWF0aC5jb3MoKDEgLSBwYW5TdGFydCkgKiBNYXRoLlBJICogMC4yNSkgKiAxLjQxNDsKICAgICAgICAgICAgICAgIGNvbnN0IHZvbHVtZUVuZEwgPSBNYXRoLmNvcygoMSArIHBhbkVuZCkgKiBNYXRoLlBJICogMC4yNSkgKiAxLjQxNDsKICAgICAgICAgICAgICAgIGNvbnN0IHZvbHVtZUVuZFIgPSBNYXRoLmNvcygoMSAtIHBhbkVuZCkgKiBNYXRoLlBJICogMC4yNSkgKiAxLjQxNDsKICAgICAgICAgICAgICAgIGNvbnN0IG1heERlbGF5U2FtcGxlcyA9IHNhbXBsZXNQZXJTZWNvbmQgKiBDb25maWcucGFuRGVsYXlTZWNvbmRzTWF4OwogICAgICAgICAgICAgICAgY29uc3QgZGVsYXlTdGFydCA9IHBhblN0YXJ0ICogbWF4RGVsYXlTYW1wbGVzOwogICAgICAgICAgICAgICAgY29uc3QgZGVsYXlFbmQgPSBwYW5FbmQgKiBtYXhEZWxheVNhbXBsZXM7CiAgICAgICAgICAgICAgICBjb25zdCBkZWxheVN0YXJ0TCA9IE1hdGgubWF4KDAuMCwgZGVsYXlTdGFydCk7CiAgICAgICAgICAgICAgICBjb25zdCBkZWxheVN0YXJ0UiA9IE1hdGgubWF4KDAuMCwgLWRlbGF5U3RhcnQpOwogICAgICAgICAgICAgICAgY29uc3QgZGVsYXlFbmRMID0gTWF0aC5tYXgoMC4wLCBkZWxheUVuZCk7CiAgICAgICAgICAgICAgICBjb25zdCBkZWxheUVuZFIgPSBNYXRoLm1heCgwLjAsIC1kZWxheUVuZCk7CiAgICAgICAgICAgICAgICB0aGlzLnBhbm5pbmdWb2x1bWVTdGFydEwgPSB2b2x1bWVTdGFydEw7CiAgICAgICAgICAgICAgICB0aGlzLnBhbm5pbmdWb2x1bWVTdGFydFIgPSB2b2x1bWVTdGFydFI7CiAgICAgICAgICAgICAgICB0aGlzLnBhbm5pbmdWb2x1bWVEZWx0YUwgPSAodm9sdW1lRW5kTCAtIHZvbHVtZVN0YXJ0TCkgLyBydW5MZW5ndGg7CiAgICAgICAgICAgICAgICB0aGlzLnBhbm5pbmdWb2x1bWVEZWx0YVIgPSAodm9sdW1lRW5kUiAtIHZvbHVtZVN0YXJ0UikgLyBydW5MZW5ndGg7CiAgICAgICAgICAgICAgICB0aGlzLnBhbm5pbmdPZmZzZXRTdGFydEwgPSBkZWxheVN0YXJ0TDsKICAgICAgICAgICAgICAgIHRoaXMucGFubmluZ09mZnNldFN0YXJ0UiA9IGRlbGF5U3RhcnRSOwogICAgICAgICAgICAgICAgdGhpcy5wYW5uaW5nT2Zmc2V0RGVsdGFMID0gKGRlbGF5RW5kTCAtIGRlbGF5U3RhcnRMKSAvIHJ1bkxlbmd0aDsKICAgICAgICAgICAgICAgIHRoaXMucGFubmluZ09mZnNldERlbHRhUiA9IChkZWxheUVuZFIgLSBkZWxheVN0YXJ0UikgLyBydW5MZW5ndGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHVzZXNDaG9ydXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNob3J1c1N0YXJ0ID0gTWF0aC5taW4oMS4wLCBpbnN0cnVtZW50LmNob3J1cyAvIChDb25maWcuY2hvcnVzUmFuZ2UgLSAxKSk7CiAgICAgICAgICAgICAgICBjb25zdCBjaG9ydXNFbmQgPSBNYXRoLm1pbigxLjAsIGluc3RydW1lbnQuY2hvcnVzIC8gKENvbmZpZy5jaG9ydXNSYW5nZSAtIDEpKTsKICAgICAgICAgICAgICAgIHRoaXMuY2hvcnVzU3RhcnQgPSBjaG9ydXNTdGFydCAqIDAuNiArIChNYXRoLnBvdyhjaG9ydXNTdGFydCwgNi4wKSkgKiAwLjQ7CiAgICAgICAgICAgICAgICB0aGlzLmNob3J1c0VuZCA9IGNob3J1c0VuZCAqIDAuNiArIChNYXRoLnBvdyhjaG9ydXNFbmQsIDYuMCkpICogMC40OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBtYXhFY2hvTXVsdCA9IDAuMDsKICAgICAgICAgICAgaWYgKHVzZXNFY2hvKSB7CiAgICAgICAgICAgICAgICBjb25zdCBlY2hvTXVsdFN0YXJ0ID0gTWF0aC5taW4oMS4wLCBNYXRoLnBvdyhpbnN0cnVtZW50LmVjaG9TdXN0YWluIC8gQ29uZmlnLmVjaG9TdXN0YWluUmFuZ2UsIDEuMSkpICogMC45OwogICAgICAgICAgICAgICAgY29uc3QgZWNob011bHRFbmQgPSBNYXRoLm1pbigxLjAsIE1hdGgucG93KGluc3RydW1lbnQuZWNob1N1c3RhaW4gLyBDb25maWcuZWNob1N1c3RhaW5SYW5nZSwgMS4xKSkgKiAwLjk7CiAgICAgICAgICAgICAgICB0aGlzLmVjaG9NdWx0U3RhcnQgPSBlY2hvTXVsdFN0YXJ0OwogICAgICAgICAgICAgICAgdGhpcy5lY2hvTXVsdERlbHRhID0gKGVjaG9NdWx0RW5kIC0gZWNob011bHRTdGFydCkgLyBydW5MZW5ndGg7CiAgICAgICAgICAgICAgICBtYXhFY2hvTXVsdCA9IE1hdGgubWF4KGVjaG9NdWx0U3RhcnQsIGVjaG9NdWx0RW5kKTsKICAgICAgICAgICAgICAgIGNvbnN0IGVjaG9EZWxheU9mZnNldCA9IE1hdGgucm91bmQoKGluc3RydW1lbnQuZWNob0RlbGF5ICsgMSkgKiBDb25maWcuZWNob0RlbGF5U3RlcFRpY2tzICogc2FtcGxlc1BlclRpY2spOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWNob0RlbGF5T2Zmc2V0TGFzdFRpY2tJc0NvbXB1dGVkKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5lY2hvRGVsYXlPZmZzZXRTdGFydCA9IHRoaXMuZWNob0RlbGF5T2Zmc2V0TGFzdFRpY2s7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVjaG9EZWxheU9mZnNldFN0YXJ0ID0gZWNob0RlbGF5T2Zmc2V0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHN5bnRoLmlzQXRFbmRPZlRpY2spIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmVjaG9EZWxheU9mZnNldExhc3RUaWNrID0gZWNob0RlbGF5T2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIHRoaXMuZWNob0RlbGF5T2Zmc2V0TGFzdFRpY2tJc0NvbXB1dGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuZWNob0RlbGF5T2Zmc2V0RW5kID0gZWNob0RlbGF5T2Zmc2V0OwogICAgICAgICAgICAgICAgdGhpcy5lY2hvRGVsYXlPZmZzZXRSYXRpbyA9IDEuMCAtIHRpY2tSZW1haW5pbmdTdGFydDsKICAgICAgICAgICAgICAgIHRoaXMuZWNob0RlbGF5T2Zmc2V0UmF0aW9EZWx0YSA9ICh0aWNrUmVtYWluaW5nU3RhcnQgLSB0aWNrUmVtYWluaW5nRW5kKSAvIHJ1bkxlbmd0aDsKICAgICAgICAgICAgICAgIGNvbnN0IHNoZWxmUmFkaWFucyA9IDIuMCAqIE1hdGguUEkgKiBDb25maWcuZWNob1NoZWxmSHogLyBzeW50aC5zYW1wbGVzUGVyU2Vjb25kOwogICAgICAgICAgICAgICAgU3ludGgudGVtcEZpbHRlclN0YXJ0Q29lZmZpY2llbnRzLmhpZ2hTaGVsZjFzdE9yZGVyKHNoZWxmUmFkaWFucywgQ29uZmlnLmVjaG9TaGVsZkdhaW4pOwogICAgICAgICAgICAgICAgdGhpcy5lY2hvU2hlbGZBMSA9IFN5bnRoLnRlbXBGaWx0ZXJTdGFydENvZWZmaWNpZW50cy5hWzFdOwogICAgICAgICAgICAgICAgdGhpcy5lY2hvU2hlbGZCMCA9IFN5bnRoLnRlbXBGaWx0ZXJTdGFydENvZWZmaWNpZW50cy5iWzBdOwogICAgICAgICAgICAgICAgdGhpcy5lY2hvU2hlbGZCMSA9IFN5bnRoLnRlbXBGaWx0ZXJTdGFydENvZWZmaWNpZW50cy5iWzFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBtYXhSZXZlcmJNdWx0ID0gMC4wOwogICAgICAgICAgICBpZiAodXNlc1JldmVyYikgewogICAgICAgICAgICAgICAgY29uc3QgcmV2ZXJiU3RhcnQgPSBNYXRoLm1pbigxLjAsIE1hdGgucG93KGluc3RydW1lbnQucmV2ZXJiIC8gQ29uZmlnLnJldmVyYlJhbmdlLCAwLjY2NykpICogMC40MjU7CiAgICAgICAgICAgICAgICBjb25zdCByZXZlcmJFbmQgPSBNYXRoLm1pbigxLjAsIE1hdGgucG93KGluc3RydW1lbnQucmV2ZXJiIC8gQ29uZmlnLnJldmVyYlJhbmdlLCAwLjY2NykpICogMC40MjU7CiAgICAgICAgICAgICAgICB0aGlzLnJldmVyYk11bHRTdGFydCA9IHJldmVyYlN0YXJ0OwogICAgICAgICAgICAgICAgdGhpcy5yZXZlcmJNdWx0RGVsdGEgPSAocmV2ZXJiRW5kIC0gcmV2ZXJiU3RhcnQpIC8gcnVuTGVuZ3RoOwogICAgICAgICAgICAgICAgbWF4UmV2ZXJiTXVsdCA9IE1hdGgubWF4KHJldmVyYlN0YXJ0LCByZXZlcmJFbmQpOwogICAgICAgICAgICAgICAgY29uc3Qgc2hlbGZSYWRpYW5zID0gMi4wICogTWF0aC5QSSAqIENvbmZpZy5yZXZlcmJTaGVsZkh6IC8gc3ludGguc2FtcGxlc1BlclNlY29uZDsKICAgICAgICAgICAgICAgIFN5bnRoLnRlbXBGaWx0ZXJTdGFydENvZWZmaWNpZW50cy5oaWdoU2hlbGYxc3RPcmRlcihzaGVsZlJhZGlhbnMsIENvbmZpZy5yZXZlcmJTaGVsZkdhaW4pOwogICAgICAgICAgICAgICAgdGhpcy5yZXZlcmJTaGVsZkExID0gU3ludGgudGVtcEZpbHRlclN0YXJ0Q29lZmZpY2llbnRzLmFbMV07CiAgICAgICAgICAgICAgICB0aGlzLnJldmVyYlNoZWxmQjAgPSBTeW50aC50ZW1wRmlsdGVyU3RhcnRDb2VmZmljaWVudHMuYlswXTsKICAgICAgICAgICAgICAgIHRoaXMucmV2ZXJiU2hlbGZCMSA9IFN5bnRoLnRlbXBGaWx0ZXJTdGFydENvZWZmaWNpZW50cy5iWzFdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0aGlzLnRvbmVzQWRkZWRJblRoaXNUaWNrKSB7CiAgICAgICAgICAgICAgICB0aGlzLmF0dGVudHVhdGlvblByb2dyZXNzID0gMC4wOwogICAgICAgICAgICAgICAgdGhpcy5mbHVzaGVkU2FtcGxlcyA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLmZsdXNoaW5nRGVsYXlMaW5lcyA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKCF0aGlzLmZsdXNoaW5nRGVsYXlMaW5lcykgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXR0ZW50dWF0aW9uUHJvZ3Jlc3MgPT0gMC4wKSB7CiAgICAgICAgICAgICAgICAgICAgZXFGaWx0ZXJWb2x1bWVTdGFydCAqPSB0aWNrUmVtYWluaW5nU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgZXFGaWx0ZXJWb2x1bWVFbmQgKj0gdGlja1JlbWFpbmluZ0VuZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIGVxRmlsdGVyVm9sdW1lU3RhcnQgPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgZXFGaWx0ZXJWb2x1bWVFbmQgPSAwLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBhdHRlbnVhdGlvblRocmVzaG9sZCA9IDEuMCAvIDI1Ni4wOwogICAgICAgICAgICAgICAgY29uc3QgaGFsZkxpZmVNdWx0ID0gLU1hdGgubG9nMihhdHRlbnVhdGlvblRocmVzaG9sZCk7CiAgICAgICAgICAgICAgICBsZXQgZGVsYXlEdXJhdGlvbiA9IDAuMDsKICAgICAgICAgICAgICAgIGlmICh1c2VzQ2hvcnVzKSB7CiAgICAgICAgICAgICAgICAgICAgZGVsYXlEdXJhdGlvbiArPSBDb25maWcuY2hvcnVzTWF4RGVsYXk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodXNlc0VjaG8pIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdmVyYWdlRGVsYXlTZWNvbmRzID0gKHRoaXMuZWNob0RlbGF5T2Zmc2V0U3RhcnQgKyB0aGlzLmVjaG9EZWxheU9mZnNldEVuZCkgKiAwLjUgLyBzYW1wbGVzUGVyU2Vjb25kOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dGVudWF0aW9uUGVyU2Vjb25kID0gTWF0aC5wb3cobWF4RWNob011bHQsIDEuMCAvIGF2ZXJhZ2VEZWxheVNlY29uZHMpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGhhbGZMaWZlID0gLTEuMCAvIE1hdGgubG9nMihhdHRlbnVhdGlvblBlclNlY29uZCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZWNob0R1cmF0aW9uID0gaGFsZkxpZmUgKiBoYWxmTGlmZU11bHQ7CiAgICAgICAgICAgICAgICAgICAgZGVsYXlEdXJhdGlvbiArPSBlY2hvRHVyYXRpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodXNlc1JldmVyYikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGF2ZXJhZ2VNdWx0ID0gbWF4UmV2ZXJiTXVsdCAqIDIuMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdmVyYWdlRGVsYXlTZWNvbmRzID0gKENvbmZpZy5yZXZlcmJEZWxheUJ1ZmZlclNpemUgLyA0LjApIC8gc2FtcGxlc1BlclNlY29uZDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRlbnVhdGlvblBlclNlY29uZCA9IE1hdGgucG93KGF2ZXJhZ2VNdWx0LCAxLjAgLyBhdmVyYWdlRGVsYXlTZWNvbmRzKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBoYWxmTGlmZSA9IC0xLjAgLyBNYXRoLmxvZzIoYXR0ZW51YXRpb25QZXJTZWNvbmQpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJldmVyYkR1cmF0aW9uID0gaGFsZkxpZmUgKiBoYWxmTGlmZU11bHQ7CiAgICAgICAgICAgICAgICAgICAgZGVsYXlEdXJhdGlvbiArPSByZXZlcmJEdXJhdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHNlY29uZHNJblRpY2sgPSBzYW1wbGVzUGVyVGljayAvIHNhbXBsZXNQZXJTZWNvbmQ7CiAgICAgICAgICAgICAgICBjb25zdCBwcm9ncmVzc0luVGljayA9IHNlY29uZHNJblRpY2sgLyBkZWxheUR1cmF0aW9uOwogICAgICAgICAgICAgICAgY29uc3QgcHJvZ3Jlc3NBdEVuZE9mVGljayA9IHRoaXMuYXR0ZW50dWF0aW9uUHJvZ3Jlc3MgKyBwcm9ncmVzc0luVGljazsKICAgICAgICAgICAgICAgIGlmIChwcm9ncmVzc0F0RW5kT2ZUaWNrID49IDEuMCkgewogICAgICAgICAgICAgICAgICAgIGRlbGF5SW5wdXRNdWx0U3RhcnQgKj0gdGlja1JlbWFpbmluZ1N0YXJ0OwogICAgICAgICAgICAgICAgICAgIGRlbGF5SW5wdXRNdWx0RW5kICo9IHRpY2tSZW1haW5pbmdFbmQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc3ludGguaXNBdEVuZE9mVGljaykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuYXR0ZW50dWF0aW9uUHJvZ3Jlc3MgPSBwcm9ncmVzc0F0RW5kT2ZUaWNrOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmF0dGVudHVhdGlvblByb2dyZXNzID49IDEuMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZsdXNoaW5nRGVsYXlMaW5lcyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgZXFGaWx0ZXJWb2x1bWVTdGFydCA9IDAuMDsKICAgICAgICAgICAgICAgIGVxRmlsdGVyVm9sdW1lRW5kID0gMC4wOwogICAgICAgICAgICAgICAgZGVsYXlJbnB1dE11bHRTdGFydCA9IDAuMDsKICAgICAgICAgICAgICAgIGRlbGF5SW5wdXRNdWx0RW5kID0gMC4wOwogICAgICAgICAgICAgICAgbGV0IHRvdGFsRGVsYXlTYW1wbGVzID0gMDsKICAgICAgICAgICAgICAgIGlmICh1c2VzQ2hvcnVzKQogICAgICAgICAgICAgICAgICAgIHRvdGFsRGVsYXlTYW1wbGVzICs9IHN5bnRoLmNob3J1c0RlbGF5QnVmZmVyU2l6ZTsKICAgICAgICAgICAgICAgIGlmICh1c2VzRWNobykKICAgICAgICAgICAgICAgICAgICB0b3RhbERlbGF5U2FtcGxlcyArPSB0aGlzLmVjaG9EZWxheUxpbmVMLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmICh1c2VzUmV2ZXJiKQogICAgICAgICAgICAgICAgICAgIHRvdGFsRGVsYXlTYW1wbGVzICs9IENvbmZpZy5yZXZlcmJEZWxheUJ1ZmZlclNpemU7CiAgICAgICAgICAgICAgICB0aGlzLmZsdXNoZWRTYW1wbGVzICs9IHJ1bkxlbmd0aDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmZsdXNoZWRTYW1wbGVzID49IHRvdGFsRGVsYXlTYW1wbGVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWFjdGl2YXRlQWZ0ZXJUaGlzVGljayA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5lcUZpbHRlclZvbHVtZVN0YXJ0ID0gZXFGaWx0ZXJWb2x1bWVTdGFydDsKICAgICAgICAgICAgdGhpcy5lcUZpbHRlclZvbHVtZURlbHRhID0gKGVxRmlsdGVyVm9sdW1lRW5kIC0gZXFGaWx0ZXJWb2x1bWVTdGFydCkgLyBydW5MZW5ndGg7CiAgICAgICAgICAgIHRoaXMuZGVsYXlJbnB1dE11bHRTdGFydCA9IGRlbGF5SW5wdXRNdWx0U3RhcnQ7CiAgICAgICAgICAgIHRoaXMuZGVsYXlJbnB1dE11bHREZWx0YSA9IChkZWxheUlucHV0TXVsdEVuZCAtIGRlbGF5SW5wdXRNdWx0U3RhcnQpIC8gcnVuTGVuZ3RoOwogICAgICAgIH0KICAgIH0KICAgIGNsYXNzIENoYW5uZWxTdGF0ZSB7CiAgICAgICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgICAgIHRoaXMuaW5zdHJ1bWVudHMgPSBbXTsKICAgICAgICAgICAgdGhpcy5tdXRlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnNpbmdsZVNlYW1sZXNzSW5zdHJ1bWVudCA9IG51bGw7CiAgICAgICAgfQogICAgfQogICAgY2xhc3MgU3ludGggewogICAgICAgIGNvbnN0cnVjdG9yKHNvbmcgPSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuc2FtcGxlc1BlclNlY29uZCA9IDQ0MTAwOwogICAgICAgICAgICB0aGlzLnNvbmcgPSBudWxsOwogICAgICAgICAgICB0aGlzLmxpdmVJbnB1dER1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5saXZlSW5wdXRTdGFydGVkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMubGl2ZUlucHV0UGl0Y2hlcyA9IFtdOwogICAgICAgICAgICB0aGlzLmxpdmVJbnB1dENoYW5uZWwgPSAwOwogICAgICAgICAgICB0aGlzLmxpdmVJbnB1dEluc3RydW1lbnRzID0gW107CiAgICAgICAgICAgIHRoaXMubG9vcFJlcGVhdENvdW50ID0gLTE7CiAgICAgICAgICAgIHRoaXMudm9sdW1lID0gMS4wOwogICAgICAgICAgICB0aGlzLnBsYXloZWFkSW50ZXJuYWwgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuYmFyID0gMDsKICAgICAgICAgICAgdGhpcy5wcmV2QmFyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5uZXh0QmFyID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5iZWF0ID0gMDsKICAgICAgICAgICAgdGhpcy5wYXJ0ID0gMDsKICAgICAgICAgICAgdGhpcy50aWNrID0gMDsKICAgICAgICAgICAgdGhpcy5pc0F0U3RhcnRPZlRpY2sgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmlzQXRFbmRPZlRpY2sgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnRpY2tTYW1wbGVDb3VudGRvd24gPSAwOwogICAgICAgICAgICB0aGlzLmlzUGxheWluZ1NvbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5saXZlSW5wdXRFbmRUaW1lID0gMC4wOwogICAgICAgICAgICB0aGlzLmJyb3dzZXJBdXRvbWF0aWNhbGx5Q2xlYXJzQXVkaW9CdWZmZXIgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnRlbXBEcnVtU2V0Q29udHJvbFBvaW50ID0gbmV3IEZpbHRlckNvbnRyb2xQb2ludCgpOwogICAgICAgICAgICB0aGlzLnRlbXBGcmVxdWVuY3lSZXNwb25zZSA9IG5ldyBGcmVxdWVuY3lSZXNwb25zZSgpOwogICAgICAgICAgICB0aGlzLmNoYW5uZWxzID0gW107CiAgICAgICAgICAgIHRoaXMudG9uZVBvb2wgPSBuZXcgRGVxdWUoKTsKICAgICAgICAgICAgdGhpcy50ZW1wTWF0Y2hlZFBpdGNoVG9uZXMgPSBBcnJheShDb25maWcubWF4Q2hvcmRTaXplKS5maWxsKG51bGwpOwogICAgICAgICAgICB0aGlzLmxpbWl0ID0gMC4wOwogICAgICAgICAgICB0aGlzLnRlbXBNb25vSW5zdHJ1bWVudFNhbXBsZUJ1ZmZlciA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuYXVkaW9DdHggPSBudWxsOwogICAgICAgICAgICB0aGlzLnNjcmlwdE5vZGUgPSBudWxsOwogICAgICAgICAgICB0aGlzLmF1ZGlvUHJvY2Vzc0NhbGxiYWNrID0gKGF1ZGlvUHJvY2Vzc2luZ0V2ZW50KSA9PiB7CiAgICAgICAgICAgICAgICBjb25zdCBvdXRwdXRCdWZmZXIgPSBhdWRpb1Byb2Nlc3NpbmdFdmVudC5vdXRwdXRCdWZmZXI7CiAgICAgICAgICAgICAgICBjb25zdCBvdXRwdXREYXRhTCA9IG91dHB1dEJ1ZmZlci5nZXRDaGFubmVsRGF0YSgwKTsKICAgICAgICAgICAgICAgIGNvbnN0IG91dHB1dERhdGFSID0gb3V0cHV0QnVmZmVyLmdldENoYW5uZWxEYXRhKDEpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYnJvd3NlckF1dG9tYXRpY2FsbHlDbGVhcnNBdWRpb0J1ZmZlciAmJiAob3V0cHV0RGF0YUxbMF0gIT0gMC4wIHx8IG91dHB1dERhdGFSWzBdICE9IDAuMCB8fCBvdXRwdXREYXRhTFtvdXRwdXRCdWZmZXIubGVuZ3RoIC0gMV0gIT0gMC4wIHx8IG91dHB1dERhdGFSW291dHB1dEJ1ZmZlci5sZW5ndGggLSAxXSAhPSAwLjApKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5icm93c2VyQXV0b21hdGljYWxseUNsZWFyc0F1ZGlvQnVmZmVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuYnJvd3NlckF1dG9tYXRpY2FsbHlDbGVhcnNBdWRpb0J1ZmZlcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IG91dHB1dEJ1ZmZlci5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXREYXRhTFtpXSA9IDAuMDsKICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0RGF0YVJbaV0gPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgaXNQbGF5aW5nTGl2ZVRvbmVzID0gcGVyZm9ybWFuY2Uubm93KCkgPCB0aGlzLmxpdmVJbnB1dEVuZFRpbWU7CiAgICAgICAgICAgICAgICBpZiAoIWlzUGxheWluZ0xpdmVUb25lcyAmJiAhdGhpcy5pc1BsYXlpbmdTb25nKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWFjdGl2YXRlQXVkaW8oKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc3ludGhlc2l6ZShvdXRwdXREYXRhTCwgb3V0cHV0RGF0YVIsIG91dHB1dEJ1ZmZlci5sZW5ndGgsIHRoaXMuaXNQbGF5aW5nU29uZyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuY29tcHV0ZURlbGF5QnVmZmVyU2l6ZXMoKTsKICAgICAgICAgICAgaWYgKHNvbmcgIT0gbnVsbCkKICAgICAgICAgICAgICAgIHRoaXMuc2V0U29uZyhzb25nKTsKICAgICAgICB9CiAgICAgICAgc3luY1NvbmdTdGF0ZSgpIHsKICAgICAgICAgICAgY29uc3QgY2hhbm5lbENvdW50ID0gdGhpcy5zb25nLmdldENoYW5uZWxDb3VudCgpOwogICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5jaGFubmVscy5sZW5ndGg7IGkgPCBjaGFubmVsQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgdGhpcy5jaGFubmVsc1tpXSA9IG5ldyBDaGFubmVsU3RhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmNoYW5uZWxzLmxlbmd0aCA9IGNoYW5uZWxDb3VudDsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaGFubmVsQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgY2hhbm5lbCA9IHRoaXMuc29uZy5jaGFubmVsc1tpXTsKICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5uZWxTdGF0ZSA9IHRoaXMuY2hhbm5lbHNbaV07CiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gY2hhbm5lbFN0YXRlLmluc3RydW1lbnRzLmxlbmd0aDsgaiA8IGNoYW5uZWwuaW5zdHJ1bWVudHMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBjaGFubmVsU3RhdGUuaW5zdHJ1bWVudHNbal0gPSBuZXcgSW5zdHJ1bWVudFN0YXRlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGFubmVsU3RhdGUuaW5zdHJ1bWVudHMubGVuZ3RoID0gY2hhbm5lbC5pbnN0cnVtZW50cy5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAoY2hhbm5lbFN0YXRlLm11dGVkICE9IGNoYW5uZWwubXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICBjaGFubmVsU3RhdGUubXV0ZWQgPSBjaGFubmVsLm11dGVkOwogICAgICAgICAgICAgICAgICAgIGlmIChjaGFubmVsU3RhdGUubXV0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBpbnN0cnVtZW50U3RhdGUgb2YgY2hhbm5lbFN0YXRlLmluc3RydW1lbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50U3RhdGUucmVzZXRBbGxFZmZlY3RzKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgd2FybVVwU3ludGhlc2l6ZXIoc29uZykgewogICAgICAgICAgICBpZiAoc29uZyAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICB0aGlzLnN5bmNTb25nU3RhdGUoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNhbXBsZXNQZXJUaWNrID0gdGhpcy5nZXRTYW1wbGVzUGVyVGljaygpOwogICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzb25nLmdldENoYW5uZWxDb3VudCgpOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNvbmcuY2hhbm5lbHNbal0uaW5zdHJ1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IHNvbmcuY2hhbm5lbHNbal0uaW5zdHJ1bWVudHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnRTdGF0ZSA9IHRoaXMuY2hhbm5lbHNbal0uaW5zdHJ1bWVudHNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIFN5bnRoLmdldEluc3RydW1lbnRTeW50aEZ1bmN0aW9uKGluc3RydW1lbnQpOwogICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50Lndhcm1VcCh0aGlzLnNhbXBsZXNQZXJTZWNvbmQpOwogICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50U3RhdGUuYWxsb2NhdGVOZWNlc3NhcnlCdWZmZXJzKHRoaXMsIGluc3RydW1lbnQsIHNhbXBsZXNQZXJUaWNrKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc3RhdGljIG9wZXJhdG9yQW1wbGl0dWRlQ3VydmUoYW1wbGl0dWRlKSB7CiAgICAgICAgICAgIHJldHVybiAoTWF0aC5wb3coMTYuMCwgYW1wbGl0dWRlIC8gMTUuMCkgLSAxLjApIC8gMTUuMDsKICAgICAgICB9CiAgICAgICAgZ2V0IHBsYXlpbmcoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmlzUGxheWluZ1Nvbmc7CiAgICAgICAgfQogICAgICAgIGdldCBwbGF5aGVhZCgpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucGxheWhlYWRJbnRlcm5hbDsKICAgICAgICB9CiAgICAgICAgc2V0IHBsYXloZWFkKHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNvbmcgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5wbGF5aGVhZEludGVybmFsID0gTWF0aC5tYXgoMCwgTWF0aC5taW4odGhpcy5zb25nLmJhckNvdW50LCB2YWx1ZSkpOwogICAgICAgICAgICAgICAgbGV0IHJlbWFpbmRlciA9IHRoaXMucGxheWhlYWRJbnRlcm5hbDsKICAgICAgICAgICAgICAgIHRoaXMuYmFyID0gTWF0aC5mbG9vcihyZW1haW5kZXIpOwogICAgICAgICAgICAgICAgcmVtYWluZGVyID0gdGhpcy5zb25nLmJlYXRzUGVyQmFyICogKHJlbWFpbmRlciAtIHRoaXMuYmFyKTsKICAgICAgICAgICAgICAgIHRoaXMuYmVhdCA9IE1hdGguZmxvb3IocmVtYWluZGVyKTsKICAgICAgICAgICAgICAgIHJlbWFpbmRlciA9IENvbmZpZy5wYXJ0c1BlckJlYXQgKiAocmVtYWluZGVyIC0gdGhpcy5iZWF0KTsKICAgICAgICAgICAgICAgIHRoaXMucGFydCA9IE1hdGguZmxvb3IocmVtYWluZGVyKTsKICAgICAgICAgICAgICAgIHJlbWFpbmRlciA9IENvbmZpZy50aWNrc1BlclBhcnQgKiAocmVtYWluZGVyIC0gdGhpcy5wYXJ0KTsKICAgICAgICAgICAgICAgIHRoaXMudGljayA9IE1hdGguZmxvb3IocmVtYWluZGVyKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNhbXBsZXNQZXJUaWNrID0gdGhpcy5nZXRTYW1wbGVzUGVyVGljaygpOwogICAgICAgICAgICAgICAgcmVtYWluZGVyID0gc2FtcGxlc1BlclRpY2sgKiAocmVtYWluZGVyIC0gdGhpcy50aWNrKTsKICAgICAgICAgICAgICAgIHRoaXMudGlja1NhbXBsZUNvdW50ZG93biA9IHNhbXBsZXNQZXJUaWNrIC0gcmVtYWluZGVyOwogICAgICAgICAgICAgICAgdGhpcy5wcmV2QmFyID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBnZXRTYW1wbGVzUGVyQmFyKCkgewogICAgICAgICAgICBpZiAodGhpcy5zb25nID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2FtcGxlc1BlclRpY2soKSAqIENvbmZpZy50aWNrc1BlclBhcnQgKiBDb25maWcucGFydHNQZXJCZWF0ICogdGhpcy5zb25nLmJlYXRzUGVyQmFyOwogICAgICAgIH0KICAgICAgICBnZXRUaWNrc0ludG9CYXIoKSB7CiAgICAgICAgICAgIHJldHVybiAodGhpcy5iZWF0ICogQ29uZmlnLnBhcnRzUGVyQmVhdCArIHRoaXMucGFydCkgKiBDb25maWcudGlja3NQZXJQYXJ0ICsgdGhpcy50aWNrOwogICAgICAgIH0KICAgICAgICBnZXRDdXJyZW50UGFydCgpIHsKICAgICAgICAgICAgcmV0dXJuICh0aGlzLmJlYXQgKiBDb25maWcucGFydHNQZXJCZWF0ICsgdGhpcy5wYXJ0KTsKICAgICAgICB9CiAgICAgICAgZ2V0VG90YWxCYXJzKGVuYWJsZUludHJvLCBlbmFibGVPdXRybykgewogICAgICAgICAgICBpZiAodGhpcy5zb25nID09IG51bGwpCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoKTsKICAgICAgICAgICAgbGV0IGJhcnMgPSB0aGlzLnNvbmcubG9vcExlbmd0aCAqICh0aGlzLmxvb3BSZXBlYXRDb3VudCArIDEpOwogICAgICAgICAgICBpZiAoZW5hYmxlSW50cm8pCiAgICAgICAgICAgICAgICBiYXJzICs9IHRoaXMuc29uZy5sb29wU3RhcnQ7CiAgICAgICAgICAgIGlmIChlbmFibGVPdXRybykKICAgICAgICAgICAgICAgIGJhcnMgKz0gdGhpcy5zb25nLmJhckNvdW50IC0gKHRoaXMuc29uZy5sb29wU3RhcnQgKyB0aGlzLnNvbmcubG9vcExlbmd0aCk7CiAgICAgICAgICAgIHJldHVybiBiYXJzOwogICAgICAgIH0KICAgICAgICBzZXRTb25nKHNvbmcpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiAoc29uZykgPT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgIHRoaXMuc29uZyA9IG5ldyBTb25nKHNvbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHNvbmcgaW5zdGFuY2VvZiBTb25nKSB7CiAgICAgICAgICAgICAgICB0aGlzLnNvbmcgPSBzb25nOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMucHJldkJhciA9IG51bGw7CiAgICAgICAgfQogICAgICAgIGNvbXB1dGVEZWxheUJ1ZmZlclNpemVzKCkgewogICAgICAgICAgICB0aGlzLnBhbm5pbmdEZWxheUJ1ZmZlclNpemUgPSBTeW50aC5maXR0aW5nUG93ZXJPZlR3byh0aGlzLnNhbXBsZXNQZXJTZWNvbmQgKiBDb25maWcucGFuRGVsYXlTZWNvbmRzTWF4KTsKICAgICAgICAgICAgdGhpcy5wYW5uaW5nRGVsYXlCdWZmZXJNYXNrID0gdGhpcy5wYW5uaW5nRGVsYXlCdWZmZXJTaXplIC0gMTsKICAgICAgICAgICAgdGhpcy5jaG9ydXNEZWxheUJ1ZmZlclNpemUgPSBTeW50aC5maXR0aW5nUG93ZXJPZlR3byh0aGlzLnNhbXBsZXNQZXJTZWNvbmQgKiBDb25maWcuY2hvcnVzTWF4RGVsYXkpOwogICAgICAgICAgICB0aGlzLmNob3J1c0RlbGF5QnVmZmVyTWFzayA9IHRoaXMuY2hvcnVzRGVsYXlCdWZmZXJTaXplIC0gMTsKICAgICAgICB9CiAgICAgICAgYWN0aXZhdGVBdWRpbygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9DdHggPT0gbnVsbCB8fCB0aGlzLnNjcmlwdE5vZGUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5hdWRpb0N0eCA9IHRoaXMuYXVkaW9DdHggfHwgbmV3ICh3aW5kb3cuQXVkaW9Db250ZXh0IHx8IHdpbmRvdy53ZWJraXRBdWRpb0NvbnRleHQpKCk7CiAgICAgICAgICAgICAgICB0aGlzLnNhbXBsZXNQZXJTZWNvbmQgPSB0aGlzLmF1ZGlvQ3R4LnNhbXBsZVJhdGU7CiAgICAgICAgICAgICAgICB0aGlzLnNjcmlwdE5vZGUgPSB0aGlzLmF1ZGlvQ3R4LmNyZWF0ZVNjcmlwdFByb2Nlc3NvciA/IHRoaXMuYXVkaW9DdHguY3JlYXRlU2NyaXB0UHJvY2Vzc29yKDIwNDgsIDAsIDIpIDogdGhpcy5hdWRpb0N0eC5jcmVhdGVKYXZhU2NyaXB0Tm9kZSgyMDQ4LCAwLCAyKTsKICAgICAgICAgICAgICAgIHRoaXMuc2NyaXB0Tm9kZS5vbmF1ZGlvcHJvY2VzcyA9IHRoaXMuYXVkaW9Qcm9jZXNzQ2FsbGJhY2s7CiAgICAgICAgICAgICAgICB0aGlzLnNjcmlwdE5vZGUuY2hhbm5lbENvdW50TW9kZSA9ICdleHBsaWNpdCc7CiAgICAgICAgICAgICAgICB0aGlzLnNjcmlwdE5vZGUuY2hhbm5lbEludGVycHJldGF0aW9uID0gJ3NwZWFrZXJzJzsKICAgICAgICAgICAgICAgIHRoaXMuc2NyaXB0Tm9kZS5jb25uZWN0KHRoaXMuYXVkaW9DdHguZGVzdGluYXRpb24pOwogICAgICAgICAgICAgICAgdGhpcy5jb21wdXRlRGVsYXlCdWZmZXJTaXplcygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuYXVkaW9DdHgucmVzdW1lKCk7CiAgICAgICAgfQogICAgICAgIGRlYWN0aXZhdGVBdWRpbygpIHsKICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9DdHggIT0gbnVsbCAmJiB0aGlzLnNjcmlwdE5vZGUgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5zY3JpcHROb2RlLmRpc2Nvbm5lY3QodGhpcy5hdWRpb0N0eC5kZXN0aW5hdGlvbik7CiAgICAgICAgICAgICAgICB0aGlzLnNjcmlwdE5vZGUgPSBudWxsOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuYXVkaW9DdHguY2xvc2UpCiAgICAgICAgICAgICAgICAgICAgdGhpcy5hdWRpb0N0eC5jbG9zZSgpOwogICAgICAgICAgICAgICAgdGhpcy5hdWRpb0N0eCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgbWFpbnRhaW5MaXZlSW5wdXQoKSB7CiAgICAgICAgICAgIHRoaXMuYWN0aXZhdGVBdWRpbygpOwogICAgICAgICAgICB0aGlzLmxpdmVJbnB1dEVuZFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKSArIDEwMDAwLjA7CiAgICAgICAgfQogICAgICAgIHBsYXkoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzUGxheWluZ1NvbmcpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nU29uZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuYWN0aXZhdGVBdWRpbygpOwogICAgICAgICAgICB0aGlzLndhcm1VcFN5bnRoZXNpemVyKHRoaXMuc29uZyk7CiAgICAgICAgfQogICAgICAgIHBhdXNlKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuaXNQbGF5aW5nU29uZykKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy5pc1BsYXlpbmdTb25nID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHNuYXBUb1N0YXJ0KCkgewogICAgICAgICAgICB0aGlzLmJhciA9IDA7CiAgICAgICAgICAgIHRoaXMuc25hcFRvQmFyKCk7CiAgICAgICAgfQogICAgICAgIGdvVG9CYXIoYmFyKSB7CiAgICAgICAgICAgIHRoaXMuYmFyID0gYmFyOwogICAgICAgICAgICB0aGlzLnBsYXloZWFkSW50ZXJuYWwgPSB0aGlzLmJhcjsKICAgICAgICAgICAgdGhpcy5wcmV2QmFyID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgc25hcFRvQmFyKCkgewogICAgICAgICAgICB0aGlzLnBsYXloZWFkSW50ZXJuYWwgPSB0aGlzLmJhcjsKICAgICAgICAgICAgdGhpcy5iZWF0ID0gMDsKICAgICAgICAgICAgdGhpcy5wYXJ0ID0gMDsKICAgICAgICAgICAgdGhpcy50aWNrID0gMDsKICAgICAgICAgICAgdGhpcy50aWNrU2FtcGxlQ291bnRkb3duID0gMDsKICAgICAgICAgICAgdGhpcy5pc0F0U3RhcnRPZlRpY2sgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnByZXZCYXIgPSBudWxsOwogICAgICAgIH0KICAgICAgICByZXNldEVmZmVjdHMoKSB7CiAgICAgICAgICAgIHRoaXMubGltaXQgPSAwLjA7CiAgICAgICAgICAgIHRoaXMuZnJlZUFsbFRvbmVzKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnNvbmcgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCBjaGFubmVsU3RhdGUgb2YgdGhpcy5jaGFubmVscykgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaW5zdHJ1bWVudFN0YXRlIG9mIGNoYW5uZWxTdGF0ZS5pbnN0cnVtZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50U3RhdGUucmVzZXRBbGxFZmZlY3RzKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGp1bXBJbnRvTG9vcCgpIHsKICAgICAgICAgICAgaWYgKCF0aGlzLnNvbmcpCiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIGlmICh0aGlzLmJhciA8IHRoaXMuc29uZy5sb29wU3RhcnQgfHwgdGhpcy5iYXIgPj0gdGhpcy5zb25nLmxvb3BTdGFydCArIHRoaXMuc29uZy5sb29wTGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvbGRCYXIgPSB0aGlzLmJhcjsKICAgICAgICAgICAgICAgIHRoaXMuYmFyID0gdGhpcy5zb25nLmxvb3BTdGFydDsKICAgICAgICAgICAgICAgIHRoaXMucGxheWhlYWRJbnRlcm5hbCArPSB0aGlzLmJhciAtIG9sZEJhcjsKICAgICAgICAgICAgICAgIHRoaXMucHJldkJhciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZ29Ub05leHRCYXIoKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5zb25nKQogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB0aGlzLnByZXZCYXIgPSB0aGlzLmJhcjsKICAgICAgICAgICAgY29uc3Qgb2xkQmFyID0gdGhpcy5iYXI7CiAgICAgICAgICAgIHRoaXMuYmFyKys7CiAgICAgICAgICAgIGlmICh0aGlzLmJhciA+PSB0aGlzLnNvbmcuYmFyQ291bnQpIHsKICAgICAgICAgICAgICAgIHRoaXMuYmFyID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnBsYXloZWFkSW50ZXJuYWwgKz0gdGhpcy5iYXIgLSBvbGRCYXI7CiAgICAgICAgfQogICAgICAgIGdvVG9QcmV2QmFyKCkgewogICAgICAgICAgICBpZiAoIXRoaXMuc29uZykKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgdGhpcy5wcmV2QmFyID0gbnVsbDsKICAgICAgICAgICAgY29uc3Qgb2xkQmFyID0gdGhpcy5iYXI7CiAgICAgICAgICAgIHRoaXMuYmFyLS07CiAgICAgICAgICAgIGlmICh0aGlzLmJhciA8IDAgfHwgdGhpcy5iYXIgPj0gdGhpcy5zb25nLmJhckNvdW50KSB7CiAgICAgICAgICAgICAgICB0aGlzLmJhciA9IHRoaXMuc29uZy5iYXJDb3VudCAtIDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5wbGF5aGVhZEludGVybmFsICs9IHRoaXMuYmFyIC0gb2xkQmFyOwogICAgICAgIH0KICAgICAgICBzeW50aGVzaXplKG91dHB1dERhdGFMLCBvdXRwdXREYXRhUiwgb3V0cHV0QnVmZmVyTGVuZ3RoLCBwbGF5U29uZyA9IHRydWUpIHsKICAgICAgICAgICAgaWYgKHRoaXMuc29uZyA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG91dHB1dEJ1ZmZlckxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0RGF0YUxbaV0gPSAwLjA7CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0RGF0YVJbaV0gPSAwLjA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLmRlYWN0aXZhdGVBdWRpbygpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHNvbmcgPSB0aGlzLnNvbmc7CiAgICAgICAgICAgIGNvbnN0IHNhbXBsZXNQZXJUaWNrID0gdGhpcy5nZXRTYW1wbGVzUGVyVGljaygpOwogICAgICAgICAgICBsZXQgZW5kZWQgPSBmYWxzZTsKICAgICAgICAgICAgd2hpbGUgKHRoaXMudGlja1NhbXBsZUNvdW50ZG93biA8PSAwKQogICAgICAgICAgICAgICAgdGhpcy50aWNrU2FtcGxlQ291bnRkb3duICs9IHNhbXBsZXNQZXJUaWNrOwogICAgICAgICAgICBpZiAodGhpcy50aWNrU2FtcGxlQ291bnRkb3duID4gc2FtcGxlc1BlclRpY2spCiAgICAgICAgICAgICAgICB0aGlzLnRpY2tTYW1wbGVDb3VudGRvd24gPSBzYW1wbGVzUGVyVGljazsKICAgICAgICAgICAgaWYgKHBsYXlTb25nKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5iZWF0ID49IHNvbmcuYmVhdHNQZXJCYXIpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmJhcisrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYmVhdCA9IDA7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0ID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRpY2sgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGlja1NhbXBsZUNvdW50ZG93biA9IHNhbXBsZXNQZXJUaWNrOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb3BSZXBlYXRDb3VudCAhPSAwICYmIHRoaXMuYmFyID09IHNvbmcubG9vcFN0YXJ0ICsgc29uZy5sb29wTGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmFyID0gc29uZy5sb29wU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb3BSZXBlYXRDb3VudCA+IDApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb3BSZXBlYXRDb3VudC0tOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmJhciA+PSBzb25nLmJhckNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5iYXIgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb3BSZXBlYXRDb3VudCAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBlbmRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5zeW5jU29uZ1N0YXRlKCk7CiAgICAgICAgICAgIGlmICh0aGlzLnRlbXBNb25vSW5zdHJ1bWVudFNhbXBsZUJ1ZmZlciA9PSBudWxsIHx8IHRoaXMudGVtcE1vbm9JbnN0cnVtZW50U2FtcGxlQnVmZmVyLmxlbmd0aCA8IG91dHB1dEJ1ZmZlckxlbmd0aCkgewogICAgICAgICAgICAgICAgdGhpcy50ZW1wTW9ub0luc3RydW1lbnRTYW1wbGVCdWZmZXIgPSBuZXcgRmxvYXQzMkFycmF5KG91dHB1dEJ1ZmZlckxlbmd0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3Qgdm9sdW1lID0gK3RoaXMudm9sdW1lOwogICAgICAgICAgICBjb25zdCBsaW1pdERlY2F5ID0gMS4wIC0gTWF0aC5wb3coMC41LCA0LjAgLyB0aGlzLnNhbXBsZXNQZXJTZWNvbmQpOwogICAgICAgICAgICBjb25zdCBsaW1pdFJpc2UgPSAxLjAgLSBNYXRoLnBvdygwLjUsIDQwMDAuMCAvIHRoaXMuc2FtcGxlc1BlclNlY29uZCk7CiAgICAgICAgICAgIGxldCBsaW1pdCA9ICt0aGlzLmxpbWl0OwogICAgICAgICAgICBsZXQgYnVmZmVySW5kZXggPSAwOwogICAgICAgICAgICB3aGlsZSAoYnVmZmVySW5kZXggPCBvdXRwdXRCdWZmZXJMZW5ndGggJiYgIWVuZGVkKSB7CiAgICAgICAgICAgICAgICB0aGlzLm5leHRCYXIgPSB0aGlzLmJhciArIDE7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29wUmVwZWF0Q291bnQgIT0gMCAmJiB0aGlzLm5leHRCYXIgPT0gc29uZy5sb29wU3RhcnQgKyBzb25nLmxvb3BMZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm5leHRCYXIgPSBzb25nLmxvb3BTdGFydDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLm5leHRCYXIgPj0gc29uZy5iYXJDb3VudCkKICAgICAgICAgICAgICAgICAgICB0aGlzLm5leHRCYXIgPSBudWxsOwogICAgICAgICAgICAgICAgY29uc3Qgc2FtcGxlc0xlZnRJbkJ1ZmZlciA9IG91dHB1dEJ1ZmZlckxlbmd0aCAtIGJ1ZmZlckluZGV4OwogICAgICAgICAgICAgICAgY29uc3Qgc2FtcGxlc0xlZnRJblRpY2sgPSBNYXRoLmNlaWwodGhpcy50aWNrU2FtcGxlQ291bnRkb3duKTsKICAgICAgICAgICAgICAgIGNvbnN0IHJ1bkxlbmd0aCA9IE1hdGgubWluKHNhbXBsZXNMZWZ0SW5UaWNrLCBzYW1wbGVzTGVmdEluQnVmZmVyKTsKICAgICAgICAgICAgICAgIHRoaXMuaXNBdEVuZE9mVGljayA9IChydW5MZW5ndGggPj0gdGhpcy50aWNrU2FtcGxlQ291bnRkb3duKTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGNoYW5uZWxJbmRleCA9IDA7IGNoYW5uZWxJbmRleCA8IHNvbmcuZ2V0Q2hhbm5lbENvdW50KCk7IGNoYW5uZWxJbmRleCsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhbm5lbCA9IHNvbmcuY2hhbm5lbHNbY2hhbm5lbEluZGV4XTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFubmVsU3RhdGUgPSB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF07CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXRlcm1pbmVDdXJyZW50QWN0aXZlVG9uZXMoc29uZywgY2hhbm5lbEluZGV4LCBwbGF5U29uZyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZXRlcm1pbmVMaXZlSW5wdXRUb25lcyhzb25nLCBjaGFubmVsSW5kZXgpOwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGluc3RydW1lbnRJbmRleCA9IDA7IGluc3RydW1lbnRJbmRleCA8IGNoYW5uZWwuaW5zdHJ1bWVudHMubGVuZ3RoOyBpbnN0cnVtZW50SW5kZXgrKykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50ID0gY2hhbm5lbC5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50U3RhdGUgPSBjaGFubmVsU3RhdGUuaW5zdHJ1bWVudHNbaW5zdHJ1bWVudEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRvbmVzUGxheWVkSW5UaGlzSW5zdHJ1bWVudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5zdHJ1bWVudFN0YXRlLmFjdGl2ZVRvbmVzLmNvdW50KCk7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9uZSA9IGluc3RydW1lbnRTdGF0ZS5hY3RpdmVUb25lcy5nZXQoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXlUb25lKHNvbmcsIGNoYW5uZWxJbmRleCwgc2FtcGxlc1BlclRpY2ssIGJ1ZmZlckluZGV4LCBydW5MZW5ndGgsIHRvbmUsIGZhbHNlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lc1BsYXllZEluVGhpc0luc3RydW1lbnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluc3RydW1lbnRTdGF0ZS5saXZlSW5wdXRUb25lcy5jb3VudCgpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvbmUgPSBpbnN0cnVtZW50U3RhdGUubGl2ZUlucHV0VG9uZXMuZ2V0KGkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5VG9uZShzb25nLCBjaGFubmVsSW5kZXgsIHNhbXBsZXNQZXJUaWNrLCBidWZmZXJJbmRleCwgcnVuTGVuZ3RoLCB0b25lLCBmYWxzZSwgZmFsc2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZXNQbGF5ZWRJblRoaXNJbnN0cnVtZW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbnN0cnVtZW50U3RhdGUucmVsZWFzZWRUb25lcy5jb3VudCgpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvbmUgPSBpbnN0cnVtZW50U3RhdGUucmVsZWFzZWRUb25lcy5nZXQoaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9uZS50aWNrc1NpbmNlUmVsZWFzZWQgPj0gTWF0aC5hYnMoaW5zdHJ1bWVudC5nZXRGYWRlT3V0VGlja3MoKSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWVSZWxlYXNlZFRvbmUoaW5zdHJ1bWVudFN0YXRlLCBpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzaG91bGRGYWRlT3V0RmFzdCA9ICh0b25lc1BsYXllZEluVGhpc0luc3RydW1lbnQgPj0gQ29uZmlnLm1heGltdW1Ub25lc1BlckNoYW5uZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wbGF5VG9uZShzb25nLCBjaGFubmVsSW5kZXgsIHNhbXBsZXNQZXJUaWNrLCBidWZmZXJJbmRleCwgcnVuTGVuZ3RoLCB0b25lLCB0cnVlLCBzaG91bGRGYWRlT3V0RmFzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lc1BsYXllZEluVGhpc0luc3RydW1lbnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudFN0YXRlLmF3YWtlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWluc3RydW1lbnRTdGF0ZS5jb21wdXRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnRTdGF0ZS5jb21wdXRlKHRoaXMsIGluc3RydW1lbnQsIHNhbXBsZXNQZXJUaWNrLCBydW5MZW5ndGgsIG51bGwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgU3ludGguZWZmZWN0c1N5bnRoKHRoaXMsIG91dHB1dERhdGFMLCBvdXRwdXREYXRhUiwgYnVmZmVySW5kZXgsIHJ1bkxlbmd0aCwgaW5zdHJ1bWVudCwgaW5zdHJ1bWVudFN0YXRlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnRTdGF0ZS5jb21wdXRlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgcnVuRW5kID0gYnVmZmVySW5kZXggKyBydW5MZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gYnVmZmVySW5kZXg7IGkgPCBydW5FbmQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHNhbXBsZUwgPSBvdXRwdXREYXRhTFtpXTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzYW1wbGVSID0gb3V0cHV0RGF0YVJbaV07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWJzID0gTWF0aC5tYXgoTWF0aC5hYnMoc2FtcGxlTCksIE1hdGguYWJzKHNhbXBsZVIpKTsKICAgICAgICAgICAgICAgICAgICBsaW1pdCArPSAoYWJzIC0gbGltaXQpICogKGxpbWl0IDwgYWJzID8gbGltaXRSaXNlIDogbGltaXREZWNheSAqICgxLjAgKyBsaW1pdCkpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbWl0ZWRWb2x1bWUgPSB2b2x1bWUgLyAobGltaXQgPj0gMSA/IGxpbWl0ICogMS4wNSA6IGxpbWl0ICogMC44ICsgMC4yNSk7CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0RGF0YUxbaV0gPSBzYW1wbGVMICogbGltaXRlZFZvbHVtZTsKICAgICAgICAgICAgICAgICAgICBvdXRwdXREYXRhUltpXSA9IHNhbXBsZVIgKiBsaW1pdGVkVm9sdW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgYnVmZmVySW5kZXggKz0gcnVuTGVuZ3RoOwogICAgICAgICAgICAgICAgdGhpcy5pc0F0U3RhcnRPZlRpY2sgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMudGlja1NhbXBsZUNvdW50ZG93biAtPSBydW5MZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50aWNrU2FtcGxlQ291bnRkb3duIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmlzQXRTdGFydE9mVGljayA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBjaGFubmVsU3RhdGUgb2YgdGhpcy5jaGFubmVscykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGluc3RydW1lbnRTdGF0ZSBvZiBjaGFubmVsU3RhdGUuaW5zdHJ1bWVudHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5zdHJ1bWVudFN0YXRlLnJlbGVhc2VkVG9uZXMuY291bnQoKTsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9uZSA9IGluc3RydW1lbnRTdGF0ZS5yZWxlYXNlZFRvbmVzLmdldChpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9uZS5pc09uTGFzdFRpY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmVlUmVsZWFzZWRUb25lKGluc3RydW1lbnRTdGF0ZSwgaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUudGlja3NTaW5jZVJlbGVhc2VkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnRTdGF0ZS5kZWFjdGl2YXRlQWZ0ZXJUaGlzVGljaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RydW1lbnRTdGF0ZS5kZWFjdGl2YXRlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0cnVtZW50U3RhdGUudG9uZXNBZGRlZEluVGhpc1RpY2sgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLnRpY2srKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRpY2tTYW1wbGVDb3VudGRvd24gKz0gc2FtcGxlc1BlclRpY2s7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudGljayA9PSBDb25maWcudGlja3NQZXJQYXJ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGljayA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydCsrOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxpdmVJbnB1dER1cmF0aW9uLS07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnBhcnQgPT0gQ29uZmlnLnBhcnRzUGVyQmVhdCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwbGF5U29uZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmVhdCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmJlYXQgPT0gc29uZy5iZWF0c1BlckJhcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmJlYXQgPSAwOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByZXZCYXIgPSB0aGlzLmJhcjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5iYXIrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubG9vcFJlcGVhdENvdW50ICE9IDAgJiYgdGhpcy5iYXIgPT0gc29uZy5sb29wU3RhcnQgKyBzb25nLmxvb3BMZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmFyID0gc29uZy5sb29wU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29wUmVwZWF0Q291bnQgPiAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9vcFJlcGVhdENvdW50LS07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuYmFyID49IHNvbmcuYmFyQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYmFyID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb3BSZXBlYXRDb3VudCAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc2V0RWZmZWN0cygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIU51bWJlci5pc0Zpbml0ZShsaW1pdCkgfHwgTWF0aC5hYnMobGltaXQpIDwgZXBzaWxvbikKICAgICAgICAgICAgICAgIGxpbWl0ID0gMC4wOwogICAgICAgICAgICB0aGlzLmxpbWl0ID0gbGltaXQ7CiAgICAgICAgICAgIGlmIChwbGF5U29uZykgewogICAgICAgICAgICAgICAgdGhpcy5wbGF5aGVhZEludGVybmFsID0gKCgodGhpcy50aWNrICsgMS4wIC0gdGhpcy50aWNrU2FtcGxlQ291bnRkb3duIC8gc2FtcGxlc1BlclRpY2spIC8gMi4wICsgdGhpcy5wYXJ0KSAvIENvbmZpZy5wYXJ0c1BlckJlYXQgKyB0aGlzLmJlYXQpIC8gc29uZy5iZWF0c1BlckJhciArIHRoaXMuYmFyOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGZyZWVUb25lKHRvbmUpIHsKICAgICAgICAgICAgdGhpcy50b25lUG9vbC5wdXNoQmFjayh0b25lKTsKICAgICAgICB9CiAgICAgICAgbmV3VG9uZSgpIHsKICAgICAgICAgICAgaWYgKHRoaXMudG9uZVBvb2wuY291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHRvbmUgPSB0aGlzLnRvbmVQb29sLnBvcEJhY2soKTsKICAgICAgICAgICAgICAgIHRvbmUuZnJlc2hseUFsbG9jYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gdG9uZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbmV3IFRvbmUoKTsKICAgICAgICB9CiAgICAgICAgcmVsZWFzZVRvbmUoaW5zdHJ1bWVudFN0YXRlLCB0b25lKSB7CiAgICAgICAgICAgIGluc3RydW1lbnRTdGF0ZS5yZWxlYXNlZFRvbmVzLnB1c2hGcm9udCh0b25lKTsKICAgICAgICAgICAgdG9uZS5hdE5vdGVTdGFydCA9IGZhbHNlOwogICAgICAgICAgICB0b25lLnBhc3NlZEVuZE9mTm90ZSA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGZyZWVSZWxlYXNlZFRvbmUoaW5zdHJ1bWVudFN0YXRlLCB0b25lSW5kZXgpIHsKICAgICAgICAgICAgdGhpcy5mcmVlVG9uZShpbnN0cnVtZW50U3RhdGUucmVsZWFzZWRUb25lcy5nZXQodG9uZUluZGV4KSk7CiAgICAgICAgICAgIGluc3RydW1lbnRTdGF0ZS5yZWxlYXNlZFRvbmVzLnJlbW92ZSh0b25lSW5kZXgpOwogICAgICAgIH0KICAgICAgICBmcmVlQWxsVG9uZXMoKSB7CiAgICAgICAgICAgIGZvciAoY29uc3QgY2hhbm5lbFN0YXRlIG9mIHRoaXMuY2hhbm5lbHMpIHsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgaW5zdHJ1bWVudFN0YXRlIG9mIGNoYW5uZWxTdGF0ZS5pbnN0cnVtZW50cykgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChpbnN0cnVtZW50U3RhdGUuYWN0aXZlVG9uZXMuY291bnQoKSA+IDApCiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZnJlZVRvbmUoaW5zdHJ1bWVudFN0YXRlLmFjdGl2ZVRvbmVzLnBvcEJhY2soKSk7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGluc3RydW1lbnRTdGF0ZS5yZWxlYXNlZFRvbmVzLmNvdW50KCkgPiAwKQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWVUb25lKGluc3RydW1lbnRTdGF0ZS5yZWxlYXNlZFRvbmVzLnBvcEJhY2soKSk7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKGluc3RydW1lbnRTdGF0ZS5saXZlSW5wdXRUb25lcy5jb3VudCgpID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmVlVG9uZShpbnN0cnVtZW50U3RhdGUubGl2ZUlucHV0VG9uZXMucG9wQmFjaygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBkZXRlcm1pbmVMaXZlSW5wdXRUb25lcyhzb25nLCBjaGFubmVsSW5kZXgpIHsKICAgICAgICAgICAgY29uc3QgY2hhbm5lbCA9IHNvbmcuY2hhbm5lbHNbY2hhbm5lbEluZGV4XTsKICAgICAgICAgICAgY29uc3QgY2hhbm5lbFN0YXRlID0gdGhpcy5jaGFubmVsc1tjaGFubmVsSW5kZXhdOwogICAgICAgICAgICBjb25zdCBwaXRjaGVzID0gdGhpcy5saXZlSW5wdXRQaXRjaGVzOwogICAgICAgICAgICBmb3IgKGxldCBpbnN0cnVtZW50SW5kZXggPSAwOyBpbnN0cnVtZW50SW5kZXggPCBjaGFubmVsLmluc3RydW1lbnRzLmxlbmd0aDsgaW5zdHJ1bWVudEluZGV4KyspIHsKICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnRTdGF0ZSA9IGNoYW5uZWxTdGF0ZS5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhdOwogICAgICAgICAgICAgICAgY29uc3QgdG9uZUxpc3QgPSBpbnN0cnVtZW50U3RhdGUubGl2ZUlucHV0VG9uZXM7CiAgICAgICAgICAgICAgICBsZXQgdG9uZUNvdW50ID0gMDsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxpdmVJbnB1dER1cmF0aW9uID4gMCAmJiBjaGFubmVsSW5kZXggPT0gdGhpcy5saXZlSW5wdXRDaGFubmVsICYmIHBpdGNoZXMubGVuZ3RoID4gMCAmJiB0aGlzLmxpdmVJbnB1dEluc3RydW1lbnRzLmluZGV4T2YoaW5zdHJ1bWVudEluZGV4KSAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSBjaGFubmVsLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleF07CiAgICAgICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnQuZ2V0Q2hvcmQoKS5zaW5nbGVUb25lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0b25lOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9uZUxpc3QuY291bnQoKSA8PSB0b25lQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUgPSB0aGlzLm5ld1RvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmVMaXN0LnB1c2hCYWNrKHRvbmUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFpbnN0cnVtZW50LmdldFRyYW5zaXRpb24oKS5pc1NlYW1sZXNzICYmIHRoaXMubGl2ZUlucHV0U3RhcnRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxlYXNlVG9uZShpbnN0cnVtZW50U3RhdGUsIHRvbmVMaXN0LmdldCh0b25lQ291bnQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUgPSB0aGlzLm5ld1RvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmVMaXN0LnNldCh0b25lQ291bnQsIHRvbmUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZSA9IHRvbmVMaXN0LmdldCh0b25lQ291bnQpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHRvbmVDb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBpdGNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUucGl0Y2hlc1tpXSA9IHBpdGNoZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5waXRjaENvdW50ID0gcGl0Y2hlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUuY2hvcmRTaXplID0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5pbnN0cnVtZW50SW5kZXggPSBpbnN0cnVtZW50SW5kZXg7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUubm90ZSA9IHRvbmUucHJldk5vdGUgPSB0b25lLm5leHROb3RlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5hdE5vdGVTdGFydCA9IHRoaXMubGl2ZUlucHV0U3RhcnRlZDsKICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5mb3JjZUNvbnRpbnVlQXRTdGFydCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0b25lLmZvcmNlQ29udGludWVBdEVuZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwaXRjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgdG9uZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b25lTGlzdC5jb3VudCgpIDw9IHRvbmVDb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUgPSB0aGlzLm5ld1RvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lTGlzdC5wdXNoQmFjayh0b25lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFpbnN0cnVtZW50LmdldFRyYW5zaXRpb24oKS5pc1NlYW1sZXNzICYmIHRoaXMubGl2ZUlucHV0U3RhcnRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVsZWFzZVRvbmUoaW5zdHJ1bWVudFN0YXRlLCB0b25lTGlzdC5nZXQodG9uZUNvdW50KSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZSA9IHRoaXMubmV3VG9uZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmVMaXN0LnNldCh0b25lQ291bnQsIHRvbmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZSA9IHRvbmVMaXN0LmdldCh0b25lQ291bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZUNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lLnBpdGNoZXNbMF0gPSBwaXRjaGVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5waXRjaENvdW50ID0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUuY2hvcmRTaXplID0gcGl0Y2hlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lLmluc3RydW1lbnRJbmRleCA9IGluc3RydW1lbnRJbmRleDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUubm90ZSA9IHRvbmUucHJldk5vdGUgPSB0b25lLm5leHROb3RlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUuYXROb3RlU3RhcnQgPSB0aGlzLmxpdmVJbnB1dFN0YXJ0ZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lLmZvcmNlQ29udGludWVBdFN0YXJ0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lLmZvcmNlQ29udGludWVBdEVuZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgd2hpbGUgKHRvbmVMaXN0LmNvdW50KCkgPiB0b25lQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VUb25lKGluc3RydW1lbnRTdGF0ZSwgdG9uZUxpc3QucG9wQmFjaygpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmxpdmVJbnB1dFN0YXJ0ZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgYWRqYWNlbnRQYXR0ZXJuSGFzQ29tcGF0aWJsZUluc3RydW1lbnRUcmFuc2l0aW9uKHNvbmcsIGNoYW5uZWwsIHBhdHRlcm4sIG90aGVyUGF0dGVybiwgaW5zdHJ1bWVudEluZGV4LCB0cmFuc2l0aW9uLCBjaG9yZCwgbm90ZSwgb3RoZXJOb3RlLCBmb3JjZUNvbnRpbnVlKSB7CiAgICAgICAgICAgIGlmIChzb25nLnBhdHRlcm5JbnN0cnVtZW50cyAmJiBvdGhlclBhdHRlcm4uaW5zdHJ1bWVudHMuaW5kZXhPZihpbnN0cnVtZW50SW5kZXgpID09IC0xKSB7CiAgICAgICAgICAgICAgICBpZiAocGF0dGVybi5pbnN0cnVtZW50cy5sZW5ndGggPiAxIHx8IG90aGVyUGF0dGVybi5pbnN0cnVtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBvdGhlckluc3RydW1lbnQgPSBjaGFubmVsLmluc3RydW1lbnRzW290aGVyUGF0dGVybi5pbnN0cnVtZW50c1swXV07CiAgICAgICAgICAgICAgICBpZiAoZm9yY2VDb250aW51ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvdGhlckluc3RydW1lbnQuZ2V0Q2hvcmQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IG90aGVyVHJhbnNpdGlvbiA9IG90aGVySW5zdHJ1bWVudC5nZXRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgICAgICBpZiAodHJhbnNpdGlvbi5pbmNsdWRlQWRqYWNlbnRQYXR0ZXJucyAmJiBvdGhlclRyYW5zaXRpb24uaW5jbHVkZUFkamFjZW50UGF0dGVybnMgJiYgb3RoZXJUcmFuc2l0aW9uLnNsaWRlcyA9PSB0cmFuc2l0aW9uLnNsaWRlcykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBvdGhlckluc3RydW1lbnQuZ2V0Q2hvcmQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIChmb3JjZUNvbnRpbnVlIHx8IHRyYW5zaXRpb24uaW5jbHVkZUFkamFjZW50UGF0dGVybnMpID8gY2hvcmQgOiBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBhZGphY2VudE5vdGVzSGF2ZU1hdGNoaW5nUGl0Y2hlcyhmaXJzdE5vdGUsIHNlY29uZE5vdGUpIHsKICAgICAgICAgICAgaWYgKGZpcnN0Tm90ZS5waXRjaGVzLmxlbmd0aCAhPSBzZWNvbmROb3RlLnBpdGNoZXMubGVuZ3RoKQogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBjb25zdCBmaXJzdE5vdGVJbnRlcnZhbCA9IGZpcnN0Tm90ZS5waW5zW2ZpcnN0Tm90ZS5waW5zLmxlbmd0aCAtIDFdLmludGVydmFsOwogICAgICAgICAgICBmb3IgKGNvbnN0IHBpdGNoIG9mIGZpcnN0Tm90ZS5waXRjaGVzKSB7CiAgICAgICAgICAgICAgICBpZiAoc2Vjb25kTm90ZS5waXRjaGVzLmluZGV4T2YocGl0Y2ggKyBmaXJzdE5vdGVJbnRlcnZhbCkgPT0gLTEpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBkZXRlcm1pbmVDdXJyZW50QWN0aXZlVG9uZXMoc29uZywgY2hhbm5lbEluZGV4LCBwbGF5U29uZykgewogICAgICAgICAgICBjb25zdCBjaGFubmVsID0gc29uZy5jaGFubmVsc1tjaGFubmVsSW5kZXhdOwogICAgICAgICAgICBjb25zdCBjaGFubmVsU3RhdGUgPSB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF07CiAgICAgICAgICAgIGNvbnN0IHBhdHRlcm4gPSBzb25nLmdldFBhdHRlcm4oY2hhbm5lbEluZGV4LCB0aGlzLmJhcik7CiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRQYXJ0ID0gdGhpcy5nZXRDdXJyZW50UGFydCgpOwogICAgICAgICAgICBjb25zdCBjdXJyZW50VGljayA9IHRoaXMudGljayArIENvbmZpZy50aWNrc1BlclBhcnQgKiBjdXJyZW50UGFydDsKICAgICAgICAgICAgbGV0IG5vdGUgPSBudWxsOwogICAgICAgICAgICBsZXQgcHJldk5vdGUgPSBudWxsOwogICAgICAgICAgICBsZXQgbmV4dE5vdGUgPSBudWxsOwogICAgICAgICAgICBpZiAocGxheVNvbmcgJiYgcGF0dGVybiAhPSBudWxsICYmICFjaGFubmVsLm11dGVkKSB7CiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHBhdHRlcm4ubm90ZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGF0dGVybi5ub3Rlc1tpXS5lbmQgPD0gY3VycmVudFBhcnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcHJldk5vdGUgPSBwYXR0ZXJuLm5vdGVzW2ldOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwYXR0ZXJuLm5vdGVzW2ldLnN0YXJ0IDw9IGN1cnJlbnRQYXJ0ICYmIHBhdHRlcm4ubm90ZXNbaV0uZW5kID4gY3VycmVudFBhcnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm90ZSA9IHBhdHRlcm4ubm90ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHBhdHRlcm4ubm90ZXNbaV0uc3RhcnQgPiBjdXJyZW50UGFydCkgewogICAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm90ZSA9IHBhdHRlcm4ubm90ZXNbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub3RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJldk5vdGUgIT0gbnVsbCAmJiBwcmV2Tm90ZS5lbmQgIT0gbm90ZS5zdGFydCkKICAgICAgICAgICAgICAgICAgICAgICAgcHJldk5vdGUgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIGlmIChuZXh0Tm90ZSAhPSBudWxsICYmIG5leHROb3RlLnN0YXJ0ICE9IG5vdGUuZW5kKQogICAgICAgICAgICAgICAgICAgICAgICBuZXh0Tm90ZSA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhdHRlcm4gIT0gbnVsbCAmJiAoIXNvbmcubGF5ZXJlZEluc3RydW1lbnRzIHx8IGNoYW5uZWwuaW5zdHJ1bWVudHMubGVuZ3RoID09IDEgfHwgKHNvbmcucGF0dGVybkluc3RydW1lbnRzICYmIHBhdHRlcm4uaW5zdHJ1bWVudHMubGVuZ3RoID09IDEpKSkgewogICAgICAgICAgICAgICAgY29uc3QgbmV3SW5zdHJ1bWVudEluZGV4ID0gc29uZy5wYXR0ZXJuSW5zdHJ1bWVudHMgPyBwYXR0ZXJuLmluc3RydW1lbnRzWzBdIDogMDsKICAgICAgICAgICAgICAgIGlmIChjaGFubmVsU3RhdGUuc2luZ2xlU2VhbWxlc3NJbnN0cnVtZW50ICE9IG51bGwgJiYgY2hhbm5lbFN0YXRlLnNpbmdsZVNlYW1sZXNzSW5zdHJ1bWVudCAhPSBuZXdJbnN0cnVtZW50SW5kZXggJiYgY2hhbm5lbFN0YXRlLnNpbmdsZVNlYW1sZXNzSW5zdHJ1bWVudCA8IGNoYW5uZWxTdGF0ZS5pbnN0cnVtZW50cy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzb3VyY2VJbnN0cnVtZW50U3RhdGUgPSBjaGFubmVsU3RhdGUuaW5zdHJ1bWVudHNbY2hhbm5lbFN0YXRlLnNpbmdsZVNlYW1sZXNzSW5zdHJ1bWVudF07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVzdEluc3RydW1lbnRTdGF0ZSA9IGNoYW5uZWxTdGF0ZS5pbnN0cnVtZW50c1tuZXdJbnN0cnVtZW50SW5kZXhdOwogICAgICAgICAgICAgICAgICAgIHdoaWxlIChzb3VyY2VJbnN0cnVtZW50U3RhdGUuYWN0aXZlVG9uZXMuY291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVzdEluc3RydW1lbnRTdGF0ZS5hY3RpdmVUb25lcy5wdXNoRnJvbnQoc291cmNlSW5zdHJ1bWVudFN0YXRlLmFjdGl2ZVRvbmVzLnBvcEJhY2soKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hhbm5lbFN0YXRlLnNpbmdsZVNlYW1sZXNzSW5zdHJ1bWVudCA9IG5ld0luc3RydW1lbnRJbmRleDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNoYW5uZWxTdGF0ZS5zaW5nbGVTZWFtbGVzc0luc3RydW1lbnQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGZvciAobGV0IGluc3RydW1lbnRJbmRleCA9IDA7IGluc3RydW1lbnRJbmRleCA8IGNoYW5uZWwuaW5zdHJ1bWVudHMubGVuZ3RoOyBpbnN0cnVtZW50SW5kZXgrKykgewogICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudFN0YXRlID0gY2hhbm5lbFN0YXRlLmluc3RydW1lbnRzW2luc3RydW1lbnRJbmRleF07CiAgICAgICAgICAgICAgICBjb25zdCB0b25lTGlzdCA9IGluc3RydW1lbnRTdGF0ZS5hY3RpdmVUb25lczsKICAgICAgICAgICAgICAgIGxldCB0b25lQ291bnQgPSAwOwogICAgICAgICAgICAgICAgaWYgKChub3RlICE9IG51bGwpICYmICghc29uZy5wYXR0ZXJuSW5zdHJ1bWVudHMgfHwgKHBhdHRlcm4uaW5zdHJ1bWVudHMuaW5kZXhPZihpbnN0cnVtZW50SW5kZXgpICE9IC0xKSkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50ID0gY2hhbm5lbC5pbnN0cnVtZW50c1tpbnN0cnVtZW50SW5kZXhdOwogICAgICAgICAgICAgICAgICAgIGxldCBwcmV2Tm90ZUZvclRoaXNJbnN0cnVtZW50ID0gcHJldk5vdGU7CiAgICAgICAgICAgICAgICAgICAgbGV0IG5leHROb3RlRm9yVGhpc0luc3RydW1lbnQgPSBuZXh0Tm90ZTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJ0c1BlckJhciA9IENvbmZpZy5wYXJ0c1BlckJlYXQgKiBzb25nLmJlYXRzUGVyQmFyOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5zaXRpb24gPSBpbnN0cnVtZW50LmdldFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaG9yZCA9IGluc3RydW1lbnQuZ2V0Q2hvcmQoKTsKICAgICAgICAgICAgICAgICAgICBsZXQgZm9yY2VDb250aW51ZUF0U3RhcnQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBsZXQgZm9yY2VDb250aW51ZUF0RW5kID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRvbmVzSW5QcmV2Tm90ZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRvbmVzSW5OZXh0Tm90ZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vdGUuc3RhcnQgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcHJldlBhdHRlcm4gPSAodGhpcy5wcmV2QmFyID09IG51bGwpID8gbnVsbCA6IHNvbmcuZ2V0UGF0dGVybihjaGFubmVsSW5kZXgsIHRoaXMucHJldkJhcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2UGF0dGVybiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0Tm90ZSA9IChwcmV2UGF0dGVybi5ub3Rlcy5sZW5ndGggPD0gMCkgPyBudWxsIDogcHJldlBhdHRlcm4ubm90ZXNbcHJldlBhdHRlcm4ubm90ZXMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdE5vdGUgIT0gbnVsbCAmJiBsYXN0Tm90ZS5lbmQgPT0gcGFydHNQZXJCYXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXR0ZXJuRm9yY2VzQ29udGludWVBdFN0YXJ0ID0gbm90ZS5jb250aW51ZXNMYXN0UGF0dGVybiAmJiBTeW50aC5hZGphY2VudE5vdGVzSGF2ZU1hdGNoaW5nUGl0Y2hlcyhsYXN0Tm90ZSwgbm90ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hvcmRPZkNvbXBhdGlibGVJbnN0cnVtZW50ID0gdGhpcy5hZGphY2VudFBhdHRlcm5IYXNDb21wYXRpYmxlSW5zdHJ1bWVudFRyYW5zaXRpb24oc29uZywgY2hhbm5lbCwgcGF0dGVybiwgcHJldlBhdHRlcm4sIGluc3RydW1lbnRJbmRleCwgdHJhbnNpdGlvbiwgY2hvcmQsIG5vdGUsIGxhc3ROb3RlLCBwYXR0ZXJuRm9yY2VzQ29udGludWVBdFN0YXJ0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hvcmRPZkNvbXBhdGlibGVJbnN0cnVtZW50ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldk5vdGVGb3JUaGlzSW5zdHJ1bWVudCA9IGxhc3ROb3RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lc0luUHJldk5vdGUgPSBjaG9yZE9mQ29tcGF0aWJsZUluc3RydW1lbnQuc2luZ2xlVG9uZSA/IDEgOiBwcmV2Tm90ZUZvclRoaXNJbnN0cnVtZW50LnBpdGNoZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JjZUNvbnRpbnVlQXRTdGFydCA9IHBhdHRlcm5Gb3JjZXNDb250aW51ZUF0U3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHByZXZOb3RlRm9yVGhpc0luc3RydW1lbnQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0b25lc0luUHJldk5vdGUgPSBjaG9yZC5zaW5nbGVUb25lID8gMSA6IHByZXZOb3RlRm9yVGhpc0luc3RydW1lbnQucGl0Y2hlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChub3RlLmVuZCA9PSBwYXJ0c1BlckJhcikgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbmV4dFBhdHRlcm4gPSAodGhpcy5uZXh0QmFyID09IG51bGwpID8gbnVsbCA6IHNvbmcuZ2V0UGF0dGVybihjaGFubmVsSW5kZXgsIHRoaXMubmV4dEJhcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0UGF0dGVybiAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmaXJzdE5vdGUgPSAobmV4dFBhdHRlcm4ubm90ZXMubGVuZ3RoIDw9IDApID8gbnVsbCA6IG5leHRQYXR0ZXJuLm5vdGVzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpcnN0Tm90ZSAhPSBudWxsICYmIGZpcnN0Tm90ZS5zdGFydCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmV4dFBhdHRlcm5Gb3JjZXNDb250aW51ZUF0U3RhcnQgPSBmaXJzdE5vdGUuY29udGludWVzTGFzdFBhdHRlcm4gJiYgU3ludGguYWRqYWNlbnROb3Rlc0hhdmVNYXRjaGluZ1BpdGNoZXMobm90ZSwgZmlyc3ROb3RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjaG9yZE9mQ29tcGF0aWJsZUluc3RydW1lbnQgPSB0aGlzLmFkamFjZW50UGF0dGVybkhhc0NvbXBhdGlibGVJbnN0cnVtZW50VHJhbnNpdGlvbihzb25nLCBjaGFubmVsLCBwYXR0ZXJuLCBuZXh0UGF0dGVybiwgaW5zdHJ1bWVudEluZGV4LCB0cmFuc2l0aW9uLCBjaG9yZCwgbm90ZSwgZmlyc3ROb3RlLCBuZXh0UGF0dGVybkZvcmNlc0NvbnRpbnVlQXRTdGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNob3JkT2ZDb21wYXRpYmxlSW5zdHJ1bWVudCAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHROb3RlRm9yVGhpc0luc3RydW1lbnQgPSBmaXJzdE5vdGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmVzSW5OZXh0Tm90ZSA9IGNob3JkT2ZDb21wYXRpYmxlSW5zdHJ1bWVudC5zaW5nbGVUb25lID8gMSA6IG5leHROb3RlRm9yVGhpc0luc3RydW1lbnQucGl0Y2hlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmNlQ29udGludWVBdEVuZCA9IG5leHRQYXR0ZXJuRm9yY2VzQ29udGludWVBdFN0YXJ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChuZXh0Tm90ZUZvclRoaXNJbnN0cnVtZW50ICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdG9uZXNJbk5leHROb3RlID0gY2hvcmQuc2luZ2xlVG9uZSA/IDEgOiBuZXh0Tm90ZUZvclRoaXNJbnN0cnVtZW50LnBpdGNoZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoY2hvcmQuc2luZ2xlVG9uZSkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdE5vdGVTdGFydCA9IChDb25maWcudGlja3NQZXJQYXJ0ICogbm90ZS5zdGFydCA9PSBjdXJyZW50VGljaykgJiYgdGhpcy5pc0F0U3RhcnRPZlRpY2s7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0b25lOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9uZUxpc3QuY291bnQoKSA8PSB0b25lQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUgPSB0aGlzLm5ld1RvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmVMaXN0LnB1c2hCYWNrKHRvbmUpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGF0Tm90ZVN0YXJ0ICYmICgoIXRyYW5zaXRpb24uaXNTZWFtbGVzcyAmJiAhZm9yY2VDb250aW51ZUF0U3RhcnQpIHx8IHByZXZOb3RlRm9yVGhpc0luc3RydW1lbnQgPT0gbnVsbCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZFRvbmUgPSB0b25lTGlzdC5nZXQodG9uZUNvdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRUb25lLmlzT25MYXN0VGljaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZnJlZVRvbmUob2xkVG9uZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VUb25lKGluc3RydW1lbnRTdGF0ZSwgb2xkVG9uZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lID0gdGhpcy5uZXdUb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lTGlzdC5zZXQodG9uZUNvdW50LCB0b25lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUgPSB0b25lTGlzdC5nZXQodG9uZUNvdW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0b25lQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub3RlLnBpdGNoZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUucGl0Y2hlc1tpXSA9IG5vdGUucGl0Y2hlc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0b25lLnBpdGNoQ291bnQgPSBub3RlLnBpdGNoZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICB0b25lLmNob3JkU2l6ZSA9IDE7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUuaW5zdHJ1bWVudEluZGV4ID0gaW5zdHJ1bWVudEluZGV4OwogICAgICAgICAgICAgICAgICAgICAgICB0b25lLm5vdGUgPSBub3RlOwogICAgICAgICAgICAgICAgICAgICAgICB0b25lLm5vdGVTdGFydFBhcnQgPSBub3RlLnN0YXJ0OwogICAgICAgICAgICAgICAgICAgICAgICB0b25lLm5vdGVFbmRQYXJ0ID0gbm90ZS5lbmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUucHJldk5vdGUgPSBwcmV2Tm90ZUZvclRoaXNJbnN0cnVtZW50OwogICAgICAgICAgICAgICAgICAgICAgICB0b25lLm5leHROb3RlID0gbmV4dE5vdGVGb3JUaGlzSW5zdHJ1bWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5wcmV2Tm90ZVBpdGNoSW5kZXggPSAwOwogICAgICAgICAgICAgICAgICAgICAgICB0b25lLm5leHROb3RlUGl0Y2hJbmRleCA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUuYXROb3RlU3RhcnQgPSBhdE5vdGVTdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5wYXNzZWRFbmRPZk5vdGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5mb3JjZUNvbnRpbnVlQXRTdGFydCA9IGZvcmNlQ29udGludWVBdFN0YXJ0OwogICAgICAgICAgICAgICAgICAgICAgICB0b25lLmZvcmNlQ29udGludWVBdEVuZCA9IGZvcmNlQ29udGludWVBdEVuZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRyYW5zaXRpb24gPSBpbnN0cnVtZW50LmdldFRyYW5zaXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCgodHJhbnNpdGlvbi5pc1NlYW1sZXNzICYmICF0cmFuc2l0aW9uLnNsaWRlcyAmJiBjaG9yZC5zdHJ1bVBhcnRzID09IDApIHx8IGZvcmNlQ29udGludWVBdFN0YXJ0KSAmJiAoQ29uZmlnLnRpY2tzUGVyUGFydCAqIG5vdGUuc3RhcnQgPT0gY3VycmVudFRpY2spICYmIHRoaXMuaXNBdFN0YXJ0T2ZUaWNrICYmIHByZXZOb3RlRm9yVGhpc0luc3RydW1lbnQgIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b25lTGlzdC5jb3VudCgpOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b25lID0gdG9uZUxpc3QuZ2V0KGkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoID0gdG9uZS5waXRjaGVzWzBdICsgdG9uZS5sYXN0SW50ZXJ2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBub3RlLnBpdGNoZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdGUucGl0Y2hlc1tqXSA9PSBwaXRjaCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZW1wTWF0Y2hlZFBpdGNoVG9uZXNbal0gPSB0b25lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZUxpc3QucmVtb3ZlKGkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAodG9uZUxpc3QuY291bnQoKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0b25lID0gdG9uZUxpc3QucG9wRnJvbnQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHRoaXMudGVtcE1hdGNoZWRQaXRjaFRvbmVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlbXBNYXRjaGVkUGl0Y2hUb25lc1tqXSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRlbXBNYXRjaGVkUGl0Y2hUb25lc1tqXSA9IHRvbmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBsZXQgc3RydW1PZmZzZXRQYXJ0cyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm90ZS5waXRjaGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgcHJldk5vdGVGb3JUaGlzVG9uZSA9ICh0b25lc0luUHJldk5vdGUgPiBpKSA/IHByZXZOb3RlRm9yVGhpc0luc3RydW1lbnQgOiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5vdGVGb3JUaGlzVG9uZSA9IG5vdGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgbmV4dE5vdGVGb3JUaGlzVG9uZSA9ICh0b25lc0luTmV4dE5vdGUgPiBpKSA/IG5leHROb3RlRm9yVGhpc0luc3RydW1lbnQgOiBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5vdGVTdGFydFBhcnQgPSBub3RlRm9yVGhpc1RvbmUuc3RhcnQgKyBzdHJ1bU9mZnNldFBhcnRzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBhc3NlZEVuZE9mTm90ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdGVTdGFydFBhcnQgPiBjdXJyZW50UGFydCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b25lTGlzdC5jb3VudCgpID4gaSAmJiAodHJhbnNpdGlvbi5pc1NlYW1sZXNzIHx8IGZvcmNlQ29udGludWVBdFN0YXJ0KSAmJiBwcmV2Tm90ZUZvclRoaXNUb25lICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dE5vdGVGb3JUaGlzVG9uZSA9IG5vdGVGb3JUaGlzVG9uZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90ZUZvclRoaXNUb25lID0gcHJldk5vdGVGb3JUaGlzVG9uZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldk5vdGVGb3JUaGlzVG9uZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vdGVTdGFydFBhcnQgPSBub3RlRm9yVGhpc1RvbmUuc3RhcnQgKyBzdHJ1bU9mZnNldFBhcnRzOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzZWRFbmRPZk5vdGUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG5vdGVFbmRQYXJ0ID0gbm90ZUZvclRoaXNUb25lLmVuZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodHJhbnNpdGlvbi5pc1NlYW1sZXNzIHx8IGZvcmNlQ29udGludWVBdFN0YXJ0KSAmJiBuZXh0Tm90ZUZvclRoaXNUb25lICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RlRW5kUGFydCA9IE1hdGgubWluKENvbmZpZy5wYXJ0c1BlckJlYXQgKiB0aGlzLnNvbmcuYmVhdHNQZXJCYXIsIG5vdGVFbmRQYXJ0ICsgc3RydW1PZmZzZXRQYXJ0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKCF0cmFuc2l0aW9uLmNvbnRpbnVlcyAmJiAhZm9yY2VDb250aW51ZUF0U3RhcnQpIHx8IHByZXZOb3RlRm9yVGhpc1RvbmUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cnVtT2Zmc2V0UGFydHMgKz0gY2hvcmQuc3RydW1QYXJ0czsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0Tm90ZVN0YXJ0ID0gKENvbmZpZy50aWNrc1BlclBhcnQgKiBub3RlU3RhcnRQYXJ0ID09IGN1cnJlbnRUaWNrKSAmJiB0aGlzLmlzQXRTdGFydE9mVGljazsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0b25lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudGVtcE1hdGNoZWRQaXRjaFRvbmVzW3RvbmVDb3VudF0gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUgPSB0aGlzLnRlbXBNYXRjaGVkUGl0Y2hUb25lc1t0b25lQ291bnRdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGVtcE1hdGNoZWRQaXRjaFRvbmVzW3RvbmVDb3VudF0gPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmVMaXN0LnB1c2hCYWNrKHRvbmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodG9uZUxpc3QuY291bnQoKSA8PSB0b25lQ291bnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lID0gdGhpcy5uZXdUb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZUxpc3QucHVzaEJhY2sodG9uZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChhdE5vdGVTdGFydCAmJiAoKCF0cmFuc2l0aW9uLmlzU2VhbWxlc3MgJiYgIWZvcmNlQ29udGludWVBdFN0YXJ0KSB8fCBwcmV2Tm90ZUZvclRoaXNUb25lID09IG51bGwpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2xkVG9uZSA9IHRvbmVMaXN0LmdldCh0b25lQ291bnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRUb25lLmlzT25MYXN0VGljaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWVUb25lKG9sZFRvbmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZWxlYXNlVG9uZShpbnN0cnVtZW50U3RhdGUsIG9sZFRvbmUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lID0gdGhpcy5uZXdUb25lKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZUxpc3Quc2V0KHRvbmVDb3VudCwgdG9uZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lID0gdG9uZUxpc3QuZ2V0KHRvbmVDb3VudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lQ291bnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUucGl0Y2hlc1swXSA9IG5vdGVGb3JUaGlzVG9uZS5waXRjaGVzW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5waXRjaENvdW50ID0gMTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUuY2hvcmRTaXplID0gbm90ZUZvclRoaXNUb25lLnBpdGNoZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5pbnN0cnVtZW50SW5kZXggPSBpbnN0cnVtZW50SW5kZXg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lLm5vdGUgPSBub3RlRm9yVGhpc1RvbmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lLm5vdGVTdGFydFBhcnQgPSBub3RlU3RhcnRQYXJ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5ub3RlRW5kUGFydCA9IG5vdGVFbmRQYXJ0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5wcmV2Tm90ZSA9IHByZXZOb3RlRm9yVGhpc1RvbmU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b25lLm5leHROb3RlID0gbmV4dE5vdGVGb3JUaGlzVG9uZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUucHJldk5vdGVQaXRjaEluZGV4ID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUubmV4dE5vdGVQaXRjaEluZGV4ID0gaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUuYXROb3RlU3RhcnQgPSBhdE5vdGVTdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUucGFzc2VkRW5kT2ZOb3RlID0gcGFzc2VkRW5kT2ZOb3RlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5mb3JjZUNvbnRpbnVlQXRTdGFydCA9IGZvcmNlQ29udGludWVBdFN0YXJ0ICYmIHByZXZOb3RlRm9yVGhpc1RvbmUgIT0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUuZm9yY2VDb250aW51ZUF0RW5kID0gZm9yY2VDb250aW51ZUF0RW5kICYmIG5leHROb3RlRm9yVGhpc1RvbmUgIT0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHdoaWxlICh0b25lTGlzdC5jb3VudCgpID4gdG9uZUNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG9uZSA9IHRvbmVMaXN0LnBvcEJhY2soKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGFubmVsID0gc29uZy5jaGFubmVsc1tjaGFubmVsSW5kZXhdOwogICAgICAgICAgICAgICAgICAgIGlmICh0b25lLmluc3RydW1lbnRJbmRleCA8IGNoYW5uZWwuaW5zdHJ1bWVudHMubGVuZ3RoICYmICF0b25lLmlzT25MYXN0VGljaykgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnN0cnVtZW50U3RhdGUgPSB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF0uaW5zdHJ1bWVudHNbdG9uZS5pbnN0cnVtZW50SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbGVhc2VUb25lKGluc3RydW1lbnRTdGF0ZSwgdG9uZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZWVUb25lKHRvbmUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSB0b25lQ291bnQ7IGkgPCB0aGlzLnRlbXBNYXRjaGVkUGl0Y2hUb25lcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9sZFRvbmUgPSB0aGlzLnRlbXBNYXRjaGVkUGl0Y2hUb25lc1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAob2xkVG9uZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRUb25lLmlzT25MYXN0VGljaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmVlVG9uZShvbGRUb25lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVsZWFzZVRvbmUoaW5zdHJ1bWVudFN0YXRlLCBvbGRUb25lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRlbXBNYXRjaGVkUGl0Y2hUb25lc1tpXSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHBsYXlUb25lKHNvbmcsIGNoYW5uZWxJbmRleCwgc2FtcGxlc1BlclRpY2ssIGJ1ZmZlckluZGV4LCBydW5MZW5ndGgsIHRvbmUsIHJlbGVhc2VkLCBzaG91bGRGYWRlT3V0RmFzdCkgewogICAgICAgICAgICBjb25zdCBjaGFubmVsID0gc29uZy5jaGFubmVsc1tjaGFubmVsSW5kZXhdOwogICAgICAgICAgICBjb25zdCBjaGFubmVsU3RhdGUgPSB0aGlzLmNoYW5uZWxzW2NoYW5uZWxJbmRleF07CiAgICAgICAgICAgIGNvbnN0IGluc3RydW1lbnQgPSBjaGFubmVsLmluc3RydW1lbnRzW3RvbmUuaW5zdHJ1bWVudEluZGV4XTsKICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudFN0YXRlID0gY2hhbm5lbFN0YXRlLmluc3RydW1lbnRzW3RvbmUuaW5zdHJ1bWVudEluZGV4XTsKICAgICAgICAgICAgaW5zdHJ1bWVudFN0YXRlLmF3YWtlID0gdHJ1ZTsKICAgICAgICAgICAgaW5zdHJ1bWVudFN0YXRlLnRvbmVzQWRkZWRJblRoaXNUaWNrID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKCFpbnN0cnVtZW50U3RhdGUuY29tcHV0ZWQpIHsKICAgICAgICAgICAgICAgIGluc3RydW1lbnRTdGF0ZS5jb21wdXRlKHRoaXMsIGluc3RydW1lbnQsIHNhbXBsZXNQZXJUaWNrLCBydW5MZW5ndGgsIHRvbmUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFN5bnRoLmNvbXB1dGVUb25lKHRoaXMsIHNvbmcsIGNoYW5uZWxJbmRleCwgc2FtcGxlc1BlclRpY2ssIHJ1bkxlbmd0aCwgdG9uZSwgcmVsZWFzZWQsIHNob3VsZEZhZGVPdXRGYXN0KTsKICAgICAgICAgICAgY29uc3Qgc3ludGhlc2l6ZXIgPSBTeW50aC5nZXRJbnN0cnVtZW50U3ludGhGdW5jdGlvbihpbnN0cnVtZW50KTsKICAgICAgICAgICAgc3ludGhlc2l6ZXIodGhpcywgYnVmZmVySW5kZXgsIHJ1bkxlbmd0aCwgdG9uZSwgaW5zdHJ1bWVudCk7CiAgICAgICAgICAgIHRvbmUuZW52ZWxvcGVDb21wdXRlci5jbGVhckVudmVsb3BlcyhpbnN0cnVtZW50KTsKICAgICAgICB9CiAgICAgICAgc3RhdGljIGNvbXB1dGVDaG9yZEV4cHJlc3Npb24oY2hvcmRTaXplKSB7CiAgICAgICAgICAgIHJldHVybiAxLjAgLyAoKGNob3JkU2l6ZSAtIDEpICogMC4yNSArIDEuMCk7CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBjb21wdXRlVG9uZShzeW50aCwgc29uZywgY2hhbm5lbEluZGV4LCBzYW1wbGVzUGVyVGljaywgcnVuTGVuZ3RoLCB0b25lLCByZWxlYXNlZCwgc2hvdWxkRmFkZU91dEZhc3QpIHsKICAgICAgICAgICAgY29uc3QgY2hhbm5lbCA9IHNvbmcuY2hhbm5lbHNbY2hhbm5lbEluZGV4XTsKICAgICAgICAgICAgY29uc3QgaW5zdHJ1bWVudCA9IGNoYW5uZWwuaW5zdHJ1bWVudHNbdG9uZS5pbnN0cnVtZW50SW5kZXhdOwogICAgICAgICAgICBjb25zdCB0cmFuc2l0aW9uID0gaW5zdHJ1bWVudC5nZXRUcmFuc2l0aW9uKCk7CiAgICAgICAgICAgIGNvbnN0IGNob3JkID0gaW5zdHJ1bWVudC5nZXRDaG9yZCgpOwogICAgICAgICAgICBjb25zdCBjaG9yZEV4cHJlc3Npb24gPSBjaG9yZC5zaW5nbGVUb25lID8gMS4wIDogU3ludGguY29tcHV0ZUNob3JkRXhwcmVzc2lvbih0b25lLmNob3JkU2l6ZSk7CiAgICAgICAgICAgIGNvbnN0IGlzTm9pc2VDaGFubmVsID0gc29uZy5nZXRDaGFubmVsSXNOb2lzZShjaGFubmVsSW5kZXgpOwogICAgICAgICAgICBjb25zdCBpbnRlcnZhbFNjYWxlID0gaXNOb2lzZUNoYW5uZWwgPyBDb25maWcubm9pc2VJbnRlcnZhbCA6IDE7CiAgICAgICAgICAgIGNvbnN0IHNlY29uZHNQZXJQYXJ0ID0gQ29uZmlnLnRpY2tzUGVyUGFydCAqIHNhbXBsZXNQZXJUaWNrIC8gc3ludGguc2FtcGxlc1BlclNlY29uZDsKICAgICAgICAgICAgY29uc3Qgc2FtcGxlVGltZSA9IDEuMCAvIHN5bnRoLnNhbXBsZXNQZXJTZWNvbmQ7CiAgICAgICAgICAgIGNvbnN0IGJlYXRzUGVyUGFydCA9IDEuMCAvIENvbmZpZy5wYXJ0c1BlckJlYXQ7CiAgICAgICAgICAgIGNvbnN0IHRpY2tTYW1wbGVDb3VudGRvd24gPSBzeW50aC50aWNrU2FtcGxlQ291bnRkb3duOwogICAgICAgICAgICBjb25zdCBzdGFydFJhdGlvID0gMS4wIC0gKHRpY2tTYW1wbGVDb3VudGRvd24pIC8gc2FtcGxlc1BlclRpY2s7CiAgICAgICAgICAgIGNvbnN0IGVuZFJhdGlvID0gMS4wIC0gKHRpY2tTYW1wbGVDb3VudGRvd24gLSBydW5MZW5ndGgpIC8gc2FtcGxlc1BlclRpY2s7CiAgICAgICAgICAgIGNvbnN0IHRpY2tzSW50b0JhciA9IHN5bnRoLmdldFRpY2tzSW50b0JhcigpOwogICAgICAgICAgICBjb25zdCBwYXJ0VGltZVRpY2tTdGFydCA9ICh0aWNrc0ludG9CYXIpIC8gQ29uZmlnLnRpY2tzUGVyUGFydDsKICAgICAgICAgICAgY29uc3QgcGFydFRpbWVUaWNrRW5kID0gKHRpY2tzSW50b0JhciArIDEpIC8gQ29uZmlnLnRpY2tzUGVyUGFydDsKICAgICAgICAgICAgY29uc3QgcGFydFRpbWVTdGFydCA9IHBhcnRUaW1lVGlja1N0YXJ0ICsgKHBhcnRUaW1lVGlja0VuZCAtIHBhcnRUaW1lVGlja1N0YXJ0KSAqIHN0YXJ0UmF0aW87CiAgICAgICAgICAgIGNvbnN0IHBhcnRUaW1lRW5kID0gcGFydFRpbWVUaWNrU3RhcnQgKyAocGFydFRpbWVUaWNrRW5kIC0gcGFydFRpbWVUaWNrU3RhcnQpICogZW5kUmF0aW87CiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRQYXJ0ID0gc3ludGguZ2V0Q3VycmVudFBhcnQoKTsKICAgICAgICAgICAgdG9uZS5zcGVjaWFsSW50ZXJ2YWxNdWx0ID0gMS4wOwogICAgICAgICAgICB0b25lLnNwZWNpYWxJbnRlcnZhbEV4cHJlc3Npb25NdWx0ID0gMS4wOwogICAgICAgICAgICBsZXQgdG9uZUlzT25MYXN0VGljayA9IHNob3VsZEZhZGVPdXRGYXN0OwogICAgICAgICAgICBsZXQgaW50ZXJ2YWxTdGFydCA9IDAuMDsKICAgICAgICAgICAgbGV0IGludGVydmFsRW5kID0gMC4wOwogICAgICAgICAgICBsZXQgdHJhbnNpdGlvbkV4cHJlc3Npb25TdGFydCA9IDEuMDsKICAgICAgICAgICAgbGV0IHRyYW5zaXRpb25FeHByZXNzaW9uRW5kID0gMS4wOwogICAgICAgICAgICBsZXQgY2hvcmRFeHByZXNzaW9uU3RhcnQgPSBjaG9yZEV4cHJlc3Npb247CiAgICAgICAgICAgIGxldCBjaG9yZEV4cHJlc3Npb25FbmQgPSBjaG9yZEV4cHJlc3Npb247CiAgICAgICAgICAgIGxldCBleHByZXNzaW9uUmVmZXJlbmNlUGl0Y2ggPSAxNjsKICAgICAgICAgICAgbGV0IGJhc2VQaXRjaCA9IENvbmZpZy5rZXlzW3Nvbmcua2V5XS5iYXNlUGl0Y2g7CiAgICAgICAgICAgIGxldCBiYXNlRXhwcmVzc2lvbiA9IDEuMDsKICAgICAgICAgICAgbGV0IHBpdGNoRGFtcGluZyA9IDQ4OwogICAgICAgICAgICBpZiAoaW5zdHJ1bWVudC50eXBlID09IDMpIHsKICAgICAgICAgICAgICAgIGJhc2VFeHByZXNzaW9uID0gQ29uZmlnLnNwZWN0cnVtQmFzZUV4cHJlc3Npb247CiAgICAgICAgICAgICAgICBpZiAoaXNOb2lzZUNoYW5uZWwpIHsKICAgICAgICAgICAgICAgICAgICBiYXNlUGl0Y2ggPSBDb25maWcuc3BlY3RydW1CYXNlUGl0Y2g7CiAgICAgICAgICAgICAgICAgICAgYmFzZUV4cHJlc3Npb24gKj0gMi4wOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZXhwcmVzc2lvblJlZmVyZW5jZVBpdGNoID0gQ29uZmlnLnNwZWN0cnVtQmFzZVBpdGNoOwogICAgICAgICAgICAgICAgcGl0Y2hEYW1waW5nID0gMjg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoaW5zdHJ1bWVudC50eXBlID09IDQpIHsKICAgICAgICAgICAgICAgIGJhc2VQaXRjaCA9IENvbmZpZy5zcGVjdHJ1bUJhc2VQaXRjaDsKICAgICAgICAgICAgICAgIGJhc2VFeHByZXNzaW9uID0gQ29uZmlnLmRydW1zZXRCYXNlRXhwcmVzc2lvbjsKICAgICAgICAgICAgICAgIGV4cHJlc3Npb25SZWZlcmVuY2VQaXRjaCA9IGJhc2VQaXRjaDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChpbnN0cnVtZW50LnR5cGUgPT0gMikgewogICAgICAgICAgICAgICAgYmFzZVBpdGNoID0gQ29uZmlnLmNoaXBOb2lzZXNbaW5zdHJ1bWVudC5jaGlwTm9pc2VdLmJhc2VQaXRjaDsKICAgICAgICAgICAgICAgIGJhc2VFeHByZXNzaW9uID0gQ29uZmlnLm5vaXNlQmFzZUV4cHJlc3Npb247CiAgICAgICAgICAgICAgICBleHByZXNzaW9uUmVmZXJlbmNlUGl0Y2ggPSBiYXNlUGl0Y2g7CiAgICAgICAgICAgICAgICBwaXRjaERhbXBpbmcgPSBDb25maWcuY2hpcE5vaXNlc1tpbnN0cnVtZW50LmNoaXBOb2lzZV0uaXNTb2Z0ID8gMjQuMCA6IDYwLjA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoaW5zdHJ1bWVudC50eXBlID09IDEpIHsKICAgICAgICAgICAgICAgIGJhc2VFeHByZXNzaW9uID0gQ29uZmlnLmZtQmFzZUV4cHJlc3Npb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoaW5zdHJ1bWVudC50eXBlID09IDApIHsKICAgICAgICAgICAgICAgIGJhc2VFeHByZXNzaW9uID0gQ29uZmlnLmNoaXBCYXNlRXhwcmVzc2lvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChpbnN0cnVtZW50LnR5cGUgPT0gNSkgewogICAgICAgICAgICAgICAgYmFzZUV4cHJlc3Npb24gPSBDb25maWcuaGFybW9uaWNzQmFzZUV4cHJlc3Npb247CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoaW5zdHJ1bWVudC50eXBlID09IDYpIHsKICAgICAgICAgICAgICAgIGJhc2VFeHByZXNzaW9uID0gQ29uZmlnLnB3bUJhc2VFeHByZXNzaW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGluc3RydW1lbnQudHlwZSA9PSA3KSB7CiAgICAgICAgICAgICAgICBiYXNlRXhwcmVzc2lvbiA9IENvbmZpZy5waWNrZWRTdHJpbmdCYXNlRXhwcmVzc2lvbjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiVW5rbm93biBpbnN0cnVtZW50IHR5cGUgaW4gY29tcHV0ZVRvbmUuIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCh0b25lLmF0Tm90ZVN0YXJ0ICYmICF0cmFuc2l0aW9uLmlzU2VhbWxlc3MgJiYgIXRvbmUuZm9yY2VDb250aW51ZUF0U3RhcnQpIHx8IHRvbmUuZnJlc2hseUFsbG9jYXRlZCkgewogICAgICAgICAgICAgICAgdG9uZS5yZXNldCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRvbmUuZnJlc2hseUFsbG9jYXRlZCA9IGZhbHNlOwogICAgICAgICAgICBjb25zdCBtYXhXYXZlcyA9IE1hdGgubWF4KENvbmZpZy5tYXhDaG9yZFNpemUsIENvbmZpZy5vcGVyYXRvckNvdW50KTsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtYXhXYXZlczsgaSsrKSB7CiAgICAgICAgICAgICAgICB0b25lLnBoYXNlRGVsdGFzW2ldID0gMC4wOwogICAgICAgICAgICAgICAgdG9uZS5leHByZXNzaW9uU3RhcnRzW2ldID0gMC4wOwogICAgICAgICAgICAgICAgdG9uZS5leHByZXNzaW9uRGVsdGFzW2ldID0gMC4wOwogICAgICAgICAgICAgICAgdG9uZS5waGFzZURlbHRhU2NhbGVzW2ldID0gMC4wOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZWxlYXNlZCkgewogICAgICAgICAgICAgICAgY29uc3Qgc3RhcnRUaWNrc1NpbmNlUmVsZWFzZWQgPSB0b25lLnRpY2tzU2luY2VSZWxlYXNlZCArIHN0YXJ0UmF0aW87CiAgICAgICAgICAgICAgICBjb25zdCBlbmRUaWNrc1NpbmNlUmVsZWFzZWQgPSB0b25lLnRpY2tzU2luY2VSZWxlYXNlZCArIGVuZFJhdGlvOwogICAgICAgICAgICAgICAgaW50ZXJ2YWxTdGFydCA9IGludGVydmFsRW5kID0gdG9uZS5sYXN0SW50ZXJ2YWw7CiAgICAgICAgICAgICAgICBjb25zdCBmYWRlT3V0VGlja3MgPSBNYXRoLmFicyhpbnN0cnVtZW50LmdldEZhZGVPdXRUaWNrcygpKTsKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25FeHByZXNzaW9uU3RhcnQgPSBTeW50aC5ub3RlU2l6ZVRvVm9sdW1lTXVsdCgoMS4wIC0gc3RhcnRUaWNrc1NpbmNlUmVsZWFzZWQgLyBmYWRlT3V0VGlja3MpICogQ29uZmlnLm5vdGVTaXplTWF4KTsKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25FeHByZXNzaW9uRW5kID0gU3ludGgubm90ZVNpemVUb1ZvbHVtZU11bHQoKDEuMCAtIGVuZFRpY2tzU2luY2VSZWxlYXNlZCAvIGZhZGVPdXRUaWNrcykgKiBDb25maWcubm90ZVNpemVNYXgpOwogICAgICAgICAgICAgICAgaWYgKHNob3VsZEZhZGVPdXRGYXN0KSB7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbkV4cHJlc3Npb25TdGFydCAqPSAxLjAgLSBzdGFydFJhdGlvOwogICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25FeHByZXNzaW9uRW5kICo9IDEuMCAtIGVuZFJhdGlvOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRvbmUudGlja3NTaW5jZVJlbGVhc2VkICsgMSA+PSBmYWRlT3V0VGlja3MpCiAgICAgICAgICAgICAgICAgICAgdG9uZUlzT25MYXN0VGljayA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodG9uZS5ub3RlID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25FeHByZXNzaW9uU3RhcnQgPSB0cmFuc2l0aW9uRXhwcmVzc2lvbkVuZCA9IDE7CiAgICAgICAgICAgICAgICB0b25lLmxhc3RJbnRlcnZhbCA9IDA7CiAgICAgICAgICAgICAgICB0b25lLnRpY2tzU2luY2VSZWxlYXNlZCA9IDA7CiAgICAgICAgICAgICAgICB0b25lLmxpdmVJbnB1dFNhbXBsZXNIZWxkICs9IHJ1bkxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5vdGUgPSB0b25lLm5vdGU7CiAgICAgICAgICAgICAgICBjb25zdCBuZXh0Tm90ZSA9IHRvbmUubmV4dE5vdGU7CiAgICAgICAgICAgICAgICBjb25zdCBub3RlU3RhcnRQYXJ0ID0gdG9uZS5ub3RlU3RhcnRQYXJ0OwogICAgICAgICAgICAgICAgY29uc3Qgbm90ZUVuZFBhcnQgPSB0b25lLm5vdGVFbmRQYXJ0OwogICAgICAgICAgICAgICAgY29uc3QgZW5kUGluSW5kZXggPSBub3RlLmdldEVuZFBpbkluZGV4KGN1cnJlbnRQYXJ0KTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0UGluID0gbm90ZS5waW5zW2VuZFBpbkluZGV4IC0gMV07CiAgICAgICAgICAgICAgICBjb25zdCBlbmRQaW4gPSBub3RlLnBpbnNbZW5kUGluSW5kZXhdOwogICAgICAgICAgICAgICAgY29uc3Qgbm90ZVN0YXJ0VGljayA9IG5vdGVTdGFydFBhcnQgKiBDb25maWcudGlja3NQZXJQYXJ0OwogICAgICAgICAgICAgICAgY29uc3Qgbm90ZUVuZFRpY2sgPSBub3RlRW5kUGFydCAqIENvbmZpZy50aWNrc1BlclBhcnQ7CiAgICAgICAgICAgICAgICBjb25zdCBwaW5TdGFydCA9IChub3RlLnN0YXJ0ICsgc3RhcnRQaW4udGltZSkgKiBDb25maWcudGlja3NQZXJQYXJ0OwogICAgICAgICAgICAgICAgY29uc3QgcGluRW5kID0gKG5vdGUuc3RhcnQgKyBlbmRQaW4udGltZSkgKiBDb25maWcudGlja3NQZXJQYXJ0OwogICAgICAgICAgICAgICAgdG9uZS50aWNrc1NpbmNlUmVsZWFzZWQgPSAwOwogICAgICAgICAgICAgICAgY29uc3QgdGlja1RpbWVTdGFydCA9IGN1cnJlbnRQYXJ0ICogQ29uZmlnLnRpY2tzUGVyUGFydCArIHN5bnRoLnRpY2s7CiAgICAgICAgICAgICAgICBjb25zdCB0aWNrVGltZUVuZCA9IGN1cnJlbnRQYXJ0ICogQ29uZmlnLnRpY2tzUGVyUGFydCArIHN5bnRoLnRpY2sgKyAxOwogICAgICAgICAgICAgICAgY29uc3Qgbm90ZVRpY2tzUGFzc2VkVGlja1N0YXJ0ID0gdGlja1RpbWVTdGFydCAtIG5vdGVTdGFydFRpY2s7CiAgICAgICAgICAgICAgICBjb25zdCBub3RlVGlja3NQYXNzZWRUaWNrRW5kID0gdGlja1RpbWVFbmQgLSBub3RlU3RhcnRUaWNrOwogICAgICAgICAgICAgICAgY29uc3QgcGluUmF0aW9TdGFydCA9IE1hdGgubWluKDEuMCwgKHRpY2tUaW1lU3RhcnQgLSBwaW5TdGFydCkgLyAocGluRW5kIC0gcGluU3RhcnQpKTsKICAgICAgICAgICAgICAgIGNvbnN0IHBpblJhdGlvRW5kID0gTWF0aC5taW4oMS4wLCAodGlja1RpbWVFbmQgLSBwaW5TdGFydCkgLyAocGluRW5kIC0gcGluU3RhcnQpKTsKICAgICAgICAgICAgICAgIGxldCB0cmFuc2l0aW9uRXhwcmVzc2lvblRpY2tTdGFydCA9IDEuMDsKICAgICAgICAgICAgICAgIGxldCB0cmFuc2l0aW9uRXhwcmVzc2lvblRpY2tFbmQgPSAxLjA7CiAgICAgICAgICAgICAgICBsZXQgaW50ZXJ2YWxUaWNrU3RhcnQgPSBzdGFydFBpbi5pbnRlcnZhbCArIChlbmRQaW4uaW50ZXJ2YWwgLSBzdGFydFBpbi5pbnRlcnZhbCkgKiBwaW5SYXRpb1N0YXJ0OwogICAgICAgICAgICAgICAgbGV0IGludGVydmFsVGlja0VuZCA9IHN0YXJ0UGluLmludGVydmFsICsgKGVuZFBpbi5pbnRlcnZhbCAtIHN0YXJ0UGluLmludGVydmFsKSAqIHBpblJhdGlvRW5kOwogICAgICAgICAgICAgICAgdG9uZS5sYXN0SW50ZXJ2YWwgPSBpbnRlcnZhbFRpY2tFbmQ7CiAgICAgICAgICAgICAgICBpZiAoKCF0cmFuc2l0aW9uLmlzU2VhbWxlc3MgJiYgIXRvbmUuZm9yY2VDb250aW51ZUF0RW5kKSB8fCBuZXh0Tm90ZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmFkZU91dFRpY2tzID0gLWluc3RydW1lbnQuZ2V0RmFkZU91dFRpY2tzKCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZhZGVPdXRUaWNrcyA+IDAuMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBub3RlTGVuZ3RoVGlja3MgPSBub3RlRW5kVGljayAtIG5vdGVTdGFydFRpY2s7CiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb25FeHByZXNzaW9uVGlja1N0YXJ0ICo9IE1hdGgubWluKDEuMCwgKG5vdGVMZW5ndGhUaWNrcyAtIG5vdGVUaWNrc1Bhc3NlZFRpY2tTdGFydCkgLyBmYWRlT3V0VGlja3MpOwogICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRXhwcmVzc2lvblRpY2tFbmQgKj0gTWF0aC5taW4oMS4wLCAobm90ZUxlbmd0aFRpY2tzIC0gbm90ZVRpY2tzUGFzc2VkVGlja0VuZCkgLyBmYWRlT3V0VGlja3MpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGlja1RpbWVFbmQgPj0gbm90ZVN0YXJ0VGljayArIG5vdGVMZW5ndGhUaWNrcykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvbmVJc09uTGFzdFRpY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGludGVydmFsU3RhcnQgPSBpbnRlcnZhbFRpY2tTdGFydCArIChpbnRlcnZhbFRpY2tFbmQgLSBpbnRlcnZhbFRpY2tTdGFydCkgKiBzdGFydFJhdGlvOwogICAgICAgICAgICAgICAgaW50ZXJ2YWxFbmQgPSBpbnRlcnZhbFRpY2tTdGFydCArIChpbnRlcnZhbFRpY2tFbmQgLSBpbnRlcnZhbFRpY2tTdGFydCkgKiBlbmRSYXRpbzsKICAgICAgICAgICAgICAgIHRyYW5zaXRpb25FeHByZXNzaW9uU3RhcnQgPSB0cmFuc2l0aW9uRXhwcmVzc2lvblRpY2tTdGFydCArICh0cmFuc2l0aW9uRXhwcmVzc2lvblRpY2tFbmQgLSB0cmFuc2l0aW9uRXhwcmVzc2lvblRpY2tTdGFydCkgKiBzdGFydFJhdGlvOwogICAgICAgICAgICAgICAgdHJhbnNpdGlvbkV4cHJlc3Npb25FbmQgPSB0cmFuc2l0aW9uRXhwcmVzc2lvblRpY2tTdGFydCArICh0cmFuc2l0aW9uRXhwcmVzc2lvblRpY2tFbmQgLSB0cmFuc2l0aW9uRXhwcmVzc2lvblRpY2tTdGFydCkgKiBlbmRSYXRpbzsKICAgICAgICAgICAgfQogICAgICAgICAgICB0b25lLmlzT25MYXN0VGljayA9IHRvbmVJc09uTGFzdFRpY2s7CiAgICAgICAgICAgIGNvbnN0IGVudmVsb3BlQ29tcHV0ZXIgPSB0b25lLmVudmVsb3BlQ29tcHV0ZXI7CiAgICAgICAgICAgIGVudmVsb3BlQ29tcHV0ZXIuY29tcHV0ZUVudmVsb3BlcyhpbnN0cnVtZW50LCBjdXJyZW50UGFydCwgQ29uZmlnLnRpY2tzUGVyUGFydCAqIHBhcnRUaW1lU3RhcnQsIENvbmZpZy50aWNrc1BlclBhcnQgKiBwYXJ0VGltZUVuZCwgc2Vjb25kc1BlclBhcnQgKiAocGFydFRpbWVFbmQgLSBwYXJ0VGltZVN0YXJ0KSwgdG9uZSk7CiAgICAgICAgICAgIGNvbnN0IGVudmVsb3BlU3RhcnRzID0gdG9uZS5lbnZlbG9wZUNvbXB1dGVyLmVudmVsb3BlU3RhcnRzOwogICAgICAgICAgICBjb25zdCBlbnZlbG9wZUVuZHMgPSB0b25lLmVudmVsb3BlQ29tcHV0ZXIuZW52ZWxvcGVFbmRzOwogICAgICAgICAgICBpZiAodG9uZS5ub3RlICE9IG51bGwgJiYgdHJhbnNpdGlvbi5zbGlkZXMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHByZXZOb3RlID0gdG9uZS5wcmV2Tm90ZTsKICAgICAgICAgICAgICAgIGNvbnN0IG5leHROb3RlID0gdG9uZS5uZXh0Tm90ZTsKICAgICAgICAgICAgICAgIGlmIChwcmV2Tm90ZSAhPSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZXJ2YWxEaWZmID0gcHJldk5vdGUucGl0Y2hlc1t0b25lLnByZXZOb3RlUGl0Y2hJbmRleF0gKyBwcmV2Tm90ZS5waW5zW3ByZXZOb3RlLnBpbnMubGVuZ3RoIC0gMV0uaW50ZXJ2YWwgLSB0b25lLnBpdGNoZXNbMF07CiAgICAgICAgICAgICAgICAgICAgaWYgKGVudmVsb3BlQ29tcHV0ZXIucHJldlNsaWRlU3RhcnQpCiAgICAgICAgICAgICAgICAgICAgICAgIGludGVydmFsU3RhcnQgKz0gaW50ZXJ2YWxEaWZmICogZW52ZWxvcGVDb21wdXRlci5wcmV2U2xpZGVSYXRpb1N0YXJ0OwogICAgICAgICAgICAgICAgICAgIGlmIChlbnZlbG9wZUNvbXB1dGVyLnByZXZTbGlkZUVuZCkKICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWxFbmQgKz0gaW50ZXJ2YWxEaWZmICogZW52ZWxvcGVDb21wdXRlci5wcmV2U2xpZGVSYXRpb0VuZDsKICAgICAgICAgICAgICAgICAgICBpZiAoIWNob3JkLnNpbmdsZVRvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hvcmRTaXplRGlmZiA9IHByZXZOb3RlLnBpdGNoZXMubGVuZ3RoIC0gdG9uZS5jaG9yZFNpemU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnZlbG9wZUNvbXB1dGVyLnByZXZTbGlkZVN0YXJ0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvcmRFeHByZXNzaW9uU3RhcnQgPSBTeW50aC5jb21wdXRlQ2hvcmRFeHByZXNzaW9uKHRvbmUuY2hvcmRTaXplICsgY2hvcmRTaXplRGlmZiAqIGVudmVsb3BlQ29tcHV0ZXIucHJldlNsaWRlUmF0aW9TdGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnZlbG9wZUNvbXB1dGVyLnByZXZTbGlkZUVuZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob3JkRXhwcmVzc2lvbkVuZCA9IFN5bnRoLmNvbXB1dGVDaG9yZEV4cHJlc3Npb24odG9uZS5jaG9yZFNpemUgKyBjaG9yZFNpemVEaWZmICogZW52ZWxvcGVDb21wdXRlci5wcmV2U2xpZGVSYXRpb0VuZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG5leHROb3RlICE9IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpbnRlcnZhbERpZmYgPSBuZXh0Tm90ZS5waXRjaGVzW3RvbmUubmV4dE5vdGVQaXRjaEluZGV4XSAtICh0b25lLnBpdGNoZXNbMF0gKyB0b25lLm5vdGUucGluc1t0b25lLm5vdGUucGlucy5sZW5ndGggLSAxXS5pbnRlcnZhbCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGVudmVsb3BlQ29tcHV0ZXIubmV4dFNsaWRlU3RhcnQpCiAgICAgICAgICAgICAgICAgICAgICAgIGludGVydmFsU3RhcnQgKz0gaW50ZXJ2YWxEaWZmICogZW52ZWxvcGVDb21wdXRlci5uZXh0U2xpZGVSYXRpb1N0YXJ0OwogICAgICAgICAgICAgICAgICAgIGlmIChlbnZlbG9wZUNvbXB1dGVyLm5leHRTbGlkZUVuZCkKICAgICAgICAgICAgICAgICAgICAgICAgaW50ZXJ2YWxFbmQgKz0gaW50ZXJ2YWxEaWZmICogZW52ZWxvcGVDb21wdXRlci5uZXh0U2xpZGVSYXRpb0VuZDsKICAgICAgICAgICAgICAgICAgICBpZiAoIWNob3JkLnNpbmdsZVRvbmUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hvcmRTaXplRGlmZiA9IG5leHROb3RlLnBpdGNoZXMubGVuZ3RoIC0gdG9uZS5jaG9yZFNpemU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnZlbG9wZUNvbXB1dGVyLm5leHRTbGlkZVN0YXJ0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hvcmRFeHByZXNzaW9uU3RhcnQgPSBTeW50aC5jb21wdXRlQ2hvcmRFeHByZXNzaW9uKHRvbmUuY2hvcmRTaXplICsgY2hvcmRTaXplRGlmZiAqIGVudmVsb3BlQ29tcHV0ZXIubmV4dFNsaWRlUmF0aW9TdGFydCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbnZlbG9wZUNvbXB1dGVyLm5leHRTbGlkZUVuZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNob3JkRXhwcmVzc2lvbkVuZCA9IFN5bnRoLmNvbXB1dGVDaG9yZEV4cHJlc3Npb24odG9uZS5jaG9yZFNpemUgKyBjaG9yZFNpemVEaWZmICogZW52ZWxvcGVDb21wdXRlci5uZXh0U2xpZGVSYXRpb0VuZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZVBpdGNoU2hpZnQoaW5zdHJ1bWVudC5lZmZlY3RzKSkgewogICAgICAgICAgICAgICAgY29uc3QgcGl0Y2hTaGlmdCA9IENvbmZpZy5qdXN0SW50b25hdGlvblNlbWl0b25lc1tpbnN0cnVtZW50LnBpdGNoU2hpZnRdIC8gaW50ZXJ2YWxTY2FsZTsKICAgICAgICAgICAgICAgIGNvbnN0IGVudmVsb3BlU3RhcnQgPSBlbnZlbG9wZVN0YXJ0c1sxNF07CiAgICAgICAgICAgICAgICBjb25zdCBlbnZlbG9wZUVuZCA9IGVudmVsb3BlRW5kc1sxNF07CiAgICAgICAgICAgICAgICBpbnRlcnZhbFN0YXJ0ICs9IHBpdGNoU2hpZnQgKiBlbnZlbG9wZVN0YXJ0OwogICAgICAgICAgICAgICAgaW50ZXJ2YWxFbmQgKz0gcGl0Y2hTaGlmdCAqIGVudmVsb3BlRW5kOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChlZmZlY3RzSW5jbHVkZURldHVuZShpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBlbnZlbG9wZVN0YXJ0ID0gZW52ZWxvcGVTdGFydHNbMTVdOwogICAgICAgICAgICAgICAgY29uc3QgZW52ZWxvcGVFbmQgPSBlbnZlbG9wZUVuZHNbMTVdOwogICAgICAgICAgICAgICAgaW50ZXJ2YWxTdGFydCArPSBTeW50aC5kZXR1bmVUb0NlbnRzKChpbnN0cnVtZW50LmRldHVuZSAtIENvbmZpZy5kZXR1bmVDZW50ZXIpICogZW52ZWxvcGVTdGFydCkgKiBDb25maWcucGl0Y2hlc1Blck9jdGF2ZSAvICgxMi4wICogMTAwLjApOwogICAgICAgICAgICAgICAgaW50ZXJ2YWxFbmQgKz0gU3ludGguZGV0dW5lVG9DZW50cygoaW5zdHJ1bWVudC5kZXR1bmUgLSBDb25maWcuZGV0dW5lQ2VudGVyKSAqIGVudmVsb3BlRW5kKSAqIENvbmZpZy5waXRjaGVzUGVyT2N0YXZlIC8gKDEyLjAgKiAxMDAuMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGVmZmVjdHNJbmNsdWRlVmlicmF0byhpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkZWxheVRpY2tzID0gQ29uZmlnLnZpYnJhdG9zW2luc3RydW1lbnQudmlicmF0b10uZGVsYXlUaWNrczsKICAgICAgICAgICAgICAgIGNvbnN0IHZpYnJhdG9BbXBsaXR1ZGUgPSBDb25maWcudmlicmF0b3NbaW5zdHJ1bWVudC52aWJyYXRvXS5hbXBsaXR1ZGU7CiAgICAgICAgICAgICAgICBsZXQgdmlicmF0b1N0YXJ0OwogICAgICAgICAgICAgICAgaWYgKHRvbmUucHJldlZpYnJhdG8gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHZpYnJhdG9TdGFydCA9IHRvbmUucHJldlZpYnJhdG87CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgbGZvU3RhcnQgPSBTeW50aC5nZXRMRk9BbXBsaXR1ZGUoaW5zdHJ1bWVudCwgc2Vjb25kc1BlclBhcnQgKiBwYXJ0VGltZVN0YXJ0KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB2aWJyYXRvRGVwdGhFbnZlbG9wZVN0YXJ0ID0gZW52ZWxvcGVTdGFydHNbMTZdOwogICAgICAgICAgICAgICAgICAgIHZpYnJhdG9TdGFydCA9IHZpYnJhdG9BbXBsaXR1ZGUgKiBsZm9TdGFydCAqIHZpYnJhdG9EZXB0aEVudmVsb3BlU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRlbGF5VGlja3MgPiAwLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGlja3NVbnRpbFZpYnJhdG9TdGFydCA9IGRlbGF5VGlja3MgLSBlbnZlbG9wZUNvbXB1dGVyLm5vdGVUaWNrc1N0YXJ0OwogICAgICAgICAgICAgICAgICAgICAgICB2aWJyYXRvU3RhcnQgKj0gTWF0aC5tYXgoMC4wLCBNYXRoLm1pbigxLjAsIDEuMCAtIHRpY2tzVW50aWxWaWJyYXRvU3RhcnQgLyAyLjApKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZXQgbGZvRW5kID0gU3ludGguZ2V0TEZPQW1wbGl0dWRlKGluc3RydW1lbnQsIHNlY29uZHNQZXJQYXJ0ICogcGFydFRpbWVFbmQpOwogICAgICAgICAgICAgICAgY29uc3QgdmlicmF0b0RlcHRoRW52ZWxvcGVFbmQgPSBlbnZlbG9wZUVuZHNbMTZdOwogICAgICAgICAgICAgICAgbGV0IHZpYnJhdG9FbmQgPSB2aWJyYXRvQW1wbGl0dWRlICogbGZvRW5kICogdmlicmF0b0RlcHRoRW52ZWxvcGVFbmQ7CiAgICAgICAgICAgICAgICBpZiAoZGVsYXlUaWNrcyA+IDAuMCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRpY2tzVW50aWxWaWJyYXRvRW5kID0gZGVsYXlUaWNrcyAtIGVudmVsb3BlQ29tcHV0ZXIubm90ZVRpY2tzRW5kOwogICAgICAgICAgICAgICAgICAgIHZpYnJhdG9FbmQgKj0gTWF0aC5tYXgoMC4wLCBNYXRoLm1pbigxLjAsIDEuMCAtIHRpY2tzVW50aWxWaWJyYXRvRW5kIC8gMi4wKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0b25lLnByZXZWaWJyYXRvID0gdmlicmF0b0VuZDsKICAgICAgICAgICAgICAgIGludGVydmFsU3RhcnQgKz0gdmlicmF0b1N0YXJ0OwogICAgICAgICAgICAgICAgaW50ZXJ2YWxFbmQgKz0gdmlicmF0b0VuZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoKCF0cmFuc2l0aW9uLmlzU2VhbWxlc3MgJiYgIXRvbmUuZm9yY2VDb250aW51ZUF0U3RhcnQpIHx8IHRvbmUucHJldk5vdGUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgY29uc3QgZmFkZUluU2Vjb25kcyA9IGluc3RydW1lbnQuZ2V0RmFkZUluU2Vjb25kcygpOwogICAgICAgICAgICAgICAgaWYgKGZhZGVJblNlY29uZHMgPiAwLjApIHsKICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRXhwcmVzc2lvblN0YXJ0ICo9IE1hdGgubWluKDEuMCwgZW52ZWxvcGVDb21wdXRlci5ub3RlU2Vjb25kc1N0YXJ0IC8gZmFkZUluU2Vjb25kcyk7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbkV4cHJlc3Npb25FbmQgKj0gTWF0aC5taW4oMS4wLCBlbnZlbG9wZUNvbXB1dGVyLm5vdGVTZWNvbmRzRW5kIC8gZmFkZUluU2Vjb25kcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudHlwZSA9PSA0ICYmIHRvbmUuZHJ1bXNldFBpdGNoID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRvbmUuZHJ1bXNldFBpdGNoID0gdG9uZS5waXRjaGVzWzBdOwogICAgICAgICAgICAgICAgaWYgKHRvbmUubm90ZSAhPSBudWxsKQogICAgICAgICAgICAgICAgICAgIHRvbmUuZHJ1bXNldFBpdGNoICs9IHRvbmUubm90ZS5waWNrTWFpbkludGVydmFsKCk7CiAgICAgICAgICAgICAgICB0b25lLmRydW1zZXRQaXRjaCA9IE1hdGgubWF4KDAsIE1hdGgubWluKENvbmZpZy5kcnVtQ291bnQgLSAxLCB0b25lLmRydW1zZXRQaXRjaCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGxldCBub3RlRmlsdGVyRXhwcmVzc2lvbiA9IGVudmVsb3BlQ29tcHV0ZXIubG93cGFzc0N1dG9mZkRlY2F5Vm9sdW1lQ29tcGVuc2F0aW9uOwogICAgICAgICAgICBpZiAoIWVmZmVjdHNJbmNsdWRlTm90ZUZpbHRlcihpbnN0cnVtZW50LmVmZmVjdHMpKSB7CiAgICAgICAgICAgICAgICB0b25lLm5vdGVGaWx0ZXJDb3VudCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBub3RlRmlsdGVyU2V0dGluZ3MgPSBpbnN0cnVtZW50Lm5vdGVGaWx0ZXI7CiAgICAgICAgICAgICAgICBjb25zdCBub3RlQWxsRnJlcXNFbnZlbG9wZVN0YXJ0ID0gZW52ZWxvcGVTdGFydHNbMV07CiAgICAgICAgICAgICAgICBjb25zdCBub3RlQWxsRnJlcXNFbnZlbG9wZUVuZCA9IGVudmVsb3BlRW5kc1sxXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbm90ZUZpbHRlclNldHRpbmdzLmNvbnRyb2xQb2ludENvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBub3RlRnJlcUVudmVsb3BlU3RhcnQgPSBlbnZlbG9wZVN0YXJ0c1sxNyArIGldOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vdGVGcmVxRW52ZWxvcGVFbmQgPSBlbnZlbG9wZUVuZHNbMTcgKyBpXTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBub3RlUGVha0VudmVsb3BlU3RhcnQgPSBlbnZlbG9wZVN0YXJ0c1syNSArIGldOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vdGVQZWFrRW52ZWxvcGVFbmQgPSBlbnZlbG9wZUVuZHNbMjUgKyBpXTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwb2ludCA9IG5vdGVGaWx0ZXJTZXR0aW5ncy5jb250cm9sUG9pbnRzW2ldOwogICAgICAgICAgICAgICAgICAgIHBvaW50LnRvQ29lZmZpY2llbnRzKFN5bnRoLnRlbXBGaWx0ZXJTdGFydENvZWZmaWNpZW50cywgc3ludGguc2FtcGxlc1BlclNlY29uZCwgbm90ZUFsbEZyZXFzRW52ZWxvcGVTdGFydCAqIG5vdGVGcmVxRW52ZWxvcGVTdGFydCwgbm90ZVBlYWtFbnZlbG9wZVN0YXJ0KTsKICAgICAgICAgICAgICAgICAgICBwb2ludC50b0NvZWZmaWNpZW50cyhTeW50aC50ZW1wRmlsdGVyRW5kQ29lZmZpY2llbnRzLCBzeW50aC5zYW1wbGVzUGVyU2Vjb25kLCBub3RlQWxsRnJlcXNFbnZlbG9wZUVuZCAqIG5vdGVGcmVxRW52ZWxvcGVFbmQsIG5vdGVQZWFrRW52ZWxvcGVFbmQpOwogICAgICAgICAgICAgICAgICAgIGlmICh0b25lLm5vdGVGaWx0ZXJzLmxlbmd0aCA8PSBpKQogICAgICAgICAgICAgICAgICAgICAgICB0b25lLm5vdGVGaWx0ZXJzW2ldID0gbmV3IER5bmFtaWNCaXF1YWRGaWx0ZXIoKTsKICAgICAgICAgICAgICAgICAgICB0b25lLm5vdGVGaWx0ZXJzW2ldLmxvYWRDb2VmZmljaWVudHNXaXRoR3JhZGllbnQoU3ludGgudGVtcEZpbHRlclN0YXJ0Q29lZmZpY2llbnRzLCBTeW50aC50ZW1wRmlsdGVyRW5kQ29lZmZpY2llbnRzLCAxLjAgLyBydW5MZW5ndGgsIHBvaW50LnR5cGUgPT0gMCk7CiAgICAgICAgICAgICAgICAgICAgbm90ZUZpbHRlckV4cHJlc3Npb24gKj0gcG9pbnQuZ2V0Vm9sdW1lQ29tcGVuc2F0aW9uTXVsdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdG9uZS5ub3RlRmlsdGVyQ291bnQgPSBub3RlRmlsdGVyU2V0dGluZ3MuY29udHJvbFBvaW50Q291bnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudHlwZSA9PSA0KSB7CiAgICAgICAgICAgICAgICBjb25zdCBkcnVtc2V0RmlsdGVyRW52ZWxvcGUgPSBpbnN0cnVtZW50LmdldERydW1zZXRFbnZlbG9wZSh0b25lLmRydW1zZXRQaXRjaCk7CiAgICAgICAgICAgICAgICBub3RlRmlsdGVyRXhwcmVzc2lvbiAqPSBFbnZlbG9wZUNvbXB1dGVyLmdldExvd3Bhc3NDdXRvZmZEZWNheVZvbHVtZUNvbXBlbnNhdGlvbihkcnVtc2V0RmlsdGVyRW52ZWxvcGUpOwogICAgICAgICAgICAgICAgbGV0IGRydW1zZXRGaWx0ZXJFbnZlbG9wZVN0YXJ0ID0gRW52ZWxvcGVDb21wdXRlci5jb21wdXRlRW52ZWxvcGUoZHJ1bXNldEZpbHRlckVudmVsb3BlLCBlbnZlbG9wZUNvbXB1dGVyLm5vdGVTZWNvbmRzU3RhcnQsIGJlYXRzUGVyUGFydCAqIHBhcnRUaW1lU3RhcnQsIGVudmVsb3BlQ29tcHV0ZXIubm90ZVNpemVTdGFydCk7CiAgICAgICAgICAgICAgICBsZXQgZHJ1bXNldEZpbHRlckVudmVsb3BlRW5kID0gRW52ZWxvcGVDb21wdXRlci5jb21wdXRlRW52ZWxvcGUoZHJ1bXNldEZpbHRlckVudmVsb3BlLCBlbnZlbG9wZUNvbXB1dGVyLm5vdGVTZWNvbmRzRW5kLCBiZWF0c1BlclBhcnQgKiBwYXJ0VGltZUVuZCwgZW52ZWxvcGVDb21wdXRlci5ub3RlU2l6ZUVuZCk7CiAgICAgICAgICAgICAgICBpZiAoZW52ZWxvcGVDb21wdXRlci5wcmV2U2xpZGVTdGFydCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG90aGVyID0gRW52ZWxvcGVDb21wdXRlci5jb21wdXRlRW52ZWxvcGUoZHJ1bXNldEZpbHRlckVudmVsb3BlLCBlbnZlbG9wZUNvbXB1dGVyLnByZXZOb3RlU2Vjb25kc1N0YXJ0LCBiZWF0c1BlclBhcnQgKiBwYXJ0VGltZVN0YXJ0LCBlbnZlbG9wZUNvbXB1dGVyLnByZXZOb3RlU2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgZHJ1bXNldEZpbHRlckVudmVsb3BlU3RhcnQgKz0gKG90aGVyIC0gZHJ1bXNldEZpbHRlckVudmVsb3BlU3RhcnQpICogZW52ZWxvcGVDb21wdXRlci5wcmV2U2xpZGVSYXRpb1N0YXJ0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGVudmVsb3BlQ29tcHV0ZXIucHJldlNsaWRlRW5kKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3RoZXIgPSBFbnZlbG9wZUNvbXB1dGVyLmNvbXB1dGVFbnZlbG9wZShkcnVtc2V0RmlsdGVyRW52ZWxvcGUsIGVudmVsb3BlQ29tcHV0ZXIucHJldk5vdGVTZWNvbmRzRW5kLCBiZWF0c1BlclBhcnQgKiBwYXJ0VGltZUVuZCwgZW52ZWxvcGVDb21wdXRlci5wcmV2Tm90ZVNpemUpOwogICAgICAgICAgICAgICAgICAgIGRydW1zZXRGaWx0ZXJFbnZlbG9wZUVuZCArPSAob3RoZXIgLSBkcnVtc2V0RmlsdGVyRW52ZWxvcGVFbmQpICogZW52ZWxvcGVDb21wdXRlci5wcmV2U2xpZGVSYXRpb0VuZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlbnZlbG9wZUNvbXB1dGVyLm5leHRTbGlkZVN0YXJ0KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3RoZXIgPSBFbnZlbG9wZUNvbXB1dGVyLmNvbXB1dGVFbnZlbG9wZShkcnVtc2V0RmlsdGVyRW52ZWxvcGUsIDAuMCwgYmVhdHNQZXJQYXJ0ICogcGFydFRpbWVTdGFydCwgZW52ZWxvcGVDb21wdXRlci5uZXh0Tm90ZVNpemUpOwogICAgICAgICAgICAgICAgICAgIGRydW1zZXRGaWx0ZXJFbnZlbG9wZVN0YXJ0ICs9IChvdGhlciAtIGRydW1zZXRGaWx0ZXJFbnZlbG9wZVN0YXJ0KSAqIGVudmVsb3BlQ29tcHV0ZXIubmV4dFNsaWRlUmF0aW9TdGFydDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChlbnZlbG9wZUNvbXB1dGVyLm5leHRTbGlkZUVuZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IG90aGVyID0gRW52ZWxvcGVDb21wdXRlci5jb21wdXRlRW52ZWxvcGUoZHJ1bXNldEZpbHRlckVudmVsb3BlLCAwLjAsIGJlYXRzUGVyUGFydCAqIHBhcnRUaW1lRW5kLCBlbnZlbG9wZUNvbXB1dGVyLm5leHROb3RlU2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgZHJ1bXNldEZpbHRlckVudmVsb3BlRW5kICs9IChvdGhlciAtIGRydW1zZXRGaWx0ZXJFbnZlbG9wZUVuZCkgKiBlbnZlbG9wZUNvbXB1dGVyLm5leHRTbGlkZVJhdGlvRW5kOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgcG9pbnQgPSBzeW50aC50ZW1wRHJ1bVNldENvbnRyb2xQb2ludDsKICAgICAgICAgICAgICAgIHBvaW50LnR5cGUgPSAwOwogICAgICAgICAgICAgICAgcG9pbnQuZ2FpbiA9IEZpbHRlckNvbnRyb2xQb2ludC5nZXRSb3VuZGVkU2V0dGluZ1ZhbHVlRnJvbUxpbmVhckdhaW4oMC41KTsKICAgICAgICAgICAgICAgIHBvaW50LmZyZXEgPSBGaWx0ZXJDb250cm9sUG9pbnQuZ2V0Um91bmRlZFNldHRpbmdWYWx1ZUZyb21Ieig4MDAwLjApOwogICAgICAgICAgICAgICAgcG9pbnQudG9Db2VmZmljaWVudHMoU3ludGgudGVtcEZpbHRlclN0YXJ0Q29lZmZpY2llbnRzLCBzeW50aC5zYW1wbGVzUGVyU2Vjb25kLCBkcnVtc2V0RmlsdGVyRW52ZWxvcGVTdGFydCAqICgxLjAgKyBkcnVtc2V0RmlsdGVyRW52ZWxvcGVTdGFydCksIDEuMCk7CiAgICAgICAgICAgICAgICBwb2ludC50b0NvZWZmaWNpZW50cyhTeW50aC50ZW1wRmlsdGVyRW5kQ29lZmZpY2llbnRzLCBzeW50aC5zYW1wbGVzUGVyU2Vjb25kLCBkcnVtc2V0RmlsdGVyRW52ZWxvcGVFbmQgKiAoMS4wICsgZHJ1bXNldEZpbHRlckVudmVsb3BlRW5kKSwgMS4wKTsKICAgICAgICAgICAgICAgIGlmICh0b25lLm5vdGVGaWx0ZXJzLmxlbmd0aCA9PSB0b25lLm5vdGVGaWx0ZXJDb3VudCkKICAgICAgICAgICAgICAgICAgICB0b25lLm5vdGVGaWx0ZXJzW3RvbmUubm90ZUZpbHRlckNvdW50XSA9IG5ldyBEeW5hbWljQmlxdWFkRmlsdGVyKCk7CiAgICAgICAgICAgICAgICB0b25lLm5vdGVGaWx0ZXJzW3RvbmUubm90ZUZpbHRlckNvdW50XS5sb2FkQ29lZmZpY2llbnRzV2l0aEdyYWRpZW50KFN5bnRoLnRlbXBGaWx0ZXJTdGFydENvZWZmaWNpZW50cywgU3ludGgudGVtcEZpbHRlckVuZENvZWZmaWNpZW50cywgMS4wIC8gcnVuTGVuZ3RoLCB0cnVlKTsKICAgICAgICAgICAgICAgIHRvbmUubm90ZUZpbHRlckNvdW50Kys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm90ZUZpbHRlckV4cHJlc3Npb24gPSBNYXRoLm1pbigzLjAsIG5vdGVGaWx0ZXJFeHByZXNzaW9uKTsKICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudHlwZSA9PSAxKSB7CiAgICAgICAgICAgICAgICBsZXQgc2luZUV4cHJlc3Npb25Cb29zdCA9IDEuMDsKICAgICAgICAgICAgICAgIGxldCB0b3RhbENhcnJpZXJFeHByZXNzaW9uID0gMC4wOwogICAgICAgICAgICAgICAgbGV0IGFycGVnZ2lvSW50ZXJ2YWwgPSAwOwogICAgICAgICAgICAgICAgY29uc3QgYXJwZWdnaWF0ZXMgPSBjaG9yZC5hcnBlZ2dpYXRlczsKICAgICAgICAgICAgICAgIGlmICh0b25lLnBpdGNoQ291bnQgPiAxICYmIGFycGVnZ2lhdGVzKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXJwZWdnaW8gPSBNYXRoLmZsb29yKChzeW50aC50aWNrICsgc3ludGgucGFydCAqIENvbmZpZy50aWNrc1BlclBhcnQpIC8gQ29uZmlnLnJoeXRobXNbc29uZy5yaHl0aG1dLnRpY2tzUGVyQXJwZWdnaW8pOwogICAgICAgICAgICAgICAgICAgIGFycGVnZ2lvSW50ZXJ2YWwgPSB0b25lLnBpdGNoZXNbZ2V0QXJwZWdnaW9QaXRjaEluZGV4KHRvbmUucGl0Y2hDb3VudCwgc29uZy5yaHl0aG0sIGFycGVnZ2lvKV0gLSB0b25lLnBpdGNoZXNbMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCBjYXJyaWVyQ291bnQgPSBDb25maWcuYWxnb3JpdGhtc1tpbnN0cnVtZW50LmFsZ29yaXRobV0uY2FycmllckNvdW50OwogICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBDb25maWcub3BlcmF0b3JDb3VudDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXNzb2NpYXRlZENhcnJpZXJJbmRleCA9IENvbmZpZy5hbGdvcml0aG1zW2luc3RydW1lbnQuYWxnb3JpdGhtXS5hc3NvY2lhdGVkQ2FycmllcltpXSAtIDE7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGl0Y2ggPSB0b25lLnBpdGNoZXNbYXJwZWdnaWF0ZXMgPyAwIDogKChpIDwgdG9uZS5waXRjaENvdW50KSA/IGkgOiAoKGFzc29jaWF0ZWRDYXJyaWVySW5kZXggPCB0b25lLnBpdGNoQ291bnQpID8gYXNzb2NpYXRlZENhcnJpZXJJbmRleCA6IDApKV07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZnJlcU11bHQgPSBDb25maWcub3BlcmF0b3JGcmVxdWVuY2llc1tpbnN0cnVtZW50Lm9wZXJhdG9yc1tpXS5mcmVxdWVuY3ldLm11bHQ7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW50ZXJ2YWwgPSBDb25maWcub3BlcmF0b3JDYXJyaWVySW50ZXJ2YWxbYXNzb2NpYXRlZENhcnJpZXJJbmRleF0gKyBhcnBlZ2dpb0ludGVydmFsOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoU3RhcnQgPSBiYXNlUGl0Y2ggKyAocGl0Y2ggKyBpbnRlcnZhbFN0YXJ0KSAqIGludGVydmFsU2NhbGUgKyBpbnRlcnZhbDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwaXRjaEVuZCA9IGJhc2VQaXRjaCArIChwaXRjaCArIGludGVydmFsRW5kKSAqIGludGVydmFsU2NhbGUgKyBpbnRlcnZhbDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBiYXNlRnJlcVN0YXJ0ID0gSW5zdHJ1bWVudC5mcmVxdWVuY3lGcm9tUGl0Y2gocGl0Y2hTdGFydCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmFzZUZyZXFFbmQgPSBJbnN0cnVtZW50LmZyZXF1ZW5jeUZyb21QaXRjaChwaXRjaEVuZCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaHpPZmZzZXQgPSBDb25maWcub3BlcmF0b3JGcmVxdWVuY2llc1tpbnN0cnVtZW50Lm9wZXJhdG9yc1tpXS5mcmVxdWVuY3ldLmh6T2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldEZyZXFTdGFydCA9IGZyZXFNdWx0ICogYmFzZUZyZXFTdGFydCArIGh6T2Zmc2V0OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldEZyZXFFbmQgPSBmcmVxTXVsdCAqIGJhc2VGcmVxRW5kICsgaHpPZmZzZXQ7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZnJlcUVudmVsb3BlU3RhcnQgPSBlbnZlbG9wZVN0YXJ0c1s1ICsgaV07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZnJlcUVudmVsb3BlRW5kID0gZW52ZWxvcGVFbmRzWzUgKyBpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgZnJlcVN0YXJ0OwogICAgICAgICAgICAgICAgICAgIGxldCBmcmVxRW5kOwogICAgICAgICAgICAgICAgICAgIGlmIChmcmVxRW52ZWxvcGVTdGFydCAhPSAxLjAgfHwgZnJlcUVudmVsb3BlRW5kICE9IDEuMCkgewogICAgICAgICAgICAgICAgICAgICAgICBmcmVxU3RhcnQgPSBNYXRoLnBvdygyLjAsIE1hdGgubG9nMih0YXJnZXRGcmVxU3RhcnQgLyBiYXNlRnJlcVN0YXJ0KSAqIGZyZXFFbnZlbG9wZVN0YXJ0KSAqIGJhc2VGcmVxU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGZyZXFFbmQgPSBNYXRoLnBvdygyLjAsIE1hdGgubG9nMih0YXJnZXRGcmVxRW5kIC8gYmFzZUZyZXFFbmQpICogZnJlcUVudmVsb3BlRW5kKSAqIGJhc2VGcmVxRW5kOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlcVN0YXJ0ID0gdGFyZ2V0RnJlcVN0YXJ0OwogICAgICAgICAgICAgICAgICAgICAgICBmcmVxRW5kID0gdGFyZ2V0RnJlcUVuZDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdG9uZS5waGFzZURlbHRhc1tpXSA9IGZyZXFTdGFydCAqIHNhbXBsZVRpbWUgKiBDb25maWcuc2luZVdhdmVMZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgdG9uZS5waGFzZURlbHRhU2NhbGVzW2ldID0gTWF0aC5wb3coZnJlcUVuZCAvIGZyZXFTdGFydCwgMS4wIC8gcnVuTGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbXBsaXR1ZGVDdXJ2ZSA9IFN5bnRoLm9wZXJhdG9yQW1wbGl0dWRlQ3VydmUoaW5zdHJ1bWVudC5vcGVyYXRvcnNbaV0uYW1wbGl0dWRlKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhbXBsaXR1ZGVNdWx0ID0gYW1wbGl0dWRlQ3VydmUgKiBDb25maWcub3BlcmF0b3JGcmVxdWVuY2llc1tpbnN0cnVtZW50Lm9wZXJhdG9yc1tpXS5mcmVxdWVuY3ldLmFtcGxpdHVkZVNpZ247CiAgICAgICAgICAgICAgICAgICAgbGV0IGV4cHJlc3Npb25TdGFydCA9IGFtcGxpdHVkZU11bHQ7CiAgICAgICAgICAgICAgICAgICAgbGV0IGV4cHJlc3Npb25FbmQgPSBhbXBsaXR1ZGVNdWx0OwogICAgICAgICAgICAgICAgICAgIGlmIChpIDwgY2FycmllckNvdW50KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpdGNoRXhwcmVzc2lvblN0YXJ0ID0gTWF0aC5wb3coMi4wLCAtKHBpdGNoU3RhcnQgLSBleHByZXNzaW9uUmVmZXJlbmNlUGl0Y2gpIC8gcGl0Y2hEYW1waW5nKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGl0Y2hFeHByZXNzaW9uRW5kID0gTWF0aC5wb3coMi4wLCAtKHBpdGNoRW5kIC0gZXhwcmVzc2lvblJlZmVyZW5jZVBpdGNoKSAvIHBpdGNoRGFtcGluZyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb25TdGFydCAqPSBiYXNlRXhwcmVzc2lvbiAqIHBpdGNoRXhwcmVzc2lvblN0YXJ0ICogdHJhbnNpdGlvbkV4cHJlc3Npb25TdGFydCAqIG5vdGVGaWx0ZXJFeHByZXNzaW9uICogY2hvcmRFeHByZXNzaW9uU3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb25FbmQgKj0gYmFzZUV4cHJlc3Npb24gKiBwaXRjaEV4cHJlc3Npb25FbmQgKiB0cmFuc2l0aW9uRXhwcmVzc2lvbkVuZCAqIG5vdGVGaWx0ZXJFeHByZXNzaW9uICogY2hvcmRFeHByZXNzaW9uRW5kOwogICAgICAgICAgICAgICAgICAgICAgICBleHByZXNzaW9uU3RhcnQgKj0gZW52ZWxvcGVTdGFydHNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb25FbmQgKj0gZW52ZWxvcGVFbmRzWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB0b3RhbENhcnJpZXJFeHByZXNzaW9uICs9IGFtcGxpdHVkZUN1cnZlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvblN0YXJ0ICo9IENvbmZpZy5zaW5lV2F2ZUxlbmd0aCAqIDEuNTsKICAgICAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbkVuZCAqPSBDb25maWcuc2luZVdhdmVMZW5ndGggKiAxLjU7CiAgICAgICAgICAgICAgICAgICAgICAgIHNpbmVFeHByZXNzaW9uQm9vc3QgKj0gMS4wIC0gTWF0aC5taW4oMS4wLCBpbnN0cnVtZW50Lm9wZXJhdG9yc1tpXS5hbXBsaXR1ZGUgLyAxNSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGV4cHJlc3Npb25TdGFydCAqPSBlbnZlbG9wZVN0YXJ0c1s5ICsgaV07CiAgICAgICAgICAgICAgICAgICAgZXhwcmVzc2lvbkVuZCAqPSBlbnZlbG9wZUVuZHNbOSArIGldOwogICAgICAgICAgICAgICAgICAgIHRvbmUuZXhwcmVzc2lvblN0YXJ0c1tpXSA9IGV4cHJlc3Npb25TdGFydDsKICAgICAgICAgICAgICAgICAgICB0b25lLmV4cHJlc3Npb25EZWx0YXNbaV0gPSAoZXhwcmVzc2lvbkVuZCAtIGV4cHJlc3Npb25TdGFydCkgLyBydW5MZW5ndGg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzaW5lRXhwcmVzc2lvbkJvb3N0ICo9IChNYXRoLnBvdygyLjAsICgyLjAgLSAxLjQgKiBpbnN0cnVtZW50LmZlZWRiYWNrQW1wbGl0dWRlIC8gMTUuMCkpIC0gMS4wKSAvIDMuMDsKICAgICAgICAgICAgICAgIHNpbmVFeHByZXNzaW9uQm9vc3QgKj0gMS4wIC0gTWF0aC5taW4oMS4wLCBNYXRoLm1heCgwLjAsIHRvdGFsQ2FycmllckV4cHJlc3Npb24gLSAxKSAvIDIuMCk7CiAgICAgICAgICAgICAgICBzaW5lRXhwcmVzc2lvbkJvb3N0ID0gMS4wICsgc2luZUV4cHJlc3Npb25Cb29zdCAqIDMuMDsKICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2FycmllckNvdW50OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICB0b25lLmV4cHJlc3Npb25TdGFydHNbaV0gKj0gc2luZUV4cHJlc3Npb25Cb29zdDsKICAgICAgICAgICAgICAgICAgICB0b25lLmV4cHJlc3Npb25EZWx0YXNbaV0gKj0gc2luZUV4cHJlc3Npb25Cb29zdDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IGZlZWRiYWNrQW1wbGl0dWRlID0gQ29uZmlnLnNpbmVXYXZlTGVuZ3RoICogMC4zICogaW5zdHJ1bWVudC5mZWVkYmFja0FtcGxpdHVkZSAvIDE1LjA7CiAgICAgICAgICAgICAgICBsZXQgZmVlZGJhY2tTdGFydCA9IGZlZWRiYWNrQW1wbGl0dWRlICogZW52ZWxvcGVTdGFydHNbMTNdOwogICAgICAgICAgICAgICAgbGV0IGZlZWRiYWNrRW5kID0gZmVlZGJhY2tBbXBsaXR1ZGUgKiBlbnZlbG9wZUVuZHNbMTNdOwogICAgICAgICAgICAgICAgdG9uZS5mZWVkYmFja011bHQgPSBmZWVkYmFja1N0YXJ0OwogICAgICAgICAgICAgICAgdG9uZS5mZWVkYmFja0RlbHRhID0gKGZlZWRiYWNrRW5kIC0gdG9uZS5mZWVkYmFja011bHQpIC8gcnVuTGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgYmFzZVBoYXNlRGVsdGFTY2FsZSA9IE1hdGgucG93KDIuMCwgKChpbnRlcnZhbEVuZCAtIGludGVydmFsU3RhcnQpICogaW50ZXJ2YWxTY2FsZSAvIDEyLjApIC8gcnVuTGVuZ3RoKTsKICAgICAgICAgICAgICAgIGxldCBwaXRjaCA9IHRvbmUucGl0Y2hlc1swXTsKICAgICAgICAgICAgICAgIGlmICh0b25lLnBpdGNoQ291bnQgPiAxICYmIChjaG9yZC5hcnBlZ2dpYXRlcyB8fCBjaG9yZC5jdXN0b21JbnRlcnZhbCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhcnBlZ2dpbyA9IE1hdGguZmxvb3IoKHN5bnRoLnRpY2sgKyBzeW50aC5wYXJ0ICogQ29uZmlnLnRpY2tzUGVyUGFydCkgLyBDb25maWcucmh5dGhtc1tzb25nLnJoeXRobV0udGlja3NQZXJBcnBlZ2dpbyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNob3JkLmN1c3RvbUludGVydmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGludGVydmFsT2Zmc2V0ID0gdG9uZS5waXRjaGVzWzEgKyBnZXRBcnBlZ2dpb1BpdGNoSW5kZXgodG9uZS5waXRjaENvdW50IC0gMSwgc29uZy5yaHl0aG0sIGFycGVnZ2lvKV0gLSB0b25lLnBpdGNoZXNbMF07CiAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUuc3BlY2lhbEludGVydmFsTXVsdCA9IE1hdGgucG93KDIuMCwgaW50ZXJ2YWxPZmZzZXQgLyAxMi4wKTsKICAgICAgICAgICAgICAgICAgICAgICAgdG9uZS5zcGVjaWFsSW50ZXJ2YWxFeHByZXNzaW9uTXVsdCA9IE1hdGgucG93KDIuMCwgLWludGVydmFsT2Zmc2V0IC8gcGl0Y2hEYW1waW5nKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBpdGNoID0gdG9uZS5waXRjaGVzW2dldEFycGVnZ2lvUGl0Y2hJbmRleCh0b25lLnBpdGNoQ291bnQsIHNvbmcucmh5dGhtLCBhcnBlZ2dpbyldOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0UGl0Y2ggPSBiYXNlUGl0Y2ggKyAocGl0Y2ggKyBpbnRlcnZhbFN0YXJ0KSAqIGludGVydmFsU2NhbGU7CiAgICAgICAgICAgICAgICBjb25zdCBlbmRQaXRjaCA9IGJhc2VQaXRjaCArIChwaXRjaCArIGludGVydmFsRW5kKSAqIGludGVydmFsU2NhbGU7CiAgICAgICAgICAgICAgICBjb25zdCBwaXRjaEV4cHJlc3Npb25TdGFydCA9IE1hdGgucG93KDIuMCwgLShzdGFydFBpdGNoIC0gZXhwcmVzc2lvblJlZmVyZW5jZVBpdGNoKSAvIHBpdGNoRGFtcGluZyk7CiAgICAgICAgICAgICAgICBjb25zdCBwaXRjaEV4cHJlc3Npb25FbmQgPSBNYXRoLnBvdygyLjAsIC0oZW5kUGl0Y2ggLSBleHByZXNzaW9uUmVmZXJlbmNlUGl0Y2gpIC8gcGl0Y2hEYW1waW5nKTsKICAgICAgICAgICAgICAgIGxldCBzZXR0aW5nc0V4cHJlc3Npb25NdWx0ID0gYmFzZUV4cHJlc3Npb24gKiBub3RlRmlsdGVyRXhwcmVzc2lvbjsKICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50LnR5cGUgPT0gMikgewogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzRXhwcmVzc2lvbk11bHQgKj0gQ29uZmlnLmNoaXBOb2lzZXNbaW5zdHJ1bWVudC5jaGlwTm9pc2VdLmV4cHJlc3Npb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaW5zdHJ1bWVudC50eXBlID09IDApIHsKICAgICAgICAgICAgICAgICAgICBzZXR0aW5nc0V4cHJlc3Npb25NdWx0ICo9IENvbmZpZy5jaGlwV2F2ZXNbaW5zdHJ1bWVudC5jaGlwV2F2ZV0uZXhwcmVzc2lvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpbnN0cnVtZW50LnR5cGUgPT0gNikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGJhc2VQdWxzZVdpZHRoID0gZ2V0UHVsc2VXaWR0aFJhdGlvKGluc3RydW1lbnQucHVsc2VXaWR0aCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcHVsc2VXaWR0aFN0YXJ0ID0gYmFzZVB1bHNlV2lkdGggKiBlbnZlbG9wZVN0YXJ0c1syXTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwdWxzZVdpZHRoRW5kID0gYmFzZVB1bHNlV2lkdGggKiBlbnZlbG9wZUVuZHNbMl07CiAgICAgICAgICAgICAgICAgICAgdG9uZS5wdWxzZVdpZHRoID0gcHVsc2VXaWR0aFN0YXJ0OwogICAgICAgICAgICAgICAgICAgIHRvbmUucHVsc2VXaWR0aERlbHRhID0gKHB1bHNlV2lkdGhFbmQgLSBwdWxzZVdpZHRoU3RhcnQpIC8gcnVuTGVuZ3RoOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudHlwZSA9PSA3KSB7CiAgICAgICAgICAgICAgICAgICAgc2V0dGluZ3NFeHByZXNzaW9uTXVsdCAqPSBNYXRoLnBvdygyLjAsIDAuNyAqICgxLjAgLSBpbnN0cnVtZW50LnN0cmluZ1N1c3RhaW4gLyAoQ29uZmlnLnN0cmluZ1N1c3RhaW5SYW5nZSAtIDEpKSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5pc29uID0gQ29uZmlnLnVuaXNvbnNbaW5zdHJ1bWVudC51bmlzb25dOwogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSB0b25lLnBpY2tlZFN0cmluZ3MubGVuZ3RoOyBpIDwgdW5pc29uLnZvaWNlczsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRvbmUucGlja2VkU3RyaW5nc1tpXSA9IG5ldyBQaWNrZWRTdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHRvbmUuYXROb3RlU3RhcnQgJiYgIXRyYW5zaXRpb24uY29udGludWVzICYmICF0b25lLmZvcmNlQ29udGludWVBdFN0YXJ0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgcGlja2VkU3RyaW5nIG9mIHRvbmUucGlja2VkU3RyaW5ncykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGlja2VkU3RyaW5nLmRlbGF5SW5kZXggPSAtMTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0RnJlcSA9IEluc3RydW1lbnQuZnJlcXVlbmN5RnJvbVBpdGNoKHN0YXJ0UGl0Y2gpOwogICAgICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudHlwZSA9PSAwIHx8IGluc3RydW1lbnQudHlwZSA9PSA1IHx8IGluc3RydW1lbnQudHlwZSA9PSA3KSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5pc29uID0gQ29uZmlnLnVuaXNvbnNbaW5zdHJ1bWVudC51bmlzb25dOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHZvaWNlQ291bnRFeHByZXNzaW9uID0gKGluc3RydW1lbnQudHlwZSA9PSA3KSA/IDEgOiB1bmlzb24udm9pY2VzIC8gMi4wOwogICAgICAgICAgICAgICAgICAgIHNldHRpbmdzRXhwcmVzc2lvbk11bHQgKj0gdW5pc29uLmV4cHJlc3Npb24gKiB2b2ljZUNvdW50RXhwcmVzc2lvbjsKICAgICAgICAgICAgICAgICAgICBjb25zdCB1bmlzb25FbnZlbG9wZVN0YXJ0ID0gZW52ZWxvcGVTdGFydHNbNF07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5pc29uRW52ZWxvcGVFbmQgPSBlbnZlbG9wZUVuZHNbNF07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5pc29uQVN0YXJ0ID0gTWF0aC5wb3coMi4wLCAodW5pc29uLm9mZnNldCArIHVuaXNvbi5zcHJlYWQpICogdW5pc29uRW52ZWxvcGVTdGFydCAvIDEyLjApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVuaXNvbkFFbmQgPSBNYXRoLnBvdygyLjAsICh1bmlzb24ub2Zmc2V0ICsgdW5pc29uLnNwcmVhZCkgKiB1bmlzb25FbnZlbG9wZUVuZCAvIDEyLjApOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHVuaXNvbkJTdGFydCA9IE1hdGgucG93KDIuMCwgKHVuaXNvbi5vZmZzZXQgLSB1bmlzb24uc3ByZWFkKSAqIHVuaXNvbkVudmVsb3BlU3RhcnQgLyAxMi4wKSAqIHRvbmUuc3BlY2lhbEludGVydmFsTXVsdDsKICAgICAgICAgICAgICAgICAgICBjb25zdCB1bmlzb25CRW5kID0gTWF0aC5wb3coMi4wLCAodW5pc29uLm9mZnNldCAtIHVuaXNvbi5zcHJlYWQpICogdW5pc29uRW52ZWxvcGVFbmQgLyAxMi4wKSAqIHRvbmUuc3BlY2lhbEludGVydmFsTXVsdDsKICAgICAgICAgICAgICAgICAgICB0b25lLnBoYXNlRGVsdGFzWzBdID0gc3RhcnRGcmVxICogc2FtcGxlVGltZSAqIHVuaXNvbkFTdGFydDsKICAgICAgICAgICAgICAgICAgICB0b25lLnBoYXNlRGVsdGFzWzFdID0gc3RhcnRGcmVxICogc2FtcGxlVGltZSAqIHVuaXNvbkJTdGFydDsKICAgICAgICAgICAgICAgICAgICB0b25lLnBoYXNlRGVsdGFTY2FsZXNbMF0gPSBiYXNlUGhhc2VEZWx0YVNjYWxlICogTWF0aC5wb3codW5pc29uQUVuZCAvIHVuaXNvbkFTdGFydCwgMS4wIC8gcnVuTGVuZ3RoKTsKICAgICAgICAgICAgICAgICAgICB0b25lLnBoYXNlRGVsdGFTY2FsZXNbMV0gPSBiYXNlUGhhc2VEZWx0YVNjYWxlICogTWF0aC5wb3codW5pc29uQkVuZCAvIHVuaXNvbkJTdGFydCwgMS4wIC8gcnVuTGVuZ3RoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRvbmUucGhhc2VEZWx0YXNbMF0gPSBzdGFydEZyZXEgKiBzYW1wbGVUaW1lOwogICAgICAgICAgICAgICAgICAgIHRvbmUucGhhc2VEZWx0YVNjYWxlc1swXSA9IGJhc2VQaGFzZURlbHRhU2NhbGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZXQgZXhwcmVzc2lvblN0YXJ0ID0gc2V0dGluZ3NFeHByZXNzaW9uTXVsdCAqIHRyYW5zaXRpb25FeHByZXNzaW9uU3RhcnQgKiBjaG9yZEV4cHJlc3Npb25TdGFydCAqIHBpdGNoRXhwcmVzc2lvblN0YXJ0ICogZW52ZWxvcGVTdGFydHNbMF07CiAgICAgICAgICAgICAgICBsZXQgZXhwcmVzc2lvbkVuZCA9IHNldHRpbmdzRXhwcmVzc2lvbk11bHQgKiB0cmFuc2l0aW9uRXhwcmVzc2lvbkVuZCAqIGNob3JkRXhwcmVzc2lvbkVuZCAqIHBpdGNoRXhwcmVzc2lvbkVuZCAqIGVudmVsb3BlRW5kc1swXTsKICAgICAgICAgICAgICAgIHRvbmUuZXhwcmVzc2lvblN0YXJ0c1swXSA9IGV4cHJlc3Npb25TdGFydDsKICAgICAgICAgICAgICAgIHRvbmUuZXhwcmVzc2lvbkRlbHRhc1swXSA9IChleHByZXNzaW9uRW5kIC0gZXhwcmVzc2lvblN0YXJ0KSAvIHJ1bkxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGF0aWMgZ2V0TEZPQW1wbGl0dWRlKGluc3RydW1lbnQsIHNlY29uZHNJbnRvQmFyKSB7CiAgICAgICAgICAgIGxldCBlZmZlY3QgPSAwLjA7CiAgICAgICAgICAgIGZvciAoY29uc3QgdmlicmF0b1BlcmlvZFNlY29uZHMgb2YgQ29uZmlnLnZpYnJhdG9zW2luc3RydW1lbnQudmlicmF0b10ucGVyaW9kc1NlY29uZHMpIHsKICAgICAgICAgICAgICAgIGVmZmVjdCArPSBNYXRoLnNpbihNYXRoLlBJICogMi4wICogc2Vjb25kc0ludG9CYXIgLyB2aWJyYXRvUGVyaW9kU2Vjb25kcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGVmZmVjdDsKICAgICAgICB9CiAgICAgICAgc3RhdGljIGdldEluc3RydW1lbnRTeW50aEZ1bmN0aW9uKGluc3RydW1lbnQpIHsKICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudHlwZSA9PSAxKSB7CiAgICAgICAgICAgICAgICBjb25zdCBmaW5nZXJwcmludCA9IGluc3RydW1lbnQuYWxnb3JpdGhtICsgIl8iICsgaW5zdHJ1bWVudC5mZWVkYmFja1R5cGU7CiAgICAgICAgICAgICAgICBpZiAoU3ludGguZm1TeW50aEZ1bmN0aW9uQ2FjaGVbZmluZ2VycHJpbnRdID09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN5bnRoU291cmNlID0gW107CiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBsaW5lIG9mIFN5bnRoLmZtU291cmNlVGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGxpbmUuaW5kZXhPZigiLy8gQ0FSUklFUiBPVVRQVVRTIikgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG91dHB1dHMgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgQ29uZmlnLmFsZ29yaXRobXNbaW5zdHJ1bWVudC5hbGdvcml0aG1dLmNhcnJpZXJDb3VudDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0cy5wdXNoKCJvcGVyYXRvciIgKyBqICsgIlNjYWxlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ludGhTb3VyY2UucHVzaChsaW5lLnJlcGxhY2UoIi8qb3BlcmF0b3IjU2NhbGVkKi8iLCBvdXRwdXRzLmpvaW4oIiArICIpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobGluZS5pbmRleE9mKCIvLyBJTlNFUlQgT1BFUkFUT1IgQ09NUFVUQVRJT04gSEVSRSIpICE9IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gQ29uZmlnLm9wZXJhdG9yQ291bnQgLSAxOyBqID49IDA7IGotLSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgb3BlcmF0b3JMaW5lIG9mIFN5bnRoLm9wZXJhdG9yU291cmNlVGVtcGxhdGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wZXJhdG9yTGluZS5pbmRleE9mKCIvKiArIG9wZXJhdG9yQFNjYWxlZCovIikgIT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtb2R1bGF0b3JzID0gIiI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG1vZHVsYXRvck51bWJlciBvZiBDb25maWcuYWxnb3JpdGhtc1tpbnN0cnVtZW50LmFsZ29yaXRobV0ubW9kdWxhdGVkQnlbal0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGF0b3JzICs9ICIgKyBvcGVyYXRvciIgKyAobW9kdWxhdG9yTnVtYmVyIC0gMSkgKyAiU2NhbGVkIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZlZWRiYWNrSW5kaWNlcyA9IENvbmZpZy5mZWVkYmFja3NbaW5zdHJ1bWVudC5mZWVkYmFja1R5cGVdLmluZGljZXNbal07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmVlZGJhY2tJbmRpY2VzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGF0b3JzICs9ICIgKyBmZWVkYmFja011bHQgKiAoIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmZWVkYmFja3MgPSBbXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG1vZHVsYXRvck51bWJlciBvZiBmZWVkYmFja0luZGljZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVlZGJhY2tzLnB1c2goIm9wZXJhdG9yIiArIChtb2R1bGF0b3JOdW1iZXIgLSAxKSArICJPdXRwdXQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxhdG9ycyArPSBmZWVkYmFja3Muam9pbigiICsgIikgKyAiKSI7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzeW50aFNvdXJjZS5wdXNoKG9wZXJhdG9yTGluZS5yZXBsYWNlKC9cIy9nLCBqICsgIiIpLnJlcGxhY2UoIi8qICsgb3BlcmF0b3JAU2NhbGVkKi8iLCBtb2R1bGF0b3JzKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzeW50aFNvdXJjZS5wdXNoKG9wZXJhdG9yTGluZS5yZXBsYWNlKC9cIy9nLCBqICsgIiIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChsaW5lLmluZGV4T2YoIiMiKSAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBDb25maWcub3BlcmF0b3JDb3VudDsgaisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ludGhTb3VyY2UucHVzaChsaW5lLnJlcGxhY2UoL1wjL2csIGogKyAiIikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ludGhTb3VyY2UucHVzaChsaW5lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBTeW50aC5mbVN5bnRoRnVuY3Rpb25DYWNoZVtmaW5nZXJwcmludF0gPSBuZXcgRnVuY3Rpb24oInN5bnRoIiwgImJ1ZmZlckluZGV4IiwgInJ1bkxlbmd0aCIsICJ0b25lIiwgImluc3RydW1lbnQiLCBzeW50aFNvdXJjZS5qb2luKCJcbiIpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiBTeW50aC5mbVN5bnRoRnVuY3Rpb25DYWNoZVtmaW5nZXJwcmludF07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoaW5zdHJ1bWVudC50eXBlID09IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiBTeW50aC5jaGlwU3ludGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoaW5zdHJ1bWVudC50eXBlID09IDUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBTeW50aC5oYXJtb25pY3NTeW50aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChpbnN0cnVtZW50LnR5cGUgPT0gNikgewogICAgICAgICAgICAgICAgcmV0dXJuIFN5bnRoLnB1bHNlV2lkdGhTeW50aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChpbnN0cnVtZW50LnR5cGUgPT0gNykgewogICAgICAgICAgICAgICAgcmV0dXJuIFN5bnRoLnBpY2tlZFN0cmluZ1N5bnRoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGluc3RydW1lbnQudHlwZSA9PSAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3ludGgubm9pc2VTeW50aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChpbnN0cnVtZW50LnR5cGUgPT0gMykgewogICAgICAgICAgICAgICAgcmV0dXJuIFN5bnRoLnNwZWN0cnVtU3ludGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoaW5zdHJ1bWVudC50eXBlID09IDQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBTeW50aC5kcnVtc2V0U3ludGg7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVucmVjb2duaXplZCBpbnN0cnVtZW50IHR5cGU6ICIgKyBpbnN0cnVtZW50LnR5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBjaGlwU3ludGgoc3ludGgsIGJ1ZmZlckluZGV4LCBydW5MZW5ndGgsIHRvbmUsIGluc3RydW1lbnQpIHsKICAgICAgICAgICAgY29uc3QgZGF0YSA9IHN5bnRoLnRlbXBNb25vSW5zdHJ1bWVudFNhbXBsZUJ1ZmZlcjsKICAgICAgICAgICAgY29uc3Qgd2F2ZSA9IENvbmZpZy5jaGlwV2F2ZXNbaW5zdHJ1bWVudC5jaGlwV2F2ZV0uc2FtcGxlczsKICAgICAgICAgICAgY29uc3Qgd2F2ZUxlbmd0aCA9IHdhdmUubGVuZ3RoIC0gMTsKICAgICAgICAgICAgY29uc3QgdW5pc29uU2lnbiA9IHRvbmUuc3BlY2lhbEludGVydmFsRXhwcmVzc2lvbk11bHQgKiBDb25maWcudW5pc29uc1tpbnN0cnVtZW50LnVuaXNvbl0uc2lnbjsKICAgICAgICAgICAgaWYgKGluc3RydW1lbnQudW5pc29uID09IDAgJiYgIWluc3RydW1lbnQuZ2V0Q2hvcmQoKS5jdXN0b21JbnRlcnZhbCkKICAgICAgICAgICAgICAgIHRvbmUucGhhc2VzWzFdID0gdG9uZS5waGFzZXNbMF07CiAgICAgICAgICAgIGxldCBwaGFzZURlbHRhQSA9IHRvbmUucGhhc2VEZWx0YXNbMF0gKiB3YXZlTGVuZ3RoOwogICAgICAgICAgICBsZXQgcGhhc2VEZWx0YUIgPSB0b25lLnBoYXNlRGVsdGFzWzFdICogd2F2ZUxlbmd0aDsKICAgICAgICAgICAgY29uc3QgcGhhc2VEZWx0YVNjYWxlQSA9ICt0b25lLnBoYXNlRGVsdGFTY2FsZXNbMF07CiAgICAgICAgICAgIGNvbnN0IHBoYXNlRGVsdGFTY2FsZUIgPSArdG9uZS5waGFzZURlbHRhU2NhbGVzWzFdOwogICAgICAgICAgICBsZXQgZXhwcmVzc2lvbiA9ICt0b25lLmV4cHJlc3Npb25TdGFydHNbMF07CiAgICAgICAgICAgIGNvbnN0IGV4cHJlc3Npb25EZWx0YSA9ICt0b25lLmV4cHJlc3Npb25EZWx0YXNbMF07CiAgICAgICAgICAgIGxldCBwaGFzZUEgPSAodG9uZS5waGFzZXNbMF0gJSAxKSAqIHdhdmVMZW5ndGg7CiAgICAgICAgICAgIGxldCBwaGFzZUIgPSAodG9uZS5waGFzZXNbMV0gJSAxKSAqIHdhdmVMZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IGZpbHRlcnMgPSB0b25lLm5vdGVGaWx0ZXJzOwogICAgICAgICAgICBjb25zdCBmaWx0ZXJDb3VudCA9IHRvbmUubm90ZUZpbHRlckNvdW50IHwgMDsKICAgICAgICAgICAgbGV0IGluaXRpYWxGaWx0ZXJJbnB1dDEgPSArdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MTsKICAgICAgICAgICAgbGV0IGluaXRpYWxGaWx0ZXJJbnB1dDIgPSArdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MjsKICAgICAgICAgICAgY29uc3QgYXBwbHlGaWx0ZXJzID0gU3ludGguYXBwbHlGaWx0ZXJzOwogICAgICAgICAgICBjb25zdCBwaGFzZUFJbnQgPSBwaGFzZUEgfCAwOwogICAgICAgICAgICBjb25zdCBwaGFzZUJJbnQgPSBwaGFzZUIgfCAwOwogICAgICAgICAgICBjb25zdCBpbmRleEEgPSBwaGFzZUFJbnQgJSB3YXZlTGVuZ3RoOwogICAgICAgICAgICBjb25zdCBpbmRleEIgPSBwaGFzZUJJbnQgJSB3YXZlTGVuZ3RoOwogICAgICAgICAgICBjb25zdCBwaGFzZVJhdGlvQSA9IHBoYXNlQSAtIHBoYXNlQUludDsKICAgICAgICAgICAgY29uc3QgcGhhc2VSYXRpb0IgPSBwaGFzZUIgLSBwaGFzZUJJbnQ7CiAgICAgICAgICAgIGxldCBwcmV2V2F2ZUludGVncmFsQSA9ICt3YXZlW2luZGV4QV07CiAgICAgICAgICAgIGxldCBwcmV2V2F2ZUludGVncmFsQiA9ICt3YXZlW2luZGV4Ql07CiAgICAgICAgICAgIHByZXZXYXZlSW50ZWdyYWxBICs9ICh3YXZlW2luZGV4QSArIDFdIC0gcHJldldhdmVJbnRlZ3JhbEEpICogcGhhc2VSYXRpb0E7CiAgICAgICAgICAgIHByZXZXYXZlSW50ZWdyYWxCICs9ICh3YXZlW2luZGV4QiArIDFdIC0gcHJldldhdmVJbnRlZ3JhbEIpICogcGhhc2VSYXRpb0I7CiAgICAgICAgICAgIGNvbnN0IHN0b3BJbmRleCA9IGJ1ZmZlckluZGV4ICsgcnVuTGVuZ3RoOwogICAgICAgICAgICBmb3IgKGxldCBzYW1wbGVJbmRleCA9IGJ1ZmZlckluZGV4OyBzYW1wbGVJbmRleCA8IHN0b3BJbmRleDsgc2FtcGxlSW5kZXgrKykgewogICAgICAgICAgICAgICAgcGhhc2VBICs9IHBoYXNlRGVsdGFBOwogICAgICAgICAgICAgICAgcGhhc2VCICs9IHBoYXNlRGVsdGFCOwogICAgICAgICAgICAgICAgY29uc3QgcGhhc2VBSW50ID0gcGhhc2VBIHwgMDsKICAgICAgICAgICAgICAgIGNvbnN0IHBoYXNlQkludCA9IHBoYXNlQiB8IDA7CiAgICAgICAgICAgICAgICBjb25zdCBpbmRleEEgPSBwaGFzZUFJbnQgJSB3YXZlTGVuZ3RoOwogICAgICAgICAgICAgICAgY29uc3QgaW5kZXhCID0gcGhhc2VCSW50ICUgd2F2ZUxlbmd0aDsKICAgICAgICAgICAgICAgIGxldCBuZXh0V2F2ZUludGVncmFsQSA9IHdhdmVbaW5kZXhBXTsKICAgICAgICAgICAgICAgIGxldCBuZXh0V2F2ZUludGVncmFsQiA9IHdhdmVbaW5kZXhCXTsKICAgICAgICAgICAgICAgIGNvbnN0IHBoYXNlUmF0aW9BID0gcGhhc2VBIC0gcGhhc2VBSW50OwogICAgICAgICAgICAgICAgY29uc3QgcGhhc2VSYXRpb0IgPSBwaGFzZUIgLSBwaGFzZUJJbnQ7CiAgICAgICAgICAgICAgICBuZXh0V2F2ZUludGVncmFsQSArPSAod2F2ZVtpbmRleEEgKyAxXSAtIG5leHRXYXZlSW50ZWdyYWxBKSAqIHBoYXNlUmF0aW9BOwogICAgICAgICAgICAgICAgbmV4dFdhdmVJbnRlZ3JhbEIgKz0gKHdhdmVbaW5kZXhCICsgMV0gLSBuZXh0V2F2ZUludGVncmFsQikgKiBwaGFzZVJhdGlvQjsKICAgICAgICAgICAgICAgIGNvbnN0IHdhdmVBID0gKG5leHRXYXZlSW50ZWdyYWxBIC0gcHJldldhdmVJbnRlZ3JhbEEpIC8gcGhhc2VEZWx0YUE7CiAgICAgICAgICAgICAgICBjb25zdCB3YXZlQiA9IChuZXh0V2F2ZUludGVncmFsQiAtIHByZXZXYXZlSW50ZWdyYWxCKSAvIHBoYXNlRGVsdGFCOwogICAgICAgICAgICAgICAgcHJldldhdmVJbnRlZ3JhbEEgPSBuZXh0V2F2ZUludGVncmFsQTsKICAgICAgICAgICAgICAgIHByZXZXYXZlSW50ZWdyYWxCID0gbmV4dFdhdmVJbnRlZ3JhbEI7CiAgICAgICAgICAgICAgICBjb25zdCBpbnB1dFNhbXBsZSA9IHdhdmVBICsgd2F2ZUIgKiB1bmlzb25TaWduOwogICAgICAgICAgICAgICAgY29uc3Qgc2FtcGxlID0gYXBwbHlGaWx0ZXJzKGlucHV0U2FtcGxlLCBpbml0aWFsRmlsdGVySW5wdXQxLCBpbml0aWFsRmlsdGVySW5wdXQyLCBmaWx0ZXJDb3VudCwgZmlsdGVycyk7CiAgICAgICAgICAgICAgICBpbml0aWFsRmlsdGVySW5wdXQyID0gaW5pdGlhbEZpbHRlcklucHV0MTsKICAgICAgICAgICAgICAgIGluaXRpYWxGaWx0ZXJJbnB1dDEgPSBpbnB1dFNhbXBsZTsKICAgICAgICAgICAgICAgIHBoYXNlRGVsdGFBICo9IHBoYXNlRGVsdGFTY2FsZUE7CiAgICAgICAgICAgICAgICBwaGFzZURlbHRhQiAqPSBwaGFzZURlbHRhU2NhbGVCOwogICAgICAgICAgICAgICAgY29uc3Qgb3V0cHV0ID0gc2FtcGxlICogZXhwcmVzc2lvbjsKICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gKz0gZXhwcmVzc2lvbkRlbHRhOwogICAgICAgICAgICAgICAgZGF0YVtzYW1wbGVJbmRleF0gKz0gb3V0cHV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRvbmUucGhhc2VzWzBdID0gcGhhc2VBIC8gd2F2ZUxlbmd0aDsKICAgICAgICAgICAgdG9uZS5waGFzZXNbMV0gPSBwaGFzZUIgLyB3YXZlTGVuZ3RoOwogICAgICAgICAgICBzeW50aC5zYW5pdGl6ZUZpbHRlcnMoZmlsdGVycyk7CiAgICAgICAgICAgIHRvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDEgPSBpbml0aWFsRmlsdGVySW5wdXQxOwogICAgICAgICAgICB0b25lLmluaXRpYWxOb3RlRmlsdGVySW5wdXQyID0gaW5pdGlhbEZpbHRlcklucHV0MjsKICAgICAgICB9CiAgICAgICAgc3RhdGljIGhhcm1vbmljc1N5bnRoKHN5bnRoLCBidWZmZXJJbmRleCwgcnVuTGVuZ3RoLCB0b25lLCBpbnN0cnVtZW50KSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBzeW50aC50ZW1wTW9ub0luc3RydW1lbnRTYW1wbGVCdWZmZXI7CiAgICAgICAgICAgIGNvbnN0IHdhdmUgPSBpbnN0cnVtZW50Lmhhcm1vbmljc1dhdmUuZ2V0Q3VzdG9tV2F2ZShpbnN0cnVtZW50LnR5cGUpOwogICAgICAgICAgICBjb25zdCB3YXZlTGVuZ3RoID0gd2F2ZS5sZW5ndGggLSAxOwogICAgICAgICAgICBjb25zdCB1bmlzb25TaWduID0gdG9uZS5zcGVjaWFsSW50ZXJ2YWxFeHByZXNzaW9uTXVsdCAqIENvbmZpZy51bmlzb25zW2luc3RydW1lbnQudW5pc29uXS5zaWduOwogICAgICAgICAgICBpZiAoaW5zdHJ1bWVudC51bmlzb24gPT0gMCAmJiAhaW5zdHJ1bWVudC5nZXRDaG9yZCgpLmN1c3RvbUludGVydmFsKQogICAgICAgICAgICAgICAgdG9uZS5waGFzZXNbMV0gPSB0b25lLnBoYXNlc1swXTsKICAgICAgICAgICAgbGV0IHBoYXNlRGVsdGFBID0gdG9uZS5waGFzZURlbHRhc1swXSAqIHdhdmVMZW5ndGg7CiAgICAgICAgICAgIGxldCBwaGFzZURlbHRhQiA9IHRvbmUucGhhc2VEZWx0YXNbMV0gKiB3YXZlTGVuZ3RoOwogICAgICAgICAgICBjb25zdCBwaGFzZURlbHRhU2NhbGVBID0gK3RvbmUucGhhc2VEZWx0YVNjYWxlc1swXTsKICAgICAgICAgICAgY29uc3QgcGhhc2VEZWx0YVNjYWxlQiA9ICt0b25lLnBoYXNlRGVsdGFTY2FsZXNbMV07CiAgICAgICAgICAgIGxldCBleHByZXNzaW9uID0gK3RvbmUuZXhwcmVzc2lvblN0YXJ0c1swXTsKICAgICAgICAgICAgY29uc3QgZXhwcmVzc2lvbkRlbHRhID0gK3RvbmUuZXhwcmVzc2lvbkRlbHRhc1swXTsKICAgICAgICAgICAgbGV0IHBoYXNlQSA9ICh0b25lLnBoYXNlc1swXSAlIDEpICogd2F2ZUxlbmd0aDsKICAgICAgICAgICAgbGV0IHBoYXNlQiA9ICh0b25lLnBoYXNlc1sxXSAlIDEpICogd2F2ZUxlbmd0aDsKICAgICAgICAgICAgY29uc3QgZmlsdGVycyA9IHRvbmUubm90ZUZpbHRlcnM7CiAgICAgICAgICAgIGNvbnN0IGZpbHRlckNvdW50ID0gdG9uZS5ub3RlRmlsdGVyQ291bnQgfCAwOwogICAgICAgICAgICBsZXQgaW5pdGlhbEZpbHRlcklucHV0MSA9ICt0b25lLmluaXRpYWxOb3RlRmlsdGVySW5wdXQxOwogICAgICAgICAgICBsZXQgaW5pdGlhbEZpbHRlcklucHV0MiA9ICt0b25lLmluaXRpYWxOb3RlRmlsdGVySW5wdXQyOwogICAgICAgICAgICBjb25zdCBhcHBseUZpbHRlcnMgPSBTeW50aC5hcHBseUZpbHRlcnM7CiAgICAgICAgICAgIGNvbnN0IHBoYXNlQUludCA9IHBoYXNlQSB8IDA7CiAgICAgICAgICAgIGNvbnN0IHBoYXNlQkludCA9IHBoYXNlQiB8IDA7CiAgICAgICAgICAgIGNvbnN0IGluZGV4QSA9IHBoYXNlQUludCAlIHdhdmVMZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IGluZGV4QiA9IHBoYXNlQkludCAlIHdhdmVMZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IHBoYXNlUmF0aW9BID0gcGhhc2VBIC0gcGhhc2VBSW50OwogICAgICAgICAgICBjb25zdCBwaGFzZVJhdGlvQiA9IHBoYXNlQiAtIHBoYXNlQkludDsKICAgICAgICAgICAgbGV0IHByZXZXYXZlSW50ZWdyYWxBID0gK3dhdmVbaW5kZXhBXTsKICAgICAgICAgICAgbGV0IHByZXZXYXZlSW50ZWdyYWxCID0gK3dhdmVbaW5kZXhCXTsKICAgICAgICAgICAgcHJldldhdmVJbnRlZ3JhbEEgKz0gKHdhdmVbaW5kZXhBICsgMV0gLSBwcmV2V2F2ZUludGVncmFsQSkgKiBwaGFzZVJhdGlvQTsKICAgICAgICAgICAgcHJldldhdmVJbnRlZ3JhbEIgKz0gKHdhdmVbaW5kZXhCICsgMV0gLSBwcmV2V2F2ZUludGVncmFsQikgKiBwaGFzZVJhdGlvQjsKICAgICAgICAgICAgY29uc3Qgc3RvcEluZGV4ID0gYnVmZmVySW5kZXggKyBydW5MZW5ndGg7CiAgICAgICAgICAgIGZvciAobGV0IHNhbXBsZUluZGV4ID0gYnVmZmVySW5kZXg7IHNhbXBsZUluZGV4IDwgc3RvcEluZGV4OyBzYW1wbGVJbmRleCsrKSB7CiAgICAgICAgICAgICAgICBwaGFzZUEgKz0gcGhhc2VEZWx0YUE7CiAgICAgICAgICAgICAgICBwaGFzZUIgKz0gcGhhc2VEZWx0YUI7CiAgICAgICAgICAgICAgICBjb25zdCBwaGFzZUFJbnQgPSBwaGFzZUEgfCAwOwogICAgICAgICAgICAgICAgY29uc3QgcGhhc2VCSW50ID0gcGhhc2VCIHwgMDsKICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4QSA9IHBoYXNlQUludCAlIHdhdmVMZW5ndGg7CiAgICAgICAgICAgICAgICBjb25zdCBpbmRleEIgPSBwaGFzZUJJbnQgJSB3YXZlTGVuZ3RoOwogICAgICAgICAgICAgICAgbGV0IG5leHRXYXZlSW50ZWdyYWxBID0gd2F2ZVtpbmRleEFdOwogICAgICAgICAgICAgICAgbGV0IG5leHRXYXZlSW50ZWdyYWxCID0gd2F2ZVtpbmRleEJdOwogICAgICAgICAgICAgICAgY29uc3QgcGhhc2VSYXRpb0EgPSBwaGFzZUEgLSBwaGFzZUFJbnQ7CiAgICAgICAgICAgICAgICBjb25zdCBwaGFzZVJhdGlvQiA9IHBoYXNlQiAtIHBoYXNlQkludDsKICAgICAgICAgICAgICAgIG5leHRXYXZlSW50ZWdyYWxBICs9ICh3YXZlW2luZGV4QSArIDFdIC0gbmV4dFdhdmVJbnRlZ3JhbEEpICogcGhhc2VSYXRpb0E7CiAgICAgICAgICAgICAgICBuZXh0V2F2ZUludGVncmFsQiArPSAod2F2ZVtpbmRleEIgKyAxXSAtIG5leHRXYXZlSW50ZWdyYWxCKSAqIHBoYXNlUmF0aW9COwogICAgICAgICAgICAgICAgY29uc3Qgd2F2ZUEgPSAobmV4dFdhdmVJbnRlZ3JhbEEgLSBwcmV2V2F2ZUludGVncmFsQSkgLyBwaGFzZURlbHRhQTsKICAgICAgICAgICAgICAgIGNvbnN0IHdhdmVCID0gKG5leHRXYXZlSW50ZWdyYWxCIC0gcHJldldhdmVJbnRlZ3JhbEIpIC8gcGhhc2VEZWx0YUI7CiAgICAgICAgICAgICAgICBwcmV2V2F2ZUludGVncmFsQSA9IG5leHRXYXZlSW50ZWdyYWxBOwogICAgICAgICAgICAgICAgcHJldldhdmVJbnRlZ3JhbEIgPSBuZXh0V2F2ZUludGVncmFsQjsKICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0U2FtcGxlID0gd2F2ZUEgKyB3YXZlQiAqIHVuaXNvblNpZ247CiAgICAgICAgICAgICAgICBjb25zdCBzYW1wbGUgPSBhcHBseUZpbHRlcnMoaW5wdXRTYW1wbGUsIGluaXRpYWxGaWx0ZXJJbnB1dDEsIGluaXRpYWxGaWx0ZXJJbnB1dDIsIGZpbHRlckNvdW50LCBmaWx0ZXJzKTsKICAgICAgICAgICAgICAgIGluaXRpYWxGaWx0ZXJJbnB1dDIgPSBpbml0aWFsRmlsdGVySW5wdXQxOwogICAgICAgICAgICAgICAgaW5pdGlhbEZpbHRlcklucHV0MSA9IGlucHV0U2FtcGxlOwogICAgICAgICAgICAgICAgcGhhc2VEZWx0YUEgKj0gcGhhc2VEZWx0YVNjYWxlQTsKICAgICAgICAgICAgICAgIHBoYXNlRGVsdGFCICo9IHBoYXNlRGVsdGFTY2FsZUI7CiAgICAgICAgICAgICAgICBjb25zdCBvdXRwdXQgPSBzYW1wbGUgKiBleHByZXNzaW9uOwogICAgICAgICAgICAgICAgZXhwcmVzc2lvbiArPSBleHByZXNzaW9uRGVsdGE7CiAgICAgICAgICAgICAgICBkYXRhW3NhbXBsZUluZGV4XSArPSBvdXRwdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdG9uZS5waGFzZXNbMF0gPSBwaGFzZUEgLyB3YXZlTGVuZ3RoOwogICAgICAgICAgICB0b25lLnBoYXNlc1sxXSA9IHBoYXNlQiAvIHdhdmVMZW5ndGg7CiAgICAgICAgICAgIHN5bnRoLnNhbml0aXplRmlsdGVycyhmaWx0ZXJzKTsKICAgICAgICAgICAgdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MSA9IGluaXRpYWxGaWx0ZXJJbnB1dDE7CiAgICAgICAgICAgIHRvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDIgPSBpbml0aWFsRmlsdGVySW5wdXQyOwogICAgICAgIH0KICAgICAgICBzdGF0aWMgcGlja2VkU3RyaW5nU3ludGgoc3ludGgsIGJ1ZmZlckluZGV4LCBydW5MZW5ndGgsIHRvbmUsIGluc3RydW1lbnQpIHsKICAgICAgICAgICAgY29uc3Qgdm9pY2VDb3VudCA9IENvbmZpZy51bmlzb25zW2luc3RydW1lbnQudW5pc29uXS52b2ljZXM7CiAgICAgICAgICAgIGxldCBwaWNrZWRTdHJpbmdGdW5jdGlvbiA9IFN5bnRoLnBpY2tlZFN0cmluZ0Z1bmN0aW9uQ2FjaGVbdm9pY2VDb3VudF07CiAgICAgICAgICAgIGlmIChwaWNrZWRTdHJpbmdGdW5jdGlvbiA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGxldCBwaWNrZWRTdHJpbmdTb3VyY2UgPSAiIjsKICAgICAgICAgICAgICAgIHBpY2tlZFN0cmluZ1NvdXJjZSArPSBgCgkJCQkKCQkJCWNvbnN0IENvbmZpZyA9IGJlZXBib3guQ29uZmlnOwoJCQkJY29uc3QgU3ludGggPSBiZWVwYm94LlN5bnRoOwoJCQkJY29uc3QgTm90ZUF1dG9tYXRpb25TdHJpbmdTdXN0YWluSW5kZXggPSAkezN9OwoJCQkJY29uc3Qgdm9pY2VDb3VudCA9ICR7dm9pY2VDb3VudH07CgkJCQljb25zdCBkYXRhID0gc3ludGgudGVtcE1vbm9JbnN0cnVtZW50U2FtcGxlQnVmZmVyOwoJCQkJCgkJCQljb25zdCBzdXN0YWluRW52ZWxvcGVTdGFydCA9IHRvbmUuZW52ZWxvcGVDb21wdXRlci5lbnZlbG9wZVN0YXJ0c1tOb3RlQXV0b21hdGlvblN0cmluZ1N1c3RhaW5JbmRleF07CgkJCQljb25zdCBzdXN0YWluRW52ZWxvcGVFbmQgICA9IHRvbmUuZW52ZWxvcGVDb21wdXRlci5lbnZlbG9wZUVuZHNbICBOb3RlQXV0b21hdGlvblN0cmluZ1N1c3RhaW5JbmRleF07CgkJCQljb25zdCBzdHJpbmdEZWNheVN0YXJ0ID0gMS4wIC0gTWF0aC5taW4oMS4wLCBzdXN0YWluRW52ZWxvcGVTdGFydCAqIGluc3RydW1lbnQuc3RyaW5nU3VzdGFpbiAvIChDb25maWcuc3RyaW5nU3VzdGFpblJhbmdlIC0gMSkpOwoJCQkJY29uc3Qgc3RyaW5nRGVjYXlFbmQgICA9IDEuMCAtIE1hdGgubWluKDEuMCwgc3VzdGFpbkVudmVsb3BlRW5kICAgKiBpbnN0cnVtZW50LnN0cmluZ1N1c3RhaW4gLyAoQ29uZmlnLnN0cmluZ1N1c3RhaW5SYW5nZSAtIDEpKTsKCQkJCQoJCQkJbGV0IHBpY2tlZFN0cmluZyMgPSB0b25lLnBpY2tlZFN0cmluZ3NbI107CgkJCQkKCQkJCWNvbnN0IHByZXZEZWxheUxlbmd0aCMgPSArcGlja2VkU3RyaW5nIy5wcmV2RGVsYXlMZW5ndGg7CgkJCQlsZXQgYWxsUGFzc1NhbXBsZSMgPSArcGlja2VkU3RyaW5nIy5hbGxQYXNzU2FtcGxlOwoJCQkJbGV0IGFsbFBhc3NQcmV2SW5wdXQjID0gK3BpY2tlZFN0cmluZyMuYWxsUGFzc1ByZXZJbnB1dDsKCQkJCWxldCBzaGVsZlNhbXBsZSMgPSArcGlja2VkU3RyaW5nIy5zaGVsZlNhbXBsZTsKCQkJCWxldCBzaGVsZlByZXZJbnB1dCMgPSArcGlja2VkU3RyaW5nIy5zaGVsZlByZXZJbnB1dDsKCQkJCWxldCBmcmFjdGlvbmFsRGVsYXlTYW1wbGUjID0gK3BpY2tlZFN0cmluZyMuZnJhY3Rpb25hbERlbGF5U2FtcGxlOwoJCQkJCgkJCQlsZXQgZXhwcmVzc2lvbiA9ICt0b25lLmV4cHJlc3Npb25TdGFydHNbMF07CgkJCQljb25zdCBleHByZXNzaW9uRGVsdGEgPSArdG9uZS5leHByZXNzaW9uRGVsdGFzWzBdOwoJCQkJCgkJCQljb25zdCBwaGFzZURlbHRhU3RhcnQjID0gK3RvbmUucGhhc2VEZWx0YXNbI107CgkJCQljb25zdCBwaGFzZURlbHRhU2NhbGUjID0gK3RvbmUucGhhc2VEZWx0YVNjYWxlc1sjXTsKCQkJCWNvbnN0IHBoYXNlRGVsdGFFbmQjID0gcGhhc2VEZWx0YVN0YXJ0IyAqIE1hdGgucG93KHBoYXNlRGVsdGFTY2FsZSMsIHJ1bkxlbmd0aCk7CgkJCQkKCQkJCWNvbnN0IHJhZGlhbnNQZXJTYW1wbGVTdGFydCMgPSBNYXRoLlBJICogMi4wICogcGhhc2VEZWx0YVN0YXJ0IzsKCQkJCWNvbnN0IHJhZGlhbnNQZXJTYW1wbGVFbmQjICAgPSBNYXRoLlBJICogMi4wICogcGhhc2VEZWx0YUVuZCM7CgkJCQkKCQkJCWNvbnN0IGNlbnRlckhhcm1vbmljU3RhcnQjID0gcmFkaWFuc1BlclNhbXBsZVN0YXJ0IyAqIDIuMDsKCQkJCWNvbnN0IGNlbnRlckhhcm1vbmljRW5kIyAgID0gcmFkaWFuc1BlclNhbXBsZUVuZCMgKiAyLjA7CgkJCQkKCQkJCWNvbnN0IGFsbFBhc3NDZW50ZXIgPSAyLjAgKiBNYXRoLlBJICogQ29uZmlnLnBpY2tlZFN0cmluZ0Rpc3BlcnNpb25DZW50ZXJGcmVxIC8gc3ludGguc2FtcGxlc1BlclNlY29uZDsKCQkJCWNvbnN0IGFsbFBhc3NSYWRpYW5zU3RhcnQjID0gTWF0aC5taW4oTWF0aC5QSSwgcmFkaWFuc1BlclNhbXBsZVN0YXJ0IyAqIENvbmZpZy5waWNrZWRTdHJpbmdEaXNwZXJzaW9uRnJlcU11bHQgKiBNYXRoLnBvdyhhbGxQYXNzQ2VudGVyIC8gcmFkaWFuc1BlclNhbXBsZVN0YXJ0IywgQ29uZmlnLnBpY2tlZFN0cmluZ0Rpc3BlcnNpb25GcmVxU2NhbGUpKTsKCQkJCWNvbnN0IGFsbFBhc3NSYWRpYW5zRW5kIyA9IE1hdGgubWluKE1hdGguUEksIHJhZGlhbnNQZXJTYW1wbGVFbmQjICogQ29uZmlnLnBpY2tlZFN0cmluZ0Rpc3BlcnNpb25GcmVxTXVsdCAqIE1hdGgucG93KGFsbFBhc3NDZW50ZXIgLyByYWRpYW5zUGVyU2FtcGxlRW5kIywgQ29uZmlnLnBpY2tlZFN0cmluZ0Rpc3BlcnNpb25GcmVxU2NhbGUpKTsKCQkJCQoJCQkJY29uc3Qgc2hlbGZSYWRpYW5zID0gMi4wICogTWF0aC5QSSAqIENvbmZpZy5waWNrZWRTdHJpbmdTaGVsZkh6IC8gc3ludGguc2FtcGxlc1BlclNlY29uZDsKCQkJCWNvbnN0IGRlY2F5Q3VydmVTdGFydCA9IChNYXRoLnBvdygxMDAuMCwgc3RyaW5nRGVjYXlTdGFydCkgLSAxLjApIC8gOTkuMDsKCQkJCWNvbnN0IGRlY2F5Q3VydmVFbmQgICA9IChNYXRoLnBvdygxMDAuMCwgc3RyaW5nRGVjYXlFbmQgICkgLSAxLjApIC8gOTkuMDsKCQkJCWNvbnN0IGRlY2F5UmF0ZVN0YXJ0IyA9IE1hdGgucG93KDAuNSwgZGVjYXlDdXJ2ZVN0YXJ0ICogc2hlbGZSYWRpYW5zIC8gcmFkaWFuc1BlclNhbXBsZVN0YXJ0Iyk7CgkJCQljb25zdCBkZWNheVJhdGVFbmQjICAgPSBNYXRoLnBvdygwLjUsIGRlY2F5Q3VydmVFbmQgICAqIHNoZWxmUmFkaWFucyAvIHJhZGlhbnNQZXJTYW1wbGVFbmQjKTsKCQkJCWNvbnN0IHNoZWxmR2FpblN0YXJ0IyA9IE1hdGgucG93KGRlY2F5UmF0ZVN0YXJ0IywgQ29uZmlnLnN0cmluZ0RlY2F5UmF0ZSk7CgkJCQljb25zdCBzaGVsZkdhaW5FbmQjICAgPSBNYXRoLnBvdyhkZWNheVJhdGVFbmQjLCAgIENvbmZpZy5zdHJpbmdEZWNheVJhdGUpOwoJCQkJY29uc3QgZXhwcmVzc2lvbkRlY2F5U3RhcnQjID0gTWF0aC5wb3coZGVjYXlSYXRlU3RhcnQjLCAwLjAwMik7CgkJCQljb25zdCBleHByZXNzaW9uRGVjYXlFbmQjICAgPSBNYXRoLnBvdyhkZWNheVJhdGVFbmQjLCAgIDAuMDAyKTtgOwogICAgICAgICAgICAgICAgZm9yIChsZXQgdm9pY2UgPSAwOyB2b2ljZSA8IHZvaWNlQ291bnQ7IHZvaWNlKyspIHsKICAgICAgICAgICAgICAgICAgICBwaWNrZWRTdHJpbmdTb3VyY2UgKz0gYAoJCQkJCgkJCQlTeW50aC50ZW1wRmlsdGVyU3RhcnRDb2VmZmljaWVudHMuYWxsUGFzczFzdE9yZGVySW52ZXJ0UGhhc2VBYm92ZShhbGxQYXNzUmFkaWFuc1N0YXJ0Iyk7CgkJCQlzeW50aC50ZW1wRnJlcXVlbmN5UmVzcG9uc2UuYW5hbHl6ZShTeW50aC50ZW1wRmlsdGVyU3RhcnRDb2VmZmljaWVudHMsIGNlbnRlckhhcm1vbmljU3RhcnQjKTsKCQkJCWxldCBhbGxQYXNzRyMgPSArU3ludGgudGVtcEZpbHRlclN0YXJ0Q29lZmZpY2llbnRzLmJbMF07IC8qIHNhbWUgYXMgYVsxXSAqLwoJCQkJY29uc3QgYWxsUGFzc1BoYXNlRGVsYXlTdGFydCMgPSAtc3ludGgudGVtcEZyZXF1ZW5jeVJlc3BvbnNlLmFuZ2xlKCkgLyBjZW50ZXJIYXJtb25pY1N0YXJ0IzsKCQkJCQoJCQkJU3ludGgudGVtcEZpbHRlckVuZENvZWZmaWNpZW50cy5hbGxQYXNzMXN0T3JkZXJJbnZlcnRQaGFzZUFib3ZlKGFsbFBhc3NSYWRpYW5zRW5kIyk7CgkJCQlzeW50aC50ZW1wRnJlcXVlbmN5UmVzcG9uc2UuYW5hbHl6ZShTeW50aC50ZW1wRmlsdGVyRW5kQ29lZmZpY2llbnRzLCBjZW50ZXJIYXJtb25pY0VuZCMpOwoJCQkJY29uc3QgYWxsUGFzc0dFbmQjID0gK1N5bnRoLnRlbXBGaWx0ZXJFbmRDb2VmZmljaWVudHMuYlswXTsgLyogc2FtZSBhcyBhWzFdICovCgkJCQljb25zdCBhbGxQYXNzUGhhc2VEZWxheUVuZCMgPSAtc3ludGgudGVtcEZyZXF1ZW5jeVJlc3BvbnNlLmFuZ2xlKCkgLyBjZW50ZXJIYXJtb25pY0VuZCM7CgkJCQkKCQkJCVN5bnRoLnRlbXBGaWx0ZXJTdGFydENvZWZmaWNpZW50cy5oaWdoU2hlbGYxc3RPcmRlcihzaGVsZlJhZGlhbnMsIHNoZWxmR2FpblN0YXJ0Iyk7CgkJCQlzeW50aC50ZW1wRnJlcXVlbmN5UmVzcG9uc2UuYW5hbHl6ZShTeW50aC50ZW1wRmlsdGVyU3RhcnRDb2VmZmljaWVudHMsIGNlbnRlckhhcm1vbmljU3RhcnQjKQoJCQkJbGV0IHNoZWxmQTEjID0gK1N5bnRoLnRlbXBGaWx0ZXJTdGFydENvZWZmaWNpZW50cy5hWzFdCgkJCQlsZXQgc2hlbGZCMCMgPSBTeW50aC50ZW1wRmlsdGVyU3RhcnRDb2VmZmljaWVudHMuYlswXSAqIGV4cHJlc3Npb25EZWNheVN0YXJ0IwoJCQkJbGV0IHNoZWxmQjEjID0gU3ludGgudGVtcEZpbHRlclN0YXJ0Q29lZmZpY2llbnRzLmJbMV0gKiBleHByZXNzaW9uRGVjYXlTdGFydCMKCQkJCWNvbnN0IHNoZWxmUGhhc2VEZWxheVN0YXJ0IyA9IC1zeW50aC50ZW1wRnJlcXVlbmN5UmVzcG9uc2UuYW5nbGUoKSAvIGNlbnRlckhhcm1vbmljU3RhcnQjOwoJCQkJCgkJCQlTeW50aC50ZW1wRmlsdGVyRW5kQ29lZmZpY2llbnRzLmhpZ2hTaGVsZjFzdE9yZGVyKHNoZWxmUmFkaWFucywgc2hlbGZHYWluRW5kIykKCQkJCXN5bnRoLnRlbXBGcmVxdWVuY3lSZXNwb25zZS5hbmFseXplKFN5bnRoLnRlbXBGaWx0ZXJFbmRDb2VmZmljaWVudHMsIGNlbnRlckhhcm1vbmljRW5kIykKCQkJCWNvbnN0IHNoZWxmQTFFbmQjID0gK1N5bnRoLnRlbXBGaWx0ZXJFbmRDb2VmZmljaWVudHMuYVsxXQoJCQkJY29uc3Qgc2hlbGZCMEVuZCMgPSBTeW50aC50ZW1wRmlsdGVyRW5kQ29lZmZpY2llbnRzLmJbMF0gKiBleHByZXNzaW9uRGVjYXlFbmQjCgkJCQljb25zdCBzaGVsZkIxRW5kIyA9IFN5bnRoLnRlbXBGaWx0ZXJFbmRDb2VmZmljaWVudHMuYlsxXSAqIGV4cHJlc3Npb25EZWNheUVuZCMKCQkJCWNvbnN0IHNoZWxmUGhhc2VEZWxheUVuZCMgPSAtc3ludGgudGVtcEZyZXF1ZW5jeVJlc3BvbnNlLmFuZ2xlKCkgLyBjZW50ZXJIYXJtb25pY0VuZCM7YC5yZXBsYWNlKC9cIy9nLCBTdHJpbmcodm9pY2UpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBpY2tlZFN0cmluZ1NvdXJjZSArPSBgCgkJCQkKCQkJCWNvbnN0IHBlcmlvZExlbmd0aFN0YXJ0IyA9IDEuMCAvIHBoYXNlRGVsdGFTdGFydCM7CgkJCQljb25zdCBwZXJpb2RMZW5ndGhFbmQjID0gMS4wIC8gcGhhc2VEZWx0YUVuZCM7CgkJCQljb25zdCBtaW5CdWZmZXJMZW5ndGgjID0gTWF0aC5jZWlsKE1hdGgubWF4KHBlcmlvZExlbmd0aFN0YXJ0IywgcGVyaW9kTGVuZ3RoRW5kIykgKiAyKTsKCQkJCWxldCBkZWxheUxlbmd0aCMgPSBwZXJpb2RMZW5ndGhTdGFydCMgLSBhbGxQYXNzUGhhc2VEZWxheVN0YXJ0IyAtIHNoZWxmUGhhc2VEZWxheVN0YXJ0IzsKCQkJCWNvbnN0IGRlbGF5TGVuZ3RoRW5kIyA9IHBlcmlvZExlbmd0aEVuZCMgLSBhbGxQYXNzUGhhc2VEZWxheUVuZCMgLSBzaGVsZlBoYXNlRGVsYXlFbmQjOwoJCQkJCgkJCQljb25zdCBkZWxheUxlbmd0aERlbHRhIyA9IChkZWxheUxlbmd0aEVuZCMgLSBkZWxheUxlbmd0aCMpIC8gcnVuTGVuZ3RoOwoJCQkJY29uc3QgYWxsUGFzc0dEZWx0YSMgPSAoYWxsUGFzc0dFbmQjIC0gYWxsUGFzc0cjKSAvIHJ1bkxlbmd0aDsKCQkJCWNvbnN0IHNoZWxmQTFEZWx0YSMgPSAoc2hlbGZBMUVuZCMgLSBzaGVsZkExIykgLyBydW5MZW5ndGg7CgkJCQljb25zdCBzaGVsZkIwRGVsdGEjID0gKHNoZWxmQjBFbmQjIC0gc2hlbGZCMCMpIC8gcnVuTGVuZ3RoOwoJCQkJY29uc3Qgc2hlbGZCMURlbHRhIyA9IChzaGVsZkIxRW5kIyAtIHNoZWxmQjEjKSAvIHJ1bkxlbmd0aDsKCQkJCQoJCQkJY29uc3QgZmlsdGVycyA9IHRvbmUubm90ZUZpbHRlcnM7CgkJCQljb25zdCBmaWx0ZXJDb3VudCA9IHRvbmUubm90ZUZpbHRlckNvdW50fDA7CgkJCQlsZXQgaW5pdGlhbEZpbHRlcklucHV0MSA9ICt0b25lLmluaXRpYWxOb3RlRmlsdGVySW5wdXQxOwoJCQkJbGV0IGluaXRpYWxGaWx0ZXJJbnB1dDIgPSArdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MjsKCQkJCWNvbnN0IGFwcGx5RmlsdGVycyA9IFN5bnRoLmFwcGx5RmlsdGVyczsKCQkJCQoJCQkJY29uc3QgcGl0Y2hDaGFuZ2VkIyA9IE1hdGguYWJzKE1hdGgubG9nMihkZWxheUxlbmd0aCMgLyBwcmV2RGVsYXlMZW5ndGgjKSkgPiAwLjAxOwoJCQkJbGV0IGRlbGF5SW5kZXgjID0gcGlja2VkU3RyaW5nIy5kZWxheUluZGV4fDA7YDsKICAgICAgICAgICAgICAgIGZvciAobGV0IHZvaWNlID0gMDsgdm9pY2UgPCB2b2ljZUNvdW50OyB2b2ljZSsrKSB7CiAgICAgICAgICAgICAgICAgICAgcGlja2VkU3RyaW5nU291cmNlICs9IGAKCQkJCQoJCQkJY29uc3QgcmVpbml0aWFsaXplSW1wdWxzZSMgPSAoZGVsYXlJbmRleCMgPT0gLTEgfHwgcGl0Y2hDaGFuZ2VkIyk7CgkJCQlpZiAocGlja2VkU3RyaW5nIy5kZWxheUxpbmUgPT0gbnVsbCB8fCBwaWNrZWRTdHJpbmcjLmRlbGF5TGluZS5sZW5ndGggPD0gbWluQnVmZmVyTGVuZ3RoIykgewoJCQkJCS8vIFRoZSBkZWxheSBsaW5lIGJ1ZmZlciB3aWxsIGdldCByZXVzZWQgZm9yIG90aGVyIHRvbmVzIHNvIG1pZ2h0IGFzIHdlbGwKCQkJCQkvLyBzdGFydCBvZmYgd2l0aCBhIGJ1ZmZlciBzaXplIHRoYXQgaXMgYmlnIGVub3VnaCBmb3IgbW9zdCBub3Rlcy4KCQkJCQljb25zdCBsaWtlbHlNYXhpbXVtTGVuZ3RoID0gTWF0aC5jZWlsKDIgKiBzeW50aC5zYW1wbGVzUGVyU2Vjb25kIC8gYmVlcGJveC5JbnN0cnVtZW50LmZyZXF1ZW5jeUZyb21QaXRjaCgxMikpOwoJCQkJCWNvbnN0IG5ld0RlbGF5TGluZSA9IG5ldyBGbG9hdDMyQXJyYXkoU3ludGguZml0dGluZ1Bvd2VyT2ZUd28oTWF0aC5tYXgobGlrZWx5TWF4aW11bUxlbmd0aCwgbWluQnVmZmVyTGVuZ3RoIykpKTsKCQkJCQlpZiAoIXJlaW5pdGlhbGl6ZUltcHVsc2UjICYmIHBpY2tlZFN0cmluZyMuZGVsYXlMaW5lICE9IG51bGwpIHsKCQkJCQkJLy8gSWYgdGhlIHRvbmUgaGFzIGFscmVhZHkgc3RhcnRlZCBidXQgdGhlIGJ1ZmZlciBuZWVkcyB0byBiZSByZWFsbG9jYXRlZCwKCQkJCQkJLy8gdHJhbnNmZXIgdGhlIG9sZCBkYXRhIHRvIHRoZSBuZXcgYnVmZmVyLgoJCQkJCQljb25zdCBvbGREZWxheUJ1ZmZlck1hc2sgPSAocGlja2VkU3RyaW5nIy5kZWxheUxpbmUubGVuZ3RoIC0gMSkgPj4gMDsKCQkJCQkJY29uc3Qgc3RhcnRDb3B5aW5nRnJvbUluZGV4ID0gZGVsYXlJbmRleCMgKyBwaWNrZWRTdHJpbmcjLmRlbGF5UmVzZXRPZmZzZXQ7CgkJCQkJCWRlbGF5SW5kZXgjID0gcGlja2VkU3RyaW5nIy5kZWxheUxpbmUubGVuZ3RoIC0gcGlja2VkU3RyaW5nIy5kZWxheVJlc2V0T2Zmc2V0OwoJCQkJCQlmb3IgKGxldCBpID0gMDsgaSA8IHBpY2tlZFN0cmluZyMuZGVsYXlMaW5lLmxlbmd0aDsgaSsrKSB7CgkJCQkJCQluZXdEZWxheUxpbmVbaV0gPSBwaWNrZWRTdHJpbmcjLmRlbGF5TGluZVsoc3RhcnRDb3B5aW5nRnJvbUluZGV4ICsgaSkgJiBvbGREZWxheUJ1ZmZlck1hc2tdOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXBpY2tlZFN0cmluZyMuZGVsYXlMaW5lID0gbmV3RGVsYXlMaW5lOwoJCQkJfQoJCQkJY29uc3QgZGVsYXlMaW5lIyA9IHBpY2tlZFN0cmluZyMuZGVsYXlMaW5lOwoJCQkJY29uc3QgZGVsYXlCdWZmZXJNYXNrIyA9IChkZWxheUxpbmUjLmxlbmd0aCAtIDEpID4+IDA7CgkJCQkKCQkJCWlmIChyZWluaXRpYWxpemVJbXB1bHNlIykgewoJCQkJCS8vIC0xIGRlbGF5IGluZGV4IG1lYW5zIHRoZSB0b25lIHdhcyByZXNldC4KCQkJCQkvLyBBbHNvLCBpZiB0aGUgcGl0Y2ggY2hhbmdlZCBzdWRkZW5seSAoZS5nLiBmcm9tIHNlYW1sZXNzIG9yIGFycGVnZ2lvKSB0aGVuIHJlc2V0IHRoZSB3YXZlLgoJCQkJCQoJCQkJCWRlbGF5SW5kZXgjID0gMDsKCQkJCQlhbGxQYXNzU2FtcGxlIyA9IDAuMDsKCQkJCQlhbGxQYXNzUHJldklucHV0IyA9IDAuMDsKCQkJCQlzaGVsZlNhbXBsZSMgPSAwLjA7CgkJCQkJc2hlbGZQcmV2SW5wdXQjID0gMC4wOwoJCQkJCWZyYWN0aW9uYWxEZWxheVNhbXBsZSMgPSAwLjA7CgkJCQkJCgkJCQkJLy8gQ2xlYXIgYXdheSBhIHJlZ2lvbiBvZiB0aGUgZGVsYXkgYnVmZmVyIGZvciB0aGUgbmV3IGltcHVsc2UuCgkJCQkJY29uc3Qgc3RhcnRJbXB1bHNlRnJvbSA9IC1kZWxheUxlbmd0aCM7CgkJCQkJY29uc3Qgc3RhcnRaZXJvc0Zyb20gPSBNYXRoLmZsb29yKHN0YXJ0SW1wdWxzZUZyb20gLSBwZXJpb2RMZW5ndGhTdGFydCMgLyAyKTsKCQkJCQljb25zdCBzdG9wWmVyb3NBdCA9IE1hdGguY2VpbChzdGFydFplcm9zRnJvbSArIHBlcmlvZExlbmd0aFN0YXJ0IyAqIDIpOwoJCQkJCXBpY2tlZFN0cmluZyMuZGVsYXlSZXNldE9mZnNldCA9IHN0b3BaZXJvc0F0OyAvLyBBbmQgY29udGludWUgY2xlYXJpbmcgdGhlIGFyZWEgaW4gZnJvbnQgb2YgdGhlIGRlbGF5IGxpbmUuCgkJCQkJZm9yIChsZXQgaSA9IHN0YXJ0WmVyb3NGcm9tOyBpIDw9IHN0b3BaZXJvc0F0OyBpKyspIHsKCQkJCQkJZGVsYXlMaW5lI1tpICYgZGVsYXlCdWZmZXJNYXNrI10gPSAwLjA7CgkJCQkJfQoJCQkJCQoJCQkJCWNvbnN0IGltcHVsc2VXYXZlID0gaW5zdHJ1bWVudC5oYXJtb25pY3NXYXZlLmdldEN1c3RvbVdhdmUoaW5zdHJ1bWVudC50eXBlKTsKCQkJCQljb25zdCBpbXB1bHNlV2F2ZUxlbmd0aCA9IGltcHVsc2VXYXZlLmxlbmd0aCAtIDE7IC8vIFRoZSBmaXJzdCBzYW1wbGUgaXMgZHVwbGljYXRlZCBhdCB0aGUgZW5kLCBkb24ndCBkb3VibGUtY291bnQgaXQuCgkJCQkJY29uc3QgaW1wdWxzZVBoYXNlRGVsdGEgPSBpbXB1bHNlV2F2ZUxlbmd0aCAvIHBlcmlvZExlbmd0aFN0YXJ0IzsKCQkJCQkKCQkJCQljb25zdCBmYWRlRHVyYXRpb24gPSBNYXRoLm1pbihwZXJpb2RMZW5ndGhTdGFydCMgKiAwLjIsIHN5bnRoLnNhbXBsZXNQZXJTZWNvbmQgKiAwLjAwMyk7CgkJCQkJY29uc3Qgc3RhcnRJbXB1bHNlRnJvbVNhbXBsZSA9IE1hdGguY2VpbChzdGFydEltcHVsc2VGcm9tKTsKCQkJCQljb25zdCBzdG9wSW1wdWxzZUF0ID0gc3RhcnRJbXB1bHNlRnJvbSArIHBlcmlvZExlbmd0aFN0YXJ0IyArIGZhZGVEdXJhdGlvbjsKCQkJCQljb25zdCBzdG9wSW1wdWxzZUF0U2FtcGxlID0gc3RvcEltcHVsc2VBdDsKCQkJCQlsZXQgaW1wdWxzZVBoYXNlID0gKHN0YXJ0SW1wdWxzZUZyb21TYW1wbGUgLSBzdGFydEltcHVsc2VGcm9tKSAqIGltcHVsc2VQaGFzZURlbHRhOwoJCQkJCWxldCBwcmV2V2F2ZUludGVncmFsID0gMC4wOwoJCQkJCWZvciAobGV0IGkgPSBzdGFydEltcHVsc2VGcm9tU2FtcGxlOyBpIDw9IHN0b3BJbXB1bHNlQXRTYW1wbGU7IGkrKykgewoJCQkJCQljb25zdCBpbXB1bHNlUGhhc2VJbnQgPSBpbXB1bHNlUGhhc2V8MDsKCQkJCQkJY29uc3QgaW5kZXggPSBpbXB1bHNlUGhhc2VJbnQgJSBpbXB1bHNlV2F2ZUxlbmd0aDsKCQkJCQkJbGV0IG5leHRXYXZlSW50ZWdyYWwgPSBpbXB1bHNlV2F2ZVtpbmRleF07CgkJCQkJCWNvbnN0IHBoYXNlUmF0aW8gPSBpbXB1bHNlUGhhc2UgLSBpbXB1bHNlUGhhc2VJbnQ7CgkJCQkJCW5leHRXYXZlSW50ZWdyYWwgKz0gKGltcHVsc2VXYXZlW2luZGV4KzFdIC0gbmV4dFdhdmVJbnRlZ3JhbCkgKiBwaGFzZVJhdGlvOwoJCQkJCQljb25zdCBzYW1wbGUgPSAobmV4dFdhdmVJbnRlZ3JhbCAtIHByZXZXYXZlSW50ZWdyYWwpIC8gaW1wdWxzZVBoYXNlRGVsdGE7CgkJCQkJCWNvbnN0IGZhZGVJbiA9IE1hdGgubWluKDEuMCwgKGkgLSBzdGFydEltcHVsc2VGcm9tKSAvIGZhZGVEdXJhdGlvbik7CgkJCQkJCWNvbnN0IGZhZGVPdXQgPSBNYXRoLm1pbigxLjAsIChzdG9wSW1wdWxzZUF0IC0gaSkgLyBmYWRlRHVyYXRpb24pOwoJCQkJCQljb25zdCBjb21iaW5lZEZhZGUgPSBmYWRlSW4gKiBmYWRlT3V0OwoJCQkJCQljb25zdCBjdXJ2ZWRGYWRlID0gY29tYmluZWRGYWRlICogY29tYmluZWRGYWRlICogKDMuMCAtIDIuMCAqIGNvbWJpbmVkRmFkZSk7IC8vIEEgY3ViaWMgc2lnbW9pZCBmcm9tIDAgdG8gMS4KCQkJCQkJZGVsYXlMaW5lI1tpICYgZGVsYXlCdWZmZXJNYXNrI10gKz0gc2FtcGxlICogY3VydmVkRmFkZTsKCQkJCQkJcHJldldhdmVJbnRlZ3JhbCA9IG5leHRXYXZlSW50ZWdyYWw7CgkJCQkJCWltcHVsc2VQaGFzZSArPSBpbXB1bHNlUGhhc2VEZWx0YTsKCQkJCQl9CgkJCQl9CgkJCQlkZWxheUluZGV4IyA9IChkZWxheUluZGV4IyAmIGRlbGF5QnVmZmVyTWFzayMpICsgZGVsYXlMaW5lIy5sZW5ndGg7YC5yZXBsYWNlKC9cIy9nLCBTdHJpbmcodm9pY2UpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBpY2tlZFN0cmluZ1NvdXJjZSArPSBgCgkJCQkKCQkJCWNvbnN0IHVuaXNvblNpZ24gPSB0b25lLnNwZWNpYWxJbnRlcnZhbEV4cHJlc3Npb25NdWx0ICogQ29uZmlnLnVuaXNvbnNbaW5zdHJ1bWVudC51bmlzb25dLnNpZ247CgkJCQljb25zdCBkZWxheVJlc2V0T2Zmc2V0IyA9IHBpY2tlZFN0cmluZyMuZGVsYXlSZXNldE9mZnNldHwwOwoJCQkJCgkJCQljb25zdCBzdG9wSW5kZXggPSBidWZmZXJJbmRleCArIHJ1bkxlbmd0aDsKCQkJCWZvciAobGV0IHNhbXBsZUluZGV4ID0gYnVmZmVySW5kZXg7IHNhbXBsZUluZGV4IDwgc3RvcEluZGV4OyBzYW1wbGVJbmRleCsrKSB7CgkJCQkJY29uc3QgdGFyZ2V0U2FtcGxlVGltZSMgPSBkZWxheUluZGV4IyAtIGRlbGF5TGVuZ3RoIzsKCQkJCQljb25zdCBsb3dlckluZGV4IyA9ICh0YXJnZXRTYW1wbGVUaW1lIyArIDAuMTI1KSB8IDA7IC8vIE9mZnNldCB0byBpbXByb3ZlIHN0YWJpbGl0eSBvZiBhbGwtcGFzcyBmaWx0ZXIuCgkJCQkJY29uc3QgdXBwZXJJbmRleCMgPSBsb3dlckluZGV4IyArIDE7CgkJCQkJY29uc3QgZnJhY3Rpb25hbERlbGF5IyA9IHVwcGVySW5kZXgjIC0gdGFyZ2V0U2FtcGxlVGltZSM7CgkJCQkJY29uc3QgZnJhY3Rpb25hbERlbGF5RyMgPSAoMS4wIC0gZnJhY3Rpb25hbERlbGF5IykgLyAoMS4wICsgZnJhY3Rpb25hbERlbGF5Iyk7IC8vIElubGluZWQgdmVyc2lvbiBvZiBGaWx0ZXJDb2VmZmljaWVudHMucHJvdG90eXBlLmFsbFBhc3Mxc3RPcmRlckZyYWN0aW9uYWxEZWxheQoJCQkJCWNvbnN0IHByZXZJbnB1dCMgPSBkZWxheUxpbmUjW2xvd2VySW5kZXgjICYgZGVsYXlCdWZmZXJNYXNrI107CgkJCQkJY29uc3QgaW5wdXQjID0gZGVsYXlMaW5lI1t1cHBlckluZGV4IyAmIGRlbGF5QnVmZmVyTWFzayNdOwoJCQkJCWZyYWN0aW9uYWxEZWxheVNhbXBsZSMgPSBmcmFjdGlvbmFsRGVsYXlHIyAqIGlucHV0IyArIHByZXZJbnB1dCMgLSBmcmFjdGlvbmFsRGVsYXlHIyAqIGZyYWN0aW9uYWxEZWxheVNhbXBsZSM7CgkJCQkJCgkJCQkJYWxsUGFzc1NhbXBsZSMgPSBmcmFjdGlvbmFsRGVsYXlTYW1wbGUjICogYWxsUGFzc0cjICsgYWxsUGFzc1ByZXZJbnB1dCMgLSBhbGxQYXNzRyMgKiBhbGxQYXNzU2FtcGxlIzsKCQkJCQlhbGxQYXNzUHJldklucHV0IyA9IGZyYWN0aW9uYWxEZWxheVNhbXBsZSM7CgkJCQkJCgkJCQkJc2hlbGZTYW1wbGUjID0gc2hlbGZCMCMgKiBhbGxQYXNzU2FtcGxlIyArIHNoZWxmQjEjICogc2hlbGZQcmV2SW5wdXQjIC0gc2hlbGZBMSMgKiBzaGVsZlNhbXBsZSM7CgkJCQkJc2hlbGZQcmV2SW5wdXQjID0gYWxsUGFzc1NhbXBsZSM7CgkJCQkJCgkJCQkJZGVsYXlMaW5lI1tkZWxheUluZGV4IyAmIGRlbGF5QnVmZmVyTWFzayNdICs9IHNoZWxmU2FtcGxlIzsKCQkJCQlkZWxheUxpbmUjWyhkZWxheUluZGV4IyArIGRlbGF5UmVzZXRPZmZzZXQjKSAmIGRlbGF5QnVmZmVyTWFzayNdID0gMC4wOwoJCQkJCWRlbGF5SW5kZXgjKys7CgkJCQkJCgkJCQkJY29uc3QgaW5wdXRTYW1wbGUgPSAoYDsKICAgICAgICAgICAgICAgIGNvbnN0IHNhbXBsZUxpc3QgPSBbXTsKICAgICAgICAgICAgICAgIGZvciAobGV0IHZvaWNlID0gMDsgdm9pY2UgPCB2b2ljZUNvdW50OyB2b2ljZSsrKSB7CiAgICAgICAgICAgICAgICAgICAgc2FtcGxlTGlzdC5wdXNoKCJmcmFjdGlvbmFsRGVsYXlTYW1wbGUiICsgdm9pY2UgKyAodm9pY2UgPT0gMSA/ICIgKiB1bmlzb25TaWduIiA6ICIiKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwaWNrZWRTdHJpbmdTb3VyY2UgKz0gc2FtcGxlTGlzdC5qb2luKCIgKyAiKTsKICAgICAgICAgICAgICAgIHBpY2tlZFN0cmluZ1NvdXJjZSArPSBgKSAqIGV4cHJlc3Npb247CgkJCQkJY29uc3Qgc2FtcGxlID0gYXBwbHlGaWx0ZXJzKGlucHV0U2FtcGxlLCBpbml0aWFsRmlsdGVySW5wdXQxLCBpbml0aWFsRmlsdGVySW5wdXQyLCBmaWx0ZXJDb3VudCwgZmlsdGVycyk7CgkJCQkJaW5pdGlhbEZpbHRlcklucHV0MiA9IGluaXRpYWxGaWx0ZXJJbnB1dDE7CgkJCQkJaW5pdGlhbEZpbHRlcklucHV0MSA9IGlucHV0U2FtcGxlOwoJCQkJCWRhdGFbc2FtcGxlSW5kZXhdICs9IHNhbXBsZTsKCQkJCQkKCQkJCQlleHByZXNzaW9uICs9IGV4cHJlc3Npb25EZWx0YTsKCQkJCQlkZWxheUxlbmd0aCMgKz0gZGVsYXlMZW5ndGhEZWx0YSM7CgkJCQkJYWxsUGFzc0cjICs9IGFsbFBhc3NHRGVsdGEjOwoJCQkJCXNoZWxmQTEjICs9IHNoZWxmQTFEZWx0YSM7CgkJCQkJc2hlbGZCMCMgKz0gc2hlbGZCMERlbHRhIzsKCQkJCQlzaGVsZkIxIyArPSBzaGVsZkIxRGVsdGEjOwoJCQkJfQoJCQkJCgkJCQkvLyBBdm9pZCBwZXJzaXN0ZW50IGRlbm9ybWFsIG9yIE5hTiB2YWx1ZXMgaW4gdGhlIGRlbGF5IGJ1ZmZlcnMgYW5kIGZpbHRlciBoaXN0b3J5LgoJCQkJY29uc3QgZXBzaWxvbiA9ICgxLjBlLTI0KTsKCQkJCWlmICghTnVtYmVyLmlzRmluaXRlKGFsbFBhc3NTYW1wbGUjKSB8fCBNYXRoLmFicyhhbGxQYXNzU2FtcGxlIykgPCBlcHNpbG9uKSBhbGxQYXNzU2FtcGxlIyA9IDAuMDsKCQkJCWlmICghTnVtYmVyLmlzRmluaXRlKGFsbFBhc3NQcmV2SW5wdXQjKSB8fCBNYXRoLmFicyhhbGxQYXNzUHJldklucHV0IykgPCBlcHNpbG9uKSBhbGxQYXNzUHJldklucHV0IyA9IDAuMDsKCQkJCWlmICghTnVtYmVyLmlzRmluaXRlKHNoZWxmU2FtcGxlIykgfHwgTWF0aC5hYnMoc2hlbGZTYW1wbGUjKSA8IGVwc2lsb24pIHNoZWxmU2FtcGxlIyA9IDAuMDsKCQkJCWlmICghTnVtYmVyLmlzRmluaXRlKHNoZWxmUHJldklucHV0IykgfHwgTWF0aC5hYnMoc2hlbGZQcmV2SW5wdXQjKSA8IGVwc2lsb24pIHNoZWxmUHJldklucHV0IyA9IDAuMDsKCQkJCWlmICghTnVtYmVyLmlzRmluaXRlKGZyYWN0aW9uYWxEZWxheVNhbXBsZSMpIHx8IE1hdGguYWJzKGZyYWN0aW9uYWxEZWxheVNhbXBsZSMpIDwgZXBzaWxvbikgZnJhY3Rpb25hbERlbGF5U2FtcGxlIyA9IDAuMDsKCQkJCXBpY2tlZFN0cmluZyMuYWxsUGFzc1NhbXBsZSA9IGFsbFBhc3NTYW1wbGUjOwoJCQkJcGlja2VkU3RyaW5nIy5hbGxQYXNzUHJldklucHV0ID0gYWxsUGFzc1ByZXZJbnB1dCM7CgkJCQlwaWNrZWRTdHJpbmcjLnNoZWxmU2FtcGxlID0gc2hlbGZTYW1wbGUjOwoJCQkJcGlja2VkU3RyaW5nIy5zaGVsZlByZXZJbnB1dCA9IHNoZWxmUHJldklucHV0IzsKCQkJCXBpY2tlZFN0cmluZyMuZnJhY3Rpb25hbERlbGF5U2FtcGxlID0gZnJhY3Rpb25hbERlbGF5U2FtcGxlIzsKCQkJCXBpY2tlZFN0cmluZyMuZGVsYXlJbmRleCA9IGRlbGF5SW5kZXgjOwoJCQkJcGlja2VkU3RyaW5nIy5wcmV2RGVsYXlMZW5ndGggPSBkZWxheUxlbmd0aCM7CgkJCQkKCQkJCXN5bnRoLnNhbml0aXplRmlsdGVycyhmaWx0ZXJzKTsKCQkJCXRvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDEgPSBpbml0aWFsRmlsdGVySW5wdXQxOwoJCQkJdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MiA9IGluaXRpYWxGaWx0ZXJJbnB1dDI7YDsKICAgICAgICAgICAgICAgIHBpY2tlZFN0cmluZ1NvdXJjZSA9IHBpY2tlZFN0cmluZ1NvdXJjZS5yZXBsYWNlKC9eLipcIy4qJC9tZywgbGluZSA9PiB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGluZXMgPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCB2b2ljZSA9IDA7IHZvaWNlIDwgdm9pY2VDb3VudDsgdm9pY2UrKykgewogICAgICAgICAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKGxpbmUucmVwbGFjZSgvXCMvZywgU3RyaW5nKHZvaWNlKSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGluZXMuam9pbigiXG4iKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgcGlja2VkU3RyaW5nRnVuY3Rpb24gPSBuZXcgRnVuY3Rpb24oInN5bnRoIiwgImJ1ZmZlckluZGV4IiwgInJ1bkxlbmd0aCIsICJ0b25lIiwgImluc3RydW1lbnQiLCBwaWNrZWRTdHJpbmdTb3VyY2UpOwogICAgICAgICAgICAgICAgU3ludGgucGlja2VkU3RyaW5nRnVuY3Rpb25DYWNoZVt2b2ljZUNvdW50XSA9IHBpY2tlZFN0cmluZ0Z1bmN0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBpY2tlZFN0cmluZ0Z1bmN0aW9uKHN5bnRoLCBidWZmZXJJbmRleCwgcnVuTGVuZ3RoLCB0b25lLCBpbnN0cnVtZW50KTsKICAgICAgICB9CiAgICAgICAgc3RhdGljIGVmZmVjdHNTeW50aChzeW50aCwgb3V0cHV0RGF0YUwsIG91dHB1dERhdGFSLCBidWZmZXJJbmRleCwgcnVuTGVuZ3RoLCBpbnN0cnVtZW50LCBpbnN0cnVtZW50U3RhdGUpIHsKICAgICAgICAgICAgY29uc3QgdXNlc0Rpc3RvcnRpb24gPSBlZmZlY3RzSW5jbHVkZURpc3RvcnRpb24oaW5zdHJ1bWVudC5lZmZlY3RzKSAmJiBpbnN0cnVtZW50LmRpc3RvcnRpb24gIT0gMDsKICAgICAgICAgICAgY29uc3QgdXNlc0JpdGNydXNoZXIgPSBlZmZlY3RzSW5jbHVkZUJpdGNydXNoZXIoaW5zdHJ1bWVudC5lZmZlY3RzKTsKICAgICAgICAgICAgY29uc3QgdXNlc0VxRmlsdGVyID0gaW5zdHJ1bWVudFN0YXRlLmVxRmlsdGVyQ291bnQgPiAwOwogICAgICAgICAgICBjb25zdCB1c2VzUGFubmluZyA9IGVmZmVjdHNJbmNsdWRlUGFubmluZyhpbnN0cnVtZW50LmVmZmVjdHMpICYmIGluc3RydW1lbnQucGFuICE9IENvbmZpZy5wYW5DZW50ZXI7CiAgICAgICAgICAgIGNvbnN0IHVzZXNDaG9ydXMgPSBlZmZlY3RzSW5jbHVkZUNob3J1cyhpbnN0cnVtZW50LmVmZmVjdHMpICYmIGluc3RydW1lbnQuY2hvcnVzICE9IDA7CiAgICAgICAgICAgIGNvbnN0IHVzZXNFY2hvID0gZWZmZWN0c0luY2x1ZGVFY2hvKGluc3RydW1lbnQuZWZmZWN0cykgJiYgaW5zdHJ1bWVudC5lY2hvU3VzdGFpbiAhPSAwOwogICAgICAgICAgICBjb25zdCB1c2VzUmV2ZXJiID0gZWZmZWN0c0luY2x1ZGVSZXZlcmIoaW5zdHJ1bWVudC5lZmZlY3RzKSAmJiBpbnN0cnVtZW50LnJldmVyYiAhPSAwOwogICAgICAgICAgICBsZXQgc2lnbmF0dXJlID0gMDsKICAgICAgICAgICAgaWYgKHVzZXNEaXN0b3J0aW9uKQogICAgICAgICAgICAgICAgc2lnbmF0dXJlID0gc2lnbmF0dXJlIHwgMTsKICAgICAgICAgICAgc2lnbmF0dXJlID0gc2lnbmF0dXJlIDw8IDE7CiAgICAgICAgICAgIGlmICh1c2VzQml0Y3J1c2hlcikKICAgICAgICAgICAgICAgIHNpZ25hdHVyZSA9IHNpZ25hdHVyZSB8IDE7CiAgICAgICAgICAgIHNpZ25hdHVyZSA9IHNpZ25hdHVyZSA8PCAxOwogICAgICAgICAgICBpZiAodXNlc0VxRmlsdGVyKQogICAgICAgICAgICAgICAgc2lnbmF0dXJlID0gc2lnbmF0dXJlIHwgMTsKICAgICAgICAgICAgc2lnbmF0dXJlID0gc2lnbmF0dXJlIDw8IDE7CiAgICAgICAgICAgIGlmICh1c2VzUGFubmluZykKICAgICAgICAgICAgICAgIHNpZ25hdHVyZSA9IHNpZ25hdHVyZSB8IDE7CiAgICAgICAgICAgIHNpZ25hdHVyZSA9IHNpZ25hdHVyZSA8PCAxOwogICAgICAgICAgICBpZiAodXNlc0Nob3J1cykKICAgICAgICAgICAgICAgIHNpZ25hdHVyZSA9IHNpZ25hdHVyZSB8IDE7CiAgICAgICAgICAgIHNpZ25hdHVyZSA9IHNpZ25hdHVyZSA8PCAxOwogICAgICAgICAgICBpZiAodXNlc0VjaG8pCiAgICAgICAgICAgICAgICBzaWduYXR1cmUgPSBzaWduYXR1cmUgfCAxOwogICAgICAgICAgICBzaWduYXR1cmUgPSBzaWduYXR1cmUgPDwgMTsKICAgICAgICAgICAgaWYgKHVzZXNSZXZlcmIpCiAgICAgICAgICAgICAgICBzaWduYXR1cmUgPSBzaWduYXR1cmUgfCAxOwogICAgICAgICAgICBsZXQgZWZmZWN0c0Z1bmN0aW9uID0gU3ludGguZWZmZWN0c0Z1bmN0aW9uQ2FjaGVbc2lnbmF0dXJlXTsKICAgICAgICAgICAgaWYgKGVmZmVjdHNGdW5jdGlvbiA9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgIGxldCBlZmZlY3RzU291cmNlID0gIiI7CiAgICAgICAgICAgICAgICBjb25zdCB1c2VzRGVsYXlzID0gdXNlc0Nob3J1cyB8fCB1c2VzUmV2ZXJiIHx8IHVzZXNFY2hvOwogICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQljb25zdCB0ZW1wTW9ub0luc3RydW1lbnRTYW1wbGVCdWZmZXIgPSBzeW50aC50ZW1wTW9ub0luc3RydW1lbnRTYW1wbGVCdWZmZXI7CgkJCQkKCQkJCWxldCBtaXhWb2x1bWUgPSAraW5zdHJ1bWVudFN0YXRlLm1peFZvbHVtZVN0YXJ0OwoJCQkJY29uc3QgbWl4Vm9sdW1lRGVsdGEgPSAraW5zdHJ1bWVudFN0YXRlLm1peFZvbHVtZURlbHRhO2A7CiAgICAgICAgICAgICAgICBpZiAodXNlc0RlbGF5cykgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCgkJCQlsZXQgZGVsYXlJbnB1dE11bHQgPSAraW5zdHJ1bWVudFN0YXRlLmRlbGF5SW5wdXRNdWx0U3RhcnQ7CgkJCQljb25zdCBkZWxheUlucHV0TXVsdERlbHRhID0gK2luc3RydW1lbnRTdGF0ZS5kZWxheUlucHV0TXVsdERlbHRhO2A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodXNlc0Rpc3RvcnRpb24pIHsKICAgICAgICAgICAgICAgICAgICBlZmZlY3RzU291cmNlICs9IGAKCQkJCQoJCQkJY29uc3QgZGlzdG9ydGlvbkJhc2VWb2x1bWUgPSArYmVlcGJveC5Db25maWcuZGlzdG9ydGlvbkJhc2VWb2x1bWU7CgkJCQljb25zdCBkaXN0b3J0aW9uU3RhcnQgPSArTWF0aC5wb3coMS4wIC0gMC44OTUgKiAoTWF0aC5wb3coMjAuMCwgaW5zdHJ1bWVudFN0YXRlLmRpc3RvcnRpb25TdGFydCkgLSAxLjApIC8gMTkuMCwgMi4wKQoJCQkJY29uc3QgZGlzdG9ydGlvbkVuZCAgID0gK01hdGgucG93KDEuMCAtIDAuODk1ICogKE1hdGgucG93KDIwLjAsIGluc3RydW1lbnRTdGF0ZS5kaXN0b3J0aW9uRW5kICApIC0gMS4wKSAvIDE5LjAsIDIuMCkKCQkJCWxldCBkaXN0b3J0aW9uID0gZGlzdG9ydGlvblN0YXJ0OwoJCQkJY29uc3QgZGlzdG9ydGlvbkRlbHRhID0gKGRpc3RvcnRpb25FbmQgLSBkaXN0b3J0aW9uU3RhcnQpIC8gcnVuTGVuZ3RoOwoJCQkJY29uc3QgZGlzdG9ydGlvbkRyaXZlU3RhcnQgPSAoMS4wICsgMi4wICogaW5zdHJ1bWVudFN0YXRlLmRpc3RvcnRpb25TdGFydCkgLyBkaXN0b3J0aW9uQmFzZVZvbHVtZTsKCQkJCWNvbnN0IGRpc3RvcnRpb25Ecml2ZUVuZCAgID0gKDEuMCArIDIuMCAqIGluc3RydW1lbnRTdGF0ZS5kaXN0b3J0aW9uRW5kKSAgIC8gZGlzdG9ydGlvbkJhc2VWb2x1bWU7CgkJCQlsZXQgZGlzdG9ydGlvbkRyaXZlID0gZGlzdG9ydGlvbkRyaXZlU3RhcnQ7CgkJCQljb25zdCBkaXN0b3J0aW9uRHJpdmVEZWx0YSA9IChkaXN0b3J0aW9uRHJpdmVFbmQgLSBkaXN0b3J0aW9uRHJpdmVTdGFydCkgLyBydW5MZW5ndGg7CgkJCQljb25zdCBkaXN0b3J0aW9uRnJhY3Rpb25hbFJlc29sdXRpb24gPSA0LjA7CgkJCQljb25zdCBkaXN0b3J0aW9uT3ZlcnNhbXBsZUNvbXBlbnNhdGlvbiA9IGRpc3RvcnRpb25CYXNlVm9sdW1lIC8gZGlzdG9ydGlvbkZyYWN0aW9uYWxSZXNvbHV0aW9uOwoJCQkJY29uc3QgZGlzdG9ydGlvbkZyYWN0aW9uYWxEZWxheTEgPSAxLjAgLyBkaXN0b3J0aW9uRnJhY3Rpb25hbFJlc29sdXRpb247CgkJCQljb25zdCBkaXN0b3J0aW9uRnJhY3Rpb25hbERlbGF5MiA9IDIuMCAvIGRpc3RvcnRpb25GcmFjdGlvbmFsUmVzb2x1dGlvbjsKCQkJCWNvbnN0IGRpc3RvcnRpb25GcmFjdGlvbmFsRGVsYXkzID0gMy4wIC8gZGlzdG9ydGlvbkZyYWN0aW9uYWxSZXNvbHV0aW9uOwoJCQkJY29uc3QgZGlzdG9ydGlvbkZyYWN0aW9uYWxEZWxheUcxID0gKDEuMCAtIGRpc3RvcnRpb25GcmFjdGlvbmFsRGVsYXkxKSAvICgxLjAgKyBkaXN0b3J0aW9uRnJhY3Rpb25hbERlbGF5MSk7IC8vIElubGluZWQgdmVyc2lvbiBvZiBGaWx0ZXJDb2VmZmljaWVudHMucHJvdG90eXBlLmFsbFBhc3Mxc3RPcmRlckZyYWN0aW9uYWxEZWxheQoJCQkJY29uc3QgZGlzdG9ydGlvbkZyYWN0aW9uYWxEZWxheUcyID0gKDEuMCAtIGRpc3RvcnRpb25GcmFjdGlvbmFsRGVsYXkyKSAvICgxLjAgKyBkaXN0b3J0aW9uRnJhY3Rpb25hbERlbGF5Mik7IC8vIElubGluZWQgdmVyc2lvbiBvZiBGaWx0ZXJDb2VmZmljaWVudHMucHJvdG90eXBlLmFsbFBhc3Mxc3RPcmRlckZyYWN0aW9uYWxEZWxheQoJCQkJY29uc3QgZGlzdG9ydGlvbkZyYWN0aW9uYWxEZWxheUczID0gKDEuMCAtIGRpc3RvcnRpb25GcmFjdGlvbmFsRGVsYXkzKSAvICgxLjAgKyBkaXN0b3J0aW9uRnJhY3Rpb25hbERlbGF5Myk7IC8vIElubGluZWQgdmVyc2lvbiBvZiBGaWx0ZXJDb2VmZmljaWVudHMucHJvdG90eXBlLmFsbFBhc3Mxc3RPcmRlckZyYWN0aW9uYWxEZWxheQoJCQkJY29uc3QgZGlzdG9ydGlvbk5leHRPdXRwdXRXZWlnaHQxID0gTWF0aC5jb3MoTWF0aC5QSSAqIGRpc3RvcnRpb25GcmFjdGlvbmFsRGVsYXkxKSAqIDAuNSArIDAuNTsKCQkJCWNvbnN0IGRpc3RvcnRpb25OZXh0T3V0cHV0V2VpZ2h0MiA9IE1hdGguY29zKE1hdGguUEkgKiBkaXN0b3J0aW9uRnJhY3Rpb25hbERlbGF5MikgKiAwLjUgKyAwLjU7CgkJCQljb25zdCBkaXN0b3J0aW9uTmV4dE91dHB1dFdlaWdodDMgPSBNYXRoLmNvcyhNYXRoLlBJICogZGlzdG9ydGlvbkZyYWN0aW9uYWxEZWxheTMpICogMC41ICsgMC41OwoJCQkJY29uc3QgZGlzdG9ydGlvblByZXZPdXRwdXRXZWlnaHQxID0gMS4wIC0gZGlzdG9ydGlvbk5leHRPdXRwdXRXZWlnaHQxOwoJCQkJY29uc3QgZGlzdG9ydGlvblByZXZPdXRwdXRXZWlnaHQyID0gMS4wIC0gZGlzdG9ydGlvbk5leHRPdXRwdXRXZWlnaHQyOwoJCQkJY29uc3QgZGlzdG9ydGlvblByZXZPdXRwdXRXZWlnaHQzID0gMS4wIC0gZGlzdG9ydGlvbk5leHRPdXRwdXRXZWlnaHQzOwoJCQkJCgkJCQlsZXQgZGlzdG9ydGlvbkZyYWN0aW9uYWxJbnB1dDEgPSAraW5zdHJ1bWVudFN0YXRlLmRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQxOwoJCQkJbGV0IGRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQyID0gK2luc3RydW1lbnRTdGF0ZS5kaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MjsKCQkJCWxldCBkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MyA9ICtpbnN0cnVtZW50U3RhdGUuZGlzdG9ydGlvbkZyYWN0aW9uYWxJbnB1dDM7CgkJCQlsZXQgZGlzdG9ydGlvblByZXZJbnB1dCA9ICtpbnN0cnVtZW50U3RhdGUuZGlzdG9ydGlvblByZXZJbnB1dDsKCQkJCWxldCBkaXN0b3J0aW9uTmV4dE91dHB1dCA9ICtpbnN0cnVtZW50U3RhdGUuZGlzdG9ydGlvbk5leHRPdXRwdXQ7YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1c2VzQml0Y3J1c2hlcikgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCgkJCQlsZXQgYml0Y3J1c2hlclByZXZJbnB1dCA9ICtpbnN0cnVtZW50U3RhdGUuYml0Y3J1c2hlclByZXZJbnB1dDsKCQkJCWxldCBiaXRjcnVzaGVyQ3VycmVudE91dHB1dCA9ICtpbnN0cnVtZW50U3RhdGUuYml0Y3J1c2hlckN1cnJlbnRPdXRwdXQ7CgkJCQlsZXQgYml0Y3J1c2hlclBoYXNlID0gK2luc3RydW1lbnRTdGF0ZS5iaXRjcnVzaGVyUGhhc2U7CgkJCQlsZXQgYml0Y3J1c2hlclBoYXNlRGVsdGEgPSAraW5zdHJ1bWVudFN0YXRlLmJpdGNydXNoZXJQaGFzZURlbHRhOwoJCQkJY29uc3QgYml0Y3J1c2hlclBoYXNlRGVsdGFTY2FsZSA9ICtpbnN0cnVtZW50U3RhdGUuYml0Y3J1c2hlclBoYXNlRGVsdGFTY2FsZTsKCQkJCWxldCBiaXRjcnVzaGVyU2NhbGUgPSAraW5zdHJ1bWVudFN0YXRlLmJpdGNydXNoZXJTY2FsZTsKCQkJCWNvbnN0IGJpdGNydXNoZXJTY2FsZVNjYWxlID0gK2luc3RydW1lbnRTdGF0ZS5iaXRjcnVzaGVyU2NhbGVTY2FsZTsKCQkJCWxldCBiaXRjcnVzaGVyRm9sZExldmVsID0gK2luc3RydW1lbnRTdGF0ZS5iaXRjcnVzaGVyRm9sZExldmVsOwoJCQkJY29uc3QgYml0Y3J1c2hlckZvbGRMZXZlbFNjYWxlID0gK2luc3RydW1lbnRTdGF0ZS5iaXRjcnVzaGVyRm9sZExldmVsU2NhbGU7YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1c2VzRXFGaWx0ZXIpIHsKICAgICAgICAgICAgICAgICAgICBlZmZlY3RzU291cmNlICs9IGAKCQkJCQoJCQkJbGV0IGZpbHRlcnMgPSBpbnN0cnVtZW50U3RhdGUuZXFGaWx0ZXJzOwoJCQkJY29uc3QgZmlsdGVyQ291bnQgPSBpbnN0cnVtZW50U3RhdGUuZXFGaWx0ZXJDb3VudHwwOwoJCQkJbGV0IGluaXRpYWxGaWx0ZXJJbnB1dDEgPSAraW5zdHJ1bWVudFN0YXRlLmluaXRpYWxFcUZpbHRlcklucHV0MTsKCQkJCWxldCBpbml0aWFsRmlsdGVySW5wdXQyID0gK2luc3RydW1lbnRTdGF0ZS5pbml0aWFsRXFGaWx0ZXJJbnB1dDI7CgkJCQljb25zdCBhcHBseUZpbHRlcnMgPSBiZWVwYm94LlN5bnRoLmFwcGx5RmlsdGVycztgOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkKCQkJCWxldCBlcUZpbHRlclZvbHVtZSA9ICtpbnN0cnVtZW50U3RhdGUuZXFGaWx0ZXJWb2x1bWVTdGFydDsKCQkJCWNvbnN0IGVxRmlsdGVyVm9sdW1lRGVsdGEgPSAraW5zdHJ1bWVudFN0YXRlLmVxRmlsdGVyVm9sdW1lRGVsdGE7YDsKICAgICAgICAgICAgICAgIGlmICh1c2VzUGFubmluZykgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCgkJCQljb25zdCBwYW5uaW5nTWFzayA9IHN5bnRoLnBhbm5pbmdEZWxheUJ1ZmZlck1hc2sgPj4+IDA7CgkJCQljb25zdCBwYW5uaW5nRGVsYXlMaW5lID0gaW5zdHJ1bWVudFN0YXRlLnBhbm5pbmdEZWxheUxpbmU7CgkJCQlsZXQgcGFubmluZ0RlbGF5UG9zID0gaW5zdHJ1bWVudFN0YXRlLnBhbm5pbmdEZWxheVBvcyAmIHBhbm5pbmdNYXNrOwoJCQkJbGV0ICAgcGFubmluZ1ZvbHVtZUwgICAgICA9ICtpbnN0cnVtZW50U3RhdGUucGFubmluZ1ZvbHVtZVN0YXJ0TDsKCQkJCWxldCAgIHBhbm5pbmdWb2x1bWVSICAgICAgPSAraW5zdHJ1bWVudFN0YXRlLnBhbm5pbmdWb2x1bWVTdGFydFI7CgkJCQljb25zdCBwYW5uaW5nVm9sdW1lRGVsdGFMID0gK2luc3RydW1lbnRTdGF0ZS5wYW5uaW5nVm9sdW1lRGVsdGFMOwoJCQkJY29uc3QgcGFubmluZ1ZvbHVtZURlbHRhUiA9ICtpbnN0cnVtZW50U3RhdGUucGFubmluZ1ZvbHVtZURlbHRhUjsKCQkJCWxldCAgIHBhbm5pbmdPZmZzZXRMICAgICAgPSBwYW5uaW5nRGVsYXlQb3MgLSBpbnN0cnVtZW50U3RhdGUucGFubmluZ09mZnNldFN0YXJ0TCArIHN5bnRoLnBhbm5pbmdEZWxheUJ1ZmZlclNpemU7CgkJCQlsZXQgICBwYW5uaW5nT2Zmc2V0UiAgICAgID0gcGFubmluZ0RlbGF5UG9zIC0gaW5zdHJ1bWVudFN0YXRlLnBhbm5pbmdPZmZzZXRTdGFydFIgKyBzeW50aC5wYW5uaW5nRGVsYXlCdWZmZXJTaXplOwoJCQkJY29uc3QgcGFubmluZ09mZnNldERlbHRhTCA9IDEuMCAtIGluc3RydW1lbnRTdGF0ZS5wYW5uaW5nT2Zmc2V0RGVsdGFMOwoJCQkJY29uc3QgcGFubmluZ09mZnNldERlbHRhUiA9IDEuMCAtIGluc3RydW1lbnRTdGF0ZS5wYW5uaW5nT2Zmc2V0RGVsdGFSO2A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodXNlc0Nob3J1cykgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCgkJCQljb25zdCBjaG9ydXNNYXNrID0gc3ludGguY2hvcnVzRGVsYXlCdWZmZXJNYXNrID4+PiAwOwoJCQkJY29uc3QgY2hvcnVzRGVsYXlMaW5lTCA9IGluc3RydW1lbnRTdGF0ZS5jaG9ydXNEZWxheUxpbmVMOwoJCQkJY29uc3QgY2hvcnVzRGVsYXlMaW5lUiA9IGluc3RydW1lbnRTdGF0ZS5jaG9ydXNEZWxheUxpbmVSOwoJCQkJaW5zdHJ1bWVudFN0YXRlLmNob3J1c0RlbGF5TGluZURpcnR5ID0gdHJ1ZTsKCQkJCWxldCBjaG9ydXNEZWxheVBvcyA9IGluc3RydW1lbnRTdGF0ZS5jaG9ydXNEZWxheVBvcyAmIGNob3J1c01hc2s7CgkJCQkKCQkJCWNvbnN0IGNob3J1c1N0YXJ0ID0gK2luc3RydW1lbnRTdGF0ZS5jaG9ydXNTdGFydDsKCQkJCWNvbnN0IGNob3J1c0VuZCAgID0gK2luc3RydW1lbnRTdGF0ZS5jaG9ydXNFbmQ7CgkJCQlsZXQgY2hvcnVzVm9pY2VNdWx0ID0gY2hvcnVzU3RhcnQ7CgkJCQljb25zdCBjaG9ydXNWb2ljZU11bHREZWx0YSA9IChjaG9ydXNFbmQgLSBjaG9ydXNTdGFydCkgLyBydW5MZW5ndGg7CgkJCQlsZXQgY2hvcnVzQ29tYmluZWRNdWx0ID0gMS4wIC8gTWF0aC5zcXJ0KDMuMCAqIGNob3J1c1N0YXJ0ICogY2hvcnVzU3RhcnQgKyAxLjApOwoJCQkJY29uc3QgY2hvcnVzQ29tYmluZWRNdWx0RW5kID0gMS4wIC8gTWF0aC5zcXJ0KDMuMCAqIGNob3J1c0VuZCAqIGNob3J1c0VuZCArIDEuMCk7CgkJCQljb25zdCBjaG9ydXNDb21iaW5lZE11bHREZWx0YSA9IChjaG9ydXNDb21iaW5lZE11bHRFbmQgLSBjaG9ydXNDb21iaW5lZE11bHQpIC8gcnVuTGVuZ3RoOwoJCQkJCgkJCQljb25zdCBjaG9ydXNEdXJhdGlvbiA9ICtiZWVwYm94LkNvbmZpZy5jaG9ydXNQZXJpb2RTZWNvbmRzOwoJCQkJY29uc3QgY2hvcnVzQW5nbGUgPSBNYXRoLlBJICogMi4wIC8gKGNob3J1c0R1cmF0aW9uICogc3ludGguc2FtcGxlc1BlclNlY29uZCk7CgkJCQljb25zdCBjaG9ydXNSYW5nZSA9IHN5bnRoLnNhbXBsZXNQZXJTZWNvbmQgKiBiZWVwYm94LkNvbmZpZy5jaG9ydXNEZWxheVJhbmdlOwoJCQkJY29uc3QgY2hvcnVzT2Zmc2V0MCA9IHN5bnRoLmNob3J1c0RlbGF5QnVmZmVyU2l6ZSAtIGJlZXBib3guQ29uZmlnLmNob3J1c0RlbGF5T2Zmc2V0c1swXVswXSAqIGNob3J1c1JhbmdlOwoJCQkJY29uc3QgY2hvcnVzT2Zmc2V0MSA9IHN5bnRoLmNob3J1c0RlbGF5QnVmZmVyU2l6ZSAtIGJlZXBib3guQ29uZmlnLmNob3J1c0RlbGF5T2Zmc2V0c1swXVsxXSAqIGNob3J1c1JhbmdlOwoJCQkJY29uc3QgY2hvcnVzT2Zmc2V0MiA9IHN5bnRoLmNob3J1c0RlbGF5QnVmZmVyU2l6ZSAtIGJlZXBib3guQ29uZmlnLmNob3J1c0RlbGF5T2Zmc2V0c1swXVsyXSAqIGNob3J1c1JhbmdlOwoJCQkJY29uc3QgY2hvcnVzT2Zmc2V0MyA9IHN5bnRoLmNob3J1c0RlbGF5QnVmZmVyU2l6ZSAtIGJlZXBib3guQ29uZmlnLmNob3J1c0RlbGF5T2Zmc2V0c1sxXVswXSAqIGNob3J1c1JhbmdlOwoJCQkJY29uc3QgY2hvcnVzT2Zmc2V0NCA9IHN5bnRoLmNob3J1c0RlbGF5QnVmZmVyU2l6ZSAtIGJlZXBib3guQ29uZmlnLmNob3J1c0RlbGF5T2Zmc2V0c1sxXVsxXSAqIGNob3J1c1JhbmdlOwoJCQkJY29uc3QgY2hvcnVzT2Zmc2V0NSA9IHN5bnRoLmNob3J1c0RlbGF5QnVmZmVyU2l6ZSAtIGJlZXBib3guQ29uZmlnLmNob3J1c0RlbGF5T2Zmc2V0c1sxXVsyXSAqIGNob3J1c1JhbmdlOwoJCQkJbGV0IGNob3J1c1BoYXNlID0gaW5zdHJ1bWVudFN0YXRlLmNob3J1c1BoYXNlICUgKE1hdGguUEkgKiAyLjApOwoJCQkJbGV0IGNob3J1c1RhcDBJbmRleCA9IGNob3J1c0RlbGF5UG9zICsgY2hvcnVzT2Zmc2V0MCAtIGNob3J1c1JhbmdlICogTWF0aC5zaW4oY2hvcnVzUGhhc2UgKyBiZWVwYm94LkNvbmZpZy5jaG9ydXNQaGFzZU9mZnNldHNbMF1bMF0pOwoJCQkJbGV0IGNob3J1c1RhcDFJbmRleCA9IGNob3J1c0RlbGF5UG9zICsgY2hvcnVzT2Zmc2V0MSAtIGNob3J1c1JhbmdlICogTWF0aC5zaW4oY2hvcnVzUGhhc2UgKyBiZWVwYm94LkNvbmZpZy5jaG9ydXNQaGFzZU9mZnNldHNbMF1bMV0pOwoJCQkJbGV0IGNob3J1c1RhcDJJbmRleCA9IGNob3J1c0RlbGF5UG9zICsgY2hvcnVzT2Zmc2V0MiAtIGNob3J1c1JhbmdlICogTWF0aC5zaW4oY2hvcnVzUGhhc2UgKyBiZWVwYm94LkNvbmZpZy5jaG9ydXNQaGFzZU9mZnNldHNbMF1bMl0pOwoJCQkJbGV0IGNob3J1c1RhcDNJbmRleCA9IGNob3J1c0RlbGF5UG9zICsgY2hvcnVzT2Zmc2V0MyAtIGNob3J1c1JhbmdlICogTWF0aC5zaW4oY2hvcnVzUGhhc2UgKyBiZWVwYm94LkNvbmZpZy5jaG9ydXNQaGFzZU9mZnNldHNbMV1bMF0pOwoJCQkJbGV0IGNob3J1c1RhcDRJbmRleCA9IGNob3J1c0RlbGF5UG9zICsgY2hvcnVzT2Zmc2V0NCAtIGNob3J1c1JhbmdlICogTWF0aC5zaW4oY2hvcnVzUGhhc2UgKyBiZWVwYm94LkNvbmZpZy5jaG9ydXNQaGFzZU9mZnNldHNbMV1bMV0pOwoJCQkJbGV0IGNob3J1c1RhcDVJbmRleCA9IGNob3J1c0RlbGF5UG9zICsgY2hvcnVzT2Zmc2V0NSAtIGNob3J1c1JhbmdlICogTWF0aC5zaW4oY2hvcnVzUGhhc2UgKyBiZWVwYm94LkNvbmZpZy5jaG9ydXNQaGFzZU9mZnNldHNbMV1bMl0pOwoJCQkJY2hvcnVzUGhhc2UgKz0gY2hvcnVzQW5nbGUgKiBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXAwRW5kID0gY2hvcnVzRGVsYXlQb3MgKyBjaG9ydXNPZmZzZXQwIC0gY2hvcnVzUmFuZ2UgKiBNYXRoLnNpbihjaG9ydXNQaGFzZSArIGJlZXBib3guQ29uZmlnLmNob3J1c1BoYXNlT2Zmc2V0c1swXVswXSkgKyBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXAxRW5kID0gY2hvcnVzRGVsYXlQb3MgKyBjaG9ydXNPZmZzZXQxIC0gY2hvcnVzUmFuZ2UgKiBNYXRoLnNpbihjaG9ydXNQaGFzZSArIGJlZXBib3guQ29uZmlnLmNob3J1c1BoYXNlT2Zmc2V0c1swXVsxXSkgKyBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXAyRW5kID0gY2hvcnVzRGVsYXlQb3MgKyBjaG9ydXNPZmZzZXQyIC0gY2hvcnVzUmFuZ2UgKiBNYXRoLnNpbihjaG9ydXNQaGFzZSArIGJlZXBib3guQ29uZmlnLmNob3J1c1BoYXNlT2Zmc2V0c1swXVsyXSkgKyBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXAzRW5kID0gY2hvcnVzRGVsYXlQb3MgKyBjaG9ydXNPZmZzZXQzIC0gY2hvcnVzUmFuZ2UgKiBNYXRoLnNpbihjaG9ydXNQaGFzZSArIGJlZXBib3guQ29uZmlnLmNob3J1c1BoYXNlT2Zmc2V0c1sxXVswXSkgKyBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXA0RW5kID0gY2hvcnVzRGVsYXlQb3MgKyBjaG9ydXNPZmZzZXQ0IC0gY2hvcnVzUmFuZ2UgKiBNYXRoLnNpbihjaG9ydXNQaGFzZSArIGJlZXBib3guQ29uZmlnLmNob3J1c1BoYXNlT2Zmc2V0c1sxXVsxXSkgKyBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXA1RW5kID0gY2hvcnVzRGVsYXlQb3MgKyBjaG9ydXNPZmZzZXQ1IC0gY2hvcnVzUmFuZ2UgKiBNYXRoLnNpbihjaG9ydXNQaGFzZSArIGJlZXBib3guQ29uZmlnLmNob3J1c1BoYXNlT2Zmc2V0c1sxXVsyXSkgKyBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXAwRGVsdGEgPSAoY2hvcnVzVGFwMEVuZCAtIGNob3J1c1RhcDBJbmRleCkgLyBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXAxRGVsdGEgPSAoY2hvcnVzVGFwMUVuZCAtIGNob3J1c1RhcDFJbmRleCkgLyBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXAyRGVsdGEgPSAoY2hvcnVzVGFwMkVuZCAtIGNob3J1c1RhcDJJbmRleCkgLyBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXAzRGVsdGEgPSAoY2hvcnVzVGFwM0VuZCAtIGNob3J1c1RhcDNJbmRleCkgLyBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXA0RGVsdGEgPSAoY2hvcnVzVGFwNEVuZCAtIGNob3J1c1RhcDRJbmRleCkgLyBydW5MZW5ndGg7CgkJCQljb25zdCBjaG9ydXNUYXA1RGVsdGEgPSAoY2hvcnVzVGFwNUVuZCAtIGNob3J1c1RhcDVJbmRleCkgLyBydW5MZW5ndGg7YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1c2VzRWNobykgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCgkJCQlsZXQgZWNob011bHQgPSAraW5zdHJ1bWVudFN0YXRlLmVjaG9NdWx0U3RhcnQ7CgkJCQljb25zdCBlY2hvTXVsdERlbHRhID0gK2luc3RydW1lbnRTdGF0ZS5lY2hvTXVsdERlbHRhOwoJCQkJCgkJCQljb25zdCBlY2hvRGVsYXlMaW5lTCA9IGluc3RydW1lbnRTdGF0ZS5lY2hvRGVsYXlMaW5lTDsKCQkJCWNvbnN0IGVjaG9EZWxheUxpbmVSID0gaW5zdHJ1bWVudFN0YXRlLmVjaG9EZWxheUxpbmVSOwoJCQkJY29uc3QgZWNob01hc2sgPSAoZWNob0RlbGF5TGluZUwubGVuZ3RoIC0gMSkgPj4+IDA7CgkJCQlpbnN0cnVtZW50U3RhdGUuZWNob0RlbGF5TGluZURpcnR5ID0gdHJ1ZTsKCQkJCQoJCQkJbGV0IGVjaG9EZWxheVBvcyA9IGluc3RydW1lbnRTdGF0ZS5lY2hvRGVsYXlQb3MgJiBlY2hvTWFzazsKCQkJCWNvbnN0IGVjaG9EZWxheU9mZnNldFN0YXJ0ID0gKGVjaG9EZWxheUxpbmVMLmxlbmd0aCAtIGluc3RydW1lbnRTdGF0ZS5lY2hvRGVsYXlPZmZzZXRTdGFydCkgJiBlY2hvTWFzazsKCQkJCWNvbnN0IGVjaG9EZWxheU9mZnNldEVuZCAgID0gKGVjaG9EZWxheUxpbmVMLmxlbmd0aCAtIGluc3RydW1lbnRTdGF0ZS5lY2hvRGVsYXlPZmZzZXRFbmQpICYgZWNob01hc2s7CgkJCQlsZXQgZWNob0RlbGF5T2Zmc2V0UmF0aW8gPSAraW5zdHJ1bWVudFN0YXRlLmVjaG9EZWxheU9mZnNldFJhdGlvOwoJCQkJY29uc3QgZWNob0RlbGF5T2Zmc2V0UmF0aW9EZWx0YSA9ICtpbnN0cnVtZW50U3RhdGUuZWNob0RlbGF5T2Zmc2V0UmF0aW9EZWx0YTsKCQkJCQoJCQkJY29uc3QgZWNob1NoZWxmQTEgPSAraW5zdHJ1bWVudFN0YXRlLmVjaG9TaGVsZkExOwoJCQkJY29uc3QgZWNob1NoZWxmQjAgPSAraW5zdHJ1bWVudFN0YXRlLmVjaG9TaGVsZkIwOwoJCQkJY29uc3QgZWNob1NoZWxmQjEgPSAraW5zdHJ1bWVudFN0YXRlLmVjaG9TaGVsZkIxOwoJCQkJbGV0IGVjaG9TaGVsZlNhbXBsZUwgPSAraW5zdHJ1bWVudFN0YXRlLmVjaG9TaGVsZlNhbXBsZUw7CgkJCQlsZXQgZWNob1NoZWxmU2FtcGxlUiA9ICtpbnN0cnVtZW50U3RhdGUuZWNob1NoZWxmU2FtcGxlUjsKCQkJCWxldCBlY2hvU2hlbGZQcmV2SW5wdXRMID0gK2luc3RydW1lbnRTdGF0ZS5lY2hvU2hlbGZQcmV2SW5wdXRMOwoJCQkJbGV0IGVjaG9TaGVsZlByZXZJbnB1dFIgPSAraW5zdHJ1bWVudFN0YXRlLmVjaG9TaGVsZlByZXZJbnB1dFI7YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1c2VzUmV2ZXJiKSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkKCQkJCWNvbnN0IHJldmVyYk1hc2sgPSBiZWVwYm94LkNvbmZpZy5yZXZlcmJEZWxheUJ1ZmZlck1hc2sgPj4+IDA7IC8vVE9ETzogRHluYW1pYyByZXZlcmIgYnVmZmVyIHNpemUuCgkJCQljb25zdCByZXZlcmJEZWxheUxpbmUgPSBpbnN0cnVtZW50U3RhdGUucmV2ZXJiRGVsYXlMaW5lOwoJCQkJaW5zdHJ1bWVudFN0YXRlLnJldmVyYkRlbGF5TGluZURpcnR5ID0gdHJ1ZTsKCQkJCWxldCByZXZlcmJEZWxheVBvcyA9IGluc3RydW1lbnRTdGF0ZS5yZXZlcmJEZWxheVBvcyAmIHJldmVyYk1hc2s7CgkJCQkKCQkJCWxldCByZXZlcmIgPSAraW5zdHJ1bWVudFN0YXRlLnJldmVyYk11bHRTdGFydDsKCQkJCWNvbnN0IHJldmVyYkRlbHRhID0gK2luc3RydW1lbnRTdGF0ZS5yZXZlcmJNdWx0RGVsdGE7CgkJCQkKCQkJCWNvbnN0IHJldmVyYlNoZWxmQTEgPSAraW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmQTE7CgkJCQljb25zdCByZXZlcmJTaGVsZkIwID0gK2luc3RydW1lbnRTdGF0ZS5yZXZlcmJTaGVsZkIwOwoJCQkJY29uc3QgcmV2ZXJiU2hlbGZCMSA9ICtpbnN0cnVtZW50U3RhdGUucmV2ZXJiU2hlbGZCMTsKCQkJCWxldCByZXZlcmJTaGVsZlNhbXBsZTAgPSAraW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmU2FtcGxlMDsKCQkJCWxldCByZXZlcmJTaGVsZlNhbXBsZTEgPSAraW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmU2FtcGxlMTsKCQkJCWxldCByZXZlcmJTaGVsZlNhbXBsZTIgPSAraW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmU2FtcGxlMjsKCQkJCWxldCByZXZlcmJTaGVsZlNhbXBsZTMgPSAraW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmU2FtcGxlMzsKCQkJCWxldCByZXZlcmJTaGVsZlByZXZJbnB1dDAgPSAraW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmUHJldklucHV0MDsKCQkJCWxldCByZXZlcmJTaGVsZlByZXZJbnB1dDEgPSAraW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmUHJldklucHV0MTsKCQkJCWxldCByZXZlcmJTaGVsZlByZXZJbnB1dDIgPSAraW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmUHJldklucHV0MjsKCQkJCWxldCByZXZlcmJTaGVsZlByZXZJbnB1dDMgPSAraW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmUHJldklucHV0MztgOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkKCQkJCWNvbnN0IHN0b3BJbmRleCA9IGJ1ZmZlckluZGV4ICsgcnVuTGVuZ3RoOwoJCQkJZm9yIChsZXQgc2FtcGxlSW5kZXggPSBidWZmZXJJbmRleDsgc2FtcGxlSW5kZXggPCBzdG9wSW5kZXg7IHNhbXBsZUluZGV4KyspIHsKCQkJCQlsZXQgc2FtcGxlID0gdGVtcE1vbm9JbnN0cnVtZW50U2FtcGxlQnVmZmVyW3NhbXBsZUluZGV4XTsKCQkJCQl0ZW1wTW9ub0luc3RydW1lbnRTYW1wbGVCdWZmZXJbc2FtcGxlSW5kZXhdID0gMC4wO2A7CiAgICAgICAgICAgICAgICBpZiAodXNlc0Rpc3RvcnRpb24pIHsKICAgICAgICAgICAgICAgICAgICBlZmZlY3RzU291cmNlICs9IGAKCQkJCQkKCQkJCQljb25zdCBkaXN0b3J0aW9uUmV2ZXJzZSA9IDEuMCAtIGRpc3RvcnRpb247CgkJCQkJY29uc3QgZGlzdG9ydGlvbk5leHRJbnB1dCA9IHNhbXBsZSAqIGRpc3RvcnRpb25Ecml2ZTsKCQkJCQlzYW1wbGUgPSBkaXN0b3J0aW9uTmV4dE91dHB1dDsKCQkJCQlkaXN0b3J0aW9uTmV4dE91dHB1dCA9IGRpc3RvcnRpb25OZXh0SW5wdXQgLyAoZGlzdG9ydGlvblJldmVyc2UgKiBNYXRoLmFicyhkaXN0b3J0aW9uTmV4dElucHV0KSArIGRpc3RvcnRpb24pOwoJCQkJCWRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQxID0gZGlzdG9ydGlvbkZyYWN0aW9uYWxEZWxheUcxICogZGlzdG9ydGlvbk5leHRJbnB1dCArIGRpc3RvcnRpb25QcmV2SW5wdXQgLSBkaXN0b3J0aW9uRnJhY3Rpb25hbERlbGF5RzEgKiBkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MTsKCQkJCQlkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MiA9IGRpc3RvcnRpb25GcmFjdGlvbmFsRGVsYXlHMiAqIGRpc3RvcnRpb25OZXh0SW5wdXQgKyBkaXN0b3J0aW9uUHJldklucHV0IC0gZGlzdG9ydGlvbkZyYWN0aW9uYWxEZWxheUcyICogZGlzdG9ydGlvbkZyYWN0aW9uYWxJbnB1dDI7CgkJCQkJZGlzdG9ydGlvbkZyYWN0aW9uYWxJbnB1dDMgPSBkaXN0b3J0aW9uRnJhY3Rpb25hbERlbGF5RzMgKiBkaXN0b3J0aW9uTmV4dElucHV0ICsgZGlzdG9ydGlvblByZXZJbnB1dCAtIGRpc3RvcnRpb25GcmFjdGlvbmFsRGVsYXlHMyAqIGRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQzOwoJCQkJCWNvbnN0IGRpc3RvcnRpb25PdXRwdXQxID0gZGlzdG9ydGlvbkZyYWN0aW9uYWxJbnB1dDEgLyAoZGlzdG9ydGlvblJldmVyc2UgKiBNYXRoLmFicyhkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MSkgKyBkaXN0b3J0aW9uKTsKCQkJCQljb25zdCBkaXN0b3J0aW9uT3V0cHV0MiA9IGRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQyIC8gKGRpc3RvcnRpb25SZXZlcnNlICogTWF0aC5hYnMoZGlzdG9ydGlvbkZyYWN0aW9uYWxJbnB1dDIpICsgZGlzdG9ydGlvbik7CgkJCQkJY29uc3QgZGlzdG9ydGlvbk91dHB1dDMgPSBkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MyAvIChkaXN0b3J0aW9uUmV2ZXJzZSAqIE1hdGguYWJzKGRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQzKSArIGRpc3RvcnRpb24pOwoJCQkJCWRpc3RvcnRpb25OZXh0T3V0cHV0ICs9IGRpc3RvcnRpb25PdXRwdXQxICogZGlzdG9ydGlvbk5leHRPdXRwdXRXZWlnaHQxICsgZGlzdG9ydGlvbk91dHB1dDIgKiBkaXN0b3J0aW9uTmV4dE91dHB1dFdlaWdodDIgKyBkaXN0b3J0aW9uT3V0cHV0MyAqIGRpc3RvcnRpb25OZXh0T3V0cHV0V2VpZ2h0MzsKCQkJCQlzYW1wbGUgKz0gZGlzdG9ydGlvbk91dHB1dDEgKiBkaXN0b3J0aW9uUHJldk91dHB1dFdlaWdodDEgKyBkaXN0b3J0aW9uT3V0cHV0MiAqIGRpc3RvcnRpb25QcmV2T3V0cHV0V2VpZ2h0MiArIGRpc3RvcnRpb25PdXRwdXQzICogZGlzdG9ydGlvblByZXZPdXRwdXRXZWlnaHQzOwoJCQkJCXNhbXBsZSAqPSBkaXN0b3J0aW9uT3ZlcnNhbXBsZUNvbXBlbnNhdGlvbjsKCQkJCQlkaXN0b3J0aW9uUHJldklucHV0ID0gZGlzdG9ydGlvbk5leHRJbnB1dDsKCQkJCQlkaXN0b3J0aW9uICs9IGRpc3RvcnRpb25EZWx0YTsKCQkJCQlkaXN0b3J0aW9uRHJpdmUgKz0gZGlzdG9ydGlvbkRyaXZlRGVsdGE7YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1c2VzQml0Y3J1c2hlcikgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCQoJCQkJCWJpdGNydXNoZXJQaGFzZSArPSBiaXRjcnVzaGVyUGhhc2VEZWx0YTsKCQkJCQlpZiAoYml0Y3J1c2hlclBoYXNlIDwgMS4wKSB7CgkJCQkJCWJpdGNydXNoZXJQcmV2SW5wdXQgPSBzYW1wbGU7CgkJCQkJCXNhbXBsZSA9IGJpdGNydXNoZXJDdXJyZW50T3V0cHV0OwoJCQkJCX0gZWxzZSB7CgkJCQkJCWJpdGNydXNoZXJQaGFzZSA9IGJpdGNydXNoZXJQaGFzZSAlIDEuMDsKCQkJCQkJY29uc3QgcmF0aW8gPSBiaXRjcnVzaGVyUGhhc2UgLyBiaXRjcnVzaGVyUGhhc2VEZWx0YTsKCQkJCQkJCgkJCQkJCWNvbnN0IGxlcnBlZElucHV0ID0gc2FtcGxlICsgKGJpdGNydXNoZXJQcmV2SW5wdXQgLSBzYW1wbGUpICogcmF0aW87CgkJCQkJCWJpdGNydXNoZXJQcmV2SW5wdXQgPSBzYW1wbGU7CgkJCQkJCQoJCQkJCQljb25zdCBiaXRjcnVzaGVyV3JhcExldmVsID0gYml0Y3J1c2hlckZvbGRMZXZlbCAqIDQuMDsKCQkJCQkJY29uc3Qgd3JhcHBlZFNhbXBsZSA9ICgoKGxlcnBlZElucHV0ICsgYml0Y3J1c2hlckZvbGRMZXZlbCkgJSBiaXRjcnVzaGVyV3JhcExldmVsKSArIGJpdGNydXNoZXJXcmFwTGV2ZWwpICUgYml0Y3J1c2hlcldyYXBMZXZlbDsKCQkJCQkJY29uc3QgZm9sZGVkU2FtcGxlID0gYml0Y3J1c2hlckZvbGRMZXZlbCAtIE1hdGguYWJzKGJpdGNydXNoZXJGb2xkTGV2ZWwgKiAyLjAgLSB3cmFwcGVkU2FtcGxlKTsKCQkJCQkJY29uc3Qgc2NhbGVkU2FtcGxlID0gZm9sZGVkU2FtcGxlIC8gYml0Y3J1c2hlclNjYWxlOwoJCQkJCQljb25zdCBvbGRWYWx1ZSA9IGJpdGNydXNoZXJDdXJyZW50T3V0cHV0OwoJCQkJCQljb25zdCBuZXdWYWx1ZSA9ICgoKHNjYWxlZFNhbXBsZSA+IDAgPyBzY2FsZWRTYW1wbGUgKyAxIDogc2NhbGVkU2FtcGxlKXwwKS0uNSkgKiBiaXRjcnVzaGVyU2NhbGU7CgkJCQkJCQoJCQkJCQlzYW1wbGUgPSBvbGRWYWx1ZSArIChuZXdWYWx1ZSAtIG9sZFZhbHVlKSAqIHJhdGlvOwoJCQkJCQliaXRjcnVzaGVyQ3VycmVudE91dHB1dCA9IG5ld1ZhbHVlOwoJCQkJCX0KCQkJCQliaXRjcnVzaGVyUGhhc2VEZWx0YSAqPSBiaXRjcnVzaGVyUGhhc2VEZWx0YVNjYWxlOwoJCQkJCWJpdGNydXNoZXJTY2FsZSAqPSBiaXRjcnVzaGVyU2NhbGVTY2FsZTsKCQkJCQliaXRjcnVzaGVyRm9sZExldmVsICo9IGJpdGNydXNoZXJGb2xkTGV2ZWxTY2FsZTtgOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHVzZXNFcUZpbHRlcikgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCQoJCQkJCWNvbnN0IGlucHV0U2FtcGxlID0gc2FtcGxlOwoJCQkJCXNhbXBsZSA9IGFwcGx5RmlsdGVycyhpbnB1dFNhbXBsZSwgaW5pdGlhbEZpbHRlcklucHV0MSwgaW5pdGlhbEZpbHRlcklucHV0MiwgZmlsdGVyQ291bnQsIGZpbHRlcnMpOwoJCQkJCWluaXRpYWxGaWx0ZXJJbnB1dDIgPSBpbml0aWFsRmlsdGVySW5wdXQxOwoJCQkJCWluaXRpYWxGaWx0ZXJJbnB1dDEgPSBpbnB1dFNhbXBsZTtgOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkJCgkJCQkJc2FtcGxlICo9IGVxRmlsdGVyVm9sdW1lOwoJCQkJCWVxRmlsdGVyVm9sdW1lICs9IGVxRmlsdGVyVm9sdW1lRGVsdGE7YDsKICAgICAgICAgICAgICAgIGlmICh1c2VzUGFubmluZykgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCQoJCQkJCXBhbm5pbmdEZWxheUxpbmVbcGFubmluZ0RlbGF5UG9zXSA9IHNhbXBsZTsKCQkJCQljb25zdCBwYW5uaW5nUmF0aW9MICA9IHBhbm5pbmdPZmZzZXRMICUgMTsKCQkJCQljb25zdCBwYW5uaW5nUmF0aW9SICA9IHBhbm5pbmdPZmZzZXRSICUgMTsKCQkJCQljb25zdCBwYW5uaW5nVGFwTEEgICA9IHBhbm5pbmdEZWxheUxpbmVbKHBhbm5pbmdPZmZzZXRMKSAmIHBhbm5pbmdNYXNrXTsKCQkJCQljb25zdCBwYW5uaW5nVGFwTEIgICA9IHBhbm5pbmdEZWxheUxpbmVbKHBhbm5pbmdPZmZzZXRMICsgMSkgJiBwYW5uaW5nTWFza107CgkJCQkJY29uc3QgcGFubmluZ1RhcFJBICAgPSBwYW5uaW5nRGVsYXlMaW5lWyhwYW5uaW5nT2Zmc2V0UikgJiBwYW5uaW5nTWFza107CgkJCQkJY29uc3QgcGFubmluZ1RhcFJCICAgPSBwYW5uaW5nRGVsYXlMaW5lWyhwYW5uaW5nT2Zmc2V0UiArIDEpICYgcGFubmluZ01hc2tdOwoJCQkJCWNvbnN0IHBhbm5pbmdUYXBMICAgID0gcGFubmluZ1RhcExBICsgKHBhbm5pbmdUYXBMQiAtIHBhbm5pbmdUYXBMQSkgKiBwYW5uaW5nUmF0aW9MOwoJCQkJCWNvbnN0IHBhbm5pbmdUYXBSICAgID0gcGFubmluZ1RhcFJBICsgKHBhbm5pbmdUYXBSQiAtIHBhbm5pbmdUYXBSQSkgKiBwYW5uaW5nUmF0aW9SOwoJCQkJCWxldCBzYW1wbGVMID0gcGFubmluZ1RhcEwgKiBwYW5uaW5nVm9sdW1lTDsKCQkJCQlsZXQgc2FtcGxlUiA9IHBhbm5pbmdUYXBSICogcGFubmluZ1ZvbHVtZVI7CgkJCQkJcGFubmluZ0RlbGF5UG9zID0gKHBhbm5pbmdEZWxheVBvcyArIDEpICYgcGFubmluZ01hc2s7CgkJCQkJcGFubmluZ1ZvbHVtZUwgKz0gcGFubmluZ1ZvbHVtZURlbHRhTDsKCQkJCQlwYW5uaW5nVm9sdW1lUiArPSBwYW5uaW5nVm9sdW1lRGVsdGFSOwoJCQkJCXBhbm5pbmdPZmZzZXRMICs9IHBhbm5pbmdPZmZzZXREZWx0YUw7CgkJCQkJcGFubmluZ09mZnNldFIgKz0gcGFubmluZ09mZnNldERlbHRhUjtgOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkJCgkJCQkJbGV0IHNhbXBsZUwgPSBzYW1wbGU7CgkJCQkJbGV0IHNhbXBsZVIgPSBzYW1wbGU7YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1c2VzQ2hvcnVzKSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkJCgkJCQkJY29uc3QgY2hvcnVzVGFwMFJhdGlvID0gY2hvcnVzVGFwMEluZGV4ICUgMTsKCQkJCQljb25zdCBjaG9ydXNUYXAxUmF0aW8gPSBjaG9ydXNUYXAxSW5kZXggJSAxOwoJCQkJCWNvbnN0IGNob3J1c1RhcDJSYXRpbyA9IGNob3J1c1RhcDJJbmRleCAlIDE7CgkJCQkJY29uc3QgY2hvcnVzVGFwM1JhdGlvID0gY2hvcnVzVGFwM0luZGV4ICUgMTsKCQkJCQljb25zdCBjaG9ydXNUYXA0UmF0aW8gPSBjaG9ydXNUYXA0SW5kZXggJSAxOwoJCQkJCWNvbnN0IGNob3J1c1RhcDVSYXRpbyA9IGNob3J1c1RhcDVJbmRleCAlIDE7CgkJCQkJY29uc3QgY2hvcnVzVGFwMEEgPSBjaG9ydXNEZWxheUxpbmVMWyhjaG9ydXNUYXAwSW5kZXgpICYgY2hvcnVzTWFza107CgkJCQkJY29uc3QgY2hvcnVzVGFwMEIgPSBjaG9ydXNEZWxheUxpbmVMWyhjaG9ydXNUYXAwSW5kZXggKyAxKSAmIGNob3J1c01hc2tdOwoJCQkJCWNvbnN0IGNob3J1c1RhcDFBID0gY2hvcnVzRGVsYXlMaW5lTFsoY2hvcnVzVGFwMUluZGV4KSAmIGNob3J1c01hc2tdOwoJCQkJCWNvbnN0IGNob3J1c1RhcDFCID0gY2hvcnVzRGVsYXlMaW5lTFsoY2hvcnVzVGFwMUluZGV4ICsgMSkgJiBjaG9ydXNNYXNrXTsKCQkJCQljb25zdCBjaG9ydXNUYXAyQSA9IGNob3J1c0RlbGF5TGluZUxbKGNob3J1c1RhcDJJbmRleCkgJiBjaG9ydXNNYXNrXTsKCQkJCQljb25zdCBjaG9ydXNUYXAyQiA9IGNob3J1c0RlbGF5TGluZUxbKGNob3J1c1RhcDJJbmRleCArIDEpICYgY2hvcnVzTWFza107CgkJCQkJY29uc3QgY2hvcnVzVGFwM0EgPSBjaG9ydXNEZWxheUxpbmVSWyhjaG9ydXNUYXAzSW5kZXgpICYgY2hvcnVzTWFza107CgkJCQkJY29uc3QgY2hvcnVzVGFwM0IgPSBjaG9ydXNEZWxheUxpbmVSWyhjaG9ydXNUYXAzSW5kZXggKyAxKSAmIGNob3J1c01hc2tdOwoJCQkJCWNvbnN0IGNob3J1c1RhcDRBID0gY2hvcnVzRGVsYXlMaW5lUlsoY2hvcnVzVGFwNEluZGV4KSAmIGNob3J1c01hc2tdOwoJCQkJCWNvbnN0IGNob3J1c1RhcDRCID0gY2hvcnVzRGVsYXlMaW5lUlsoY2hvcnVzVGFwNEluZGV4ICsgMSkgJiBjaG9ydXNNYXNrXTsKCQkJCQljb25zdCBjaG9ydXNUYXA1QSA9IGNob3J1c0RlbGF5TGluZVJbKGNob3J1c1RhcDVJbmRleCkgJiBjaG9ydXNNYXNrXTsKCQkJCQljb25zdCBjaG9ydXNUYXA1QiA9IGNob3J1c0RlbGF5TGluZVJbKGNob3J1c1RhcDVJbmRleCArIDEpICYgY2hvcnVzTWFza107CgkJCQkJY29uc3QgY2hvcnVzVGFwMCA9IGNob3J1c1RhcDBBICsgKGNob3J1c1RhcDBCIC0gY2hvcnVzVGFwMEEpICogY2hvcnVzVGFwMFJhdGlvOwoJCQkJCWNvbnN0IGNob3J1c1RhcDEgPSBjaG9ydXNUYXAxQSArIChjaG9ydXNUYXAxQiAtIGNob3J1c1RhcDFBKSAqIGNob3J1c1RhcDFSYXRpbzsKCQkJCQljb25zdCBjaG9ydXNUYXAyID0gY2hvcnVzVGFwMkEgKyAoY2hvcnVzVGFwMkIgLSBjaG9ydXNUYXAyQSkgKiBjaG9ydXNUYXAyUmF0aW87CgkJCQkJY29uc3QgY2hvcnVzVGFwMyA9IGNob3J1c1RhcDNBICsgKGNob3J1c1RhcDNCIC0gY2hvcnVzVGFwM0EpICogY2hvcnVzVGFwM1JhdGlvOwoJCQkJCWNvbnN0IGNob3J1c1RhcDQgPSBjaG9ydXNUYXA0QSArIChjaG9ydXNUYXA0QiAtIGNob3J1c1RhcDRBKSAqIGNob3J1c1RhcDRSYXRpbzsKCQkJCQljb25zdCBjaG9ydXNUYXA1ID0gY2hvcnVzVGFwNUEgKyAoY2hvcnVzVGFwNUIgLSBjaG9ydXNUYXA1QSkgKiBjaG9ydXNUYXA1UmF0aW87CgkJCQkJY2hvcnVzRGVsYXlMaW5lTFtjaG9ydXNEZWxheVBvc10gPSBzYW1wbGVMICogZGVsYXlJbnB1dE11bHQ7CgkJCQkJY2hvcnVzRGVsYXlMaW5lUltjaG9ydXNEZWxheVBvc10gPSBzYW1wbGVSICogZGVsYXlJbnB1dE11bHQ7CgkJCQkJc2FtcGxlTCA9IGNob3J1c0NvbWJpbmVkTXVsdCAqIChzYW1wbGVMICsgY2hvcnVzVm9pY2VNdWx0ICogKGNob3J1c1RhcDEgLSBjaG9ydXNUYXAwIC0gY2hvcnVzVGFwMikpOwoJCQkJCXNhbXBsZVIgPSBjaG9ydXNDb21iaW5lZE11bHQgKiAoc2FtcGxlUiArIGNob3J1c1ZvaWNlTXVsdCAqIChjaG9ydXNUYXA0IC0gY2hvcnVzVGFwMyAtIGNob3J1c1RhcDUpKTsKCQkJCQljaG9ydXNEZWxheVBvcyA9IChjaG9ydXNEZWxheVBvcyArIDEpICYgY2hvcnVzTWFzazsKCQkJCQljaG9ydXNUYXAwSW5kZXggKz0gY2hvcnVzVGFwMERlbHRhOwoJCQkJCWNob3J1c1RhcDFJbmRleCArPSBjaG9ydXNUYXAxRGVsdGE7CgkJCQkJY2hvcnVzVGFwMkluZGV4ICs9IGNob3J1c1RhcDJEZWx0YTsKCQkJCQljaG9ydXNUYXAzSW5kZXggKz0gY2hvcnVzVGFwM0RlbHRhOwoJCQkJCWNob3J1c1RhcDRJbmRleCArPSBjaG9ydXNUYXA0RGVsdGE7CgkJCQkJY2hvcnVzVGFwNUluZGV4ICs9IGNob3J1c1RhcDVEZWx0YTsKCQkJCQljaG9ydXNWb2ljZU11bHQgKz0gY2hvcnVzVm9pY2VNdWx0RGVsdGE7CgkJCQkJY2hvcnVzQ29tYmluZWRNdWx0ICs9IGNob3J1c0NvbWJpbmVkTXVsdERlbHRhO2A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodXNlc0VjaG8pIHsKICAgICAgICAgICAgICAgICAgICBlZmZlY3RzU291cmNlICs9IGAKCQkJCQkKCQkJCQljb25zdCBlY2hvVGFwU3RhcnRJbmRleCA9IChlY2hvRGVsYXlQb3MgKyBlY2hvRGVsYXlPZmZzZXRTdGFydCkgJiBlY2hvTWFzazsKCQkJCQljb25zdCBlY2hvVGFwRW5kSW5kZXggICA9IChlY2hvRGVsYXlQb3MgKyBlY2hvRGVsYXlPZmZzZXRFbmQgICkgJiBlY2hvTWFzazsKCQkJCQljb25zdCBlY2hvVGFwU3RhcnRMID0gZWNob0RlbGF5TGluZUxbZWNob1RhcFN0YXJ0SW5kZXhdOwoJCQkJCWNvbnN0IGVjaG9UYXBFbmRMICAgPSBlY2hvRGVsYXlMaW5lTFtlY2hvVGFwRW5kSW5kZXhdOwoJCQkJCWNvbnN0IGVjaG9UYXBTdGFydFIgPSBlY2hvRGVsYXlMaW5lUltlY2hvVGFwU3RhcnRJbmRleF07CgkJCQkJY29uc3QgZWNob1RhcEVuZFIgICA9IGVjaG9EZWxheUxpbmVSW2VjaG9UYXBFbmRJbmRleF07CgkJCQkJY29uc3QgZWNob1RhcEwgPSAoZWNob1RhcFN0YXJ0TCArIChlY2hvVGFwRW5kTCAtIGVjaG9UYXBTdGFydEwpICogZWNob0RlbGF5T2Zmc2V0UmF0aW8pICogZWNob011bHQ7CgkJCQkJY29uc3QgZWNob1RhcFIgPSAoZWNob1RhcFN0YXJ0UiArIChlY2hvVGFwRW5kUiAtIGVjaG9UYXBTdGFydFIpICogZWNob0RlbGF5T2Zmc2V0UmF0aW8pICogZWNob011bHQ7CgkJCQkJCgkJCQkJZWNob1NoZWxmU2FtcGxlTCA9IGVjaG9TaGVsZkIwICogZWNob1RhcEwgKyBlY2hvU2hlbGZCMSAqIGVjaG9TaGVsZlByZXZJbnB1dEwgLSBlY2hvU2hlbGZBMSAqIGVjaG9TaGVsZlNhbXBsZUw7CgkJCQkJZWNob1NoZWxmU2FtcGxlUiA9IGVjaG9TaGVsZkIwICogZWNob1RhcFIgKyBlY2hvU2hlbGZCMSAqIGVjaG9TaGVsZlByZXZJbnB1dFIgLSBlY2hvU2hlbGZBMSAqIGVjaG9TaGVsZlNhbXBsZVI7CgkJCQkJZWNob1NoZWxmUHJldklucHV0TCA9IGVjaG9UYXBMOwoJCQkJCWVjaG9TaGVsZlByZXZJbnB1dFIgPSBlY2hvVGFwUjsKCQkJCQlzYW1wbGVMICs9IGVjaG9TaGVsZlNhbXBsZUw7CgkJCQkJc2FtcGxlUiArPSBlY2hvU2hlbGZTYW1wbGVSOwoJCQkJCQoJCQkJCWVjaG9EZWxheUxpbmVMW2VjaG9EZWxheVBvc10gPSBzYW1wbGVMICogZGVsYXlJbnB1dE11bHQ7CgkJCQkJZWNob0RlbGF5TGluZVJbZWNob0RlbGF5UG9zXSA9IHNhbXBsZVIgKiBkZWxheUlucHV0TXVsdDsKCQkJCQllY2hvRGVsYXlQb3MgPSAoZWNob0RlbGF5UG9zICsgMSkgJiBlY2hvTWFzazsKCQkJCQllY2hvRGVsYXlPZmZzZXRSYXRpbyArPSBlY2hvRGVsYXlPZmZzZXRSYXRpb0RlbHRhOwoJCQkJCWVjaG9NdWx0ICs9IGVjaG9NdWx0RGVsdGE7YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1c2VzUmV2ZXJiKSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkJCgkJCQkJLy8gUmV2ZXJiLCBpbXBsZW1lbnRlZCB1c2luZyBhIGZlZWRiYWNrIGRlbGF5IG5ldHdvcmsgd2l0aCBhIEhhZGFtYXJkIG1hdHJpeCBhbmQgbG93cGFzcyBmaWx0ZXJzLgoJCQkJCS8vIGdvb2QgcmF0aW9zOiAgICAwLjU1NTIzNSArIDAuNjE4MDMzICsgMC44MTggKyAgIDEuMCA9IDIuOTkxMjY4CgkJCQkJLy8gRGVsYXkgbGVuZ3RoczogIDMwNDEgICAgICsgMzM4NSAgICAgKyA0NDgxICArICA1NDc3ID0gMTYzODQgPSAyXjE0CgkJCQkJLy8gQnVmZmVyIG9mZnNldHM6IDMwNDEgICAgLT4gNjQyNiAgIC0+IDEwOTA3IC0+IDE2Mzg0CgkJCQkJY29uc3QgcmV2ZXJiRGVsYXlQb3MxID0gKHJldmVyYkRlbGF5UG9zICsgIDMwNDEpICYgcmV2ZXJiTWFzazsKCQkJCQljb25zdCByZXZlcmJEZWxheVBvczIgPSAocmV2ZXJiRGVsYXlQb3MgKyAgNjQyNikgJiByZXZlcmJNYXNrOwoJCQkJCWNvbnN0IHJldmVyYkRlbGF5UG9zMyA9IChyZXZlcmJEZWxheVBvcyArIDEwOTA3KSAmIHJldmVyYk1hc2s7CgkJCQkJY29uc3QgcmV2ZXJiU2FtcGxlMCA9IChyZXZlcmJEZWxheUxpbmVbcmV2ZXJiRGVsYXlQb3NdKTsKCQkJCQljb25zdCByZXZlcmJTYW1wbGUxID0gcmV2ZXJiRGVsYXlMaW5lW3JldmVyYkRlbGF5UG9zMV07CgkJCQkJY29uc3QgcmV2ZXJiU2FtcGxlMiA9IHJldmVyYkRlbGF5TGluZVtyZXZlcmJEZWxheVBvczJdOwoJCQkJCWNvbnN0IHJldmVyYlNhbXBsZTMgPSByZXZlcmJEZWxheUxpbmVbcmV2ZXJiRGVsYXlQb3MzXTsKCQkJCQljb25zdCByZXZlcmJUZW1wMCA9IC0ocmV2ZXJiU2FtcGxlMCArIHNhbXBsZUwpICsgcmV2ZXJiU2FtcGxlMTsKCQkJCQljb25zdCByZXZlcmJUZW1wMSA9IC0ocmV2ZXJiU2FtcGxlMCArIHNhbXBsZVIpIC0gcmV2ZXJiU2FtcGxlMTsKCQkJCQljb25zdCByZXZlcmJUZW1wMiA9IC1yZXZlcmJTYW1wbGUyICsgcmV2ZXJiU2FtcGxlMzsKCQkJCQljb25zdCByZXZlcmJUZW1wMyA9IC1yZXZlcmJTYW1wbGUyIC0gcmV2ZXJiU2FtcGxlMzsKCQkJCQljb25zdCByZXZlcmJTaGVsZklucHV0MCA9IChyZXZlcmJUZW1wMCArIHJldmVyYlRlbXAyKSAqIHJldmVyYjsKCQkJCQljb25zdCByZXZlcmJTaGVsZklucHV0MSA9IChyZXZlcmJUZW1wMSArIHJldmVyYlRlbXAzKSAqIHJldmVyYjsKCQkJCQljb25zdCByZXZlcmJTaGVsZklucHV0MiA9IChyZXZlcmJUZW1wMCAtIHJldmVyYlRlbXAyKSAqIHJldmVyYjsKCQkJCQljb25zdCByZXZlcmJTaGVsZklucHV0MyA9IChyZXZlcmJUZW1wMSAtIHJldmVyYlRlbXAzKSAqIHJldmVyYjsKCQkJCQlyZXZlcmJTaGVsZlNhbXBsZTAgPSByZXZlcmJTaGVsZkIwICogcmV2ZXJiU2hlbGZJbnB1dDAgKyByZXZlcmJTaGVsZkIxICogcmV2ZXJiU2hlbGZQcmV2SW5wdXQwIC0gcmV2ZXJiU2hlbGZBMSAqIHJldmVyYlNoZWxmU2FtcGxlMDsKCQkJCQlyZXZlcmJTaGVsZlNhbXBsZTEgPSByZXZlcmJTaGVsZkIwICogcmV2ZXJiU2hlbGZJbnB1dDEgKyByZXZlcmJTaGVsZkIxICogcmV2ZXJiU2hlbGZQcmV2SW5wdXQxIC0gcmV2ZXJiU2hlbGZBMSAqIHJldmVyYlNoZWxmU2FtcGxlMTsKCQkJCQlyZXZlcmJTaGVsZlNhbXBsZTIgPSByZXZlcmJTaGVsZkIwICogcmV2ZXJiU2hlbGZJbnB1dDIgKyByZXZlcmJTaGVsZkIxICogcmV2ZXJiU2hlbGZQcmV2SW5wdXQyIC0gcmV2ZXJiU2hlbGZBMSAqIHJldmVyYlNoZWxmU2FtcGxlMjsKCQkJCQlyZXZlcmJTaGVsZlNhbXBsZTMgPSByZXZlcmJTaGVsZkIwICogcmV2ZXJiU2hlbGZJbnB1dDMgKyByZXZlcmJTaGVsZkIxICogcmV2ZXJiU2hlbGZQcmV2SW5wdXQzIC0gcmV2ZXJiU2hlbGZBMSAqIHJldmVyYlNoZWxmU2FtcGxlMzsKCQkJCQlyZXZlcmJTaGVsZlByZXZJbnB1dDAgPSByZXZlcmJTaGVsZklucHV0MDsKCQkJCQlyZXZlcmJTaGVsZlByZXZJbnB1dDEgPSByZXZlcmJTaGVsZklucHV0MTsKCQkJCQlyZXZlcmJTaGVsZlByZXZJbnB1dDIgPSByZXZlcmJTaGVsZklucHV0MjsKCQkJCQlyZXZlcmJTaGVsZlByZXZJbnB1dDMgPSByZXZlcmJTaGVsZklucHV0MzsKCQkJCQlyZXZlcmJEZWxheUxpbmVbcmV2ZXJiRGVsYXlQb3MxXSA9IHJldmVyYlNoZWxmU2FtcGxlMCAqIGRlbGF5SW5wdXRNdWx0OwoJCQkJCXJldmVyYkRlbGF5TGluZVtyZXZlcmJEZWxheVBvczJdID0gcmV2ZXJiU2hlbGZTYW1wbGUxICogZGVsYXlJbnB1dE11bHQ7CgkJCQkJcmV2ZXJiRGVsYXlMaW5lW3JldmVyYkRlbGF5UG9zM10gPSByZXZlcmJTaGVsZlNhbXBsZTIgKiBkZWxheUlucHV0TXVsdDsKCQkJCQlyZXZlcmJEZWxheUxpbmVbcmV2ZXJiRGVsYXlQb3MgXSA9IHJldmVyYlNoZWxmU2FtcGxlMyAqIGRlbGF5SW5wdXRNdWx0OwoJCQkJCXJldmVyYkRlbGF5UG9zID0gKHJldmVyYkRlbGF5UG9zICsgMSkgJiByZXZlcmJNYXNrOwoJCQkJCXNhbXBsZUwgKz0gcmV2ZXJiU2FtcGxlMSArIHJldmVyYlNhbXBsZTIgKyByZXZlcmJTYW1wbGUzOwoJCQkJCXNhbXBsZVIgKz0gcmV2ZXJiU2FtcGxlMCArIHJldmVyYlNhbXBsZTIgLSByZXZlcmJTYW1wbGUzOwoJCQkJCXJldmVyYiArPSByZXZlcmJEZWx0YTtgOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkJCgkJCQkJb3V0cHV0RGF0YUxbc2FtcGxlSW5kZXhdICs9IHNhbXBsZUwgKiBtaXhWb2x1bWU7CgkJCQkJb3V0cHV0RGF0YVJbc2FtcGxlSW5kZXhdICs9IHNhbXBsZVIgKiBtaXhWb2x1bWU7CgkJCQkJbWl4Vm9sdW1lICs9IG1peFZvbHVtZURlbHRhO2A7CiAgICAgICAgICAgICAgICBpZiAodXNlc0RlbGF5cykgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCQoJCQkJCWRlbGF5SW5wdXRNdWx0ICs9IGRlbGF5SW5wdXRNdWx0RGVsdGE7YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJfQoJCQkJCgkJCQkvLyBBdm9pZCBwZXJzaXN0ZW50IGRlbm9ybWFsIG9yIE5hTiB2YWx1ZXMgaW4gdGhlIGRlbGF5IGJ1ZmZlcnMgYW5kIGZpbHRlciBoaXN0b3J5LgoJCQkJY29uc3QgZXBzaWxvbiA9ICgxLjBlLTI0KTtgOwogICAgICAgICAgICAgICAgaWYgKHVzZXNEaXN0b3J0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkKCQkJCWlmICghTnVtYmVyLmlzRmluaXRlKGRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQxKSB8fCBNYXRoLmFicyhkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MSkgPCBlcHNpbG9uKSBkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MSA9IDAuMDsKCQkJCWlmICghTnVtYmVyLmlzRmluaXRlKGRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQyKSB8fCBNYXRoLmFicyhkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MikgPCBlcHNpbG9uKSBkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MiA9IDAuMDsKCQkJCWlmICghTnVtYmVyLmlzRmluaXRlKGRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQzKSB8fCBNYXRoLmFicyhkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MykgPCBlcHNpbG9uKSBkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MyA9IDAuMDsKCQkJCWlmICghTnVtYmVyLmlzRmluaXRlKGRpc3RvcnRpb25QcmV2SW5wdXQpIHx8IE1hdGguYWJzKGRpc3RvcnRpb25QcmV2SW5wdXQpIDwgZXBzaWxvbikgZGlzdG9ydGlvblByZXZJbnB1dCA9IDAuMDsKCQkJCWlmICghTnVtYmVyLmlzRmluaXRlKGRpc3RvcnRpb25OZXh0T3V0cHV0KSB8fCBNYXRoLmFicyhkaXN0b3J0aW9uTmV4dE91dHB1dCkgPCBlcHNpbG9uKSBkaXN0b3J0aW9uTmV4dE91dHB1dCA9IDAuMDsKCQkJCQoJCQkJaW5zdHJ1bWVudFN0YXRlLmRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQxID0gZGlzdG9ydGlvbkZyYWN0aW9uYWxJbnB1dDE7CgkJCQlpbnN0cnVtZW50U3RhdGUuZGlzdG9ydGlvbkZyYWN0aW9uYWxJbnB1dDIgPSBkaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MjsKCQkJCWluc3RydW1lbnRTdGF0ZS5kaXN0b3J0aW9uRnJhY3Rpb25hbElucHV0MyA9IGRpc3RvcnRpb25GcmFjdGlvbmFsSW5wdXQzOwoJCQkJaW5zdHJ1bWVudFN0YXRlLmRpc3RvcnRpb25QcmV2SW5wdXQgPSBkaXN0b3J0aW9uUHJldklucHV0OwoJCQkJaW5zdHJ1bWVudFN0YXRlLmRpc3RvcnRpb25OZXh0T3V0cHV0ID0gZGlzdG9ydGlvbk5leHRPdXRwdXQ7YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1c2VzQml0Y3J1c2hlcikgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCQoJCQkJaWYgKE1hdGguYWJzKGJpdGNydXNoZXJQcmV2SW5wdXQpIDwgZXBzaWxvbikgYml0Y3J1c2hlclByZXZJbnB1dCA9IDAuMDsKCQkJCWlmIChNYXRoLmFicyhiaXRjcnVzaGVyQ3VycmVudE91dHB1dCkgPCBlcHNpbG9uKSBiaXRjcnVzaGVyQ3VycmVudE91dHB1dCA9IDAuMDsKCQkJCWluc3RydW1lbnRTdGF0ZS5iaXRjcnVzaGVyUHJldklucHV0ID0gYml0Y3J1c2hlclByZXZJbnB1dDsKCQkJCWluc3RydW1lbnRTdGF0ZS5iaXRjcnVzaGVyQ3VycmVudE91dHB1dCA9IGJpdGNydXNoZXJDdXJyZW50T3V0cHV0OwoJCQkJaW5zdHJ1bWVudFN0YXRlLmJpdGNydXNoZXJQaGFzZSA9IGJpdGNydXNoZXJQaGFzZTtgOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHVzZXNFcUZpbHRlcikgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCQoJCQkJc3ludGguc2FuaXRpemVGaWx0ZXJzKGZpbHRlcnMpOwoJCQkJLy8gVGhlIGZpbHRlciBpbnB1dCBoZXJlIGlzIGRvd25zdHJlYW0gZnJvbSBhbm90aGVyIGZpbHRlciBzbyB3ZQoJCQkJLy8gYmV0dGVyIG1ha2Ugc3VyZSBpdCdzIHNhZmUgdG9vLgoJCQkJaWYgKCEoaW5pdGlhbEZpbHRlcklucHV0MSA8IDEwMCkgfHwgIShpbml0aWFsRmlsdGVySW5wdXQyIDwgMTAwKSkgewoJCQkJCWluaXRpYWxGaWx0ZXJJbnB1dDEgPSAwLjA7CgkJCQkJaW5pdGlhbEZpbHRlcklucHV0MiA9IDAuMDsKCQkJCX0KCQkJCWlmIChNYXRoLmFicyhpbml0aWFsRmlsdGVySW5wdXQxKSA8IGVwc2lsb24pIGluaXRpYWxGaWx0ZXJJbnB1dDEgPSAwLjA7CgkJCQlpZiAoTWF0aC5hYnMoaW5pdGlhbEZpbHRlcklucHV0MikgPCBlcHNpbG9uKSBpbml0aWFsRmlsdGVySW5wdXQyID0gMC4wOwoJCQkJaW5zdHJ1bWVudFN0YXRlLmluaXRpYWxFcUZpbHRlcklucHV0MSA9IGluaXRpYWxGaWx0ZXJJbnB1dDE7CgkJCQlpbnN0cnVtZW50U3RhdGUuaW5pdGlhbEVxRmlsdGVySW5wdXQyID0gaW5pdGlhbEZpbHRlcklucHV0MjtgOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHVzZXNQYW5uaW5nKSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkKCQkJCWJlZXBib3guU3ludGguc2FuaXRpemVEZWxheUxpbmUocGFubmluZ0RlbGF5TGluZSwgcGFubmluZ0RlbGF5UG9zLCBwYW5uaW5nTWFzayk7CgkJCQlpbnN0cnVtZW50U3RhdGUucGFubmluZ0RlbGF5UG9zID0gcGFubmluZ0RlbGF5UG9zO2A7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodXNlc0Nob3J1cykgewogICAgICAgICAgICAgICAgICAgIGVmZmVjdHNTb3VyY2UgKz0gYAoJCQkJCgkJCQliZWVwYm94LlN5bnRoLnNhbml0aXplRGVsYXlMaW5lKGNob3J1c0RlbGF5TGluZUwsIGNob3J1c0RlbGF5UG9zLCBjaG9ydXNNYXNrKTsKCQkJCWJlZXBib3guU3ludGguc2FuaXRpemVEZWxheUxpbmUoY2hvcnVzRGVsYXlMaW5lUiwgY2hvcnVzRGVsYXlQb3MsIGNob3J1c01hc2spOwoJCQkJaW5zdHJ1bWVudFN0YXRlLmNob3J1c1BoYXNlID0gY2hvcnVzUGhhc2U7CgkJCQlpbnN0cnVtZW50U3RhdGUuY2hvcnVzRGVsYXlQb3MgPSBjaG9ydXNEZWxheVBvcztgOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHVzZXNFY2hvKSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkKCQkJCWJlZXBib3guU3ludGguc2FuaXRpemVEZWxheUxpbmUoZWNob0RlbGF5TGluZUwsIGVjaG9EZWxheVBvcywgZWNob01hc2spOwoJCQkJYmVlcGJveC5TeW50aC5zYW5pdGl6ZURlbGF5TGluZShlY2hvRGVsYXlMaW5lUiwgZWNob0RlbGF5UG9zLCBlY2hvTWFzayk7CgkJCQlpbnN0cnVtZW50U3RhdGUuZWNob0RlbGF5UG9zID0gZWNob0RlbGF5UG9zOwoJCQkJCgkJCQlpZiAoIU51bWJlci5pc0Zpbml0ZShlY2hvU2hlbGZTYW1wbGVMKSB8fCBNYXRoLmFicyhlY2hvU2hlbGZTYW1wbGVMKSA8IGVwc2lsb24pIGVjaG9TaGVsZlNhbXBsZUwgPSAwLjA7CgkJCQlpZiAoIU51bWJlci5pc0Zpbml0ZShlY2hvU2hlbGZTYW1wbGVSKSB8fCBNYXRoLmFicyhlY2hvU2hlbGZTYW1wbGVSKSA8IGVwc2lsb24pIGVjaG9TaGVsZlNhbXBsZVIgPSAwLjA7CgkJCQlpZiAoIU51bWJlci5pc0Zpbml0ZShlY2hvU2hlbGZQcmV2SW5wdXRMKSB8fCBNYXRoLmFicyhlY2hvU2hlbGZQcmV2SW5wdXRMKSA8IGVwc2lsb24pIGVjaG9TaGVsZlByZXZJbnB1dEwgPSAwLjA7CgkJCQlpZiAoIU51bWJlci5pc0Zpbml0ZShlY2hvU2hlbGZQcmV2SW5wdXRSKSB8fCBNYXRoLmFicyhlY2hvU2hlbGZQcmV2SW5wdXRSKSA8IGVwc2lsb24pIGVjaG9TaGVsZlByZXZJbnB1dFIgPSAwLjA7CgkJCQlpbnN0cnVtZW50U3RhdGUuZWNob1NoZWxmU2FtcGxlTCA9IGVjaG9TaGVsZlNhbXBsZUw7CgkJCQlpbnN0cnVtZW50U3RhdGUuZWNob1NoZWxmU2FtcGxlUiA9IGVjaG9TaGVsZlNhbXBsZVI7CgkJCQlpbnN0cnVtZW50U3RhdGUuZWNob1NoZWxmUHJldklucHV0TCA9IGVjaG9TaGVsZlByZXZJbnB1dEw7CgkJCQlpbnN0cnVtZW50U3RhdGUuZWNob1NoZWxmUHJldklucHV0UiA9IGVjaG9TaGVsZlByZXZJbnB1dFI7YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1c2VzUmV2ZXJiKSB7CiAgICAgICAgICAgICAgICAgICAgZWZmZWN0c1NvdXJjZSArPSBgCgkJCQkKCQkJCWJlZXBib3guU3ludGguc2FuaXRpemVEZWxheUxpbmUocmV2ZXJiRGVsYXlMaW5lLCByZXZlcmJEZWxheVBvcyAgICAgICAgLCByZXZlcmJNYXNrKTsKCQkJCWJlZXBib3guU3ludGguc2FuaXRpemVEZWxheUxpbmUocmV2ZXJiRGVsYXlMaW5lLCByZXZlcmJEZWxheVBvcyArICAzMDQxLCByZXZlcmJNYXNrKTsKCQkJCWJlZXBib3guU3ludGguc2FuaXRpemVEZWxheUxpbmUocmV2ZXJiRGVsYXlMaW5lLCByZXZlcmJEZWxheVBvcyArICA2NDI2LCByZXZlcmJNYXNrKTsKCQkJCWJlZXBib3guU3ludGguc2FuaXRpemVEZWxheUxpbmUocmV2ZXJiRGVsYXlMaW5lLCByZXZlcmJEZWxheVBvcyArIDEwOTA3LCByZXZlcmJNYXNrKTsKCQkJCWluc3RydW1lbnRTdGF0ZS5yZXZlcmJEZWxheVBvcyAgPSByZXZlcmJEZWxheVBvczsKCQkJCQoJCQkJaWYgKCFOdW1iZXIuaXNGaW5pdGUocmV2ZXJiU2hlbGZTYW1wbGUwKSB8fCBNYXRoLmFicyhyZXZlcmJTaGVsZlNhbXBsZTApIDwgZXBzaWxvbikgcmV2ZXJiU2hlbGZTYW1wbGUwID0gMC4wOwoJCQkJaWYgKCFOdW1iZXIuaXNGaW5pdGUocmV2ZXJiU2hlbGZTYW1wbGUxKSB8fCBNYXRoLmFicyhyZXZlcmJTaGVsZlNhbXBsZTEpIDwgZXBzaWxvbikgcmV2ZXJiU2hlbGZTYW1wbGUxID0gMC4wOwoJCQkJaWYgKCFOdW1iZXIuaXNGaW5pdGUocmV2ZXJiU2hlbGZTYW1wbGUyKSB8fCBNYXRoLmFicyhyZXZlcmJTaGVsZlNhbXBsZTIpIDwgZXBzaWxvbikgcmV2ZXJiU2hlbGZTYW1wbGUyID0gMC4wOwoJCQkJaWYgKCFOdW1iZXIuaXNGaW5pdGUocmV2ZXJiU2hlbGZTYW1wbGUzKSB8fCBNYXRoLmFicyhyZXZlcmJTaGVsZlNhbXBsZTMpIDwgZXBzaWxvbikgcmV2ZXJiU2hlbGZTYW1wbGUzID0gMC4wOwoJCQkJaWYgKCFOdW1iZXIuaXNGaW5pdGUocmV2ZXJiU2hlbGZQcmV2SW5wdXQwKSB8fCBNYXRoLmFicyhyZXZlcmJTaGVsZlByZXZJbnB1dDApIDwgZXBzaWxvbikgcmV2ZXJiU2hlbGZQcmV2SW5wdXQwID0gMC4wOwoJCQkJaWYgKCFOdW1iZXIuaXNGaW5pdGUocmV2ZXJiU2hlbGZQcmV2SW5wdXQxKSB8fCBNYXRoLmFicyhyZXZlcmJTaGVsZlByZXZJbnB1dDEpIDwgZXBzaWxvbikgcmV2ZXJiU2hlbGZQcmV2SW5wdXQxID0gMC4wOwoJCQkJaWYgKCFOdW1iZXIuaXNGaW5pdGUocmV2ZXJiU2hlbGZQcmV2SW5wdXQyKSB8fCBNYXRoLmFicyhyZXZlcmJTaGVsZlByZXZJbnB1dDIpIDwgZXBzaWxvbikgcmV2ZXJiU2hlbGZQcmV2SW5wdXQyID0gMC4wOwoJCQkJaWYgKCFOdW1iZXIuaXNGaW5pdGUocmV2ZXJiU2hlbGZQcmV2SW5wdXQzKSB8fCBNYXRoLmFicyhyZXZlcmJTaGVsZlByZXZJbnB1dDMpIDwgZXBzaWxvbikgcmV2ZXJiU2hlbGZQcmV2SW5wdXQzID0gMC4wOwoJCQkJaW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmU2FtcGxlMCA9IHJldmVyYlNoZWxmU2FtcGxlMDsKCQkJCWluc3RydW1lbnRTdGF0ZS5yZXZlcmJTaGVsZlNhbXBsZTEgPSByZXZlcmJTaGVsZlNhbXBsZTE7CgkJCQlpbnN0cnVtZW50U3RhdGUucmV2ZXJiU2hlbGZTYW1wbGUyID0gcmV2ZXJiU2hlbGZTYW1wbGUyOwoJCQkJaW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmU2FtcGxlMyA9IHJldmVyYlNoZWxmU2FtcGxlMzsKCQkJCWluc3RydW1lbnRTdGF0ZS5yZXZlcmJTaGVsZlByZXZJbnB1dDAgPSByZXZlcmJTaGVsZlByZXZJbnB1dDA7CgkJCQlpbnN0cnVtZW50U3RhdGUucmV2ZXJiU2hlbGZQcmV2SW5wdXQxID0gcmV2ZXJiU2hlbGZQcmV2SW5wdXQxOwoJCQkJaW5zdHJ1bWVudFN0YXRlLnJldmVyYlNoZWxmUHJldklucHV0MiA9IHJldmVyYlNoZWxmUHJldklucHV0MjsKCQkJCWluc3RydW1lbnRTdGF0ZS5yZXZlcmJTaGVsZlByZXZJbnB1dDMgPSByZXZlcmJTaGVsZlByZXZJbnB1dDM7YDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVmZmVjdHNGdW5jdGlvbiA9IG5ldyBGdW5jdGlvbigic3ludGgiLCAib3V0cHV0RGF0YUwiLCAib3V0cHV0RGF0YVIiLCAiYnVmZmVySW5kZXgiLCAicnVuTGVuZ3RoIiwgImluc3RydW1lbnQiLCAiaW5zdHJ1bWVudFN0YXRlIiwgZWZmZWN0c1NvdXJjZSk7CiAgICAgICAgICAgICAgICBTeW50aC5lZmZlY3RzRnVuY3Rpb25DYWNoZVtzaWduYXR1cmVdID0gZWZmZWN0c0Z1bmN0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVmZmVjdHNGdW5jdGlvbihzeW50aCwgb3V0cHV0RGF0YUwsIG91dHB1dERhdGFSLCBidWZmZXJJbmRleCwgcnVuTGVuZ3RoLCBpbnN0cnVtZW50LCBpbnN0cnVtZW50U3RhdGUpOwogICAgICAgIH0KICAgICAgICBzdGF0aWMgcHVsc2VXaWR0aFN5bnRoKHN5bnRoLCBidWZmZXJJbmRleCwgcnVuTGVuZ3RoLCB0b25lLCBpbnN0cnVtZW50KSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBzeW50aC50ZW1wTW9ub0luc3RydW1lbnRTYW1wbGVCdWZmZXI7CiAgICAgICAgICAgIGxldCBwaGFzZURlbHRhID0gdG9uZS5waGFzZURlbHRhc1swXTsKICAgICAgICAgICAgY29uc3QgcGhhc2VEZWx0YVNjYWxlID0gK3RvbmUucGhhc2VEZWx0YVNjYWxlc1swXTsKICAgICAgICAgICAgbGV0IGV4cHJlc3Npb24gPSArdG9uZS5leHByZXNzaW9uU3RhcnRzWzBdOwogICAgICAgICAgICBjb25zdCBleHByZXNzaW9uRGVsdGEgPSArdG9uZS5leHByZXNzaW9uRGVsdGFzWzBdOwogICAgICAgICAgICBsZXQgcGhhc2UgPSAodG9uZS5waGFzZXNbMF0gJSAxKTsKICAgICAgICAgICAgbGV0IHB1bHNlV2lkdGggPSB0b25lLnB1bHNlV2lkdGg7CiAgICAgICAgICAgIGNvbnN0IHB1bHNlV2lkdGhEZWx0YSA9IHRvbmUucHVsc2VXaWR0aERlbHRhOwogICAgICAgICAgICBjb25zdCBmaWx0ZXJzID0gdG9uZS5ub3RlRmlsdGVyczsKICAgICAgICAgICAgY29uc3QgZmlsdGVyQ291bnQgPSB0b25lLm5vdGVGaWx0ZXJDb3VudCB8IDA7CiAgICAgICAgICAgIGxldCBpbml0aWFsRmlsdGVySW5wdXQxID0gK3RvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDE7CiAgICAgICAgICAgIGxldCBpbml0aWFsRmlsdGVySW5wdXQyID0gK3RvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDI7CiAgICAgICAgICAgIGNvbnN0IGFwcGx5RmlsdGVycyA9IFN5bnRoLmFwcGx5RmlsdGVyczsKICAgICAgICAgICAgY29uc3Qgc3RvcEluZGV4ID0gYnVmZmVySW5kZXggKyBydW5MZW5ndGg7CiAgICAgICAgICAgIGZvciAobGV0IHNhbXBsZUluZGV4ID0gYnVmZmVySW5kZXg7IHNhbXBsZUluZGV4IDwgc3RvcEluZGV4OyBzYW1wbGVJbmRleCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzYXdQaGFzZUEgPSBwaGFzZSAlIDE7CiAgICAgICAgICAgICAgICBjb25zdCBzYXdQaGFzZUIgPSAocGhhc2UgKyBwdWxzZVdpZHRoKSAlIDE7CiAgICAgICAgICAgICAgICBsZXQgcHVsc2VXYXZlID0gc2F3UGhhc2VCIC0gc2F3UGhhc2VBOwogICAgICAgICAgICAgICAgaWYgKHNhd1BoYXNlQSA8IHBoYXNlRGVsdGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IHNhd1BoYXNlQSAvIHBoYXNlRGVsdGE7CiAgICAgICAgICAgICAgICAgICAgcHVsc2VXYXZlICs9ICh0ICsgdCAtIHQgKiB0IC0gMSkgKiAwLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChzYXdQaGFzZUEgPiAxLjAgLSBwaGFzZURlbHRhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHQgPSAoc2F3UGhhc2VBIC0gMS4wKSAvIHBoYXNlRGVsdGE7CiAgICAgICAgICAgICAgICAgICAgcHVsc2VXYXZlICs9ICh0ICsgdCArIHQgKiB0ICsgMSkgKiAwLjU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoc2F3UGhhc2VCIDwgcGhhc2VEZWx0YSkgewogICAgICAgICAgICAgICAgICAgIHZhciB0ID0gc2F3UGhhc2VCIC8gcGhhc2VEZWx0YTsKICAgICAgICAgICAgICAgICAgICBwdWxzZVdhdmUgLT0gKHQgKyB0IC0gdCAqIHQgLSAxKSAqIDAuNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKHNhd1BoYXNlQiA+IDEuMCAtIHBoYXNlRGVsdGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdCA9IChzYXdQaGFzZUIgLSAxLjApIC8gcGhhc2VEZWx0YTsKICAgICAgICAgICAgICAgICAgICBwdWxzZVdhdmUgLT0gKHQgKyB0ICsgdCAqIHQgKyAxKSAqIDAuNTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0U2FtcGxlID0gcHVsc2VXYXZlOwogICAgICAgICAgICAgICAgY29uc3Qgc2FtcGxlID0gYXBwbHlGaWx0ZXJzKGlucHV0U2FtcGxlLCBpbml0aWFsRmlsdGVySW5wdXQxLCBpbml0aWFsRmlsdGVySW5wdXQyLCBmaWx0ZXJDb3VudCwgZmlsdGVycyk7CiAgICAgICAgICAgICAgICBpbml0aWFsRmlsdGVySW5wdXQyID0gaW5pdGlhbEZpbHRlcklucHV0MTsKICAgICAgICAgICAgICAgIGluaXRpYWxGaWx0ZXJJbnB1dDEgPSBpbnB1dFNhbXBsZTsKICAgICAgICAgICAgICAgIHBoYXNlICs9IHBoYXNlRGVsdGE7CiAgICAgICAgICAgICAgICBwaGFzZURlbHRhICo9IHBoYXNlRGVsdGFTY2FsZTsKICAgICAgICAgICAgICAgIHB1bHNlV2lkdGggKz0gcHVsc2VXaWR0aERlbHRhOwogICAgICAgICAgICAgICAgY29uc3Qgb3V0cHV0ID0gc2FtcGxlICogZXhwcmVzc2lvbjsKICAgICAgICAgICAgICAgIGV4cHJlc3Npb24gKz0gZXhwcmVzc2lvbkRlbHRhOwogICAgICAgICAgICAgICAgZGF0YVtzYW1wbGVJbmRleF0gKz0gb3V0cHV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRvbmUucGhhc2VzWzBdID0gcGhhc2U7CiAgICAgICAgICAgIHN5bnRoLnNhbml0aXplRmlsdGVycyhmaWx0ZXJzKTsKICAgICAgICAgICAgdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MSA9IGluaXRpYWxGaWx0ZXJJbnB1dDE7CiAgICAgICAgICAgIHRvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDIgPSBpbml0aWFsRmlsdGVySW5wdXQyOwogICAgICAgIH0KICAgICAgICBzdGF0aWMgbm9pc2VTeW50aChzeW50aCwgYnVmZmVySW5kZXgsIHJ1bkxlbmd0aCwgdG9uZSwgaW5zdHJ1bWVudCkgewogICAgICAgICAgICBjb25zdCBkYXRhID0gc3ludGgudGVtcE1vbm9JbnN0cnVtZW50U2FtcGxlQnVmZmVyOwogICAgICAgICAgICBsZXQgd2F2ZSA9IGluc3RydW1lbnQuZ2V0RHJ1bVdhdmUoKTsKICAgICAgICAgICAgbGV0IHBoYXNlRGVsdGEgPSArdG9uZS5waGFzZURlbHRhc1swXTsKICAgICAgICAgICAgY29uc3QgcGhhc2VEZWx0YVNjYWxlID0gK3RvbmUucGhhc2VEZWx0YVNjYWxlc1swXTsKICAgICAgICAgICAgbGV0IGV4cHJlc3Npb24gPSArdG9uZS5leHByZXNzaW9uU3RhcnRzWzBdOwogICAgICAgICAgICBjb25zdCBleHByZXNzaW9uRGVsdGEgPSArdG9uZS5leHByZXNzaW9uRGVsdGFzWzBdOwogICAgICAgICAgICBsZXQgcGhhc2UgPSAodG9uZS5waGFzZXNbMF0gJSAxKSAqIENvbmZpZy5jaGlwTm9pc2VMZW5ndGg7CiAgICAgICAgICAgIGlmICh0b25lLnBoYXNlc1swXSA9PSAwKSB7CiAgICAgICAgICAgICAgICBwaGFzZSA9IE1hdGgucmFuZG9tKCkgKiBDb25maWcuY2hpcE5vaXNlTGVuZ3RoOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IHBoYXNlTWFzayA9IENvbmZpZy5jaGlwTm9pc2VMZW5ndGggLSAxOwogICAgICAgICAgICBsZXQgbm9pc2VTYW1wbGUgPSArdG9uZS5zYW1wbGU7CiAgICAgICAgICAgIGNvbnN0IGZpbHRlcnMgPSB0b25lLm5vdGVGaWx0ZXJzOwogICAgICAgICAgICBjb25zdCBmaWx0ZXJDb3VudCA9IHRvbmUubm90ZUZpbHRlckNvdW50IHwgMDsKICAgICAgICAgICAgbGV0IGluaXRpYWxGaWx0ZXJJbnB1dDEgPSArdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MTsKICAgICAgICAgICAgbGV0IGluaXRpYWxGaWx0ZXJJbnB1dDIgPSArdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MjsKICAgICAgICAgICAgY29uc3QgYXBwbHlGaWx0ZXJzID0gU3ludGguYXBwbHlGaWx0ZXJzOwogICAgICAgICAgICBjb25zdCBwaXRjaFJlbGF0aXZlZmlsdGVyID0gTWF0aC5taW4oMS4wLCB0b25lLnBoYXNlRGVsdGFzWzBdICogQ29uZmlnLmNoaXBOb2lzZXNbaW5zdHJ1bWVudC5jaGlwTm9pc2VdLnBpdGNoRmlsdGVyTXVsdCk7CiAgICAgICAgICAgIGNvbnN0IHN0b3BJbmRleCA9IGJ1ZmZlckluZGV4ICsgcnVuTGVuZ3RoOwogICAgICAgICAgICBmb3IgKGxldCBzYW1wbGVJbmRleCA9IGJ1ZmZlckluZGV4OyBzYW1wbGVJbmRleCA8IHN0b3BJbmRleDsgc2FtcGxlSW5kZXgrKykgewogICAgICAgICAgICAgICAgY29uc3Qgd2F2ZVNhbXBsZSA9IHdhdmVbcGhhc2UgJiBwaGFzZU1hc2tdOwogICAgICAgICAgICAgICAgbm9pc2VTYW1wbGUgKz0gKHdhdmVTYW1wbGUgLSBub2lzZVNhbXBsZSkgKiBwaXRjaFJlbGF0aXZlZmlsdGVyOwogICAgICAgICAgICAgICAgY29uc3QgaW5wdXRTYW1wbGUgPSBub2lzZVNhbXBsZTsKICAgICAgICAgICAgICAgIGNvbnN0IHNhbXBsZSA9IGFwcGx5RmlsdGVycyhpbnB1dFNhbXBsZSwgaW5pdGlhbEZpbHRlcklucHV0MSwgaW5pdGlhbEZpbHRlcklucHV0MiwgZmlsdGVyQ291bnQsIGZpbHRlcnMpOwogICAgICAgICAgICAgICAgaW5pdGlhbEZpbHRlcklucHV0MiA9IGluaXRpYWxGaWx0ZXJJbnB1dDE7CiAgICAgICAgICAgICAgICBpbml0aWFsRmlsdGVySW5wdXQxID0gaW5wdXRTYW1wbGU7CiAgICAgICAgICAgICAgICBwaGFzZSArPSBwaGFzZURlbHRhOwogICAgICAgICAgICAgICAgcGhhc2VEZWx0YSAqPSBwaGFzZURlbHRhU2NhbGU7CiAgICAgICAgICAgICAgICBjb25zdCBvdXRwdXQgPSBzYW1wbGUgKiBleHByZXNzaW9uOwogICAgICAgICAgICAgICAgZXhwcmVzc2lvbiArPSBleHByZXNzaW9uRGVsdGE7CiAgICAgICAgICAgICAgICBkYXRhW3NhbXBsZUluZGV4XSArPSBvdXRwdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdG9uZS5waGFzZXNbMF0gPSBwaGFzZSAvIENvbmZpZy5jaGlwTm9pc2VMZW5ndGg7CiAgICAgICAgICAgIHRvbmUuc2FtcGxlID0gbm9pc2VTYW1wbGU7CiAgICAgICAgICAgIHN5bnRoLnNhbml0aXplRmlsdGVycyhmaWx0ZXJzKTsKICAgICAgICAgICAgdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MSA9IGluaXRpYWxGaWx0ZXJJbnB1dDE7CiAgICAgICAgICAgIHRvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDIgPSBpbml0aWFsRmlsdGVySW5wdXQyOwogICAgICAgIH0KICAgICAgICBzdGF0aWMgc3BlY3RydW1TeW50aChzeW50aCwgYnVmZmVySW5kZXgsIHJ1bkxlbmd0aCwgdG9uZSwgaW5zdHJ1bWVudCkgewogICAgICAgICAgICBjb25zdCBkYXRhID0gc3ludGgudGVtcE1vbm9JbnN0cnVtZW50U2FtcGxlQnVmZmVyOwogICAgICAgICAgICBsZXQgd2F2ZSA9IGluc3RydW1lbnQuZ2V0RHJ1bVdhdmUoKTsKICAgICAgICAgICAgbGV0IHBoYXNlRGVsdGEgPSB0b25lLnBoYXNlRGVsdGFzWzBdICogKDEgPDwgNyk7CiAgICAgICAgICAgIGNvbnN0IHBoYXNlRGVsdGFTY2FsZSA9ICt0b25lLnBoYXNlRGVsdGFTY2FsZXNbMF07CiAgICAgICAgICAgIGxldCBleHByZXNzaW9uID0gK3RvbmUuZXhwcmVzc2lvblN0YXJ0c1swXTsKICAgICAgICAgICAgY29uc3QgZXhwcmVzc2lvbkRlbHRhID0gK3RvbmUuZXhwcmVzc2lvbkRlbHRhc1swXTsKICAgICAgICAgICAgbGV0IG5vaXNlU2FtcGxlID0gK3RvbmUuc2FtcGxlOwogICAgICAgICAgICBjb25zdCBmaWx0ZXJzID0gdG9uZS5ub3RlRmlsdGVyczsKICAgICAgICAgICAgY29uc3QgZmlsdGVyQ291bnQgPSB0b25lLm5vdGVGaWx0ZXJDb3VudCB8IDA7CiAgICAgICAgICAgIGxldCBpbml0aWFsRmlsdGVySW5wdXQxID0gK3RvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDE7CiAgICAgICAgICAgIGxldCBpbml0aWFsRmlsdGVySW5wdXQyID0gK3RvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDI7CiAgICAgICAgICAgIGNvbnN0IGFwcGx5RmlsdGVycyA9IFN5bnRoLmFwcGx5RmlsdGVyczsKICAgICAgICAgICAgbGV0IHBoYXNlID0gKHRvbmUucGhhc2VzWzBdICUgMSkgKiBDb25maWcuc3BlY3RydW1Ob2lzZUxlbmd0aDsKICAgICAgICAgICAgaWYgKHRvbmUucGhhc2VzWzBdID09IDApCiAgICAgICAgICAgICAgICBwaGFzZSA9IFN5bnRoLmZpbmRSYW5kb21aZXJvQ3Jvc3Npbmcod2F2ZSwgQ29uZmlnLnNwZWN0cnVtTm9pc2VMZW5ndGgpICsgcGhhc2VEZWx0YTsKICAgICAgICAgICAgY29uc3QgcGhhc2VNYXNrID0gQ29uZmlnLnNwZWN0cnVtTm9pc2VMZW5ndGggLSAxOwogICAgICAgICAgICBjb25zdCBwaXRjaFJlbGF0aXZlZmlsdGVyID0gTWF0aC5taW4oMS4wLCBwaGFzZURlbHRhKTsKICAgICAgICAgICAgY29uc3Qgc3RvcEluZGV4ID0gYnVmZmVySW5kZXggKyBydW5MZW5ndGg7CiAgICAgICAgICAgIGZvciAobGV0IHNhbXBsZUluZGV4ID0gYnVmZmVySW5kZXg7IHNhbXBsZUluZGV4IDwgc3RvcEluZGV4OyBzYW1wbGVJbmRleCsrKSB7CiAgICAgICAgICAgICAgICBjb25zdCBwaGFzZUludCA9IHBoYXNlIHwgMDsKICAgICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gcGhhc2VJbnQgJiBwaGFzZU1hc2s7CiAgICAgICAgICAgICAgICBsZXQgd2F2ZVNhbXBsZSA9IHdhdmVbaW5kZXhdOwogICAgICAgICAgICAgICAgY29uc3QgcGhhc2VSYXRpbyA9IHBoYXNlIC0gcGhhc2VJbnQ7CiAgICAgICAgICAgICAgICB3YXZlU2FtcGxlICs9ICh3YXZlW2luZGV4ICsgMV0gLSB3YXZlU2FtcGxlKSAqIHBoYXNlUmF0aW87CiAgICAgICAgICAgICAgICBub2lzZVNhbXBsZSArPSAod2F2ZVNhbXBsZSAtIG5vaXNlU2FtcGxlKSAqIHBpdGNoUmVsYXRpdmVmaWx0ZXI7CiAgICAgICAgICAgICAgICBjb25zdCBpbnB1dFNhbXBsZSA9IG5vaXNlU2FtcGxlOwogICAgICAgICAgICAgICAgY29uc3Qgc2FtcGxlID0gYXBwbHlGaWx0ZXJzKGlucHV0U2FtcGxlLCBpbml0aWFsRmlsdGVySW5wdXQxLCBpbml0aWFsRmlsdGVySW5wdXQyLCBmaWx0ZXJDb3VudCwgZmlsdGVycyk7CiAgICAgICAgICAgICAgICBpbml0aWFsRmlsdGVySW5wdXQyID0gaW5pdGlhbEZpbHRlcklucHV0MTsKICAgICAgICAgICAgICAgIGluaXRpYWxGaWx0ZXJJbnB1dDEgPSBpbnB1dFNhbXBsZTsKICAgICAgICAgICAgICAgIHBoYXNlICs9IHBoYXNlRGVsdGE7CiAgICAgICAgICAgICAgICBwaGFzZURlbHRhICo9IHBoYXNlRGVsdGFTY2FsZTsKICAgICAgICAgICAgICAgIGNvbnN0IG91dHB1dCA9IHNhbXBsZSAqIGV4cHJlc3Npb247CiAgICAgICAgICAgICAgICBleHByZXNzaW9uICs9IGV4cHJlc3Npb25EZWx0YTsKICAgICAgICAgICAgICAgIGRhdGFbc2FtcGxlSW5kZXhdICs9IG91dHB1dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB0b25lLnBoYXNlc1swXSA9IHBoYXNlIC8gQ29uZmlnLnNwZWN0cnVtTm9pc2VMZW5ndGg7CiAgICAgICAgICAgIHRvbmUuc2FtcGxlID0gbm9pc2VTYW1wbGU7CiAgICAgICAgICAgIHN5bnRoLnNhbml0aXplRmlsdGVycyhmaWx0ZXJzKTsKICAgICAgICAgICAgdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MSA9IGluaXRpYWxGaWx0ZXJJbnB1dDE7CiAgICAgICAgICAgIHRvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDIgPSBpbml0aWFsRmlsdGVySW5wdXQyOwogICAgICAgIH0KICAgICAgICBzdGF0aWMgZHJ1bXNldFN5bnRoKHN5bnRoLCBidWZmZXJJbmRleCwgcnVuTGVuZ3RoLCB0b25lLCBpbnN0cnVtZW50KSB7CiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBzeW50aC50ZW1wTW9ub0luc3RydW1lbnRTYW1wbGVCdWZmZXI7CiAgICAgICAgICAgIGxldCB3YXZlID0gaW5zdHJ1bWVudC5nZXREcnVtc2V0V2F2ZSh0b25lLmRydW1zZXRQaXRjaCk7CiAgICAgICAgICAgIGxldCBwaGFzZURlbHRhID0gdG9uZS5waGFzZURlbHRhc1swXSAvIEluc3RydW1lbnQuZHJ1bXNldEluZGV4UmVmZXJlbmNlRGVsdGEodG9uZS5kcnVtc2V0UGl0Y2gpOwogICAgICAgICAgICBjb25zdCBwaGFzZURlbHRhU2NhbGUgPSArdG9uZS5waGFzZURlbHRhU2NhbGVzWzBdOwogICAgICAgICAgICBsZXQgZXhwcmVzc2lvbiA9ICt0b25lLmV4cHJlc3Npb25TdGFydHNbMF07CiAgICAgICAgICAgIGNvbnN0IGV4cHJlc3Npb25EZWx0YSA9ICt0b25lLmV4cHJlc3Npb25EZWx0YXNbMF07CiAgICAgICAgICAgIGNvbnN0IGZpbHRlcnMgPSB0b25lLm5vdGVGaWx0ZXJzOwogICAgICAgICAgICBjb25zdCBmaWx0ZXJDb3VudCA9IHRvbmUubm90ZUZpbHRlckNvdW50IHwgMDsKICAgICAgICAgICAgbGV0IGluaXRpYWxGaWx0ZXJJbnB1dDEgPSArdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MTsKICAgICAgICAgICAgbGV0IGluaXRpYWxGaWx0ZXJJbnB1dDIgPSArdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MjsKICAgICAgICAgICAgY29uc3QgYXBwbHlGaWx0ZXJzID0gU3ludGguYXBwbHlGaWx0ZXJzOwogICAgICAgICAgICBsZXQgcGhhc2UgPSAodG9uZS5waGFzZXNbMF0gJSAxKSAqIENvbmZpZy5zcGVjdHJ1bU5vaXNlTGVuZ3RoOwogICAgICAgICAgICBpZiAodG9uZS5waGFzZXNbMF0gPT0gMCkKICAgICAgICAgICAgICAgIHBoYXNlID0gU3ludGguZmluZFJhbmRvbVplcm9Dcm9zc2luZyh3YXZlLCBDb25maWcuc3BlY3RydW1Ob2lzZUxlbmd0aCkgKyBwaGFzZURlbHRhOwogICAgICAgICAgICBjb25zdCBwaGFzZU1hc2sgPSBDb25maWcuc3BlY3RydW1Ob2lzZUxlbmd0aCAtIDE7CiAgICAgICAgICAgIGNvbnN0IHN0b3BJbmRleCA9IGJ1ZmZlckluZGV4ICsgcnVuTGVuZ3RoOwogICAgICAgICAgICBmb3IgKGxldCBzYW1wbGVJbmRleCA9IGJ1ZmZlckluZGV4OyBzYW1wbGVJbmRleCA8IHN0b3BJbmRleDsgc2FtcGxlSW5kZXgrKykgewogICAgICAgICAgICAgICAgY29uc3QgcGhhc2VJbnQgPSBwaGFzZSB8IDA7CiAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IHBoYXNlSW50ICYgcGhhc2VNYXNrOwogICAgICAgICAgICAgICAgbGV0IG5vaXNlU2FtcGxlID0gd2F2ZVtpbmRleF07CiAgICAgICAgICAgICAgICBjb25zdCBwaGFzZVJhdGlvID0gcGhhc2UgLSBwaGFzZUludDsKICAgICAgICAgICAgICAgIG5vaXNlU2FtcGxlICs9ICh3YXZlW2luZGV4ICsgMV0gLSBub2lzZVNhbXBsZSkgKiBwaGFzZVJhdGlvOwogICAgICAgICAgICAgICAgY29uc3QgaW5wdXRTYW1wbGUgPSBub2lzZVNhbXBsZTsKICAgICAgICAgICAgICAgIGNvbnN0IHNhbXBsZSA9IGFwcGx5RmlsdGVycyhpbnB1dFNhbXBsZSwgaW5pdGlhbEZpbHRlcklucHV0MSwgaW5pdGlhbEZpbHRlcklucHV0MiwgZmlsdGVyQ291bnQsIGZpbHRlcnMpOwogICAgICAgICAgICAgICAgaW5pdGlhbEZpbHRlcklucHV0MiA9IGluaXRpYWxGaWx0ZXJJbnB1dDE7CiAgICAgICAgICAgICAgICBpbml0aWFsRmlsdGVySW5wdXQxID0gaW5wdXRTYW1wbGU7CiAgICAgICAgICAgICAgICBwaGFzZSArPSBwaGFzZURlbHRhOwogICAgICAgICAgICAgICAgcGhhc2VEZWx0YSAqPSBwaGFzZURlbHRhU2NhbGU7CiAgICAgICAgICAgICAgICBjb25zdCBvdXRwdXQgPSBzYW1wbGUgKiBleHByZXNzaW9uOwogICAgICAgICAgICAgICAgZXhwcmVzc2lvbiArPSBleHByZXNzaW9uRGVsdGE7CiAgICAgICAgICAgICAgICBkYXRhW3NhbXBsZUluZGV4XSArPSBvdXRwdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdG9uZS5waGFzZXNbMF0gPSBwaGFzZSAvIENvbmZpZy5zcGVjdHJ1bU5vaXNlTGVuZ3RoOwogICAgICAgICAgICBzeW50aC5zYW5pdGl6ZUZpbHRlcnMoZmlsdGVycyk7CiAgICAgICAgICAgIHRvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDEgPSBpbml0aWFsRmlsdGVySW5wdXQxOwogICAgICAgICAgICB0b25lLmluaXRpYWxOb3RlRmlsdGVySW5wdXQyID0gaW5pdGlhbEZpbHRlcklucHV0MjsKICAgICAgICB9CiAgICAgICAgc3RhdGljIGZpbmRSYW5kb21aZXJvQ3Jvc3Npbmcod2F2ZSwgd2F2ZUxlbmd0aCkgewogICAgICAgICAgICBsZXQgcGhhc2UgPSBNYXRoLnJhbmRvbSgpICogd2F2ZUxlbmd0aDsKICAgICAgICAgICAgY29uc3QgcGhhc2VNYXNrID0gd2F2ZUxlbmd0aCAtIDE7CiAgICAgICAgICAgIGxldCBpbmRleFByZXYgPSBwaGFzZSAmIHBoYXNlTWFzazsKICAgICAgICAgICAgbGV0IHdhdmVQcmV2ID0gd2F2ZVtpbmRleFByZXZdOwogICAgICAgICAgICBjb25zdCBzdHJpZGUgPSAxNjsKICAgICAgICAgICAgZm9yIChsZXQgYXR0ZW1wdHNSZW1haW5pbmcgPSAxMjg7IGF0dGVtcHRzUmVtYWluaW5nID4gMDsgYXR0ZW1wdHNSZW1haW5pbmctLSkgewogICAgICAgICAgICAgICAgY29uc3QgaW5kZXhOZXh0ID0gKGluZGV4UHJldiArIHN0cmlkZSkgJiBwaGFzZU1hc2s7CiAgICAgICAgICAgICAgICBjb25zdCB3YXZlTmV4dCA9IHdhdmVbaW5kZXhOZXh0XTsKICAgICAgICAgICAgICAgIGlmICh3YXZlUHJldiAqIHdhdmVOZXh0IDw9IDAuMCkgewogICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3RyaWRlOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5uZXJJbmRleE5leHQgPSAoaW5kZXhQcmV2ICsgMSkgJiBwaGFzZU1hc2s7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlubmVyV2F2ZU5leHQgPSB3YXZlW2lubmVySW5kZXhOZXh0XTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdhdmVQcmV2ICogaW5uZXJXYXZlTmV4dCA8PSAwLjApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNsb3BlID0gaW5uZXJXYXZlTmV4dCAtIHdhdmVQcmV2OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGhhc2UgPSBpbmRleFByZXY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoc2xvcGUpID4gMC4wMDAwMDAwMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBoYXNlICs9IC13YXZlUHJldiAvIHNsb3BlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGhhc2UgPSBNYXRoLm1heCgwLCBwaGFzZSkgJSB3YXZlTGVuZ3RoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleFByZXYgPSBpbm5lckluZGV4TmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhdmVQcmV2ID0gaW5uZXJXYXZlTmV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgIGluZGV4UHJldiA9IGluZGV4TmV4dDsKICAgICAgICAgICAgICAgICAgICB3YXZlUHJldiA9IHdhdmVOZXh0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBwaGFzZTsKICAgICAgICB9CiAgICAgICAgc3RhdGljIGluc3RydW1lbnRWb2x1bWVUb1ZvbHVtZU11bHQoaW5zdHJ1bWVudFZvbHVtZSkgewogICAgICAgICAgICByZXR1cm4gKGluc3RydW1lbnRWb2x1bWUgPT0gQ29uZmlnLnZvbHVtZVJhbmdlIC0gMSkgPyAwLjAgOiBNYXRoLnBvdygyLCBDb25maWcudm9sdW1lTG9nU2NhbGUgKiBpbnN0cnVtZW50Vm9sdW1lKTsKICAgICAgICB9CiAgICAgICAgc3RhdGljIHZvbHVtZU11bHRUb0luc3RydW1lbnRWb2x1bWUodm9sdW1lTXVsdCkgewogICAgICAgICAgICByZXR1cm4gKHZvbHVtZU11bHQgPD0gMC4wKSA/IENvbmZpZy52b2x1bWVSYW5nZSAtIDEgOiBNYXRoLm1pbihDb25maWcudm9sdW1lUmFuZ2UgLSAyLCBNYXRoLmxvZzIodm9sdW1lTXVsdCkgLyBDb25maWcudm9sdW1lTG9nU2NhbGUpOwogICAgICAgIH0KICAgICAgICBzdGF0aWMgbm90ZVNpemVUb1ZvbHVtZU11bHQoc2l6ZSkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5wb3coTWF0aC5tYXgoMC4wLCBzaXplKSAvIENvbmZpZy5ub3RlU2l6ZU1heCwgMS41KTsKICAgICAgICB9CiAgICAgICAgc3RhdGljIHZvbHVtZU11bHRUb05vdGVTaXplKHZvbHVtZU11bHQpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgucG93KE1hdGgubWF4KDAuMCwgdm9sdW1lTXVsdCksIDEgLyAxLjUpICogQ29uZmlnLm5vdGVTaXplTWF4OwogICAgICAgIH0KICAgICAgICBzdGF0aWMgZmFkZUluU2V0dGluZ1RvU2Vjb25kcyhzZXR0aW5nKSB7CiAgICAgICAgICAgIHJldHVybiAwLjAxMjUgKiAoMC45NSAqIHNldHRpbmcgKyAwLjA1ICogc2V0dGluZyAqIHNldHRpbmcpOwogICAgICAgIH0KICAgICAgICBzdGF0aWMgc2Vjb25kc1RvRmFkZUluU2V0dGluZyhzZWNvbmRzKSB7CiAgICAgICAgICAgIHJldHVybiBjbGFtcCgwLCBDb25maWcuZmFkZUluUmFuZ2UsIE1hdGgucm91bmQoKC0wLjk1ICsgTWF0aC5zcXJ0KDAuOTAyNSArIDAuMiAqIHNlY29uZHMgLyAwLjAxMjUpKSAvIDAuMSkpOwogICAgICAgIH0KICAgICAgICBzdGF0aWMgZmFkZU91dFNldHRpbmdUb1RpY2tzKHNldHRpbmcpIHsKICAgICAgICAgICAgcmV0dXJuIENvbmZpZy5mYWRlT3V0VGlja3Nbc2V0dGluZ107CiAgICAgICAgfQogICAgICAgIHN0YXRpYyB0aWNrc1RvRmFkZU91dFNldHRpbmcodGlja3MpIHsKICAgICAgICAgICAgbGV0IGxvd2VyID0gQ29uZmlnLmZhZGVPdXRUaWNrc1swXTsKICAgICAgICAgICAgaWYgKHRpY2tzIDw9IGxvd2VyKQogICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAxOyBpIDwgQ29uZmlnLmZhZGVPdXRUaWNrcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgbGV0IHVwcGVyID0gQ29uZmlnLmZhZGVPdXRUaWNrc1tpXTsKICAgICAgICAgICAgICAgIGlmICh0aWNrcyA8PSB1cHBlcikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gKHRpY2tzIDwgKGxvd2VyICsgdXBwZXIpIC8gMikgPyBpIC0gMSA6IGk7CiAgICAgICAgICAgICAgICBsb3dlciA9IHVwcGVyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBDb25maWcuZmFkZU91dFRpY2tzLmxlbmd0aCAtIDE7CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBkZXR1bmVUb0NlbnRzKGRldHVuZSkgewogICAgICAgICAgICByZXR1cm4gZGV0dW5lICogKE1hdGguYWJzKGRldHVuZSkgKyAxKSAvIDI7CiAgICAgICAgfQogICAgICAgIHN0YXRpYyBjZW50c1RvRGV0dW5lKGNlbnRzKSB7CiAgICAgICAgICAgIHJldHVybiBNYXRoLnNpZ24oY2VudHMpICogKE1hdGguc3FydCgxICsgOCAqIE1hdGguYWJzKGNlbnRzKSkgLSAxKSAvIDIuMDsKICAgICAgICB9CiAgICAgICAgZ2V0U2FtcGxlc1BlclRpY2soKSB7CiAgICAgICAgICAgIGlmICh0aGlzLnNvbmcgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICBjb25zdCBiZWF0c1Blck1pbnV0ZSA9IHRoaXMuc29uZy5nZXRCZWF0c1Blck1pbnV0ZSgpOwogICAgICAgICAgICBjb25zdCBiZWF0c1BlclNlY29uZCA9IGJlYXRzUGVyTWludXRlIC8gNjAuMDsKICAgICAgICAgICAgY29uc3QgcGFydHNQZXJTZWNvbmQgPSBDb25maWcucGFydHNQZXJCZWF0ICogYmVhdHNQZXJTZWNvbmQ7CiAgICAgICAgICAgIGNvbnN0IHRpY2tQZXJTZWNvbmQgPSBDb25maWcudGlja3NQZXJQYXJ0ICogcGFydHNQZXJTZWNvbmQ7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnNhbXBsZXNQZXJTZWNvbmQgLyB0aWNrUGVyU2Vjb25kOwogICAgICAgIH0KICAgICAgICBzdGF0aWMgZml0dGluZ1Bvd2VyT2ZUd28oeCkgewogICAgICAgICAgICByZXR1cm4gMSA8PCAoMzIgLSBNYXRoLmNsejMyKE1hdGguY2VpbCh4KSAtIDEpKTsKICAgICAgICB9CiAgICAgICAgc2FuaXRpemVGaWx0ZXJzKGZpbHRlcnMpIHsKICAgICAgICAgICAgbGV0IHJlc2V0ID0gZmFsc2U7CiAgICAgICAgICAgIGZvciAoY29uc3QgZmlsdGVyIG9mIGZpbHRlcnMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG91dHB1dDEgPSBNYXRoLmFicyhmaWx0ZXIub3V0cHV0MSk7CiAgICAgICAgICAgICAgICBjb25zdCBvdXRwdXQyID0gTWF0aC5hYnMoZmlsdGVyLm91dHB1dDIpOwogICAgICAgICAgICAgICAgaWYgKCEob3V0cHV0MSA8IDEwMCkgfHwgIShvdXRwdXQyIDwgMTAwKSkgewogICAgICAgICAgICAgICAgICAgIHJlc2V0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvdXRwdXQxIDwgZXBzaWxvbikKICAgICAgICAgICAgICAgICAgICBmaWx0ZXIub3V0cHV0MSA9IDAuMDsKICAgICAgICAgICAgICAgIGlmIChvdXRwdXQyIDwgZXBzaWxvbikKICAgICAgICAgICAgICAgICAgICBmaWx0ZXIub3V0cHV0MiA9IDAuMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocmVzZXQpIHsKICAgICAgICAgICAgICAgIGZvciAoY29uc3QgZmlsdGVyIG9mIGZpbHRlcnMpIHsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXIub3V0cHV0MSA9IDAuMDsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXIub3V0cHV0MiA9IDAuMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGF0aWMgc2FuaXRpemVEZWxheUxpbmUoZGVsYXlMaW5lLCBsYXN0SW5kZXgsIG1hc2spIHsKICAgICAgICAgICAgd2hpbGUgKHRydWUpIHsKICAgICAgICAgICAgICAgIGxhc3RJbmRleC0tOwogICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBsYXN0SW5kZXggJiBtYXNrOwogICAgICAgICAgICAgICAgY29uc3Qgc2FtcGxlID0gTWF0aC5hYnMoZGVsYXlMaW5lW2luZGV4XSk7CiAgICAgICAgICAgICAgICBpZiAoTnVtYmVyLmlzRmluaXRlKHNhbXBsZSkgJiYgKHNhbXBsZSA9PSAwLjAgfHwgc2FtcGxlID49IGVwc2lsb24pKQogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgZGVsYXlMaW5lW2luZGV4XSA9IDAuMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdGF0aWMgYXBwbHlGaWx0ZXJzKHNhbXBsZSwgaW5wdXQxLCBpbnB1dDIsIGZpbHRlckNvdW50LCBmaWx0ZXJzKSB7CiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZmlsdGVyQ291bnQ7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgZmlsdGVyID0gZmlsdGVyc1tpXTsKICAgICAgICAgICAgICAgIGNvbnN0IG91dHB1dDEgPSBmaWx0ZXIub3V0cHV0MTsKICAgICAgICAgICAgICAgIGNvbnN0IG91dHB1dDIgPSBmaWx0ZXIub3V0cHV0MjsKICAgICAgICAgICAgICAgIGNvbnN0IGExID0gZmlsdGVyLmExOwogICAgICAgICAgICAgICAgY29uc3QgYTIgPSBmaWx0ZXIuYTI7CiAgICAgICAgICAgICAgICBjb25zdCBiMCA9IGZpbHRlci5iMDsKICAgICAgICAgICAgICAgIGNvbnN0IGIxID0gZmlsdGVyLmIxOwogICAgICAgICAgICAgICAgY29uc3QgYjIgPSBmaWx0ZXIuYjI7CiAgICAgICAgICAgICAgICBzYW1wbGUgPSBiMCAqIHNhbXBsZSArIGIxICogaW5wdXQxICsgYjIgKiBpbnB1dDIgLSBhMSAqIG91dHB1dDEgLSBhMiAqIG91dHB1dDI7CiAgICAgICAgICAgICAgICBmaWx0ZXIuYTEgPSBhMSArIGZpbHRlci5hMURlbHRhOwogICAgICAgICAgICAgICAgZmlsdGVyLmEyID0gYTIgKyBmaWx0ZXIuYTJEZWx0YTsKICAgICAgICAgICAgICAgIGlmIChmaWx0ZXIudXNlTXVsdGlwbGljYXRpdmVJbnB1dENvZWZmaWNpZW50cykgewogICAgICAgICAgICAgICAgICAgIGZpbHRlci5iMCA9IGIwICogZmlsdGVyLmIwRGVsdGE7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyLmIxID0gYjEgKiBmaWx0ZXIuYjFEZWx0YTsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXIuYjIgPSBiMiAqIGZpbHRlci5iMkRlbHRhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZmlsdGVyLmIwID0gYjAgKyBmaWx0ZXIuYjBEZWx0YTsKICAgICAgICAgICAgICAgICAgICBmaWx0ZXIuYjEgPSBiMSArIGZpbHRlci5iMURlbHRhOwogICAgICAgICAgICAgICAgICAgIGZpbHRlci5iMiA9IGIyICsgZmlsdGVyLmIyRGVsdGE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmaWx0ZXIub3V0cHV0MiA9IG91dHB1dDE7CiAgICAgICAgICAgICAgICBmaWx0ZXIub3V0cHV0MSA9IHNhbXBsZTsKICAgICAgICAgICAgICAgIGlucHV0MiA9IG91dHB1dDI7CiAgICAgICAgICAgICAgICBpbnB1dDEgPSBvdXRwdXQxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzYW1wbGU7CiAgICAgICAgfQogICAgfQogICAgU3ludGgudGVtcEZpbHRlclN0YXJ0Q29lZmZpY2llbnRzID0gbmV3IEZpbHRlckNvZWZmaWNpZW50cygpOwogICAgU3ludGgudGVtcEZpbHRlckVuZENvZWZmaWNpZW50cyA9IG5ldyBGaWx0ZXJDb2VmZmljaWVudHMoKTsKICAgIFN5bnRoLmZtU3ludGhGdW5jdGlvbkNhY2hlID0ge307CiAgICBTeW50aC5lZmZlY3RzRnVuY3Rpb25DYWNoZSA9IEFycmF5KDEgPDwgNykuZmlsbCh1bmRlZmluZWQpOwogICAgU3ludGgucGlja2VkU3RyaW5nRnVuY3Rpb25DYWNoZSA9IEFycmF5KDMpLmZpbGwodW5kZWZpbmVkKTsKICAgIFN5bnRoLmZtU291cmNlVGVtcGxhdGUgPSAoYAoJCWNvbnN0IGRhdGEgPSBzeW50aC50ZW1wTW9ub0luc3RydW1lbnRTYW1wbGVCdWZmZXI7CgkJY29uc3Qgc2luZVdhdmUgPSBiZWVwYm94LkNvbmZpZy5zaW5lV2F2ZTsKCQkKCQkvLyBJJ20gYWRkaW5nIDEwMDAgdG8gdGhlIHBoYXNlIHRvIGVuc3VyZSB0aGF0IGl0J3MgbmV2ZXIgbmVnYXRpdmUgZXZlbiB3aGVuIG1vZHVsYXRlZCBieSBvdGhlciB3YXZlcyBiZWNhdXNlIG5lZ2F0aXZlIG51bWJlcnMgZG9uJ3Qgd29yayB3aXRoIHRoZSBtb2R1bHVzIG9wZXJhdG9yIHZlcnkgd2VsbC4KCQlsZXQgb3BlcmF0b3IjUGhhc2UgICAgICAgPSArKCh0b25lLnBoYXNlc1sjXSAlIDEpICsgMTAwMCkgKiBiZWVwYm94LkNvbmZpZy5zaW5lV2F2ZUxlbmd0aDsKCQlsZXQgb3BlcmF0b3IjUGhhc2VEZWx0YSAgPSArdG9uZS5waGFzZURlbHRhc1sjXTsKCQlsZXQgb3BlcmF0b3IjUGhhc2VEZWx0YVNjYWxlID0gK3RvbmUucGhhc2VEZWx0YVNjYWxlc1sjXTsKCQlsZXQgb3BlcmF0b3IjT3V0cHV0TXVsdCAgPSArdG9uZS5leHByZXNzaW9uU3RhcnRzWyNdOwoJCWNvbnN0IG9wZXJhdG9yI091dHB1dERlbHRhID0gK3RvbmUuZXhwcmVzc2lvbkRlbHRhc1sjXTsKCQlsZXQgb3BlcmF0b3IjT3V0cHV0ICAgICAgPSArdG9uZS5mZWVkYmFja091dHB1dHNbI107CgkJbGV0IGZlZWRiYWNrTXVsdCAgICAgICAgID0gK3RvbmUuZmVlZGJhY2tNdWx0OwoJCWNvbnN0IGZlZWRiYWNrRGVsdGEgICAgICA9ICt0b25lLmZlZWRiYWNrRGVsdGE7CgkJCgkJY29uc3QgZmlsdGVycyA9IHRvbmUubm90ZUZpbHRlcnM7CgkJY29uc3QgZmlsdGVyQ291bnQgPSB0b25lLm5vdGVGaWx0ZXJDb3VudHwwOwoJCWxldCBpbml0aWFsRmlsdGVySW5wdXQxID0gK3RvbmUuaW5pdGlhbE5vdGVGaWx0ZXJJbnB1dDE7CgkJbGV0IGluaXRpYWxGaWx0ZXJJbnB1dDIgPSArdG9uZS5pbml0aWFsTm90ZUZpbHRlcklucHV0MjsKCQljb25zdCBhcHBseUZpbHRlcnMgPSBiZWVwYm94LlN5bnRoLmFwcGx5RmlsdGVyczsKCQkKCQljb25zdCBzdG9wSW5kZXggPSBidWZmZXJJbmRleCArIHJ1bkxlbmd0aDsKCQlmb3IgKGxldCBzYW1wbGVJbmRleCA9IGJ1ZmZlckluZGV4OyBzYW1wbGVJbmRleCA8IHN0b3BJbmRleDsgc2FtcGxlSW5kZXgrKykgewoJCQkvLyBJTlNFUlQgT1BFUkFUT1IgQ09NUFVUQVRJT04gSEVSRQoJCQljb25zdCBmbU91dHB1dCA9ICgvKm9wZXJhdG9yI1NjYWxlZCovKTsgLy8gQ0FSUklFUiBPVVRQVVRTCgkJCQoJCQljb25zdCBpbnB1dFNhbXBsZSA9IGZtT3V0cHV0OwoJCQljb25zdCBzYW1wbGUgPSBhcHBseUZpbHRlcnMoaW5wdXRTYW1wbGUsIGluaXRpYWxGaWx0ZXJJbnB1dDEsIGluaXRpYWxGaWx0ZXJJbnB1dDIsIGZpbHRlckNvdW50LCBmaWx0ZXJzKTsKCQkJaW5pdGlhbEZpbHRlcklucHV0MiA9IGluaXRpYWxGaWx0ZXJJbnB1dDE7CgkJCWluaXRpYWxGaWx0ZXJJbnB1dDEgPSBpbnB1dFNhbXBsZTsKCQkJCgkJCWZlZWRiYWNrTXVsdCArPSBmZWVkYmFja0RlbHRhOwoJCQlvcGVyYXRvciNPdXRwdXRNdWx0ICs9IG9wZXJhdG9yI091dHB1dERlbHRhOwoJCQlvcGVyYXRvciNQaGFzZSArPSBvcGVyYXRvciNQaGFzZURlbHRhOwoJCQlvcGVyYXRvciNQaGFzZURlbHRhICo9IG9wZXJhdG9yI1BoYXNlRGVsdGFTY2FsZTsKCQkJCgkJCWRhdGFbc2FtcGxlSW5kZXhdICs9IHNhbXBsZTsKCQl9CgkJCgkJdG9uZS5waGFzZXNbI10gPSBvcGVyYXRvciNQaGFzZSAvIGAgKyBDb25maWcuc2luZVdhdmVMZW5ndGggKyBgOwoJCXRvbmUuZmVlZGJhY2tPdXRwdXRzWyNdID0gb3BlcmF0b3IjT3V0cHV0OwoJCQoJCXN5bnRoLnNhbml0aXplRmlsdGVycyhmaWx0ZXJzKTsKCQl0b25lLmluaXRpYWxOb3RlRmlsdGVySW5wdXQxID0gaW5pdGlhbEZpbHRlcklucHV0MTsKCQl0b25lLmluaXRpYWxOb3RlRmlsdGVySW5wdXQyID0gaW5pdGlhbEZpbHRlcklucHV0MjsKCWApLnNwbGl0KCJcbiIpOwogICAgU3ludGgub3BlcmF0b3JTb3VyY2VUZW1wbGF0ZSA9IChgCgkJCWNvbnN0IG9wZXJhdG9yI1BoYXNlTWl4ID0gb3BlcmF0b3IjUGhhc2UvKiArIG9wZXJhdG9yQFNjYWxlZCovOwoJCQljb25zdCBvcGVyYXRvciNQaGFzZUludCA9IG9wZXJhdG9yI1BoYXNlTWl4fDA7CgkJCWNvbnN0IG9wZXJhdG9yI0luZGV4ICAgID0gb3BlcmF0b3IjUGhhc2VJbnQgJiBgICsgQ29uZmlnLnNpbmVXYXZlTWFzayArIGA7CgkJCWNvbnN0IG9wZXJhdG9yI1NhbXBsZSAgID0gc2luZVdhdmVbb3BlcmF0b3IjSW5kZXhdOwoJCQlvcGVyYXRvciNPdXRwdXQgICAgICAgICA9IG9wZXJhdG9yI1NhbXBsZSArIChzaW5lV2F2ZVtvcGVyYXRvciNJbmRleCArIDFdIC0gb3BlcmF0b3IjU2FtcGxlKSAqIChvcGVyYXRvciNQaGFzZU1peCAtIG9wZXJhdG9yI1BoYXNlSW50KTsKCQkJY29uc3Qgb3BlcmF0b3IjU2NhbGVkICAgPSBvcGVyYXRvciNPdXRwdXRNdWx0ICogb3BlcmF0b3IjT3V0cHV0OwoJYCkuc3BsaXQoIlxuIik7CgogICAgZXhwb3J0cy5DaGFubmVsID0gQ2hhbm5lbDsKICAgIGV4cG9ydHMuQ29uZmlnID0gQ29uZmlnOwogICAgZXhwb3J0cy5FbnZlbG9wZVNldHRpbmdzID0gRW52ZWxvcGVTZXR0aW5nczsKICAgIGV4cG9ydHMuRmlsdGVyQ29udHJvbFBvaW50ID0gRmlsdGVyQ29udHJvbFBvaW50OwogICAgZXhwb3J0cy5GaWx0ZXJTZXR0aW5ncyA9IEZpbHRlclNldHRpbmdzOwogICAgZXhwb3J0cy5IYXJtb25pY3NXYXZlID0gSGFybW9uaWNzV2F2ZTsKICAgIGV4cG9ydHMuSW5zdHJ1bWVudCA9IEluc3RydW1lbnQ7CiAgICBleHBvcnRzLk5vdGUgPSBOb3RlOwogICAgZXhwb3J0cy5PcGVyYXRvciA9IE9wZXJhdG9yOwogICAgZXhwb3J0cy5QYXR0ZXJuID0gUGF0dGVybjsKICAgIGV4cG9ydHMuU29uZyA9IFNvbmc7CiAgICBleHBvcnRzLlNwZWN0cnVtV2F2ZSA9IFNwZWN0cnVtV2F2ZTsKICAgIGV4cG9ydHMuU3ludGggPSBTeW50aDsKICAgIGV4cG9ydHMuY2xhbXAgPSBjbGFtcDsKICAgIGV4cG9ydHMubWFrZU5vdGVQaW4gPSBtYWtlTm90ZVBpbjsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgJ19fZXNNb2R1bGUnLCB7IHZhbHVlOiB0cnVlIH0pOwoKICAgIHJldHVybiBleHBvcnRzOwoKfSkoe30pOwovLyMgc291cmNlTWFwcGluZ1VSTD1iZWVwYm94X3N5bnRoLmpzLm1hcAo=";
var scriptBeepbox = document.createElement("script");
scriptBeepbox.src = beepboxsynthuri;
document.body.appendChild(scriptBeepbox);
scriptBeepbox.onload = function () {
	try {
		window.BeepboxSynthObject = new beepbox.Synth("5sbk4l00e0ftaa7g0fj7i0r1w1100f0000d1110c0000h0000v2200o3320b4z8Ql6hkpUsiczhkp5hDxN8Od5hAl6u74z8Ql6hkpUsp24ZFzzQ1E39kxIceEtoV8s66138l1S0L1u2139l1H39McyaeOgKA0TxAU213jj0NM4x8i0o0c86ywz7keUtVxQk1E3hi6OEcB8Atl0q0Qmm6eCexg6wd50oczkhO8VcsEeAc26gG3E1q2U406hG3i6jw94ksf8i5Uo0dZY26kHHzxp2gAgM0o4d516ej7uegceGwd0q84czm6yj8Xa0Q1EIIctcvq0Q1EE3ihE8W1OgV8s46Icxk7o24110w0OdgqMOk392OEWhS1ANQQ4toUctBpzRxx1M0WNSk1I3ANMEXwS3I79xSzJ7q6QtEXgw0");
	}catch(e){}
};
var blockIconURI = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAAAKE/YAAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAACClBMVEUAAAAAAAEBAQIBAQMCAQQEAggKBhUSCicdET4mFlIwG2c6IX1BJYxIKZpNLKRRLq1TMLNVMbYFAwsQCSIfEkMyHWxEJ5FVMLZhN89rPeVxQPJ0Qvl3RP54Rf95Rf8FAwoSCycoF1VAJYlXMrpoO95yQfR4RP93RP8IBRIcEDw4IHlVMLVpPOJ0Q/kGBA09IoJbNMRvQO8SCiYzHW1vP+54RP4eEUBGKJZnO912RPwHBBAmFlFRLq5vP+0pF1dWMbklFU9VMbdzQvUbEDpOLKdxQPEPCSA/JIdrPeYqGFlfNsx3RP1JKZtxQfIDAgcoF1ZhONELBxhAJYpwQO8YDjNWMbcnFlNkOdc2H3NuP+tCJo0NBxxLK6F2Q/tSL68RCiUJBRJuP+oYDjRkOdYDAgZBJYp2RP12Q/1yQfVsPuhrPeRqPOISCyhhONBzQvZoO99aM8BIKZs5IXsrGFwhE0YaDzcUCysQCSMOCB4EAwlJKps7In8iFEoRCSMGAw0BAAFtP+tUMLMyHGsVDC0PCSFlOddAJIgaDzk2H3UbEDtmO9s5IXoPCB9OLKZHKJgVDCwBAAJeNspzQfVHKZgQCSEyHGpWMbhiONEiE0hbNMJGKJVnO9wzHW4GBA49I4FeNslvQO4TCyhpPOEPCCA3H3VtP+obDzlyQfMyHWsVDC4KBhYRCSQ6IXz///93k4F5AAAAAWJLR0StIGLCHQAAAAd0SU1FB+MJDhMoAhz4BGEAAAbnSURBVHja7Z33VxNLFMc3EAwgNaFFMhshMCEgikrQSJGgiIAIShERsFOCUqQqWBBBBUUEUey9+0e+BEHxyebObnY3776T7w+cwznZu5+9c2fLnZk7HBdQQAEFFFBAASklTVCw1q3gII2/SRgUskEXGha+MSIyKjomNjYmOioyYmN4WKhuQ4i/ydaVRm+Ii09ITDJuSjYRfo2IKXmTMSkxIT7OoP9P+d28OSXVkpZuciNS6zqi7sswpadZUlM2m/3NuixNhi0za0s24YkVkPsn2VuyMm0Z/nb4Vtu2nO0mnkLAv3zOm7bnbLNt9R+xdsdOS64d9PBfHrfnWnbu0PoFWZ+3a7eD3cd/+tuxe1eeXnXkPfkFhUS0k9e4mxQW5O9RF7lob7o0J691d/reIvWw9cXOEh+cvMbdJc5idYJEu29/qSzIy9il+/ep0CUPlB2UDXkZ+2DZAYWRzeUVlT7G8r9FKyvKFX1O6g5VyermFWdXHdIphny4usYuP7JH9prqw8owHzlaq4CbV5xde/SIAsiaunqHzNG8VtRRXyf7i5S24Zhibl5x9rEGmW9+5sbjCjO7qY83ynoXyWgqUTA0VkVLmjLkYz7R3KICs5u6pfmEXMyG1ko1kD2qbDXIw3zSaVKL2Wo1OU/KwmxRJTRWRS0yUBucqjK7qZ0+R8iJVhVj46dMrT72xlPNqvXB36psPuULs7mpRX1mq7WlyYenjLZRjWfK36IljdKf6A2n/cLspj7dIJX5zFnF3zeERM6ekcZ8pN5vzG7qeknv1+fOt0k/J6WUEPcf6Rbazp+TAF1dK+mUhOdJe0dup6ury9WZ29Hu+V/SZddWi2e+cFH8uShPu3t6+y71DwwODY+MDA8NDvRf6uvt6aYS0lHk4gWxzJeviD0N5R1G5+jY1WvX/7R0/drVsVGnUXyukl65LBK6vEqkX+w3xm9OCOa49BM3x2+IzQpXlYtjvlUh6gTEMTl1G8jK6W9PTTrEWa24JYZZWybmNYk4au4YgmCrQYY7NaKwTWViHox3jewBSO3TM/cYv/4192am7SJMG++yM+vvs/uD1M4+mGM3PfdgVkTKh9xnzwQXl7K34MN8kQObIfkP2WOvtJjV7J5YVl/Q+YVH4pA9erQwzxoiJJZ1rKCom9Wka1HSi6950cXqlu4iRkc/ZrRInizNSWF2R/bSE9ZzPGZzdVg6o72nddKQPap7ykidHsbUdgU8G7PFp0y4zsJGzRewRGBeIVMvIZZhX5g5bpiNmhbmwbaCnzHZIk99HnHQsUUIeRYMm3rOYoo88SGeV1XH1BvJc9g9L1i+V6hryXdmjltysURi2wvIzksLSzecX5yTA3pucZ7hZLzlJWDHxtQNF2RK2ZsXWJq10AaYecXATF7LlETmOMNrhrCmr7wbyciBjdBapvs9m8IYPp9JjvdRDdsbhguflXGg8vAsQ9O+8R4fmQzBMT0hHzPHTUwzBEimNwvmLPje0TYjJzPHzcD3WD7LW8d/+w5sLFLzXl7o9zWgq+m7t14MpGTDjv4gLzPHfYBdnZ3i5fhUeEbgpI/vSX9reBI+a6rw4Xr4cUinZB9210yBMclbhD9wDWnQNdOPn+Rm5rhPHyFqkib8OIv7DF7yuAKzu/TjYAN/jhM8Oh461tr2RX5mjvsCd8V4wYMToCumxq9KQH8FE1p8gtCxIYkQNF+vyNw/fT144kShlNC3JLAfjirBzHGjYE9M+iZwqA5spe4xZaDHoPQQNQp9c4VCKTzS810Z6O89UBuXhgocGpYMRVavQlPMt/ZCQZ0s9A4fboWg+xSazq/pA+/U4QKH/oDaiMj8VvpbM+CpfwgcGQFdbnu/UtD97VAjRwi0USQE3TGgFPRABwQduX5kBkUB0DR3UCnowVzgbstHrT8SFRwNQXcOKQU91AlBR6+f0dPGQNAu2T8AVjUMJcj4mPVH57SxADTpGlEKeqQLuH3wsf8naIzhgbIjorzloXy4oHyM43xhQvlqivIjAOXnFsoPW5QpBJTJGpRpMZwJSJSpXpRJdZTDFygHinAOyaEc/EQ5zIxyQB/n1AmUk1RQTgfCOfEK5RQ3lJMJcU7bRDlBFuVUZJyTvlFOr8e5kAHlkhGci3NQLoPCueAM5dI+nIsoUS5XxbkwGOcSbJSL3XGWFcBZwAFlqQycRUlwln/BWWgHZUkjnMWjcJbpwlkQDWfpOZxF/nCWU8RZuBJniVCcxVhxlr3FWWCYQ1nKmcNZNJtDWZ6cw1kInkNZcp/DubkBh3IbCY8QbtixjI1vaxSPEG5C4xHC7X6WhW9jpWUh3MLqp9BtFrYifNuy/RKyDfD+FKqtBgMKKKCAAgoIq/4B++jkVfDyLoAAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTktMDktMTRUMTk6NDA6MDIrMDI6MDDOE0aoAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE5LTA5LTE0VDE5OjQwOjAyKzAyOjAwv07+FAAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAABXelRYdFJhdyBwcm9maWxlIHR5cGUgaXB0YwAAeJzj8gwIcVYoKMpPy8xJ5VIAAyMLLmMLEyMTS5MUAxMgRIA0w2QDI7NUIMvY1MjEzMQcxAfLgEigSi4A6hcRdPJCNZUAAAAASUVORK5CYII=";
class beepboxsynth {
    constructor (runtime) {
        this.runtime = runtime;
    }

    getInfo () {
        return {
            id: 'beepboxsynth',
            name: 'Beepbox',
			blockIconURI: blockIconURI,
            blocks: [
                {
                    opcode: 'loadsong',
                    blockType: BlockType.COMMAND,
                    text: 'Load song [Data]',
                    arguments: {
                        Data: {
                            type: ArgumentType.STRING,
                            defaultValue: "5sbk4l00e0ftaa7g0fj7i0r1w1100f0000d1110c0000h0000v2200o3320b4z8Ql6hkpUsiczhkp5hDxN8Od5hAl6u74z8Ql6hkpUsp24ZFzzQ1E39kxIceEtoV8s66138l1S0L1u2139l1H39McyaeOgKA0TxAU213jj0NM4x8i0o0c86ywz7keUtVxQk1E3hi6OEcB8Atl0q0Qmm6eCexg6wd50oczkhO8VcsEeAc26gG3E1q2U406hG3i6jw94ksf8i5Uo0dZY26kHHzxp2gAgM0o4d516ej7uegceGwd0q84czm6yj8Xa0Q1EIIctcvq0Q1EE3ihE8W1OgV8s46Icxk7o24110w0OdgqMOk392OEWhS1ANQQ4toUctBpzRxx1M0WNSk1I3ANMEXwS3I79xSzJ7q6QtEXgw0"
                        }
                    }
                },
                {
                    opcode: 'playsong',
                    blockType: BlockType.COMMAND,
                    text: 'Play song',
                    arguments: {
						
                    }
                },
                {
                    opcode: 'pausesong',
                    blockType: BlockType.COMMAND,
                    text: 'Pause song',
                    arguments: {
						
                    }
                },
                {
                    opcode: 'isplaying',
                    blockType: BlockType.BOOLEAN,
                    text: 'Is song playing?',
                    arguments: {
						
                    }
                },
                {
                    opcode: 'extractcontents',
                    blockType: BlockType.REPORTER,
                    text: 'Extract data from beepbox url [url]',
                    arguments: {
						url:{
							type: ArgumentType.STRING,
							defaultValue: "https://beepbox.co/#5sbk4l00e0ftaa7g0fj7i0r1w1100f0000d1110c0000h0000v2200o3320b4z8Ql6hkpUsiczhkp5hDxN8Od5hAl6u74z8Ql6hkpUsp24ZFzzQ1E39kxIceEtoV8s66138l1S0L1u2139l1H39McyaeOgKA0TxAU213jj0NM4x8i0o0c86ywz7keUtVxQk1E3hi6OEcB8Atl0q0Qmm6eCexg6wd50oczkhO8VcsEeAc26gG3E1q2U406hG3i6jw94ksf8i5Uo0dZY26kHHzxp2gAgM0o4d516ej7uegceGwd0q84czm6yj8Xa0Q1EIIctcvq0Q1EE3ihE8W1OgV8s46Icxk7o24110w0OdgqMOk392OEWhS1ANQQ4toUctBpzRxx1M0WNSk1I3ANMEXwS3I79xSzJ7q6QtEXgw0"
						}
                    }
                }
            ],
            menus: {
            }
        };
    }

    loadsong (args) {
		try {
			try{
				window.BeepboxSynthObject.pause();
			}catch(e){}
			window.BeepboxSynthObject = new beepbox.Synth(Cast.toString(args.Data));
		} catch(e) {
			console.log(e);
		}
    }
	playsong  () {
		try {
			window.BeepboxSynthObject.play();
		} catch(e) {
			console.log(e);
		}
	}
	pausesong  () {
		try {
			window.BeepboxSynthObject.pause();
		} catch(e) {
			console.log(e);
		}
	}
	isplaying  () {
		try {
			return window.BeepboxSynthObject.isPlayingSong;
		} catch(e) {
			console.log(e);
			return false;
		}
	}
	extractcontents (args) {
		try {
			return Cast.toString(args.url).split("#").pop();
		} catch(e) {
			console.log(e);
			return false;
		}
	}
}
module.exports = beepboxsynth;